SET search_path TO helio_api,helio_core;
SET helio_api.next_collection_id TO 2000;
SET helio_api.next_collection_index_id TO 2000;
-- replace document scenarios
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "a": 1}', '{ "": { "_id": 1, "b": 2 } }', '{}');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "2" } }
(1 row)

-- allow updating ID if it's type compatible
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "a": 1}', '{ "": { "_id": 1.0, "b": 2 } }', '{}');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "2" } }
(1 row)

-- ID mismatch not allowed: error
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "a": 1}', '{ "": { "_id": 2.0, "b": 2 } }', '{}');
ERROR:  After applying the update, the (immutable) field '_id' was found to have been altered
-- ID not specified - pick the ID from the source document
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "a": 1}', '{ "": { "b": 2 } }', '{}');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "2" } }
(1 row)

-- upsert case: Creates a new document.
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "_id": 2.0, "b": 2 } }', '{}');
                         bson_update_document                          
-----------------------------------------------------------------------
 { "_id" : { "$numberDouble" : "2.0" }, "b" : { "$numberInt" : "2" } }
(1 row)

-- upsert case: no id specified creates a new ID
SELECT (helio_api_internal.bson_update_document('{}', '{ "": { "b": 2 } }', '{}')).newDocument @? '{ "_id" : 1 }';
ERROR:  operator does not exist: bson @? unknown
LINE 1: ...nt('{}', '{ "": { "b": 2 } }', '{}')).newDocument @? '{ "_id...
                                                             ^
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
-- upsert case: no id specified creates from filter
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "b": 2 } }', '{"$and": [ { "a": 1, "_id": 2.0 }]}');
                         bson_update_document                          
-----------------------------------------------------------------------
 { "_id" : { "$numberDouble" : "2.0" }, "b" : { "$numberInt" : "2" } }
(1 row)

-- upsert case: no id specified autogenerates when _id filter is not $eq.
SELECT (helio_api_internal.bson_update_document('{}', '{ "": { "b": 2 } }', '{"$and": [ { "a": 1, "_id": { "$gt": 2.0 } }]}')).newDocument  @? '{ "_id" : 1 }';
ERROR:  operator does not exist: bson @? unknown
LINE 1: ..."a": 1, "_id": { "$gt": 2.0 } }]}')).newDocument  @? '{ "_id...
                                                             ^
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
SELECT (helio_api_internal.bson_update_document('{}', '{ "": { "b": 2 } }', '{"$and": [ { "a": 1, "_id": { "$lt": 2.0 } }]}')).newDocument  @? '{ "_id" : 1 }';
ERROR:  operator does not exist: bson @? unknown
LINE 1: ..."a": 1, "_id": { "$lt": 2.0 } }]}')).newDocument  @? '{ "_id...
                                                             ^
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
SELECT (helio_api_internal.bson_update_document('{}', '{ "": { "b": 2 } }', '{"$or": [ { "a": 1, "_id": 2.0 } ]}')).newDocument  @? '{ "_id" : 1 }';
ERROR:  operator does not exist: bson @? unknown
LINE 1: ...$or": [ { "a": 1, "_id": 2.0 } ]}')).newDocument  @? '{ "_id...
                                                             ^
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
SELECT (helio_api_internal.bson_update_document('{}', '{ "": { "b": 2 } }', '{"$or": [ { "a": 1 }, { "_id": 3 } ] }')).newDocument @? '{ "_id" : 1 }';
ERROR:  operator does not exist: bson @? unknown
LINE 1: ...r": [ { "a": 1 }, { "_id": 3 } ] }')).newDocument @? '{ "_id...
                                                             ^
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
-- would be nice to use the $type function.
SELECT bson_get_value((helio_api_internal.bson_update_document('{}', '{ "": { "b": 2 } }', '{"$or": [ { "a": 1, "_id": 2.0 } ]}')).newDocument, '_id') @=  '{ "" : 2.0 }';
ERROR:  operator does not exist: bson @= unknown
LINE 1: ... { "a": 1, "_id": 2.0 } ]}')).newDocument, '_id') @=  '{ "" ...
                                                             ^
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
SELECT bson_get_value((helio_api_internal.bson_update_document('{}', '{ "": { "b": 2 } }', '{"$or": [ { "a": 1 }, { "_id": 3 } ] }')).newDocument, '_id') @!= '{ "" : 3 }';
ERROR:  operator does not exist: bson @!= unknown
LINE 1: ..."a": 1 }, { "_id": 3 } ] }')).newDocument, '_id') @!= '{ "" ...
                                                             ^
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
-- upsert case: _id collision between query and replace; errors out
SELECT helio_api_internal.bson_update_document('{}', '{ "": { "_id": 3, "b": 2 } }', '{"$and": [ { "a": 1, "_id": 2.0 }]}');
ERROR:  After applying the update, the (immutable) field '_id' was found to have been altered
SELECT helio_api_internal.bson_update_document('{}', '{ "": { "$setOnInsert": {"_id.b": 1}, "$set":{ "_id": 1 } } }', '{"_id.a": 4}');
ERROR:  Updating the path '_id.b' would create a conflict at '_id'
-- _id specified twice, failure for update.
SELECT helio_api_internal.bson_update_document('{}', '{ "": { "_id": 3, "b": 2 } }', '{"$and": [ { "a": 1 }, {"_id": 2.0 }, { "_id": 3.0 }]}');
ERROR:  cannot infer query fields to set, path '_id' is matched twice
-- update scenario tests: $set
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1 }', '{ "": { "$set": { "a": 2 } } }', '{}');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "2" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1, 2, 3 ] }', '{ "": { "$set": { "a": 2 } } }', '{}');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "2" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1, 2, 3 ] }', '{ "": { "$set": { "a.1": "somePath" } } }', '{}');
                                           bson_update_document                                           
----------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, "somePath", { "$numberInt" : "3" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": { "c": 3 }} }', '{ "": { "$set": { "a.b.c": "somePath" } } }', '{}');
                           bson_update_document                           
--------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "c" : "somePath" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": [1, 2, 3 ]} }', '{ "": { "$set": { "a.b.7": 9, "a.b.10": 13 } } }', '{}');
                                                                                                bson_update_document                                                                                                 
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, null, null, null, null, { "$numberInt" : "9" }, null, null, { "$numberInt" : "13" } ] } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": [1, 2, 3 ]} }', '{ "": { "$set": { "a.b.7": 9, "a.b.10": 13 }, "$unset": { "a.b.6": 1 } } }', '{}');
                                                                                                bson_update_document                                                                                                 
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, null, null, null, null, { "$numberInt" : "9" }, null, null, { "$numberInt" : "13" } ] } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": [1, 2, 3 ]} }', '{ "": { "$set": { "a.b.1": { "sub": "1234" }, "a.b.5": [1, 2, 3 ] } } }', '{}');
                                                                                                bson_update_document                                                                                                
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "1" }, { "sub" : "1234" }, { "$numberInt" : "3" }, null, null, [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" } ] ] } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 2 }', '{ "": { "$set": { "b.c.d": { "sub": "1234" } } } }', '{}');
                                              bson_update_document                                              
----------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "2" }, "b" : { "c" : { "d" : { "sub" : "1234" } } } }
(1 row)

SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": { "c": 3 }} }', '{ "": { "$set": { "a.b.c": "somePath", "a.b.c": false } } }', '{}');
ERROR:  Updating the path 'a.b.c' would create a conflict at 'a.b.c'
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [] }', '{ "": { "$set": { "a.2.b": 1, "a.2.c": 1 } } }', '{}');
                                                   bson_update_document                                                   
--------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ null, null, { "b" : { "$numberInt" : "1" }, "c" : { "$numberInt" : "1" } } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [] }', '{ "": { "$set": { "a.1500001": 1 } } }', '{}');
ERROR:  can't backfill more than 1500000 elements
-- update scenario tests: $inc
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$inc": { "a.b": 2 } } }', '{}');
                            bson_update_document                            
----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberInt" : "4" } } }
(1 row)

SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": { "c": 3 }} }', '{ "": { "$set": { "a.b.c": "somePath", "a.b.c": 10 }, "$inc": { "a.b.c": 2 } } }', '{}');
ERROR:  Updating the path 'a.b.c' would create a conflict at 'a.b.c'
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": 2 }', '{ "": { "$set": { "b.c": 10 }, "$inc": { "b.c": 2 } } }', '{}');
ERROR:  Updating the path 'b.c' would create a conflict at 'b.c'
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 2 }', '{ "": { "$inc": { "b.c": 2 } } }', '{}');
                                           bson_update_document                                           
----------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "2" }, "b" : { "c" : { "$numberInt" : "2" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [ 1, 2, 3 ] }', '{ "": { "$inc": { "a.2": 2, "a.6": 1 } } }', '{}');
                                                                      bson_update_document                                                                      
----------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "5" }, null, null, null, { "$numberInt" : "1" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": {"$numberLong": "9223372036854775807"} }', '{ "": { "$inc": { "a": 1 } } }', '{}');
ERROR:  Failed to apply $inc operations to current value ((NumberLong)9223372036854775807) for document {_id: 1}
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": {"$numberLong": "-9223372036854775808"} }', '{ "": { "$inc": { "a": -1 } } }', '{}');
ERROR:  Failed to apply $inc operations to current value ((NumberLong)-9223372036854775808) for document {_id: 1}
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id":{"$oid":"5d505646cf6d4fe581014ab2"}, "a": {"$numberLong": "9223372036854775807"} }', '{ "": { "$inc": { "a": 1 } } }', '{}');
ERROR:  Failed to apply $inc operations to current value ((NumberLong)9223372036854775807) for document {_id: { "$oid" : "5d505646cf6d4fe581014ab2" }}
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": {"$numberDouble": "9223372036854775807"} }', '{ "": { "$inc": { "a": 1 } } }', '{}');
                                  bson_update_document                                   
-----------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberDouble" : "9223372036854775808.0" } }
(1 row)

-- update scenario tests: $min
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$min": { "a.b": 1 } } }', '{}');
                            bson_update_document                            
----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberInt" : "1" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$min": { "a.b": true } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$min": { "a.b": null } } }', '{}');
                   bson_update_document                   
----------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : null } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$min": { "a.b": [1, 2, 3 ] } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$min": { "a.c": [1, 2, 3 ] } } }', '{}');
                                                                     bson_update_document                                                                     
--------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberInt" : "2" }, "c" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" } ] } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1, 2, 3 ] }', '{ "": { "$min": { "a.1": 1 } } }', '{}');
                                                 bson_update_document                                                 
----------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" }, { "$numberInt" : "3" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1, 2, 3 ] }', '{ "": { "$min": { "a.1": 3 } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1, 2, 3 ] }', '{ "": { "$set": { "a.1": -1 }, "$min": { "a.1": 1 } } }', '{}');
ERROR:  Updating the path 'a.1' would create a conflict at 'a.1'
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$min": { "a.b": {"$numberDecimal": "9.99e-100"} } } }', '{}');
                                  bson_update_document                                  
----------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDecimal" : "9.99E-100" } } }
(1 row)

-- update scenario tests: $max
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$max": { "a.b": 3 } } }', '{}');
                            bson_update_document                            
----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberInt" : "3" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$max": { "a.b": true } } }', '{}');
                   bson_update_document                   
----------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : true } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$max": { "a.b": null } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$max": { "a.b": [1, 2, 3 ] } } }', '{}');
                                                      bson_update_document                                                      
--------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" } ] } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$max": { "a.c": [1, 2, 3 ] } } }', '{}');
                                                                     bson_update_document                                                                     
--------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberInt" : "2" }, "c" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" } ] } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1, 2, 3 ] }', '{ "": { "$max": { "a.1": 1 } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1, 2, 3 ] }', '{ "": { "$max": { "a.1": 3 } } }', '{}');
                                                 bson_update_document                                                 
----------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "3" }, { "$numberInt" : "3" } ] }
(1 row)

SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1, 2, 3 ] }', '{ "": { "$set": { "a.1": 3 }, "$max": { "a.1": 1 } } }', '{}');
ERROR:  Updating the path 'a.1' would create a conflict at 'a.1'
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$max": { "a.b": {"$numberDecimal": "9.99e100"} } } }', '{}');
                                  bson_update_document                                  
----------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDecimal" : "9.99E+100" } } }
(1 row)

-- update scenario tests: $bit
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "expdata" :13}', '{ "": { "$bit": { "expdata" : {  "and" : 10 }} }}', '{}');
                          bson_update_document                          
------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "expdata" : { "$numberInt" : "8" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "expdata" :3}', '{ "": { "$bit": { "expdata" : {  "or" : 5 }} }}', '{}');
                          bson_update_document                          
------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "expdata" : { "$numberInt" : "7" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "expdata" :1}', '{ "": { "$bit": { "expdata" : {  "xor" : 5 }} }}', '{}');
                          bson_update_document                          
------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "expdata" : { "$numberInt" : "4" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "expdata" :[13,3,1]}', '{ "": { "$bit": { "expdata.0" : { "and" :10 }  }  }}', '{}');
                                                    bson_update_document                                                    
----------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "expdata" : [ { "$numberInt" : "8" }, { "$numberInt" : "3" }, { "$numberInt" : "1" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "expdata" :13}', '{ "": { "$bit": { "expdata" : { "and" : 0, "or" : 10 }} }}', '{}');
                          bson_update_document                           
-------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "expdata" : { "$numberInt" : "10" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "expdata" :13}', '{ "": { "$bit": { "expdata" : { "or" : 10, "xor" : 10 }} }}', '{}');
                          bson_update_document                          
------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "expdata" : { "$numberInt" : "5" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1}', '{ "": { "$bit": { "expdata" : { "or" : 10 }} }, "upsert" : false}', '{}');
                          bson_update_document                           
-------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "expdata" : { "$numberInt" : "10" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "key": { "x": { "y": [ 100, 200 ]}}, "f": 12 }', '{ "": { "$bit": {"key.x.y.0": {"and": 10}, "f": {"and": 10 }}}}', '{}');
                                                                bson_update_document                                                                
----------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "x" : { "y" : [ { "$numberInt" : "0" }, { "$numberInt" : "200" } ] } }, "f" : { "$numberInt" : "8" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "key": { "x": { "y": 10 }}, "f": 1}', '{ "": { "$bit": { "key.x.y": { "xor": 10 } }}}', '{}');
                                                 bson_update_document                                                 
----------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "x" : { "y" : { "$numberInt" : "0" } } }, "f" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "key": {"x": { "y": [100 , 200 ] } }, "f": 1 } ', '{ "": { "$bit": { "key.x.y.0": { "and": 10 } }}}', '{}');
                                                                bson_update_document                                                                
----------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "x" : { "y" : [ { "$numberInt" : "0" }, { "$numberInt" : "200" } ] } }, "f" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "x": 1 , "f": 1 } ', '{ "": { "$bit": { "x": { "and": { "$numberLong": "1" } } } } }', '{}');
                                      bson_update_document                                      
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberLong" : "1"}, "f" : { "$numberInt" : "1" } }
(1 row)

-- update scenario negative tests: $bit
SELECT helio_api_internal.bson_update_document('{"_id": 1, "expdata" :"abc"}', '{ "": { "$bit": { "expdata" : { "or" :10 }  }  }}', '{}');
ERROR:  Cannot apply $bit to a value of non-integral type.{ "_id" : 1 } has the field expdata of non-integer type string
HINT:  Cannot apply $bit to a value of non-integral type string
SELECT helio_api_internal.bson_update_document('{"_id": 1, "expdata" :13}', '{ "": { "$bit": { "expdata" : { "or" :10.0 }  }  }}', '{}');
ERROR:  The $bit modifier field must be an Integer(32/64 bit); a 'double' is not supported here: { "or" : 10 }
HINT:  The $bit modifier field must be an Integer(32/64 bit); a 'double' is not supported here
SELECT helio_api_internal.bson_update_document('{"_id": 1, "expdata" :13}', '{ "": { "$bit": { "expdata" : { "ors" :10 }  }  }}', '{}');
ERROR:  The $bit modifier only supports 'and', 'or', and 'xor', not 'ors' which is an unknown operator: { "ors" : 10 }
SELECT helio_api_internal.bson_update_document('{"_id": 1, "expdata" :[1,2,3]}', '{ "": { "$bit": { "expdata" : { "or" :10 }  }  }}', '{}');
ERROR:  Cannot apply $bit to a value of non-integral type.{ "_id" : 1 } has the field expdata of non-integer type array
HINT:  Cannot apply $bit to a value of non-integral type array
SELECT helio_api_internal.bson_update_document('{"_id": 1, "expdata" :13}', '{ "": { "$bit": { "expdata" : {  }} }}', '{}');
ERROR:  You must pass in at least one bitwise operation. The format is: {$bit: {field: {and/or/xor: #}}
/* TODO: Make the error compatible with mongo: "errmsg" : "Cannot create field 'y' in element {x: [ { y: 10 } ]}"  */
SELECT helio_api_internal.bson_update_document('{"_id": 1, "key": {"x": [ { "y": 10 } ] }}', '{ "": { "$bit": { "key.x.y": { "and": 0 }}}}', '{}');
ERROR:  Invalid array index path y
-- update scenario tests: $addToSet
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id":1 }', '{ "": {"$addToSet": { "letters": "a" } }}', '{}');
                  bson_update_document                   
---------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ "a" ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1 }', '{ "": {"$addToSet": { "letters": {"a":"b", "c":"d"} } }}', '{}');
                             bson_update_document                             
------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ { "a" : "b", "c" : "d" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1 }', '{ "": {"$addToSet": { "letters": {"$each" : ["a", "b","c"]} } }}', '{}');
                       bson_update_document                        
-------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ "a", "b", "c" ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "letters": ["a", "b"]}', '{ "": {"$addToSet": { "letters": {"c":"d", "e":"f", "g":"h" }} }}', '{}');
                                       bson_update_document                                        
---------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ "a", "b", { "c" : "d", "e" : "f", "g" : "h" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "letters": ["a", "b"]}', '{ "": {"$addToSet": { "letters": "c" } }}', '{}');
                       bson_update_document                        
-------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ "a", "b", "c" ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "letters": ["a", "b"]}', '{ "": {"$addToSet": { "letters": ["c", "d"] } }}', '{}');
                            bson_update_document                            
----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ "a", "b", [ "c", "d" ] ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "letters": ["a", "b"]}', '{ "": {"$addToSet": { "letters": "a" } }}', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "letters": ["a", "b"]}', '{ "": {"$addToSet": { "letters": ["a", "b"] } }}', '{}');
                            bson_update_document                            
----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ "a", "b", [ "a", "b" ] ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "letters": ["a", "b"]}', '{ "": {"$addToSet": { "c":123456} }}', '{}');
                                        bson_update_document                                         
-----------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ "a", "b" ], "c" : [ { "$numberInt" : "123456" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "colors": "blue, green, red" }', '{ "": { "$addToSet": { "newColors": "mauve" } }}', '{}');
                                     bson_update_document                                     
----------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "colors" : "blue, green, red", "newColors" : [ "mauve" ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "colors": ["blue, green, red"] }', '{ "": { "$addToSet": { "colors": {} } }}', '{}');
                            bson_update_document                             
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "colors" : [ "blue, green, red", {  } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "colors": ["blue, green, red", { }] }', '{ "": { "$addToSet": { "colors": {} } }}', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "letters": ["a","b"] }', '{ "": { "$addToSet": { "letters": { "$each": ["c", "d"]}}} }', '{}');
                          bson_update_document                          
------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ "a", "b", "c", "d" ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "letters": ["a","b"] }', '{ "": { "$addToSet": { "letters": { "$each": [ { } ]}}} }', '{}');
                        bson_update_document                        
--------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ "a", "b", {  } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "numbers": [44,78,80,80,80] }', '{ "": { "$addToSet": { "numbers": 80 }} }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "letters": ["a","b"] }', '{ "": { "$addToSet": { "letters": { "$each" : ["c","d","c","d","c","e","d","e"] }}} }', '{}');
                            bson_update_document                             
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ "a", "b", "c", "d", "e" ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "letters": ["a","b","e"] }', '{ "": { "$addToSet": { "letters": { "$each" : ["a","b","c","d","e"] }}} }', '{}');
                            bson_update_document                             
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ "a", "b", "e", "c", "d" ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "numbers": [1,2,5] }', '{ "": { "$addToSet": { "numbers": { "$each" : [1,2,3,4,5,5,4,3,2,1] }}} }', '{}');
                                                                            bson_update_document                                                                            
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "numbers" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "5" }, { "$numberInt" : "3" }, { "$numberInt" : "4" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "key": {"x": { "y": [100 , 200 ] } }, "f": 1 } ', '{ "": { "$addToSet": { "key.x.y": { "$each": [3, 5, 6] } }}}', '{}');
                                                                                                     bson_update_document                                                                                                     
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "x" : { "y" : [ { "$numberInt" : "100" }, { "$numberInt" : "200" }, { "$numberInt" : "3" }, { "$numberInt" : "5" }, { "$numberInt" : "6" } ] } }, "f" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "key": {"x": { "y": [100 , 200, "a" ] } }, "f": 1 } ', '{ "": { "$addToSet": { "key.x.y": { "$each": [3, 5, 6, 7,8,9,"a","b","a",7,8] } }}}', '{}');
                                                                                                                                              bson_update_document                                                                                                                                              
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "x" : { "y" : [ { "$numberInt" : "100" }, { "$numberInt" : "200" }, "a", { "$numberInt" : "3" }, { "$numberInt" : "5" }, { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" }, "b" ] } }, "f" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "key": { "x": { "y": [ 100,3,6 ]}}, "f": [1,3] }', '{ "": { "$addToSet": {"key.x.y": {"$each": [1, 3, 6, 9,"b","a"]}, "f": {"$each": [1,2,4] }}}}', '{}');
                                                                                                                                               bson_update_document                                                                                                                                               
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "x" : { "y" : [ { "$numberInt" : "100" }, { "$numberInt" : "3" }, { "$numberInt" : "6" }, { "$numberInt" : "1" }, { "$numberInt" : "9" }, "b", "a" ] } }, "f" : [ { "$numberInt" : "1" }, { "$numberInt" : "3" }, { "$numberInt" : "2" }, { "$numberInt" : "4" } ] }
(1 row)

-- Update scenario for some complex items: $addToSet
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id" : 1, "letters" : [ [ 1, { "a" : 2 } ], { "a" : [ 1, 2 ] } ] }', '{ "": { "$addToSet": { "letters": { "$each": [1,3,4] } } }}', '{}');
                                                                                                                  bson_update_document                                                                                                                  
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ [ { "$numberInt" : "1" }, { "a" : { "$numberInt" : "2" } } ], { "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] }, { "$numberInt" : "1" }, { "$numberInt" : "3" }, { "$numberInt" : "4" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id" : 1, "letters" : [ [ 1, { "a" : 2 } ], { "a" : [ 1, 2 ] } ] }', '{ "": { "$addToSet": { "letters": { "$each": [[1,3,4]] } } }}', '{}');
                                                                                                                    bson_update_document                                                                                                                    
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ [ { "$numberInt" : "1" }, { "a" : { "$numberInt" : "2" } } ], { "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] }, [ { "$numberInt" : "1" }, { "$numberInt" : "3" }, { "$numberInt" : "4" } ] ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id" : 1, "letters" : [ [ 1, { "a" : 2 } ], { "a" : [ 1, 2 ] } ] }', '{ "": { "$addToSet": { "letters.0": { "$each": [1,3,4] } }}}', '{}');
                                                                                                      bson_update_document                                                                                                      
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ [ { "$numberInt" : "1" }, { "a" : { "$numberInt" : "2" } }, { "$numberInt" : "3" }, { "$numberInt" : "4" } ], { "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id" : 1, "letters" : [ [ 1, { "a" : 2 } ], { "a" : [ 1, 2 ] } ] }', '{ "": {"$addToSet": { "letters.0": { "$each": [1,3,4, { "a":2}, {"a":3} ] } }}}', '{}');
                                                                                                                       bson_update_document                                                                                                                       
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ [ { "$numberInt" : "1" }, { "a" : { "$numberInt" : "2" } }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "a" : { "$numberInt" : "3" } } ], { "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id" : 1, "letters" : [ [ 1, { "a" : 2 } ], { "a" : [ 1, 2 ] } ] }', '{ "": {"$addToSet": { "letters.0": { "$each": [4,{"a":3} ] }, "letters.1.a": { "$each": [4, {"a":2}] }  } }}', '{}');
                                                                                                                                        bson_update_document                                                                                                                                        
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ [ { "$numberInt" : "1" }, { "a" : { "$numberInt" : "2" } }, { "$numberInt" : "4" }, { "a" : { "$numberInt" : "3" } } ], { "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "4" }, { "a" : { "$numberInt" : "2" } } ] } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3]}', '{ "": { "$addToSet" : {"a.3": 4 } } }', '{}');
                                                               bson_update_document                                                               
--------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, [ { "$numberInt" : "4" } ] ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3]}', '{ "": { "$addToSet" : {"a.7": 7 } } }', '{}');
                                                                           bson_update_document                                                                           
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, null, null, null, null, [ { "$numberInt" : "7" } ] ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [[1],[2],[3]]}', '{ "": { "$addToSet" : {"a.0.5": 7 } } }', '{}');
                                                                                 bson_update_document                                                                                 
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ [ { "$numberInt" : "1" }, null, null, null, null, [ { "$numberInt" : "7" } ] ], [ { "$numberInt" : "2" } ], [ { "$numberInt" : "3" } ] ] }
(1 row)

SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [[1],[2],3]}', '{ "": { "$addToSet" : {"a.2.5": 7 } } }', '{}');
ERROR:  Cannot create field '2' in element {2 : 3}
-- update scenario negative tests: $inc
SELECT helio_api_internal.bson_update_document('{"_id": 5, "a": [1,2] }', '{ "": { "$inc": { "a": 30 } } }', '{}');
ERROR:  Cannot apply $inc to a value of non-numeric type. { _id: 5 } has the field 'a' of non-numeric type array
HINT:  Cannot apply $inc to a value of non-numeric type array
SELECT helio_api_internal.bson_update_document('{"_id": 5, "a": {"x":1} }', '{ "": { "$inc": { "a": 30 } } }', '{}');
ERROR:  Cannot apply $inc to a value of non-numeric type. { _id: 5 } has the field 'a' of non-numeric type object
HINT:  Cannot apply $inc to a value of non-numeric type object
SELECT helio_api_internal.bson_update_document('{"_id": 5, "a": "b" }', '{ "": { "$inc": { "a": 30 } } }', '{}');
ERROR:  Cannot apply $inc to a value of non-numeric type. { _id: 5 } has the field 'a' of non-numeric type string
HINT:  Cannot apply $inc to a value of non-numeric type string
-- update scenario negative tests: $addToSet
SELECT helio_api_internal.bson_update_document('{"_id": 1, "colors": "blue, green, red" }', '{ "": { "$addToSet": { "colors": "mauve" } }}', '{}');
ERROR:  Cannot apply $addToSet to non-array field. Field named 'colors' has non-array type string
SELECT helio_api_internal.bson_update_document('{"_id": 1, "letters": ["a","b"] }', '{ "": { "$addToSet": { "letters": { "$each": "c"}}} }', '{}');
ERROR:  The argument to $each in $addToSet must be an array but it was of type string
SELECT helio_api_internal.bson_update_document('{"_id": 1, "letters": ["a","b"] }', '{ "": { "$addToSet": { "letters": { "$each" : {} }}} }', '{}');
ERROR:  The argument to $each in $addToSet must be an array but it was of type object
SELECT helio_api_internal.bson_update_document('{"_id": 1, "letters": ["a","b"] }', '{ "": { "$addToSet": { "letters": { "$ach": ["c"]}}} }', '{}');
                                          bson_update_document                                           
---------------------------------------------------------------------------------------------------------
 ("{ ""_id"" : { ""$numberInt"" : ""1"" }, ""letters"" : [ ""a"", ""b"", { ""$ach"" : [ ""c"" ] } ] }",)
(1 row)

-- update scenario tests: $unset
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$unset": { "a.b": 1 } } }', '{}');
              bson_update_document              
------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : {  } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2, "c": 3 }, "d": 1 }', '{ "": { "$unset": { "a.b": 1 } } }', '{}');
                                           bson_update_document                                           
----------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "c" : { "$numberInt" : "3" } }, "d" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": [ 1, 2, 3 ] } }', '{ "": { "$unset": { "a.b.1": 1 } } }', '{}');
                                             bson_update_document                                             
--------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "1" }, null, { "$numberInt" : "3" } ] } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": [ 1, 2, 3 ] } }', '{ "": { "$unset": { "a.b.5": 1 } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1 }', '{ "": { "$unset": { "a": 1, "b.c": 1 } } }', '{}');
        bson_update_document        
------------------------------------
 { "_id" : { "$numberInt" : "1" } }
(1 row)

-- update scenario tests: $rename
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$rename": { "a.b": "c.d" } } }', '{}');
                                  bson_update_document                                  
----------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : {  }, "c" : { "d" : { "$numberInt" : "2" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$rename": { "a.b": "a.c" } } }', '{}');
                            bson_update_document                            
----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "c" : { "$numberInt" : "2" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$rename": { "a": "c" } } }', '{}');
                            bson_update_document                            
----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "c" : { "b" : { "$numberInt" : "2" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "a": 1 }', '{ "" : { "$rename": { "b": "c" } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "a": 1, "c": 4}', '{ "": { "$rename": { "b": "c.d" } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

-- $rename when rename source node doesn't exist but target node exist, this should be a no-op
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "a": 1, "c": 4}', '{ "": { "$rename": { "b": "a" } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "a": {"b": 1, "d": 2}}', '{ "": { "$rename": { "a.b": "c" } } }', '{}');
                                           bson_update_document                                           
----------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "d" : { "$numberInt" : "2" } }, "c" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "a": {"b": 1}}', '{ "": { "$rename": { "a.b": "d" } } }', '{}');
                             bson_update_document                             
------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : {  }, "d" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "a": 1}', '{ "": { "$rename": { "b": "a" }, "$set": {"x" : 1} } }', '{}');
                                      bson_update_document                                      
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "a": 1, "x": 1}', '{ "": { "$rename": { "b": "a" }, "$inc": {"x" : 1} } }', '{}');
                                      bson_update_document                                      
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "b": 1, "x": 1}', '{ "": { "$rename": { "a": "b", "x": "y" } } }', '{}');
                                      bson_update_document                                      
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "1" } }
(1 row)

-- update scenario tests: $mul
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberDouble" : "2.0"} } }', '{ "": { "$mul": { "a.b": 0 } } }', '{}');
                              bson_update_document                               
---------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDouble" : "0.0" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberInt" : "2" } } }', '{ "": { "$mul": { "a.b": 0 } } }', '{}');
                            bson_update_document                            
----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberInt" : "0" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberLong" : "2" } } }', '{ "": { "$mul": { "a.b": 0 } } }', '{}');
                            bson_update_document                            
----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberLong" : "0"} } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberLong" : "9223372036854775807" } } }', '{ "": { "$mul": { "a.b": {"$numberLong": "0"} } } }', '{}');
                            bson_update_document                            
----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberLong" : "0"} } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberDouble" : "0.0"} } }', '{ "": { "$mul": { "a.b": 10 } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberInt" : "0" } } }', '{ "": { "$mul": { "a.b": 10 } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberLong" : "0" } } }', '{ "": { "$mul": { "a.b": 10 } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$mul": { "a.b": 10 } } }', '{}');
                            bson_update_document                             
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberInt" : "20" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$mul": { "a.b": -10 } } }', '{}');
                             bson_update_document                             
------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberInt" : "-20" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$mul": { "a.b": {"$numberDouble": "+1.0"} } } }', '{}');
                              bson_update_document                               
---------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDouble" : "2.0" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$mul": { "a.b": 1.1 } } }', '{}');
                                       bson_update_document                                        
---------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDouble" : "2.2000000000000001776" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$mul": { "a.b": -1.1 } } }', '{}');
                                        bson_update_document                                        
----------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDouble" : "-2.2000000000000001776" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$mul": { "a.c": {"$numberInt": "2"} } } }', '{}');
                                           bson_update_document                                           
----------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberInt" : "2" }, "c" : { "$numberInt" : "0" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$mul": { "a.c": {"$numberLong": "2"} } } }', '{}');
                                           bson_update_document                                           
----------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberInt" : "2" }, "c" : { "$numberLong" : "0"} } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$mul": { "a.c": {"$numberDouble": "2"} } } }', '{}');
                                             bson_update_document                                              
---------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberInt" : "2" }, "c" : { "$numberDouble" : "0.0" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$mul": { "a.c": {"$numberDecimal": "2"} } } }', '{}');
                                             bson_update_document                                             
--------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberInt" : "2" }, "c" : { "$numberDecimal" : "0" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberInt": "100"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberInt": "500"} } } }', '{}');
                              bson_update_document                              
--------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberInt" : "50000" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberInt": "2147483647"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberInt": "2147483647"} } } }', '{}');
                                     bson_update_document                                     
----------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberLong" : "4611686014132420609"} } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberInt": "2147483647"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberLong": "2147483647"} } } }', '{}');
                                     bson_update_document                                     
----------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberLong" : "4611686014132420609"} } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberInt": "2147483647"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberDouble": "2.0"} } } }', '{}');
                                   bson_update_document                                   
------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDouble" : "4294967294.0" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberLong": "2147483647"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberInt": "-2147483647"} } } }', '{}');
                                     bson_update_document                                      
-----------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberLong" : "-4611686014132420609"} } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberLong": "2147483647"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberLong": "-2147483647"} } } }', '{}');
                                     bson_update_document                                      
-----------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberLong" : "-4611686014132420609"} } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberLong": "9223372036854775807"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberDouble": "2.0"} } } }', '{}');
                                        bson_update_document                                        
----------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDouble" : "18446744073709551616.0" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberDouble": "10.0"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberInt": "2"} } } }', '{}');
                               bson_update_document                               
----------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDouble" : "20.0" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberDouble": "10.0"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberLong": "2"} } } }', '{}');
                               bson_update_document                               
----------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDouble" : "20.0" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberDouble": "10.0"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberDouble": "2.0"} } } }', '{}');
                               bson_update_document                               
----------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDouble" : "20.0" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": NaN } }','{ "": { "$mul": { "a.b": 2 } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }','{ "": { "$mul": { "a.b": NaN } } }', '{}');
                              bson_update_document                               
---------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDouble" : "NaN" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberDecimal": "10"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberInt": "2"} } } }', '{}');
                              bson_update_document                               
---------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDecimal" : "20" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberInt": "10"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberDecimal": "2"} } } }', '{}');
                              bson_update_document                               
---------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDecimal" : "20" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberDecimal": "10"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberLong": "2"} } } }', '{}');
                              bson_update_document                               
---------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDecimal" : "20" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberLong": "10"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberDecimal": "2"} } } }', '{}');
                              bson_update_document                               
---------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDecimal" : "20" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberDecimal": "10"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberDouble": "2"} } } }', '{}');
                                      bson_update_document                                      
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDecimal" : "20.00000000000000" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberDouble": "10"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberDecimal": "2"} } } }', '{}');
                                     bson_update_document                                      
-----------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberDecimal" : "20.0000000000000" } } }
(1 row)

-- int64 overflow should coerce to double: $mul
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberLong": "9223372036854775807"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberInt": "2"} } } }', '{}');
ERROR:  Failed to apply $mul operations to current ((NumberLong)9223372036854775807) value for document { _id: 1 }
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {"$numberLong": "-9223372036854775807"} } }',
                                                '{ "": { "$mul": { "a.b": {"$numberInt": "2"} } } }', '{}');
ERROR:  Failed to apply $mul operations to current ((NumberLong)-9223372036854775807) value for document { _id: 1 }
-- update scenario error tests: $mul
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }','{ "": { "$mul": { "a.b": "Hello" } } }', '{}');
ERROR:  Cannot multiply with non-numeric argument: { a.b : "Hello" }
HINT:  Cannot multiply with non-numeric argument of type string 
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": "Text" } }','{ "": { "$mul": { "a.b": 2 } } }', '{}');
ERROR:  Cannot apply $mul to a value of non-numeric type. { _id: 1 } has the field 'b' of non-numeric type string
HINT:  Cannot apply $mul to a value of non-numeric type string
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": [1,2,3] } }','{ "": { "$mul": { "a.b": 2 } } }', '{}');
ERROR:  Cannot apply $mul to a value of non-numeric type. { _id: 1 } has the field 'b' of non-numeric type array
HINT:  Cannot apply $mul to a value of non-numeric type array
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": {} } }','{ "": { "$mul": { "a.b": 2 } } }', '{}');
ERROR:  Cannot apply $mul to a value of non-numeric type. { _id: 1 } has the field 'b' of non-numeric type object
HINT:  Cannot apply $mul to a value of non-numeric type object
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": null } }','{ "": { "$mul": { "a.b": 2 } } }', '{}');
ERROR:  Cannot apply $mul to a value of non-numeric type. { _id: 1 } has the field 'b' of non-numeric type null
HINT:  Cannot apply $mul to a value of non-numeric type null
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": true } }','{ "": { "$mul": { "a.b": 2 } } }', '{}');
ERROR:  Cannot apply $mul to a value of non-numeric type. { _id: 1 } has the field 'b' of non-numeric type bool
HINT:  Cannot apply $mul to a value of non-numeric type bool
-- $pullAll operator- positive testcases
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id" : 1, "scores" : [ 0, 2, 5, 5, 1, 0 ] }', '{ "": { "$pullAll": { "scores": [0,5] } }}', '{}');
                                       bson_update_document                                        
---------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "scores" : [ { "$numberInt" : "2" }, { "$numberInt" : "1" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id" : 1, "letters" : [ [ 1, { "a" : 2 } ], { "a" : [ 1, 2 ] } ] }', '{ "": { "$pullAll": { "letters": [1,3,4] } }}', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id" : 1, "letters" : [ [ 1, { "a" : 2 } ], { "a" : [ 1, 2 ] } ] }', '{ "": { "$pullAll": { "letters.0": [1,3,4] } }}', '{}');
                                                                  bson_update_document                                                                  
--------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "letters" : [ [ { "a" : { "$numberInt" : "2" } } ], { "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id" : 1, "scores" : [ 0, 2, 5, 5, 1, 0 ] }', '{ "": { "$pullAll": { } }}', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id" : 1, "scores" : [ 0, 2, 5, 5, 1, 0 ] }', '{ "": { "$pullAll": { "score": [0,5] } }}', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id" : 1, "scores" : [ 0, 2, 5, 5, 1, 0 ] }', '{ "": { "$pullAll": { "a.b": [0,5] } }}', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id" : 1, "scores" : {} }', '{ "": { "$pullAll": { "scores.top": [0,5] } }}', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id" : 1, "scores" : {"top": [0,5,10,11]} }', '{ "": { "$pullAll": { "scores.top": [0,5] } }}', '{}');
                                              bson_update_document                                               
-----------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "scores" : { "top" : [ { "$numberInt" : "10" }, { "$numberInt" : "11" } ] } }
(1 row)

-- $pullAll operator- negative testcases
SELECT helio_api_internal.bson_update_document('{"_id" : 1, "scores" : [ 0, 2, 5, 5, 1, 0 ] }', '{ "": { "$pullAll": { "scores": 0 } }}', '{}');
ERROR:  $pullAll requires an array argument but was given a int
SELECT helio_api_internal.bson_update_document('{"_id" : 1, "scores" : "a" }', '{ "": { "$pullAll": { "scores": [0] } }}', '{}');
ERROR:  Cannot apply $pullAll to a non-array value
SELECT helio_api_internal.bson_update_document('{"_id" : 1, "letters" : [ [ 1, { "a" : 2 } ], { "a" : [ 1, 2 ] } ] }', '{ "": { "$pullAll": { "letters.1": [1,3,4] } }}', '{}');
ERROR:  Cannot apply $pullAll to a non-array value
-- rename overwrites.
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2, "c": 1 } }', '{ "": { "$rename": { "a.b": "a.c" } } }', '{}');
                            bson_update_document                            
----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "c" : { "$numberInt" : "2" } } }
(1 row)

-- update scenario tests: $setOnInsert (non-upsert)
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": 2 } }', '{ "": { "$setOnInsert": { "a.b": 1, "c": 2, "d": 4 } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

-- upsert:
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 2, "_id": 1 } } }', '{}');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "2" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 2 } } }', '{ "_id": 1 }');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "2" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 2 } } }', '{ "_id": { "$eq": 1 } }');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "2" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 2, "h": 6 } } }', '{ "_id": { "$eq": 1 }, "f": 3, "g": 4, "h": 5 }');
                                                                    bson_update_document                                                                    
------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "f" : { "$numberInt" : "3" }, "g" : { "$numberInt" : "4" }, "h" : { "$numberInt" : "6" }, "a" : { "$numberInt" : "2" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 2, "h": 6 } } }', '{ "$and": [ { "_id": { "$eq": 1 }}, {"f": 3 }, { "g": 4 }, { "h": 5 } ] }');
                                                                    bson_update_document                                                                    
------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "f" : { "$numberInt" : "3" }, "g" : { "$numberInt" : "4" }, "h" : { "$numberInt" : "6" }, "a" : { "$numberInt" : "2" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 2, "h": 6 } } }', '{ "_id": { "$eq": 1 }, "$or": [ { "_id": { "$eq": 1 }}, {"f": 3 }, { "g": 4 }, { "h": 5 } ] }');
                                      bson_update_document                                      
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "2" }, "h" : { "$numberInt" : "6" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 2, "h": 6 } } }', '{ "_id": { "$eq": 1 }, "$or": [ { "g": 4 } ] }');
                                                     bson_update_document                                                     
------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "g" : { "$numberInt" : "4" }, "a" : { "$numberInt" : "2" }, "h" : { "$numberInt" : "6" } }
(1 row)

--upsert querySpec has document
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 5, "_id": 1 } } }', '{"a.x.y":10}');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "5" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a.y": 5, "_id": 1 } } }', '{"a.x":{"c":"d"}}');
                                      bson_update_document                                       
-------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "x" : { "c" : "d" }, "y" : { "$numberInt" : "5" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a.y": 10, "_id": 1 } } }', '{"a": {"x":5}}');
                                           bson_update_document                                            
-----------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "10" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": {"b":5}, "_id": 1 } } }', '{"a.c":8}');
                            bson_update_document                            
----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "$numberInt" : "5" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": {"x":{"z":10}}, "_id": 1} }}', '{"a":{"x":{"y":5}}}');
                                 bson_update_document                                  
---------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "x" : { "z" : { "$numberInt" : "10" } } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a.x.z": 10, "_id": 1 } } }', '{"a":{"x":{"y":5}}}');
                                                bson_update_document                                                 
---------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "x" : { "y" : { "$numberInt" : "5" }, "z" : { "$numberInt" : "10" } } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": {"x":{"z":10}}, "_id": 1 } } }', '{"a.x.y":10}');
                                 bson_update_document                                  
---------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "x" : { "z" : { "$numberInt" : "10" } } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a.x.z":10, "_id": 1 } } }', '{"a.x.y":10}');
                                                 bson_update_document                                                 
----------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "x" : { "y" : { "$numberInt" : "10" }, "z" : { "$numberInt" : "10" } } } }
(1 row)

--upsert querySpec has array
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a.11":11, "_id": 1 } } }', '{"a":[0,1,2,3,4,5,6,7,8,9,10]}');
                                                                                                                                                              bson_update_document                                                                                                                                                              
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "0" }, { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" }, { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" }, { "$numberInt" : "10" }, { "$numberInt" : "11" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a.0":0, "a.6":6, "_id": 1 } } }', '{"a":[8,1,2,3]}');
                                                                               bson_update_document                                                                               
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "0" }, { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, null, null, { "$numberInt" : "6" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a.0":1, "a.1":2, "_id": 1 } } }', '{"a":[{"x":1},{"x":2},{"x":3}]}');
                                                      bson_update_document                                                      
--------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "x" : { "$numberInt" : "3" } } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a.0.1": 5 , "_id": 1} } }', '{"a":[[1,2],[3,4]]}');
                                                                 bson_update_document                                                                 
------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ [ { "$numberInt" : "1" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "3" }, { "$numberInt" : "4" } ] ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a.0.x": 10 , "_id": 1} } }', '{"a":[{"x":1},{"x":2}]}');
                                               bson_update_document                                                
-------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "x" : { "$numberInt" : "10" } }, { "x" : { "$numberInt" : "2" } } ] }
(1 row)

--upsert $rename cases
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$rename": { "a": "b"}, "$set":{ "_id": 1 } } }', '{"b":1}');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$rename": { "b": "a"}, "$set":{ "_id": 1 } } }', '{"b":1}');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$rename": { "a.b": "a.c"}, "$set":{ "_id": 1 } } }', '{"a.b":10}');
                            bson_update_document                             
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "c" : { "$numberInt" : "10" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$rename": { "a.b": "a.c"}, "$set":{ "_id": 1 } } }', '{"a":{"b":10}}');
                            bson_update_document                             
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "c" : { "$numberInt" : "10" } } }
(1 row)

--upsert querySpec with $gt, $lt, $gte, $lte
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "_id":1} } }', '{"a.1":{"$gt": 100},"a.2":{"x":10}}');
                                 bson_update_document                                  
---------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "2" : { "x" : { "$numberInt" : "10" } } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "_id":1} } }', '{"a.x":{"$lt": 100},"a.y":{"x":10}}');
                                 bson_update_document                                  
---------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "y" : { "x" : { "$numberInt" : "10" } } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "_id":1} } }', '{"a.x":{"$gte": 100},"a.y":{"x":10}}');
                                 bson_update_document                                  
---------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "y" : { "x" : { "$numberInt" : "10" } } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "_id":1} } }', '{"a.x":{"$lte": 100},"a.y":{"x":10}}');
                                 bson_update_document                                  
---------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "y" : { "x" : { "$numberInt" : "10" } } } }
(1 row)

-- upsert querySpec with implicit AND - valid cases
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "_id": 1, "a": 1} } }', '{"b": { "$eq": 2, "$in": [ 1, 2 ] } }'); 
                                      bson_update_document                                      
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "_id": 1, "a": 1} } }', '{"b": { "$eq": 2, "$gt": 20, "$lt": 40 } }');
                                      bson_update_document                                      
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "_id": 1, "a": 1} } }', '{"b": { "$all": [ 2 ], "$in": [ 1, 2 ] } }');
                                      bson_update_document                                      
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "_id": 1, "a": 1} } }', '{"b": { "$all": [ 2 ], "$ne": 40 } }');
                                      bson_update_document                                      
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "1" } }
(1 row)

-- upsert querySpec with implicit AND - Invalid cases
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "_id": 1, "a": 1} } }', '{"b": { "$eq": 2, "$all": [ 2 ] } }');
ERROR:  cannot infer query fields to set, path 'b' is matched twice
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "_id": 1, "a": 1} } }', '{"b": { "$eq": 2, "$all": [ 2 ], "$in" : [ 2 ] } }');
ERROR:  cannot infer query fields to set, path 'b' is matched twice
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "_id": 1, "a": 1} } }', '{"b": { "$all": [ 2, 1 ], "$in": [ 1, 2 ] } }');
ERROR:  cannot infer query fields to set, path 'b' is matched twice
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "_id": 1, "a": 1} } }', '{"b": { "$all": [ 2, 1 ], "$in": [ 2 ] } }');
ERROR:  cannot infer query fields to set, path 'b' is matched twice
-- upsert querySpec with implicit AND on "_id" - valid cases
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 1} } }', '{"_id": { "$eq": 2, "$in": [ 1, 2 ] } }'); 
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 1} } }', '{"_id": { "$eq": 2, "$gt": 20, "$lt": 40 } }');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 1} } }', '{"_id": { "$all": [ 2 ], "$in": [ 1, 2 ] } }');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 1} } }', '{"_id": { "$all": [ 2 ], "$ne": 40 } }');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "1" } }
(1 row)

-- upsert querySpec with implicit AND on "_id" - Invalid cases
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 1} } }', '{"_id": { "$eq": 2, "$all": [ 2 ] } }');
ERROR:  cannot infer query fields to set, path '_id' is matched twice
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 1} } }', '{"_id": { "$eq": 2, "$all": [ 2 ], "$in" : [ 2 ] } }');
ERROR:  cannot infer query fields to set, path '_id' is matched twice
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 1} } }', '{"_id": { "$all": [ 2, 1 ], "$in": [ 1, 2 ] } }');
ERROR:  cannot infer query fields to set, path '_id' is matched twice
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 1} } }', '{"_id": { "$all": [ 2, 1 ], "$in": [ 2 ] } }');
ERROR:  cannot infer query fields to set, path '_id' is matched twice
-- cannot modify id cases
SELECT helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 2, "_id": 2 } } }', '{ "_id": 1 }');
ERROR:  Performing an update on the path '_id' would modify the immutable field '_id'
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": 1 }', '{ "": { "$set": { "_id": 2 } } }', '{}');
ERROR:  Performing an update on the path '_id' would modify the immutable field '_id'
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": 1 }', '{ "": { "$inc": { "_id": 2 } } }', '{}');
ERROR:  Performing an update on the path '_id' would modify the immutable field '_id'
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": 1 }', '{ "": { "$max": { "_id": 2 } } }', '{}');
ERROR:  Performing an update on the path '_id' would modify the immutable field '_id'
-- Multiple operators: no-op
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": {}, "x": 0 }', '{ "": { "$pullAll": { "a.b": [0] }, "$unset": { "d": 1 }, "$mul": { "x": 10 } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": {}, "x": 0 }', '{ "": { "$pullAll": { "a.b": [0] }, "$unset": { "d": 1 }, "$bit": { "x": { "and": 0 } } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

-- Multiple operators at least one update
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [0,0,0,0,4], "x": 0 }', '{ "": { "$pullAll": { "a": [0] }, "$unset": { "d": 1 }, "$mul": { "x": 10 } } }', '{}');
                                        bson_update_document                                        
----------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "4" } ], "x" : { "$numberInt" : "0" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [0,0,0,0,4], "x": 10 }', '{ "": { "$pullAll": { "b": [0] }, "$unset": { "a": 1 }, "$mul": { "x": 10 } } }', '{}');
                        bson_update_document                        
--------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "100" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": {"b": [0,0,0,0,0,1,1,1,2]}, "x": 10 }', '{ "": { "$pullAll": { "a.b": [0,1] }, "$set": { "d": 1 }, "$mul": { "x": 1 } } }', '{}');
                                                            bson_update_document                                                             
---------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "2" } ] }, "x" : { "$numberInt" : "10" }, "d" : { "$numberInt" : "1" } }
(1 row)

-- aggregation pipeline: project & unset
-- -- simple case for project
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1, "b": 2 }', '{ "": [ { "$project": { "a": 1, "c": { "$literal": 2.0 }} }] }', '{}');
                                        bson_update_document                                         
-----------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "c" : { "$numberDouble" : "2.0" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1, "b": 2 }', '{ "": [ { "$project": { "b": 0 } }] }', '{}');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "x": 1, "y": [{ "z": 1, "foo": 1 }] }', '{ "": [ { "$unset": ["x", "y.z"] } ] }', '{}');
                               bson_update_document                               
----------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "y" : [ { "foo" : { "$numberInt" : "1" } } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 2, "title": "Bees Babble", "isbn": "999999999333", "author": { "last": "Bumble", "first": "Bee" }, "copies": [{ "warehouse": "A", "qty": 2 }, { "warehouse": "B", "qty": 5 }] }',
                                               '{ "": [ { "$unset": "copies" } ] }', '{}');
                                                          bson_update_document                                                           
-----------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "title" : "Bees Babble", "isbn" : "999999999333", "author" : { "last" : "Bumble", "first" : "Bee" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 2, "title": "Bees Babble", "isbn": "999999999333", "author": { "last": "Bumble", "first": "Bee" }, "copies": [{ "warehouse": "A", "qty": 2 }, { "warehouse": "B", "qty": 5 }] }',
                                               '{ "": [ { "$unset": ["isbn", "author.first", "copies.warehouse"] } ] }', '{}');
                                                                                 bson_update_document                                                                                 
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "title" : "Bees Babble", "author" : { "last" : "Bumble" }, "copies" : [ { "qty" : { "$numberInt" : "2" } }, { "qty" : { "$numberInt" : "5" } } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "name": "John Doe" }',
                                               '{ "": [ { "$project": { "_id": 1, "name": 1 } }, { "$unset": "name" } ] }', '{}');
        bson_update_document        
------------------------------------
 { "_id" : { "$numberInt" : "1" } }
(1 row)

-- -- project with upsert uses fields from query
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": [ { "$project": { "b": { "$literal": 2.0 }, "d": 1 } }] }', '{ "d" : 1, "_id": 2.0 }');
                                           bson_update_document                                           
----------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberDouble" : "2.0" }, "d" : { "$numberInt" : "1" }, "b" : { "$numberDouble" : "2.0" } }
(1 row)

-- -- project and unset (shoudl just project _id )
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1, "b": 2 }', '{ "": [ { "$unset": "b" }, { "$project": { "b": 1 } }] }', '{}');
        bson_update_document        
------------------------------------
 { "_id" : { "$numberInt" : "1" } }
(1 row)

-- project and unset silently ignore removing the _id field.
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1, "b": 2 }', '{ "": [ { "$unset": "_id" }] }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1, "b": 2 }', '{ "": [ { "$project": { "_id": 0 } } ] }', '{}');
 bson_update_document 
----------------------
 
(1 row)

-- -- simple case for addFields
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1, "b": 2 }', '{ "": [ { "$addFields": { "a": 1, "c": { "$literal": 2.0 }} }] }', '{}');
                                                       bson_update_document                                                        
-----------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "2" }, "c" : { "$numberDouble" : "2.0" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1, "b": 2 }', '{ "": [ { "$addFields": { "b": 0 } }] }', '{}');
                                      bson_update_document                                      
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "0" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "name": "John Doe" }', '{ "": [ { "$addFields": { "_id": 1, "name": 1 } }, { "$unset": "name" } ] }', '{}');
        bson_update_document        
------------------------------------
 { "_id" : { "$numberInt" : "1" } }
(1 row)

SELECT helio_api_internal.bson_update_document('{ "_id": 1, "name": "John Doe" }', '{ "": [ { "$addFields": { "_id": 10, "name": 1 } }, { "$unset": "name" } ] }', '{}');
ERROR:  Performing an update on the path '_id' would modify the immutable field '_id'
SELECT helio_api_internal.bson_update_document('{ "_id": 1, "name": "John Doe" }', '{ "": [ { "$addFields": { "_id": 30.5, "name": 1 } }, { "$unset": "name" } ] }', '{}');
ERROR:  Performing an update on the path '_id' would modify the immutable field '_id'
SELECT helio_api_internal.bson_update_document('{ "_id": 1, "name": "John Doe" }', '{ "": [ { "$addFields": { "_id": false, "name": 1 } }, { "$unset": "name" } ] }', '{}');
ERROR:  Performing an update on the path '_id' would modify the immutable field '_id'
SELECT helio_api_internal.bson_update_document('{ "_id": 1, "name": "John Doe" }', '{ "": [ { "$addFields": { "_id": "someString", "name": 1 } }, { "$unset": "name" } ] }', '{}');
ERROR:  Performing an update on the path '_id' would modify the immutable field '_id'
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": [ { "$addFields": { "b": { "$literal": 2.0 }, "d": 1 } }] }', '{ "d" : 1, "_id": 2.0 }');
                                           bson_update_document                                           
----------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberDouble" : "2.0" }, "d" : { "$numberInt" : "1" }, "b" : { "$numberDouble" : "2.0" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1, "b": 2 }', '{ "": [ { "$unset": "b" }, { "$addFields": { "b": 1 } }] }', '{}');
                                      bson_update_document                                      
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }
(1 row)

-- -- simple case for set
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1, "b": 2 }', '{ "": [ { "$set": { "a": 1, "c": { "$literal": 2.0 }} }] }', '{}');
                                                       bson_update_document                                                        
-----------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "2" }, "c" : { "$numberDouble" : "2.0" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1, "b": 2 }', '{ "": [ { "$set": { "b": 0 } }] }', '{}');
                                      bson_update_document                                      
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "0" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{ "_id": 1, "name": "John Doe" }', '{ "": [ { "$set": { "_id": 1, "name": 1 } }, { "$unset": "name" } ] }', '{}');
        bson_update_document        
------------------------------------
 { "_id" : { "$numberInt" : "1" } }
(1 row)

SELECT helio_api_internal.bson_update_document('{ "_id": 1, "name": "John Doe" }', '{ "": [ { "$set": { "_id": 10, "name": 1 } }, { "$unset": "name" } ] }', '{}');
ERROR:  Performing an update on the path '_id' would modify the immutable field '_id'
SELECT helio_api_internal.bson_update_document('{ "_id": 1, "name": "John Doe" }', '{ "": [ { "$set": { "_id": 30.5, "name": 1 } }, { "$unset": "name" } ] }', '{}');
ERROR:  Performing an update on the path '_id' would modify the immutable field '_id'
SELECT helio_api_internal.bson_update_document('{ "_id": 1, "name": "John Doe" }', '{ "": [ { "$set": { "_id": false, "name": 1 } }, { "$unset": "name" } ] }', '{}');
ERROR:  Performing an update on the path '_id' would modify the immutable field '_id'
SELECT helio_api_internal.bson_update_document('{ "_id": 1, "name": "John Doe" }', '{ "": [ { "$set": { "_id": "someString", "name": 1 } }, { "$unset": "name" } ] }', '{}');
ERROR:  Performing an update on the path '_id' would modify the immutable field '_id'
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": [ { "$set": { "b": { "$literal": 2.0 }, "d": 1 } }] }', '{ "d" : 1, "_id": 2.0 }');
                                           bson_update_document                                           
----------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberDouble" : "2.0" }, "d" : { "$numberInt" : "1" }, "b" : { "$numberDouble" : "2.0" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1, "b": 2 }', '{ "": [ { "$unset": "b" }, { "$set": { "b": 1 } }] }', '{}');
                                      bson_update_document                                      
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }
(1 row)

-- simple case for replaceRoot
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1, "b": 2 }', '{ "": [ { "$replaceRoot" : { "newRoot": { "a_key" : "$a" }} }]}', '{}');
                         bson_update_document                         
----------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a_key" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 2, "a": { "b": {"arr" : [1, 2, 3, {}], "a" : {"b": 1}, "int" : 1} }, "b": 2 }', '{ "": [ { "$replaceRoot" : { "newRoot": { "a_b_key" : "$a.b" }} }]}', '{}');
                                                                                                 bson_update_document                                                                                                 
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a_b_key" : { "arr" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, {  } ], "a" : { "b" : { "$numberInt" : "1" } }, "int" : { "$numberInt" : "1" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 2, "a": { "b": {"arr" : [1, 2, 3, {}], "a" : {"b": 1}, "int" : 1} }, "b": 2 }', '{ "": [ { "$replaceRoot" : { "newRoot": { "a_b_key" : "$a.b", "a_key" : "$a", "a_b_arr_key" : "$a.b.arr" }} }]}', '{}');
                                                                                                                                                                                                                                               bson_update_document                                                                                                                                                                                                                                               
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a_b_key" : { "arr" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, {  } ], "a" : { "b" : { "$numberInt" : "1" } }, "int" : { "$numberInt" : "1" } }, "a_key" : { "b" : { "arr" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, {  } ], "a" : { "b" : { "$numberInt" : "1" } }, "int" : { "$numberInt" : "1" } } }, "a_b_arr_key" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, {  } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 2, "a": { "b": {"arr" : [1, 2, 3, {}], "a" : {"b": 1}, "int" : 1} }, "b": 2 }', '{ "": [ { "$replaceRoot" : { "newRoot": "$a.b" }}]}', '{}');
                                                                                         bson_update_document                                                                                         
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "arr" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, {  } ], "a" : { "b" : { "$numberInt" : "1" } }, "int" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 2, "a": { "b": {"arr" : [1, 2, 3, {}], "a" : {"b": 1}, "int" : 1} }, "b": 2 }', '{ "": [ { "$replaceRoot" : { "newRoot":  {"$mergeObjects":  [ { "dogs": 0, "cats": 0, "birds": 0, "fish": 0 }, "$a.b" ] } }}]}', '{}');
                                                                                                                                                           bson_update_document                                                                                                                                                            
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "dogs" : { "$numberInt" : "0" }, "cats" : { "$numberInt" : "0" }, "birds" : { "$numberInt" : "0" }, "fish" : { "$numberInt" : "0" }, "arr" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, {  } ], "a" : { "b" : { "$numberInt" : "1" } }, "int" : { "$numberInt" : "1" } }
(1 row)

-- simple case for replaceWith
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1, "b": 2 }', '{ "": [ { "$replaceWith" : { "newRoot": { "a_key" : "$a" }} }]}', '{}');
                                 bson_update_document                                 
--------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "newRoot" : { "a_key" : { "$numberInt" : "1" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 2, "a": { "b": {"arr" : [1, 2, 3, {}], "a" : {"b" : 1}, "int" : 1} }, "b": 2 }', '{ "": [ { "$replaceWith" : { "newRoot": { "a_b_key" : "$a.b" }} }]}', '{}');
                                                                                                         bson_update_document                                                                                                         
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "newRoot" : { "a_b_key" : { "arr" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, {  } ], "a" : { "b" : { "$numberInt" : "1" } }, "int" : { "$numberInt" : "1" } } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 2, "a": { "b": {"arr" : [1, 2, 3, {}], "a" : {"b": 1}, "int" : 1} }, "b": 2 }', '{ "": [ { "$replaceWith" : { "newRoot": { "a_b_key" : "$a.b", "a_key" : "$a", "a_b_arr_key" : "$a.b.arr" }} }]}', '{}');
                                                                                                                                                                                                                                                       bson_update_document                                                                                                                                                                                                                                                       
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "newRoot" : { "a_b_key" : { "arr" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, {  } ], "a" : { "b" : { "$numberInt" : "1" } }, "int" : { "$numberInt" : "1" } }, "a_key" : { "b" : { "arr" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, {  } ], "a" : { "b" : { "$numberInt" : "1" } }, "int" : { "$numberInt" : "1" } } }, "a_b_arr_key" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, {  } ] } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 2, "a": { "b": {"arr" : [1, 2, 3, {}], "a" : {"b": 1}, "int" : 1} }, "b": 2 }', '{ "": [ { "$replaceWith" : { "newRoot": "$a.b" }}]}', '{}');
                                                                                                 bson_update_document                                                                                                 
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "newRoot" : { "arr" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, {  } ], "a" : { "b" : { "$numberInt" : "1" } }, "int" : { "$numberInt" : "1" } } }
(1 row)

-- update: Error cases:
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b": [1, 2, 3 ]} }', '{ "": { "$set": { "a.b.7": 9, "a.b.10": 13 }, "$unset": { "a.b.7": 1 } } }', '{}');
ERROR:  Updating the path 'a.b.7' would create a conflict at 'a.b.7'
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [ { "b": 2 } ] }', '{ "": { "$rename": { "a.0": "b" } } }', '{}');
ERROR:  The source field of a rename cannot be an array element
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [ { "b": 2 } ] }', '{ "": { "$rename": { "a.0.b": "a.1.c" } } }', '{}');
ERROR:  The source field of a rename cannot be an array element
SELECT helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "a": 2, "h": 6 } } }', '{ "_id": { "$eq": 1 }, "c": 3, "$and": [ { "c": 4 } ] }');
ERROR:  cannot infer query fields to set, path 'c' is matched twice
SELECT helio_api_internal.bson_update_document('{"a": [1], "b": {"c": [2]}, "d": [{"e": 3}], "f": 4}', '{ "": { "$rename" :{"f":"d.e"}} }', '{}');
ERROR:  Invalid array index path e
SELECT helio_api_internal.bson_update_document('{"a": [1], "b": {"c": [2]}, "d": [{"e": 3}], "f": 4}', '{ "": { "$rename" :{"f":"d.e"}} }', '{}');
ERROR:  Invalid array index path e
SELECT helio_api_internal.bson_update_document('{"a": [1], "b": {"c": [2]}, "d": [{"e": 3}], "f": 4}', '{ "": { "$rename" :{"d.e":"d.c"}} }', '{}');
ERROR:  Invalid array index path e
SELECT helio_api_internal.bson_update_document('{"a": [1], "b": {"c": [2]}, "d": [{"e": 3}], "f": 4}', '{ "": { "$rename" :{"f":"a.0"}} }', '{}');
ERROR:  The target field of a rename cannot be an array element
-- $push top level input validation with all modifiers
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": {"$numberInt" : "2"}}', '{ "": { "$push" :{"a":"0"}} }', '{}');
ERROR:  The field 'a' must be an array but is of type int in document { _id: 1 }
HINT:  The field in $push must be an array but is of type int
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": {"$numberLong" : "2"}}', '{ "": { "$push" :{"a":"0"}} }', '{}');
ERROR:  The field 'a' must be an array but is of type long in document { _id: 1 }
HINT:  The field in $push must be an array but is of type long
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": {"$numberDouble" : "2.0"}}', '{ "": { "$push" :{"a":"0"}} }', '{}');
ERROR:  The field 'a' must be an array but is of type double in document { _id: 1 }
HINT:  The field in $push must be an array but is of type double
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": {"b" : [1,2,3]}}', '{ "": { "$push" :{"a":"0"}} }', '{}');
ERROR:  The field 'a' must be an array but is of type object in document { _id: 1 }
HINT:  The field in $push must be an array but is of type object
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": false}', '{ "": { "$push" :{"a":"0"}} }', '{}');
ERROR:  The field 'a' must be an array but is of type bool in document { _id: 1 }
HINT:  The field in $push must be an array but is of type bool
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": NaN}', '{ "": { "$push" :{"a":"0"}} }', '{}');
ERROR:  The field 'a' must be an array but is of type double in document { _id: 1 }
HINT:  The field in $push must be an array but is of type double
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": "6" }}} }', '{}');
ERROR:  The argument to $each in $push must be an array but it was of type: string
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": 6 }}} }', '{}');
ERROR:  The argument to $each in $push must be an array but it was of type: int
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": {"a": 6} }}} }', '{}');
ERROR:  The argument to $each in $push must be an array but it was of type: object
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$slice": 1.1 }}} }', '{}');
ERROR:  The argument to $slice in $push must be an integer value but was given type: double
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$slice": "2" }}} }', '{}');
ERROR:  The argument to $slice in $push must be an integer value but was given type: string
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$slice": true }}} }', '{}');
ERROR:  The argument to $slice in $push must be an integer value but was given type: bool
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$slice": [1,2,3] }}} }', '{}');
ERROR:  The argument to $slice in $push must be an integer value but was given type: array
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$sort": 0 }}} }', '{}');
ERROR:  The $sort element value must be either 1 or -1
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$sort": -2 }}} }', '{}');
ERROR:  The $sort element value must be either 1 or -1
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$sort": 2 }}} }', '{}');
ERROR:  The $sort element value must be either 1 or -1
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$sort": 1.1 }}} }', '{}');
ERROR:  The $sort element value must be either 1 or -1
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$sort": {"a.b": -2} }}} }', '{}');
ERROR:  The $sort element value must be either 1 or -1
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$sort": {"a.": -2} }}} }', '{}');
ERROR:  The $sort field is a dotted field but has an empty part: a.
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$sort": {".b.c": -2} }}} }', '{}');
ERROR:  The $sort field is a dotted field but has an empty part: .b.c
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$sort": {"": 1} }}} }', '{}');
ERROR:  The $sort field cannot be empty
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$sort": {} }}} }', '{}');
ERROR:  The $sort pattern is empty when it should be a set of fields.
-- TODO: Make the error compatible with mongo: "errmsg" : "Cannot create field 'y' in element {x: [ { y: 1 } ]}"
SELECT helio_api_internal.bson_update_document('{"_id": 1, "key": {"x": [{"y": [1]}, {"y": [2]}]}}', '{ "": { "$push" :{"key.x.y": 1 }}}', '{}');
ERROR:  Invalid array index path y
SELECT helio_api_internal.bson_update_document('{"_id": 1, "key": {"x": [{"y": [1]}, {"y": [2]}]}}', '{ "": { "$push" :{ "key.x": { "$each": [], "badplugin": 1} }}}', '{}');
ERROR:  Unrecognized clause in $push: badplugin
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$position": -0.1 }}} }', '{}');
ERROR:  The value for $position must be an integer value, not of type: double
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$position": 1.1 }}} }', '{}');
ERROR:  The value for $position must be an integer value, not of type: double
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$position": "start" }}} }', '{}');
ERROR:  The value for $position must be an integer value, not of type: string
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$position": false }}} }', '{}');
ERROR:  The value for $position must be an integer value, not of type: bool
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$position": {"a.b": -2} }}} }', '{}');
ERROR:  The value for $position must be an integer value, not of type: object
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$each": [], "$position": [1,2,3] }}} }', '{}');
ERROR:  The value for $position must be an integer value, not of type: array
-- $push valid cases when modifiers are not persent
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" : {"a": 6} } }', '{}');
                                                                                     bson_update_document                                                                                     
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" : {"a": {"another": 6}} } }', '{}');
                                                                                             bson_update_document                                                                                             
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" }, { "another" : { "$numberInt" : "6" } } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3]}', '{ "": { "$push" : {"a": false} } }', '{}');
                                                    bson_update_document                                                     
-----------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, false ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3]}', '{ "": { "$push" : {"a": [5,6,7]} } }', '{}');
                                                                                       bson_update_document                                                                                       
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, [ { "$numberInt" : "5" }, { "$numberInt" : "6" }, { "$numberInt" : "7" } ] ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3]}', '{ "": { "$push" : {"a": 1.21} } }', '{}');
                                                                        bson_update_document                                                                         
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberDouble" : "1.2099999999999999645" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "key": 1, "scores": [44,78,38,80], "a": {"scores": [1,2]}}', '{ "": { "$push" : {"scores": 1, "a.scores": 10} } }', '{}');
                                                                                                                                              bson_update_document                                                                                                                                               
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "$numberInt" : "1" }, "scores" : [ { "$numberInt" : "44" }, { "$numberInt" : "78" }, { "$numberInt" : "38" }, { "$numberInt" : "80" }, { "$numberInt" : "1" } ], "a" : { "scores" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "10" } ] } }
(1 row)

-- $push with $each modifier in non-dotted path
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3]}', '{ "": { "$push" : {"a": { "$each" : [1,2,"3", {"four": 4}] }} } }', '{}');
                                                                                              bson_update_document                                                                                              
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "1" }, { "$numberInt" : "2" }, "3", { "four" : { "$numberInt" : "4" } } ] }
(1 row)

-- $push with array indices as dotted path
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3]}', '{ "": { "$push" : {"a.3": 4 } } }', '{}');
                                                               bson_update_document                                                               
--------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, [ { "$numberInt" : "4" } ] ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3]}', '{ "": { "$push" : {"a.7": 7 } } }', '{}');
                                                                           bson_update_document                                                                           
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, null, null, null, null, [ { "$numberInt" : "7" } ] ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [[1],[2],[3]]}', '{ "": { "$push" : {"a.0.5": 7 } } }', '{}');
                                                                                 bson_update_document                                                                                 
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ [ { "$numberInt" : "1" }, null, null, null, null, [ { "$numberInt" : "7" } ] ], [ { "$numberInt" : "2" } ], [ { "$numberInt" : "3" } ] ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [[1],[2],[3]]}', '{ "": { "$push" : {"a.0.5": { "$each": [10,9,8], "$sort" : 1 } } } }', '{}');
                                                                                                         bson_update_document                                                                                                          
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ [ { "$numberInt" : "1" }, null, null, null, null, [ { "$numberInt" : "8" }, { "$numberInt" : "9" }, { "$numberInt" : "10" } ] ], [ { "$numberInt" : "2" } ], [ { "$numberInt" : "3" } ] ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [[1],[2],3]}', '{ "": { "$push" : {"a.2.5": 7 } } }', '{}');
ERROR:  Cannot create field '2' in element {2 : 3}
-- $push with $each & $slice modifier in non-dotted path
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5,6,7,8,9,10]}', '{ "": { "$push" : {"a": { "$each" : [], "$slice": 5 }} } }', '{}');
                                                                         bson_update_document                                                                         
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5,6,7,8,9,10]}', '{ "": { "$push" : {"a": { "$each" : [], "$slice": -6 }} } }', '{}');
                                                                                     bson_update_document                                                                                      
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" }, { "$numberInt" : "10" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5,6,7,8,9,10]}', '{ "": { "$push" : {"a": { "$each" : [], "$slice": 20 }} } }', '{}');
                                                                                                                                     bson_update_document                                                                                                                                      
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" }, { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" }, { "$numberInt" : "10" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5,6,7,8,9,10]}', '{ "": { "$push" : {"a": { "$each" : [], "$slice": -11 }} } }', '{}');
                                                                                                                                     bson_update_document                                                                                                                                      
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" }, { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" }, { "$numberInt" : "10" } ] }
(1 row)

-- $push with $each & $position modifier in non-dotted path
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5,6,7,8,9,10]}', '{ "": { "$push" : {"a": { "$each" : [-1, 0], "$position": 20 }} } }', '{}');
                                                                                                                                                              bson_update_document                                                                                                                                                              
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" }, { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" }, { "$numberInt" : "10" }, { "$numberInt" : "-1" }, { "$numberInt" : "0" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5,6,7,8,9,10]}', '{ "": { "$push" : {"a": { "$each" : [-1, 0], "$position": -20 }} } }', '{}');
                                                                                                                                                              bson_update_document                                                                                                                                                              
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "-1" }, { "$numberInt" : "0" }, { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" }, { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" }, { "$numberInt" : "10" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5,6,7,8,9,10]}', '{ "": { "$push" : {"a": { "$each" : [-1, 0], "$position": 6 }} } }', '{}');
                                                                                                                                                              bson_update_document                                                                                                                                                              
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" }, { "$numberInt" : "6" }, { "$numberInt" : "-1" }, { "$numberInt" : "0" }, { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" }, { "$numberInt" : "10" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5,6,7,8,9,10]}', '{ "": { "$push" : {"a": { "$each" : [-1, 0], "$position": -8 }} } }', '{}');
                                                                                                                                                              bson_update_document                                                                                                                                                              
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "-1" }, { "$numberInt" : "0" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" }, { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" }, { "$numberInt" : "10" } ] }
(1 row)

-- $push with $sort modifier in non-dotted path
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3]}', '{ "": { "$push" : {"a": { "$each" : [1,2,"3", {"four": 4}, false, [3,1,2]], "$sort": -1 }} } }', '{}');
                                                                                                                                       bson_update_document                                                                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ false, [ { "$numberInt" : "3" }, { "$numberInt" : "1" }, { "$numberInt" : "2" } ], { "four" : { "$numberInt" : "4" } }, "3", { "$numberInt" : "3" }, { "$numberInt" : "2" }, { "$numberInt" : "2" }, { "$numberInt" : "1" }, { "$numberInt" : "1" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [{"wk": 1, "scores": 85}, {"wk": 3, "scores": 30}, {"wk": 2, "scores": 75}, {"wk": 5, "scores": 99}]}',
                                                '{ "": { "$push" : {"a": { "$each" : [{"wk": 2, "scores": 70}], "$sort": 1 }} } }', '{}');
                                                                                                                                                                                              bson_update_document                                                                                                                                                                                               
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "wk" : { "$numberInt" : "1" }, "scores" : { "$numberInt" : "85" } }, { "wk" : { "$numberInt" : "2" }, "scores" : { "$numberInt" : "70" } }, { "wk" : { "$numberInt" : "2" }, "scores" : { "$numberInt" : "75" } }, { "wk" : { "$numberInt" : "3" }, "scores" : { "$numberInt" : "30" } }, { "wk" : { "$numberInt" : "5" }, "scores" : { "$numberInt" : "99" } } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [{"wk": 1, "scores": 85}, {"wk": 3, "scores": 30}, {"wk": 2, "scores": 75}, {"wk": 5, "scores": 99}]}',
                                                '{ "": { "$push" : {"a": { "$each" : [{"wk": 2, "scores": 70}], "$sort": { "scores" : -1 } }} } }', '{}');
                                                                                                                                                                                              bson_update_document                                                                                                                                                                                               
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "wk" : { "$numberInt" : "5" }, "scores" : { "$numberInt" : "99" } }, { "wk" : { "$numberInt" : "1" }, "scores" : { "$numberInt" : "85" } }, { "wk" : { "$numberInt" : "2" }, "scores" : { "$numberInt" : "75" } }, { "wk" : { "$numberInt" : "2" }, "scores" : { "$numberInt" : "70" } }, { "wk" : { "$numberInt" : "3" }, "scores" : { "$numberInt" : "30" } } ] }
(1 row)

-- Sort spec dotted path contains intermediate array, sort spec path not found so same sort order
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1,"key": 1,"a": [{"b": [{"c": 5}]},{"b": [{"c": 10}]},{"b": [{"c": 3}]},{"b": [{"c": 2}]}]}',
                                                '{ "": { "$push" : {"a": { "$each" : [], "$sort": { "b.c" : 1 } }} } }', '{}');
                                                                                                                             bson_update_document                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "$numberInt" : "1" }, "a" : [ { "b" : [ { "c" : { "$numberInt" : "5" } } ] }, { "b" : [ { "c" : { "$numberInt" : "10" } } ] }, { "b" : [ { "c" : { "$numberInt" : "3" } } ] }, { "b" : [ { "c" : { "$numberInt" : "2" } } ] } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1,"key": 1,"a": [{"b": [{"c": 5}]},{"b": [{"c": 10}]},{"b": [{"c": 3}]},{"b": [{"c": 2}]}]}',
                                                '{ "": { "$push" : {"a": { "$each" : [], "$sort": { "b.c" : -1 } }} } }', '{}');
                                                                                                                             bson_update_document                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "$numberInt" : "1" }, "a" : [ { "b" : [ { "c" : { "$numberInt" : "5" } } ] }, { "b" : [ { "c" : { "$numberInt" : "10" } } ] }, { "b" : [ { "c" : { "$numberInt" : "3" } } ] }, { "b" : [ { "c" : { "$numberInt" : "2" } } ] } ] }
(1 row)

-- Sort spec dotted path doesn't exist, same sort order
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1,"key": 1,"a": [{"b": [{"c": 5}]},{"b": [{"c": 10}]},{"b": [{"c": 3}]},{"b": [{"c": 2}]}]}',
                                                '{ "": { "$push" : {"a": { "$each" : [], "$sort": { "c" : -1 } }} } }', '{}');
                                                                                                                             bson_update_document                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "$numberInt" : "1" }, "a" : [ { "b" : [ { "c" : { "$numberInt" : "5" } } ] }, { "b" : [ { "c" : { "$numberInt" : "10" } } ] }, { "b" : [ { "c" : { "$numberInt" : "3" } } ] }, { "b" : [ { "c" : { "$numberInt" : "2" } } ] } ] }
(1 row)

-- Sort spec with array and valid index element
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1,"key": 1,"a": [{"b": [{"c": 5}]},{"b": [{"c": 10}]},{"b": [{"c": 3}]},{"b": [{"c": 2}]}]}',
                                                '{ "": { "$push" : {"a": { "$each" : [], "$sort": { "b.0" : -1 } }} } }', '{}');
                                                                                                                             bson_update_document                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "$numberInt" : "1" }, "a" : [ { "b" : [ { "c" : { "$numberInt" : "10" } } ] }, { "b" : [ { "c" : { "$numberInt" : "5" } } ] }, { "b" : [ { "c" : { "$numberInt" : "3" } } ] }, { "b" : [ { "c" : { "$numberInt" : "2" } } ] } ] }
(1 row)

-- Multiple Sort spec with existing or non exisiting paths
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id":1,"key":1,"a":[{"a":5,"b":10},{"a":2,"b":2},{"a":8,"b":3},{"a":4,"b":1},{"a":2,"b":5},{"a":2,"b":1}]}',
                                                '{ "": { "$push" : {"a": { "$each" : [], "$sort": { "a" : 1, "b": -1 } }} } }', '{}');
                                                                                                                                                                                                                             bson_update_document                                                                                                                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "$numberInt" : "1" }, "a" : [ { "a" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "5" } }, { "a" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "2" } }, { "a" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "1" } }, { "a" : { "$numberInt" : "4" }, "b" : { "$numberInt" : "1" } }, { "a" : { "$numberInt" : "5" }, "b" : { "$numberInt" : "10" } }, { "a" : { "$numberInt" : "8" }, "b" : { "$numberInt" : "3" } } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id":1,"key":1,"a":[{"a":5,"b":10},{"a":2,"b":2},{"a":8,"b":3},{"a":4,"b":1},{"a":2,"b":5},{"a":2,"b":1}]}',
                                                '{ "": { "$push" : {"a": { "$each" : [], "$sort": { "a" : 1, "b": -1, "c": 1 } }} } }', '{}');
                                                                                                                                                                                                                             bson_update_document                                                                                                                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "$numberInt" : "1" }, "a" : [ { "a" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "5" } }, { "a" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "2" } }, { "a" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "1" } }, { "a" : { "$numberInt" : "4" }, "b" : { "$numberInt" : "1" } }, { "a" : { "$numberInt" : "5" }, "b" : { "$numberInt" : "10" } }, { "a" : { "$numberInt" : "8" }, "b" : { "$numberInt" : "3" } } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id":1,"key":1,"a":[{"a":5,"b":10},{"a":2,"b":2},{"a":8,"b":3},{"a":4,"b":1},{"a":2,"b":5},{"a":2,"b":1}]}',
                                                '{ "": { "$push" : {"a": { "$each" : [], "$sort": { "d" : 1, "e": -1, "f": 1 } }} } }', '{}');
                                                                                                                                                                                                                             bson_update_document                                                                                                                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "$numberInt" : "1" }, "a" : [ { "a" : { "$numberInt" : "5" }, "b" : { "$numberInt" : "10" } }, { "a" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "2" } }, { "a" : { "$numberInt" : "8" }, "b" : { "$numberInt" : "3" } }, { "a" : { "$numberInt" : "4" }, "b" : { "$numberInt" : "1" } }, { "a" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "5" } }, { "a" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "1" } } ] }
(1 row)

-- Sort spec with only some elements having sort path, other elements treat missing path as NULL
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1,"key": 1,"a": [{"b": 1}, {"a": 10, "b": 0}, {"b": 5}, {"b": 3}]}',
                                                '{ "": { "$push" : {"a": { "$each" : [], "$sort": { "a" : 1 } }} } }', '{}');
                                                                                                                bson_update_document                                                                                                                 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "$numberInt" : "1" }, "a" : [ { "b" : { "$numberInt" : "1" } }, { "b" : { "$numberInt" : "5" } }, { "b" : { "$numberInt" : "3" } }, { "a" : { "$numberInt" : "10" }, "b" : { "$numberInt" : "0" } } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1,"key": 1,"a": [{"b": 1}, {"a": 10, "b": 0}, {"b": 5}, {"b": 3}]}',
                                                '{ "": { "$push" : {"a": { "$each" : [], "$sort": { "a" : -1 } }} } }', '{}');
                                                                                                                bson_update_document                                                                                                                 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "$numberInt" : "1" }, "a" : [ { "a" : { "$numberInt" : "10" }, "b" : { "$numberInt" : "0" } }, { "b" : { "$numberInt" : "1" } }, { "b" : { "$numberInt" : "5" } }, { "b" : { "$numberInt" : "3" } } ] }
(1 row)

-- $push with combinations of other modifiers e.g $slice, $sort
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "arr": [{"a": 1, "b": 10}, {"a": 2, "b": 8}, {"a": 3, "b": 5}, {"a": 4, "b": 6}]}',
                                                '{ "": { "$push" : {"arr": { "$each" : [{"a": 5, "b": 8}, {"a": 6, "b": 7}, {"a": 7, "b": 6}], "$sort": { "b" : -1 }, "$slice": 3 }} } }', '{}');
                                                                                                              bson_update_document                                                                                                               
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "arr" : [ { "a" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "10" } }, { "a" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "8" } }, { "a" : { "$numberInt" : "5" }, "b" : { "$numberInt" : "8" } } ] }
(1 row)

-- $push & modifiers with dotted paths
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": {"b": {"c": [1,2,3,4,5,6,7,8,9,10]}}}', '{"" : {"$push": {"a.b.c": 11}} }', '{}');
                                                                                                                                                            bson_update_document                                                                                                                                                            
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "c" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" }, { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" }, { "$numberInt" : "10" }, { "$numberInt" : "11" } ] } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": {"b": {"c": [1,2,3,4,5,6,7,8,9,10]}}}', '{"" : {"$push": {"a.b.c": {"$each": [11,12], "$slice": -6, "$sort": -1, "$position": 4}}} }', '{}');
                                                                                               bson_update_document                                                                                               
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "c" : [ { "$numberInt" : "6" }, { "$numberInt" : "5" }, { "$numberInt" : "4" }, { "$numberInt" : "3" }, { "$numberInt" : "2" }, { "$numberInt" : "1" } ] } } }
(1 row)

-- $push with absent fields
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "scores": {"a": {"b": [1]}}, "key": 1}', '{"" : {"$push": {"scores.a.c": {"x": [{"z": 1}]}}} }', '{}');
                                                                                  bson_update_document                                                                                   
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "scores" : { "a" : { "b" : [ { "$numberInt" : "1" } ], "c" : [ { "x" : [ { "z" : { "$numberInt" : "1" } } ] } ] } }, "key" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "scores": {"a": {"b": [1]}}, "key": 1}', '{"" : {"$push": {"scores.a.c": {"$each": [5,4,3,2,1], "$slice": 3, "$sort": 1}}} }', '{}');
                                                                                              bson_update_document                                                                                               
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "scores" : { "a" : { "b" : [ { "$numberInt" : "1" } ], "c" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" } ] } }, "key" : { "$numberInt" : "1" } }
(1 row)

-- $push with key having dots
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "scores": {"a": {"b": [1]}}, "key": 1}', '{"" : {"$push": {"scores.a.b": {"x": [{"z.a": 1}]}}} }', '{}');
                                                                              bson_update_document                                                                               
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "scores" : { "a" : { "b" : [ { "$numberInt" : "1" }, { "x" : [ { "z.a" : { "$numberInt" : "1" } } ] } ] } }, "key" : { "$numberInt" : "1" } }
(1 row)

-- $push with NaN and Infinity values
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [{"$numberDecimal": "100"}, {"$numberDouble": "NaN"}, {"$numberDecimal": "2"}, {"$numberDecimal": "NaN"}, {"$numberDecimal": "23"}]}', '{ "": { "$push" : {"a": { "$each": [], "$sort" : 1 } } } }', '{}');
                                                                                                      bson_update_document                                                                                                       
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ("{ ""_id"" : { ""$numberInt"" : ""1"" }, ""a"" : [ { ""$numberDouble"" : ""NaN"" }, { ""$numberDecimal"" : ""NaN"" }, { ""$numberDecimal"" : ""2"" }, { ""$numberDecimal"" : ""23"" }, { ""$numberDecimal"" : ""100"" } ] }",)
(1 row)

SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [{"$numberDecimal": "Infinity"}, {"$numberDouble": "NaN"}, {"$numberDecimal": "332"}, {"$numberDecimal": "NaN"}, {"$numberDecimal": "23"}]}', '{ "": { "$push" : {"a": { "$each": [], "$sort" : -1 } } } }', '{}');
                                                                                                          bson_update_document                                                                                                          
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ("{ ""_id"" : { ""$numberInt"" : ""1"" }, ""a"" : [ { ""$numberDecimal"" : ""Infinity"" }, { ""$numberDecimal"" : ""332"" }, { ""$numberDecimal"" : ""23"" }, { ""$numberDouble"" : ""NaN"" }, { ""$numberDecimal"" : ""NaN"" } ] }",)
(1 row)

SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [{"$numberDecimal": "NaN"}, {"$numberDouble": "NaN"}, {"$numberDecimal": "Infinity"}, {"$numberDecimal": "23"}]}', '{ "": { "$push" : {"a": { "$each": [], "$sort" : 1 } } } }', '{}');
                                                                                         bson_update_document                                                                                         
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ("{ ""_id"" : { ""$numberInt"" : ""1"" }, ""a"" : [ { ""$numberDecimal"" : ""NaN"" }, { ""$numberDouble"" : ""NaN"" }, { ""$numberDecimal"" : ""23"" }, { ""$numberDecimal"" : ""Infinity"" } ] }",)
(1 row)

SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [{"$numberDecimal": "NaN"}, {"$numberDouble": "NaN"}, {"$numberDecimal": "Infinity"}, {"$numberDecimal": "23"}]}', '{ "": { "$push" : {"a": { "$each": [], "$sort" : -1 } } } }', '{}');
                                                                                         bson_update_document                                                                                         
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ("{ ""_id"" : { ""$numberInt"" : ""1"" }, ""a"" : [ { ""$numberDecimal"" : ""Infinity"" }, { ""$numberDecimal"" : ""23"" }, { ""$numberDecimal"" : ""NaN"" }, { ""$numberDouble"" : ""NaN"" } ] }",)
(1 row)

-- $push without $each but with other modifiers works on mongo5.0, $ is now supported in key names.
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "key": {"x": [{"y": [1]}, {"y": [2]}]}}', '{ "": { "$push" :{ "key.x": { "$eachh": [], "$position": 1, "$sort" : 1} }}}', '{}');
                                                                                                       bson_update_document                                                                                                        
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key" : { "x" : [ { "y" : [ { "$numberInt" : "1" } ] }, { "y" : [ { "$numberInt" : "2" } ] }, { "$eachh" : [  ], "$position" : { "$numberInt" : "1" }, "$sort" : { "$numberInt" : "1" } } ] } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$push" :{"a": { "$position": 5, "$slice": 3, "$sort": -1 }}} }', '{}');
                                                                                                                                 bson_update_document                                                                                                                                 
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" }, { "$position" : { "$numberInt" : "5" }, "$slice" : { "$numberInt" : "3" }, "$sort" : { "$numberInt" : "-1" } } ] }
(1 row)

-- test conflicting update operator paths
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a": 1 } } }', '{}');
ERROR:  Updating the path 'a' would create a conflict at 'a'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a.b": 1 } } }', '{}');
ERROR:  Updating the path 'a.b' would create a conflict at 'a.b'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$inc": {"a": 1 } } }', '{}');
ERROR:  Updating the path 'a' would create a conflict at 'a'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$inc": {"a.b": 1 } } }', '{}');
ERROR:  Updating the path 'a.b' would create a conflict at 'a.b'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$inc": {"a.b.c": 1 } } }', '{}');
ERROR:  Updating the path 'a.b.c' would create a conflict at 'a.b'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$inc": {"a.b.c.d.e": 1 } } }', '{}');
ERROR:  Updating the path 'a.b.c.d.e' would create a conflict at 'a.b'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a.b.c.d.e": 1 } } }', '{}');
ERROR:  Updating the path 'a.b.c.d.e' would create a conflict at 'a.b'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a": {"b.c": 1} } } }', '{}');
ERROR:  Updating the path 'a' would create a conflict at 'a'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a": {"b": 1} } } }', '{}');
ERROR:  Updating the path 'a' would create a conflict at 'a'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a": {"b.c.d": 1} } } }', '{}');
ERROR:  Updating the path 'a' would create a conflict at 'a'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a": {"b.k.d": 1} } } }', '{}');
ERROR:  Updating the path 'a' would create a conflict at 'a'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a": {"b.c.d.e": 1} } } }', '{}');
ERROR:  Updating the path 'a' would create a conflict at 'a'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a": {"b.c.d": { "e": 1 } } } } }', '{}');
ERROR:  Updating the path 'a' would create a conflict at 'a'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a": {"b.c.d": { "e.f": 1 } } } } }', '{}');
ERROR:  Updating the path 'a' would create a conflict at 'a'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a": {"b.c.d": { "k.f": 1 } } } } }', '{}');
ERROR:  Updating the path 'a' would create a conflict at 'a'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a": {"b.c.d": { "f.k": 1 } } } } }', '{}');
ERROR:  Updating the path 'a' would create a conflict at 'a'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a": {"b.c.d": { "e.f": {"g": 1} } } } } }', '{}');
ERROR:  Updating the path 'a' would create a conflict at 'a'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a.b.c.d": { "e": 1 } } } }', '{}');
ERROR:  Updating the path 'a.b.c.d' would create a conflict at 'a.b'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a.b.c": { "d.e": 1 } } } }', '{}');
ERROR:  Updating the path 'a.b.c' would create a conflict at 'a.b'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b": {"c": { "d.e.f": "1"} } }, "$unset": {"a.b": { "c.d.e": 1 } } } }', '{}');
ERROR:  Updating the path 'a.b' would create a conflict at 'a.b'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b.c.d.e": 1 }, "$unset": {"a.b": 1 } } }', '{}');
ERROR:  Updating the path 'a.b' would create a conflict at 'a.b'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b.c.d.e": 1 }, "$unset": {"a.b.c.d.e.f": 1 } } }', '{}');
ERROR:  Updating the path 'a.b.c.d.e.f' would create a conflict at 'a.b.c.d.e'
SELECT helio_api_internal.bson_update_document('{"data": "data"}', '{ "": { "$set": { "a.b.c.d.e": 1 }, "$inc": {"a.b": 1 } } }', '{}');
ERROR:  Updating the path 'a.b' would create a conflict at 'a.b'
-- update scenario tests: $currentDate
-- -- Function that extracts date / timestamp value of a given key in a json obj, and returns the equivalent epoch in ms
CREATE OR REPLACE FUNCTION get_epochms_from_key(obj json, qkey text, is_date bool)
RETURNS bigint
AS $$
DECLARE
    k text;
    qarr text[];
    epoch_seconds bigint;
    nanoseconds_in_second bigint;
    epoch_milliseconds bigint;
    tmp bool;
BEGIN
    SELECT string_to_array(qkey, '.') into qarr;    -- convert the nested keys in keys array (e.g. "a.b.c" to [a,b,c] )
    FOREACH k IN ARRAY qarr
    LOOP
        IF obj->k IS NULL THEN
            RETURN 0;
        END IF;
        SELECT obj->k into obj;
    END LOOP;

    IF is_date THEN
        IF (obj->'$date' IS NULL) OR (obj->'$date'->'$numberLong' IS NULL) THEN
            RETURN 0;
        END IF;
        SELECT obj->'$date'->>'$numberLong' into epoch_milliseconds;
    ELSE
        IF (obj->'$timestamp' IS NULL) OR (obj ->'$timestamp'->'t' IS NULL) OR (obj->'$timestamp'->'i' IS NULL) THEN
            RETURN 0;
        END IF;
        SELECT obj->'$timestamp'->>'t' into epoch_seconds;
        SELECT obj->'$timestamp'->>'i' into nanoseconds_in_second;
        epoch_milliseconds := (epoch_seconds * 1000) + ROUND(nanoseconds_in_second::float8 / (1000 * 1000));
    END IF;

    RETURN epoch_milliseconds;
END
$$
LANGUAGE plpgsql;
-- -- Function to test that on updating a doc with $currentDate, the date/timestamp value lies between the timestamp values of just before & after calling the update api
CREATE OR REPLACE FUNCTION test_update_currentDate(doc bson, updateSpec bson, querySpec bson, qDates text[] DEFAULT '{}'::text[], qTimestamps text[] DEFAULT '{}'::text[])
RETURNS text
AS $$
DECLARE
    obj             json;
    bgn_epoch       numeric;
    end_epoch       numeric;
    qKey            text;
    epoch_msec      bigint;
    bgn_epoch_msec  bigint;
    end_epoch_msec  bigint;
BEGIN
    SELECT extract(epoch from clock_timestamp()) into bgn_epoch;    -- get time just before the $currentDate execution. (e.g 1709721220.205436)
    SELECT newDocument FROM helio_api_internal.bson_update_document(doc, updateSpec, querySpec) into obj;
    SELECT extract(epoch from clock_timestamp()) into end_epoch;    -- get time just after the $currentDate execution.

    -- convert the epoch to milliseconds (e.g. 1709721220.205436 -> 1709721220205)
    -- Also adjust begin and end epochs by 1 ms to eliminate any rounding error and reduce flakyness.
    bgn_epoch_msec := FLOOR(bgn_epoch * 1000) - 1;
    end_epoch_msec := CEIL(end_epoch * 1000) + 1;

    IF array_length(qDates, 1) != 0 THEN
        FOREACH qKey IN ARRAY qDates
        LOOP
            SELECT get_epochms_from_key(obj, qKey, true) into epoch_msec;
            IF epoch_msec NOT BETWEEN bgn_epoch_msec AND end_epoch_msec THEN
                RETURN 'TEST FAILED : Updated date "' || qkey || '" : ' || epoch_msec || ' should be between ' || bgn_epoch_msec || ' and ' || end_epoch_msec;
            END IF;
        END LOOP;
    END IF;

    IF array_length(qTimestamps, 1) != 0 THEN
        FOREACH qKey IN ARRAY qTimestamps
        LOOP
            SELECT get_epochms_from_key(obj, qKey, false) into epoch_msec;
            IF epoch_msec NOT BETWEEN bgn_epoch_msec AND end_epoch_msec THEN
                RETURN 'TEST FAILED : Updated timestamp "' || qkey || '" : ' || epoch_msec || ' should be between ' || bgn_epoch_msec || ' and ' || end_epoch_msec;
            END IF;
        END LOOP;
    END IF;

    RETURN 'TEST PASSED';
END;
$$
LANGUAGE plpgsql;
-- -- tests to update existing field to current timestamp using { "$type" : "timestamp" }
SELECT test_update_currentDate('{"_id": 1, "a": { "$timestamp": { "t": 1234567890, "i": 1 }}}', '{ "": { "$currentDate": { "a": { "$type" : "timestamp"} } } }', '{}', ARRAY[]::text[], ARRAY['a']::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": { "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "$currentDate": { "a": { "$type" : "timestamp"} } } }', '{}', ARRAY[]::text[], ARRAY['a']::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": "Hello" }', '{ "": { "$currentDate": { "a": { "$type" : "timestamp"} } } }', '{}', ARRAY[]::text[], ARRAY['a']::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": 2 }', '{ "": { "$currentDate": { "a": { "$type" : "timestamp"} } } }', '{}', ARRAY[]::text[], ARRAY['a']::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

-- -- tests to update existing field to current date using { true }
SELECT test_update_currentDate('{"_id": 1, "a": { "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "$currentDate": { "a": true} } } ', '{}', ARRAY['a']::text[], ARRAY[]::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": { "$timestamp": { "t": 1234567890, "i": 1 }}}', '{ "": { "$currentDate": { "a": true} } } ', '{}', ARRAY['a']::text[], ARRAY[]::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": "Hello" }', '{ "": { "$currentDate": { "a": true} } } ', '{}', ARRAY['a']::text[], ARRAY[]::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": 2 }', '{ "": { "$currentDate": { "a": true} } } ', '{}', ARRAY['a']::text[], ARRAY[]::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

-- -- tests to update existing field to current date using { false }
SELECT test_update_currentDate('{"_id": 1, "a": { "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "$currentDate": { "a": false} } } ', '{}', ARRAY['a']::text[], ARRAY[]::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": { "$timestamp": { "t": 1234567890, "i": 1 }}}', '{ "": { "$currentDate": { "a": false} } } ', '{}', ARRAY['a']::text[], ARRAY[]::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": "Hello" }', '{ "": { "$currentDate": { "a": false} } } ', '{}', ARRAY['a']::text[], ARRAY[]::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": 2 }', '{ "": { "$currentDate": { "a": false} } } ', '{}', ARRAY['a']::text[], ARRAY[]::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

-- -- tests to update existing field to current date using { "$$type" : "date" }
-- -- Note: Due to a bug in libbson, parsing of { "$type" : "date" } fails. So temporarily the HelioApi $currentDate impl also supports {"$$type" : "date" }
-- -- Once the bug is fixed, these tests need to be updated from "$$type" to "$type"
SELECT test_update_currentDate('{"_id": 1, "a": { "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "$currentDate": { "a": { "$$type" : "date"} } } } ', '{}', ARRAY['a']::text[], ARRAY[]::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": { "$timestamp": { "t": 1234567890, "i": 1 }}}', '{ "": { "$currentDate": { "a": { "$$type" : "date"} } } } ', '{}', ARRAY['a']::text[], ARRAY[]::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": "Hello" }', '{ "": { "$currentDate": { "a": { "$$type" : "date"} } } } ', '{}', ARRAY['a']::text[], ARRAY[]::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": 2 }', '{ "": { "$currentDate": { "a": { "$$type" : "date"} } } } ', '{}', ARRAY['a']::text[], ARRAY[]::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

-- -- tests to update existing field to timestamp, and add new fields with current date / timestamp
SELECT test_update_currentDate('{"_id": 1, "a": "Hello" }', '{ "": { "$currentDate": { "a": { "$type" : "timestamp"}, "b.c" : { "$type" : "timestamp"} } } } ', '{}', ARRAY[]::text[], ARRAY['a','b.c']::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": "Hello" }', '{ "": { "$currentDate": { "a": { "$type" : "timestamp"}, "b.c" : { "$$type" : "date"} } } } ', '{}', ARRAY['b.c']::text[], ARRAY['a']::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": "Hello" }', '{ "": { "$currentDate": { "a": { "$type" : "timestamp"}, "b.c" : true } } } ', '{}', ARRAY['b.c']::text[], ARRAY['a']::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

SELECT test_update_currentDate('{"_id": 1, "a": "Hello" }', '{ "": { "$currentDate": { "a": { "$type" : "timestamp"}, "b.c" : false } } } ', '{}', ARRAY['b.c']::text[], ARRAY['a']::text[]);
 test_update_currentdate 
-------------------------
 TEST PASSED
(1 row)

-- -- these tests should give error messages
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$timestamp": { "t": 1234567890, "i": 1 }}}', '{ "": { "$currentDate": { "a": { } } } }', '{}');
ERROR:  The '$type' string field is required to be 'date' or 'timestamp': {$currentDate: {field : {$type: 'date'}}}
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$timestamp": { "t": 1234567890, "i": 1 }}}', '{ "": { "$currentDate": { "a": {"$numberInt" : "1"} } } }', '{}');
ERROR:  int is not valid type for $currentDate. Please use a boolean ('true') or a $type expression ({$type: 'timestamp/date'})
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$timestamp": { "t": 1234567890, "i": 1 }}}', '{ "": { "$currentDate": { "a": {"$numberLong" : "1"} } } }', '{}');
ERROR:  long is not valid type for $currentDate. Please use a boolean ('true') or a $type expression ({$type: 'timestamp/date'})
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$timestamp": { "t": 1234567890, "i": 1 }}}', '{ "": { "$currentDate": { "a": {"$numberDouble" : "1.0"} } } }', '{}');
ERROR:  double is not valid type for $currentDate. Please use a boolean ('true') or a $type expression ({$type: 'timestamp/date'})
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$timestamp": { "t": 1234567890, "i": 1 }}}', '{ "": { "$currentDate": { "a": "Hello" } } }', '{}');
ERROR:  string is not valid type for $currentDate. Please use a boolean ('true') or a $type expression ({$type: 'timestamp/date'})
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$timestamp": { "t": 1234567890, "i": 1 }}}', '{ "": { "$currentDate": { "a": NaN } } }', '{}');
ERROR:  double is not valid type for $currentDate. Please use a boolean ('true') or a $type expression ({$type: 'timestamp/date'})
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$timestamp": { "t": 1234567890, "i": 1 }}}', '{ "": { "$currentDate": { "a": { "$type" : "Hello" } } } }', '{}');
ERROR:  The '$type' string field is required to be 'date' or 'timestamp': {$currentDate: {field : {$type: 'date'}}}
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$timestamp": { "t": 1234567890, "i": 1 }}}', '{ "": { "$currentDate": { "a": { "$$type" : true } } } }', '{}');
ERROR:  The '$type' string field is required to be 'date' or 'timestamp': {$currentDate: {field : {$type: 'date'}}}
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$timestamp": { "t": 1234567890, "i": 1 }}}', '{ "": { "$currentDate": { "a": { "$$type" : 2 } } } }', '{}');
ERROR:  The '$type' string field is required to be 'date' or 'timestamp': {$currentDate: {field : {$type: 'date'}}}
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "$currentDate": { "a": { } } } }', '{}');
ERROR:  The '$type' string field is required to be 'date' or 'timestamp': {$currentDate: {field : {$type: 'date'}}}
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "$currentDate": { "a": {"$numberInt" : "1"} } } }', '{}');
ERROR:  int is not valid type for $currentDate. Please use a boolean ('true') or a $type expression ({$type: 'timestamp/date'})
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "$currentDate": { "a": {"$numberLong" : "1"} } } }', '{}');
ERROR:  long is not valid type for $currentDate. Please use a boolean ('true') or a $type expression ({$type: 'timestamp/date'})
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "$currentDate": { "a": {"$numberDouble" : "1.0"} } } }', '{}');
ERROR:  double is not valid type for $currentDate. Please use a boolean ('true') or a $type expression ({$type: 'timestamp/date'})
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "$currentDate": { "a": "Hello" } } }', '{}');
ERROR:  string is not valid type for $currentDate. Please use a boolean ('true') or a $type expression ({$type: 'timestamp/date'})
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "$currentDate": { "a": NaN } } }', '{}');
ERROR:  double is not valid type for $currentDate. Please use a boolean ('true') or a $type expression ({$type: 'timestamp/date'})
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "$currentDate": { "a": { "$type" : "Hello" } } } }', '{}');
ERROR:  The '$type' string field is required to be 'date' or 'timestamp': {$currentDate: {field : {$type: 'date'}}}
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "$currentDate": { "a": { "$$type" : true } } } }', '{}');
ERROR:  The '$type' string field is required to be 'date' or 'timestamp': {$currentDate: {field : {$type: 'date'}}}
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "$currentDate": { "a": { "$$type" : 2 } } } }', '{}');
ERROR:  The '$type' string field is required to be 'date' or 'timestamp': {$currentDate: {field : {$type: 'date'}}}
-- -- Note : This test intenionally provides { "$type" : "date" } instead of { "$$type" : "date" }
-- -- The API call returns Error due to a Bug in libbson library that fails to parse { "$type" : "date" }
-- -- If this test starts failing (i.e. api call does't return error), it may mean that the libbson bug has been fixed.
-- -- In that case $currentDate implementation in helioapi needs a fix as well (i.e. remove support for "$$type" since "$type" will work OK)
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "$currentDate": { "a": { "$type" : "date" } } } }', '{}');
ERROR:  invalid input syntax JSON for BSON: Code: '2', Message 'Missing "$binary" after "$type" reading type "binary"'
LINE 1: ... "$date": { "$numberLong" : "1234567890000" }}}', '{ "": { "...
                                                             ^
-- --Empty UpdateSpec check
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4] }', '{ "": { "$inc": { "": 11} } }', '{}');
ERROR:  An empty update path is not valid
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4] }', '{ "": { "$mul": { "a.": 11} } }', '{}');
ERROR:  An update path 'a.' contains an empty field name, which is not allowed.
-- update scenario tests: $pop
-- -- $pop from begin of array
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" :{"a": -1}} }', '{}');
                                                             bson_update_document                                                             
----------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1]}', '{ "": { "$pop" :{"a": -1}} }', '{}');
              bson_update_document              
------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [  ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": []}', '{ "": { "$pop" :{"a": -1}} }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b" : { "c" : [1,2,3,4,5] }} }', '{ "": { "$pop" :{"a.b.c": -1}} }', '{}');
                                                                       bson_update_document                                                                       
------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "c" : [ { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" } ] } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5], "b" : [6,7,8,9] }', '{ "": { "$pop" :{"a": -1, "b": -1}} }', '{}');
                                                                                                      bson_update_document                                                                                                      
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" } ], "b" : [ { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5], "b" : [6,7,8,9] }', '{ "": { "$pop" :{"a": -1, "b": -1, "c" : -1}} }', '{}');
                                                                                                      bson_update_document                                                                                                      
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" } ], "b" : [ { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" } ] }
(1 row)

-- -- $pop from end of array
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" :{"a": 1}} }', '{}');
                                                             bson_update_document                                                             
----------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [5]}', '{ "": { "$pop" :{"a": 1}} }', '{}');
              bson_update_document              
------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [  ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": []}', '{ "": { "$pop" :{"a": 1}} }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "b" : { "c" : [1,2,3,4,5] }} }', '{ "": { "$pop" :{"a.b.c": 1}} }', '{}');
                                                                       bson_update_document                                                                       
------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "c" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" } ] } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5], "b" : [6,7,8,9] }', '{ "": { "$pop" :{"a": 1, "b": 1}} }', '{}');
                                                                                                      bson_update_document                                                                                                      
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" } ], "b" : [ { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5], "b" : [6,7,8,9] }', '{ "": { "$pop" :{"a": 1, "b": 1, "c" : 1}} }', '{}');
                                                                                                      bson_update_document                                                                                                      
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" } ], "b" : [ { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" } ] }
(1 row)

-- -- $pop from begin and end of array
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5], "b" : [6,7,8,9]}', '{ "": { "$pop" :{"a": -1, "b": 1}} }', '{}');
                                                                                                      bson_update_document                                                                                                      
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" } ], "b" : [ { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5], "b" : [6,7,8,9]}', '{ "": { "$pop" :{"z": 1, "a": -1, "b": 1}} }', '{}');
                                                                                                      bson_update_document                                                                                                      
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "5" } ], "b" : [ { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" } ] }
(1 row)

  -- For below test, the spec parsing func (ParseDotPathAndGetTreeNode) throws error, but mongoDB 5.0 doesn't. TODO : Fix ParseDotPathAndGetTreeNode
  -- SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" :{"a": -1, "a": 1}} }', '{}');
-- -- Empty $pop document. Should not pop anything
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : {}} }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": []}', '{ "": { "$pop" : {}} }', '{}');
 bson_update_document 
----------------------
 
(1 row)

-- -- Error Cases : $pop on Non-Array Fields
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b" : { "c" : {"$numberInt" : "2"} }} }', '{ "": { "$pop" :{"a.b.c": 1}} }', '{}');
ERROR:  Path 'a.b.c' contains an element of non-array type 'int'
HINT:  Path in $pop contains an element of non-array type 'int'
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b" : { "c" : {"$numberLong" : "2"} }} }', '{ "": { "$pop" :{"a.b.c": 1}} }', '{}');
ERROR:  Path 'a.b.c' contains an element of non-array type 'long'
HINT:  Path in $pop contains an element of non-array type 'long'
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b" : { "c" : {"$numberDouble" : "2.0"} }} }', '{ "": { "$pop" :{"a.b.c": 1}} }', '{}');
ERROR:  Path 'a.b.c' contains an element of non-array type 'double'
HINT:  Path in $pop contains an element of non-array type 'double'
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b" : { "c" : "Hello" }} }', '{ "": { "$pop" :{"a.b.c": 1}} }', '{}');
ERROR:  Path 'a.b.c' contains an element of non-array type 'string'
HINT:  Path in $pop contains an element of non-array type 'string'
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b" : { "c" : false }} }', '{ "": { "$pop" :{"a.b.c": 1}} }', '{}');
ERROR:  Path 'a.b.c' contains an element of non-array type 'bool'
HINT:  Path in $pop contains an element of non-array type 'bool'
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b" : { "c" : NaN }} }', '{ "": { "$pop" :{"a.b.c": 1}} }', '{}');
ERROR:  Path 'a.b.c' contains an element of non-array type 'double'
HINT:  Path in $pop contains an element of non-array type 'double'
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b" : { "c" : [5,6,7,8], "d" : "Hello" }} }', '{ "": { "$pop" :{"a.b.c": 1, "a.b.d": -1 }} }', '{}');
ERROR:  Path 'a.b.d' contains an element of non-array type 'string'
HINT:  Path in $pop contains an element of non-array type 'string'
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b" : { "c" : [5,6,7,8], "d" : "Hello" }} }', '{ "": { "$pop" :{"a" : {"b" : { "c": 1 ,  "d": -1} }} } }', '{}');
ERROR:  Expected a number in: a: { "b" : { "c" : 1, "d" : -1 } }
HINT:  Expected a number in $pop, found: object
-- -- Error Cases : $pop's key's value is neither -1 nor 1
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : {"a": "Hello"}} }', '{}');
ERROR:  Expected a number in: a: "Hello"
HINT:  Expected a number in $pop, found: string
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : {"a": true}} }', '{}');
ERROR:  Expected a number in: a: true
HINT:  Expected a number in $pop, found: bool
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : {"a": NaN}} }', '{}');
ERROR:  Expected an integer: a: NaN
HINT:  Expected a number in $pop, found: double
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : {"a": []}} }', '{}');
ERROR:  Expected a number in: a: [  ]
HINT:  Expected a number in $pop, found: array
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : {"a": {}}} }', '{}');
ERROR:  Expected a number in: a: { }
HINT:  Expected a number in $pop, found: object
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : {"a": {"$numberInt" : "2"}}} }', '{}');
ERROR:  $pop expects 1 or -1, found: 2
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : {"a": {"$numberDouble" : "-1.5"}}} }', '{}');
ERROR:  Expected an integer: a: -1.5
HINT:  Expected a number in $pop, found: double
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b" : { "c" : [5,6,7,8]}} }', '{ "": { "$pop" : {"a.b.c": 2 }} }', '{}');
ERROR:  $pop expects 1 or -1, found: 2
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b" : { "c" : [5,6,7,8], "d" : "Hello" }} }', '{ "": { "$pop" :{"a.b.c": 25, "a.b.d": -1 }} }', '{}');
ERROR:  $pop expects 1 or -1, found: 25
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": { "b" : { "c" : [5,6,7,8], "d" : "Hello" }} }', '{ "": { "$pop" :{"a.b.c": 1, "a.b.d": -25 }} }', '{}');
ERROR:  $pop expects 1 or -1, found: -25
-- -- Error Cases : $pop is not a document
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : []} }', '{}');
ERROR:  Modifiers operate on fields but we found type array instead. For example: {$mod: {<field>: ...}} not {$pop: [  ]}
HINT:  Modifiers operate on fields but we found type array instead for operator name: $pop
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : [{"a" : 1}]} }', '{}');
ERROR:  Modifiers operate on fields but we found type array instead. For example: {$mod: {<field>: ...}} not {$pop: [ { "a" : 1 } ]}
HINT:  Modifiers operate on fields but we found type array instead for operator name: $pop
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : "Hello"} }', '{}');
ERROR:  Modifiers operate on fields but we found type string instead. For example: {$mod: {<field>: ...}} not {$pop: "Hello"}
HINT:  Modifiers operate on fields but we found type string instead for operator name: $pop
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : false} }', '{}');
ERROR:  Modifiers operate on fields but we found type bool instead. For example: {$mod: {<field>: ...}} not {$pop: false}
HINT:  Modifiers operate on fields but we found type bool instead for operator name: $pop
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : NaN} }', '{}');
ERROR:  Modifiers operate on fields but we found type double instead. For example: {$mod: {<field>: ...}} not {$pop: NaN}
HINT:  Modifiers operate on fields but we found type double instead for operator name: $pop
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : {"$numberInt" : "1"}} }', '{}');
ERROR:  Modifiers operate on fields but we found type int instead. For example: {$mod: {<field>: ...}} not {$pop: 1}
HINT:  Modifiers operate on fields but we found type int instead for operator name: $pop
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : {"$numberLong" : "-1"}} }', '{}');
ERROR:  Modifiers operate on fields but we found type long instead. For example: {$mod: {<field>: ...}} not {$pop: -1}
HINT:  Modifiers operate on fields but we found type long instead for operator name: $pop
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pop" : {"$numberDouble" : "2.5"}} }', '{}');
ERROR:  Modifiers operate on fields but we found type double instead. For example: {$mod: {<field>: ...}} not {$pop: 2.5}
HINT:  Modifiers operate on fields but we found type double instead for operator name: $pop
-- --Update the Field with Periods (.) and Dollar Signs ($)
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": { "$b": 2 } }', '{ "": { "$inc": { "a.$b": 2 } } }', '{}');
                            bson_update_document                             
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$b" : { "$numberInt" : "4" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "$a": { "b": 2 } }', '{ "": { "$inc": { "$a.c": 2 } } }', '{}');
                                           bson_update_document                                            
-----------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "$a" : { "b" : { "$numberInt" : "2" }, "c" : { "$numberInt" : "2" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "$a": { "$b": { "c" :  2 } } }', '{ "": { "$inc": { "$a.$b.c": 1 } } }', '{}');
                                  bson_update_document                                  
----------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "$a" : { "$b" : { "c" : { "$numberInt" : "3" } } } }
(1 row)

-- --Negative scenarios for field names with Dollar Signs ($)
SELECT helio_api_internal.bson_update_document('{"_id" : 1}', '{ "": { "$set": { "$a": 2 } } }', '{}');
ERROR:  The dollar ($) prefixed field '$a' in '$a' is not allowed in the context of an update's replacement document. Consider using an aggregation pipeline with $replaceWith.
SELECT helio_api_internal.bson_update_document('{}', '{ "": { "_id" : 1, "$set": { "$a": 2 } } }', '{}');
ERROR:  The dollar ($) prefixed field '$set' in '$set' is not allowed in the context of an update's replacement document. Consider using an aggregation pipeline with $replaceWith.
SELECT helio_api_internal.bson_update_document('{"_id" : 1, "a" : 1 }', '{ "": { "_id" : 1, "$b" : 2} }', '{}');
ERROR:  The dollar ($) prefixed field '$b' in '$b' is not allowed in the context of an update's replacement document. Consider using an aggregation pipeline with $replaceWith.
SELECT helio_api_internal.bson_update_document('{"_id": 1, "$a": { "$b": { "c" :  2 } } }', '{ "": { "$set": { "$a": { "$b" : { "$d": 1 } } } } } ', '{}');
                                             bson_update_document                                             
--------------------------------------------------------------------------------------------------------------
 ("{ ""_id"" : { ""$numberInt"" : ""1"" }, ""$a"" : { ""$b"" : { ""$d"" : { ""$numberInt"" : ""1"" } } } }",)
(1 row)

-- more scenarios for update field names with $ signs
-- $ paths not allowed when it's not an upsert
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": "1" }', '{ "": { "$set": { "$secret.agent.x": 1 } } }', '{}');
ERROR:  The dollar ($) prefixed field '$secret' in '$secret.agent.x' is not allowed in the context of an update's replacement document. Consider using an aggregation pipeline with $replaceWith.
SELECT helio_api_internal.bson_update_document('{"_id": 1, "$secret": { "agent": 1 } }', '{ "": { "$set": { "$secret.agent.x": 1 } } }', '{}');
ERROR:  Cannot create field 'agent' in element {agent : 1}
SELECT helio_api_internal.bson_update_document('{"_id": 1, "$secret": { "agent": { "y": 1 } } }', '{ "": { "$set": { "$secret.agent.x": 1 } } }', '{}');
                                                                  bson_update_document                                                                   
---------------------------------------------------------------------------------------------------------------------------------------------------------
 ("{ ""_id"" : { ""$numberInt"" : ""1"" }, ""$secret"" : { ""agent"" : { ""y"" : { ""$numberInt"" : ""1"" }, ""x"" : { ""$numberInt"" : ""1"" } } } }",)
(1 row)

SELECT helio_api_internal.bson_update_document('{ "_id": 5 }', '{ "": { "$set": { "$inc": 5 } } }', '{}');
ERROR:  The dollar ($) prefixed field '$inc' in '$inc' is not allowed in the context of an update's replacement document. Consider using an aggregation pipeline with $replaceWith.
-- allowed on upsert.
SELECT helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "$secret.agent.x": 1, "_id": 6 } } }', '{}');
                                                bson_update_document                                                 
---------------------------------------------------------------------------------------------------------------------
 ("{ ""_id"" : { ""$numberInt"" : ""6"" }, ""$secret"" : { ""agent"" : { ""x"" : { ""$numberInt"" : ""1"" } } } }",)
(1 row)

SELECT helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "$secret.agent.x": 1 } } }', '{"_id": 2 }');
                                                bson_update_document                                                 
---------------------------------------------------------------------------------------------------------------------
 ("{ ""_id"" : { ""$numberInt"" : ""2"" }, ""$secret"" : { ""agent"" : { ""x"" : { ""$numberInt"" : ""1"" } } } }",)
(1 row)

SELECT helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "$secret.agent.x": 1 } } }', '{"a": 3, "_id": 4 }');
                                                                  bson_update_document                                                                   
---------------------------------------------------------------------------------------------------------------------------------------------------------
 ("{ ""_id"" : { ""$numberInt"" : ""4"" }, ""a"" : { ""$numberInt"" : ""3"" }, ""$secret"" : { ""agent"" : { ""x"" : { ""$numberInt"" : ""1"" } } } }",)
(1 row)

SELECT helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "$inc": 5 } } }', '{"_id": 5 }');
                                 bson_update_document                                 
--------------------------------------------------------------------------------------
 ("{ ""_id"" : { ""$numberInt"" : ""5"" }, ""$inc"" : { ""$numberInt"" : ""5"" } }",)
(1 row)

-- $pull invalid cases
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": "text"}', '{ "": { "$pull": { "a": 1 } } }', '{}');
ERROR:  Cannot apply $pull to a non-array value
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1}', '{ "": { "$pull": { "a": 1 } } }', '{}');
ERROR:  Cannot apply $pull to a non-array value
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": true}', '{ "": { "$pull": { "a": 1 } } }', '{}');
ERROR:  Cannot apply $pull to a non-array value
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": {"$numberDecimal": "1.23"}}', '{ "": { "$pull": { "a": 1 } } }', '{}');
ERROR:  Cannot apply $pull to a non-array value
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": {"b": 2}}', '{ "": { "$pull": { "a": 1 } } }', '{}');
ERROR:  Cannot apply $pull to a non-array value
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [{"b": 1, "c": 1}, {"b": 2, "c": 2}, {"b": 3, "c": 3}]}', '{ "": { "$pull": { "a.0": {"b": 2, "c":2} } } }', '{}');
ERROR:  Cannot apply $pull to a non-array value
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [{"b": [1], "c": [1]}, {"b": [2], "c": [2]}, {"b": [3], "c": [3]}]}', '{ "": { "$pull": { "a.b": 1 } } }', '{}');
ERROR:  Invalid array index path b
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pull": { "a": {"$lte": 2, "b": 2} } } }', '{}');
ERROR:  unknown operator: b
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pull": { "a": {"b": 2, "$lte": 2} } } }', '{}');
ERROR:  unknown top level operator: $lte. If you have a field name that starts with a '$' symbol, consider using $getField or $setField.
-- valid $pull without expressions in arrays and array of arrays
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pull": { "a": 3 } } }', '{}');
                                                             bson_update_document                                                             
----------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "4" }, { "$numberInt" : "5" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [{"b": 1, "c": 1}, {"b": 2, "c": 2}, {"b": 3, "c": 3}]}', '{ "": { "$pull": { "a": {"b": 2, "c":2} } } }', '{}');
                                                                             bson_update_document                                                                             
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "b" : { "$numberInt" : "1" }, "c" : { "$numberInt" : "1" } }, { "b" : { "$numberInt" : "3" }, "c" : { "$numberInt" : "3" } } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [[1,2,3,4,5], [6,7,8,9,10]]}', '{ "": { "$pull": { "a.0": 4 } } }', '{}');
                                                                                                                             bson_update_document                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" }, { "$numberInt" : "10" } ] ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [[{"b": 1, "c": 1}, {"b": 2, "c": 2}, {"b": 3, "c": 3}], [{"b": 4, "c": 4}, {"b": 5, "c": 5}, {"b": 6, "c": 6}]]}', '{ "": { "$pull": { "a.1": {"b": 4, "c": 4} } } }', '{}');
                                                                                                                                                                                 bson_update_document                                                                                                                                                                                 
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ [ { "b" : { "$numberInt" : "1" }, "c" : { "$numberInt" : "1" } }, { "b" : { "$numberInt" : "2" }, "c" : { "$numberInt" : "2" } }, { "b" : { "$numberInt" : "3" }, "c" : { "$numberInt" : "3" } } ], [ { "b" : { "$numberInt" : "5" }, "c" : { "$numberInt" : "5" } }, { "b" : { "$numberInt" : "6" }, "c" : { "$numberInt" : "6" } } ] ] }
(1 row)

-- valid $pull with expressions in arrays and array of arrays
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5,6,7,8,9,10]}', '{ "": { "$pull": { "a": {"$gte": 2, "$lte": 5} } } }', '{}');
                                                                                     bson_update_document                                                                                      
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" }, { "$numberInt" : "10" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [[1],[2],[3],[4],[5],[6],[7],[8],[9],[10]]}', '{ "": { "$pull": { "a": {"$gte": 5} } } }', '{}');
                                                                     bson_update_document                                                                     
--------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ [ { "$numberInt" : "1" } ], [ { "$numberInt" : "2" } ], [ { "$numberInt" : "3" } ], [ { "$numberInt" : "4" } ] ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5,6,7,8,9,10]}', '{ "": { "$pull": { "a": {"$gte": 5, "$ne": 8} } } }', '{}');
                                                                         bson_update_document                                                                         
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" }, { "$numberInt" : "4" }, { "$numberInt" : "8" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5,6,7,8,9,10]}', '{ "": { "$pull": { "a": {"$in": [3,6,9]} } } }', '{}');
                                                                                                 bson_update_document                                                                                                  
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "4" }, { "$numberInt" : "5" }, { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "10" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5,6,7,8,9,10]}', '{ "": { "$pull": { "a": {"$nin": [3,6,9]} } } }', '{}');
                                                 bson_update_document                                                 
----------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "3" }, { "$numberInt" : "6" }, { "$numberInt" : "9" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5,6,7,8,9,10]}', '{ "": { "$pull": { "a": { "$not": {"$gt": 5 } } } } }', '{}');
                                                                         bson_update_document                                                                          
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "6" }, { "$numberInt" : "7" }, { "$numberInt" : "8" }, { "$numberInt" : "9" }, { "$numberInt" : "10" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id":1,"fruits":[ "apples", "pears", "oranges", "grapes", "bananas" ],"vegetables":[ "carrots", "celery", "squash", "carrots" ]}',
                                                                                        '{"":{"$pull":{"fruits":{"$in":["apples","oranges"]},"vegetables":"carrots"}}}', '{}');
                                                  bson_update_document                                                  
------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "fruits" : [ "pears", "grapes", "bananas" ], "vegetables" : [ "celery", "squash" ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id":2,"fruits":[ "plums", "kiwis", "oranges", "bananas", "apples" ],"vegetables":[ "broccoli", "zucchini", "carrots", "onions" ]}',
                                                                                        '{"":{"$pull":{"fruits":{"$in":["apples","oranges"]},"vegetables":"carrots"}}}', '{}');
                                                        bson_update_document                                                         
-------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "fruits" : [ "plums", "kiwis", "bananas" ], "vegetables" : [ "broccoli", "zucchini", "onions" ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [{ "item": "A", "score": 5 }, { "item": "B", "score": 8 }, { "item": "C", "score": 8 }, { "item": "B", "score": 4 }]}',
                                                                                        '{ "": { "$pull": { "a": { "score": 8 , "item": "B" } } } }', '{}');
                                                                                           bson_update_document                                                                                           
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "item" : "A", "score" : { "$numberInt" : "5" } }, { "item" : "C", "score" : { "$numberInt" : "8" } }, { "item" : "B", "score" : { "$numberInt" : "4" } } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "results": [{ "item": "A", "score": 5, "answers": [ { "q": 1, "a": 4 }, { "q": 2, "a": 6 } ] }, { "item": "B", "score": 8, "answers": [ { "q": 1, "a": 8 }, { "q": 2, "a": 9 } ]}, { "item": "C", "score": 8, "answers": [ { "q": 1, "a": 8 }, { "q": 2, "a": 7 } ] }, { "item": "B", "score": 4, "answers": [ { "q": 1, "a": 0 }, { "q": 2, "a": 8 } ] }]}',
                                                                                        '{ "": { "$pull": { "results": { "answers": {"$elemMatch": { "q": 2, "a": { "$gte": 8 } } } } } } }', '{}');
                                                                                                                                                                                                                    bson_update_document                                                                                                                                                                                                                    
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "results" : [ { "item" : "A", "score" : { "$numberInt" : "5" }, "answers" : [ { "q" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "4" } }, { "q" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "6" } } ] }, { "item" : "C", "score" : { "$numberInt" : "8" }, "answers" : [ { "q" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "8" } }, { "q" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "7" } } ] } ] }
(1 row)

-- First level of nested array is supported in native mongo only when pull spec value is expression
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [[1],[2],[3],[4],[5],[6],[7],[8],[9],[10]]}', '{ "": { "$pull": { "a": {"$gte": 5} } } }', '{}');
                                                                     bson_update_document                                                                     
--------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ [ { "$numberInt" : "1" } ], [ { "$numberInt" : "2" } ], [ { "$numberInt" : "3" } ], [ { "$numberInt" : "4" } ] ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "arr": [[{"a": 1, "b" : 1}], [{"a": 2, "b": 2}], [{"a": 3, "b": 3}]]}', '{ "": { "$pull": { "arr":  {"$eq": {"a": 1, "b": 1} } } } }', '{}');
                                                                                  bson_update_document                                                                                  
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "arr" : [ [ { "a" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "2" } } ], [ { "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "3" } } ] ] }
(1 row)

-- First level of nested array is not recursed if $pull spec value is plain value
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "arr": [[1],[2],[3],[4],[5],[6],[7],[8],[9],[10]]}', '{ "": { "$pull": { "a":  5 } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "arr": [[{"a": 1, "b" : 1}], [{"a": 2, "b": 2}], [{"a": 3, "b": 3}]]}', '{ "": { "$pull": { "arr":  {"a": 1, "b": 1} } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

-- Second and more are not supported
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [[[1,2]], [[3,4]]]}', '{ "": { "$pull": { "a": {"$gte": 3} } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

-- $pull no ops for no match
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [{"b": 1, "c": 1}, {"b": 2, "c": 2}, {"b": 3, "c": 3}]}', '{ "": { "$pull": { "a": {"b": 2, "c":3} } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pull": { "c": 1 } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [1,2,3,4,5]}', '{ "": { "$pull": { "a": {"$gt": 5} } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": [{ "item": "A", "score": 5 }, { "item": "B", "score": 8 }, { "item": "C", "score": 8 }, { "item": "B", "score": 4 }]}',
                                                                                        '{ "": { "$pull": { "a": { "$elemMatch": { "score": 8 , "item": "B" } } } } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

-- validate _id
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$set": { "_id": {"$b": 2, "c":3} } } }', '{}');
ERROR:  _id fields may not contain '$'-prefixed fields: $b is not valid for storage.
-- replaceRoot/replaceWith with dotted paths.
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": [ { "$replaceWith": { "_id": 1, "a.b.c": 3 } } ] }', '{}');
ERROR:  FieldPath field names may not contain '.'. Consider using $getField or $setField
--upsert when querySpec has $all
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {} }', '{"_id": 10, "x": { "$all" : {}}}');
ERROR:  $all needs an array
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {} }', '{"_id": 11, "x": { "$all" : [1]}}');
        bson_update_document         
-------------------------------------
 { "_id" : { "$numberInt" : "11" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"_id":12}}}','{"x": { "$all" : [2]}}');
                       bson_update_document                        
-------------------------------------------------------------------
 { "_id" : { "$numberInt" : "12" }, "x" : { "$numberInt" : "2" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"_id":13}}}' ,'{"x": { "$all" : [[3]]}}');
                         bson_update_document                          
-----------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "x" : [ { "$numberInt" : "3" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"_id":14}}}','{"x": { "$all" : [{"x":11}]}}');
                             bson_update_document                             
------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "14" }, "x" : { "x" : { "$numberInt" : "11" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"x":15}}}','{"_id": { "$all" : [15]}}');
                        bson_update_document                        
--------------------------------------------------------------------
 { "_id" : { "$numberInt" : "15" }, "x" : { "$numberInt" : "15" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"x":16}}}','{"_id": { "$all" : [{"x": 16}]}}');
                             bson_update_document                             
------------------------------------------------------------------------------
 { "_id" : { "x" : { "$numberInt" : "16" } }, "x" : { "$numberInt" : "16" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"x":17}}}','{"_id": { "$all" : [[13]]}}');
ERROR:  The '_id' value cannot be of type array
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"_id":18}}}','{"x": { "$all" : [1,2,3]}}');
ERROR:  cannot infer query fields to set, path 'x' is matched twice
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"x":19}}}','{"_id": { "$all" : [15,16,17]}}');
ERROR:  cannot infer query fields to set, path '_id' is matched twice
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {}}','{"_id": { "$all" : [[15]]}}');
ERROR:  After applying the update to the document, the (immutable) field '_id' was found to be an array or array descendant.
--upsert when querySpec has $in
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {} }','{"_id": 21, "x": { "$in" : {}}}');
ERROR:  $in needs an array
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {} }','{"_id": 22, "x": { "$in" : [1]}}');
        bson_update_document         
-------------------------------------
 { "_id" : { "$numberInt" : "22" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"_id":23}}}','{"x": { "$in" : [3423]}}');
                         bson_update_document                         
----------------------------------------------------------------------
 { "_id" : { "$numberInt" : "23" }, "x" : { "$numberInt" : "3423" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"_id":24}}}','{"x": { "$in" : [[2]]}}');
                         bson_update_document                          
-----------------------------------------------------------------------
 { "_id" : { "$numberInt" : "24" }, "x" : [ { "$numberInt" : "2" } ] }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"_id":25}}}','{"x": { "$in" : [{"y":2}]}}');
                            bson_update_document                             
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "25" }, "x" : { "y" : { "$numberInt" : "2" } } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"_id":26}}}','{"x": { "$in" : [10,20,30]}}');
        bson_update_document         
-------------------------------------
 { "_id" : { "$numberInt" : "26" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"x":27}}}','{"_id": { "$in" : [25]}}');
                        bson_update_document                        
--------------------------------------------------------------------
 { "_id" : { "$numberInt" : "25" }, "x" : { "$numberInt" : "27" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"x":28}}}','{"_id": { "$in" : [{"y":26}]}}');
                             bson_update_document                             
------------------------------------------------------------------------------
 { "_id" : { "y" : { "$numberInt" : "26" } }, "x" : { "$numberInt" : "28" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"x":29}}}','{"_id": { "$in" : [[26]]}}');
ERROR:  The '_id' value cannot be of type array
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"_id":30}}}','{"_id": { "$in" : [27]}}');
ERROR:  Performing an update on the path '_id' would modify the immutable field '_id'
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"_id":31}}}','{"_id": { "$in" : [27,28,29]}}');
        bson_update_document         
-------------------------------------
 { "_id" : { "$numberInt" : "31" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {} }','{"_id": { "$in" : [[27]]}}');
ERROR:  After applying the update to the document, the (immutable) field '_id' was found to be an array or array descendant.
SELECT bson_dollar_project(newDocument, '{ "_id": 0 }') as newDocument from  helio_api_internal.bson_update_document('{}', '{ "": {"$set":{"y":31}}}','{"_id": { "$in" : [27,28,29]}}');
ERROR:  function bson_dollar_project(bson, unknown) does not exist
LINE 1: SELECT bson_dollar_project(newDocument, '{ "_id": 0 }') as n...
               ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
-- $nor operator in query spec
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"_id": 1, "b": 3} }', '{"$nor": [ { "_id": { "$eq" : 2}}]}');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "3" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"_id": 1, "b": 3} }', '{"$nor": [ { "a": { "$eq" : 2}}]}');
                       bson_update_document                       
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "3" } }
(1 row)

--miscellaneous tests with multiple fields in queySpec
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {} }','{"$and": [{"_id": 1}, {"_id": 1}]}');
ERROR:  cannot infer query fields to set, path '_id' is matched twice
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set": {"a": 1}} }','{"_id.x": 1 , "_id.y": 2}');
                                           bson_update_document                                           
----------------------------------------------------------------------------------------------------------
 { "_id" : { "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" } }, "a" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set": {"a": 1}} }','{"$and": [{"x": 1}, {"x": 1}]}');
ERROR:  cannot infer query fields to set, path 'x' is matched twice
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set": {"a": 1}} }','{"x": 1, "x.x": 1}');
ERROR:  cannot infer query fields to set, path 'x.x' is matched twice
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": {"$set": {"a": 1}} }','{"x.x": 1, "x": 1}');
ERROR:  cannot infer query fields to set, path 'x' is matched twice
-- show that we never crash due to passing one of the arguments as NULL
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": 1}', '{"": {"a": 2}}', null);
ERROR:  sourceDocument / updateSpec / querySpec cannot be NULL
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": 1}', null, '{"b": 1}');
ERROR:  sourceDocument / updateSpec / querySpec cannot be NULL
SELECT helio_api_internal.bson_update_document(null, '{"": {"a": 1}}', '{"c": 1}');
ERROR:  sourceDocument / updateSpec / querySpec cannot be NULL
SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": 1}', '{"": {"a": 2}}', '{"b": 1}', null, true);
                               bson_update_document                                
-----------------------------------------------------------------------------------
 ("{ ""_id"" : { ""$numberInt"" : ""1"" }, ""a"" : { ""$numberInt"" : ""2"" } }",)
(1 row)

SELECT helio_api_internal.bson_update_document('{"_id": 1, "a": 1}', '{"": {"a": 2}}', '{"b": 1}', '{"a": 1}', true);
                               bson_update_document                                
-----------------------------------------------------------------------------------
 ("{ ""_id"" : { ""$numberInt"" : ""1"" }, ""a"" : { ""$numberInt"" : ""2"" } }",)
(1 row)

-- $rename Negative/No-Op cases
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$rename": { "a.": "b"} } }', '{}');
ERROR:  An update path 'a.' contains an empty field name, which is not allowed.
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$rename": { "$.": "b"} } }', '{}');
ERROR:  An update path '$.' contains an empty field name, which is not allowed.
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$rename": { "$[].0": "b"} } }', '{}');
ERROR:  Cannot have array filter identifier (i.e. '$[<id>]') element in the first position in path '$[].0'
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$rename": { "a": "b."} } }', '{}');
ERROR:  An update path 'b.' contains an empty field name, which is not allowed.
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$rename": { "a": "$"} } }', '{}');
ERROR:  Cannot have positional (i.e. '$') element in the first position in path '$'
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{}', '{ "": { "$rename": { "a": "$[]"} } }', '{}');
ERROR:  Cannot have array filter identifier (i.e. '$[<id>]') element in the first position in path '$[]'
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"a": 1, "f": 1}', '{ "": { "$rename": { "a": "f.g"} } }', '{}');
ERROR:  Cannot create field 'f' in element {f : 1}
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"a": 1, "f": 1}', '{ "": { "$rename": { "f.g": "a"} } }', '{}');
ERROR:  Cannot create field 'f' in element {f : 1}
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "a": 1, "f": 1}', '{ "": { "$rename": { "x": "f.g"} } }', '{}');
 bson_update_document 
----------------------
 
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"a" : 1, "f" : 1, "b" : { "c" : { "d" : 1 } }}', '{ "": { "$rename": { "b.c.d.f": "t.k"} } }', '{}');
ERROR:  Cannot create field 'd' in element {d : 1}
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"key": 1,"key2": 2,"f": {"g": 1, "h": 1},"j": 1,"k": 1}', '{ "": { "$rename": { "f.g": "k.m","f.h":"j.m"} } }', '{}');
ERROR:  Cannot create field 'j' in element {j : 1}
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"key": 1,"key2": 2,"f": {"g": 1, "h": 1},"j": {},"k": 1}', '{ "": { "$rename": { "f.g": "k.m","f.h":"j.m"} } }', '{}');
ERROR:  Cannot create field 'k' in element {k : 1}
--$rename working complex cases
SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 1, "key": 1,"key2": 2,"f": {"g": 1, "h": 1},"h":1}', '{ "": { "$rename": { "key": "f.g"} } }', '{}');
                                                                          bson_update_document                                                                           
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "key2" : { "$numberInt" : "2" }, "f" : { "g" : { "$numberInt" : "1" }, "h" : { "$numberInt" : "1" } }, "h" : { "$numberInt" : "1" } }
(1 row)

SELECT newDocument as bson_update_document FROM helio_api_internal.bson_update_document('{"_id": 2, "key": 2,"x": {"y": 1, "z": 2}}', '{ "": { "$rename": { "key": "newName","x.y":"z","x.z":"k"} } }', '{}');
                                                              bson_update_document                                                              
------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "x" : {  }, "newName" : { "$numberInt" : "2" }, "z" : { "$numberInt" : "1" }, "k" : { "$numberInt" : "2" } }
(1 row)

