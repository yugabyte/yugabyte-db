SET search_path to helio_core,helio_api,helio_api_catalog,pg_catalog;
SET citus.next_shard_id TO 1116000;
SET helio_api.next_collection_id TO 11160;
SET helio_api.next_collection_index_id TO 11160;
SELECT helio_api.insert_one('db','maxminn_test1',' { "gameId": "G1", "name" : "playerA", "score": 23 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test1',' { "gameId": "G1", "name" : "playerB", "score": 128 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test1',' { "gameId": "G1", "name" : "playerC", "score": 1 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test1',' { "gameId": "G1", "name" : "playerD", "score": 32 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test1',' { "gameId": "G2", "name" : "playerA", "score": 76 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test1',' { "gameId": "G2", "name" : "playerB", "score": 34 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test1',' { "gameId": "G2", "name" : "playerC", "score": 6 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test1',' { "gameId": "G2", "name" : "playerD", "score": 87 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test2',' { "gameId": "G1", "name" : "playerA", "score": null }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test2',' { "gameId": "G1", "name" : "playerB", "score": 128 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test2',' { "gameId": "G1", "name" : "playerC", "score": {"$undefined":true} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test2',' { "gameId": "G1", "name" : "playerD", "score": 32 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test2',' { "gameId": "G1", "name" : "playerA", "score": null }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test2',' { "gameId": "G1", "name" : "playerB", "score": 179 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test2',' { "gameId": "G2", "name" : "playerA", "score": null }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test2',' { "gameId": "G2", "name" : "playerB", "score": 34 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test2',' { "gameId": "G2", "name" : "playerC", "score": 6 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test2',' { "gameId": "G2", "name" : "playerD", "score": {"$undefined":true} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test2',' { "gameId": "G2", "name" : "playerA", "score": 76 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test2',' { "gameId": "G2", "name" : "playerB", "score": {"$undefined":true} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test3',' { "gameId": "G1", "name" : "playerA", "score": 23 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test3',' { "gameId": "G1", "name" : "playerB", "score": 128 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test3',' { "gameId": "G1", "name" : "playerC", "score": [[1,3],5,2,4] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test3',' { "gameId": "G1", "name" : "playerD", "score": 32 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test3',' { "gameId": "G2", "name" : "playerA", "score": 76 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test3',' { "gameId": "G2", "name" : "playerB", "score": [[7,8],3,4] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test3',' { "gameId": "G2", "name" : "playerC", "score": 6 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test3',' { "gameId": "G2", "name" : "playerD", "score": 87 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test4',' {"_id": 1, "gameId": "G1", "name" : "playerA", "score": 23 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test4',' {"_id": 2, "gameId": "G1", "name" : "playerB", "score": 128 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test4',' {"_id": 3, "gameId": "G1", "name" : "playerC", "score": 1 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test4',' {"_id": 4, "gameId": "G1", "name" : "playerD", "score": 32 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test4',' {"_id": 5, "gameId": "G2", "name" : "playerA", "score": 76 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test4',' {"_id": 6, "gameId": "G2", "name" : "playerB", "score": 34 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test4',' {"_id": 7, "gameId": "G2", "name" : "playerC", "score": 6 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test4',' {"_id": 8, "gameId": "G2", "name" : "playerD", "score": 87 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test5',' { "gameId": "G1", "name" : "playerA", "score": 23 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test5',' { "gameId": "G1", "name" : "playerB", "score": [[1,2],[3,4]] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test5',' { "gameId": "G1", "name" : "playerC", "score": "apple" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test5',' { "gameId": "G1", "name" : "playerD", "score": 32 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test5',' { "gameId": "G2", "name" : "playerA", "score": 76 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test5',' { "gameId": "G2", "name" : "playerC", "score": [[7,8],2,1] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test5',' { "gameId": "G2", "name" : "playerB", "score": "port" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','maxminn_test5',' { "gameId": "G2", "name" : "playerD", "score": 87 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 3 } } } } ] }');
                                                  document                                                   
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "128" }, { "$numberInt" : "32" }, { "$numberInt" : "23" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "87" }, { "$numberInt" : "76" }, { "$numberInt" : "34" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 3 } } } } ] }');
                                                 document                                                  
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "1" }, { "$numberInt" : "23" }, { "$numberInt" : "32" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "6" }, { "$numberInt" : "34" }, { "$numberInt" : "76" } ] }
(2 rows)

/*n == 1*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 1 } } } } ] }');
                         document                          
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "128" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "87" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 1 } } } } ] }');
                        document                         
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "1" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "6" } ] }
(2 rows)

/*n == 0*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 0 } } } } ] }');
ERROR:  'n' must be greater than 0, found 0
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 0 } } } } ] }');
ERROR:  'n' must be greater than 0, found 0
/*n == -1*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": -1 } } } } ] }');
ERROR:  'n' must be greater than 0, found -1
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": -1 } } } } ] }');
ERROR:  'n' must be greater than 0, found -1
/*n == 0.5*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 0.5 } } } } ] }');
ERROR:  Value for 'n' must be of integral type, but found 0.5
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 0.5 } } } } ] }');
ERROR:  Value for 'n' must be of integral type, but found 0.5
/*n is a variable*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": "$$nValue" } } } } ], "let": { "nValue": 3 } }');
                                                  document                                                   
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "128" }, { "$numberInt" : "32" }, { "$numberInt" : "23" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "87" }, { "$numberInt" : "76" }, { "$numberInt" : "34" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": "$$nValue" } } } } ], "let": { "nValue": 3 } }');
                                                 document                                                  
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "1" }, { "$numberInt" : "23" }, { "$numberInt" : "32" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "6" }, { "$numberInt" : "34" }, { "$numberInt" : "76" } ] }
(2 rows)

/*input is a document*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": {"$bitAnd": ["$score", 7]}, "n": 3 } } } } ] }');
                                                document                                                 
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "7" }, { "$numberInt" : "1" }, { "$numberInt" : "0" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "7" }, { "$numberInt" : "6" }, { "$numberInt" : "4" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": {"$bitAnd": ["$score", 7]}, "n": 3 } } } } ] }');
                                                document                                                 
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" }, { "$numberInt" : "1" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "2" }, { "$numberInt" : "4" }, { "$numberInt" : "6" } ] }
(2 rows)

/*n is a object*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": {"key" :{"value": {"score": "$score" }}}, "n": 3 } } } } ] }');
                                                                                                              document                                                                                                               
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "key" : { "value" : { "score" : { "$numberInt" : "128" } } } }, { "key" : { "value" : { "score" : { "$numberInt" : "32" } } } }, { "key" : { "value" : { "score" : { "$numberInt" : "23" } } } } ] }
 { "_id" : "G2", "NScore" : [ { "key" : { "value" : { "score" : { "$numberInt" : "87" } } } }, { "key" : { "value" : { "score" : { "$numberInt" : "76" } } } }, { "key" : { "value" : { "score" : { "$numberInt" : "34" } } } } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": {"key" :{"value": {"score": "$score" }}}, "n": 3 } } } } ] }');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "key" : { "value" : { "score" : { "$numberInt" : "1" } } } }, { "key" : { "value" : { "score" : { "$numberInt" : "23" } } } }, { "key" : { "value" : { "score" : { "$numberInt" : "32" } } } } ] }
 { "_id" : "G2", "NScore" : [ { "key" : { "value" : { "score" : { "$numberInt" : "6" } } } }, { "key" : { "value" : { "score" : { "$numberInt" : "34" } } } }, { "key" : { "value" : { "score" : { "$numberInt" : "76" } } } } ] }
(2 rows)

/*input is a nested array*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": [[2,3], "$score"], "n": 3 } } } } ] }');
                                                                                                                                      document
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ [ [ { "$numberInt" : "2" }, { "$numberInt" : "3" } ], { "$numberInt" : "128" } ], [ [ { "$numberInt" : "2" }, { "$numberInt" : "3" } ], { "$numberInt" : "32" } ], [ [ { "$numberInt" : "2" }, { "$numberInt" : "3" } ], { "$numberInt" : "23" } ] ] }
 { "_id" : "G2", "NScore" : [ [ [ { "$numberInt" : "2" }, { "$numberInt" : "3" } ], { "$numberInt" : "87" } ], [ [ { "$numberInt" : "2" }, { "$numberInt" : "3" } ], { "$numberInt" : "76" } ], [ [ { "$numberInt" : "2" }, { "$numberInt" : "3" } ], { "$numberInt" : "34" } ] ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": [[2,3], "$score"], "n": 3 } } } } ] }');
                                                                                                                                     document
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ [ [ { "$numberInt" : "2" }, { "$numberInt" : "3" } ], { "$numberInt" : "1" } ], [ [ { "$numberInt" : "2" }, { "$numberInt" : "3" } ], { "$numberInt" : "23" } ], [ [ { "$numberInt" : "2" }, { "$numberInt" : "3" } ], { "$numberInt" : "32" } ] ] }
 { "_id" : "G2", "NScore" : [ [ [ { "$numberInt" : "2" }, { "$numberInt" : "3" } ], { "$numberInt" : "6" } ], [ [ { "$numberInt" : "2" }, { "$numberInt" : "3" } ], { "$numberInt" : "34" } ], [ [ { "$numberInt" : "2" }, { "$numberInt" : "3" } ], { "$numberInt" : "76" } ] ] }
(2 rows)

/*n too large */
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 100 } } } } ] }');
                                                              document                                                               
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "128" }, { "$numberInt" : "32" }, { "$numberInt" : "23" }, { "$numberInt" : "1" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "87" }, { "$numberInt" : "76" }, { "$numberInt" : "34" }, { "$numberInt" : "6" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 100 } } } } ] }');
                                                              document                                                               
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "1" }, { "$numberInt" : "23" }, { "$numberInt" : "32" }, { "$numberInt" : "128" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "6" }, { "$numberInt" : "34" }, { "$numberInt" : "76" }, { "$numberInt" : "87" } ] }
(2 rows)

/*n missing */
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score"} } } } ] }');
ERROR:  $maxN requires an 'n' field
HINT:  $maxN requires an 'n' field
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score"} } } } ] }');
ERROR:  $minN requires an 'n' field
HINT:  $minN requires an 'n' field
/*input missing */
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"n": 3 } } } } ] }');
ERROR:  $maxN requires an 'input' field
HINT:  $maxN requires an 'input' field
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test1", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"n": 3 } } } } ] }');
ERROR:  $minN requires an 'input' field
HINT:  $minN requires an 'input' field
/*test null/$undefined */
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test2", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 3 } } } } ] }');
                                                   document                                                   
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "179" }, { "$numberInt" : "128" }, { "$numberInt" : "32" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "76" }, { "$numberInt" : "34" }, { "$numberInt" : "6" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test2", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 3 } } } } ] }');
                                                   document                                                   
--------------------------------------------------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "32" }, { "$numberInt" : "128" }, { "$numberInt" : "179" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "6" }, { "$numberInt" : "34" }, { "$numberInt" : "76" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test2", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 100 } } } } ] }');
                                                   document                                                   
--------------------------------------------------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "179" }, { "$numberInt" : "128" }, { "$numberInt" : "32" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "76" }, { "$numberInt" : "34" }, { "$numberInt" : "6" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test2", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 100 } } } } ] }');
                                                   document                                                   
--------------------------------------------------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "32" }, { "$numberInt" : "128" }, { "$numberInt" : "179" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "6" }, { "$numberInt" : "34" }, { "$numberInt" : "76" } ] }
(2 rows)

/* nested array */
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test3", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 3 } } } } ] }');
                                                                                                      document                                                                                                      
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ [ [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ], { "$numberInt" : "5" }, { "$numberInt" : "2" }, { "$numberInt" : "4" } ], { "$numberInt" : "128" }, { "$numberInt" : "32" } ] }
 { "_id" : "G2", "NScore" : [ [ [ { "$numberInt" : "7" }, { "$numberInt" : "8" } ], { "$numberInt" : "3" }, { "$numberInt" : "4" } ], { "$numberInt" : "87" }, { "$numberInt" : "76" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test3", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 3 } } } } ] }');
                                                  document                                                   
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "23" }, { "$numberInt" : "32" }, { "$numberInt" : "128" } ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "6" }, { "$numberInt" : "76" }, { "$numberInt" : "87" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test3", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 100 } } } } ] }');
                                                                                                                  document                                                                                                                   
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ [ [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ], { "$numberInt" : "5" }, { "$numberInt" : "2" }, { "$numberInt" : "4" } ], { "$numberInt" : "128" }, { "$numberInt" : "32" }, { "$numberInt" : "23" } ] }
 { "_id" : "G2", "NScore" : [ [ [ { "$numberInt" : "7" }, { "$numberInt" : "8" } ], { "$numberInt" : "3" }, { "$numberInt" : "4" } ], { "$numberInt" : "87" }, { "$numberInt" : "76" }, { "$numberInt" : "6" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test3", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 100 } } } } ] }');
                                                                                                                  document                                                                                                                   
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "23" }, { "$numberInt" : "32" }, { "$numberInt" : "128" }, [ [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ], { "$numberInt" : "5" }, { "$numberInt" : "2" }, { "$numberInt" : "4" } ] ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "6" }, { "$numberInt" : "76" }, { "$numberInt" : "87" }, [ [ { "$numberInt" : "7" }, { "$numberInt" : "8" } ], { "$numberInt" : "3" }, { "$numberInt" : "4" } ] ] }
(2 rows)

/* sharded tests */
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test4", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 3 } } } } ] }');
                                                    QUERY PLAN                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Subquery Scan on agg_stage_0
               ->  GroupAggregate
                     Group Key: (helio_api_catalog.bson_expression_get(collection.document, '{ "" : "$gameId" }'::helio_core.bson, true))
                     ->  Sort
                           Sort Key: (helio_api_catalog.bson_expression_get(collection.document, '{ "" : "$gameId" }'::helio_core.bson, true))
                           ->  Bitmap Heap Scan on documents_11163_1116049 collection
                                 Recheck Cond: (shard_key_value = '11163'::bigint)
                                 ->  Bitmap Index Scan on _id_
                                       Index Cond: (shard_key_value = '11163'::bigint)
(14 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test4", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 3 } } } } ] }');
                                                    QUERY PLAN                                                     
--------------------------------------------------------------------- 
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Subquery Scan on agg_stage_0
               ->  GroupAggregate
                     Group Key: (helio_api_catalog.bson_expression_get(collection.document, '{ "" : "$gameId" }'::helio_core.bson, true))
                     ->  Sort
                           Sort Key: (helio_api_catalog.bson_expression_get(collection.document, '{ "" : "$gameId" }'::helio_core.bson, true))
                           ->  Bitmap Heap Scan on documents_11163_1116049 collection
                                 Recheck Cond: (shard_key_value = '11163'::bigint)
                                 ->  Bitmap Index Scan on _id_
                                       Index Cond: (shard_key_value = '11163'::bigint)
(14 rows)

SELECT helio_api.shard_collection('db', 'maxminn_test4', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test4", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 3 } } } } ] }');
                                                 QUERY PLAN                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   ->  Distributed Subplan 133_1
         ->  HashAggregate
               Group Key: remote_scan.c2
               ->  Custom Scan (Citus Adaptive)
                     Task Count: 8
                     Tasks Shown: One of 8
                     ->  Task
                           Node: host=localhost port=58070 dbname=regression
                           ->  HashAggregate
                                 Group Key: helio_api_catalog.bson_expression_get(document, '{ "" : "$gameId" }'::helio_core.bson, true)
                                 ->  Seq Scan on documents_11163_1116080 collection
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Function Scan on read_intermediate_result intermediate_result
(17 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test4", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 3 } } } } ] }');
                                                 QUERY PLAN                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   ->  Distributed Subplan 135_1
         ->  HashAggregate
               Group Key: remote_scan.c2
               ->  Custom Scan (Citus Adaptive)
                     Task Count: 8
                     Tasks Shown: One of 8
                     ->  Task
                           Node: host=localhost port=58070 dbname=regression
                           ->  HashAggregate
                                 Group Key: helio_api_catalog.bson_expression_get(document, '{ "" : "$gameId" }'::helio_core.bson, true)
                                 ->  Seq Scan on documents_11163_1116080 collection
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Function Scan on read_intermediate_result intermediate_result
(17 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test4", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 3 } } } } ] }');
                                                  document                                                   
---------------------------------------------------------------------
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "87" }, { "$numberInt" : "76" }, { "$numberInt" : "34" } ] }
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "128" }, { "$numberInt" : "32" }, { "$numberInt" : "23" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test4", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 3 } } } } ] }');
                                                 document                                                  
---------------------------------------------------------------------
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "6" }, { "$numberInt" : "34" }, { "$numberInt" : "76" } ] }
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "1" }, { "$numberInt" : "23" }, { "$numberInt" : "32" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test4", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 100 } } } } ] }');
                                                              document                                                               
---------------------------------------------------------------------
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "87" }, { "$numberInt" : "76" }, { "$numberInt" : "34" }, { "$numberInt" : "6" } ] }
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "128" }, { "$numberInt" : "32" }, { "$numberInt" : "23" }, { "$numberInt" : "1" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test4", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 100 } } } } ] }');
                                                              document                                                               
---------------------------------------------------------------------
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "6" }, { "$numberInt" : "34" }, { "$numberInt" : "76" }, { "$numberInt" : "87" } ] }
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "1" }, { "$numberInt" : "23" }, { "$numberInt" : "32" }, { "$numberInt" : "128" } ] }
(2 rows)

/* test string and nested array */
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test5", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 3 } } } } ] }');
                                                                                   document                                                                                    
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ [ [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "3" }, { "$numberInt" : "4" } ] ], "apple", { "$numberInt" : "32" } ] }
 { "_id" : "G2", "NScore" : [ [ [ { "$numberInt" : "7" }, { "$numberInt" : "8" } ], { "$numberInt" : "2" }, { "$numberInt" : "1" } ], "port", { "$numberInt" : "87" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test5", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 3 } } } } ] }');
                                          document                                          
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "23" }, { "$numberInt" : "32" }, "apple" ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "76" }, { "$numberInt" : "87" }, "port" ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test5", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$maxN": {"input": "$score", "n": 100 } } } } ] }');
                                                                                                document                                                                                                
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ [ [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "3" }, { "$numberInt" : "4" } ] ], "apple", { "$numberInt" : "32" }, { "$numberInt" : "23" } ] }
 { "_id" : "G2", "NScore" : [ [ [ { "$numberInt" : "7" }, { "$numberInt" : "8" } ], { "$numberInt" : "2" }, { "$numberInt" : "1" } ], "port", { "$numberInt" : "87" }, { "$numberInt" : "76" } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "maxminn_test5", "pipeline": [ { "$group": { "_id": "$gameId", "NScore":{"$minN": {"input": "$score", "n": 100 } } } } ] }');
                                                                                                document                                                                                                
---------------------------------------------------------------------
 { "_id" : "G1", "NScore" : [ { "$numberInt" : "23" }, { "$numberInt" : "32" }, "apple", [ [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "3" }, { "$numberInt" : "4" } ] ] ] }
 { "_id" : "G2", "NScore" : [ { "$numberInt" : "76" }, { "$numberInt" : "87" }, "port", [ [ { "$numberInt" : "7" }, { "$numberInt" : "8" } ], { "$numberInt" : "2" }, { "$numberInt" : "1" } ] ] }
(2 rows)

