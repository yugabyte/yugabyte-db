--
-- test distinct bitmap scans (distinct pushdown is not supported by bitmap scans)
--
\getenv abs_srcdir PG_ABS_SRCDIR
\set filename :abs_srcdir '/yb_commands/explainrun.sql'
\i :filename
-- A helper script to explain and run a query.  Use in regress tests by
-- defining :explain, :query, and optionally :hint#.
\set explain1 ':explain :hint1 :query;'
\set explain2 ':explain1 :explain :hint2 :query;'
\set explain3 ':explain2 :explain :hint3 :query;'
\set explain4 ':explain3 :explain :hint4 :query;'
\set explain5 ':explain4 :explain :hint5 :query;'
\set explain1run1 ':explain1; :hint1 :query;'
\set explain2run2 ':explain2; :hint1 :query; :hint2 :query;'
\set explain3run3 ':explain3; :hint1 :query; :hint2 :query; :hint3 :query;'
\set explain4run4 ':explain4; :hint1 :query; :hint2 :query; :hint3 :query; :hint4 :query;'
\set explain5run5 ':explain5; :hint1 :query; :hint2 :query; :hint3 :query; :hint4 :query; :hint5 :query;'
-- Default to no hints.
\set hint1 ''
\set hint2 ''
\set hint3 ''
\set hint4 ''
\set hint5 ''
\set explain 'EXPLAIN (ANALYZE, COSTS OFF, SUMMARY OFF)'
SET yb_enable_bitmapscan = true;
CREATE TABLE test_distinct (r1 INT, r2 INT, r3 INT, v INT, PRIMARY KEY(r1 ASC, r2 ASC, r3 ASC)) SPLIT AT VALUES ((1, 1, 500));
INSERT INTO test_distinct (SELECT 1, i%3, i, i/3 FROM GENERATE_SERIES(1, 1000) AS i);
-- Add one more distinct value to catch bugs that arise only with more than one distinct value.
INSERT INTO test_distinct (SELECT 2, i%3, i, i/3 FROM GENERATE_SERIES(1, 1000) AS i);
SET yb_enable_distinct_pushdown = true;
SET enable_bitmapscan = false;
\set query 'SELECT DISTINCT r1 FROM test_distinct WHERE r1 < 2 ORDER BY r1'
:explain1run1
                                         QUERY PLAN                                          
---------------------------------------------------------------------------------------------
 Unique (actual rows=1 loops=1)
   ->  Distinct Index Scan using test_distinct_pkey on test_distinct (actual rows=2 loops=1)
         Index Cond: (r1 < 2)
         Distinct Keys: r1
(4 rows)

 r1 
----
  1
(1 row)

\set query 'SELECT DISTINCT r1, r2 FROM test_distinct WHERE r1 < 2 OR r2 < 3 ORDER BY r1, r2'
:explain1run1
                                         QUERY PLAN                                          
---------------------------------------------------------------------------------------------
 Unique (actual rows=6 loops=1)
   ->  Distinct Index Scan using test_distinct_pkey on test_distinct (actual rows=7 loops=1)
         Distinct Keys: r1, r2
         Storage Filter: ((r1 < 2) OR (r2 < 3))
(4 rows)

 r1 | r2 
----+----
  1 |  0
  1 |  1
  1 |  2
  2 |  0
  2 |  1
  2 |  2
(6 rows)

\set query 'SELECT DISTINCT r1, r2 FROM test_distinct WHERE r1 < 2 OR r2 < 3 OR r3 < 2 ORDER BY r1, r2'
:explain1run1
                            QUERY PLAN                            
------------------------------------------------------------------
 Sort (actual rows=6 loops=1)
   Sort Key: r1, r2
   Sort Method: quicksort
   ->  HashAggregate (actual rows=6 loops=1)
         Group Key: r1, r2
         ->  Seq Scan on test_distinct (actual rows=2000 loops=1)
               Storage Filter: ((r1 < 2) OR (r2 < 3) OR (r3 < 2))
(7 rows)

 r1 | r2 
----+----
  1 |  0
  1 |  1
  1 |  2
  2 |  0
  2 |  1
  2 |  2
(6 rows)

RESET enable_bitmapscan;
\set hint1 '/*+ BitmapScan(test_distinct) */'
\set query 'SELECT DISTINCT r1 FROM test_distinct WHERE r1 < 2 ORDER BY r1'
:explain1run1
                                      QUERY PLAN                                      
--------------------------------------------------------------------------------------
 Unique (actual rows=1 loops=1)
   ->  Sort (actual rows=1000 loops=1)
         Sort Key: r1
         Sort Method: quicksort
         ->  YB Bitmap Table Scan on test_distinct (actual rows=1000 loops=1)
               ->  Bitmap Index Scan on test_distinct_pkey (actual rows=1000 loops=1)
                     Index Cond: (r1 < 2)
(7 rows)

 r1 
----
  1
(1 row)

\set query 'SELECT DISTINCT r1, r2 FROM test_distinct WHERE r1 < 2 OR r2 < 3 ORDER BY r1, r2'
:explain1run1
                                         QUERY PLAN                                         
--------------------------------------------------------------------------------------------
 Unique (actual rows=6 loops=1)
   ->  Sort (actual rows=2000 loops=1)
         Sort Key: r1, r2
         Sort Method: quicksort
         ->  YB Bitmap Table Scan on test_distinct (actual rows=2000 loops=1)
               ->  BitmapOr (actual rows=2000 loops=1)
                     ->  Bitmap Index Scan on test_distinct_pkey (actual rows=1000 loops=1)
                           Index Cond: (r1 < 2)
                     ->  Bitmap Index Scan on test_distinct_pkey (actual rows=2000 loops=1)
                           Index Cond: (r2 < 3)
(10 rows)

 r1 | r2 
----+----
  1 |  0
  1 |  1
  1 |  2
  2 |  0
  2 |  1
  2 |  2
(6 rows)

\set query 'SELECT DISTINCT r1, r2 FROM test_distinct WHERE r1 < 2 OR r2 < 3 OR r3 < 2 ORDER BY r1, r2'
:explain1run1
                                         QUERY PLAN                                         
--------------------------------------------------------------------------------------------
 Unique (actual rows=6 loops=1)
   ->  Sort (actual rows=2000 loops=1)
         Sort Key: r1, r2
         Sort Method: quicksort
         ->  YB Bitmap Table Scan on test_distinct (actual rows=2000 loops=1)
               ->  BitmapOr (actual rows=2000 loops=1)
                     ->  Bitmap Index Scan on test_distinct_pkey (actual rows=1000 loops=1)
                           Index Cond: (r1 < 2)
                     ->  Bitmap Index Scan on test_distinct_pkey (actual rows=2000 loops=1)
                           Index Cond: (r2 < 3)
                     ->  Bitmap Index Scan on test_distinct_pkey (actual rows=2 loops=1)
                           Index Cond: (r3 < 2)
(12 rows)

 r1 | r2 
----+----
  1 |  0
  1 |  1
  1 |  2
  2 |  0
  2 |  1
  2 |  2
(6 rows)

SET yb_enable_distinct_pushdown TO false;
SET enable_bitmapscan = false;
\set hint1
\set query 'SELECT DISTINCT r1 FROM test_distinct WHERE r1 < 2 ORDER BY r1'
:explain1run1
                                      QUERY PLAN                                       
---------------------------------------------------------------------------------------
 Unique (actual rows=1 loops=1)
   ->  Index Scan using test_distinct_pkey on test_distinct (actual rows=1000 loops=1)
         Index Cond: (r1 < 2)
(3 rows)

 r1 
----
  1
(1 row)

\set query 'SELECT DISTINCT r1, r2 FROM test_distinct WHERE r1 < 2 OR r2 < 3 ORDER BY r1, r2'
:explain1run1
                            QUERY PLAN                            
------------------------------------------------------------------
 Sort (actual rows=6 loops=1)
   Sort Key: r1, r2
   Sort Method: quicksort
   ->  HashAggregate (actual rows=6 loops=1)
         Group Key: r1, r2
         ->  Seq Scan on test_distinct (actual rows=2000 loops=1)
               Storage Filter: ((r1 < 2) OR (r2 < 3))
(7 rows)

 r1 | r2 
----+----
  1 |  0
  1 |  1
  1 |  2
  2 |  0
  2 |  1
  2 |  2
(6 rows)

RESET enable_bitmapscan;
\set hint1 '/*+ BitmapScan(test_distinct) */'
\set query 'SELECT DISTINCT r1 FROM test_distinct WHERE r1 < 2 ORDER BY r1'
:explain1run1
                                      QUERY PLAN                                      
--------------------------------------------------------------------------------------
 Unique (actual rows=1 loops=1)
   ->  Sort (actual rows=1000 loops=1)
         Sort Key: r1
         Sort Method: quicksort
         ->  YB Bitmap Table Scan on test_distinct (actual rows=1000 loops=1)
               ->  Bitmap Index Scan on test_distinct_pkey (actual rows=1000 loops=1)
                     Index Cond: (r1 < 2)
(7 rows)

 r1 
----
  1
(1 row)

\set query 'SELECT DISTINCT r1, r2 FROM test_distinct WHERE r1 < 2 OR r2 < 3 ORDER BY r1, r2'
:explain1run1
                                         QUERY PLAN                                         
--------------------------------------------------------------------------------------------
 Unique (actual rows=6 loops=1)
   ->  Sort (actual rows=2000 loops=1)
         Sort Key: r1, r2
         Sort Method: quicksort
         ->  YB Bitmap Table Scan on test_distinct (actual rows=2000 loops=1)
               ->  BitmapOr (actual rows=2000 loops=1)
                     ->  Bitmap Index Scan on test_distinct_pkey (actual rows=1000 loops=1)
                           Index Cond: (r1 < 2)
                     ->  Bitmap Index Scan on test_distinct_pkey (actual rows=2000 loops=1)
                           Index Cond: (r2 < 3)
(10 rows)

 r1 | r2 
----+----
  1 |  0
  1 |  1
  1 |  2
  2 |  0
  2 |  1
  2 |  2
(6 rows)

RESET yb_enable_distinct_pushdown;
DROP TABLE test_distinct;
