CREATE TABLE p1 (k INT PRIMARY KEY);
CREATE TABLE p2 (k INT PRIMARY KEY);
CREATE TABLE t_test (k INT PRIMARY KEY,
					 p1_fk INT REFERENCES p1(k),
					 p2_fk INT REFERENCES p2(k) DEFERRABLE INITIALLY DEFERRED);
-- Load some data into each of the tables
INSERT INTO p1 (SELECT generate_series(1, 15));
INSERT INTO p2 (SELECT generate_series(1, 15));
-- Commit stats are not displayed by default
EXPLAIN (ANALYZE, DIST, COSTS OFF) INSERT INTO t_test VALUES (1, 1, 1);
                    QUERY PLAN                     
---------------------------------------------------
 Insert on t_test (actual rows=0 loops=1)
   ->  Result *RESULT* (actual rows=1 loops=1)
         Storage Table Write Requests: 1
         Storage Flush Requests: 1
 Trigger for constraint t_test_p1_fk_fkey: calls=1
 Storage Read Requests: 1
 Storage Read Ops: 1
 Storage Rows Scanned: 1
 Storage Write Requests: 1
 Storage Flush Requests: 1
(10 rows)

-- When enabled, commit stats should include read requests indicating the deferred foreign key check
EXPLAIN (ANALYZE, DIST, COMMIT, COSTS OFF) INSERT INTO t_test VALUES (2, 2, 2);
                    QUERY PLAN                     
---------------------------------------------------
 Insert on t_test (actual rows=0 loops=1)
   ->  Result *RESULT* (actual rows=1 loops=1)
         Storage Table Write Requests: 1
 Trigger for constraint t_test_p1_fk_fkey: calls=1
 Storage Read Requests: 1
 Storage Read Ops: 1
 Storage Rows Scanned: 1
 Storage Write Requests: 1
 Storage Flush Requests: 0
(9 rows)

       COMMIT STATS       
--------------------------
 Storage Read Requests: 1
 Storage Read Ops: 1
(2 rows)

-- Commit stats should not be shown if EXPLAIN is invoked within an explicit transaction
BEGIN;
EXPLAIN (ANALYZE, DIST, COMMIT, COSTS OFF) INSERT INTO t_test VALUES (3, 3, 3);
                    QUERY PLAN                     
---------------------------------------------------
 Insert on t_test (actual rows=0 loops=1)
   ->  Result *RESULT* (actual rows=1 loops=1)
         Storage Table Write Requests: 1
 Trigger for constraint t_test_p1_fk_fkey: calls=1
 Storage Read Requests: 1
 Storage Read Ops: 1
 Storage Rows Scanned: 1
 Storage Write Requests: 1
 Storage Flush Requests: 0
(9 rows)

ROLLBACK;
-- Commit stats should be displayed for the last statement in a multi-statement query
-- when autocommit is turned on. This is only applicable to the simple query protocol
-- which is used by the regress tests.
EXPLAIN (ANALYZE, DIST, COMMIT, COSTS OFF) INSERT INTO t_test VALUES (4, 4, 4) \; EXPLAIN (ANALYZE, DIST, COMMIT, COSTS OFF) INSERT INTO t_test VALUES (5, 5, 5);
                    QUERY PLAN                     
---------------------------------------------------
 Insert on t_test (actual rows=0 loops=1)
   ->  Result *RESULT* (actual rows=1 loops=1)
         Storage Table Write Requests: 1
 Trigger for constraint t_test_p1_fk_fkey: calls=1
 Storage Read Requests: 1
 Storage Read Ops: 1
 Storage Rows Scanned: 1
 Storage Write Requests: 1
 Storage Flush Requests: 0
(9 rows)

                    QUERY PLAN                     
---------------------------------------------------
 Insert on t_test (actual rows=0 loops=1)
   ->  Result *RESULT* (actual rows=1 loops=1)
         Storage Table Write Requests: 1
 Trigger for constraint t_test_p1_fk_fkey: calls=1
 Storage Read Requests: 1
 Storage Read Ops: 1
 Storage Rows Scanned: 1
 Storage Write Requests: 1
 Storage Flush Requests: 0
(9 rows)

       COMMIT STATS       
--------------------------
 Storage Read Requests: 1
 Storage Read Ops: 2
(2 rows)

\set AUTOCOMMIT OFF
-- However, when autocommit is turned off, commit stats should not be displayed as nothing is committed.
EXPLAIN (ANALYZE, DIST, COMMIT, COSTS OFF) INSERT INTO t_test VALUES (6, 6, 6) \; EXPLAIN (ANALYZE, DIST, COMMIT, COSTS OFF) INSERT INTO t_test VALUES (7, 7, 7);
                    QUERY PLAN                     
---------------------------------------------------
 Insert on t_test (actual rows=0 loops=1)
   ->  Result *RESULT* (actual rows=1 loops=1)
         Storage Table Write Requests: 1
 Trigger for constraint t_test_p1_fk_fkey: calls=1
 Storage Read Requests: 1
 Storage Read Ops: 1
 Storage Rows Scanned: 1
 Storage Write Requests: 1
 Storage Flush Requests: 0
(9 rows)

                    QUERY PLAN                     
---------------------------------------------------
 Insert on t_test (actual rows=0 loops=1)
   ->  Result *RESULT* (actual rows=1 loops=1)
         Storage Table Write Requests: 1
 Trigger for constraint t_test_p1_fk_fkey: calls=1
 Storage Read Requests: 1
 Storage Read Ops: 1
 Storage Rows Scanned: 1
 Storage Write Requests: 1
 Storage Flush Requests: 0
(9 rows)

ROLLBACK;
\set AUTOCOMMIT ON
-- Commit stats should not be displayed if there is nothing to display.
EXPLAIN (ANALYZE, DIST, COMMIT, COSTS OFF) INSERT INTO p1 VALUES (101);
                  QUERY PLAN                   
-----------------------------------------------
 Insert on p1 (actual rows=0 loops=1)
   ->  Result *RESULT* (actual rows=1 loops=1)
         Storage Table Write Requests: 1
 Storage Read Requests: 0
 Storage Read Ops: 0
 Storage Rows Scanned: 0
 Storage Write Requests: 1
 Storage Flush Requests: 1
(8 rows)

-- Commit stats should respect the other options provided to EXPLAIN. No commit stats should be
-- displayed for any of the following queries.
EXPLAIN (COSTS OFF) INSERT INTO t_test VALUES (8, 8, 8);
      QUERY PLAN       
-----------------------
 Insert on t_test
   ->  Result *RESULT*
(2 rows)

EXPLAIN (COMMIT, COSTS OFF) INSERT INTO t_test VALUES (8, 8, 8);
ERROR:  EXPLAIN option COMMIT requires ANALYZE
EXPLAIN (ANALYZE, COMMIT, COSTS OFF) INSERT INTO t_test VALUES (9, 9, 9);
                    QUERY PLAN                     
---------------------------------------------------
 Insert on t_test (actual rows=0 loops=1)
   ->  Result *RESULT* (actual rows=1 loops=1)
 Trigger for constraint t_test_p1_fk_fkey: calls=1
(3 rows)

EXPLAIN (ANALYZE, DIST, COMMIT, SUMMARY OFF, COSTS OFF) INSERT INTO t_test VALUES (10, 10, 10);
                    QUERY PLAN                     
---------------------------------------------------
 Insert on t_test (actual rows=0 loops=1)
   ->  Result *RESULT* (actual rows=1 loops=1)
         Storage Table Write Requests: 1
 Trigger for constraint t_test_p1_fk_fkey: calls=1
(4 rows)

-- Commit stats should also respect the format option.
EXPLAIN (ANALYZE, DIST, COMMIT, COSTS OFF, FORMAT JSON) INSERT INTO t_test VALUES (11, 11, 11);
                       QUERY PLAN                        
---------------------------------------------------------
 [                                                      +
   {                                                    +
     "Plan": {                                          +
       "Node Type": "ModifyTable",                      +
       "Operation": "Insert",                           +
       "Parallel Aware": false,                         +
       "Async Capable": false,                          +
       "Relation Name": "t_test",                       +
       "Alias": "t_test",                               +
       "Actual Rows": 0,                                +
       "Actual Loops": 1,                               +
       "Plans": [                                       +
         {                                              +
           "Node Type": "Result *RESULT*",              +
           "Parent Relationship": "Outer",              +
           "Parallel Aware": false,                     +
           "Async Capable": false,                      +
           "Actual Rows": 1,                            +
           "Actual Loops": 1,                           +
           "Storage Table Write Requests": 1            +
         }                                              +
       ]                                                +
     },                                                 +
     "Triggers": [                                      +
       {                                                +
         "Trigger Name": "RI_ConstraintTrigger_c_16402",+
         "Constraint Name": "t_test_p1_fk_fkey",        +
         "Relation": "t_test",                          +
         "Calls": 1                                     +
       }                                                +
     ],                                                 +
     "Storage Read Requests": 1,                        +
     "Storage Read Ops": 1,                             +
     "Storage Rows Scanned": 1,                         +
     "Storage Write Requests": 1,                       +
     "Storage Flush Requests": 0                        +
   }                                                    +
 ]
(1 row)

          COMMIT STATS           
---------------------------------
 [                              +
   {                            +
     "Storage Read Requests": 1,+
     "Storage Read Ops": 1      +
   }                            +
 ]
(1 row)

SELECT * FROM t_test ORDER BY k;
 k  | p1_fk | p2_fk 
----+-------+-------
  1 |     1 |     1
  2 |     2 |     2
  4 |     4 |     4
  5 |     5 |     5
  9 |     9 |     9
 10 |    10 |    10
 11 |    11 |    11
(7 rows)

