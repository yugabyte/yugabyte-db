-- Testing IN queries on hash keys
set yb_enable_hash_batch_in = false;
CREATE TABLE test_method (h1 int, a int, b int, c int, d int, e int, PRIMARY KEY (h1 HASH));
INSERT INTO test_method VALUES (1, 1, 1, 1, 1, 11), (2, 1, 1, 2, 2, 12), (19, 1, 2, 1, 3, 13), (3, 1, 2, 2, 4, 14), (4, 2, 1, 1, 5, 15), (5, 2, 1, 2, 6, 16), (6, 2, 2, 1, 7, 17), (7, 2, 2, 2, 8, 18), (8, 2, 999, 2, 8, 18), (9, 0, 1, 1, 9, 19), (10, 1, 1, 2, 10, 20), (11, 3, 1, 1, 1, 11), (12, 3, 1, 2, 2, 12), (13, 3, 2, 1, 3, 13), (14, 3, 2, 2, 4, 14), (15, 4, 1, 1, 1, 11), (16, 4, 1, 2, 2, 12), (17, 4, 2, 1, 3, 13), (18, 4, 2, 2, 4, 14);
SELECT * FROM test_method where h1 = 1;
 h1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

SELECT * FROM test_method where h1 = 1 AND a = 1;
 h1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

SELECT * FROM test_method where h1 = 1 AND b = 2;
 h1 | a | b | c | d | e 
----+---+---+---+---+---
(0 rows)

SELECT * FROM test_method where h1 = 2 AND a = 1 AND b = 1;
 h1 | a | b | c | d | e  
----+---+---+---+---+----
  2 | 1 | 1 | 2 | 2 | 12
(1 row)

SELECT * FROM test_method where h1 = 1 AND a IN (1, 2, 3, 4);
 h1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

SELECT * FROM test_method where h1 = 1 AND a IN (1, 2, 3, 4) AND b IN (1, 2, 3, 4);
 h1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4);
                                QUERY PLAN                                
--------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=4 loops=1)
   Index Cond: (h1 = ANY ('{1,2,3,4}'::integer[]))
   Storage Table Read Requests: 4
   Storage Table Read Ops: 4
   Storage Table Rows Scanned: 4
(5 rows)

SELECT * FROM test_method where h1 IN (1, 2, 3, 4);
 h1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
  2 | 1 | 1 | 2 | 2 | 12
  3 | 1 | 2 | 2 | 4 | 14
  4 | 2 | 1 | 1 | 5 | 15
(4 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND a = 1;
                                QUERY PLAN                                
--------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=3 loops=1)
   Index Cond: (h1 = ANY ('{1,2,3,4}'::integer[]))
   Storage Filter: (a = 1)
   Storage Table Read Requests: 4
   Storage Table Read Ops: 4
   Storage Table Rows Scanned: 4
(6 rows)

SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND a = 1;
 h1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
  2 | 1 | 1 | 2 | 2 | 12
  3 | 1 | 2 | 2 | 4 | 14
(3 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND yb_hash_code(h1) < 8192;
                                    QUERY PLAN                                     
-----------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=1 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (yb_hash_code(h1) < 8192))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
   Storage Table Rows Scanned: 1
(5 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND a = 1 AND yb_hash_code(h1) < 8192;
                                    QUERY PLAN                                     
-----------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=1 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (yb_hash_code(h1) < 8192))
   Storage Filter: (a = 1)
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
   Storage Table Rows Scanned: 1
(6 rows)

set yb_enable_hash_batch_in = true;
SELECT * FROM test_method where h1 = 1;
 h1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

SELECT * FROM test_method where h1 = 1 AND a = 1;
 h1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

SELECT * FROM test_method where h1 = 1 AND b = 2;
 h1 | a | b | c | d | e 
----+---+---+---+---+---
(0 rows)

SELECT * FROM test_method where h1 = 2 AND a = 1 AND b = 1;
 h1 | a | b | c | d | e  
----+---+---+---+---+----
  2 | 1 | 1 | 2 | 2 | 12
(1 row)

SELECT * FROM test_method where h1 = 1 AND a IN (1, 2, 3, 4);
 h1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

SELECT * FROM test_method where h1 = 1 AND a IN (1, 2, 3, 4) AND b IN (1, 2, 3, 4);
 h1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4);
                                QUERY PLAN                                
--------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=4 loops=1)
   Index Cond: (h1 = ANY ('{1,2,3,4}'::integer[]))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 3
   Storage Table Rows Scanned: 4
(5 rows)

SELECT * FROM test_method where h1 IN (1, 2, 3, 4);
 h1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
  2 | 1 | 1 | 2 | 2 | 12
  3 | 1 | 2 | 2 | 4 | 14
  4 | 2 | 1 | 1 | 5 | 15
(4 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND a = 1;
                                QUERY PLAN                                
--------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=3 loops=1)
   Index Cond: (h1 = ANY ('{1,2,3,4}'::integer[]))
   Storage Filter: (a = 1)
   Storage Table Read Requests: 1
   Storage Table Read Ops: 3
   Storage Table Rows Scanned: 4
(6 rows)

SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND a = 1;
 h1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
  2 | 1 | 1 | 2 | 2 | 12
  3 | 1 | 2 | 2 | 4 | 14
(3 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND yb_hash_code(h1) < 8192;
                                    QUERY PLAN                                     
-----------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=1 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (yb_hash_code(h1) < 8192))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
   Storage Table Rows Scanned: 1
(5 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND a = 1 AND yb_hash_code(h1) < 8192;
                                    QUERY PLAN                                     
-----------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=1 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (yb_hash_code(h1) < 8192))
   Storage Filter: (a = 1)
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
   Storage Table Rows Scanned: 1
(6 rows)

DROP TABLE test_method;
-- Testing IN queries on range keys
set yb_enable_hash_batch_in = false;
CREATE TABLE test_method (r1 int, a int, b int, c int, d int, e int, PRIMARY KEY (r1 ASC));
INSERT INTO test_method VALUES (1, 1, 1, 1, 1, 11), (2, 1, 1, 2, 2, 12), (19, 1, 2, 1, 3, 13), (3, 1, 2, 2, 4, 14), (4, 2, 1, 1, 5, 15), (5, 2, 1, 2, 6, 16), (6, 2, 2, 1, 7, 17), (7, 2, 2, 2, 8, 18), (8, 2, 999, 2, 8, 18), (9, 0, 1, 1, 9, 19), (10, 1, 1, 2, 10, 20), (11, 3, 1, 1, 1, 11), (12, 3, 1, 2, 2, 12), (13, 3, 2, 1, 3, 13), (14, 3, 2, 2, 4, 14), (15, 4, 1, 1, 1, 11), (16, 4, 1, 2, 2, 12), (17, 4, 2, 1, 3, 13), (18, 4, 2, 2, 4, 14);
SELECT * FROM test_method where r1 = 1;
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

SELECT * FROM test_method where r1 = 1 AND a = 1;
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

SELECT * FROM test_method where r1 = 1 AND b = 2;
 r1 | a | b | c | d | e 
----+---+---+---+---+---
(0 rows)

SELECT * FROM test_method where r1 = 2 AND a = 1 AND b = 1;
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  2 | 1 | 1 | 2 | 2 | 12
(1 row)

SELECT * FROM test_method where r1 = 1 AND a IN (1, 2, 3, 4);
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

SELECT * FROM test_method where r1 = 1 AND a IN (1, 2, 3, 4) AND b IN (1, 2, 3, 4);
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4);
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
  2 | 1 | 1 | 2 | 2 | 12
  3 | 1 | 2 | 2 | 4 | 14
  4 | 2 | 1 | 1 | 5 | 15
(4 rows)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND a = 1;
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
  2 | 1 | 1 | 2 | 2 | 12
  3 | 1 | 2 | 2 | 4 | 14
(3 rows)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND b = 2;
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  3 | 1 | 2 | 2 | 4 | 14
(1 row)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND a = 1 AND b = 1;
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
  2 | 1 | 1 | 2 | 2 | 12
(2 rows)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND a IN (1, 2, 3, 4);
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
  2 | 1 | 1 | 2 | 2 | 12
  3 | 1 | 2 | 2 | 4 | 14
  4 | 2 | 1 | 1 | 5 | 15
(4 rows)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND a IN (1, 2, 3, 4) AND b IN (1, 2, 3, 4);
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
  2 | 1 | 1 | 2 | 2 | 12
  3 | 1 | 2 | 2 | 4 | 14
  4 | 2 | 1 | 1 | 5 | 15
(4 rows)

set yb_enable_hash_batch_in = true;
SELECT * FROM test_method where r1 = 1;
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

SELECT * FROM test_method where r1 = 1 AND a = 1;
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

SELECT * FROM test_method where r1 = 1 AND b = 2;
 r1 | a | b | c | d | e 
----+---+---+---+---+---
(0 rows)

SELECT * FROM test_method where r1 = 2 AND a = 1 AND b = 1;
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  2 | 1 | 1 | 2 | 2 | 12
(1 row)

SELECT * FROM test_method where r1 = 1 AND a IN (1, 2, 3, 4);
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

SELECT * FROM test_method where r1 = 1 AND a IN (1, 2, 3, 4) AND b IN (1, 2, 3, 4);
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
(1 row)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4);
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
  2 | 1 | 1 | 2 | 2 | 12
  3 | 1 | 2 | 2 | 4 | 14
  4 | 2 | 1 | 1 | 5 | 15
(4 rows)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND a = 1;
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
  2 | 1 | 1 | 2 | 2 | 12
  3 | 1 | 2 | 2 | 4 | 14
(3 rows)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND b = 2;
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  3 | 1 | 2 | 2 | 4 | 14
(1 row)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND a = 1 AND b = 1;
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
  2 | 1 | 1 | 2 | 2 | 12
(2 rows)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND a IN (1, 2, 3, 4);
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
  2 | 1 | 1 | 2 | 2 | 12
  3 | 1 | 2 | 2 | 4 | 14
  4 | 2 | 1 | 1 | 5 | 15
(4 rows)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND a IN (1, 2, 3, 4) AND b IN (1, 2, 3, 4);
 r1 | a | b | c | d | e  
----+---+---+---+---+----
  1 | 1 | 1 | 1 | 1 | 11
  2 | 1 | 1 | 2 | 2 | 12
  3 | 1 | 2 | 2 | 4 | 14
  4 | 2 | 1 | 1 | 5 | 15
(4 rows)

DROP TABLE test_method;
-- Testing IN queries on multi column hash keys
CREATE TABLE test_method (h1 int, h2 int, a int, b int, v1 int, v2 int, PRIMARY KEY ((h1, h2) HASH));
INSERT INTO test_method VALUES (1, 1, 1, 1, 1, 11), (2, 1, 1, 2, 2, 12), (19, 1, 2, 1, 3, 13), (3, 1, 2, 2, 4, 14), (4, 2, 1, 1, 5, 15), (5, 2, 1, 2, 6, 16), (6, 2, 2, 1, 7, 17), (7, 2, 2, 2, 8, 18), (8, 2, 999, 2, 8, 18);
INSERT INTO test_method VALUES (9, 0, 1, 1, 9, 19), (10, 1, 1, 2, 10, 20), (11, 3, 1, 1, 1, 11), (12, 3, 1, 2, 2, 12),   (13, 3, 2, 1, 3, 13), (14, 3, 2, 2, 4, 14), (15, 4, 1, 1, 1, 11), (16, 4, 1, 2, 2, 12), (17, 4, 2, 1, 3, 13), (18, 4, 2, 2, 4, 14);
set yb_enable_hash_batch_in = false;
SELECT * FROM test_method where h1 = 1 ;
 h1 | h2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
(1 row)

SELECT * FROM test_method where h1 = 1 AND h2 = 2;
 h1 | h2 | a | b | v1 | v2 
----+----+---+---+----+----
(0 rows)

SELECT * FROM test_method where h1 = 1 AND h2 = 2 AND a = 1;
 h1 | h2 | a | b | v1 | v2 
----+----+---+---+----+----
(0 rows)

SELECT * FROM test_method where h1 = 1 AND h2 = 2 AND a = 1 AND b = 2;
 h1 | h2 | a | b | v1 | v2 
----+----+---+---+----+----
(0 rows)

SELECT * FROM test_method where h1 = 1 AND h2 = 1 AND a IN (1, 2, 3, 4) AND b IN (1, 2, 3, 4);
 h1 | h2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
(1 row)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2);
                                       QUERY PLAN                                        
-----------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=4 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (h2 = ANY ('{1,2}'::integer[])))
   Storage Table Read Requests: 8
   Storage Table Read Ops: 8
   Storage Table Rows Scanned: 4
(5 rows)

SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2);
 h1 | h2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
  2 |  1 | 1 | 2 |  2 | 12
  3 |  1 | 2 | 2 |  4 | 14
  4 |  2 | 1 | 1 |  5 | 15
(4 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND yb_hash_code(h1, h2) < 8192;
                                                        QUERY PLAN                                                         
---------------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=0 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (yb_hash_code(h1, h2) < 8192) AND (h2 = ANY ('{1,2}'::integer[])))
(2 rows)

set yb_enable_hash_batch_in = true;
SELECT * FROM test_method where h1 = 1 ;
 h1 | h2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
(1 row)

SELECT * FROM test_method where h1 = 1 AND h2 = 2;
 h1 | h2 | a | b | v1 | v2 
----+----+---+---+----+----
(0 rows)

SELECT * FROM test_method where h1 = 1 AND h2 = 2 AND a = 1;
 h1 | h2 | a | b | v1 | v2 
----+----+---+---+----+----
(0 rows)

SELECT * FROM test_method where h1 = 1 AND h2 = 2 AND a = 1 AND b = 2;
 h1 | h2 | a | b | v1 | v2 
----+----+---+---+----+----
(0 rows)

SELECT * FROM test_method where h1 = 1 AND h2 = 1 AND a IN (1, 2, 3, 4) AND b IN (1, 2, 3, 4);
 h1 | h2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
(1 row)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2);
                                       QUERY PLAN                                        
-----------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=4 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (h2 = ANY ('{1,2}'::integer[])))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 2
   Storage Table Rows Scanned: 4
(5 rows)

SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2);
 h1 | h2 | a | b | v1 | v2 
----+----+---+---+----+----
  3 |  1 | 2 | 2 |  4 | 14
  2 |  1 | 1 | 2 |  2 | 12
  1 |  1 | 1 | 1 |  1 | 11
  4 |  2 | 1 | 1 |  5 | 15
(4 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND yb_hash_code(h1, h2) < 8192;
                                                        QUERY PLAN                                                         
---------------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=0 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (yb_hash_code(h1, h2) < 8192) AND (h2 = ANY ('{1,2}'::integer[])))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
(4 rows)

DROP TABLE test_method;
-- Testing IN queries on multi column range keys
CREATE TABLE test_method (r1 int, r2 int, a int, b int, v1 int, v2 int, PRIMARY KEY (r1 ASC, r2 ASC));
INSERT INTO test_method VALUES (1, 1, 1, 1, 1, 11), (2, 1, 1, 2, 2, 12), (19, 1, 2, 1, 3, 13), (3, 1, 2, 2, 4, 14), (4, 2, 1, 1, 5, 15), (5, 2, 1, 2, 6, 16), (6, 2, 2, 1, 7, 17), (7, 2, 2, 2, 8, 18), (8, 2, 999, 2, 8, 18);
INSERT INTO test_method VALUES (9, 0, 1, 1, 9, 19), (10, 1, 1, 2, 10, 20), (11, 3, 1, 1, 1, 11), (12, 3, 1, 2, 2, 12),   (13, 3, 2, 1, 3, 13), (14, 3, 2, 2, 4, 14), (15, 4, 1, 1, 1, 11), (16, 4, 1, 2, 2, 12), (17, 4, 2, 1, 3, 13), (18, 4, 2, 2, 4, 14);
set yb_enable_hash_batch_in = false;
SELECT * FROM test_method where r1 = 1 ;
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
(1 row)

SELECT * FROM test_method where r1 = 1 AND r2 = 2;
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
(0 rows)

SELECT * FROM test_method where r1 = 1 AND r2 = 2 AND a = 1;
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
(0 rows)

SELECT * FROM test_method where r1 = 1 AND r2 = 2 AND a = 1 AND b = 2;
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
(0 rows)

SELECT * FROM test_method where r1 = 1 AND r2 = 1 AND a IN (1, 2, 3, 4) AND b IN (1, 2, 3, 4);
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
(1 row)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND r2 IN (1, 2);
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
  2 |  1 | 1 | 2 |  2 | 12
  3 |  1 | 2 | 2 |  4 | 14
  4 |  2 | 1 | 1 |  5 | 15
(4 rows)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND r2 IN (1, 2) AND a = 1;
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
  2 |  1 | 1 | 2 |  2 | 12
  4 |  2 | 1 | 1 |  5 | 15
(3 rows)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND r2 IN (1, 2) AND a = 1 AND b = 2;
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
  2 |  1 | 1 | 2 |  2 | 12
(1 row)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND r2 IN (1, 2) AND a IN (1, 2, 3, 4) AND b IN (1, 2, 3, 4);
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
  2 |  1 | 1 | 2 |  2 | 12
  3 |  1 | 2 | 2 |  4 | 14
  4 |  2 | 1 | 1 |  5 | 15
(4 rows)

set yb_enable_hash_batch_in = true;
SELECT * FROM test_method where r1 = 1 ;
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
(1 row)

SELECT * FROM test_method where r1 = 1 AND r2 = 2;
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
(0 rows)

SELECT * FROM test_method where r1 = 1 AND r2 = 2 AND a = 1;
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
(0 rows)

SELECT * FROM test_method where r1 = 1 AND r2 = 2 AND a = 1 AND b = 2;
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
(0 rows)

SELECT * FROM test_method where r1 = 1 AND r2 = 1 AND a IN (1, 2, 3, 4) AND b IN (1, 2, 3, 4);
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
(1 row)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND r2 IN (1, 2);
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
  2 |  1 | 1 | 2 |  2 | 12
  3 |  1 | 2 | 2 |  4 | 14
  4 |  2 | 1 | 1 |  5 | 15
(4 rows)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND r2 IN (1, 2) AND a = 1;
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
  2 |  1 | 1 | 2 |  2 | 12
  4 |  2 | 1 | 1 |  5 | 15
(3 rows)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND r2 IN (1, 2) AND a = 1 AND b = 2;
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
  2 |  1 | 1 | 2 |  2 | 12
(1 row)

SELECT * FROM test_method where r1 IN (1, 2, 3, 4) AND r2 IN (1, 2) AND a IN (1, 2, 3, 4) AND b IN (1, 2, 3, 4);
 r1 | r2 | a | b | v1 | v2 
----+----+---+---+----+----
  1 |  1 | 1 | 1 |  1 | 11
  2 |  1 | 1 | 2 |  2 | 12
  3 |  1 | 2 | 2 |  4 | 14
  4 |  2 | 1 | 1 |  5 | 15
(4 rows)

DROP TABLE test_method;
-- Testing IN queries on multi column hash and range keys
CREATE TABLE test_method (h1 int, h2 int, r1 int, r2 int, v1 int, v2 int, PRIMARY KEY ((h1, h2) HASH, r1, r2));
INSERT INTO test_method VALUES (1, 1, 1, 1, 1, 11), (1, 1, 1, 2, 2, 12), (1, 1, 2, 1, 3, 13), (1, 1, 2, 2, 4, 14), (1, 2, 1, 1, 5, 15), (1, 2, 1, 2, 6, 16), (1, 2, 2, 1, 7, 17), (1, 2, 2, 2, 8, 18), (1, 2, 999, 2, 8, 18);
INSERT INTO test_method VALUES (2, 0, 1, 1, 9, 19), (2, 1, 1, 2, 10, 20), (1, 3, 1, 1, 1, 11), (1, 3, 1, 2, 2, 12), (1, 3, 2, 1, 3, 13), (1, 3, 2, 2, 4, 14), (1, 4, 1, 1, 1, 11), (1, 4, 1, 2, 2, 12), (1, 4, 2, 1, 3, 13), (1, 4, 2, 2, 4, 14);
set yb_enable_hash_batch_in = false;
EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 = 1 ;
                    QUERY PLAN                    
--------------------------------------------------
 Seq Scan on test_method (actual rows=17 loops=1)
   Storage Filter: (h1 = 1)
   Storage Table Read Requests: 1
   Storage Table Read Ops: 3
   Storage Table Rows Scanned: 19
(5 rows)

SELECT * FROM test_method where h1 = 1 ;
 h1 | h2 | r1  | r2 | v1 | v2 
----+----+-----+----+----+----
  1 |  1 |   1 |  1 |  1 | 11
  1 |  1 |   1 |  2 |  2 | 12
  1 |  1 |   2 |  1 |  3 | 13
  1 |  1 |   2 |  2 |  4 | 14
  1 |  2 |   1 |  1 |  5 | 15
  1 |  2 |   1 |  2 |  6 | 16
  1 |  2 |   2 |  1 |  7 | 17
  1 |  2 |   2 |  2 |  8 | 18
  1 |  2 | 999 |  2 |  8 | 18
  1 |  4 |   1 |  1 |  1 | 11
  1 |  4 |   1 |  2 |  2 | 12
  1 |  4 |   2 |  1 |  3 | 13
  1 |  4 |   2 |  2 |  4 | 14
  1 |  3 |   1 |  1 |  1 | 11
  1 |  3 |   1 |  2 |  2 | 12
  1 |  3 |   2 |  1 |  3 | 13
  1 |  3 |   2 |  2 |  4 | 14
(17 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 = 1 AND h2 = 2;
                                QUERY PLAN                                
--------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=5 loops=1)
   Index Cond: ((h1 = 1) AND (h2 = 2))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
   Storage Table Rows Scanned: 5
(5 rows)

SELECT * FROM test_method where h1 = 1 AND h2 = 2;
 h1 | h2 | r1  | r2 | v1 | v2 
----+----+-----+----+----+----
  1 |  2 |   1 |  1 |  5 | 15
  1 |  2 |   1 |  2 |  6 | 16
  1 |  2 |   2 |  1 |  7 | 17
  1 |  2 |   2 |  2 |  8 | 18
  1 |  2 | 999 |  2 |  8 | 18
(5 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 = 1 AND h2 = 2 AND r1 = 1;
                                QUERY PLAN                                
--------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=2 loops=1)
   Index Cond: ((h1 = 1) AND (h2 = 2) AND (r1 = 1))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
   Storage Table Rows Scanned: 2
(5 rows)

SELECT * FROM test_method where h1 = 1 AND h2 = 2 AND r1 = 1;
 h1 | h2 | r1 | r2 | v1 | v2 
----+----+----+----+----+----
  1 |  2 |  1 |  1 |  5 | 15
  1 |  2 |  1 |  2 |  6 | 16
(2 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 = 1 AND h2 = 2 AND r1 = 1 AND r2 = 2;
                                QUERY PLAN                                
--------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=1 loops=1)
   Index Cond: ((h1 = 1) AND (h2 = 2) AND (r1 = 1) AND (r2 = 2))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
   Storage Table Rows Scanned: 1
(5 rows)

SELECT * FROM test_method where h1 = 1 AND h2 = 2 AND r1 = 1 AND r2 = 2;
 h1 | h2 | r1 | r2 | v1 | v2 
----+----+----+----+----+----
  1 |  2 |  1 |  2 |  6 | 16
(1 row)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 = 1 AND h2 = 1 AND r1 IN (1, 2, 3, 4) AND r2 IN (1, 2, 3, 4);
                                                      QUERY PLAN                                                       
-----------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=4 loops=1)
   Index Cond: ((h1 = 1) AND (h2 = 1) AND (r1 = ANY ('{1,2,3,4}'::integer[])) AND (r2 = ANY ('{1,2,3,4}'::integer[])))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
   Storage Table Rows Scanned: 4
(5 rows)

SELECT * FROM test_method where h1 = 1 AND h2 = 1 AND r1 IN (1, 2, 3, 4) AND r2 IN (1, 2, 3, 4);
 h1 | h2 | r1 | r2 | v1 | v2 
----+----+----+----+----+----
  1 |  1 |  1 |  1 |  1 | 11
  1 |  1 |  1 |  2 |  2 | 12
  1 |  1 |  2 |  1 |  3 | 13
  1 |  1 |  2 |  2 |  4 | 14
(4 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2);
                                       QUERY PLAN                                        
-----------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=10 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (h2 = ANY ('{1,2}'::integer[])))
   Storage Table Read Requests: 8
   Storage Table Read Ops: 8
   Storage Table Rows Scanned: 10
(5 rows)

SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2);
 h1 | h2 | r1  | r2 | v1 | v2 
----+----+-----+----+----+----
  1 |  1 |   1 |  1 |  1 | 11
  1 |  1 |   1 |  2 |  2 | 12
  1 |  1 |   2 |  1 |  3 | 13
  1 |  1 |   2 |  2 |  4 | 14
  2 |  1 |   1 |  2 | 10 | 20
  1 |  2 |   1 |  1 |  5 | 15
  1 |  2 |   1 |  2 |  6 | 16
  1 |  2 |   2 |  1 |  7 | 17
  1 |  2 |   2 |  2 |  8 | 18
  1 |  2 | 999 |  2 |  8 | 18
(10 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 = 1;
                                              QUERY PLAN                                              
------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=5 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (h2 = ANY ('{1,2}'::integer[])) AND (r1 = 1))
   Storage Table Read Requests: 8
   Storage Table Read Ops: 8
   Storage Table Rows Scanned: 5
(5 rows)

SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 = 1;
 h1 | h2 | r1 | r2 | v1 | v2 
----+----+----+----+----+----
  1 |  1 |  1 |  1 |  1 | 11
  1 |  1 |  1 |  2 |  2 | 12
  2 |  1 |  1 |  2 | 10 | 20
  1 |  2 |  1 |  1 |  5 | 15
  1 |  2 |  1 |  2 |  6 | 16
(5 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 = 1 AND r2 = 2;
                                                    QUERY PLAN                                                     
-------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=3 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (h2 = ANY ('{1,2}'::integer[])) AND (r1 = 1) AND (r2 = 2))
   Storage Table Read Requests: 8
   Storage Table Read Ops: 8
   Storage Table Rows Scanned: 3
(5 rows)

SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 = 1 AND r2 = 2;
 h1 | h2 | r1 | r2 | v1 | v2 
----+----+----+----+----+----
  1 |  1 |  1 |  2 |  2 | 12
  2 |  1 |  1 |  2 | 10 | 20
  1 |  2 |  1 |  2 |  6 | 16
(3 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 IN (1, 2, 3, 4) AND r2 IN (1, 2, 3, 4);
                                                                               QUERY PLAN                                                                                
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=9 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (h2 = ANY ('{1,2}'::integer[])) AND (r1 = ANY ('{1,2,3,4}'::integer[])) AND (r2 = ANY ('{1,2,3,4}'::integer[])))
   Storage Table Read Requests: 8
   Storage Table Read Ops: 8
   Storage Table Rows Scanned: 9
(5 rows)

SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 IN (1, 2, 3, 4) AND r2 IN (1, 2, 3, 4);
 h1 | h2 | r1 | r2 | v1 | v2 
----+----+----+----+----+----
  1 |  1 |  1 |  1 |  1 | 11
  1 |  1 |  1 |  2 |  2 | 12
  1 |  1 |  2 |  1 |  3 | 13
  1 |  1 |  2 |  2 |  4 | 14
  2 |  1 |  1 |  2 | 10 | 20
  1 |  2 |  1 |  1 |  5 | 15
  1 |  2 |  1 |  2 |  6 | 16
  1 |  2 |  2 |  1 |  7 | 17
  1 |  2 |  2 |  2 |  8 | 18
(9 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND yb_hash_code(h1, h2) < 8192;
                                                        QUERY PLAN                                                         
---------------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=0 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (yb_hash_code(h1, h2) < 8192) AND (h2 = ANY ('{1,2}'::integer[])))
(2 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 = 1 AND yb_hash_code(h1, h2) < 8192;
                                                               QUERY PLAN                                                               
----------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=0 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (yb_hash_code(h1, h2) < 8192) AND (h2 = ANY ('{1,2}'::integer[])) AND (r1 = 1))
(2 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 = 1 AND r2 = 2 AND yb_hash_code(h1, h2) < 8192;
                                                                     QUERY PLAN                                                                      
-----------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=0 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (yb_hash_code(h1, h2) < 8192) AND (h2 = ANY ('{1,2}'::integer[])) AND (r1 = 1) AND (r2 = 2))
(2 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 IN (1, 2, 3, 4) AND r2 IN (1, 2, 3, 4) AND yb_hash_code(h1, h2) < 8192;
                                                                                                QUERY PLAN                                                                                                 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=0 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (yb_hash_code(h1, h2) < 8192) AND (h2 = ANY ('{1,2}'::integer[])) AND (r1 = ANY ('{1,2,3,4}'::integer[])) AND (r2 = ANY ('{1,2,3,4}'::integer[])))
(2 rows)

set yb_enable_hash_batch_in = true;
EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 = 1 ;
                    QUERY PLAN                    
--------------------------------------------------
 Seq Scan on test_method (actual rows=17 loops=1)
   Storage Filter: (h1 = 1)
   Storage Table Read Requests: 1
   Storage Table Read Ops: 3
   Storage Table Rows Scanned: 19
(5 rows)

SELECT * FROM test_method where h1 = 1 ;
 h1 | h2 | r1  | r2 | v1 | v2 
----+----+-----+----+----+----
  1 |  1 |   1 |  1 |  1 | 11
  1 |  1 |   1 |  2 |  2 | 12
  1 |  1 |   2 |  1 |  3 | 13
  1 |  1 |   2 |  2 |  4 | 14
  1 |  2 |   1 |  1 |  5 | 15
  1 |  2 |   1 |  2 |  6 | 16
  1 |  2 |   2 |  1 |  7 | 17
  1 |  2 |   2 |  2 |  8 | 18
  1 |  2 | 999 |  2 |  8 | 18
  1 |  4 |   1 |  1 |  1 | 11
  1 |  4 |   1 |  2 |  2 | 12
  1 |  4 |   2 |  1 |  3 | 13
  1 |  4 |   2 |  2 |  4 | 14
  1 |  3 |   1 |  1 |  1 | 11
  1 |  3 |   1 |  2 |  2 | 12
  1 |  3 |   2 |  1 |  3 | 13
  1 |  3 |   2 |  2 |  4 | 14
(17 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 = 1 AND h2 = 2;
                                QUERY PLAN                                
--------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=5 loops=1)
   Index Cond: ((h1 = 1) AND (h2 = 2))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
   Storage Table Rows Scanned: 5
(5 rows)

SELECT * FROM test_method where h1 = 1 AND h2 = 2;
 h1 | h2 | r1  | r2 | v1 | v2 
----+----+-----+----+----+----
  1 |  2 |   1 |  1 |  5 | 15
  1 |  2 |   1 |  2 |  6 | 16
  1 |  2 |   2 |  1 |  7 | 17
  1 |  2 |   2 |  2 |  8 | 18
  1 |  2 | 999 |  2 |  8 | 18
(5 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 = 1 AND h2 = 2 AND r1 = 1;
                                QUERY PLAN                                
--------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=2 loops=1)
   Index Cond: ((h1 = 1) AND (h2 = 2) AND (r1 = 1))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
   Storage Table Rows Scanned: 2
(5 rows)

SELECT * FROM test_method where h1 = 1 AND h2 = 2 AND r1 = 1;
 h1 | h2 | r1 | r2 | v1 | v2 
----+----+----+----+----+----
  1 |  2 |  1 |  1 |  5 | 15
  1 |  2 |  1 |  2 |  6 | 16
(2 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 = 1 AND h2 = 2 AND r1 = 1 AND r2 = 2;
                                QUERY PLAN                                
--------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=1 loops=1)
   Index Cond: ((h1 = 1) AND (h2 = 2) AND (r1 = 1) AND (r2 = 2))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
   Storage Table Rows Scanned: 1
(5 rows)

SELECT * FROM test_method where h1 = 1 AND h2 = 2 AND r1 = 1 AND r2 = 2;
 h1 | h2 | r1 | r2 | v1 | v2 
----+----+----+----+----+----
  1 |  2 |  1 |  2 |  6 | 16
(1 row)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 = 1 AND h2 = 1 AND r1 IN (1, 2, 3, 4) AND r2 IN (1, 2, 3, 4);
                                                      QUERY PLAN                                                       
-----------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=4 loops=1)
   Index Cond: ((h1 = 1) AND (h2 = 1) AND (r1 = ANY ('{1,2,3,4}'::integer[])) AND (r2 = ANY ('{1,2,3,4}'::integer[])))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
   Storage Table Rows Scanned: 4
(5 rows)

SELECT * FROM test_method where h1 = 1 AND h2 = 1 AND r1 IN (1, 2, 3, 4) AND r2 IN (1, 2, 3, 4);
 h1 | h2 | r1 | r2 | v1 | v2 
----+----+----+----+----+----
  1 |  1 |  1 |  1 |  1 | 11
  1 |  1 |  1 |  2 |  2 | 12
  1 |  1 |  2 |  1 |  3 | 13
  1 |  1 |  2 |  2 |  4 | 14
(4 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2);
                                       QUERY PLAN                                        
-----------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=10 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (h2 = ANY ('{1,2}'::integer[])))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 2
   Storage Table Rows Scanned: 10
(5 rows)

SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2);
 h1 | h2 | r1  | r2 | v1 | v2 
----+----+-----+----+----+----
  2 |  1 |   1 |  2 | 10 | 20
  1 |  1 |   1 |  1 |  1 | 11
  1 |  1 |   1 |  2 |  2 | 12
  1 |  1 |   2 |  1 |  3 | 13
  1 |  1 |   2 |  2 |  4 | 14
  1 |  2 |   1 |  1 |  5 | 15
  1 |  2 |   1 |  2 |  6 | 16
  1 |  2 |   2 |  1 |  7 | 17
  1 |  2 |   2 |  2 |  8 | 18
  1 |  2 | 999 |  2 |  8 | 18
(10 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 = 1;
                                              QUERY PLAN                                              
------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=5 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (h2 = ANY ('{1,2}'::integer[])) AND (r1 = 1))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 2
   Storage Table Rows Scanned: 5
(5 rows)

SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 = 1;
 h1 | h2 | r1 | r2 | v1 | v2 
----+----+----+----+----+----
  2 |  1 |  1 |  2 | 10 | 20
  1 |  1 |  1 |  1 |  1 | 11
  1 |  1 |  1 |  2 |  2 | 12
  1 |  2 |  1 |  1 |  5 | 15
  1 |  2 |  1 |  2 |  6 | 16
(5 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 = 1 AND r2 = 2;
                                                    QUERY PLAN                                                     
-------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=3 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (h2 = ANY ('{1,2}'::integer[])) AND (r1 = 1) AND (r2 = 2))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 2
   Storage Table Rows Scanned: 3
(5 rows)

SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 = 1 AND r2 = 2;
 h1 | h2 | r1 | r2 | v1 | v2 
----+----+----+----+----+----
  2 |  1 |  1 |  2 | 10 | 20
  1 |  1 |  1 |  2 |  2 | 12
  1 |  2 |  1 |  2 |  6 | 16
(3 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 IN (1, 2, 3, 4) AND r2 IN (1, 2, 3, 4);
                                                                               QUERY PLAN                                                                                
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=9 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (h2 = ANY ('{1,2}'::integer[])) AND (r1 = ANY ('{1,2,3,4}'::integer[])) AND (r2 = ANY ('{1,2,3,4}'::integer[])))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 2
   Storage Table Rows Scanned: 9
(5 rows)

SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 IN (1, 2, 3, 4) AND r2 IN (1, 2, 3, 4);
 h1 | h2 | r1 | r2 | v1 | v2 
----+----+----+----+----+----
  2 |  1 |  1 |  2 | 10 | 20
  1 |  1 |  1 |  1 |  1 | 11
  1 |  1 |  1 |  2 |  2 | 12
  1 |  1 |  2 |  1 |  3 | 13
  1 |  1 |  2 |  2 |  4 | 14
  1 |  2 |  1 |  1 |  5 | 15
  1 |  2 |  1 |  2 |  6 | 16
  1 |  2 |  2 |  1 |  7 | 17
  1 |  2 |  2 |  2 |  8 | 18
(9 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND yb_hash_code(h1, h2) < 8192;
                                                        QUERY PLAN                                                         
---------------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=0 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (yb_hash_code(h1, h2) < 8192) AND (h2 = ANY ('{1,2}'::integer[])))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
(4 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 = 1 AND yb_hash_code(h1, h2) < 8192;
                                                               QUERY PLAN                                                               
----------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=0 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (yb_hash_code(h1, h2) < 8192) AND (h2 = ANY ('{1,2}'::integer[])) AND (r1 = 1))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
(4 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 = 1 AND r2 = 2 AND yb_hash_code(h1, h2) < 8192;
                                                                     QUERY PLAN                                                                      
-----------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=0 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (yb_hash_code(h1, h2) < 8192) AND (h2 = ANY ('{1,2}'::integer[])) AND (r1 = 1) AND (r2 = 2))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
(4 rows)

EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method where h1 IN (1, 2, 3, 4) AND h2 IN (1, 2) AND r1 IN (1, 2, 3, 4) AND r2 IN (1, 2, 3, 4) AND yb_hash_code(h1, h2) < 8192;
                                                                                                QUERY PLAN                                                                                                 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=0 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4}'::integer[])) AND (yb_hash_code(h1, h2) < 8192) AND (h2 = ANY ('{1,2}'::integer[])) AND (r1 = ANY ('{1,2,3,4}'::integer[])) AND (r2 = ANY ('{1,2,3,4}'::integer[])))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 1
(4 rows)

DROP TABLE test_method;
CREATE TABLE test_method (h1 int, h2 int, h3 int, h4 int, v1 int, v2 int, PRIMARY KEY ((h1, h2, h3, h4) HASH));
INSERT INTO test_method VALUES (1, 1, 1, 1, 1, 11), (1, 1, 1, 2, 2, 12), (1, 1, 2, 1, 3, 13), (1, 1, 2, 2, 4, 14), (1, 2, 1, 1, 5, 15), (1, 2, 1, 2, 6, 16), (1, 2, 2, 1, 7, 17), (1, 2, 2, 2, 8, 18), (1, 2, 999, 2, 8, 18);
INSERT INTO test_method VALUES (2, 0, 1, 1, 9, 19), (2, 1, 1, 2, 10, 20), (1, 3, 1, 1, 1, 11), (1, 3, 1, 2, 2, 12), (1, 3, 2, 1, 3, 13), (1, 3, 2, 2, 4, 14), (1, 4, 1, 1, 1, 11), (1, 4, 1, 2, 2, 12), (1, 4, 2, 1, 3, 13), (1, 4, 2, 2, 4, 14);
-- Set a high work_mem limit so we don't limit the size of each request batch
SET work_mem = 2147483647;
EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method WHERE h1 IN (1,2,3,4,5,6,7,8,9,0) AND h2 IN (1,2,3,4,5,6,7,8,9,0) AND h3 IN (1,2,3,4,5,6,7,8,9,0) AND h4 IN (1,2,3,4,5,6,7,8,9,0);
                                                                                                         QUERY PLAN                                                                                                          
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=18 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4,5,6,7,8,9,0}'::integer[])) AND (h2 = ANY ('{1,2,3,4,5,6,7,8,9,0}'::integer[])) AND (h3 = ANY ('{1,2,3,4,5,6,7,8,9,0}'::integer[])) AND (h4 = ANY ('{1,2,3,4,5,6,7,8,9,0}'::integer[])))
   Storage Table Read Requests: 1
   Storage Table Read Ops: 3
   Storage Table Rows Scanned: 18
(5 rows)

-- Set a low work_mem limit so we limit the size of each request batch and cause
-- more requests to be sent out.
SET work_mem = 64;
EXPLAIN (ANALYZE, DIST, COSTS OFF, SUMMARY OFF, TIMING OFF) SELECT * FROM test_method WHERE h1 IN (1,2,3,4,5,6,7,8,9,0) AND h2 IN (1,2,3,4,5,6,7,8,9,0) AND h3 IN (1,2,3,4,5,6,7,8,9,0) AND h4 IN (1,2,3,4,5,6,7,8,9,0);
                                                                                                         QUERY PLAN                                                                                                          
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using test_method_pkey on test_method (actual rows=18 loops=1)
   Index Cond: ((h1 = ANY ('{1,2,3,4,5,6,7,8,9,0}'::integer[])) AND (h2 = ANY ('{1,2,3,4,5,6,7,8,9,0}'::integer[])) AND (h3 = ANY ('{1,2,3,4,5,6,7,8,9,0}'::integer[])) AND (h4 = ANY ('{1,2,3,4,5,6,7,8,9,0}'::integer[])))
   Storage Table Read Requests: 122
   Storage Table Read Ops: 366
   Storage Table Rows Scanned: 18
(5 rows)

DROP TABLE test_method;
CREATE TABLE sample (h int primary key);
INSERT INTO sample VALUES (24), (262095);
SELECT * FROM sample WHERE h = ANY('{{{24, 101}, {911, 262095}}}') ORDER BY h;
   h    
--------
     24
 262095
(2 rows)

DROP TABLE sample;
CREATE TABLE in_with_single_asc_key (r INT, v INT, PRIMARY KEY(r ASC)) SPLIT AT VALUES((100));
INSERT INTO in_with_single_asc_key VALUES(1, 1), (3, 3), (2, 2), (101, 101), (102, 102), (103, 103);
SELECT * FROM in_with_single_asc_key WHERE r IN (1, 3, 2, 102, 103, 101) ORDER BY r ASC;
  r  |  v  
-----+-----
   1 |   1
   2 |   2
   3 |   3
 101 | 101
 102 | 102
 103 | 103
(6 rows)

SELECT * FROM in_with_single_asc_key WHERE r IN (1, 3, 2, 102, 103, 101) ORDER BY r DESC;
  r  |  v  
-----+-----
 103 | 103
 102 | 102
 101 | 101
   3 |   3
   2 |   2
   1 |   1
(6 rows)

DROP TABLE in_with_single_asc_key;
CREATE TABLE in_with_single_desc_key (r INT, v INT, PRIMARY KEY(r DESC)) SPLIT AT VALUES((100));
INSERT INTO in_with_single_desc_key VALUES(1, 1), (3, 3), (2, 2), (101, 101), (102, 102), (103, 103);
SELECT * FROM in_with_single_desc_key WHERE r IN (1, 3, 2, 102, 103, 101) ORDER BY r ASC;
  r  |  v  
-----+-----
   1 |   1
   2 |   2
   3 |   3
 101 | 101
 102 | 102
 103 | 103
(6 rows)

SELECT * FROM in_with_single_desc_key WHERE r IN (1, 3, 2, 102, 103, 101) ORDER BY r DESC;
  r  |  v  
-----+-----
 103 | 103
 102 | 102
 101 | 101
   3 |   3
   2 |   2
   1 |   1
(6 rows)

DROP TABLE in_with_single_desc_key;
CREATE TABLE in_with_compound_asc_key (r1 INT, r2 INT, v INT, PRIMARY KEY(r1 ASC, r2 ASC)) SPLIT AT VALUES((1, 100));
INSERT INTO in_with_compound_asc_key VALUES(1, 1, 1), (1, 3, 3), (1, 2, 2), (1, 101, 101), (1, 102, 102), (1, 103, 103);
SELECT * FROM in_with_compound_asc_key WHERE r1 = 1 AND r2 IN (1, 3, 2, 102, 103, 101) ORDER BY r1 DESC, r2 DESC;
 r1 | r2  |  v  
----+-----+-----
  1 | 103 | 103
  1 | 102 | 102
  1 | 101 | 101
  1 |   3 |   3
  1 |   2 |   2
  1 |   1 |   1
(6 rows)

SELECT * FROM in_with_compound_asc_key WHERE r1 = 1 AND r2 IN (1, 3, 2, 102, 103, 101) ORDER BY r1 DESC, r2 ASC;
 r1 | r2  |  v  
----+-----+-----
  1 |   1 |   1
  1 |   2 |   2
  1 |   3 |   3
  1 | 101 | 101
  1 | 102 | 102
  1 | 103 | 103
(6 rows)

SELECT * FROM in_with_compound_asc_key WHERE r1 = 1 AND r2 IN (1, 3, 2, 102, 103, 101) ORDER BY r1 ASC, r2 DESC;
 r1 | r2  |  v  
----+-----+-----
  1 | 103 | 103
  1 | 102 | 102
  1 | 101 | 101
  1 |   3 |   3
  1 |   2 |   2
  1 |   1 |   1
(6 rows)

SELECT * FROM in_with_compound_asc_key WHERE r1 = 1 AND r2 IN (1, 3, 2, 102, 103, 101) ORDER BY r1 ASC, r2 ASC;
 r1 | r2  |  v  
----+-----+-----
  1 |   1 |   1
  1 |   2 |   2
  1 |   3 |   3
  1 | 101 | 101
  1 | 102 | 102
  1 | 103 | 103
(6 rows)

DROP TABLE in_with_compound_asc_key;
CREATE TABLE in_with_compound_desc_key (r1 INT, r2 INT, v INT, PRIMARY KEY(r1 ASC, r2 DESC)) SPLIT AT VALUES((1, 100));
INSERT INTO in_with_compound_desc_key VALUES(1, 1, 1), (1, 3, 3), (1, 2, 2), (1, 101, 101), (1, 102, 102), (1, 103, 103);
SELECT * FROM in_with_compound_desc_key WHERE r1 = 1 AND r2 IN (1, 3, 2, 102, 103, 101) ORDER BY r1 DESC, r2 DESC;
 r1 | r2  |  v  
----+-----+-----
  1 | 103 | 103
  1 | 102 | 102
  1 | 101 | 101
  1 |   3 |   3
  1 |   2 |   2
  1 |   1 |   1
(6 rows)

SELECT * FROM in_with_compound_desc_key WHERE r1 = 1 AND r2 IN (1, 3, 2, 102, 103, 101) ORDER BY r1 DESC, r2 ASC;
 r1 | r2  |  v  
----+-----+-----
  1 |   1 |   1
  1 |   2 |   2
  1 |   3 |   3
  1 | 101 | 101
  1 | 102 | 102
  1 | 103 | 103
(6 rows)

SELECT * FROM in_with_compound_desc_key WHERE r1 = 1 AND r2 IN (1, 3, 2, 102, 103, 101) ORDER BY r1 ASC, r2 DESC;
 r1 | r2  |  v  
----+-----+-----
  1 | 103 | 103
  1 | 102 | 102
  1 | 101 | 101
  1 |   3 |   3
  1 |   2 |   2
  1 |   1 |   1
(6 rows)

SELECT * FROM in_with_compound_desc_key WHERE r1 = 1 AND r2 IN (1, 3, 2, 102, 103, 101) ORDER BY r1 ASC, r2 ASC;
 r1 | r2  |  v  
----+-----+-----
  1 |   1 |   1
  1 |   2 |   2
  1 |   3 |   3
  1 | 101 | 101
  1 | 102 | 102
  1 | 103 | 103
(6 rows)

DROP TABLE in_with_compound_desc_key;
-- GHI #29041
create table test_29041(id varchar primary key, f1 varchar, f2 timestamptz, f3 timestamptz) split into 6 tablets;
insert into test_29041 select 'first_col_filler' || i::varchar, 'second_col_filler' || i::varchar, now(), now() + '10 days'::interval from generate_series(1, 100000) i;
SET work_mem = '256MB';
explain (analyze, dist) select * from test_29041 where id = ANY (array(select 'first_col_filler' || i::varchar from generate_series(1, 10000) i)) and yb_hash_code(id) >= 0 and yb_hash_code(id) < 8192;
                                                     QUERY PLAN                                                     
--------------------------------------------------------------------------------------------------------------------
 Index Scan using test_29041_pkey on test_29041  (cost=175.00..197.64 rows=141 width=80) (actual rows=1223 loops=1)
   Index Cond: (((id)::text = ANY ($0)) AND (yb_hash_code(id) >= 0) AND (yb_hash_code(id) < 8192))
   Storage Table Read Requests: 2
   Storage Table Read Ops: 2
   Storage Table Rows Scanned: 1223
   InitPlan 1 (returns $0)
     ->  Function Scan on generate_series i  (cost=0.00..175.00 rows=10000 width=32) (actual rows=10000 loops=1)
 Storage Read Requests: 2
 Storage Read Ops: 2
 Storage Rows Scanned: 1223
 Storage Write Requests: 0
 Storage Flush Requests: 0
(12 rows)

drop table test_29041;
