--
-- YB Bitmap Scans on System Tables (bitmap index scans + YB bitmap table scans)
--
\getenv abs_srcdir PG_ABS_SRCDIR
\set filename :abs_srcdir '/yb_commands/explainrun.sql'
\i :filename
-- A helper script to explain and run a query.  Use in regress tests by
-- defining :explain, :query, and optionally :hint#.
\set explain1 ':explain :hint1 :query;'
\set explain2 ':explain1 :explain :hint2 :query;'
\set explain3 ':explain2 :explain :hint3 :query;'
\set explain4 ':explain3 :explain :hint4 :query;'
\set explain5 ':explain4 :explain :hint5 :query;'
\set explain1run1 ':explain1; :hint1 :query;'
\set explain2run2 ':explain2; :hint1 :query; :hint2 :query;'
\set explain3run3 ':explain3; :hint1 :query; :hint2 :query; :hint3 :query;'
\set explain4run4 ':explain4; :hint1 :query; :hint2 :query; :hint3 :query; :hint4 :query;'
\set explain5run5 ':explain5; :hint1 :query; :hint2 :query; :hint3 :query; :hint4 :query; :hint5 :query;'
-- Default to no hints.
\set hint1 ''
\set hint2 ''
\set hint3 ''
\set hint4 ''
\set hint5 ''
\set explain 'EXPLAIN (ANALYZE, COSTS OFF, SUMMARY OFF)'
\set hint1 '/*+ BitmapScan(pg_authid) */'
SET yb_enable_bitmapscan = true;
SET enable_bitmapscan = true;
SELECT $$
SELECT rolname FROM pg_authid WHERE rolname LIKE 'pg_%' OR rolname LIKE 'yb_%' ORDER BY rolname
$$ AS query \gset
:explain1run1
                                                              QUERY PLAN                                                              
--------------------------------------------------------------------------------------------------------------------------------------
 Sort (actual rows=15 loops=1)
   Sort Key: rolname
   Sort Method: quicksort
   ->  YB Bitmap Table Scan on pg_authid (actual rows=15 loops=1)
         Storage Filter: ((rolname ~~ 'pg_%'::text) OR (rolname ~~ 'yb_%'::text))
         Recheck Cond: (((rolname >= 'pg'::text) AND (rolname < 'ph'::text)) OR ((rolname >= 'yb'::text) AND (rolname < 'yc'::text)))
         ->  BitmapOr (actual rows=15 loops=1)
               ->  Bitmap Index Scan on pg_authid_rolname_index (actual rows=15 loops=1)
                     Index Cond: ((rolname >= 'pg'::text) AND (rolname < 'ph'::text))
                     Storage Index Filter: ((rolname ~~ 'pg_%'::text) OR (rolname ~~ 'yb_%'::text))
               ->  Bitmap Index Scan on pg_authid_rolname_index (actual rows=15 loops=1)
                     Index Cond: ((rolname >= 'yb'::text) AND (rolname < 'yc'::text))
                     Storage Index Filter: ((rolname ~~ 'pg_%'::text) OR (rolname ~~ 'yb_%'::text))
(13 rows)

          rolname          
---------------------------
 pg_checkpoint
 pg_database_owner
 pg_execute_server_program
 pg_monitor
 pg_read_all_data
 pg_read_all_settings
 pg_read_all_stats
 pg_read_server_files
 pg_signal_backend
 pg_stat_scan_tables
 pg_write_all_data
 pg_write_server_files
 yb_db_admin
 yb_extension
 yb_fdw
(15 rows)

SELECT $$
SELECT spcname FROM pg_tablespace WHERE spcowner NOT IN (
    SELECT oid FROM pg_roles WHERE rolname = 'postgres' OR rolname LIKE 'pg_%' OR rolname LIKE 'yb_%')
$$ AS query \gset
:explain1run1
                                                                               QUERY PLAN                                                                               
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Seq Scan on pg_tablespace (actual rows=0 loops=1)
   Filter: (NOT (hashed SubPlan 1))
   Rows Removed by Filter: 2
   SubPlan 1
     ->  YB Bitmap Table Scan on pg_authid (actual rows=16 loops=1)
           Storage Filter: ((rolname = 'postgres'::name) OR (rolname ~~ 'pg_%'::text) OR (rolname ~~ 'yb_%'::text))
           Recheck Cond: ((rolname = 'postgres'::name) OR ((rolname >= 'pg'::text) AND (rolname < 'ph'::text)) OR ((rolname >= 'yb'::text) AND (rolname < 'yc'::text)))
           ->  BitmapOr (actual rows=16 loops=1)
                 ->  Bitmap Index Scan on pg_authid_rolname_index (actual rows=1 loops=1)
                       Index Cond: (rolname = 'postgres'::name)
                 ->  Bitmap Index Scan on pg_authid_rolname_index (actual rows=16 loops=1)
                       Index Cond: ((rolname >= 'pg'::text) AND (rolname < 'ph'::text))
                       Storage Index Filter: ((rolname = 'postgres'::name) OR (rolname ~~ 'pg_%'::text) OR (rolname ~~ 'yb_%'::text))
                 ->  Bitmap Index Scan on pg_authid_rolname_index (actual rows=16 loops=1)
                       Index Cond: ((rolname >= 'yb'::text) AND (rolname < 'yc'::text))
                       Storage Index Filter: ((rolname = 'postgres'::name) OR (rolname ~~ 'pg_%'::text) OR (rolname ~~ 'yb_%'::text))
(16 rows)

 spcname 
---------
(0 rows)

SET yb_enable_expression_pushdown = false;
SELECT $$
SELECT spcname FROM pg_tablespace WHERE spcowner NOT IN (
    SELECT oid FROM pg_roles WHERE rolname = 'postgres' OR rolname LIKE 'pg_%' OR rolname LIKE 'yb_%')
$$ AS query \gset
:explain1run1
                                                                               QUERY PLAN                                                                               
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Seq Scan on pg_tablespace (actual rows=0 loops=1)
   Filter: (NOT (hashed SubPlan 1))
   Rows Removed by Filter: 2
   SubPlan 1
     ->  YB Bitmap Table Scan on pg_authid (actual rows=16 loops=1)
           Recheck Cond: ((rolname = 'postgres'::name) OR ((rolname >= 'pg'::text) AND (rolname < 'ph'::text)) OR ((rolname >= 'yb'::text) AND (rolname < 'yc'::text)))
           Rows Removed by Index Recheck: 2
           Filter: ((rolname = 'postgres'::name) OR (rolname ~~ 'pg_%'::text) OR (rolname ~~ 'yb_%'::text))
           ->  BitmapOr (actual rows=18 loops=1)
                 ->  Bitmap Index Scan on pg_authid_rolname_index (actual rows=1 loops=1)
                       Index Cond: (rolname = 'postgres'::name)
                 ->  Bitmap Index Scan on pg_authid_rolname_index (actual rows=18 loops=1)
                       Index Cond: ((rolname >= 'pg'::text) AND (rolname < 'ph'::text))
                 ->  Bitmap Index Scan on pg_authid_rolname_index (actual rows=18 loops=1)
                       Index Cond: ((rolname >= 'yb'::text) AND (rolname < 'yc'::text))
(15 rows)

 spcname 
---------
(0 rows)

RESET yb_enable_expression_pushdown;
RESET yb_enable_bitmapscan;
RESET enable_bitmapscan;
