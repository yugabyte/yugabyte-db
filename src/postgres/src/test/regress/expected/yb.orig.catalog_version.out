--
-- This file is to check the effect of DDL statements on the catalog version
-- stored in pg_yb_catalog_table. In particular, not all DDL query causes
-- changes in catalog. For example, a grant statement may not really change
-- anything if the same privileges are already granted. In such cases it is
-- benefitial to avoid catalog version increment to prevent catalog cache
-- update which may overload yb-master if there are a large number of active
-- Postgres connections.
--
--
\set template1_db_oid 1
\set db_oid 'CASE WHEN (select count(*) from pg_yb_catalog_version) = 1 THEN :template1_db_oid ELSE (SELECT oid FROM pg_database WHERE datname = \'yugabyte\') END'
-- Set the catalog versions to known, fixed values before running the test.
-- This is done so that the test output isn't affected by queries that run
-- run during test setup.
SET yb_non_ddl_txn_for_sys_tables_allowed TO on;
UPDATE pg_yb_catalog_version SET current_version = 10000,
    last_breaking_version = 10000 WHERE db_oid = :db_oid;
RESET yb_non_ddl_txn_for_sys_tables_allowed;
-- Build a SQL query that works with per-database catalog version mode enabled
-- or disabled.
\set display_catalog_version 'SELECT current_version, last_breaking_version FROM pg_yb_catalog_version WHERE db_oid = :db_oid'
-- Display the initial catalog version.
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10000 |                 10000
(1 row)

-- The next CREATE ROLE will not increment current_version.
CREATE ROLE cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10001 |                 10000
(1 row)

-- The next CREATE ROLE fails and should not cause any catalog version change.
CREATE ROLE cv_test_role;
ERROR:  role "cv_test_role" already exists
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10001 |                 10000
(1 row)

-- The next CREATE ROLE will increment current_version.
CREATE ROLE cv_test_role2 IN ROLE cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10002 |                 10000
(1 row)

-- The next CREATE ROLE will increment current_version.
CREATE ROLE cv_test_role3 ADMIN cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10003 |                 10000
(1 row)

-- The next CREATE ROLE will increment current_version.
CREATE ROLE cv_test_role4 ROLE cv_test_role2, cv_test_role3;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10004 |                 10000
(1 row)

-- The next CREATE DATABASE will not increment current_version.
CREATE DATABASE cv_test_database;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10005 |                 10000
(1 row)

-- The next GRANT CONNECT will increment current_version.
GRANT CONNECT ON DATABASE cv_test_database TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10006 |                 10000
(1 row)

-- The next GRANT CONNECT should not cause any catalog version change.
GRANT CONNECT ON DATABASE cv_test_database TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10006 |                 10000
(1 row)

-- The next REVOKE CONNECT is a "breaking" catalog change. It will increment
-- both current_version and last_breaking_version.
REVOKE CONNECT ON DATABASE cv_test_database from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10007 |                 10007
(1 row)

-- The next REVOKE CONNECT should not cause any catalog version change.
REVOKE CONNECT ON DATABASE cv_test_database from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10007 |                 10007
(1 row)

-- The next CREATE TABLE should increment current_version.
CREATE TABLE cv_test_table(id int);
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10008 |                 10007
(1 row)

-- The next GRANT SELECT will increment current_version.
GRANT SELECT ON cv_test_table TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10009 |                 10007
(1 row)

-- The next GRANT SELECT should not cause any catalog version change.
GRANT SELECT ON cv_test_table TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10009 |                 10007
(1 row)

-- The next REVOKE SELECT is a "breaking" catalog change. It will increment
-- both current_version and last_breaking_version.
REVOKE SELECT ON cv_test_table FROM cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10010 |                 10010
(1 row)

-- The next REVOKE SELECT should not cause any catalog version change.
REVOKE SELECT ON cv_test_table FROM cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10010 |                 10010
(1 row)

-- The next CREATE FOREIGN DATA WRAPPER will increment current_version.
CREATE FOREIGN DATA WRAPPER cv_test_fdw_wrapper;
-- The next GRANT USAGE will increment current_version.
GRANT USAGE ON FOREIGN DATA WRAPPER cv_test_fdw_wrapper TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10012 |                 10010
(1 row)

-- The next GRANT USAGE should not cause any catalog version change.
GRANT USAGE ON FOREIGN DATA WRAPPER cv_test_fdw_wrapper TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10012 |                 10010
(1 row)

-- The next REVOKE USAGE is a "breaking" catalog change. It will increment
-- both current_version and last_breaking_version.
REVOKE USAGE ON FOREIGN DATA WRAPPER cv_test_fdw_wrapper FROM cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10013 |                 10013
(1 row)

-- The next REVOKE USAGE should not cause any catalog version change.
REVOKE USAGE ON FOREIGN DATA WRAPPER cv_test_fdw_wrapper FROM cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10013 |                 10013
(1 row)

-- The next CREATE SERVER will increment current_version.
CREATE SERVER cv_test_fdw_server FOREIGN DATA WRAPPER cv_test_fdw_wrapper;
-- The next GRANT USAGE will increment current_version.
GRANT USAGE ON FOREIGN SERVER cv_test_fdw_server TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10015 |                 10013
(1 row)

-- The next GRANT USAGE should not cause any catalog version change.
GRANT USAGE ON FOREIGN SERVER cv_test_fdw_server TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10015 |                 10013
(1 row)

-- The next REVOKE USAGE is a "breaking" catalog change. It will increment
-- both current_version and last_breaking_version.
REVOKE USAGE ON FOREIGN SERVER cv_test_fdw_server FROM cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10016 |                 10016
(1 row)

-- The next REVOKE USAGE should not cause any catalog version change.
REVOKE USAGE ON FOREIGN SERVER cv_test_fdw_server FROM cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10016 |                 10016
(1 row)

-- The next CREATE FUNCTION will increment current_version.
CREATE FUNCTION cv_test_function() RETURNS int AS $$ SELECT 1 $$ LANGUAGE sql;
-- The next GRANT EXECUTE will increment current_version.
GRANT EXECUTE ON FUNCTION cv_test_function TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10018 |                 10016
(1 row)

-- The next GRANT EXECUTE should not cause any catalog version change.
GRANT EXECUTE ON FUNCTION cv_test_function TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10018 |                 10016
(1 row)

-- The next REVOKE EXECUTE is a "breaking" catalog change. It will increment
-- both current_version and last_breaking_version.
REVOKE EXECUTE ON FUNCTION cv_test_function from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10019 |                 10019
(1 row)

-- The next REVOKE EXECUTE should not cause any catalog version change.
REVOKE EXECUTE ON FUNCTION cv_test_function from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10019 |                 10019
(1 row)

-- The next GRANT USAGE will increment current_version.
GRANT USAGE ON LANGUAGE sql TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10020 |                 10019
(1 row)

-- The next GRANT USAGE should not cause any catalog version change.
GRANT USAGE ON LANGUAGE sql TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10020 |                 10019
(1 row)

-- The next REVOKE USAGE is a "breaking" catalog change. It will increment
-- both current_version and last_breaking_version.
REVOKE USAGE ON LANGUAGE sql from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10021 |                 10021
(1 row)

-- The next REVOKE USAGE should not cause any catalog version change.
REVOKE USAGE ON LANGUAGE sql from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10021 |                 10021
(1 row)

SET yb_non_ddl_txn_for_sys_tables_allowed=1;
SELECT lo_create(1001);
 lo_create 
-----------
      1001
(1 row)

SET yb_non_ddl_txn_for_sys_tables_allowed=0;
-- The next GRANT SELECT will increment current_version.
GRANT SELECT ON LARGE OBJECT 1001 TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10022 |                 10021
(1 row)

-- The next GRANT SELECT should not cause any catalog version change.
GRANT SELECT ON LARGE OBJECT 1001 TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10022 |                 10021
(1 row)

-- The next REVOKE SELECT is a "breaking" catalog change. It will increment
-- both current_version and last_breaking_version.
REVOKE SELECT ON LARGE OBJECT 1001 from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10023 |                 10023
(1 row)

-- The next REVOKE SELECT should not cause any catalog version change.
REVOKE SELECT ON LARGE OBJECT 1001 from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10023 |                 10023
(1 row)

-- The next GRANT USAGE will increment current_version.
GRANT USAGE ON SCHEMA public TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10024 |                 10023
(1 row)

-- The next GRANT USAGE should not cause any catalog version change.
GRANT USAGE ON SCHEMA public TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10024 |                 10023
(1 row)

-- The next REVOKE USAGE is a "breaking" catalog change. It will increment
-- both current_version and last_breaking_version.
REVOKE USAGE ON SCHEMA public from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10025 |                 10025
(1 row)

-- The next REVOKE USAGE should not cause any catalog version change.
REVOKE USAGE ON SCHEMA public from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10025 |                 10025
(1 row)

-- The next CREATE TABLEGROUP will increment current_version.
CREATE TABLEGROUP cv_test_tablegroup;
-- The next GRANT CREATE will increment current_version.
GRANT CREATE ON TABLEGROUP cv_test_tablegroup TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10027 |                 10025
(1 row)

-- The next GRANT CREATE should not cause any catalog version change.
GRANT CREATE ON TABLEGROUP cv_test_tablegroup TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10027 |                 10025
(1 row)

-- The next REVOKE CREATE is a "breaking" catalog change. It will increment
-- both current_version and last_breaking_version.
REVOKE CREATE ON TABLEGROUP cv_test_tablegroup from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10028 |                 10028
(1 row)

-- The next REVOKE CREATE should not cause any catalog version change.
REVOKE CREATE ON TABLEGROUP cv_test_tablegroup from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10028 |                 10028
(1 row)

-- The next CREATE TABLESPACE will increment current_version.
CREATE TABLESPACE cv_test_tablespace WITH (replica_placement=
  '{"num_replicas":1,"placement_blocks":[{"cloud":"c1","region":"r1","zone":"z1","min_num_replicas":1}]}');
-- The next GRANT CREATE will increment current_version.
GRANT CREATE ON TABLESPACE cv_test_tablespace TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10030 |                 10028
(1 row)

-- The next GRANT CREATE should not cause any catalog version change.
GRANT CREATE ON TABLESPACE cv_test_tablespace TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10030 |                 10028
(1 row)

-- The next REVOKE CREATE is a "breaking" catalog change. It will increment
-- both current_version and last_breaking_version.
REVOKE CREATE ON TABLESPACE cv_test_tablespace from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10031 |                 10031
(1 row)

-- The next REVOKE CREATE should not cause any catalog version change.
REVOKE CREATE ON TABLESPACE cv_test_tablespace from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10031 |                 10031
(1 row)

-- The next CREATE TYPE will increment current_version.
CREATE TYPE cv_test_type AS (a int, b text);
-- The next GRANT USAGE will increment current_version.
GRANT USAGE ON TYPE cv_test_type TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10033 |                 10031
(1 row)

-- The next GRANT USAGE should not cause any catalog version change.
GRANT USAGE ON TYPE cv_test_type TO cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10033 |                 10031
(1 row)

-- The next REVOKE USAGE is a "breaking" catalog change. It will increment
-- both current_version and last_breaking_version.
REVOKE USAGE ON TYPE cv_test_type from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10034 |                 10034
(1 row)

-- The next REVOKE USAGE should not cause any catalog version change.
REVOKE USAGE ON TYPE cv_test_type from cv_test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10034 |                 10034
(1 row)

-- CREATE TABLE should increment current_version.
CREATE TABLE t_check (col INT CHECK (col > 0));
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10035 |                 10034
(1 row)

CREATE TABLE t_not_null (col INT NOT NULL);
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10036 |                 10034
(1 row)

CREATE TABLE t_primary_key (col INT PRIMARY KEY);
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10037 |                 10034
(1 row)

CREATE TABLE t_sequence (col SERIAL, value TEXT);
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10038 |                 10034
(1 row)

CREATE TABLE t_unique (col INT UNIQUE);
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10039 |                 10034
(1 row)

CREATE TABLE t_identity (col INT GENERATED ALWAYS AS IDENTITY);
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10040 |                 10034
(1 row)

CREATE TABLE t_primary_key_sequence_identity (c1 INT PRIMARY KEY, c2 SERIAL, c3 INT GENERATED ALWAYS AS IDENTITY);
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10041 |                 10034
(1 row)

-- The CREATE TABLE with FOREIGN KEY will increment current_version.
CREATE TABLE t1 (col INT UNIQUE);
CREATE TABLE t2 (col INT REFERENCES t1(col));
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10043 |                 10034
(1 row)

-- The ALTER TABLE will increment current_version.
ALTER TABLE t1 ADD COLUMN val INT;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10044 |                 10034
(1 row)

-- The CREATE PROCEDURE will not increment current_version.
CREATE PROCEDURE test() AS $$ BEGIN INSERT INTO t1 VALUES(1); END; $$ LANGUAGE 'plpgsql';
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10045 |                 10034
(1 row)

-- The CALL to PROCEDURE will not increment current_version.
CALL test();
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10045 |                 10034
(1 row)

-- The CREATE FUNCTION will increment current_version.
CREATE TABLE evt_trig_table (id serial PRIMARY KEY, evt_trig_name text);
CREATE OR REPLACE FUNCTION evt_trig_fn() RETURNS event_trigger AS $$ BEGIN INSERT INTO evt_trig_table (evt_trig_name) VALUES (TG_EVENT); END; $$ LANGUAGE plpgsql;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10047 |                 10034
(1 row)

-- The CREATE EVENT TRIGGER will increment current_version.
CREATE EVENT TRIGGER evt_ddl_start ON ddl_command_start EXECUTE PROCEDURE evt_trig_fn();
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10048 |                 10034
(1 row)

-- The DDLs proceeding the trigger will increment current_version based on the command's individual behaviour.
-- The ALTER TABLE will increment current_version.
ALTER TABLE evt_trig_table ADD COLUMN val INT;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10049 |                 10034
(1 row)

-- The CREATE TABLE will not increment current_version.
CREATE TABLE post_trigger_table (id INT);
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10050 |                 10034
(1 row)

-- The execution on atomic SPI context function will not increment current_version.
CREATE FUNCTION atomic_spi(INT) RETURNS INT AS $$
DECLARE TOTAL INT;
BEGIN
  CREATE TEMP TABLE temp_table(a INT);
  INSERT INTO temp_table VALUES($1);
  INSERT INTO temp_table VALUES(1);
  SELECT SUM(a) INTO TOTAL FROM temp_table;
  DROP TABLE temp_table;
  RETURN TOTAL;
END
$$ LANGUAGE PLPGSQL;
SELECT atomic_spi(1);
 atomic_spi 
------------
          2
(1 row)

:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10051 |                 10034
(1 row)

SELECT atomic_spi(2);
 atomic_spi 
------------
          3
(1 row)

:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10051 |                 10034
(1 row)

-- The execution on non-atomic SPI context will not increment current_version.
CREATE TABLE non_atomic_spi(a INT, b INT);
CREATE PROCEDURE proc(x INT, y INT) LANGUAGE PLPGSQL AS $$
BEGIN FOR i IN 0..x LOOP INSERT INTO non_atomic_spi(a, b) VALUES (i, y);
IF i % 2 = 0 THEN COMMIT;
ELSE ROLLBACK;
END IF;
END LOOP;
END $$;
CREATE PROCEDURE p1() LANGUAGE PLPGSQL AS $$ BEGIN CALL p2(); END $$;
CREATE PROCEDURE p2() LANGUAGE PLPGSQL AS $$ BEGIN CALL proc(2, 2); END $$;
CALL p1();
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10055 |                 10034
(1 row)

-- Verify that variants of CREATE TABLE AS SELECT do not increment catalog version.
CREATE TABLE t (id INT);
SELECT id INTO TEMPORARY TABLE temp FROM t;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10057 |                 10034
(1 row)

CREATE TEMPORARY TABLE temp2 AS SELECT id FROM t;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10058 |                 10034
(1 row)

CREATE TABLE t_1 AS SELECT id FROM t;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10059 |                 10034
(1 row)

-- Verify that catalog version gets incremented if CREATE TABLE AS invokes other
-- DDL operations.
CREATE TABLE t_2 (id INT);
GRANT ALL ON t_2 TO public;
CREATE OR REPLACE FUNCTION f1() RETURNS float8 AS $$
BEGIN
	ALTER TABLE t_2 ADD COLUMN v2 int;
	REVOKE SELECT ON t_2 FROM public;
	RETURN 1;
END$$ LANGUAGE plpgsql;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10062 |                 10034
(1 row)

CREATE TABLE t_3 AS SELECT c FROM (SELECT 1 AS c, f1()) AS s;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10063 |                 10063
(1 row)

-- The next GRANT SELECT will increment current_version.
GRANT SELECT (rolname, rolsuper) ON pg_authid TO CURRENT_USER;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10064 |                 10063
(1 row)

-- The next GRANT SELECT used to increment current_version due to evt_ddl_start
-- which causes an insert into evt_trig_table table. However, evt_trig_table is
-- not a catalog table. It is a user table and writing to a user table does not
-- change catalog state so should not need to increment catalog version. As of
-- 2024-10-15, we simply detect whether there is any write under DDL mode and
-- when we make the write to evt_trig_table, the GRANT SELECT DDL execution is
-- in progress. An improvement is to detect we write to catalog table under DDL
-- mode.
-- With invalidation messages, we detect that the GRANT SELECT DDL statement
-- does not generate any invalidation messages at all, which implies no catalog
-- cache entries need to be invalidated. Therefore this GRANT SELECT no longer
-- increments current_version.
GRANT SELECT (rolname, rolsuper) ON pg_authid TO CURRENT_USER;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10064 |                 10063
(1 row)

DROP EVENT TRIGGER evt_ddl_start;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10065 |                 10063
(1 row)

-- The next GRANT SELECT should not cause any catalog version change.
GRANT SELECT (rolname, rolsuper) ON pg_authid TO CURRENT_USER;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10065 |                 10063
(1 row)

-- Verify REFRESH MATERIALIZED VIEW is not a breaking change.
CREATE TABLE base (t int);
CREATE MATERIALIZED VIEW mv AS SELECT * FROM base;
CREATE UNIQUE INDEX ON mv(t);
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10070 |                 10063
(1 row)

-- nonconcurrent refreshes should bump catalog version.
REFRESH MATERIALIZED VIEW mv;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10071 |                 10063
(1 row)

-- concurrent refreshes should increment current_version.
INSERT INTO base VALUES (1); -- TODO(#26677): remove this workaround.
REFRESH MATERIALIZED VIEW CONCURRENTLY mv;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10071 |                 10063
(1 row)

-- Verify ANALYZE increments catalog version once for every involved table
-- and is not a breaking change.
CREATE TABLE analyze_table (t int);
CREATE TABLE analyze_table2 (t int);
INSERT INTO analyze_table select generate_series(1,100);
INSERT INTO analyze_table2 select generate_series(1,100);
ANALYZE analyze_table, analyze_table2;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10075 |                 10063
(1 row)

SELECT relname, reltuples FROM pg_class WHERE relname = 'analyze_table' OR relname = 'analyze_table2' ORDER BY relname;
    relname     | reltuples 
----------------+-----------
 analyze_table  |       100
 analyze_table2 |       100
(2 rows)

SELECT min(t), max(t) FROM analyze_table;
 min | max 
-----+-----
   1 | 100
(1 row)

SELECT min(t), max(t) FROM analyze_table2;
 min | max 
-----+-----
   1 | 100
(1 row)

-- Verify no-op ALTER ROLE
CREATE ROLE test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10076 |                 10063
(1 row)

-- The next ALTER ROLE should increment current_version.
ALTER ROLE test_role CONNECTION LIMIT 1;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10077 |                 10077
(1 row)

-- The next ALTER ROLE should increment current_version.
ALTER ROLE test_role CONNECTION LIMIT -1;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10078 |                 10078
(1 row)

-- The next ALTER ROLE should not increment current_version.
ALTER ROLE test_role CONNECTION LIMIT -1;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10078 |                 10078
(1 row)

-- The next ALTER ROLE should increment current_version.
ALTER ROLE test_role PASSWORD '123';
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10079 |                 10078
(1 row)

-- The next ALTER ROLE should increment current_version.
ALTER ROLE test_role PASSWORD NULL;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10080 |                 10078
(1 row)

-- The next ALTER ROLE should increment current_version.
ALTER ROLE test_role VALID UNTIL 'May 4 12:00:00 2015 +1';
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10081 |                 10081
(1 row)

-- The next ALTER ROLE should not increment current_version.
ALTER ROLE test_role VALID UNTIL 'May 4 12:00:00 2015 +1';
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10081 |                 10081
(1 row)

-- The next ALTER ROLE should increment current_version.
ALTER ROLE test_role VALID UNTIL 'infinity';
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10082 |                 10082
(1 row)

-- The next ALTER ROLE should not increment current_version.
ALTER ROLE test_role VALID UNTIL 'infinity';
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10082 |                 10082
(1 row)

-- The next ALTER ROLE should increment current_version.
ALTER ROLE test_role CREATEROLE;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10083 |                 10083
(1 row)

-- The next ALTER ROLE should increment current_version.
ALTER ROLE test_role CREATEDB;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10084 |                 10084
(1 row)

-- The next ALTER ROLE should not increment current_version.
ALTER ROLE test_role CREATEROLE CREATEDB;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10084 |                 10084
(1 row)

-- The next ALTER ROLE should not increment current_version.
ALTER ROLE test_role;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10084 |                 10084
(1 row)

-- Sanity test yb_increment_db_catalog_version_with_inval_messages
-- Clear pg_yb_invalidation_messages for any left over messages from previous DDLs.
SET yb_non_ddl_txn_for_sys_tables_allowed=1;
DELETE FROM pg_yb_invalidation_messages;
SET yb_non_ddl_txn_for_sys_tables_allowed=0;
\set display_all 'SELECT datname, current_version, last_breaking_version FROM pg_yb_catalog_version JOIN pg_database ON db_oid = oid ORDER BY datname; SELECT datname, current_version, messages FROM pg_yb_invalidation_messages JOIN pg_database ON db_oid = oid ORDER BY datname'
SET yb_non_ddl_txn_for_sys_tables_allowed TO on;
SET yb_disable_catalog_version_check TO on;
-- Messages expire after 10 seconds.
SELECT yb_increment_db_catalog_version_with_inval_messages(:db_oid, false, '', 10);
 yb_increment_db_catalog_version_with_inval_messages 
-----------------------------------------------------
                                               10085
(1 row)

:display_all;
     datname      | current_version | last_breaking_version 
------------------+-----------------+-----------------------
 cv_test_database |              16 |                    16
 postgres         |              21 |                    21
 system_platform  |              21 |                    21
 template0        |              21 |                    21
 template1        |              21 |                    21
 yugabyte         |           10085 |                 10084
(6 rows)

 datname  | current_version | messages 
----------+-----------------+----------
 yugabyte |           10085 | \x
(1 row)

SELECT yb_increment_db_catalog_version_with_inval_messages(:db_oid, false, null, 10);
 yb_increment_db_catalog_version_with_inval_messages 
-----------------------------------------------------
                                               10086
(1 row)

:display_all;
     datname      | current_version | last_breaking_version 
------------------+-----------------+-----------------------
 cv_test_database |              16 |                    16
 postgres         |              21 |                    21
 system_platform  |              21 |                    21
 template0        |              21 |                    21
 template1        |              21 |                    21
 yugabyte         |           10086 |                 10084
(6 rows)

 datname  | current_version | messages 
----------+-----------------+----------
 yugabyte |           10085 | \x
 yugabyte |           10086 | 
(2 rows)

SELECT yb_increment_db_catalog_version_with_inval_messages(:db_oid, true, '', 10);
 yb_increment_db_catalog_version_with_inval_messages 
-----------------------------------------------------
                                               10087
(1 row)

:display_all;
     datname      | current_version | last_breaking_version 
------------------+-----------------+-----------------------
 cv_test_database |              16 |                    16
 postgres         |              21 |                    21
 system_platform  |              21 |                    21
 template0        |              21 |                    21
 template1        |              21 |                    21
 yugabyte         |           10087 |                 10087
(6 rows)

 datname  | current_version | messages 
----------+-----------------+----------
 yugabyte |           10085 | \x
 yugabyte |           10086 | 
 yugabyte |           10087 | \x
(3 rows)

SELECT yb_increment_db_catalog_version_with_inval_messages(:db_oid, true, null, 10);
 yb_increment_db_catalog_version_with_inval_messages 
-----------------------------------------------------
                                               10088
(1 row)

:display_all;
     datname      | current_version | last_breaking_version 
------------------+-----------------+-----------------------
 cv_test_database |              16 |                    16
 postgres         |              21 |                    21
 system_platform  |              21 |                    21
 template0        |              21 |                    21
 template1        |              21 |                    21
 yugabyte         |           10088 |                 10088
(6 rows)

 datname  | current_version | messages 
----------+-----------------+----------
 yugabyte |           10085 | \x
 yugabyte |           10086 | 
 yugabyte |           10087 | \x
 yugabyte |           10088 | 
(4 rows)

-- Wait for the old message row to expire.
SELECT pg_sleep(15);
 pg_sleep 
----------
 
(1 row)

SELECT yb_increment_db_catalog_version_with_inval_messages(:db_oid, false, '', 10);
 yb_increment_db_catalog_version_with_inval_messages 
-----------------------------------------------------
                                               10089
(1 row)

:display_all;
     datname      | current_version | last_breaking_version 
------------------+-----------------+-----------------------
 cv_test_database |              16 |                    16
 postgres         |              21 |                    21
 system_platform  |              21 |                    21
 template0        |              21 |                    21
 template1        |              21 |                    21
 yugabyte         |           10089 |                 10088
(6 rows)

 datname  | current_version | messages 
----------+-----------------+----------
 yugabyte |           10089 | \x
(1 row)

SELECT yb_increment_db_catalog_version_with_inval_messages(:db_oid, true, '', 10);
 yb_increment_db_catalog_version_with_inval_messages 
-----------------------------------------------------
                                               10090
(1 row)

:display_all;
     datname      | current_version | last_breaking_version 
------------------+-----------------+-----------------------
 cv_test_database |              16 |                    16
 postgres         |              21 |                    21
 system_platform  |              21 |                    21
 template0        |              21 |                    21
 template1        |              21 |                    21
 yugabyte         |           10090 |                 10090
(6 rows)

 datname  | current_version | messages 
----------+-----------------+----------
 yugabyte |           10089 | \x
 yugabyte |           10090 | \x
(2 rows)

-- Wait for the old message row to expire.
SELECT pg_sleep(15);
 pg_sleep 
----------
 
(1 row)

-- Sanity test yb_increment_all_db_catalog_versions_with_inval_messages
SELECT yb_increment_all_db_catalog_versions_with_inval_messages(:db_oid, false, '', 10);
 yb_increment_all_db_catalog_versions_with_inval_messages 
----------------------------------------------------------
                                                    10091
(1 row)

:display_all;
     datname      | current_version | last_breaking_version 
------------------+-----------------+-----------------------
 cv_test_database |              17 |                    16
 postgres         |              22 |                    21
 system_platform  |              22 |                    21
 template0        |              22 |                    21
 template1        |              22 |                    21
 yugabyte         |           10091 |                 10090
(6 rows)

     datname      | current_version | messages 
------------------+-----------------+----------
 cv_test_database |              17 | \x
 postgres         |              22 | \x
 system_platform  |              22 | \x
 template0        |              22 | \x
 template1        |              22 | \x
 yugabyte         |           10091 | \x
(6 rows)

SELECT yb_increment_all_db_catalog_versions_with_inval_messages(:db_oid, false, null, 10);
 yb_increment_all_db_catalog_versions_with_inval_messages 
----------------------------------------------------------
                                                    10092
(1 row)

:display_all;
     datname      | current_version | last_breaking_version 
------------------+-----------------+-----------------------
 cv_test_database |              18 |                    16
 postgres         |              23 |                    21
 system_platform  |              23 |                    21
 template0        |              23 |                    21
 template1        |              23 |                    21
 yugabyte         |           10092 |                 10090
(6 rows)

     datname      | current_version | messages 
------------------+-----------------+----------
 cv_test_database |              18 | 
 cv_test_database |              17 | \x
 postgres         |              22 | \x
 postgres         |              23 | 
 system_platform  |              22 | \x
 system_platform  |              23 | 
 template0        |              22 | \x
 template0        |              23 | 
 template1        |              22 | \x
 template1        |              23 | 
 yugabyte         |           10092 | 
 yugabyte         |           10091 | \x
(12 rows)

SELECT yb_increment_all_db_catalog_versions_with_inval_messages(:db_oid, true, '', 10);
 yb_increment_all_db_catalog_versions_with_inval_messages 
----------------------------------------------------------
                                                    10093
(1 row)

:display_all;
     datname      | current_version | last_breaking_version 
------------------+-----------------+-----------------------
 cv_test_database |              19 |                    19
 postgres         |              24 |                    24
 system_platform  |              24 |                    24
 template0        |              24 |                    24
 template1        |              24 |                    24
 yugabyte         |           10093 |                 10093
(6 rows)

     datname      | current_version | messages 
------------------+-----------------+----------
 cv_test_database |              19 | \x
 cv_test_database |              17 | \x
 cv_test_database |              18 | 
 postgres         |              22 | \x
 postgres         |              23 | 
 postgres         |              24 | \x
 system_platform  |              22 | \x
 system_platform  |              24 | \x
 system_platform  |              23 | 
 template0        |              22 | \x
 template0        |              23 | 
 template0        |              24 | \x
 template1        |              22 | \x
 template1        |              23 | 
 template1        |              24 | \x
 yugabyte         |           10093 | \x
 yugabyte         |           10092 | 
 yugabyte         |           10091 | \x
(18 rows)

SELECT yb_increment_all_db_catalog_versions_with_inval_messages(:db_oid, true, null, 10);
 yb_increment_all_db_catalog_versions_with_inval_messages 
----------------------------------------------------------
                                                    10094
(1 row)

:display_all;
     datname      | current_version | last_breaking_version 
------------------+-----------------+-----------------------
 cv_test_database |              20 |                    20
 postgres         |              25 |                    25
 system_platform  |              25 |                    25
 template0        |              25 |                    25
 template1        |              25 |                    25
 yugabyte         |           10094 |                 10094
(6 rows)

     datname      | current_version | messages 
------------------+-----------------+----------
 cv_test_database |              20 | 
 cv_test_database |              17 | \x
 cv_test_database |              18 | 
 cv_test_database |              19 | \x
 postgres         |              22 | \x
 postgres         |              23 | 
 postgres         |              24 | \x
 postgres         |              25 | 
 system_platform  |              22 | \x
 system_platform  |              25 | 
 system_platform  |              24 | \x
 system_platform  |              23 | 
 template0        |              22 | \x
 template0        |              23 | 
 template0        |              24 | \x
 template0        |              25 | 
 template1        |              22 | \x
 template1        |              23 | 
 template1        |              24 | \x
 template1        |              25 | 
 yugabyte         |           10094 | 
 yugabyte         |           10093 | \x
 yugabyte         |           10092 | 
 yugabyte         |           10091 | \x
(24 rows)

-- Wait for the old message row to expire.
SELECT pg_sleep(15);
 pg_sleep 
----------
 
(1 row)

SELECT yb_increment_all_db_catalog_versions_with_inval_messages(:db_oid, false, '', 10);
 yb_increment_all_db_catalog_versions_with_inval_messages 
----------------------------------------------------------
                                                    10095
(1 row)

:display_all;
     datname      | current_version | last_breaking_version 
------------------+-----------------+-----------------------
 cv_test_database |              21 |                    20
 postgres         |              26 |                    25
 system_platform  |              26 |                    25
 template0        |              26 |                    25
 template1        |              26 |                    25
 yugabyte         |           10095 |                 10094
(6 rows)

     datname      | current_version | messages 
------------------+-----------------+----------
 cv_test_database |              21 | \x
 postgres         |              26 | \x
 system_platform  |              26 | \x
 template0        |              26 | \x
 template1        |              26 | \x
 yugabyte         |           10095 | \x
(6 rows)

SELECT yb_increment_all_db_catalog_versions_with_inval_messages(:db_oid, true, '', 10);
 yb_increment_all_db_catalog_versions_with_inval_messages 
----------------------------------------------------------
                                                    10096
(1 row)

:display_all;
     datname      | current_version | last_breaking_version 
------------------+-----------------+-----------------------
 cv_test_database |              22 |                    22
 postgres         |              27 |                    27
 system_platform  |              27 |                    27
 template0        |              27 |                    27
 template1        |              27 |                    27
 yugabyte         |           10096 |                 10096
(6 rows)

     datname      | current_version | messages 
------------------+-----------------+----------
 cv_test_database |              22 | \x
 cv_test_database |              21 | \x
 postgres         |              26 | \x
 postgres         |              27 | \x
 system_platform  |              26 | \x
 system_platform  |              27 | \x
 template0        |              26 | \x
 template0        |              27 | \x
 template1        |              26 | \x
 template1        |              27 | \x
 yugabyte         |           10096 | \x
 yugabyte         |           10095 | \x
(12 rows)

-- Without specifying tables, ANALYZE update statistics for all tables.
-- Verify catalog version bumps once for every table.
ANALYZE;
:display_catalog_version;
 current_version | last_breaking_version 
-----------------+-----------------------
           10169 |                 10096
(1 row)

-- It is best to add any new test before this block ('ANALYZE;'). This minimizes the
-- changes required to the expected output when introducing a new catalog table.
