CALL TEST_reset();
SELECT yb_xcluster_ddl_replication.get_replication_role();
 get_replication_role 
----------------------
 source
(1 row)

CREATE TABLE products (
    id INT PRIMARY KEY,
    category TEXT,
    price NUMERIC
);
CREATE MATERIALIZED VIEW product_summary AS
  SELECT category, COUNT(*) as item_count
  FROM products
  GROUP BY category;
COMMENT ON MATERIALIZED VIEW product_summary
  IS 'Stores the total count of products per category.';
ALTER MATERIALIZED VIEW product_summary RENAME TO product_inventory;
REFRESH MATERIALIZED VIEW product_inventory;
DROP MATERIALIZED VIEW product_inventory;
SELECT yb_data FROM public.TEST_filtered_ddl_queue() ORDER BY ddl_end_time;
                                                                                                                                                                    yb_data                                                                                                                                                                    
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"user": "yugabyte", "query": "CREATE TABLE products (\n    id INT PRIMARY KEY,\n    category TEXT,\n    price NUMERIC\n)", "schema": "public", "version": 1, "command_tag": "CREATE TABLE", "new_rel_map": [{"rel_name": "products", "relfile_oid": "***", "rel_namespace": "public"}]}
 {"user": "yugabyte", "query": "CREATE MATERIALIZED VIEW product_summary AS\n  SELECT category, COUNT(*) as item_count\n  FROM products\n  GROUP BY category", "schema": "public", "version": 1, "command_tag": "CREATE MATERIALIZED VIEW", "new_rel_map": [{"rel_name": "product_summary", "relfile_oid": "***", "rel_namespace": "public"}]}
 {"user": "yugabyte", "query": "COMMENT ON MATERIALIZED VIEW product_summary\n  IS 'Stores the total count of products per category.'", "schema": "public", "version": 1, "command_tag": "COMMENT"}
 {"user": "yugabyte", "query": "ALTER MATERIALIZED VIEW product_summary RENAME TO product_inventory", "schema": "public", "version": 1, "command_tag": "ALTER MATERIALIZED VIEW"}
 {"user": "yugabyte", "query": "REFRESH MATERIALIZED VIEW product_inventory", "schema": "public", "version": 1, "command_tag": "REFRESH MATERIALIZED VIEW", "new_rel_map": [{"rel_name": "product_inventory", "relfile_oid": "***", "rel_namespace": "public"}]}
 {"user": "yugabyte", "query": "DROP MATERIALIZED VIEW product_inventory", "schema": "public", "version": 1, "command_tag": "DROP MATERIALIZED VIEW"}
(6 rows)

-- Test dropping materialized views using other DROP commands
-- DROP SCHEMA
CREATE SCHEMA IF NOT EXISTS permanent_schema;
CREATE TABLE permanent_schema.my_table (id INT);
CREATE MATERIALIZED VIEW permanent_schema.my_mview AS SELECT 'hello' AS greeting;
DROP SCHEMA permanent_schema CASCADE;
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to materialized view permanent_schema.my_mview
drop cascades to table permanent_schema.my_table
-- DROP ROLE
CREATE ROLE drop_me_role;
SET ROLE drop_me_role;
CREATE TEMP TABLE my_temp_object (id INT);
CREATE MATERIALIZED VIEW my_mview AS SELECT 'hello' AS greeting;
RESET ROLE;
DROP OWNED BY drop_me_role; -- fail due to temp object
ERROR:  cannot drop temporary and permanent objects in one command
DETAIL:  This database is being replicated using xCluster automatic mode, which does not support DDLs that simultaneously drop both temporary and permanent objects.
HINT:  Drop the temporary objects separately from the permanent ones using multiple commands.
SET ROLE drop_me_role;
DROP TABLE my_temp_object;
CREATE TABLE real_table (id INT);
RESET ROLE;
DROP OWNED BY drop_me_role; -- should succeed now
SELECT yb_data FROM public.TEST_filtered_ddl_queue() ORDER BY ddl_end_time;
                                                                                                                                                                    yb_data                                                                                                                                                                    
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"user": "yugabyte", "query": "CREATE TABLE products (\n    id INT PRIMARY KEY,\n    category TEXT,\n    price NUMERIC\n)", "schema": "public", "version": 1, "command_tag": "CREATE TABLE", "new_rel_map": [{"rel_name": "products", "relfile_oid": "***", "rel_namespace": "public"}]}
 {"user": "yugabyte", "query": "CREATE MATERIALIZED VIEW product_summary AS\n  SELECT category, COUNT(*) as item_count\n  FROM products\n  GROUP BY category", "schema": "public", "version": 1, "command_tag": "CREATE MATERIALIZED VIEW", "new_rel_map": [{"rel_name": "product_summary", "relfile_oid": "***", "rel_namespace": "public"}]}
 {"user": "yugabyte", "query": "COMMENT ON MATERIALIZED VIEW product_summary\n  IS 'Stores the total count of products per category.'", "schema": "public", "version": 1, "command_tag": "COMMENT"}
 {"user": "yugabyte", "query": "ALTER MATERIALIZED VIEW product_summary RENAME TO product_inventory", "schema": "public", "version": 1, "command_tag": "ALTER MATERIALIZED VIEW"}
 {"user": "yugabyte", "query": "REFRESH MATERIALIZED VIEW product_inventory", "schema": "public", "version": 1, "command_tag": "REFRESH MATERIALIZED VIEW", "new_rel_map": [{"rel_name": "product_inventory", "relfile_oid": "***", "rel_namespace": "public"}]}
 {"user": "yugabyte", "query": "DROP MATERIALIZED VIEW product_inventory", "schema": "public", "version": 1, "command_tag": "DROP MATERIALIZED VIEW"}
 {"user": "yugabyte", "query": "CREATE SCHEMA IF NOT EXISTS permanent_schema", "schema": "public", "version": 1, "command_tag": "CREATE SCHEMA"}
 {"user": "yugabyte", "query": "CREATE TABLE permanent_schema.my_table (id INT)", "schema": "public", "version": 1, "command_tag": "CREATE TABLE", "new_rel_map": [{"rel_name": "my_table", "relfile_oid": "***", "rel_namespace": "permanent_schema"}]}
 {"user": "yugabyte", "query": "CREATE MATERIALIZED VIEW permanent_schema.my_mview AS SELECT 'hello' AS greeting", "schema": "public", "version": 1, "command_tag": "CREATE MATERIALIZED VIEW", "new_rel_map": [{"rel_name": "my_mview", "relfile_oid": "***", "rel_namespace": "permanent_schema"}]}
 {"user": "yugabyte", "query": "DROP SCHEMA permanent_schema CASCADE", "schema": "public", "version": 1, "command_tag": "DROP SCHEMA"}
 {"user": "drop_me_role", "query": "CREATE MATERIALIZED VIEW my_mview AS SELECT 'hello' AS greeting", "schema": "public", "version": 1, "command_tag": "CREATE MATERIALIZED VIEW", "new_rel_map": [{"rel_name": "my_mview", "relfile_oid": "***", "rel_namespace": "public"}]}
 {"user": "drop_me_role", "query": "CREATE TABLE real_table (id INT)", "schema": "public", "version": 1, "command_tag": "CREATE TABLE", "new_rel_map": [{"rel_name": "real_table", "relfile_oid": "***", "rel_namespace": "public"}]}
 {"user": "yugabyte", "query": "DROP OWNED BY drop_me_role", "schema": "public", "version": 1, "command_tag": "DROP OWNED"}
(13 rows)

select * from TEST_verify_replicated_ddls();
 test_verify_replicated_ddls 
-----------------------------
 t
(1 row)

