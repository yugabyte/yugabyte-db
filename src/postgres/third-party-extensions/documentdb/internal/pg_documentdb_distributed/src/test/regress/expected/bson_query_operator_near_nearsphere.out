SET citus.next_shard_id TO 523000;
SET documentdb.next_collection_id TO 5230;
SET documentdb.next_collection_index_id TO 5230;
SET search_path to documentdb_api_catalog;
SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 1, "a": { "b": [ 0, 0]} }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 2, "a": { "b": [ 1.1, 1.1]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 3, "a": { "b": [ 2.29, 2.29]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 4, "a": { "b": [ 3.31, 3.31]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 5, "a": { "b": [ 4.42, 4.42]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 6, "a": { "b": [ 5.5, 5.5]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 7, "a": { "b": [ 6.66, 6.66]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 8, "a": { "b": [ 7.74, 7.74]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 9, "a": { "b": [ 8.81, 8.81]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 10, "a": { "geo": {"type": "Point", "coordinates": [35.3, 35.4]}} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 11, "a": { "geo": {"type": "LineString", "coordinates": [[35.36, 35.42], [32.3, 30]]}} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 12, "a": { "geo": {"type": "Polygon", "coordinates": [[[35.73, 35.74], [38.6, 35.3], [38.7, 39.2], [35.73, 35.74]]]}} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 13, "a": { "geo": {"type": "MultiPoint", "coordinates": [[35.43, 35.44], [32.3, 30.3]]}} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 14, "a": { "geo": {"type": "MultiLineString", "coordinates": [[[35.83, 35.84], [32.3, 30.6]]]}} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere','{ "_id": 15, "a": { "geo": {"type": "MultiPolygon", "coordinates": [[[[35.312, 35.441], [38.644, 35.3231], [38.71, 39.32], [35.312, 35.441]]]]}} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- $near and $nearSphere enforce index usage
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "near_sphere", "indexes": [{"key": {"a.b": "2d"}, "name": "my_2d_ab_idx" }, {"key": {"a.b": "2dsphere"}, "name": "my_2ds_ab_idx" }, {"key": {"a.geo": "2dsphere"}, "name": "my_2ds_ageo_idx" }]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "4" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_distributed_test_helpers.drop_primary_key('db','near_sphere');
 drop_primary_key 
---------------------------------------------------------------------
 
(1 row)

SELECT * FROM documentdb_distributed_test_helpers.get_collection_indexes('db', 'near_sphere') ORDER BY collection_id, index_id;
 collection_id | index_id |                                                               index_spec_as_bson                                                                | index_is_valid 
---------------------------------------------------------------------
          5230 |     5231 | { "v" : { "$numberInt" : "2" }, "key" : { "a.b" : "2d" }, "name" : "my_2d_ab_idx" }                                                             | t
          5230 |     5232 | { "v" : { "$numberInt" : "2" }, "key" : { "a.b" : "2dsphere" }, "name" : "my_2ds_ab_idx", "2dsphereIndexVersion" : { "$numberInt" : "3" } }     | t
          5230 |     5233 | { "v" : { "$numberInt" : "2" }, "key" : { "a.geo" : "2dsphere" }, "name" : "my_2ds_ageo_idx", "2dsphereIndexVersion" : { "$numberInt" : "3" } } | t
(3 rows)

-- validations
-- $near/$nearSphere tests
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [0] } }}');
ERROR:  invalid argument in geo near query: 0
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"$geometry": {"type": "Point", "coordinates": [0]}}}}}');
ERROR:  invalid argument in geo near query: coordinates
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$hello": 1}}}}');
ERROR:  invalid argument in geo near query: $hello
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"$geometry": {"type": "Point"}}}}}');
ERROR:  $near requires geojson point, given { "type" : "Point" }
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"$geometry": {"tide": "Point", "coordintes": [1,1]}}}}}');
ERROR:  $near requires geojson point, given { "tide" : "Point", "coordintes" : [ 1, 1 ] }
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {}}}}');
ERROR:  $geometry is required for geo near query
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": []}}}');
ERROR:  $geometry is required for geo near query
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"tide": "Point", "coordintes": [1,1]}}}}');
ERROR:  invalid argument in geo near query: tide
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"x": 1, "coordinates": [1,1]}}}}');
ERROR:  invalid argument in geo near query: x
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"x": "a", "y": 1}}}}');
ERROR:  invalid argument in geo near query: x
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [0] } }}');
ERROR:  invalid argument in geo near query: 0
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0]}}}}}');
ERROR:  invalid argument in geo near query: coordinates
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$hello": 1}}}}');
ERROR:  invalid argument in geo near query: $hello
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"type": "Point"}}}}}');
ERROR:  $near requires geojson point, given { "type" : "Point" }
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"tide": "Point", "coordintes": [1,1]}}}}}');
ERROR:  $near requires geojson point, given { "tide" : "Point", "coordintes" : [ 1, 1 ] }
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {}}}}');
ERROR:  $geometry is required for geo near query
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": []}}}');
ERROR:  $geometry is required for geo near query
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"tide": "Point", "coordintes": [1,1]}}}}');
ERROR:  invalid argument in geo near query: tide
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"x": 1, "coordinates": [1,1]}}}}');
ERROR:  invalid argument in geo near query: x
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"x": "a", "y": 1}}}}');
ERROR:  invalid argument in geo near query: x
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"coordinates": [1,1]}}, "b": { "$nearSphere": {"coordinates": [1,1]}}}}');
ERROR:  Too many geoNear expressions
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"coordinates": [1,1]}}, "b": { "$nearSphere": {"coordinates": [1,1]}}}}');
ERROR:  Too many geoNear expressions
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"coordinates": [1,1]}}, "b": { "$near": {"coordinates": [1,1]}}}}');
ERROR:  Too many geoNear expressions
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "near_sphere", "pipeline": [ { "$sort": { "a.b": 1 }}, { "$match": { "a.b": { "$near": {"coordinates": [1,1]}}}} ], "cursor": {} }');
ERROR:  $geoNear, $near, and $nearSphere are not allowed in this context
-- $near/$nearSphere with invalid distance argument
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [1, 1], "$minDistance": -1}}}');
ERROR:  minDistance must be nonnegative
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [1, 1], "$minDistance": {"$numberDouble": "NaN"}}}}');
ERROR:  minDistance must be non-negative
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"$geometry": {"coordinates": [1, 1]}, "$minDistance": {"$numberDouble": "Infinity"}}}}}');
ERROR:  minDistance must be non-negative
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"$geometry": {"coordinates": [1, 1]}, "$maxDistance": {"$numberDouble": "Infinity"}}}}}');
ERROR:  maxDistance must be non-negative
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [1, 1], "$maxDistance": {"$numberDouble": "-Infinity"}}}}');
ERROR:  maxDistance must be nonnegative
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [1, 1], "$maxDistance": {"$numberDouble": "-NaN"}}}}');
ERROR:  maxDistance must be non-negative
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [1, 1], "$minDistance": -1}}}');
ERROR:  minDistance must be nonnegative
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [1, 1], "$minDistance": {"$numberDouble": "NaN"}}}}');
ERROR:  minDistance must be non-negative
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"coordinates": [1, 1]}, "$minDistance": {"$numberDouble": "Infinity"}}}}}');
ERROR:  minDistance must be non-negative
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"coordinates": [1, 1]}, "$maxDistance": {"$numberDouble": "Infinity"}}}}}');
ERROR:  maxDistance must be non-negative
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [1, 1], "$maxDistance": {"$numberDouble": "-Infinity"}}}}');
ERROR:  maxDistance must be nonnegative
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [1, 1], "$maxDistance": {"$numberDouble": "-NaN"}}}}');
ERROR:  maxDistance must be non-negative
-- invalid places to call $near/$nearSphere
SELECT document FROM documentdb_api.collection('db','near_sphere') WHERE document @@ '{ "a.b": { "$elemMatch" : {"$near": [1,1] }}}';
ERROR:  $geoNear, $near, and $nearSphere are not allowed in this context, as these operators require sorting geospatial data. If you do not need sort, consider using $geoWithin instead.
SELECT document FROM documentdb_api.collection('db','near_sphere') WHERE document @@ '{ "$or": [{"a.b": {"$near": [1,1] }},{"t": 1}]}';
ERROR:  geo $near must be top-level expr
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": {}, "projection": { "p" : {"$elemMatch": {"geo": {"$near": [1,1]}}}}}');
ERROR:  $geoNear, $near, and $nearSphere are not allowed in this context, as these operators require sorting geospatial data. If you do not need sort, consider using $geoWithin instead.
SELECT documentdb_api.update('db', '{"update":"near_sphere", "updates":[{"q":{},"u":{"$set": {"a.$[elem].b": 1}},"multi":false,"upsert":true, "arrayFilters": [{"elem.geo": {"$near": [1, 1]}}]}]}');
                                                                                                                                                                                                                          update                                                                                                                                                                                                                          
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberLong"" : ""0"" }, ""n"" : { ""$numberLong"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""21757981"" }, ""errmsg"" : ""$geoNear, $near, and $nearSphere are not allowed in this context, as these operators require sorting geospatial data. If you do not need sort, consider using $geoWithin instead."" } ] }",f)
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "near_sphere", "indexes": [{"key": {"t": 1}, "name": "my_invalid_idx", "partialFilterExpression": {"geo": {"$near": [1,1]}} }]}', true);
ERROR:  Error in specification { "key" : { "t" : 1 }, "name" : "my_invalid_idx", "partialFilterExpression" : { "geo" : { "$near" : [ 1, 1 ] } } } :: caused by :: $geoNear, $near, and $nearSphere are not allowed in this context
BEGIN;
-- $near operator
-- Test with legacy coordinate pair
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [0, 0]}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [0, 0], "$minDistance": 6}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [0, 0], "$maxDistance": 6}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [0, 0], "$minDistance": 5, "$maxDistance": 8}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [0, 0, 6]}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"x": 0, "y": 0}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"x": 0, "y": 0, "z": 6}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
(4 rows)

-- Test with GeoJson point
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"type": "Point", "coordinates": [0, 0]}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 700000}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"type": "Point", "coordinates": [0, 0]}, "$maxDistance": 1000000}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 500000, "$maxDistance": 1500000}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(6 rows)

-- Test with GeoJson point with $geometry
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"$geometry": {"type": "Point", "coordinates": [0, 0]}}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 700000}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$maxDistance": 1000000}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 500000, "$maxDistance": 1500000}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(6 rows)

-- Test order of documents
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [5, 6]}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"coordinates": [5, 6]}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
(9 rows)

-- $nearSphere operator
-- Test with legacy coordinate pair
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [0, 0]}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [0, 0], "$minDistance": 0.1}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [0, 0], "$maxDistance": 0.15}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [0, 0], "$minDistance": 0.16, "$maxDistance": 0.2}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [0, 0, 0.15]}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"x": 0, "y": 0}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"x": 0, "y": 0, "z": 0.15}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(6 rows)

-- Test with GeoJson point
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 700000}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}, "$maxDistance": 1000000}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 500000, "$maxDistance": 1500000}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(6 rows)

-- Test with GeoJson point with $geometry
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 700000}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$maxDistance": 1000000}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 500000, "$maxDistance": 1500000}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(6 rows)

-- Test order of documents
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [5, 6]}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"coordinates": [5, 6]}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
(9 rows)

-- Test with GeoJson objects in documents
-- Test with GeoJson point
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 5000000}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}, "$maxDistance": 5000000}}}');
                                                                                                                                                     document                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 4500000, "$maxDistance": 5000000}}}');
                                                                                                                                                     document                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
(3 rows)

-- Test with GeoJson point with $geometry
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}}}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 5000000}}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$maxDistance": 5000000}}}}');
                                                                                                                                                     document                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 4500000, "$maxDistance": 5000000}}}}');
                                                                                                                                                     document                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
(3 rows)

-- Test order of documents
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": { "type": "Point", "coordinates": [5, 6] }}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"coordinates": [5, 6]}}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(6 rows)

-- Verify that @@ operator handles the near / nearSphere operators
SELECT document FROM documentdb_api.collection('db', 'near_sphere') WHERE document @@ '{ "a.b": { "$near": [5, 6]}}';
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
(9 rows)

SELECT document FROM documentdb_api.collection('db', 'near_sphere') WHERE document @@ '{ "a.b": { "$near": [5, 6]}}';
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
(9 rows)

SELECT document FROM documentdb_api.collection('db', 'near_sphere') WHERE document @@ '{ "a.geo": { "$nearSphere": [5, 6]}}';
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(6 rows)

SELECT document FROM documentdb_api.collection('db', 'near_sphere') WHERE document @@ '{ "a.geo": { "$nearSphere": {"coordinates": [5, 6]}}}';
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(6 rows)

-- Explain tests to ensure index pushdown
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [0, 0]}}}');
                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                 
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_5230_523006 collection WHERE ((documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) IS NOT NULL) AND (shard_key_value OPERATOR(pg_catalog.=) '5230'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist" }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_2d_ab_idx on documentdb_data.documents_5230_523006 collection
               Output: document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist" }'::documentdb_core.bson)
               Order By: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist" }'::documentdb_core.bson)
(10 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [0, 0], "$minDistance": 5, "$maxDistance": 8}}}');
                                                                                                                                                                                                                                                                                                                                                                                                                                          QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                           
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_5230_523006 collection WHERE (((documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) IS NOT NULL) AND (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberInt" : "5" }, "maxDistance" : { "$numberInt" : "8" }, "distanceField" : "dist" } }'::documentdb_core.bson)) AND (shard_key_value OPERATOR(pg_catalog.=) '5230'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberInt" : "5" }, "maxDistance" : { "$numberInt" : "8" }, "distanceField" : "dist" }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_2d_ab_idx on documentdb_data.documents_5230_523006 collection
               Output: document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberInt" : "5" }, "maxDistance" : { "$numberInt" : "8" }, "distanceField" : "dist" }'::documentdb_core.bson)
               Index Cond: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberInt" : "5" }, "maxDistance" : { "$numberInt" : "8" }, "distanceField" : "dist" } }'::documentdb_core.bson)
               Order By: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberInt" : "5" }, "maxDistance" : { "$numberInt" : "8" }, "distanceField" : "dist" }'::documentdb_core.bson)
(11 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"type": "Point", "coordinates": [0, 0]}}}}');
                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_5230_523006 collection WHERE ((documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) IS NOT NULL) AND (shard_key_value OPERATOR(pg_catalog.=) '5230'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_2ds_ab_idx on documentdb_data.documents_5230_523006 collection
               Output: document, (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
               Order By: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
(10 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 500000, "$maxDistance": 1500000}}}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_5230_523006 collection WHERE (((documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) IS NOT NULL) AND (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true } }'::documentdb_core.bson)) AND (shard_key_value OPERATOR(pg_catalog.=) '5230'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_2ds_ab_idx on documentdb_data.documents_5230_523006 collection
               Output: document, (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
               Index Cond: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true } }'::documentdb_core.bson)
               Order By: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
(11 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [0, 0]}}}');
                                                                                                                                                                                                                                           QUERY PLAN                                                                                                                                                                                                                                           
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_5230_523006 collection WHERE ((documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) IS NOT NULL) AND (shard_key_value OPERATOR(pg_catalog.=) '5230'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_2d_ab_idx on documentdb_data.documents_5230_523006 collection
               Output: document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
               Order By: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
(10 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [0, 0], "$minDistance": 0.8, "$maxDistance": 1}}}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_5230_523006 collection WHERE (((documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) IS NOT NULL) AND (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberDouble" : "0.80000000000000004441" }, "maxDistance" : { "$numberInt" : "1" }, "distanceField" : "dist", "spherical" : true } }'::documentdb_core.bson)) AND (shard_key_value OPERATOR(pg_catalog.=) '5230'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberDouble" : "0.80000000000000004441" }, "maxDistance" : { "$numberInt" : "1" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_2d_ab_idx on documentdb_data.documents_5230_523006 collection
               Output: document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberDouble" : "0.80000000000000004441" }, "maxDistance" : { "$numberInt" : "1" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
               Index Cond: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberDouble" : "0.80000000000000004441" }, "maxDistance" : { "$numberInt" : "1" }, "distanceField" : "dist", "spherical" : true } }'::documentdb_core.bson)
               Order By: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberDouble" : "0.80000000000000004441" }, "maxDistance" : { "$numberInt" : "1" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
(11 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}}}}');
                                                                                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_5230_523006 collection WHERE ((documentdb_api_catalog.bson_validate_geography(document, 'a.geo'::text) IS NOT NULL) AND (shard_key_value OPERATOR(pg_catalog.=) '5230'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geography(document, 'a.geo'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.geo", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_2ds_ageo_idx on documentdb_data.documents_5230_523006 collection
               Output: document, (documentdb_api_catalog.bson_validate_geography(document, 'a.geo'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.geo", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
               Order By: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a.geo'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.geo", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
(10 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 500000, "$maxDistance": 1500000}}}}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_5230_523006 collection WHERE (((documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) IS NOT NULL) AND (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true } }'::documentdb_core.bson)) AND (shard_key_value OPERATOR(pg_catalog.=) '5230'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_2ds_ab_idx on documentdb_data.documents_5230_523006 collection
               Output: document, (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
               Index Cond: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true } }'::documentdb_core.bson)
               Order By: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
(11 rows)

ROLLBACK;
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": [0, 0]}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(6 rows)

-- check update
BEGIN;
SELECT documentdb_api.update('db', '{"update":"near_sphere", "updates":[{"q":{"a.b": {"$near": [1,1]}} ,"u":{"$set": {"t": 1}},"multi":false,"upsert":false}]}');
                                                                                                                                                                 update                                                                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberLong"" : ""0"" }, ""n"" : { ""$numberLong"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""21757981"" }, ""errmsg"" : ""$geoNear, $near, and $nearSphere are not allowed in this context"" } ] }",f)
(1 row)

SELECT documentdb_api.update('db', '{"update":"near_sphere", "updates":[{"q":{"a.b": {"$near": [1.1,1.1]}} ,"u":{"$set": {"t": 1}},"multi":false,"upsert":false}]}');
                                                                                                                                                                 update                                                                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberLong"" : ""0"" }, ""n"" : { ""$numberLong"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""21757981"" }, ""errmsg"" : ""$geoNear, $near, and $nearSphere are not allowed in this context"" } ] }",f)
(1 row)

SELECT documentdb_api.update('db', '{"update":"near_sphere", "updates":[{"q":{"a.b": {"$near": [1,1]}} ,"u":{"$set": {"t": 1}},"multi":true,"upsert":false}]}');
                                                                                                                                                                 update                                                                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberLong"" : ""0"" }, ""n"" : { ""$numberLong"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""21757981"" }, ""errmsg"" : ""$geoNear, $near, and $nearSphere are not allowed in this context"" } ] }",f)
(1 row)

ROLLBACK;
-- Shard the collection
SELECT documentdb_api.shard_collection('db', 'near_sphere', '{"_id": "hashed"}', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

BEGIN;
SET LOCAL enable_seqscan to off;
set local citus.enable_local_execution TO OFF;
SET LOCAL seq_page_cost TO 9999999;
-- $near operator
-- Test with legacy coordinate pair
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [0, 0]}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [0, 0], "$minDistance": 6}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [0, 0], "$maxDistance": 6}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [0, 0], "$minDistance": 5, "$maxDistance": 8}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"x": 0, "y": 0}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"x": 0, "y": 0, "z": 6}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
(4 rows)

-- Test with GeoJson point
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"type": "Point", "coordinates": [0, 0]}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 700000}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"type": "Point", "coordinates": [0, 0]}, "$maxDistance": 1000000}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 500000, "$maxDistance": 1500000}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(6 rows)

-- Test with GeoJson point with $geometry
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"$geometry": {"type": "Point", "coordinates": [0, 0]}}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 700000}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$maxDistance": 1000000}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 500000, "$maxDistance": 1500000}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(6 rows)

-- Test order of documents
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [5, 6]}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"coordinates": [5, 6]}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
(9 rows)

-- $nearSphere operator
-- Test with legacy coordinate pair
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [0, 0]}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [0, 0], "$minDistance": 0.1}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [0, 0], "$maxDistance": 0.15}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [0, 0], "$minDistance": 0.16, "$maxDistance": 0.2}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"x": 0, "y": 0}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"x": 0, "y": 0, "z": 0.15}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(6 rows)

-- Test with GeoJson point
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 700000}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}, "$maxDistance": 1000000}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 500000, "$maxDistance": 1500000}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(6 rows)

-- Test with GeoJson point with $geometry
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 700000}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$maxDistance": 1000000}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 500000, "$maxDistance": 1500000}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
(6 rows)

-- Test order of documents
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [5, 6]}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"coordinates": [5, 6]}}}}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
(9 rows)

-- Test with GeoJson objects in documents
-- Test with legacy coordinate pair
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": [0, 0]}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": [0, 0], "$minDistance": 0.8}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": [0, 0], "$maxDistance": 0.8}}}');
                                                                                                                                                     document                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": [0, 0], "$minDistance": 0.8, "$maxDistance": 1}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(3 rows)

-- Test with GeoJson point
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 5000000}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}, "$maxDistance": 5000000}}}');
                                                                                                                                                     document                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 4500000, "$maxDistance": 5000000}}}');
                                                                                                                                                     document                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
(3 rows)

-- Test with GeoJson point with $geometry
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}}}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 5000000}}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$maxDistance": 5000000}}}}');
                                                                                                                                                     document                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 4500000, "$maxDistance": 5000000}}}}');
                                                                                                                                                     document                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
(3 rows)

-- Test order of documents
SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": [5, 6]}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(6 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"coordinates": [5, 6]}}}}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.300000000000000711" } ] ] } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberDouble" : "30.600000000000001421" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } } }
(6 rows)

-- Explain tests to ensure index pushdown
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [0, 0]}}}');
                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                       
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist" }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_5230_523016 collection WHERE (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) IS NOT NULL)
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2d_ab_idx on documentdb_data.documents_5230_523016 collection
                     Output: document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist" }'::documentdb_core.bson)
(12 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": [0, 0], "$minDistance": 5, "$maxDistance": 8}}}');
                                                                                                                                                                                                                                                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                 
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberInt" : "5" }, "maxDistance" : { "$numberInt" : "8" }, "distanceField" : "dist" }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_5230_523016 collection WHERE ((documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) IS NOT NULL) AND (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberInt" : "5" }, "maxDistance" : { "$numberInt" : "8" }, "distanceField" : "dist" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2d_ab_idx on documentdb_data.documents_5230_523016 collection
                     Output: document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberInt" : "5" }, "maxDistance" : { "$numberInt" : "8" }, "distanceField" : "dist" }'::documentdb_core.bson)
                     Index Cond: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberInt" : "5" }, "maxDistance" : { "$numberInt" : "8" }, "distanceField" : "dist" } }'::documentdb_core.bson)
(13 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"type": "Point", "coordinates": [0, 0]}}}}');
                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_5230_523016 collection WHERE (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) IS NOT NULL)
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2ds_ab_idx on documentdb_data.documents_5230_523016 collection
                     Output: document, (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
(12 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$near": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 500000, "$maxDistance": 1500000}}}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_5230_523016 collection WHERE ((documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) IS NOT NULL) AND (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2ds_ab_idx on documentdb_data.documents_5230_523016 collection
                     Output: document, (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
                     Index Cond: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true } }'::documentdb_core.bson)
(13 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [0, 0]}}}');
                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                 
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_5230_523016 collection WHERE (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) IS NOT NULL)
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2d_ab_idx on documentdb_data.documents_5230_523016 collection
                     Output: document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
(12 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": [0, 0], "$minDistance": 0.8, "$maxDistance": 1}}}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                            QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                             
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberDouble" : "0.80000000000000004441" }, "maxDistance" : { "$numberInt" : "1" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_5230_523016 collection WHERE ((documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) IS NOT NULL) AND (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberDouble" : "0.80000000000000004441" }, "maxDistance" : { "$numberInt" : "1" }, "distanceField" : "dist", "spherical" : true } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2d_ab_idx on documentdb_data.documents_5230_523016 collection
                     Output: document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberDouble" : "0.80000000000000004441" }, "maxDistance" : { "$numberInt" : "1" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
                     Index Cond: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "minDistance" : { "$numberDouble" : "0.80000000000000004441" }, "maxDistance" : { "$numberInt" : "1" }, "distanceField" : "dist", "spherical" : true } }'::documentdb_core.bson)
(13 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.geo": { "$nearSphere": {"type": "Point", "coordinates": [0, 0]}}}}');
                                                                                                                                                                                                                                        QUERY PLAN                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, (documentdb_api_catalog.bson_validate_geography(document, 'a.geo'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.geo", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_5230_523016 collection WHERE (documentdb_api_catalog.bson_validate_geography(document, 'a.geo'::text) IS NOT NULL)
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2ds_ageo_idx on documentdb_data.documents_5230_523016 collection
                     Output: document, (documentdb_api_catalog.bson_validate_geography(document, 'a.geo'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.geo", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
(12 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "near_sphere", "filter": { "a.b": { "$nearSphere": {"$geometry": {"type": "Point", "coordinates": [0, 0]}, "$minDistance": 500000, "$maxDistance": 1500000}}}}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_5230_523016 collection WHERE ((documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) IS NOT NULL) AND (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2ds_ab_idx on documentdb_data.documents_5230_523016 collection
                     Output: document, (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true }'::documentdb_core.bson)
                     Index Cond: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "key" : "a.b", "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "minDistance" : { "$numberInt" : "500000" }, "maxDistance" : { "$numberInt" : "1500000" }, "distanceField" : "dist", "spherical" : true } }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
-- update with sharded
BEGIN;
SELECT documentdb_api.update('db', '{"update":"near_sphere", "updates":[{"q":{"a.b": {"$near": [1,1]}} ,"u":{"$set": {"t": 1}},"multi":true,"upsert":false}]}');
                                                                                                                                                                 update                                                                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberLong"" : ""0"" }, ""n"" : { ""$numberLong"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""21757981"" }, ""errmsg"" : ""$geoNear, $near, and $nearSphere are not allowed in this context"" } ] }",f)
(1 row)

ROLLBACK;
-- Test near and nearsphere with different sorting features.
SELECT documentdb_api.insert_one('db','near_sphere_distinct','{ "_id": 1, "zone": 1, "loc": { "type": "Point", "coordinates": [-20, -20]} }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere_distinct','{ "_id": 2, "zone": 2, "loc": { "type": "Point", "coordinates": [-10, -10]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere_distinct','{ "_id": 3, "zone": 3, "loc": { "type": "Point", "coordinates": [0, 0]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere_distinct','{ "_id": 4, "zone": 4, "loc": { "type": "Point", "coordinates": [10, 10]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere_distinct','{ "_id": 5, "zone": 5, "loc": { "type": "Point", "coordinates": [20, 20]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere_distinct','{ "_id": 6, "zone": 1, "loc": { "type": "Point", "coordinates": [-20, -20]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere_distinct','{ "_id": 7, "zone": 2, "loc": { "type": "Point", "coordinates": [-10, -10]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere_distinct','{ "_id": 8, "zone": 3, "loc": { "type": "Point", "coordinates": [0, 0]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere_distinct','{ "_id": 9, "zone": 4, "loc": { "type": "Point", "coordinates": [10, 10]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere_distinct','{ "_id": 10, "zone": 5, "loc": { "type": "Point", "coordinates": [20, 20]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','near_sphere_distinct','{ "_id": 11, "zone": 6, "loc": { "type": "Point", "coordinates": [30, 30]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "near_sphere_distinct", "indexes": [{"key": {"loc.coordinates": "2d"}, "name": "my_2d_loccoord_idx" }]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT document FROM bson_aggregation_distinct('db', '{ "distinct": "near_sphere_distinct", "key": "zone", "query": {"loc.coordinates": { "$near": [0, 0], "$maxDistance": 1}} }');
                                   document                                    
---------------------------------------------------------------------
 { "values" : [ { "$numberInt" : "3" } ], "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- find and modify fails with geonear
-- With sort on findAndModify with near, sort takes precedence
SELECT documentdb_api.find_and_modify('db', '{"findAndModify": "near_sphere_distinct", "query": { "loc.coordinates": { "$near": [0, 0], "$maxDistance": 1} }, "sort": {"_id": -1}, "update": {"a": 10}, "fields": {"_id": 1}}');
ERROR:  $geoNear, $near, and $nearSphere are not allowed in this context
CONTEXT:  SQL statement "SELECT ctid, object_id, document FROM documentdb_data.documents_5231_523025 WHERE shard_key_value = $1 AND document OPERATOR(documentdb_api_catalog.@@) $2::documentdb_core.bson ORDER BY documentdb_api_catalog.bson_orderby(document, $3::documentdb_core.bson) DESC LIMIT 1 FOR UPDATE"
SQL statement " SELECT documentdb_api_internal.update_worker($1, $2, $3, $4::documentdb_core.bson, $5::documentdb_core.bsonsequence, $6) FROM documentdb_data.documents_5231 WHERE shard_key_value = 5231"
-- If no sort clause then near decides the ordering
SELECT documentdb_api.find_and_modify('db', '{"findAndModify": "near_sphere_distinct", "query": { "loc.coordinates": { "$near": [30, 30]} }, "update": {"a": 10}, "fields": {"_id": 1}}');
ERROR:  $geoNear, $near, and $nearSphere are not allowed in this context
CONTEXT:  SQL statement "SELECT ctid, object_id, document FROM documentdb_data.documents_5231_523025 WHERE shard_key_value = $1 AND document OPERATOR(documentdb_api_catalog.@@) $2::documentdb_core.bson LIMIT 1 FOR UPDATE"
SQL statement " SELECT documentdb_api_internal.update_worker($1, $2, $3, $4::documentdb_core.bson, $5::documentdb_core.bsonsequence, $6) FROM documentdb_data.documents_5231 WHERE shard_key_value = 5231"
