SET search_path TO documentdb_core,documentdb_api,documentdb_api_catalog,documentdb_api_internal;
SET citus.next_shard_id TO 5900000;
SET documentdb.next_collection_id TO 5900;
SET documentdb.next_collection_index_id TO 5900;
-- $hour, $minute, $second, $millisecond: simple
SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-01-01T07:30:10.5Z"}}', '{"hour": {"$hour": "$date"}, "minute": {"$minute": "$date"}, "second": {"$second": "$date"}, "ms": {"$millisecond": "$date"}}');
                                                             bson_dollar_project                                                              
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "7" }, "minute" : { "$numberInt" : "30" }, "second" : { "$numberInt" : "10" }, "ms" : { "$numberInt" : "500" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-01-01T10:30:10.5Z"}}', '{"hour": {"$hour": [ "$date" ]}, "minute": {"$minute": [ "$date" ]}, "second": {"$second": [ "$date" ]}, "ms": {"$millisecond": [ "$date" ]}}');
                                                              bson_dollar_project                                                              
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "10" }, "minute" : { "$numberInt" : "30" }, "second" : { "$numberInt" : "10" }, "ms" : { "$numberInt" : "500" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-01-01T23:59:59.28Z"}}', '{"hour": {"$hour": { "date": "$date" }}, "minute": {"$minute": { "date": "$date" }}, "second": {"$second": { "date": "$date" }}, "ms": {"$millisecond": { "date": "$date" }}}');
                                                              bson_dollar_project                                                              
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "23" }, "minute" : { "$numberInt" : "59" }, "second" : { "$numberInt" : "59" }, "ms" : { "$numberInt" : "280" } }
(1 row)

-- 2022-12-14T01:28:46.000Z
SELECT * FROM bson_dollar_project('{"date": {"$oid" : "639926cee6bda3127f153bf1" } }', '{"hour": {"$hour": { "date": "$date" }}, "minute": {"$minute": { "date": "$date" }}, "second": {"$second": { "date": "$date" }}, "ms": {"$millisecond": { "date": "$date" }}}');
                                                            bson_dollar_project                                                             
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "1" }, "minute" : { "$numberInt" : "28" }, "second" : { "$numberInt" : "46" }, "ms" : { "$numberInt" : "0" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$timestamp" : { "t": 1670981326, "i": 1 } } }', '{"hour": {"$hour": { "date": "$date" }}, "minute": {"$minute": { "date": "$date" }}, "second": {"$second": { "date": "$date" }}, "ms": {"$millisecond": { "date": "$date" }}}');
                                                            bson_dollar_project                                                             
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "1" }, "minute" : { "$numberInt" : "28" }, "second" : { "$numberInt" : "46" }, "ms" : { "$numberInt" : "0" } }
(1 row)

-- 2022-12-14T01:31:47.000Z
SELECT * FROM bson_dollar_project('{"date": {"$oid" : "63992783f5e4d92817ef6ccc" } }', '{"hour": {"$hour": { "date": "$date" }}, "minute": {"$minute": { "date": "$date" }}, "second": {"$second": { "date": "$date" }}, "ms": {"$millisecond": { "date": "$date" }}}');
                                                            bson_dollar_project                                                             
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "1" }, "minute" : { "$numberInt" : "31" }, "second" : { "$numberInt" : "47" }, "ms" : { "$numberInt" : "0" } }
(1 row)

-- $hour, $minute, $second, $millisecond: with timezone
SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-01-01T00:00:01.000Z"}, "tz": "+08:05"}', '{"hour": {"$hour": { "date": "$date",  "timezone":  "$tz" }}, "minute": {"$minute": { "date": "$date",  "timezone":  "$tz" }}, "second": {"$second": { "date": "$date",  "timezone":  "$tz" }}, "ms": {"$millisecond": { "date": "$date",  "timezone":  "$tz" }}}');
                                                           bson_dollar_project                                                            
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "8" }, "minute" : { "$numberInt" : "5" }, "second" : { "$numberInt" : "1" }, "ms" : { "$numberInt" : "0" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-01-01T00:00:00.001Z"}, "tz": "-08:05"}', '{"hour": {"$hour": { "date": "$date",  "timezone":  "$tz" }}, "minute": {"$minute": { "date": "$date",  "timezone":  "$tz" }}, "second": {"$second": { "date": "$date",  "timezone":  "$tz" }}, "ms": {"$millisecond": { "date": "$date",  "timezone":  "$tz" }}}');
                                                            bson_dollar_project                                                             
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "15" }, "minute" : { "$numberInt" : "55" }, "second" : { "$numberInt" : "0" }, "ms" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-01-01T00:00:01.000Z"}, "tz": "-08"}', '{"hour": {"$hour": { "date": "$date",  "timezone":  "$tz" }}, "minute": {"$minute": { "date": "$date",  "timezone":  "$tz" }}, "second": {"$second": { "date": "$date",  "timezone":  "$tz" }}, "ms": {"$millisecond": { "date": "$date",  "timezone":  "$tz" }}}');
                                                            bson_dollar_project                                                            
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "16" }, "minute" : { "$numberInt" : "0" }, "second" : { "$numberInt" : "1" }, "ms" : { "$numberInt" : "0" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-01-01T00:00:01.000Z"}, "tz": "-0801"}', '{"hour": {"$hour": { "date": "$date",  "timezone":  "$tz" }}, "minute": {"$minute": { "date": "$date",  "timezone":  "$tz" }}, "second": {"$second": { "date": "$date",  "timezone":  "$tz" }}, "ms": {"$millisecond": { "date": "$date",  "timezone":  "$tz" }}}');
                                                            bson_dollar_project                                                             
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "15" }, "minute" : { "$numberInt" : "59" }, "second" : { "$numberInt" : "1" }, "ms" : { "$numberInt" : "0" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-01-01T00:00:01.020Z"}, "tz": "+1210"}', '{"hour": {"$hour": { "date": "$date",  "timezone":  "$tz" }}, "minute": {"$minute": { "date": "$date",  "timezone":  "$tz" }}, "second": {"$second": { "date": "$date",  "timezone":  "$tz" }}, "ms": {"$millisecond": { "date": "$date",  "timezone":  "$tz" }}}');
                                                             bson_dollar_project                                                             
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "12" }, "minute" : { "$numberInt" : "10" }, "second" : { "$numberInt" : "1" }, "ms" : { "$numberInt" : "20" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-01-01T00:00:01.000Z"}, "tz": "UTC"}', '{"hour": {"$hour": { "date": "$date",  "timezone":  "$tz" }}, "minute": {"$minute": { "date": "$date",  "timezone":  "$tz" }}, "second": {"$second": { "date": "$date",  "timezone":  "$tz" }}, "ms": {"$millisecond": { "date": "$date",  "timezone":  "$tz" }}}');
                                                           bson_dollar_project                                                            
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "0" }, "minute" : { "$numberInt" : "0" }, "second" : { "$numberInt" : "1" }, "ms" : { "$numberInt" : "0" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-01-01T00:00:01.000Z"}, "tz": "+00"}', '{"hour": {"$hour": { "date": "$date",  "timezone":  "$tz" }}, "minute": {"$minute": { "date": "$date",  "timezone":  "$tz" }}, "second": {"$second": { "date": "$date",  "timezone":  "$tz" }}, "ms": {"$millisecond": { "date": "$date",  "timezone":  "$tz" }}}');
                                                           bson_dollar_project                                                            
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "0" }, "minute" : { "$numberInt" : "0" }, "second" : { "$numberInt" : "1" }, "ms" : { "$numberInt" : "0" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-01-01T00:00:01.000Z"}, "tz": "+0000"}', '{"hour": {"$hour": { "date": "$date",  "timezone":  "$tz" }}, "minute": {"$minute": { "date": "$date",  "timezone":  "$tz" }}, "second": {"$second": { "date": "$date",  "timezone":  "$tz" }}, "ms": {"$millisecond": { "date": "$date",  "timezone":  "$tz" }}}');
                                                           bson_dollar_project                                                            
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "0" }, "minute" : { "$numberInt" : "0" }, "second" : { "$numberInt" : "1" }, "ms" : { "$numberInt" : "0" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-01-01T00:00:01.000Z"}, "tz": "-00:00"}', '{"hour": {"$hour": { "date": "$date",  "timezone":  "$tz" }}, "minute": {"$minute": { "date": "$date",  "timezone":  "$tz" }}, "second": {"$second": { "date": "$date",  "timezone":  "$tz" }}, "ms": {"$millisecond": { "date": "$date",  "timezone":  "$tz" }}}');
                                                           bson_dollar_project                                                            
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "0" }, "minute" : { "$numberInt" : "0" }, "second" : { "$numberInt" : "1" }, "ms" : { "$numberInt" : "0" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-01-01T00:00:01.201Z"}, "tz": "US/Pacific"}', '{"hour": {"$hour": { "date": "$date",  "timezone":  "$tz" }}, "minute": {"$minute": { "date": "$date",  "timezone":  "$tz" }}, "second": {"$second": { "date": "$date",  "timezone":  "$tz" }}, "ms": {"$millisecond": { "date": "$date",  "timezone":  "$tz" }}}');
                                                             bson_dollar_project                                                             
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "16" }, "minute" : { "$numberInt" : "0" }, "second" : { "$numberInt" : "1" }, "ms" : { "$numberInt" : "201" } }
(1 row)

-- should observe daylight savings or not
SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-06-01T00:00:01.201Z"}, "tz": "US/Pacific"}', '{"hour": {"$hour": { "date": "$date",  "timezone":  "$tz" }}, "minute": {"$minute": { "date": "$date",  "timezone":  "$tz" }}, "second": {"$second": { "date": "$date",  "timezone":  "$tz" }}, "ms": {"$millisecond": { "date": "$date",  "timezone":  "$tz" }}}');
                                                             bson_dollar_project                                                             
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "17" }, "minute" : { "$numberInt" : "0" }, "second" : { "$numberInt" : "1" }, "ms" : { "$numberInt" : "201" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-12-01T00:00:01.201Z"}, "tz": "US/Pacific"}', '{"hour": {"$hour": { "date": "$date",  "timezone":  "$tz" }}, "minute": {"$minute": { "date": "$date",  "timezone":  "$tz" }}, "second": {"$second": { "date": "$date",  "timezone":  "$tz" }}, "ms": {"$millisecond": { "date": "$date",  "timezone":  "$tz" }}}');
                                                             bson_dollar_project                                                             
---------------------------------------------------------------------
 { "hour" : { "$numberInt" : "16" }, "minute" : { "$numberInt" : "0" }, "second" : { "$numberInt" : "1" }, "ms" : { "$numberInt" : "201" } }
(1 row)

-- $year, $month, $dayOfMonth: simple
SELECT * FROM bson_dollar_project('{"date": {"$date": "2005-01-01T07:30:10.5Z"}}', '{"year": {"$year": "$date"}, "month": {"$month": "$date"}, "dayOfMonth": {"$dayOfMonth": "$date"}}');
                                               bson_dollar_project                                               
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "2005" }, "month" : { "$numberInt" : "1" }, "dayOfMonth" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2999-02-28T10:30:10.5Z"}}', '{"year": {"$year": [ "$date" ]}, "month": {"$month": [ "$date" ]}, "dayOfMonth": {"$dayOfMonth": [ "$date" ]}}');
                                               bson_dollar_project                                                
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "2999" }, "month" : { "$numberInt" : "2" }, "dayOfMonth" : { "$numberInt" : "28" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "1930-12-31T23:59:59.28Z"}}', '{"year": {"$year": { "date": "$date" }}, "month": {"$month": { "date": "$date" }}, "dayOfMonth": {"$dayOfMonth": { "date": "$date" }}}');
                                                bson_dollar_project                                                
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "1930" }, "month" : { "$numberInt" : "12" }, "dayOfMonth" : { "$numberInt" : "31" } }
(1 row)

-- 2022-12-14T01:28:46.000Z
SELECT * FROM bson_dollar_project('{"date": {"$oid" : "639926cee6bda3127f153bf1" }}', '{"year": {"$year": { "date": "$date" }}, "month": {"$month": { "date": "$date" }}, "dayOfMonth": {"$dayOfMonth": { "date": "$date" }}}');
                                                bson_dollar_project                                                
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "2022" }, "month" : { "$numberInt" : "12" }, "dayOfMonth" : { "$numberInt" : "14" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$timestamp" : { "t": 1670981326, "i": 1 } }}', '{"year": {"$year": { "date": "$date" }}, "month": {"$month": { "date": "$date" }}, "dayOfMonth": {"$dayOfMonth": { "date": "$date" }}}');
                                                bson_dollar_project                                                
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "2022" }, "month" : { "$numberInt" : "12" }, "dayOfMonth" : { "$numberInt" : "14" } }
(1 row)

-- $year, $month, $dayOfMonth: with timezone
SELECT * FROM bson_dollar_project('{"date": {"$date": "1930-12-31T23:59:59.28Z"}, "tz": "+01"}', '{"year": {"$year": { "date": "$date", "timezone": "$tz" }}, "month": {"$month": { "date": "$date", "timezone": "$tz" }}, "dayOfMonth": {"$dayOfMonth": { "date": "$date", "timezone": "$tz" }}}');
                                               bson_dollar_project                                               
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "1931" }, "month" : { "$numberInt" : "1" }, "dayOfMonth" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "1930-12-31T11:59:00.000Z"}, "tz": "+12"}', '{"year": {"$year": { "date": "$date", "timezone": "$tz" }}, "month": {"$month": { "date": "$date", "timezone": "$tz" }}, "dayOfMonth": {"$dayOfMonth": { "date": "$date", "timezone": "$tz" }}}');
                                                bson_dollar_project                                                
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "1930" }, "month" : { "$numberInt" : "12" }, "dayOfMonth" : { "$numberInt" : "31" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "1930-12-31T11:59:00.000Z"}, "tz": "+12:01"}', '{"year": {"$year": { "date": "$date", "timezone": "$tz" }}, "month": {"$month": { "date": "$date", "timezone": "$tz" }}, "dayOfMonth": {"$dayOfMonth": { "date": "$date", "timezone": "$tz" }}}');
                                               bson_dollar_project                                               
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "1931" }, "month" : { "$numberInt" : "1" }, "dayOfMonth" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "1930-12-31T11:59:00.000Z"}, "tz": "-1159"}', '{"year": {"$year": { "date": "$date", "timezone": "$tz" }}, "month": {"$month": { "date": "$date", "timezone": "$tz" }}, "dayOfMonth": {"$dayOfMonth": { "date": "$date", "timezone": "$tz" }}}');
                                                bson_dollar_project                                                
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "1930" }, "month" : { "$numberInt" : "12" }, "dayOfMonth" : { "$numberInt" : "31" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "1930-12-31T11:59:00.000Z"}, "tz": "-12"}', '{"year": {"$year": { "date": "$date", "timezone": "$tz" }}, "month": {"$month": { "date": "$date", "timezone": "$tz" }}, "dayOfMonth": {"$dayOfMonth": { "date": "$date", "timezone": "$tz" }}}');
                                                bson_dollar_project                                                
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "1930" }, "month" : { "$numberInt" : "12" }, "dayOfMonth" : { "$numberInt" : "30" } }
(1 row)

-- $week and $isoWeek 
-- $week range is 0-53, weeks are from Sunday-Saturday, and the 1st of the year starts on the first Sunday of the year, so any day of that year before
-- the first Sunday, is week 0.
-- $isoWeek follows ISO 8601, ranges is 1-53, weeks are Monday-Sunday, and the 1st of the year is the week that contains the year's first Thursday.
-- 2023-01-01 is first Sunday of the year.
SELECT * FROM bson_dollar_project('{"date": {"$date": "2023-01-01T07:30:10.5Z"}}', '{"week": {"$week": "$date"}, "isoWeek": {"$isoWeek": "$date"}}');
                           bson_dollar_project                            
---------------------------------------------------------------------
 { "week" : { "$numberInt" : "1" }, "isoWeek" : { "$numberInt" : "52" } }
(1 row)

-- 2023-01-08 is second Sunday of the year.
SELECT * FROM bson_dollar_project('{"date": {"$date": "2023-01-08T07:30:10.5Z"}}', '{"week": {"$week": "$date"}, "isoWeek": {"$isoWeek": "$date"}}');
                           bson_dollar_project                           
---------------------------------------------------------------------
 { "week" : { "$numberInt" : "2" }, "isoWeek" : { "$numberInt" : "1" } }
(1 row)

-- 2022-01-01 is Saturday
SELECT * FROM bson_dollar_project('{"date": {"$date": "2022-01-01T07:30:10.5Z"}}', '{"week": {"$week": {"date": "$date"}}, "isoWeek": {"$isoWeek": { "date": "$date"}}}');
                           bson_dollar_project                            
---------------------------------------------------------------------
 { "week" : { "$numberInt" : "0" }, "isoWeek" : { "$numberInt" : "52" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2022-12-31T07:30:10.5Z"}}', '{"week": [ {"$week": "$date"} ], "isoWeek": [ {"$isoWeek": "$date"} ]}');
                                bson_dollar_project                                
---------------------------------------------------------------------
 { "week" : [ { "$numberInt" : "52" } ], "isoWeek" : [ { "$numberInt" : "52" } ] }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2012-12-31T07:30:10.5Z"}}', '{"week": [ {"$week": "$date"} ], "isoWeek": [ {"$isoWeek": "$date"} ]}');
                               bson_dollar_project                                
---------------------------------------------------------------------
 { "week" : [ { "$numberInt" : "53" } ], "isoWeek" : [ { "$numberInt" : "1" } ] }
(1 row)

-- $week and $isoWeek: leap year
SELECT * FROM bson_dollar_project('{"date": {"$date": "2020-12-31T07:30:10.5Z"}}', '{"week": [ {"$week": "$date"} ], "isoWeek": [ {"$isoWeek": "$date"} ]}');
                                bson_dollar_project                                
---------------------------------------------------------------------
 { "week" : [ { "$numberInt" : "52" } ], "isoWeek" : [ { "$numberInt" : "53" } ] }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2000-12-31T07:30:10.5Z"}}', '{"week": [ {"$week": "$date"} ], "isoWeek": [ {"$isoWeek": "$date"} ]}');
                                bson_dollar_project                                
---------------------------------------------------------------------
 { "week" : [ { "$numberInt" : "53" } ], "isoWeek" : [ { "$numberInt" : "52" } ] }
(1 row)

-- $dayOfYear
SELECT * FROM bson_dollar_project('{"date": {"$date": "2023-01-01T07:30:10.5Z"}}', '{"dayOfYear": {"$dayOfYear": "$date"}}');
           bson_dollar_project            
---------------------------------------------------------------------
 { "dayOfYear" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2023-01-31T07:30:10.5Z"}}', '{"dayOfYear": {"$dayOfYear": [ "$date" ]}}');
            bson_dollar_project            
---------------------------------------------------------------------
 { "dayOfYear" : { "$numberInt" : "31" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2023-02-28T07:30:10.5Z"}}', '{"dayOfYear": {"$dayOfYear": { "date": "$date" }}}');
            bson_dollar_project            
---------------------------------------------------------------------
 { "dayOfYear" : { "$numberInt" : "59" } }
(1 row)

-- $dayOfYear: leap year should add 1 day
SELECT * FROM bson_dollar_project('{"leapDate": {"$date": "2024-03-01T07:30:10.5Z"}, "nonLeapDate": {"$date": "2023-03-01T07:30:10.5Z"}}', '{"leapDayOfYear": {"$dayOfYear": { "date": "$leapDate" }}, "nonLeapDayOfYear": {"$dayOfYear": { "date": "$nonLeapDate" }}}');
                                     bson_dollar_project                                     
---------------------------------------------------------------------
 { "leapDayOfYear" : { "$numberInt" : "61" }, "nonLeapDayOfYear" : { "$numberInt" : "60" } }
(1 row)

SELECT * FROM bson_dollar_project('{"leapDate": {"$date": "2024-12-31T07:30:10.5Z"}, "nonLeapDate": {"$date": "2023-12-31T07:30:10.5Z"}}', '{"leapDayOfYear": {"$dayOfYear": { "date": "$leapDate" }}, "nonLeapDayOfYear": {"$dayOfYear": { "date": "$nonLeapDate" }}}');
                                      bson_dollar_project                                      
---------------------------------------------------------------------
 { "leapDayOfYear" : { "$numberInt" : "366" }, "nonLeapDayOfYear" : { "$numberInt" : "365" } }
(1 row)

-- $dayOfWeek and $isoDayOfWeek
-- $dayOfWeek is between 1 (Sunday) and 7 (Saturday).
-- $isoDayOfWeek is between 1 (Monday) and 7 (Sunday).
SELECT * FROM bson_dollar_project('{"date": {"$date": "2023-01-01T07:30:10.5Z"}}', '{"name": "Sunday", "dayOfWeek": {"$dayOfWeek": "$date"}, "isoDayOfWeek": {"$isoDayOfWeek": "$date"}}');
                                         bson_dollar_project                                          
---------------------------------------------------------------------
 { "name" : "Sunday", "dayOfWeek" : { "$numberInt" : "1" }, "isoDayOfWeek" : { "$numberInt" : "7" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2023-01-02T07:30:10.5Z"}}', '{"name": "Monday", "dayOfWeek": {"$dayOfWeek": "$date"}, "isoDayOfWeek": {"$isoDayOfWeek": "$date"}}');
                                         bson_dollar_project                                          
---------------------------------------------------------------------
 { "name" : "Monday", "dayOfWeek" : { "$numberInt" : "2" }, "isoDayOfWeek" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "1999-02-02T07:30:10.5Z"}}', '{"name": "Tuesday", "dayOfWeek": {"$dayOfWeek": "$date"}, "isoDayOfWeek": {"$isoDayOfWeek": "$date"}}');
                                          bson_dollar_project                                          
---------------------------------------------------------------------
 { "name" : "Tuesday", "dayOfWeek" : { "$numberInt" : "3" }, "isoDayOfWeek" : { "$numberInt" : "2" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2023-03-15T07:30:10.5Z"}}', '{"name": "Wednesday", "dayOfWeek": {"$dayOfWeek": "$date"}, "isoDayOfWeek": {"$isoDayOfWeek": "$date"}}');
                                           bson_dollar_project                                           
---------------------------------------------------------------------
 { "name" : "Wednesday", "dayOfWeek" : { "$numberInt" : "4" }, "isoDayOfWeek" : { "$numberInt" : "3" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-11-29T07:30:10.5Z"}}', '{"name": "Thursday", "dayOfWeek": {"$dayOfWeek": "$date"}, "isoDayOfWeek": {"$isoDayOfWeek": "$date"}}');
                                          bson_dollar_project                                           
---------------------------------------------------------------------
 { "name" : "Thursday", "dayOfWeek" : { "$numberInt" : "5" }, "isoDayOfWeek" : { "$numberInt" : "4" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2028-05-19T07:30:10.5Z"}}', '{"name": "Friday", "dayOfWeek": {"$dayOfWeek": "$date"}, "isoDayOfWeek": {"$isoDayOfWeek": "$date"}}');
                                         bson_dollar_project                                          
---------------------------------------------------------------------
 { "name" : "Friday", "dayOfWeek" : { "$numberInt" : "6" }, "isoDayOfWeek" : { "$numberInt" : "5" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"name": "Saturday", "dayOfWeek": {"$dayOfWeek": "$date"}, "isoDayOfWeek": {"$isoDayOfWeek": "$date"}}');
                                          bson_dollar_project                                           
---------------------------------------------------------------------
 { "name" : "Saturday", "dayOfWeek" : { "$numberInt" : "7" }, "isoDayOfWeek" : { "$numberInt" : "6" } }
(1 row)

-- $year and $isoWeekYear
-- $isoWeekYear returns the ISO 8601 week-numbering year that the date falls in.
SELECT * FROM bson_dollar_project('{"date": {"$date": "2023-01-01T07:30:10.5Z"}}', '{"year": {"$year": "$date"}, "isoWeekYear": {"$isoWeekYear": "$date"}}');
                                bson_dollar_project                                 
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "2023" }, "isoWeekYear" : { "$numberLong" : "2022" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2006-01-01T07:30:10.5Z"}}', '{"year": {"$year": "$date"}, "isoWeekYear": {"$isoWeekYear": "$date"}}');
                                bson_dollar_project                                 
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "2006" }, "isoWeekYear" : { "$numberLong" : "2005" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2006-01-02T07:30:10.5Z"}}', '{"year": {"$year": "$date"}, "isoWeekYear": {"$isoWeekYear": "$date"}}');
                                bson_dollar_project                                 
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "2006" }, "isoWeekYear" : { "$numberLong" : "2006" } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2012-12-31T07:30:10.5Z"}}', '{"year": {"$year": "$date"}, "isoWeekYear": {"$isoWeekYear": "$date"}}');
                                bson_dollar_project                                 
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "2012" }, "isoWeekYear" : { "$numberLong" : "2013" } }
(1 row)

-- date part operators with nested operators
-- add 1 year to the date.
SELECT * FROM bson_dollar_project('{"date": {"$date": "2023-01-01T07:30:10.5Z"}}', '{"year": {"$year": { "$add": ["$date", {"$numberLong": "31540000000"}]}}}');
          bson_dollar_project           
---------------------------------------------------------------------
 { "year" : { "$numberInt" : "2024" } }
(1 row)

-- date part operators, null/undefined date or timezone, should return null.
SELECT * FROM bson_dollar_project('{ }', '{"year": {"$year": null}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "year" : null }
(1 row)

SELECT * FROM bson_dollar_project('{ }', '{"month": {"$month": [ null ]}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "month" : null }
(1 row)

SELECT * FROM bson_dollar_project('{ }', '{"dayOfMonth": {"$dayOfMonth": {"date": null}}}');
   bson_dollar_project   
---------------------------------------------------------------------
 { "dayOfMonth" : null }
(1 row)

SELECT * FROM bson_dollar_project('{ }', '{"dayOfYear": {"$dayOfYear": {"date": "$a"}}}');
  bson_dollar_project   
---------------------------------------------------------------------
 { "dayOfYear" : null }
(1 row)

SELECT * FROM bson_dollar_project('{ }', '{"dayOfWeek": {"$dayOfWeek": {"date": {"$date": "2012-12-31T07:30:10.5Z"}, "timezone": null }}}');
  bson_dollar_project   
---------------------------------------------------------------------
 { "dayOfWeek" : null }
(1 row)

SELECT * FROM bson_dollar_project('{ }', '{"hour": {"$hour": [ "$a" ]}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "hour" : null }
(1 row)

SELECT * FROM bson_dollar_project('{ }', '{"minute": {"$minute": {"date": {"$date": "2012-12-31T07:30:10.5Z"}, "timezone": "$a" }}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "minute" : null }
(1 row)

SELECT * FROM bson_dollar_project('{ }', '{"second": {"$second": [ null ]}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "second" : null }
(1 row)

SELECT * FROM bson_dollar_project('{ }', '{"millisecond": {"$millisecond": "$a"}}');
   bson_dollar_project    
---------------------------------------------------------------------
 { "millisecond" : null }
(1 row)

SELECT * FROM bson_dollar_project('{ }', '{"week": {"$week": {"date": {"$date": "2012-12-31T07:30:10.5Z"}, "timezone": "$a" }}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "week" : null }
(1 row)

SELECT * FROM bson_dollar_project('{ }', '{"isoWeekYear": {"$isoWeekYear": {"date": {"$date": "2012-12-31T07:30:10.5Z"}, "timezone": null }}}');
   bson_dollar_project    
---------------------------------------------------------------------
 { "isoWeekYear" : null }
(1 row)

SELECT * FROM bson_dollar_project('{ }', '{"isoDayOfWeek": {"$isoDayOfWeek": {"date": null}}}');
    bson_dollar_project    
---------------------------------------------------------------------
 { "isoDayOfWeek" : null }
(1 row)

SELECT * FROM bson_dollar_project('{ }', '{"isoWeek": {"$isoWeek": {"date": "$a"}}}');
 bson_dollar_project  
---------------------------------------------------------------------
 { "isoWeek" : null }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2012-12-31T07:30:10.5Z"}}', '{"isoWeek": {"$isoWeek": {"date": "$date", "timezone": "$timezone"}}}');
 bson_dollar_project  
---------------------------------------------------------------------
 { "isoWeek" : null }
(1 row)

-- negative tests for date part operators --
-- date part operators: date expression should be convertible to date: timestamp, object id or date time.
SELECT * FROM bson_dollar_project('{ }', '{"year": {"$year": "str"}}');
ERROR:  can't convert from BSON type string to Date
SELECT * FROM bson_dollar_project('{ }', '{"month": {"$month": true}}');
ERROR:  can't convert from BSON type bool to Date
SELECT * FROM bson_dollar_project('{ }', '{"dayOfMonth": {"$dayOfMonth": false}}');
ERROR:  can't convert from BSON type bool to Date
SELECT * FROM bson_dollar_project('{ }', '{"dayOfYear": {"$dayOfYear": false}}');
ERROR:  can't convert from BSON type bool to Date
SELECT * FROM bson_dollar_project('{ }', '{"dayOfWeek": {"$dayOfWeek": "str"}}');
ERROR:  can't convert from BSON type string to Date
SELECT * FROM bson_dollar_project('{ }', '{"hour": {"$hour": 1}}');
ERROR:  can't convert from BSON type int to Date
SELECT * FROM bson_dollar_project('{ }', '{"minute": {"$minute": 1}}');
ERROR:  can't convert from BSON type int to Date
SELECT * FROM bson_dollar_project('{ }', '{"second": {"$second": 1}}');
ERROR:  can't convert from BSON type int to Date
SELECT * FROM bson_dollar_project('{ }', '{"millisecond": {"$millisecond": 1}}');
ERROR:  can't convert from BSON type int to Date
SELECT * FROM bson_dollar_project('{ }', '{"week": {"$week": [[]]}}');
ERROR:  can't convert from BSON type array to Date
SELECT * FROM bson_dollar_project('{ }', '{"isoWeekYear": {"$isoWeekYear": [[]]}}');
ERROR:  can't convert from BSON type array to Date
SELECT * FROM bson_dollar_project('{ }', '{"isoDayOfWeek": {"$isoDayOfWeek": {"date": {}}}}');
ERROR:  can't convert from BSON type object to Date
SELECT * FROM bson_dollar_project('{ }', '{"isoWeek": {"$isoWeek": {"date": []}}}');
ERROR:  can't convert from BSON type array to Date
SELECT * FROM bson_dollar_project('{"date": {"date": {"$date": "2012-12-31T07:30:10.5Z"} }}', '{"isoWeek": {"$isoWeek": "$date"}}');
ERROR:  can't convert from BSON type object to Date
-- date part operators: timezone argument should be string
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"year": {"$year": {"date": "$date", "timezone": true}}}');
ERROR:  $year requires a string for the timezone argument, but was given a bool (true)
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"month": {"$month": {"date": "$date", "timezone": false}}}');
ERROR:  $month requires a string for the timezone argument, but was given a bool (false)
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"dayOfMonth": {"$dayOfMonth": {"date": "$date", "timezone": []}}}');
ERROR:  $dayOfMonth requires a string for the timezone argument, but was given a array ([  ])
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"dayOfYear": {"$dayOfYear": {"date": "$date", "timezone": 1}}}');
ERROR:  $dayOfYear requires a string for the timezone argument, but was given a int (1)
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"dayOfWeek": {"$dayOfWeek": {"date": "$date", "timezone": {}}}}');
ERROR:  $dayOfWeek requires a string for the timezone argument, but was given a object ({ })
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"hour": {"$hour": {"date": "$date", "timezone": false}}}');
ERROR:  $hour requires a string for the timezone argument, but was given a bool (false)
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"minute": {"$minute": {"date": "$date", "timezone": [[[]]]}}}');
ERROR:  $minute requires a string for the timezone argument, but was given a array ([ [ [  ] ] ])
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"second": {"$second": {"date": "$date", "timezone": {}}}}');
ERROR:  $second requires a string for the timezone argument, but was given a object ({ })
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"millisecond": {"$millisecond": {"date": "$date", "timezone": 1}}}');
ERROR:  $millisecond requires a string for the timezone argument, but was given a int (1)
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"week": {"$week": {"date": "$date", "timezone": {"$date": {"$numberLong": "0"}}}}}');
ERROR:  $week requires a string for the timezone argument, but was given a date ({ "$date" : "1970-01-01T00:00:00Z" })
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"isoWeekYear": {"$isoWeekYear": {"date": "$date", "timezone": {"$oid": "639926cee6bda3127f153bf1"}}}}');
ERROR:  $isoWeekYear requires a string for the timezone argument, but was given a objectId ({ "$oid" : "639926cee6bda3127f153bf1" })
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"isoDayOfWeek": {"$isoDayOfWeek": {"date": "$date", "timezone": true}}}');
ERROR:  $isoDayOfWeek requires a string for the timezone argument, but was given a bool (true)
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"isoWeek": {"$isoWeek": {"date": "$date", "timezone": true}}}');
ERROR:  $isoWeek requires a string for the timezone argument, but was given a bool (true)
-- date part operators: date option must be provided when argument is an object
SELECT * FROM bson_dollar_project('{ }', '{"year": {"$year": {"timezone": true}}}');
ERROR:  missing 'date' argument to $year, provided: $year: { "timezone" : true }
SELECT * FROM bson_dollar_project('{ }', '{"month": {"$month": {}}}');
ERROR:  missing 'date' argument to $month, provided: $month: { }
SELECT * FROM bson_dollar_project('{ }', '{"dayOfMonth": {"$dayOfMonth": {"timezone": []}}}');
ERROR:  missing 'date' argument to $dayOfMonth, provided: $dayOfMonth: { "timezone" : [  ] }
SELECT * FROM bson_dollar_project('{ }', '{"dayOfYear": {"$dayOfYear": {"timezone": 1}}}');
ERROR:  missing 'date' argument to $dayOfYear, provided: $dayOfYear: { "timezone" : 1 }
SELECT * FROM bson_dollar_project('{ }', '{"dayOfWeek": {"$dayOfWeek": {"timezone": {}}}}');
ERROR:  missing 'date' argument to $dayOfWeek, provided: $dayOfWeek: { "timezone" : {  } }
SELECT * FROM bson_dollar_project('{ }', '{"hour": {"$hour": {}}}');
ERROR:  missing 'date' argument to $hour, provided: $hour: { }
SELECT * FROM bson_dollar_project('{ }', '{"minute": {"$minute": {"timezone": [[[]]]}}}');
ERROR:  missing 'date' argument to $minute, provided: $minute: { "timezone" : [ [ [  ] ] ] }
SELECT * FROM bson_dollar_project('{ }', '{"second": {"$second": {"timezone": {}}}}');
ERROR:  missing 'date' argument to $second, provided: $second: { "timezone" : {  } }
SELECT * FROM bson_dollar_project('{ }', '{"millisecond": {"$millisecond": {}}}');
ERROR:  missing 'date' argument to $millisecond, provided: $millisecond: { }
SELECT * FROM bson_dollar_project('{ }', '{"week": {"$week": {"timezone": {"$date": {"$numberLong": "0"}}}}}');
ERROR:  missing 'date' argument to $week, provided: $week: { "timezone" : { "$date" : "1970-01-01T00:00:00Z" } }
SELECT * FROM bson_dollar_project('{ }', '{"isoWeekYear": {"$isoWeekYear": {"timezone": {"$oid": "639926cee6bda3127f153bf1"}}}}');
ERROR:  missing 'date' argument to $isoWeekYear, provided: $isoWeekYear: { "timezone" : { "$oid" : "639926cee6bda3127f153bf1" } }
SELECT * FROM bson_dollar_project('{ }', '{"isoDayOfWeek": {"$isoDayOfWeek": {"timezone": true}}}');
ERROR:  missing 'date' argument to $isoDayOfWeek, provided: $isoDayOfWeek: { "timezone" : true }
SELECT * FROM bson_dollar_project('{ }', '{"isoWeek": {"$isoWeek": {"timezone": true}}}');
ERROR:  missing 'date' argument to $isoWeek, provided: $isoWeek: { "timezone" : true }
-- date part operators: when argument is object only date and timezone keys are accepted.
SELECT * FROM bson_dollar_project('{ }', '{"year": {"$year": {"random": true}}}');
ERROR:  unrecognized option to $year: "random"
SELECT * FROM bson_dollar_project('{ }', '{"month": {"$month": {"foo": 1}}}');
ERROR:  unrecognized option to $month: "foo"
SELECT * FROM bson_dollar_project('{ }', '{"dayOfMonth": {"$dayOfMonth": {"timezone": [], "date": 1, "time": 1}}}');
ERROR:  unrecognized option to $dayOfMonth: "time"
SELECT * FROM bson_dollar_project('{ }', '{"dayOfYear": {"$dayOfYear": {"timezone": 1, "dat": 2}}}');
ERROR:  unrecognized option to $dayOfYear: "dat"
SELECT * FROM bson_dollar_project('{ }', '{"dayOfWeek": {"$dayOfWeek": {"timezon": {}}}}');
ERROR:  unrecognized option to $dayOfWeek: "timezon"
SELECT * FROM bson_dollar_project('{ }', '{"hour": {"$hour": {"datetime": 1}}}');
ERROR:  unrecognized option to $hour: "datetime"
SELECT * FROM bson_dollar_project('{ }', '{"minute": {"$minute": {"timeZone": [[[]]]}}}');
ERROR:  unrecognized option to $minute: "timeZone"
SELECT * FROM bson_dollar_project('{ }', '{"second": {"$second": {"Timezone": {}}}}');
ERROR:  unrecognized option to $second: "Timezone"
SELECT * FROM bson_dollar_project('{ }', '{"millisecond": {"$millisecond": {"unknown": "1"}}}');
ERROR:  unrecognized option to $millisecond: "unknown"
SELECT * FROM bson_dollar_project('{ }', '{"week": {"$week": {"location": {"$date": {"$numberLong": "0"}}}}}');
ERROR:  unrecognized option to $week: "location"
SELECT * FROM bson_dollar_project('{ }', '{"isoWeekYear": {"$isoWeekYear": {"timezonE": {"$oid": "639926cee6bda3127f153bf1"}}}}');
ERROR:  unrecognized option to $isoWeekYear: "timezonE"
SELECT * FROM bson_dollar_project('{ }', '{"isoDayOfWeek": {"$isoDayOfWeek": {"timezone": true, "foo": 1}}}');
ERROR:  unrecognized option to $isoDayOfWeek: "foo"
SELECT * FROM bson_dollar_project('{ }', '{"isoWeek": {"$isoWeek": {"date": 1, "info": ""}}}');
ERROR:  unrecognized option to $isoWeek: "info"
-- date part operators: when argument is array, it only accepts a single element in the array.
SELECT * FROM bson_dollar_project('{ }', '{"year": {"$year": [1, 2, 3]}}');
ERROR:  $year accepts exactly one argument if given an array, but was given 3
SELECT * FROM bson_dollar_project('{ }', '{"month": {"$month": []}}');
ERROR:  $month accepts exactly one argument if given an array, but was given 0
SELECT * FROM bson_dollar_project('{ }', '{"dayOfMonth": {"$dayOfMonth": [1, 2]}}');
ERROR:  $dayOfMonth accepts exactly one argument if given an array, but was given 2
SELECT * FROM bson_dollar_project('{ }', '{"dayOfYear": {"$dayOfYear": [[], []]}}');
ERROR:  $dayOfYear accepts exactly one argument if given an array, but was given 2
SELECT * FROM bson_dollar_project('{ }', '{"dayOfWeek": {"$dayOfWeek": []}}');
ERROR:  $dayOfWeek accepts exactly one argument if given an array, but was given 0
SELECT * FROM bson_dollar_project('{ }', '{"hour": {"$hour": [1, 2, 3, 4]}}');
ERROR:  $hour accepts exactly one argument if given an array, but was given 4
SELECT * FROM bson_dollar_project('{ }', '{"minute": {"$minute": []}}');
ERROR:  $minute accepts exactly one argument if given an array, but was given 0
SELECT * FROM bson_dollar_project('{ }', '{"second": {"$second": ["srr", "foo"]}}');
ERROR:  $second accepts exactly one argument if given an array, but was given 2
SELECT * FROM bson_dollar_project('{ }', '{"millisecond": {"$millisecond": [1, 2]}}');
ERROR:  $millisecond accepts exactly one argument if given an array, but was given 2
SELECT * FROM bson_dollar_project('{ }', '{"week": {"$week": []}}');
ERROR:  $week accepts exactly one argument if given an array, but was given 0
SELECT * FROM bson_dollar_project('{ }', '{"isoWeekYear": {"$isoWeekYear": [1, 2, 3, 4, 5]}}');
ERROR:  $isoWeekYear accepts exactly one argument if given an array, but was given 5
SELECT * FROM bson_dollar_project('{ }', '{"isoDayOfWeek": {"$isoDayOfWeek": []}}');
ERROR:  $isoDayOfWeek accepts exactly one argument if given an array, but was given 0
SELECT * FROM bson_dollar_project('{ }', '{"isoWeek": {"$isoWeek": [1, []]}}');
ERROR:  $isoWeek accepts exactly one argument if given an array, but was given 2
-- date part operators: unrecognized timezones
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"year": {"$year": {"date": "$date", "timezone": ""}}}');
ERROR:  unrecognized time zone identifier: ""
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"year": {"$year": {"date": "$date", "timezone": "\u0000\u0000"}}}');
ERROR:  unrecognized time zone identifier: ""
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"year": {"$year": {"date": "$date", "timezone": "+8"}}}');
ERROR:  unrecognized time zone identifier: "+8"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"month": {"$month": {"date": "$date", "timezone": "+080"}}}');
ERROR:  unrecognized time zone identifier: "+080"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"dayOfMonth": {"$dayOfMonth": {"date": "$date", "timezone": "+08:800"}}}');
ERROR:  unrecognized time zone identifier: "+08:800"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"dayOfYear": {"$dayOfYear": {"date": "$date", "timezone": "-888888"}}}');
ERROR:  unrecognized time zone identifier: "-888888"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"dayOfWeek": {"$dayOfWeek": {"date": "$date", "timezone": "US/Unknown"}}}');
ERROR:  unrecognized time zone identifier: "US/Unknown"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"hour": {"$hour": {"date": "$date", "timezone": "+"}}}');
ERROR:  unrecognized time zone identifier: "+"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"minute": {"$minute": {"date": "$date", "timezone": "08:09"}}}');
ERROR:  unrecognized time zone identifier: "08:09"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"second": {"$second": {"date": "$date", "timezone": "Etc/Invalid"}}}');
ERROR:  unrecognized time zone identifier: "Etc/Invalid"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"millisecond": {"$millisecond": {"date": "$date", "timezone": "US/Pacifi"}}}');
ERROR:  unrecognized time zone identifier: "US/Pacifi"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"week": {"$week": {"date": "$date", "timezone": "America/LosAngeles"}}}');
ERROR:  unrecognized time zone identifier: "America/LosAngeles"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"isoWeekYear": {"$isoWeekYear": {"date": "$date", "timezone": "UST"}}}');
ERROR:  unrecognized time zone identifier: "UST"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"isoDayOfWeek": {"$isoDayOfWeek": {"date": "$date", "timezone": "+080\u00001"}}}');
ERROR:  unrecognized time zone identifier: "+080"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"isoWeek": {"$isoWeek": {"date": "$date", "timezone": "+080\u0000"}}}');
ERROR:  unrecognized time zone identifier: "+080"
-- $dateToParts no timezone
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date" }}}');
                                                                                                                               bson_dollar_project                                                                                                                               
---------------------------------------------------------------------
 { "dateParts" : { "year" : { "$numberInt" : "2017" }, "month" : { "$numberInt" : "6" }, "day" : { "$numberInt" : "19" }, "hour" : { "$numberInt" : "15" }, "minute" : { "$numberInt" : "13" }, "second" : { "$numberInt" : "25" }, "millisecond" : { "$numberInt" : "713" } } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "1990-01-01T23:13:00.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date", "iso8601": true }}}');
                                                                                                                                       bson_dollar_project                                                                                                                                       
---------------------------------------------------------------------
 { "dateParts" : { "isoWeekYear" : { "$numberInt" : "1990" }, "isoWeek" : { "$numberInt" : "1" }, "isoDayOfWeek" : { "$numberInt" : "1" }, "hour" : { "$numberInt" : "23" }, "minute" : { "$numberInt" : "13" }, "second" : { "$numberInt" : "0" }, "millisecond" : { "$numberInt" : "713" } } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "0006-12-31T15:13:25.003Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date" }}}');
                                                                                                                             bson_dollar_project                                                                                                                             
---------------------------------------------------------------------
 { "dateParts" : { "year" : { "$numberInt" : "6" }, "month" : { "$numberInt" : "12" }, "day" : { "$numberInt" : "31" }, "hour" : { "$numberInt" : "15" }, "minute" : { "$numberInt" : "13" }, "second" : { "$numberInt" : "25" }, "millisecond" : { "$numberInt" : "3" } } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "0006-12-31T15:13:25.003Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date", "iso8601": false }}}');
                                                                                                                             bson_dollar_project                                                                                                                             
---------------------------------------------------------------------
 { "dateParts" : { "year" : { "$numberInt" : "6" }, "month" : { "$numberInt" : "12" }, "day" : { "$numberInt" : "31" }, "hour" : { "$numberInt" : "15" }, "minute" : { "$numberInt" : "13" }, "second" : { "$numberInt" : "25" }, "millisecond" : { "$numberInt" : "3" } } }
(1 row)

-- $dateToParts with timezone
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date", "timezone": "UTC" }}}');
                                                                                                                               bson_dollar_project                                                                                                                               
---------------------------------------------------------------------
 { "dateParts" : { "year" : { "$numberInt" : "2017" }, "month" : { "$numberInt" : "6" }, "day" : { "$numberInt" : "19" }, "hour" : { "$numberInt" : "15" }, "minute" : { "$numberInt" : "13" }, "second" : { "$numberInt" : "25" }, "millisecond" : { "$numberInt" : "713" } } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date", "timezone": "Europe/London" }}}');
                                                                                                                               bson_dollar_project                                                                                                                               
---------------------------------------------------------------------
 { "dateParts" : { "year" : { "$numberInt" : "2017" }, "month" : { "$numberInt" : "6" }, "day" : { "$numberInt" : "19" }, "hour" : { "$numberInt" : "16" }, "minute" : { "$numberInt" : "13" }, "second" : { "$numberInt" : "25" }, "millisecond" : { "$numberInt" : "713" } } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date", "timezone": "America/New_York" }}}');
                                                                                                                               bson_dollar_project                                                                                                                               
---------------------------------------------------------------------
 { "dateParts" : { "year" : { "$numberInt" : "2017" }, "month" : { "$numberInt" : "6" }, "day" : { "$numberInt" : "19" }, "hour" : { "$numberInt" : "11" }, "minute" : { "$numberInt" : "13" }, "second" : { "$numberInt" : "25" }, "millisecond" : { "$numberInt" : "713" } } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date", "timezone": "+01" }}}');
                                                                                                                               bson_dollar_project                                                                                                                               
---------------------------------------------------------------------
 { "dateParts" : { "year" : { "$numberInt" : "2017" }, "month" : { "$numberInt" : "6" }, "day" : { "$numberInt" : "19" }, "hour" : { "$numberInt" : "16" }, "minute" : { "$numberInt" : "13" }, "second" : { "$numberInt" : "25" }, "millisecond" : { "$numberInt" : "713" } } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date", "timezone": "-01" }}}');
                                                                                                                               bson_dollar_project                                                                                                                               
---------------------------------------------------------------------
 { "dateParts" : { "year" : { "$numberInt" : "2017" }, "month" : { "$numberInt" : "6" }, "day" : { "$numberInt" : "19" }, "hour" : { "$numberInt" : "14" }, "minute" : { "$numberInt" : "13" }, "second" : { "$numberInt" : "25" }, "millisecond" : { "$numberInt" : "713" } } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date", "timezone": "-0001" }}}');
                                                                                                                               bson_dollar_project                                                                                                                               
---------------------------------------------------------------------
 { "dateParts" : { "year" : { "$numberInt" : "2017" }, "month" : { "$numberInt" : "6" }, "day" : { "$numberInt" : "19" }, "hour" : { "$numberInt" : "15" }, "minute" : { "$numberInt" : "12" }, "second" : { "$numberInt" : "25" }, "millisecond" : { "$numberInt" : "713" } } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}, "tz": "America/New_York"}', '{"dateParts": {"$dateToParts": { "date": "$date", "timezone": "$tz", "iso8601": {"$eq": ["$tz", "America/New_York"]} }}}');
                                                                                                                                        bson_dollar_project                                                                                                                                        
---------------------------------------------------------------------
 { "dateParts" : { "isoWeekYear" : { "$numberInt" : "2017" }, "isoWeek" : { "$numberInt" : "25" }, "isoDayOfWeek" : { "$numberInt" : "1" }, "hour" : { "$numberInt" : "11" }, "minute" : { "$numberInt" : "13" }, "second" : { "$numberInt" : "25" }, "millisecond" : { "$numberInt" : "713" } } }
(1 row)

-- oid == 2017-06-19T15:13:25.713Z UTC.
SELECT * FROM bson_dollar_project('{"_id": {"$oid": "58c7cba47bbadf523cf2c313"}}', '{"dateParts": {"$dateToParts": { "date": "$_id", "timezone": "Europe/London" }}}');
                                                                                                                                                      bson_dollar_project                                                                                                                                                       
---------------------------------------------------------------------
 { "_id" : { "$oid" : "58c7cba47bbadf523cf2c313" }, "dateParts" : { "year" : { "$numberInt" : "2017" }, "month" : { "$numberInt" : "3" }, "day" : { "$numberInt" : "14" }, "hour" : { "$numberInt" : "10" }, "minute" : { "$numberInt" : "53" }, "second" : { "$numberInt" : "24" }, "millisecond" : { "$numberInt" : "0" } } }
(1 row)

-- $dateToParts should return null
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date", "timezone": "$tz" }}}');
  bson_dollar_project   
---------------------------------------------------------------------
 { "dateParts" : null }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date", "timezone": null }}}');
  bson_dollar_project   
---------------------------------------------------------------------
 { "dateParts" : null }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date", "timezone": "UTC", "iso8601": "$iso" }}}');
  bson_dollar_project   
---------------------------------------------------------------------
 { "dateParts" : null }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date", "timezone": "UTC", "iso8601": null }}}');
  bson_dollar_project   
---------------------------------------------------------------------
 { "dateParts" : null }
(1 row)

SELECT * FROM bson_dollar_project('{"_id": 1 }', '{"dateParts": {"$dateToParts": { "date": "$date", "timezone": "UTC", "iso8601": true }}}');
                  bson_dollar_project                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "dateParts" : null }
(1 row)

SELECT * FROM bson_dollar_project('{"_id": 1 }', '{"dateParts": {"$dateToParts": { "date": null, "timezone": "UTC", "iso8601": true }}}');
                  bson_dollar_project                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "dateParts" : null }
(1 row)

-- $dateToParts 'date' argument is required
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "timezone": "$tz" }}}');
ERROR:  Missing 'date' parameter to $dateToParts
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "timezone": "$tz", "iso8601": true }}}');
ERROR:  Missing 'date' parameter to $dateToParts
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "timezone": "Unknown", "iso8601": true }}}');
ERROR:  Missing 'date' parameter to $dateToParts
-- $dateToParts 'iso8601' should be a bool
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date", "iso8601": {"$add": [1, 1]} }}}');
ERROR:  iso8601 must evaluate to a bool, found int
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "$date", "iso8601": "str" }}}');
ERROR:  iso8601 must evaluate to a bool, found string
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": {"$add": [1, 1]}, "iso8601": "str" }}}');
ERROR:  iso8601 must evaluate to a bool, found string
-- $dateToParts 'date' must be a date, timestamp or oid
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date":  {"$add": [1, 1]}, "iso8601": true }}}');
ERROR:  can't convert from BSON type int to Date
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": "str" }}}');
ERROR:  can't convert from BSON type string to Date
-- $dateToParts 'timezone' must be a string
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": {"$add": [1, 1]}, "iso8601": "str", "timezone": 1 }}}');
ERROR:  timezone must evaluate to a string, found int
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateParts": {"$dateToParts": { "date": {"$add": [1, 1]}, "iso8601": "str", "timezone": {"$add": [1]} }}}');
ERROR:  timezone must evaluate to a string, found int
-- $dateToParts 'timezone' is unknown
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"dateToParts": {"$dateToParts": {"date": "$date", "timezone": ""}}}');
ERROR:  unrecognized time zone identifier: ""
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"dateToParts": {"$dateToParts": {"date": "$date", "timezone": "\u0000\u0000"}}}');
ERROR:  unrecognized time zone identifier: ""
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"dateToParts": {"$dateToParts": {"date": "$date", "timezone": "+8"}}}');
ERROR:  unrecognized time zone identifier: "+8"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"dateToParts": {"$dateToParts": {"date": "$date", "timezone": "+080"}}}');
ERROR:  unrecognized time zone identifier: "+080"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"dateToParts": {"$dateToParts": {"date": "$date", "timezone": "+08:800"}}}');
ERROR:  unrecognized time zone identifier: "+08:800"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"dateToParts": {"$dateToParts": {"date": "$date", "timezone": "-888888"}}}');
ERROR:  unrecognized time zone identifier: "-888888"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"dateToParts": {"$dateToParts": {"date": "$date", "timezone": "Ut"}}}');
ERROR:  unrecognized time zone identifier: "Ut"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2035-06-23T07:30:10.5Z"}}', '{"dateToParts": {"$dateToParts": {"date": "$date", "timezone": "Unknown"}}}');
ERROR:  unrecognized time zone identifier: "Unknown"
-- $dateToString no timezone default format
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateString": {"$dateToString": { "date": "$date" }}}');
              bson_dollar_project              
---------------------------------------------------------------------
 { "dateString" : "2017-06-19T15:13:25.713Z" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "0006-06-01T00:01:02.003Z"}}', '{"dateString": {"$dateToString": { "date": "$date" }}}');
              bson_dollar_project              
---------------------------------------------------------------------
 { "dateString" : "0006-06-01T00:01:02.003Z" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "0906-06-01T08:01:02.023Z"}}', '{"dateString": {"$dateToString": { "date": "$date" }}}');
              bson_dollar_project              
---------------------------------------------------------------------
 { "dateString" : "0906-06-01T08:01:02.023Z" }
(1 row)

-- $dateToString with timezone default format
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "timezone": "UTC" }}}');
              bson_dollar_project              
---------------------------------------------------------------------
 { "dateString" : "2017-06-19T15:13:25.713Z" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "timezone": "America/Los_Angeles" }}}');
              bson_dollar_project              
---------------------------------------------------------------------
 { "dateString" : "2017-06-19T08:13:25.713Z" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-01-19T15:13:25.713Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "timezone": "America/Los_Angeles" }}}');
              bson_dollar_project              
---------------------------------------------------------------------
 { "dateString" : "2017-01-19T07:13:25.713Z" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "timezone": "Europe/London" }}}');
              bson_dollar_project              
---------------------------------------------------------------------
 { "dateString" : "2017-06-19T16:13:25.713Z" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-01-19T15:13:25.713Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "timezone": "Europe/London" }}}');
              bson_dollar_project              
---------------------------------------------------------------------
 { "dateString" : "2017-01-19T15:13:25.713Z" }
(1 row)

-- $dateToString random formats
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%d%d***%d***%d**%d*%d" }}}');
            bson_dollar_project             
---------------------------------------------------------------------
 { "dateString" : "1919***19***19**19*19" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "0006-06-01T00:01:02.003Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%%%%%%%%%%%%%%%%%%---%Y---%%%%%%%%%%%%" }}}');
              bson_dollar_project               
---------------------------------------------------------------------
 { "dateString" : "%%%%%%%%%---0006---%%%%%%" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "0906-06-01T08:01:02.023Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "This is a custom format:\u0000....%Y-%d-%m....\u0000"}}}');
                             bson_dollar_project                             
---------------------------------------------------------------------
 { "dateString" : "This is a custom format:\u0000....0906-01-06....\u0000" }
(1 row)

-- $dateToString timezone specifiers
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-06-19T15:13:25.713Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "UTC offset: %z (%Z minutes)", "timezone": "America/Los_Angeles" }}}');
                  bson_dollar_project                  
---------------------------------------------------------------------
 { "dateString" : "UTC offset: -0700 (-420 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-01-19T15:13:25.713Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "UTC offset: %z (%Z minutes)","timezone": "America/Los_Angeles" }}}');
                  bson_dollar_project                  
---------------------------------------------------------------------
 { "dateString" : "UTC offset: -0800 (-480 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-01-19T15:13:25.713Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "UTC offset: %z (%Z minutes)","timezone": "Africa/Asmera" }}}');
                 bson_dollar_project                  
---------------------------------------------------------------------
 { "dateString" : "UTC offset: +0300 (180 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-01-19T15:13:25.713Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "UTC offset: %z (%Z minutes)","timezone": "+08" }}}');
                 bson_dollar_project                  
---------------------------------------------------------------------
 { "dateString" : "UTC offset: +0800 (480 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-01-19T15:13:25.713Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "UTC offset: %z (%Z minutes)","timezone": "+0059" }}}');
                 bson_dollar_project                 
---------------------------------------------------------------------
 { "dateString" : "UTC offset: +0059 (59 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-01-19T15:13:25.713Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "UTC offset: %z (%Z minutes)","timezone": "+5959" }}}');
                  bson_dollar_project                  
---------------------------------------------------------------------
 { "dateString" : "UTC offset: +5959 (3599 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-01-19T15:13:25.713Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "UTC offset: %z (%Z minutes)","timezone": "-00:01" }}}');
                 bson_dollar_project                 
---------------------------------------------------------------------
 { "dateString" : "UTC offset: -0001 (-1 minutes)" }
(1 row)

-- $dateToString multiple timezones
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%Y-%m-%d %H:%M:%S %z (%Z minutes)", "timezone": "UTC" }}}');
                    bson_dollar_project                     
---------------------------------------------------------------------
 { "dateString" : "2017-07-04 14:56:42 +0000 (0 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%Y-%m-%d %H:%M:%S %z (%Z minutes)", "timezone": "Europe/London" }}}');
                     bson_dollar_project                     
---------------------------------------------------------------------
 { "dateString" : "2017-07-04 15:56:42 +0100 (60 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%Y-%m-%d %H:%M:%S %z (%Z minutes)", "timezone": "America/New_York" }}}');
                      bson_dollar_project                      
---------------------------------------------------------------------
 { "dateString" : "2017-07-04 10:56:42 -0400 (-240 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%Y-%m-%d %H:%M:%S %z (%Z minutes)", "timezone": "Australia/Eucla" }}}');
                     bson_dollar_project                      
---------------------------------------------------------------------
 { "dateString" : "2017-07-04 23:41:42 +0845 (525 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%Y-%m-%d %H:%M:%S %z (%Z minutes)", "timezone": "Asia/Katmandu" }}}');
                     bson_dollar_project                      
---------------------------------------------------------------------
 { "dateString" : "2017-07-04 20:41:42 +0545 (345 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%Y-%m-%d %H:%M:%S %z (%Z minutes)", "timezone": "Europe/Amsterdam" }}}');
                     bson_dollar_project                      
---------------------------------------------------------------------
 { "dateString" : "2017-07-04 16:56:42 +0200 (120 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "1900-07-10T11:41:22.418Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%Y-%m-%d %H:%M:%S %z (%Z minutes)", "timezone": "America/Caracas" }}}');
                      bson_dollar_project                      
---------------------------------------------------------------------
 { "dateString" : "1900-07-10 07:13:42 -0427 (-267 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-01-04T15:08:51.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%Y-%m-%d %H:%M:%S %z (%Z minutes)", "timezone": "America/New_York" }}}');
                      bson_dollar_project                      
---------------------------------------------------------------------
 { "dateString" : "2017-01-04 10:08:51 -0500 (-300 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T15:09:12.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%Y-%m-%d %H:%M:%S %z (%Z minutes)", "timezone": "America/New_York" }}}');
                      bson_dollar_project                      
---------------------------------------------------------------------
 { "dateString" : "2017-07-04 11:09:12 -0400 (-240 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-12-04T15:09:14.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%Y-%m-%d %H:%M:%S %z (%Z minutes)", "timezone": "America/New_York" }}}');
                      bson_dollar_project                      
---------------------------------------------------------------------
 { "dateString" : "2017-12-04 10:09:14 -0500 (-300 minutes)" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-12-04T15:09:14.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%Y-%m-%d %H:%M:%S %z (%Z minutes)" }}}');
                    bson_dollar_project                     
---------------------------------------------------------------------
 { "dateString" : "2017-12-04 15:09:14 +0000 (0 minutes)" }
(1 row)

-- $dateToString natural vs iso dates
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-01-01T15:08:51.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "Natural: %Y-W%w-%U-d%j, ISO: %G-W%u-%V-d%j" }}}');
                         bson_dollar_project                         
---------------------------------------------------------------------
 { "dateString" : "Natural: 2017-W1-01-d001, ISO: 2016-W7-52-d001" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T15:09:12.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "Natural: %Y-W%w-%U-d%j, ISO: %G-W%u-%V-d%j" }}}');
                         bson_dollar_project                         
---------------------------------------------------------------------
 { "dateString" : "Natural: 2017-W3-27-d185, ISO: 2017-W2-27-d185" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-12-04T15:09:14.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "Natural: %Y-W%w-%U-d%j, ISO: %G-W%u-%V-d%j" }}}');
                         bson_dollar_project                         
---------------------------------------------------------------------
 { "dateString" : "Natural: 2017-W2-49-d338, ISO: 2017-W1-49-d338" }
(1 row)

-- $dateToString long format strings > 256 bytes
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-01-01T15:08:51.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "The order: RIMSLABOZXERCQTXYYSJFUOPCAUWTDPXHEMCUUTUWZZSPLMXNWSIYDZNMIX was placed on: %Y-%m-%d %H:%M:%S" }}}');
                                                      bson_dollar_project                                                       
---------------------------------------------------------------------
 { "dateString" : "The order: RIMSLABOZXERCQTXYYSJFUOPCAUWTDPXHEMCUUTUWZZSPLMXNWSIYDZNMIX was placed on: 2017-01-01 15:08:51" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2038-01-01T15:08:51.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "The order: RIMSLABOZXERCQTXYYSJFUOPCAUWTDPXHEMCUUTUWZZSPLMXNWSIYDZ was placed on: %Y-%m-%d %H:%M:%S" }}}');
                                                    bson_dollar_project                                                     
---------------------------------------------------------------------
 { "dateString" : "The order: RIMSLABOZXERCQTXYYSJFUOPCAUWTDPXHEMCUUTUWZZSPLMXNWSIYDZ was placed on: 2038-01-01 15:08:51" }
(1 row)

-- $dateToString returns null if no onNull is specified and any arg expression is null or undefined
SELECT * FROM bson_dollar_project('{"date": null}', '{"dateString": {"$dateToString": { "date": "$date", "format": "Natural: %Y-W%w-%U, ISO: %G-W%u-%V" }}}');
   bson_dollar_project   
---------------------------------------------------------------------
 { "dateString" : null }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-12-04T15:09:14.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "timezone": "$tz", "format": "Natural: %Y-W%w-%U, ISO: %G-W%u-%V" }}}');
   bson_dollar_project   
---------------------------------------------------------------------
 { "dateString" : null }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-12-04T15:09:14.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "timezone": null, "format": "Natural: %Y-W%w-%U, ISO: %G-W%u-%V" }}}');
   bson_dollar_project   
---------------------------------------------------------------------
 { "dateString" : null }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-12-04T15:09:14.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "timezone": "America/New_York", "format": "$format" }}}');
   bson_dollar_project   
---------------------------------------------------------------------
 { "dateString" : null }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-12-04T15:09:14.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "timezone": "America/New_York", "format": null }}}');
   bson_dollar_project   
---------------------------------------------------------------------
 { "dateString" : null }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-12-04T15:09:14.911Z"}}', '{"dateString": {"$dateToString": { "date": null, "timezone": "America/New_York"}}}');
   bson_dollar_project   
---------------------------------------------------------------------
 { "dateString" : null }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-12-04T15:09:14.911Z"}}', '{"dateString": {"$dateToString": { "date": {"$literal": null}, "timezone": "America/New_York"}}}');
   bson_dollar_project   
---------------------------------------------------------------------
 { "dateString" : null }
(1 row)

-- $dateToString onNull expression is only returned and honored when 'date' argument is null
SELECT * FROM bson_dollar_project('{"date": null}', '{"dateString": {"$dateToString": { "date": "$date", "format": "Natural: %Y-W%w-%U, ISO: %G-W%u-%V", "onNull": "date was null or undefined" }}}');
               bson_dollar_project               
---------------------------------------------------------------------
 { "dateString" : "date was null or undefined" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": null}', '{"dateString": {"$dateToString": { "date": "$date", "format": "Natural: %Y-W%w-%U, ISO: %G-W%u-%V", "onNull": "$date" }}}');
   bson_dollar_project   
---------------------------------------------------------------------
 { "dateString" : null }
(1 row)

SELECT * FROM bson_dollar_project('{"date": null}', '{"dateString": {"$dateToString": { "date": "$date", "format": "Natural: %Y-W%w-%U, ISO: %G-W%u-%V", "onNull": {"$date": "2017-12-04T15:09:14.911Z"} }}}');
                         bson_dollar_project                          
---------------------------------------------------------------------
 { "dateString" : { "$date" : { "$numberLong" : "1512400154911" } } }
(1 row)

SELECT * FROM bson_dollar_project('{"date": null}', '{"dateString": {"$dateToString": { "date": "$newYorkDate", "format": "Natural: %Y-W%w-%U, ISO: %G-W%u-%V", "onNull": "date was null or undefined" }}}');
               bson_dollar_project               
---------------------------------------------------------------------
 { "dateString" : "date was null or undefined" }
(1 row)

SELECT * FROM bson_dollar_project('{"date": null}', '{"dateString": {"$dateToString": { "date": "$date", "format": "Natural: %Y-W%w-%U, ISO: %G-W%u-%V", "timezone": "$tz", "onNull": "date was null or undefined" }}}');
   bson_dollar_project   
---------------------------------------------------------------------
 { "dateString" : null }
(1 row)

SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-12-04T15:09:14.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "$format", "onNull": "date was null or undefined" }}}');
   bson_dollar_project   
---------------------------------------------------------------------
 { "dateString" : null }
(1 row)

-- $dateToString when date is null and onNull expression points to a non existent path in the document, no result is returned
SELECT * FROM bson_dollar_project('{"date": null}', '{"dateString": {"$dateToString": { "date": "$date", "format": "Natural: %Y-W%w-%U, ISO: %G-W%u-%V", "onNull": "$a" }}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { }
(1 row)

SELECT * FROM bson_dollar_project('{"date": null}', '{"dateString": {"$dateToString": { "date": "$date", "format": "Natural: %Y-W%w-%U, ISO: %G-W%u-%V", "onNull": "$b" }}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { }
(1 row)

SELECT * FROM bson_dollar_project('{"date": null}', '{"dateString": {"$dateToString": { "date": "$date", "format": "Natural: %Y-W%w-%U, ISO: %G-W%u-%V", "onNull": "$c" }}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { }
(1 row)

-- $dateToString 'date' is required
SELECT * FROM bson_dollar_project('{"date": null}', '{"dateString": {"$dateToString": { "format": "Natural: %Y-W%w-%U, ISO: %G-W%u-%V", "onNull": "$a" }}}');
ERROR:  Missing 'date' parameter to $dateToString
-- $dateToString unknown field
SELECT * FROM bson_dollar_project('{"date": null}', '{"dateString": {"$dateToString": { "date": "$date", "format": "Natural: %Y-W%w-%U, ISO: %G-W%u-%V", "onNull": "$a", "customField": "a" }}}');
ERROR:  Unrecognized argument to $dateToString: customField
-- $dateToString an object is required as an argument
SELECT * FROM bson_dollar_project('{"arg": {"date": null, "format": "%Y", "timezone": "UTC"}}', '{"dateString": {"$dateToString": "$arg"}}');
ERROR:  $dateToString only supports an object as its argument
SELECT * FROM bson_dollar_project('{"arg": {"date": null, "format": "%Y", "timezone": "UTC"}}', '{"dateString": {"$dateToString": null}}');
ERROR:  $dateToString only supports an object as its argument
SELECT * FROM bson_dollar_project('{"arg": {"date": null, "format": "%Y", "timezone": "UTC"}}', '{"dateString": {"$dateToString": []}}');
ERROR:  $dateToString only supports an object as its argument
-- $dateToString invalid format modifier
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%Y-%m-%d %i %H:%M:%S %z (%Z minutes)", "timezone": "UTC" }}}');
ERROR:  Invalid format character '%i' in format string
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%i %Y-%m-%d %H:%M:%S %z (%Z minutes)", "timezone": "UTC" }}}');
ERROR:  Invalid format character '%i' in format string
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%Y-%m-%d %H:%M:%S %z (%Z minutes) %i", "timezone": "UTC" }}}');
ERROR:  Invalid format character '%i' in format string
-- $dateToString unmatched % at end of format string
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": "%Y-%m-%d %H:%M:%S %z (%Z minutes)%%%", "timezone": "UTC" }}}');
ERROR:  Unmatched '%' at end of format string
-- $dateToString 'format' argument must be a string
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": true, "timezone": "UTC" }}}');
ERROR:  $dateToString requires that 'format' be a string, found: bool with value true
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "format": 1, "timezone": "UTC" }}}');
ERROR:  $dateToString requires that 'format' be a string, found: int with value 1
-- $dateToString 'date' must be an oid, timestamp or date
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "", "timezone": "UTC" }}}');
ERROR:  can't convert from BSON type string to Date
-- $dateToString 'timezone' must be string and a valid timezone
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "timezone": true }}}');
ERROR:  timezone must evaluate to a string, found bool
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "timezone": "Unknown" }}}');
ERROR:  unrecognized time zone identifier: "Unknown"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "timezone": "+8" }}}');
ERROR:  unrecognized time zone identifier: "+8"
SELECT * FROM bson_dollar_project('{"date": {"$date": "2017-07-04T14:56:42.911Z"}}', '{"dateString": {"$dateToString": { "date": "$date", "timezone": "+80000000" }}}');
ERROR:  unrecognized time zone identifier: "+80000000"
-- $dateToString date component outside of supported range
SELECT * FROM bson_dollar_project('{"date": {"$date": "9999-12-31T11:59:59.911Z"}}', '{"dateString": {"$dateToString": { "date": {"$add": ["$date", {"$numberLong": "86400000"}]} }}}');
ERROR:  Could not convert date to string: date component was outside the supported range of 0-9999: 10000
SELECT * FROM bson_dollar_project('{"date": {"$date": "9999-12-31T11:59:59.911Z"}}', '{"dateString": {"$dateToString": { "date": {"$add": ["$date", {"$numberLong": "86400000"}]}, "format": "%Y" }}}');
ERROR:  Could not convert date to string: date component was outside the supported range of 0-9999: 10000
-- $dateFromParts null cases
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": null }}');
ERROR:  $dateFromParts only supports an object as its argument
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"$undefined":true} }}');
ERROR:  $dateFromParts only supports an object as its argument
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": null} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2029, "month": null} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2029, "month": 5, "day":null} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2029, "month": 5, "day": 10, "hour":null} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2029, "month": 5, "day": 10, "hour":2 , "minute":null} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2029, "month": 5, "day": 10, "hour":2 , "minute":20, "second":null} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2029, "month": 5, "day": 10, "hour":2 , "minute":20, "second":5, "millisecond":null} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2029, "month": 5, "day": 10, "hour":2 , "minute":20, "second":5, "millisecond":200, "timezone":null} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear" : null} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear" : 2029, "isoWeek": null} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear" : 2029, "isoWeek": 5, "isoDayOfWeek":null} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

-- $dateFromParts undefined cases
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": {"$undefined":true}} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2029, "month": {"$undefined":true}} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2029, "month": 5, "day":{"$undefined":true}} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2029, "month": 5, "day": 10, "hour":{"$undefined":true}} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2029, "month": 5, "day": 10, "hour":2 , "minute":{"$undefined":true}} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2029, "month": 5, "day": 10, "hour":2 , "minute":20, "second":{"$undefined":true}} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2029, "month": 5, "day": 10, "hour":2 , "minute":20, "second":5, "millisecond":{"$undefined":true}} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2029, "month": 5, "day": 10, "hour":2 , "minute":20, "second":5, "millisecond":200, "timezone":{"$undefined":true}} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear" : {"$undefined":true}} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear" : 2029, "isoWeek": {"$undefined":true}} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear" : 2029, "isoWeek": 5, "isoDayOfWeek":{"$undefined":true}} }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

-- $dateFromParts non-iso format cases
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 2029} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1861920000000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2000, "month": 5, "day":5} }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "957484800000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2020, "month": 5, "day": 10, "hour":2 , "minute":20, "second":5, "millisecond":450} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1589077205450" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 1970, "month": 2, "day": 10, "hour":23 , "minute":59, "second":50, "millisecond":450} }}');
                      bson_dollar_project                      
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "3542390450" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2000, "month": 2, "day": 29, "hour":23 , "minute":59, "second":50, "millisecond":450} }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "951868790450" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 1, "month": 2, "day": 28, "hour":23 , "minute":59, "second":50, "millisecond":450} }}');
                        bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-62130499209550" } } }
(1 row)

-- $dateFromParts non-iso format cases with timezone
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2020, "month": 5, "day": 10, "hour":2 , "minute":20, "second":5, "millisecond":450, "timezone": "UTC"} }}'); 
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1589077205450" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2020, "month": 5, "day": 10, "hour":2 , "minute":20, "second":5, "millisecond":450, "timezone": "America/Denver"} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1589098805450" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2020, "month": 5, "day": 10, "hour":2 , "minute":20, "second":5, "millisecond":450, "timezone": "Asia/Kolkata"} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1589057405450" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2020, "month": 5, "day": 10, "hour":2 , "minute":20, "second":5, "millisecond":450, "timezone": "+04:30"} }}'); 
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1589061005450" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2020, "month": 5, "day": 10, "hour":2 , "minute":20, "second":5, "millisecond":450, "timezone": "+0430"} }}'); 
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1589061005450" } } }
(1 row)

-- $dateFromParts iso format
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2029} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1861920000000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2029, "isoWeek":20, "isoDayOfWeek": 2} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1873497600000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2029, "isoWeek":20, "isoDayOfWeek": 2 ,"hour":20, "minute":45, "second":12} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1873572312000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2023, "isoWeek":12, "isoDayOfWeek": 2} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1679356800000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2024, "isoWeek":50, "isoDayOfWeek": 2 ,"hour":18, "minute":45, "second":12} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1733856312000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 1, "isoWeek":12, "isoDayOfWeek": 2 ,"hour":18, "minute":45, "second":12} }}');
                        bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-62128790088000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 1, "isoWeek":12, "isoDayOfWeek": 2 ,"hour":18, "minute":45, "second":12, "timezone": "+04:30"} }}');
                        bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-62128806288000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 1, "isoWeek":12, "isoDayOfWeek": 2 ,"hour":18, "minute":45, "second":12, "timezone": "+0430"} }}');
                        bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-62128806288000" } } }
(1 row)

-- $dateFromParts iso cases with timezone
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2029, "isoWeek":20, "isoDayOfWeek": 2 ,"hour":20, "minute":45, "second":12, "timezone": "America/Denver"} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1873593912000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2023, "isoWeek":12, "isoDayOfWeek": 2, "timezone": "America/Los_Angeles"} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1679382000000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2024, "isoWeek":50, "isoDayOfWeek": 2 ,"hour":20, "minute":45, "second":12 , "timezone": "Asia/Kolkata"} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1733843712000" } } }
(1 row)

-- $dateFromParts cases with carrying when range is not valid for iso format
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2017, "isoWeek":0, "isoDayOfWeek": 2 ,"hour":18, "minute":45, "second":12} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1482864312000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2000, "isoWeek":0, "isoDayOfWeek": 5 ,"hour":18, "minute":45, "second":12} }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "946665912000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2000, "isoWeek":0, "isoDayOfWeek": 15 ,"hour":28, "minute":450, "second":124 , "millisecond":876} }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "947590324876" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 1, "isoWeek":0, "isoDayOfWeek": 15 ,"hour":28, "minute":450, "second":124 , "millisecond":876} }}');
                        bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-62134864075124" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2011, "isoWeek":-24, "isoDayOfWeek": -15 ,"hour":28, "minute":450, "second":124 , "millisecond":876} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1277638324876" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2011, "isoWeek":-24, "isoDayOfWeek": -15 ,"hour":-28, "minute":-450, "second":-124 , "millisecond":876} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1277382476876" } } }
(1 row)

-- $dateFromParts cases with carrying when range is not valid for non-iso format
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2020, "month": 15, "day": 100, "hour":23 , "minute":210, "second":1115, "millisecond":450} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1623206915450" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 2020, "month": -15, "day": 1200, "hour":213 , "minute":2110, "second":-1115, "millisecond":-450} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1640245884550" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 1, "month": -15, "day": 1200, "hour":213 , "minute":2110, "second":-1115, "millisecond":-450} }}');
                        bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-62073274115450" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year" : 9999, "month": -15, "day": 1200, "hour":213 , "minute":2110, "second":-1115, "millisecond":-450} }}');
                        bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "253433173884550" } } }
(1 row)

-- $dateFromParts cases negative cases
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": 1 }}');
ERROR:  $dateFromParts only supports an object as its argument
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": "abc" }}');
ERROR:  $dateFromParts only supports an object as its argument
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {} }}');
ERROR:  $dateFromParts requires either 'year' or 'isoWeekYear' to be present
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year":2017, "isoWeekYear": 2012} }}');
ERROR:  $dateFromParts does not allow mixing natural dates with ISO dates
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": {"$numberDecimal": "2014.5"} } }}');
ERROR:  'year' must evaluate to an integer, found decimal with value :2014.5
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": 1 }}');
ERROR:  $dateFromParts only supports an object as its argument
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": "abc" }}');
ERROR:  $dateFromParts only supports an object as its argument
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {} }}');
ERROR:  $dateFromParts requires either 'year' or 'isoWeekYear' to be present
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year":2017, "isoWeekYear": 2012} }}');
ERROR:  $dateFromParts does not allow mixing natural dates with ISO dates
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year":2017.5} }}');
ERROR:  'year' must evaluate to an integer, found double with value :2017.5
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year":"2017"} }}');
ERROR:  'year' must evaluate to an integer, found string with value :"2017"
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 2017, "abcd":1} }}');
ERROR:  Unrecognized argument to $dateFromParts: abcd
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2012.12} }}');
ERROR:  'isoWeekYear' must evaluate to an integer, found double with value :2012.12
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": "2012"} }}');
ERROR:  'isoWeekYear' must evaluate to an integer, found string with value :"2012"
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2012, "timezone": "hello"} }}');
ERROR:  unrecognized time zone identifier: "hello"
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 2012, "timezone": 1} }}');
ERROR:  timezone must evaluate to a string, found int
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 0} }}');
ERROR:  'year' must evaluate to an integer in the range 1 to 9999, found 0
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 11110} }}');
ERROR:  'year' must evaluate to an integer in the range 1 to 9999, found 11110
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 0} }}');
ERROR:  'isoWeekYear' must evaluate to an integer in the range 1 to 9999, found 0
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 11110} }}');
ERROR:  'isoWeekYear' must evaluate to an integer in the range 1 to 9999, found 11110
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 2010, "month": 32769, "day": 100, "second": 50, "minute":100} }}');
ERROR:  'month' must evaluate to a value in the range [-32768, 32767]; value 32769 is not in range
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 2010, "month": 12, "day": 32769, "second": 50, "minute":100} }}');
ERROR:  'day' must evaluate to a value in the range [-32768, 32767]; value 32769 is not in range
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 2010, "month": 12, "day": 1, "second": 32769, "minute":100} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1291200369000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 2010, "month": 12, "day": 1, "hour": 32769, "minute":100} }}');
ERROR:  'hour' must evaluate to a value in the range [-32768, 32767]; value 32769 is not in range
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 2010, "month": 12, "day": 1, "hour": -24, "minute":32769} }}');
ERROR:  'minute' must evaluate to a value in the range [-32768, 32767]; value 32769 is not in range
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 2010, "month": -32769, "day": 100, "second": 50, "minute":100} }}');
ERROR:  'month' must evaluate to a value in the range [-32768, 32767]; value -32769 is not in range
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 2010, "month": 12, "day": -32769, "second": 50, "minute":100} }}');
ERROR:  'day' must evaluate to a value in the range [-32768, 32767]; value -32769 is not in range
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 2010, "month": 12, "day": 1, "second": -32769, "minute":100} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1291134831000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 2010, "month": 12, "day": 1, "hour": -32769, "minute":100} }}');
ERROR:  'hour' must evaluate to a value in the range [-32768, 32767]; value -32769 is not in range
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 2010, "month": 12, "day": 1, "hour": -24, "minute":-32769} }}');
ERROR:  'minute' must evaluate to a value in the range [-32768, 32767]; value -32769 is not in range
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 2010, "millisecond": {"$numberDecimal": "-18999999999999999888888888"}} }}');
ERROR:  'millisecond' must evaluate to an integer, found decimal with value :-18999999999999999888888888
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2012, "month":12} }}');
ERROR:  $dateFromParts does not allow mixing natural dates with ISO dates
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeekYear": 2012, "day":12} }}');
ERROR:  $dateFromParts does not allow mixing natural dates with ISO dates
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 1209, "isoWeek": 12} }}');
ERROR:  $dateFromParts does not allow mixing natural dates with ISO dates
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"year": 1209, "isoDayOfWeek": 12} }}');
ERROR:  $dateFromParts does not allow mixing natural dates with ISO dates
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"month": 1209, "isoDayOfWeek": 12} }}');
ERROR:  $dateFromParts does not allow mixing natural dates with ISO dates
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"month": 1209} }}');
ERROR:  $dateFromParts requires either 'year' or 'isoWeekYear' to be present
select * from bson_dollar_project('{}', '{"result": {"$dateFromParts": {"isoWeek": 1209} }}');
ERROR:  $dateFromParts requires either 'year' or 'isoWeekYear' to be present
-- $dateFromParts document based cases
select * from bson_dollar_project('{"year" : 2011, "month": 2, "day": 28, "hour":23 , "minute":59, "second":50, "millisecond":450}', '{"result": {"$dateFromParts": {"year" : "$year", "month": "$month", "day": "$day", "hour":"$hour" , "minute":"$minute", "second":"$second", "millisecond":"$millisecond"} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1298937590450" } } }
(1 row)

select * from bson_dollar_project('{"year" : 2011, "month": 2, "day": 28, "hour":23 , "minute":59, "second":50, "millisecond":450}', '{"result": {"$dateFromParts": {"year" : "$year", "month": "$month"} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1296518400000" } } }
(1 row)

select * from bson_dollar_project('{"year" : 2011, "month": 2, "day": 28, "hour":23 , "minute":59, "second":50, "millisecond":450, "timezone": "America/Los_Angeles"}', '{"result": {"$dateFromParts": {"year" : "$year", "month": "$month" , "timezone": "$timezone"} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1296547200000" } } }
(1 row)

select * from bson_dollar_project(' {"isoWeekYear": 2024, "isoWeek":50, "isoDayOfWeek": 2 ,"hour":18, "minute":45, "second":12}', '{"result": {"$dateFromParts":  {"isoWeekYear": "$isoWeekYear", "isoWeek": "$isoWeek", "isoDayOfWeek": "$isoDayOfWeek" ,"hour":"$hour", "minute":"$minute", "second":"$second"} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1733856312000" } } }
(1 row)

select * from bson_dollar_project(' {"isoWeekYear": 2024, "isoWeek":50, "isoDayOfWeek": 2 ,"hour":18, "minute":45, "second":12}', '{"result": {"$dateFromParts":  {"isoWeekYear": "$isoWeekYear", "isoWeek": "$isoWeek", "isoDayOfWeek": "$isoDayOfWeek"} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1733788800000" } } }
(1 row)

select * from bson_dollar_project(' {"isoWeekYear": 2024, "isoWeek":50, "isoDayOfWeek": 2 ,"hour":18, "minute":45, "second":12, "timezone" : "America/New_York"}', '{"result": {"$dateFromParts":  {"isoWeekYear": "$isoWeekYear", "isoWeek": "$isoWeek", "isoDayOfWeek": "$isoDayOfWeek", "timezone": "$timezone"} }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1733806800000" } } }
(1 row)

--$dateTrunc null cases
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": null }}');
ERROR:  $dateTrunc only supports an object as its argument
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"$undefined": true} }}');
ERROR:  $dateTrunc only supports an object as its argument
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "second", "binSize": null  }  }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "second", "binSize": {"$undefined": true}  }  }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "second", "timezone": null , "binSize": 5  }  }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "second", "timezone": {"$undefined": true} , "binSize":5 }  }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "timezone": "+04:45", "unit": null , "binSize": 5  }  }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "timezone": "-0430", "unit": {"$undefined": true} , "binSize":5 }  }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

-- $dateTrunc case when startOfWeek is null
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "week", "startOfWeek": null , "binSize": 2 }  }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "week", "startOfWeek": {"$undefined": true}, "binSize": 2  }  }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

-- $dateTrunc case when startOfWeek null but unit is not week
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "second", "startOfWeek": null , "binSize": 2 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1707123354000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "second", "startOfWeek": {"$undefined": true} , "binSize": 2 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1707123354000" } } }
(1 row)

-- $dateTrunc cases with unit millisecond
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "millisecond", "binSize": 2 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1707123355380" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "millisecond" , "binSize": 200000 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1707123200000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "millisecond", "binSize": 2, "timezone": "America/Denver" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "951850555380" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "millisecond" , "binSize": 200000, "timezone": "Asia/Kolkata" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "951850400000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "millisecond" , "binSize": 4500 }  }}');
                      bson_dollar_project                      
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "7498552500" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "millisecond" , "binSize": 450000000 }  }}');
                      bson_dollar_project                      
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "7084800000" } } }
(1 row)

-- $dateTrunc cases with unit second
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "second", "binSize": 2 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1707123354000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "second" , "binSize": 200000 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1707084800000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "second", "binSize": 2, "timezone": "America/Denver" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "951850554000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "second" , "binSize": 200000, "timezone": "Asia/Kolkata" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "951665000000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "second" , "binSize": 4500 }  }}');
                      bson_dollar_project                      
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "7494300000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "second" , "binSize": 450000000 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-403315200000" } } }
(1 row)

-- $dateTrunc cases with unit minute
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "minute", "binSize": 2 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1707123240000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "minute" , "binSize": 200000 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1702684800000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "minute", "binSize": 2, "timezone": "America/Denver" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "951850440000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "minute" , "binSize": 200000, "timezone": "Asia/Kolkata" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "946665000000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "minute" , "binSize": 4500 }  }}');
                      bson_dollar_project                      
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "7354800000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "minute" , "binSize": 450000000 }  }}');
                        bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-26053315200000" } } }
(1 row)

-- $dateTrunc cases with unit hour
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "hour", "binSize": 2 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1707120000000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "hour" , "binSize": 200000 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1666684800000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "hour", "binSize": 2, "timezone": "America/Los_Angeles" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "951847200000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "hour" , "binSize": 200000, "timezone": "America/New_York" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "946702800000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "hour" , "binSize": 200000, "timezone": "America/Denver" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "946710000000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "hour" , "binSize": 4500 }  }}');
                      bson_dollar_project                      
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "7084800000" } } }
(1 row)

/* This test case has overflow, postgres added this check in newer minor versions.
 * Todo: add this test back and check overflow after we bump up the postgres minor version (>=15.7 and >=16.3).
 */
-- select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "hour" , "binSize": 450000000 }  }}');
-- $dateTrunc cases with unit day
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "day", "binSize": 2 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1707004800000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "day" , "binSize": 200000 }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "946684800000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "day", "binSize": 2, "timezone": "America/Denver" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "951721200000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "day" , "binSize": 200000, "timezone": "Asia/Kolkata" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "946665000000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "day" , "binSize": 4500 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-219715200000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "day" , "binSize": 450000000 }  }}');
                          bson_dollar_project                           
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "9223372036854775807" } } }
(1 row)

-- $dateTrunc cases with unit week
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "week", "binSize": 2 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1706400000000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "week" , "binSize": 200000 }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "946771200000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "week", "binSize": 2, "timezone": "America/Denver" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "951634800000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "week" , "binSize": 200000, "timezone": "Asia/Kolkata" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "946751400000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "week" , "binSize": 4500 }  }}');
                        bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-1774828800000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "week" , "binSize": 450000000 }  }}');
                          bson_dollar_project                           
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "9223372036854775807" } } }
(1 row)

-- $dateTrunc cases with unit month
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "month", "binSize": 2 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1704067200000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "month" , "binSize": 200000 }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "946684800000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "month", "binSize": 2, "timezone": "America/Denver" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "946710000000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "month" , "binSize": 200000, "timezone": "Asia/Kolkata" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "946665000000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "month" , "binSize": 4500 }  }}');
                        bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-10887091200000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "month" , "binSize": 450000000 }  }}');
                          bson_dollar_project                           
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "9223372036854775807" } } }
(1 row)

-- $dateTrunc cases with unit year
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "year", "binSize": 2 }  }}');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1704067200000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}, "unit": "year" , "binSize": 200000 }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "946684800000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "year", "binSize": 2, "timezone": "America/Denver" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "946710000000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "951850555381"}}, "unit": "year" , "binSize": 200000, "timezone": "Asia/Kolkata" }  }}');
                       bson_dollar_project                       
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "946665000000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "year" , "binSize": 4500 }  }}');
                         bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-141059577600000" } } }
(1 row)

select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "7498555381"}}, "unit": "year" , "binSize": 450000000 }  }}');
                          bson_dollar_project                           
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "9223372036854775807" } } }
(1 row)

-- $dateTrunc invalid cases
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": "A" }}');
ERROR:  $dateTrunc only supports an object as its argument
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {} }}');
ERROR:  Missing 'date' parameter to $dateTrunc
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"abc": 1} }}');
ERROR:  Unrecognized argument to $dateTrunc: abc. Expected arguments are date, unit, and optionally, binSize, timezone, startOfWeek
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}}  } }}');
ERROR:  Missing 'unit' parameter to $dateTrunc
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}} , "unit": 1 } }}');
ERROR:  $dateTrunc requires 'unit' to be a string, but got int
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}} , "unit": "456" } }}');
ERROR:  $dateTrunc parameter 'unit' value cannot be recognized as a time unit: 456
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}} , "unit": "456" } }}');
ERROR:  $dateTrunc parameter 'unit' value cannot be recognized as a time unit: 456
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}} , "unit": "year", "binSize": "1" } }}');
ERROR:  $dateTrunc requires 'binSize' to be a 64-bit integer, but got value '"1"' of type string
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}} , "unit": "year", "binSize": 1.5 } }}');
ERROR:  $dateTrunc requires 'binSize' to be a 64-bit integer, but got value '1.5' of type double
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}} , "unit": "year", "binSize": 1 , "timezone": 123} }}');
ERROR:  timezone must evaluate to a string, found int
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": {"$date" : {"$numberLong": "1707123355381"}} , "unit": "week", "binSize": 1 , "startOfWeek": "Menday"} }}');
ERROR:  $dateTrunc parameter 'startOfWeek' value cannot be recognized as a day of a week: Menday
select * from bson_dollar_project('{}', '{"result": {"$dateTrunc": {"date": "A" , "unit": "456" } }}');
ERROR:  $dateTrunc requires 'date' to be a date, but got string
-- $dateAdd null based cases
select * from bson_dollar_project('{}','{"result": {"$dateAdd": null } }');
ERROR:  $dateAdd expects an object as its argument.found input type:null
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"$undefined":true} } }');
ERROR:  $dateAdd expects an object as its argument.found input type:{ "$undefined" : true }
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {} } }');
ERROR:  $dateAdd requires startDate, unit, and amount to be present
-- $dateAdd cases when input parts are null or undefined
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": null , "unit":"month" , "amount":30000000000, "timezone": "+04:00" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":null , "amount":30000000000, "timezone": "+04:00" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"second" , "amount":null, "timezone": "+04:00" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"second" , "amount":1, "timezone": null } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$undefined":true} , "unit":"month" , "amount":30000000000, "timezone": "+04:00" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":{"$undefined":true} , "amount":30000000000, "timezone": "+04:00" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"second" , "amount":{"$undefined":true}, "timezone": "+04:00" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"second" , "amount":1, "timezone": {"$undefined":true} } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

-- $dateAdd normal cases
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"second" , "amount":300 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1615647900000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"month" , "amount":-30 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1536850800000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"year" , "amount":3 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1710342000000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"quarter" , "amount":45 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1970751600000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"day" , "amount":145 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1628175600000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"week" , "amount":-14 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1607180400000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"hour" , "amount":4 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1615662000000" } } }
(1 row)

-- $dateAdd cases with timezone handling
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"month" , "amount":2,  "timezone": "America/New_York" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1617156000000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"hour" , "amount":12,  "timezone": "America/New_York" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1612105200000" } } }
(1 row)

-- dst offset not applied for hours
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1603563000000"} } , "unit":"hour" , "amount":24,  "timezone": "Europe/Paris" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1603649400000" } } }
(1 row)

-- dst offset applied
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1603563000000"} } , "unit":"day" , "amount":1,  "timezone": "Europe/Paris" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1603653000000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1603563000000"} } , "unit":"day" , "amount":1,  "timezone": "+04:00" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1603649400000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1603563000000"} } , "unit":"second" , "amount":1,  "timezone": "-05:30" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1603563001000" } } }
(1 row)

-- dst offset applied
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"day" , "amount":5,  "timezone": "America/New_York" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1616076000000" } } }
(1 row)

-- $dateAdd cases with input validation of ranges which are calculated manually. With these inputs we should error that it's out of range. This is a pre-addition validation
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"year" , "amount": 584942419} } }');
ERROR:  invalid $dateAdd 'amount' parameter value: 584942419 year
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"quarter" , "amount": 1754827252} } }');
ERROR:  invalid $dateAdd 'amount' parameter value: 1754827252 quarter
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"month" , "amount": 7019309005} } }');
ERROR:  invalid $dateAdd 'amount' parameter value: 7019309005 month
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"week" , "amount": 30500568906} } }');
ERROR:  invalid $dateAdd 'amount' parameter value: 30500568906 week
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"week" , "amount": 30500568906} } }');
ERROR:  invalid $dateAdd 'amount' parameter value: 30500568906 week
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"day" , "amount": 213503982336} } }');
ERROR:  invalid $dateAdd 'amount' parameter value: 213503982336 day
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"hour" , "amount": 5124095576041} } }');
ERROR:  invalid $dateAdd 'amount' parameter value: 5124095576041 hour
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"minute" , "amount": 307445734562401} } }');
ERROR:  invalid $dateAdd 'amount' parameter value: 307445734562401 minute
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"second" , "amount": 18446744073744001} } }');
ERROR:  invalid $dateAdd 'amount' parameter value: 18446744073744001 second
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"second" , "amount": 1, "hex": "a"} } }');
ERROR:  Unrecognized argument to $dateAdd: hex. Expected arguments are startDate, unit, amount, and optionally timezone
-- $dateAdd cases with error cases
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"year" , "amount": 56.55} } }');
ERROR:  $dateAdd expects integer amount of time units
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"years" , "amount": 56} } }');
ERROR:  unknown time unit value: years
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"year" , "amount": 56, "field":5} } }');
ERROR:  Unrecognized argument to $dateAdd: field. Expected arguments are startDate, unit, amount, and optionally timezone
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"year" , "amount": 56, "field":5} } }');
ERROR:  Unrecognized argument to $dateAdd: field. Expected arguments are startDate, unit, amount, and optionally timezone
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} }  , "amount": 56} } }');
ERROR:  $dateAdd requires startDate, unit, and amount to be present
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"unit":"day"  , "amount": 56} } }');
ERROR:  $dateAdd requires startDate, unit, and amount to be present
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"unit":"day"  , "amount": 56} } }');
ERROR:  $dateAdd requires startDate, unit, and amount to be present
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": "abcd"  , "amount": 56, "unit": 5} } }');
ERROR:  $dateAdd requires startDate to be convertible to a date
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1612062000000"} }  , "amount": 56, "unit": 5, "timezone": "abcd"} } }');
ERROR:  $dateAdd expects string defining the time unit
-- $dateAdd cases with overflow
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1603563000000"} } , "unit":"year" , "amount": 584942416} } }');
ERROR:  $dateAdd overflowed
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1603563000000"} } , "unit":"month" , "amount": 584942416} } }');
ERROR:  $dateAdd overflowed
select * from bson_dollar_project('{}','{"result": {"$dateAdd": {"startDate": {"$date": {"$numberLong": "1603563000000"} } , "unit":"hour" , "amount": 58411942416} } }');
ERROR:  $dateAdd overflowed
-- $dateAdd cases with document
select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"second" , "amount":300 }','{"result": {"$dateAdd": {"startDate": "$startDate", "amount": "$amount", "unit":"$unit"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1615647900000" } } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"month" , "amount":3 }','{"result": {"$dateAdd": {"startDate": "$startDate", "amount": "$amount", "unit":"$unit"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1623596400000" } } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"year" , "amount":10 }','{"result": {"$dateAdd": {"startDate": "$startDate", "amount": "$amount", "unit":"$unit"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1931180400000" } } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"day" , "amount":60 }','{"result": {"$dateAdd": {"startDate": "$startDate", "amount": "$amount", "unit":"$unit"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1620831600000" } } }
(1 row)

-- $dateSubtract null based cases
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": null } }');
ERROR:  $dateSubtract expects an object as its argument.found input type:null
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"$undefined":true} } }');
ERROR:  $dateSubtract expects an object as its argument.found input type:{ "$undefined" : true }
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {} } }');
ERROR:  $dateSubtract requires startDate, unit, and amount to be present
-- $dateSubtract cases when input parts are null or undefined
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": null , "unit":"month" , "amount":30000000000, "timezone": "+04:00" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":null , "amount":30000000000, "timezone": "+04:00" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"second" , "amount":null, "timezone": "+04:00" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"second" , "amount":1, "timezone": null } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$undefined":true} , "unit":"month" , "amount":30000000000, "timezone": "+04:00" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":{"$undefined":true} , "amount":30000000000, "timezone": "+04:00" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"second" , "amount":{"$undefined":true}, "timezone": "+04:00" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"second" , "amount":1, "timezone": {"$undefined":true} } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

-- $dateSubtract normal cases
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"second" , "amount":300 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1615647300000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"month" , "amount":-30 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1694617200000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"year" , "amount":3 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1520953200000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1709205288000"} } , "unit":"year" , "amount":1 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1677582888000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"quarter" , "amount":45 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1260716400000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"day" , "amount":145 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1603119600000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"week" , "amount":-14 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1624114800000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"hour" , "amount":4 } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1615633200000" } } }
(1 row)

-- $dateSubtract cases with timezone handling
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"month" , "amount":2,  "timezone": "America/New_York" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1606791600000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"hour" , "amount":12,  "timezone": "America/New_York" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1612018800000" } } }
(1 row)

-- dst offset not applied for hours
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1603563000000"} } , "unit":"hour" , "amount":24,  "timezone": "Europe/Paris" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1603476600000" } } }
(1 row)

-- dst offset applied
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1603563000000"} } , "unit":"day" , "amount":1,  "timezone": "Europe/Paris" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1603476600000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1603563000000"} } , "unit":"day" , "amount":1,  "timezone": "+04:00" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1603476600000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1603563000000"} } , "unit":"second" , "amount":1,  "timezone": "-05:30" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1603562999000" } } }
(1 row)

-- dst offset applied
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"day" , "amount":5,  "timezone": "America/New_York" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1615215600000" } } }
(1 row)

-- $dateSubtract cases with input validation of ranges which are calculated manually. With these inputs we should error that it's out of range. This is a pre-subtraction validation
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"year" , "amount": 584942419} } }'); 
ERROR:  invalid $dateSubtract 'amount' parameter value: 584942419 year
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"quarter" , "amount": 1754827252} } }');
ERROR:  invalid $dateSubtract 'amount' parameter value: 1754827252 quarter
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"month" , "amount": 7019309005} } }');
ERROR:  invalid $dateSubtract 'amount' parameter value: 7019309005 month
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"week" , "amount": 30500568906} } }');
ERROR:  invalid $dateSubtract 'amount' parameter value: 30500568906 week
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"week" , "amount": 30500568906} } }');
ERROR:  invalid $dateSubtract 'amount' parameter value: 30500568906 week
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"day" , "amount": 213503982336} } }');
ERROR:  invalid $dateSubtract 'amount' parameter value: 213503982336 day
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"hour" , "amount": 5124095576041} } }');
ERROR:  invalid $dateSubtract 'amount' parameter value: 5124095576041 hour
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"minute" , "amount": 307445734562401} } }');
ERROR:  invalid $dateSubtract 'amount' parameter value: 307445734562401 minute
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"second" , "amount": 18446744073744001} } }');
ERROR:  invalid $dateSubtract 'amount' parameter value: 18446744073744001 second
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"second" , "amount": 1, "hex": "a"} } }');
ERROR:  Unrecognized argument to $dateSubtract: hex. Expected arguments are startDate, unit, amount, and optionally timezone
-- $dateSubtract cases with error cases
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"year" , "amount": 56.55} } }');
ERROR:  $dateSubtract expects integer amount of time units
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"years" , "amount": 56} } }');
ERROR:  unknown time unit value: years
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"year" , "amount": 56, "field":5} } }');
ERROR:  Unrecognized argument to $dateSubtract: field. Expected arguments are startDate, unit, amount, and optionally timezone
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} } , "unit":"year" , "amount": 56, "field":5} } }');
ERROR:  Unrecognized argument to $dateSubtract: field. Expected arguments are startDate, unit, amount, and optionally timezone
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} }  , "amount": 56} } }');
ERROR:  $dateSubtract requires startDate, unit, and amount to be present
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"unit":"day"  , "amount": 56} } }');
ERROR:  $dateSubtract requires startDate, unit, and amount to be present
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"unit":"day"  , "amount": 56} } }');
ERROR:  $dateSubtract requires startDate, unit, and amount to be present
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": "abcd"  , "amount": 56, "unit": 5} } }');
ERROR:  $dateSubtract requires startDate to be convertible to a date
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1612062000000"} }  , "amount": 56, "unit": 5, "timezone": "abcd"} } }');
ERROR:  $dateSubtract expects string defining the time unit
-- $dateSubtract cases with overflow
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1603563000000"} } , "unit":"year" , "amount": 584942416} } }');
ERROR:  $dateSubtract overflowed
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1603563000000"} } , "unit":"month" , "amount": 584942416} } }');
ERROR:  $dateSubtract overflowed
select * from bson_dollar_project('{}','{"result": {"$dateSubtract": {"startDate": {"$date": {"$numberLong": "1603563000000"} } , "unit":"hour" , "amount": 58411942416} } }');
                         bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "6184962583800001" } } }
(1 row)

-- $dateSubtract cases with document
select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"second" , "amount":300 }','{"result": {"$dateSubtract": {"startDate": "$startDate", "amount": "$amount", "unit":"$unit"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1615647300000" } } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"month" , "amount":3 }','{"result": {"$dateSubtract": {"startDate": "$startDate", "amount": "$amount", "unit":"$unit"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1607871600000" } } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"year" , "amount":10 }','{"result": {"$dateSubtract": {"startDate": "$startDate", "amount": "$amount", "unit":"$unit"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1300028400000" } } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1615647600000"} } , "unit":"day" , "amount":60 }','{"result": {"$dateSubtract": {"startDate": "$startDate", "amount": "$amount", "unit":"$unit"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610463600000" } } }
(1 row)

-- $dateDiff null cases
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": null , "unit":"minute" , "endDate": {"$date": {"$numberLong": "1678924740000"} } } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740000"} } , "unit":"minute" , "endDate": null } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": null  } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "week" , "timezone": null  } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "week" , "timezone": "-05:00", "startOfWeek" : null  } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$undefined":true} , "unit":"minute" , "endDate": {"$date": {"$numberLong": "1678924740000"} } } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740000"} } , "unit":"minute" , "endDate": {"$undefined":true} } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": {"$undefined":true}  } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "week" , "timezone": {"$undefined":true}  } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "week" , "timezone": "-05:00", "startOfWeek" : {"$undefined":true}  } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

-- $dateDiff null cases with document
select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "millisecond", "timezone": "America/New_York"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezones"  } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "millisecond", "timezone": "America/New_York"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unist", "timezone": "$timezone"  } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "millisecond", "timezone": "America/New_York"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDsate", "unit": "$unit", "timezone": "$timezone"  } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "millisecond", "timezone": "America/New_York"  }','{"result": {"$dateDiff": {"startDate": "$sstartDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

-- startOfWeek is ignored when unit is not week
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "hour" , "timezone": "-05:00", "startOfWeek" : null  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "hour" , "timezone": "-05:00", "startOfWeek" : 1  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

-- $dateDiff unit milliseconds
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "millisecond"  } } }');
            bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-500" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "millisecond"  } } }');
             bson_dollar_project              
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "3999500" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740500"} } , "endDate": {"$date": {"$numberLong": "4740000"} }, "unit": "millisecond"  } } }');
                 bson_dollar_project                 
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-1678920000500" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "millisecond", "timezone": "UTC"  } } }');
             bson_dollar_project              
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "3999500" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "millisecond", "timezone": "America/New_York"  } } }');
             bson_dollar_project              
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "3999500" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "millisecond", "timezone": "America/New_York"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
             bson_dollar_project              
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "3999500" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "millisecond", "timezone": "+05:00"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
             bson_dollar_project              
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "3999500" } }
(1 row)

-- $dateDiff unit seconds
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "second"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "second"  } } }');
            bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "4000" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740500"} } , "endDate": {"$date": {"$numberLong": "4740000"} }, "unit": "second"  } } }');
               bson_dollar_project                
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-1678920000" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "second", "timezone": "UTC"  } } }');
            bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "4000" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "second", "timezone": "America/New_York"  } } }');
            bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "4000" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "second", "timezone": "America/New_York"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
            bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "4000" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "second", "timezone": "+05:00"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
            bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "4000" } }
(1 row)

-- $dateDiff unit minute
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "minute"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "minute"  } } }');
           bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "67" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740500"} } , "endDate": {"$date": {"$numberLong": "4740000"} }, "unit": "minute"  } } }');
              bson_dollar_project               
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-27982000" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "minute", "timezone": "UTC"  } } }');
           bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "67" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "minute", "timezone": "America/New_York"  } } }');
           bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "67" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "minute", "timezone": "America/New_York"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
           bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "67" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "minute", "timezone": "+05:00"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
           bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "67" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678406400000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "minute", "timezone": "America/New_York"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
            bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "8639" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678406400000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "minute"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit"} } }');
            bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "8639" } }
(1 row)

-- $dateDiff unit hour
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "hour"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "hour"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740500"} } , "endDate": {"$date": {"$numberLong": "4740000"} }, "unit": "hour"  } } }');
             bson_dollar_project              
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-466366" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "hour", "timezone": "UTC"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "hour", "timezone": "America/New_York"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "hour", "timezone": "America/New_York"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "hour", "timezone": "+05:00"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678406400000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "hour", "timezone": "America/New_York"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
           bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "143" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678406400000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "hour"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit"} } }');
           bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "143" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1604255016000"} } , "endDate": {"$date": {"$numberLong": "1604275200000"} }, "unit": "hour"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit"} } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "6" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1604255016000"} } , "endDate": {"$date": {"$numberLong": "1604275200000"} }, "unit": "hour", "timezone": "America/New_York"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"} } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "6" } }
(1 row)

-- $dateDiff unit day
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "day"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "day"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740500"} } , "endDate": {"$date": {"$numberLong": "4740000"} }, "unit": "day"  } } }');
             bson_dollar_project             
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-19432" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "day", "timezone": "UTC"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "day", "timezone": "America/New_York"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "day", "timezone": "America/New_York"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "day", "timezone": "+05:00"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678406400000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "day", "timezone": "America/New_York"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "5" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678406400000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "day"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit"} } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "5" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1604255016000"} } , "endDate": {"$date": {"$numberLong": "1604275200000"} }, "unit": "day"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit"} } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1604255016000"} } , "endDate": {"$date": {"$numberLong": "1604275200000"} }, "unit": "day", "timezone": "America/New_York"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"} } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

-- days in 2024 year
select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1704067200000"} } , "endDate": {"$date": {"$numberLong": "1735603200000"} }, "unit": "day"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit"} } }');
           bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "365" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1704067200000"} } , "endDate": {"$date": {"$numberLong": "1735603200000"} }, "unit": "day", "timezone": "America/Denver"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"} } }');
           bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "365" } }
(1 row)

-- $dateDiff unit week
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "week"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "week"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678924740500"} } , "endDate": {"$date": {"$numberLong": "4740000"} }, "unit": "week"  } } }');
            bson_dollar_project             
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-2776" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "week", "timezone": "UTC"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "week", "timezone": "America/New_York"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678920740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "week", "timezone": "America/New_York"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678488740500"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "week", "timezone": "+05:00"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678406400000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "week", "timezone": "America/New_York"  }','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1678406400000"} } , "endDate": {"$date": {"$numberLong": "1678924740000"} }, "unit": "week"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit"} } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1604255016000"} } , "endDate": {"$date": {"$numberLong": "1604275200000"} }, "unit": "week"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit"} } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1604255016000"} } , "endDate": {"$date": {"$numberLong": "1604275200000"} }, "unit": "week", "timezone": "America/New_York"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"} } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

-- weeks in 2024 year
select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1704067200000"} } , "endDate": {"$date": {"$numberLong": "1735603200000"} }, "unit": "week"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit"} } }');
           bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "52" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1704067200000"} } , "endDate": {"$date": {"$numberLong": "1735603200000"} }, "unit": "week", "timezone": "America/Denver"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "timezone": "$timezone"} } }');
           bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "52" } }
(1 row)

-- week startOfWeek cases
select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1611512616000"} } , "endDate": {"$date": {"$numberLong": "1611541416000"} }, "unit": "week", "startOfWeek": "MONDAY"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "startOfWeek": "$startOfWeek"} } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1611512616000"} } , "endDate": {"$date": {"$numberLong": "1611541416000"} }, "unit": "week", "startOfWeek": "monday"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "startOfWeek": "$startOfWeek"} } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1611512616000"} } , "endDate": {"$date": {"$numberLong": "1611541416000"} }, "unit": "week", "startOfWeek": "tuesday"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "startOfWeek": "$startOfWeek"} } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{"startDate": {"$date": {"$numberLong": "1610859600000"} } , "endDate": {"$date": {"$numberLong": "1610859540000"} }, "unit": "week", "startOfWeek": "sunday", "timezone": "America/New_York"}','{"result": {"$dateDiff": {"startDate": "$startDate" , "endDate": "$endDate", "unit": "$unit", "startOfWeek": "$startOfWeek", "timezone": "$timezone"} } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

-- $dateDiff unit month
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1262304000000"} } , "endDate": {"$date": {"$numberLong": "1293840000000"} }, "unit": "month"  } } }');
           bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "12" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1262304000000"} } , "endDate": {"$date": {"$numberLong": "1309392000000"} }, "unit": "month"  } } }');
           bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "17" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1267401600000"} } , "endDate": {"$date": {"$numberLong": "1272585600000"} }, "unit": "month"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1267401600000"} } , "endDate": {"$date": {"$numberLong": "1272585600000"} }, "unit": "month"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "993859200000"} } , "endDate": {"$date": {"$numberLong": "1262304000000"} }, "unit": "month"  } } }');
           bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "103" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"endDate": {"$date": {"$numberLong": "993859200000"} } , "startDate": {"$date": {"$numberLong": "1262304000000"} }, "unit": "month"  } } }');
            bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-103" } }
(1 row)

-- $dateDiff unit quarter
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1262304000000"} } , "endDate": {"$date": {"$numberLong": "1293840000000"} }, "unit": "quarter"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "4" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1262304000000"} } , "endDate": {"$date": {"$numberLong": "1309392000000"} }, "unit": "quarter"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "5" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1267401600000"} } , "endDate": {"$date": {"$numberLong": "1272585600000"} }, "unit": "quarter"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1267401600000"} } , "endDate": {"$date": {"$numberLong": "1272585600000"} }, "unit": "quarter"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "993859200000"} } , "endDate": {"$date": {"$numberLong": "1262304000000"} }, "unit": "quarter"  } } }');
           bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "35" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"endDate": {"$date": {"$numberLong": "993859200000"} } , "startDate": {"$date": {"$numberLong": "1262304000000"} }, "unit": "quarter"  } } }');
           bson_dollar_project            
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-35" } }
(1 row)

-- $dateDiff unit year
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1262304000000"} } , "endDate": {"$date": {"$numberLong": "1293840000000"} }, "unit": "year"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1262304000000"} } , "endDate": {"$date": {"$numberLong": "1309392000000"} }, "unit": "year"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1267401600000"} } , "endDate": {"$date": {"$numberLong": "1272585600000"} }, "unit": "year"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1267401600000"} } , "endDate": {"$date": {"$numberLong": "1272585600000"} }, "unit": "year"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "0" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "993859200000"} } , "endDate": {"$date": {"$numberLong": "1262304000000"} }, "unit": "year"  } } }');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "9" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"endDate": {"$date": {"$numberLong": "993859200000"} } , "startDate": {"$date": {"$numberLong": "1262304000000"} }, "unit": "year"  } } }');
           bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-9" } }
(1 row)

-- $dateDiff invalid cases
select * from bson_dollar_project('{}','{"result": {"$dateDiff": 1 } }');
ERROR:  $dateDiff only supports an object as its argument
select * from bson_dollar_project('{}','{"result": {"$dateDiff": "abc" } }');
ERROR:  $dateDiff only supports an object as its argument
select * from bson_dollar_project('{}','{"result": {"$dateDiff": ["abc"] } }');
ERROR:  $dateDiff only supports an object as its argument
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {} } }');
ERROR:  Missing 'startDate' parameter to $dateDiff
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": {"$date": {"$numberLong": "1262304000000"} } , "unit": "month"  } } }');
ERROR:  Missing 'endDate' parameter to $dateDiff
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"endDate": {"$date": {"$numberLong": "1262304000000"} } , "unit": "month"  } } }');
ERROR:  Missing 'startDate' parameter to $dateDiff
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"startDate": 1 , "unit": "month",  "endDate": {"$date": {"$numberLong": "1262304000000"} } } } }');
ERROR:  $dateDiff requires 'startDate' to be a date, but got int
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"endDate": 1 , "unit": "month",  "startDate": {"$date": {"$numberLong": "1262304000000"} } } } }');
ERROR:  $dateDiff requires 'endDate' to be a date, but got int
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"hex":1, "endDate": 1 , "unit": "month",  "startDate": {"$date": {"$numberLong": "1262304000000"} } } } }');
ERROR:  Unrecognized argument to $dateDiff: hex
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"endDate": {"$date": {"$numberLong": "1262304000000"} } , "unit": "ashd",  "startDate": {"$date": {"$numberLong": "1262304000000"} } } } }');
ERROR:  $dateDiff parameter 'unit' value cannot be recognized as a time unit: ashd
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"endDate": {"$date": {"$numberLong": "1262304000000"} } , "unit": 1,  "startDate": {"$date": {"$numberLong": "1262304000000"} } } } }');
ERROR:  $dateDiff requires 'unit' to be a string, but got int
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"endDate": {"$date": {"$numberLong": "1262304000000"} } , "unit": "week",  "startDate": {"$date": {"$numberLong": "1262304000000"} }, "timezone" : 1 } } }');
ERROR:  timezone must evaluate to a string, found int
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"endDate": {"$date": {"$numberLong": "1262304000000"} } , "unit": "week",  "startDate": {"$date": {"$numberLong": "1262304000000"} }, "timezone" : "abcd" } } }');
ERROR:  unrecognized time zone identifier: "abcd"
select * from bson_dollar_project('{}','{"result": {"$dateDiff": {"endDate": {"$date": {"$numberLong": "1262304000000"} } , "unit": "week",  "startDate": {"$date": {"$numberLong": "1262304000000"} }, "timezone" : "UTC", "startOfWeek": "hello" } } }');
ERROR:  $dateDiff parameter 'startOfWeek' value cannot be recognized as a day of a week: hello
-- $dateFromString null cases
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": null } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11", "format": null } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11", "format": "%Y-%m-%d", "timezone": null } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

-- checking with undefined as well
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": {"$undefined": true} } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11", "format": {"$undefined": true} } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11", "format": "%Y-%m-%d", "timezone": {"$undefined": true} } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

-- onError null does not effect null response
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11", "format": "%Y-%m-%d", "timezone": "UTC", "onError": null} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610352000000" } } }
(1 row)

-- $dateFromString null cases with document
select * from bson_dollar_project('{"dateString": null}','{"result": {"$dateFromString": {"dateString": "$dateString" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{"dateString": "2021-01-11", "format": null }','{"result": {"$dateFromString": {"dateString": "$dateString", "format": "$format" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{"dateString": "2021-01-11", "format": "%Y-%m-%d", "timezone": null }','{"result": {"$dateFromString": {"dateString": "$dateString", "format": "$format", "timezone": "$timezone" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{"dateString": {"$undefined": true} }','{"result": {"$dateFromString": {"dateString": "$dateString"} } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{"dateString": "2021-01-11", "format": {"$undefined": true}}','{"result": {"$dateFromString": {"dateString": "$dateString", "format": "$format" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

select * from bson_dollar_project('{"dateString": "2021-01-11", "format": "%Y-%m-%d", "timezone": {"$undefined": true}}','{"result": {"$dateFromString": {"dateString": "$dateString", "format": "$format", "timezone": "$timezone" } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

-- onError null does not effect null response
select * from bson_dollar_project('{"dateString": "2021-01-11", "format": "%Y-%m-%d", "timezone": "UTC", "onError": null}','{"result": {"$dateFromString": {"dateString": "$dateString", "format": "$format", "timezone": "$timezone", "onError": "$onError"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610352000000" } } }
(1 row)

-- $dateFromString normal cases
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12:53:12.506Z", "format": "%Y-%m-%dT%H:%M:%S.%LZ"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392506" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12.53.12.506Z", "format": "%Y-%m-%dT%H.%M.%S.%LZ"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392506" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "ABCD 2021-01-11T12.53.12.506Z", "format": "ABCD %Y-%m-%dT%H.%M.%S.%LZ"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392506" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2025-12-31", "format": "%Y-%m-%d"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1767168000000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "20-1-1", "format": "%Y-%m-%d"} } }');
                        bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-61536038822000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "Year 2025, Month 12, Day 31", "format": "Year %Y, Month %m, Day %d"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1767168000000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12:53:12.506Z"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392506" } } }
(1 row)

-- millisecond can be of min 1 and max 3 digits
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12.53.12.5Z", "format": "%Y-%m-%dT%H.%M.%S.%LZ"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392500" } } }
(1 row)

-- millisecond of 2 digits
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12.53.12.50Z", "format": "%Y-%m-%dT%H.%M.%S.%LZ"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392500" } } }
(1 row)

-- iso date format
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "53.7.2017", "format": "%V.%u.%G"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1515312000000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "1.1.1", "format": "%V.%u.%G"} } }');
                        bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-62135568422000" } } }
(1 row)

-- iso part only requires year
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2017", "format": "%G"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1483344000000" } } }
(1 row)

-- % format specifier parsing test
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "% 2021-01-11T12:53:12.506Z", "format": "%% %Y-%m-%dT%H:%M:%S.%LZ"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392506" } } }
(1 row)

-- $dateFromString normal cases with document
select * from bson_dollar_project('{"dateString": "2021-01-11T12:53:12.506Z", "format": "%Y-%m-%dT%H:%M:%S.%LZ"}','{"result": {"$dateFromString": {"dateString": "$dateString" , "format": "$format"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392506" } } }
(1 row)

select * from bson_dollar_project('{"dateString": "2021-01-11T12.53.12.506Z", "format": "%Y-%m-%dT%H.%M.%S.%LZ"}','{"result": {"$dateFromString": {"dateString": "$dateString" , "format": "$format"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392506" } } }
(1 row)

select * from bson_dollar_project('{"dateString": "ABCD 2021-01-11T12.53.12.506Z", "format": "ABCD %Y-%m-%dT%H.%M.%S.%LZ"}','{"result": {"$dateFromString": {"dateString": "$dateString" , "format": "$format"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392506" } } }
(1 row)

select * from bson_dollar_project('{"dateString": "2025-12-31", "format": "%Y-%m-%d"}','{"result": {"$dateFromString": {"dateString": "$dateString" , "format": "$format"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1767168000000" } } }
(1 row)

select * from bson_dollar_project('{"dateString": "20-1-1", "format": "%Y-%m-%d"}','{"result": {"$dateFromString": {"dateString": "$dateString" , "format": "$format"} } }');
                        bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-61536038822000" } } }
(1 row)

select * from bson_dollar_project('{"dateString": "Year 2025, Month 12, Day 31", "format": "Year %Y, Month %m, Day %d"}','{"result": {"$dateFromString": {"dateString": "$dateString" , "format": "$format"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1767168000000" } } }
(1 row)

select * from bson_dollar_project('{"dateString": "2021-01-11T12:53:12.506Z"}','{"result": {"$dateFromString": {"dateString": "$dateString"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392506" } } }
(1 row)

-- millisecond can be of min 1 and max 3 digits
select * from bson_dollar_project('{"dateString": "2021-01-11T12.53.12.5Z", "format": "%Y-%m-%dT%H.%M.%S.%LZ"}','{"result": {"$dateFromString": {"dateString": "$dateString" , "format": "$format"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392500" } } }
(1 row)

-- millisecond of 2 digits
select * from bson_dollar_project('{"dateString": "2021-01-11T12.53.12.50Z", "format": "%Y-%m-%dT%H.%M.%S.%LZ"}','{"result": {"$dateFromString": {"dateString": "$dateString" , "format": "$format"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392500" } } }
(1 row)

-- iso date format
select * from bson_dollar_project('{"dateString": "53.7.2017", "format": "%V.%u.%G"}','{"result": {"$dateFromString": {"dateString": "$dateString" , "format": "$format"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1515312000000" } } }
(1 row)

select * from bson_dollar_project('{"dateString": "1.1.1", "format": "%V.%u.%G"}','{"result": {"$dateFromString": {"dateString": "$dateString" , "format": "$format"} } }');
                        bson_dollar_project                         
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-62135568422000" } } }
(1 row)

-- iso part only requires year
select * from bson_dollar_project('{"dateString": "2017", "format": "%G"}','{"result": {"$dateFromString": {"dateString": "$dateString" , "format": "$format"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1483344000000" } } }
(1 row)

-- $dateFromString cases with onNull
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": null, "format": "%Y-%m-%dT%H:%M:%S.%LZ", "onNull": "5"} } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : "5" }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": null, "format": "%Y-%m-%dT%H:%M:%S.%LZ", "onNull": 1} } }');
          bson_dollar_project          
---------------------------------------------------------------------
 { "result" : { "$numberInt" : "1" } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": null, "format": "%Y-%m-%dT%H:%M:%S.%LZ", "onNull":  {"$date": {"$numberLong": "1678924740500"} }} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1678924740500" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "$missing", "onNull": "$missing"} } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { }
(1 row)

-- only when dateString is nullish value, onNull is considered
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2018-02-06T11:56:02Z", "format": null, "onNull": 1} } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

-- onNull with document cases
select * from bson_dollar_project('{"dateString": null, "format": "%Y-%m-%dT%H:%M:%S.%LZ", "onNull": "5"}','{"result": {"$dateFromString": {"dateString": "$dateFromString", "format": "$format", "onNull": "$onNull"} } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : "5" }
(1 row)

select * from bson_dollar_project('{"dateString": null, "format": "%Y-%m-%dT%H:%M:%S.%LZ", "onNull": 1}','{"result": {"$dateFromString": {"dateString": "$dateString", "format": "$format", "onNull": "$onNull"} } }');
          bson_dollar_project          
---------------------------------------------------------------------
 { "result" : { "$numberInt" : "1" } }
(1 row)

select * from bson_dollar_project('{"dateString": null, "format": "%Y-%m-%dT%H:%M:%S.%LZ", "onNull":  {"$date": {"$numberLong": "1678924740500"} }}','{"result": {"$dateFromString": {"dateString": "$dateString", "format": "$format", "onNull":  "$onNull"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1678924740500" } } }
(1 row)

-- $dateFromString cases with timezone
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12:53:12.506Z", "format": "%Y-%m-%dT%H:%M:%S.%LZ", "timezone": "UTC"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392506" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12:53:12.506Z", "format": "%Y-%m-%dT%H:%M:%S.%LZ", "timezone": "+01:00"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610394792506" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12:53:12.506Z", "format": "%Y-%m-%dT%H:%M:%S.%LZ", "timezone": "America/Denver"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610423592506" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12:53:12.506+130", "format": "%Y-%m-%dT%H:%M:%S.%L%Z"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610390592506" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12:53:12.506-130", "format": "%Y-%m-%dT%H:%M:%S.%L%Z"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610406192506" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "Year is 2021 , Month is 12 and Day is @ 12 with minute offset +560", "format": "Year is %Y , Month is %m and Day is @ %d with minute offset %Z"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1639262400000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12:53:12.506+0130", "format": "%Y-%m-%dT%H:%M:%S.%L%z"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610392992506" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12:53:12.506-01:30", "format": "%Y-%m-%dT%H:%M:%S.%L%z"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610403792506" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12:53:12.506 UTC", "format": "%Y-%m-%dT%H:%M:%S.%L %z"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392506" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12:53:12.506 MST", "format": "%Y-%m-%dT%H:%M:%S.%L %z"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610423592506" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2021-01-11T12:53:12.506 GMT-03:00", "format": "%Y-%m-%dT%H:%M:%S.%L %z"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610409192506" } } }
(1 row)

-- $dateFromString invalid cases
select * from bson_dollar_project('{}','{"result": {"$dateFromString": "a" } }');
ERROR:  $dateFromString only supports an object as an argument, found: string
select * from bson_dollar_project('{}','{"result": {"$dateFromString": 1 } }');
ERROR:  $dateFromString only supports an object as an argument, found: int
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {} } }');
ERROR:  Missing 'dateString' parameter to $dateFromString
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": 5} } }');
ERROR:  $dateFromString requires that 'dateString' be a string, found: int with value 5
select * FROM bson_dollar_project('{"dates": { "startDate": "2024-04-15", "endDate": "2024-05-14" }}','{ "result": { "$dateFromString": {"dateString": "$dates", "format": "%Y-%m-%d"}}}');
ERROR:  $dateFromString requires that 'dateString' be a string, found: object with value { "startDate" : "2024-04-15", "endDate" : "2024-05-14" }
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2022-10-12", "format": 1} } }');
ERROR:  $dateFromString requires that 'format' be a string, found: int with value 1
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2022-10-12", "format": " %Y-%m-%d"} } }');
ERROR:  Error parsing date string '2022-10-12'. Format literal not found '2'
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2022-10-12", "format": " %Y-%m-%d"} } }');
ERROR:  Error parsing date string '2022-10-12'. Format literal not found '2'
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2024 1002", "format": "%Y %j" } } }');
ERROR:  Error parsing date string '2024 1002'. Trailing data '2'
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "Jenuery 1 2024", "format": "%B %d %Y" } } }');
ERROR:  an incomplete date/time string has been found, with elements missing: 'Jenuery 1 2024'
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "act 1 2024", "format": "%b %d %Y" } } }');
ERROR:  an incomplete date/time string has been found, with elements missing: 'act 1 2024'
-- unkown argument in input
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2022-10-12", "format": " %Y-%m-%d", "unknown":1} } }');
ERROR:  Unrecognized argument to $dateFromString: unknown
-- passing timezone as input with existing timezone in string
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2017-07-12T22:23:55 GMT+02:00", "format": "%Y-%m-%dT%H:%M:%S %z", "timezone": "Europe/Paris"} } }');
ERROR:  you cannot pass in a date/time string with GMT offset together with a timezone argument
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2017-07-12T22:23:55 GMT", "format": "%Y-%m-%dT%H:%M:%S %z", "timezone": "Europe/Paris"} } }');
ERROR:  you cannot pass in a date/time string with time zone information ('GMT') together with a timezone argument
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2017-07-12T22:23:55 +02:20", "format": "%Y-%m-%dT%H:%M:%S %z", "timezone": "Europe/Paris"} } }');
ERROR:  you cannot pass in a date/time string with GMT offset together with a timezone argument
-- not enough data
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2017-07T22:23:55 GMT+02:00", "format": "%Y-%mT%H:%M:%S %z"} } }');
ERROR:  an incomplete date/time string has been found, with elements missing: '2017-07T22:23:55 GMT+02:00'
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2017", "format": "%C"} } }');
ERROR:  Invalid format character '%C' in format string
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "ISO Week 1, 2018", "format": "ISO Week %V, %Y"} } }');
ERROR:  Error parsing date string 'ISO Week 1, 2018'; Mixing of ISO dates with natural dates is not allowed
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "12/31/2018", "format": "%m/%d\\0/%Y"} } }');
ERROR:  Error parsing date string '12/31/2018'. Format literal not found '/'
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2017-12", "format": "%Y"} } }');
ERROR:  Error parsing date string '2017-12'. Trailing data '-'
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "ISO Day 6", "format": "ISO Day %V"} }}');
ERROR:  Error parsing date string 'ISO Day 6';The parsed date was invalid
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "12/31/2018", "format": "%m/%d/%G"} } }');
ERROR:  Error parsing date string '12/31/2018'; Mixing of ISO dates with natural dates is not allowed
-- % format specifier test
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "% 2021-01-11T12:53:12.506Z", "format": "% %Y-%m-%dT%H:%M:%S.%LZ"} } }');
ERROR:  Invalid format character '% ' in format string
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "% 2021-01-11T12:53:12.506Z", "format": "%%Y-%m-%dT%H:%M:%S.%LZ"} } }');
ERROR:  Error parsing date string '% 2021-01-11T12:53:12.506Z'. Format literal not found ' '
-- $dateFromString cases with onError
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": "error handled","dateString": 5} } }');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "error handled" }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": "error handled","dateString": "2022-10-12", "format": " %Y-%m-%d"} } }');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "error handled" }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": "error handled","dateString": "2022-10-12", "format": " %Y-%m-%d"} } }');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "error handled" }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": "error handled","dateString": "2022-10-12", "format": null } } }');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

-- if dateString is not a string, onError should be considered
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": "error handled","dateString": 5, "format": null } } }');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "error handled" }
(1 row)

-- passing timezone as input with existing timezone in string
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": "error handled","dateString": "2017-07-12T22:23:55 GMT+02:00", "format": "%Y-%m-%dT%H:%M:%S %z", "timezone": "Europe/Paris"} } }');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "error handled" }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": "error handled","dateString": "2017-07-12T22:23:55 GMT", "format": "%Y-%m-%dT%H:%M:%S %z", "timezone": "Europe/Paris"} } }');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "error handled" }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": "error handled", "dateString": "2017-07-12T22:23:55 +02:20", "format": "%Y-%m-%dT%H:%M:%S %z", "timezone": "Europe/Paris"} } }');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "error handled" }
(1 row)

-- not enough data
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": "error handled","dateString": "2017-07T22:23:55 GMT+02:00", "format": "%Y-%mT%H:%M:%S %z"} } }');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "error handled" }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": "error handled","dateString": "ISO Week 1, 2018", "format": "ISO Week %V, %Y"} } }');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "error handled" }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": "error handled","dateString": "12/31/2018", "format": "%m/%d\\0/%Y"} } }');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "error handled" }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": "error handled","dateString": "2017-12", "format": "%Y"} } }');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "error handled" }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": "error handled","dateString": "ISO Day 6", "format": "ISO Day %V"} } }');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "error handled" }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": "error handled","dateString": "12/31/2018", "format": "%m/%d/%G"} } }');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "error handled" }
(1 row)

-- checking with changing onError return type
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": {"$date": {"$numberLong": "1678924740500"} },"dateString": 5} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1678924740500" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": {"$date": {"$numberLong": "1678924740500"} },"dateString": "2022-10-12", "format": " %Y-%m-%d"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1678924740500" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"onError": {"$date": {"$numberLong": "1678924740500"} },"dateString": "2022-10-12", "format": " %Y-%m-%d"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1678924740500" } } }
(1 row)

-- adding extra format specifiers
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2024 234 04:34:11", "format": "%Y %j %H:%M:%S" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1724301240000" } } }
(1 row)

-- exception test for value of dayOfyear is 999
select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "2024 999", "format": "%Y %j" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1790380800000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "year is 2024 and the days are 234 and time is 04:34:11", "format": "year is %Y and the days are %j and time is %H:%M:%S" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1724301240000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "dec 1 2024 04:34:11", "format": "%b %d %Y %H:%M:%S" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1733056451000" } } }
(1 row)

select * from bson_dollar_project('{}','{"result": {"$dateFromString": {"dateString": "janUary 1 2024 04:34:11", "format": "%B %d %Y %H:%M:%S" } } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1704112451000" } } }
(1 row)

-- Defensive check to prevent error from ms conversion to timestamptz
SELECT * FROM bson_dollar_project('{}', '{"result": {"$dateToString": {"date":{"$toDate": {"$numberDouble": "-244058800000000"}}}}}');
ERROR:  Invalid conversion to date time.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$dateToString": {"date":{"$toDate": {"$numberDouble": "9664590969990000"}}}}}');
ERROR:  Invalid conversion to date time.
-- parse with preset formats
select * from bson_dollar_project('{"dateString": "2021-01-11 11:00:03"}','{"result": {"$dateFromString": {"dateString": "$dateString"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610391603000" } } }
(1 row)

select * from bson_dollar_project('{"dateString": "2021-01-11T12:53:12"}','{"result": {"$dateFromString": {"dateString": "$dateString"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1610398392000" } } }
(1 row)

select * from bson_dollar_project('{"dateString": "July 4th, 2017"}','{"result": {"$dateFromString": {"dateString": "$dateString"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1499151600000" } } }
(1 row)

select * from bson_dollar_project('{"dateString": "July 4th, 2017 12:39:30 BST"}','{"result": {"$dateFromString": {"dateString": "$dateString"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1499193570000" } } }
(1 row)

select * from bson_dollar_project('{"dateString": "July 4th, 2017 11am"}','{"result": {"$dateFromString": {"dateString": "$dateString"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1499191200000" } } }
(1 row)

select * from bson_dollar_project('{"dateString": "2017-Jul-04 noon"}','{"result": {"$dateFromString": {"dateString": "$dateString"} } }');
                       bson_dollar_project                        
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "1499194800000" } } }
(1 row)

