SET search_path TO documentdb_core,documentdb_api,documentdb_api_catalog,documentdb_api_internal;
SET citus.next_shard_id TO 5150000;
SET documentdb.next_collection_id TO 51500;
SET documentdb.next_collection_index_id TO 51500;
/* Insert data, normal case*/
SELECT documentdb_api.insert_one('db','redactTest1','{ "_id": 1, "level": "public", "content": "content 1", "details": { "level": "public", "value": "content 1.1", "moreDetails": { "level": "restricted", "info": "content 1.1.1" } } }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactTest1','{ "_id": 2, "level": "restricted", "content": "content 2", "details": { "level": "public", "value": "content 2.1", "moreDetails": { "level": "restricted", "info": "content 2.1.1" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactTest1','{ "_id": 3, "level": "public", "content": "content 3", "details": { "level": "restricted", "value": "content 3.1", "moreDetails": { "level": "public", "info": "content 3.1.1" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactTest1','{ "_id": 4, "content": "content 4", "details": { "level": "public", "value": "content 4.1" } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactTest1','{ "_id": 5, "level": "public", "content": "content 5", "details": { "level": "public", "value": "content 5.1", "moreDetails": [{ "level": "restricted", "info": "content 5.1.1" }, { "level": "public", "info": "content 5.1.2" }] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', 
    '{ "aggregate": "redactTest1", "pipeline": [ { "$redact": { "$cond": { "if": { "$eq": ["$level", "public"] }, "then": "$$KEEP", "else": "$$PRUNE" } } }  ], "cursor": {} }');
                                                                                                                                 document                                                                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : "public", "content" : "content 1", "details" : { "level" : "public", "value" : "content 1.1", "moreDetails" : { "level" : "restricted", "info" : "content 1.1.1" } } }
 
 { "_id" : { "$numberInt" : "3" }, "level" : "public", "content" : "content 3", "details" : { "level" : "restricted", "value" : "content 3.1", "moreDetails" : { "level" : "public", "info" : "content 3.1.1" } } }
 
 { "_id" : { "$numberInt" : "5" }, "level" : "public", "content" : "content 5", "details" : { "level" : "public", "value" : "content 5.1", "moreDetails" : [ { "level" : "restricted", "info" : "content 5.1.1" }, { "level" : "public", "info" : "content 5.1.2" } ] } }
(5 rows)

SELECT document FROM bson_aggregation_pipeline('db', 
    '{ "aggregate": "redactTest1", "pipeline": [ { "$redact": { "$cond": { "if": { "$eq": ["$level", "public"] }, "then": "$$DESCEND", "else": "$$PRUNE" } } }  ], "cursor": {} }');
                                                                                                      document                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : "public", "content" : "content 1", "details" : { "level" : "public", "value" : "content 1.1" } }
 
 { "_id" : { "$numberInt" : "3" }, "level" : "public", "content" : "content 3" }
 
 { "_id" : { "$numberInt" : "5" }, "level" : "public", "content" : "content 5", "details" : { "level" : "public", "value" : "content 5.1", "moreDetails" : [ { "level" : "public", "info" : "content 5.1.2" } ] } }
(5 rows)

/* Insert data, add validation for array-nested subdocument, array of documents, array of arrays, empty document being returned,  test DESCEND and PRUNE*/
SELECT documentdb_api.insert_one('db','redactTest2','{ "_id": 1, "level": 1, "a": { "level": 2, "b": { "level": 4, "c": { "level": 1, "d": 8 } } }, "e": 20 }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactTest2','{ "_id": 2, "level": 4, "a": { "level": 3, "b": [{ "level": 1, "e": 4 }] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactTest2','{ "_id": 3, "level": 2, "a": { "b": { "level": 3, "n": 12 } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactTest2','{ "_id": 4, "level": 3, "a": [{ "level": 5, "b": 20 }] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactTest2','{ "_id": 5, "level": 3, "b": { "level": 3, "d": [ { "level": 1, "e": 4 }, { "level": 5, "g": 9 }, [{ "level": 1, "r": 11 }, 52, 42, 75, { "level": 5, "s": 3 }]] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest2", "pipeline": [ { "$redact": { "$cond": [{"$lte": ["$level", 1]}, "$$DESCEND", "$$PRUNE"] } }  ], "cursor": {} }');
                                              document                                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "e" : { "$numberInt" : "20" } }
 
 
 
 
(5 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest2", "pipeline": [ { "$redact": { "$cond": [{"$lte": ["$level", 2]}, "$$DESCEND", "$$PRUNE"] } }  ], "cursor": {} }');
                                                                    document                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "2" } }, "e" : { "$numberInt" : "20" } }
 
 { "_id" : { "$numberInt" : "3" }, "level" : { "$numberInt" : "2" }, "a" : {  } }
 
 
(5 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest2", "pipeline": [ { "$redact": { "$cond": [{"$lte": ["$level", 3]}, "$$DESCEND", "$$PRUNE"] } }  ], "cursor": {} }');
                                                                                                                                                                      document                                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "2" } }, "e" : { "$numberInt" : "20" } }
 
 { "_id" : { "$numberInt" : "3" }, "level" : { "$numberInt" : "2" }, "a" : { "b" : { "level" : { "$numberInt" : "3" }, "n" : { "$numberInt" : "12" } } } }
 { "_id" : { "$numberInt" : "4" }, "level" : { "$numberInt" : "3" }, "a" : [  ] }
 { "_id" : { "$numberInt" : "5" }, "level" : { "$numberInt" : "3" }, "b" : { "level" : { "$numberInt" : "3" }, "d" : [ { "level" : { "$numberInt" : "1" }, "e" : { "$numberInt" : "4" } }, [ { "level" : { "$numberInt" : "1" }, "r" : { "$numberInt" : "11" } }, { "$numberInt" : "52" }, { "$numberInt" : "42" }, { "$numberInt" : "75" } ] ] } }
(5 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest2", "pipeline": [ { "$redact": { "$cond": [{"$lte": ["$level", 4]}, "$$DESCEND", "$$PRUNE"] } }  ], "cursor": {} }');
                                                                                                                                                                      document                                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "2" }, "b" : { "level" : { "$numberInt" : "4" }, "c" : { "level" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "8" } } } }, "e" : { "$numberInt" : "20" } }
 { "_id" : { "$numberInt" : "2" }, "level" : { "$numberInt" : "4" }, "a" : { "level" : { "$numberInt" : "3" }, "b" : [ { "level" : { "$numberInt" : "1" }, "e" : { "$numberInt" : "4" } } ] } }
 { "_id" : { "$numberInt" : "3" }, "level" : { "$numberInt" : "2" }, "a" : { "b" : { "level" : { "$numberInt" : "3" }, "n" : { "$numberInt" : "12" } } } }
 { "_id" : { "$numberInt" : "4" }, "level" : { "$numberInt" : "3" }, "a" : [  ] }
 { "_id" : { "$numberInt" : "5" }, "level" : { "$numberInt" : "3" }, "b" : { "level" : { "$numberInt" : "3" }, "d" : [ { "level" : { "$numberInt" : "1" }, "e" : { "$numberInt" : "4" } }, [ { "level" : { "$numberInt" : "1" }, "r" : { "$numberInt" : "11" } }, { "$numberInt" : "52" }, { "$numberInt" : "42" }, { "$numberInt" : "75" } ] ] } }
(5 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest2", "pipeline": [ { "$redact": { "$cond": [{"$lte": ["$level", 5]}, "$$DESCEND", "$$PRUNE"] } }  ], "cursor": {} }');
                                                                                                                                                                                                                                          document                                                                                                                                                                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "2" }, "b" : { "level" : { "$numberInt" : "4" }, "c" : { "level" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "8" } } } }, "e" : { "$numberInt" : "20" } }
 { "_id" : { "$numberInt" : "2" }, "level" : { "$numberInt" : "4" }, "a" : { "level" : { "$numberInt" : "3" }, "b" : [ { "level" : { "$numberInt" : "1" }, "e" : { "$numberInt" : "4" } } ] } }
 { "_id" : { "$numberInt" : "3" }, "level" : { "$numberInt" : "2" }, "a" : { "b" : { "level" : { "$numberInt" : "3" }, "n" : { "$numberInt" : "12" } } } }
 { "_id" : { "$numberInt" : "4" }, "level" : { "$numberInt" : "3" }, "a" : [ { "level" : { "$numberInt" : "5" }, "b" : { "$numberInt" : "20" } } ] }
 { "_id" : { "$numberInt" : "5" }, "level" : { "$numberInt" : "3" }, "b" : { "level" : { "$numberInt" : "3" }, "d" : [ { "level" : { "$numberInt" : "1" }, "e" : { "$numberInt" : "4" } }, { "level" : { "$numberInt" : "5" }, "g" : { "$numberInt" : "9" } }, [ { "level" : { "$numberInt" : "1" }, "r" : { "$numberInt" : "11" } }, { "$numberInt" : "52" }, { "$numberInt" : "42" }, { "$numberInt" : "75" }, { "level" : { "$numberInt" : "5" }, "s" : { "$numberInt" : "3" } } ] ] } }
(5 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest2", "pipeline": [ { "$redact": { "$cond": [{"$lte": ["$level", 5]}, { "$literal" :"$$DESCEND"}, "$$PRUNE"] } }  ], "cursor": {} }');
                                                                                                                                                                                                                                          document                                                                                                                                                                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "2" }, "b" : { "level" : { "$numberInt" : "4" }, "c" : { "level" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "8" } } } }, "e" : { "$numberInt" : "20" } }
 { "_id" : { "$numberInt" : "2" }, "level" : { "$numberInt" : "4" }, "a" : { "level" : { "$numberInt" : "3" }, "b" : [ { "level" : { "$numberInt" : "1" }, "e" : { "$numberInt" : "4" } } ] } }
 { "_id" : { "$numberInt" : "3" }, "level" : { "$numberInt" : "2" }, "a" : { "b" : { "level" : { "$numberInt" : "3" }, "n" : { "$numberInt" : "12" } } } }
 { "_id" : { "$numberInt" : "4" }, "level" : { "$numberInt" : "3" }, "a" : [ { "level" : { "$numberInt" : "5" }, "b" : { "$numberInt" : "20" } } ] }
 { "_id" : { "$numberInt" : "5" }, "level" : { "$numberInt" : "3" }, "b" : { "level" : { "$numberInt" : "3" }, "d" : [ { "level" : { "$numberInt" : "1" }, "e" : { "$numberInt" : "4" } }, { "level" : { "$numberInt" : "5" }, "g" : { "$numberInt" : "9" } }, [ { "level" : { "$numberInt" : "1" }, "r" : { "$numberInt" : "11" } }, { "$numberInt" : "52" }, { "$numberInt" : "42" }, { "$numberInt" : "75" }, { "level" : { "$numberInt" : "5" }, "s" : { "$numberInt" : "3" } } ] ] } }
(5 rows)

/* Insert data, test KEEP*/
SELECT documentdb_api.insert_one('db','redactTest3','{ "_id": 1, "level": 1, "a": { "level": 1, "b": 1 }, "c": { "level": 1, "d": 1 }}', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactTest3','{ "_id": 2, "level": 2, "a": { "level": 2, "b": 2 }, "c": { "level": 2, "d": 2 }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactTest3','{ "_id": 3, "level": 3, "a": { "level": 3, "b": 3 }, "c": { "level": 3, "d": 3 }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": { "$cond": [{"$lte": ["$level", 1]}, "$$KEEP", "$$PRUNE"] } }  ], "cursor": {} }');
                                                                                                         document                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }, "c" : { "level" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "1" } } }
 
 
(3 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": { "$cond": [{"$lte": ["$level", 2]}, "$$KEEP", "$$PRUNE"] } }  ], "cursor": {} }');
                                                                                                         document                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }, "c" : { "level" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "1" } } }
 { "_id" : { "$numberInt" : "2" }, "level" : { "$numberInt" : "2" }, "a" : { "level" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "2" } }, "c" : { "level" : { "$numberInt" : "2" }, "d" : { "$numberInt" : "2" } } }
 
(3 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": { "$cond": [{"$lte": ["$level", 3]}, "$$KEEP", "$$PRUNE"] } }  ], "cursor": {} }');
                                                                                                         document                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }, "c" : { "level" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "1" } } }
 { "_id" : { "$numberInt" : "2" }, "level" : { "$numberInt" : "2" }, "a" : { "level" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "2" } }, "c" : { "level" : { "$numberInt" : "2" }, "d" : { "$numberInt" : "2" } } }
 { "_id" : { "$numberInt" : "3" }, "level" : { "$numberInt" : "3" }, "a" : { "level" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "3" } }, "c" : { "level" : { "$numberInt" : "3" }, "d" : { "$numberInt" : "3" } } }
(3 rows)

/*test directly systemvariable*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": "$$KEEP" }], "cursor": {} }');
                                                                                                         document                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }, "c" : { "level" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "1" } } }
 { "_id" : { "$numberInt" : "2" }, "level" : { "$numberInt" : "2" }, "a" : { "level" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "2" } }, "c" : { "level" : { "$numberInt" : "2" }, "d" : { "$numberInt" : "2" } } }
 { "_id" : { "$numberInt" : "3" }, "level" : { "$numberInt" : "3" }, "a" : { "level" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "3" } }, "c" : { "level" : { "$numberInt" : "3" }, "d" : { "$numberInt" : "3" } } }
(3 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": "$$PRUNE"}], "cursor": {} }');
 document 
---------------------------------------------------------------------
 
 
 
(3 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": "$$DESCEND"}], "cursor": {} }');
                                                                                                         document                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }, "c" : { "level" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "1" } } }
 { "_id" : { "$numberInt" : "2" }, "level" : { "$numberInt" : "2" }, "a" : { "level" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "2" } }, "c" : { "level" : { "$numberInt" : "2" }, "d" : { "$numberInt" : "2" } } }
 { "_id" : { "$numberInt" : "3" }, "level" : { "$numberInt" : "3" }, "a" : { "level" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "3" } }, "c" : { "level" : { "$numberInt" : "3" }, "d" : { "$numberInt" : "3" } } }
(3 rows)

/*switch case*/
SELECT documentdb_api.insert_one('db','redactTestSwitch','{ "_id": 1, "title": "Document 1", "classification": "confidential", "content": "This is confidential content.", "metadata": { "author": "Alice", "revision": 3 } }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactTestSwitch','{ "_id": 2, "title": "Document 2", "classification": "public", "content": "This is public content.", "metadata": { "author": "Bob", "revision": 1 } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactTestSwitch','{ "_id": 3, "title": "Document 3", "classification": "restricted", "content": "This content is restricted.", "metadata": { "author": "Charlie", "revision": 2 } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTestSwitch", "pipeline": [ { "$redact": { "$switch": { "branches": [ { "case": { "$eq": ["$classification", "confidential"] }, "then": "$$PRUNE" }, { "case": { "$eq": ["$classification", "restricted"] }, "then": { "$cond": { "if": { "$eq": ["$content", null] }, "then": "$$KEEP", "else": "$$PRUNE" } } }], "default": "$$KEEP" } }  }], "cursor": {} }');
                                                                                                document                                                                                                
---------------------------------------------------------------------
 
 { "_id" : { "$numberInt" : "2" }, "title" : "Document 2", "classification" : "public", "content" : "This is public content.", "metadata" : { "author" : "Bob", "revision" : { "$numberInt" : "1" } } }
 
(3 rows)

/*$lookup $let and $redact example*/
SELECT documentdb_api.insert_one('db','redactUsers','{ "_id": 1, "name": "Alice"}', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactUsers','{ "_id": 2, "name": "Bob"}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactUsers','{ "_id": 3, "name": "Charlie"}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactOrders','{ "_id": 1, "user_id": 1, "order_amount":150, "status": "completed"}', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactOrders','{ "_id": 2, "user_id": 1, "order_amount":200, "status": "pending"}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactOrders','{ "_id": 3, "user_id": 2, "order_amount":500, "status": "completed"}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactOrders','{ "_id": 4, "user_id": 2, "order_amount":50, "status": "completed"}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','redactOrders','{ "_id": 5, "user_id": 3, "order_amount":300, "status": "pending"}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

/* $redact with $let*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactUsers", "pipeline": [ { "$lookup": { "from": "redactOrders", "localField": "_id", "foreignField": "user_id", "as": "user_orders", "pipeline": [ { "$redact": { "$cond": { "if": { "$let": { "vars": { "totalAmount": { "$sum": "$$ROOT.order_amount" } }, "in": { "$gt": [ "$$totalAmount", 40 ] } } }, "then": "$$KEEP", "else": "$$PRUNE" } } } ] } } ], "cursor": {} }');
                                                                                                                                                                           document                                                                                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "Alice", "user_orders" : [ { "_id" : { "$numberInt" : "1" }, "user_id" : { "$numberInt" : "1" }, "order_amount" : { "$numberInt" : "150" }, "status" : "completed" }, { "_id" : { "$numberInt" : "2" }, "user_id" : { "$numberInt" : "1" }, "order_amount" : { "$numberInt" : "200" }, "status" : "pending" } ] }
 { "_id" : { "$numberInt" : "2" }, "name" : "Bob", "user_orders" : [ { "_id" : { "$numberInt" : "3" }, "user_id" : { "$numberInt" : "2" }, "order_amount" : { "$numberInt" : "500" }, "status" : "completed" }, { "_id" : { "$numberInt" : "4" }, "user_id" : { "$numberInt" : "2" }, "order_amount" : { "$numberInt" : "50" }, "status" : "completed" } ] }
 { "_id" : { "$numberInt" : "3" }, "name" : "Charlie", "user_orders" : [ { "_id" : { "$numberInt" : "5" }, "user_id" : { "$numberInt" : "3" }, "order_amount" : { "$numberInt" : "300" }, "status" : "pending" } ] }
(3 rows)

/* add $let with the same level with $lookup, different variable with $let in $redact*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactUsers", "pipeline": [ { "$lookup": { "from": "redactOrders", "localField": "_id", "foreignField": "user_id", "as": "user_orders", "let": { "user_id": "$_id" }, "pipeline": [ { "$redact": { "$cond": { "if": { "$let": { "vars": { "totalAmount": { "$sum": "$order_amount" } }, "in": { "$gt": [ "$$totalAmount", 40 ] } } }, "then": "$$KEEP", "else": "$$PRUNE" } } } ] } } ], "cursor": {} }');
                                                                                                                                                                           document                                                                                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "Alice", "user_orders" : [ { "_id" : { "$numberInt" : "1" }, "user_id" : { "$numberInt" : "1" }, "order_amount" : { "$numberInt" : "150" }, "status" : "completed" }, { "_id" : { "$numberInt" : "2" }, "user_id" : { "$numberInt" : "1" }, "order_amount" : { "$numberInt" : "200" }, "status" : "pending" } ] }
 { "_id" : { "$numberInt" : "2" }, "name" : "Bob", "user_orders" : [ { "_id" : { "$numberInt" : "3" }, "user_id" : { "$numberInt" : "2" }, "order_amount" : { "$numberInt" : "500" }, "status" : "completed" }, { "_id" : { "$numberInt" : "4" }, "user_id" : { "$numberInt" : "2" }, "order_amount" : { "$numberInt" : "50" }, "status" : "completed" } ] }
 { "_id" : { "$numberInt" : "3" }, "name" : "Charlie", "user_orders" : [ { "_id" : { "$numberInt" : "5" }, "user_id" : { "$numberInt" : "3" }, "order_amount" : { "$numberInt" : "300" }, "status" : "pending" } ] }
(3 rows)

/* two level $let has the same variable*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactUsers", "pipeline": [ { "$lookup": { "from": "redactOrders", "localField": "_id", "foreignField": "user_id", "as": "user_orders", "let": { "user_id": "$_id", "totalAmount": { "$sum": "$user_orders.order_amount" } }, "pipeline": [ { "$redact": { "$cond": { "if": { "$let": { "vars": { "totalAmount": { "$sum": "$order_amount" } }, "in": { "$gt": [ "$$totalAmount", 40 ] } } }, "then": "$$KEEP", "else": "$$PRUNE" } } } ] } } ], "cursor": {} }');
                                                                                                                                                                           document                                                                                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "Alice", "user_orders" : [ { "_id" : { "$numberInt" : "1" }, "user_id" : { "$numberInt" : "1" }, "order_amount" : { "$numberInt" : "150" }, "status" : "completed" }, { "_id" : { "$numberInt" : "2" }, "user_id" : { "$numberInt" : "1" }, "order_amount" : { "$numberInt" : "200" }, "status" : "pending" } ] }
 { "_id" : { "$numberInt" : "2" }, "name" : "Bob", "user_orders" : [ { "_id" : { "$numberInt" : "3" }, "user_id" : { "$numberInt" : "2" }, "order_amount" : { "$numberInt" : "500" }, "status" : "completed" }, { "_id" : { "$numberInt" : "4" }, "user_id" : { "$numberInt" : "2" }, "order_amount" : { "$numberInt" : "50" }, "status" : "completed" } ] }
 { "_id" : { "$numberInt" : "3" }, "name" : "Charlie", "user_orders" : [ { "_id" : { "$numberInt" : "5" }, "user_id" : { "$numberInt" : "3" }, "order_amount" : { "$numberInt" : "300" }, "status" : "pending" } ] }
(3 rows)

/* redact use top level $let*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactUsers", "pipeline": [ { "$lookup": { "from": "redactOrders", "localField": "_id", "foreignField": "user_id", "as": "user_orders", "let": { "user_id": "$_id" }, "pipeline": [ { "$redact": { "$cond": { "if": { "$let": { "vars": { "totalAmount": { "$sum": "$order_amount" } }, "in": { "$and": [ { "$gt": [ "$$totalAmount", 40 ] }, { "$lt": [ "$$user_id", 2 ] } ] } } }, "then": "$$KEEP", "else": "$$PRUNE" } } } ] } } ], "cursor": {} }');
                                                                                                                                                                           document                                                                                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "Alice", "user_orders" : [ { "_id" : { "$numberInt" : "1" }, "user_id" : { "$numberInt" : "1" }, "order_amount" : { "$numberInt" : "150" }, "status" : "completed" }, { "_id" : { "$numberInt" : "2" }, "user_id" : { "$numberInt" : "1" }, "order_amount" : { "$numberInt" : "200" }, "status" : "pending" } ] }
 { "_id" : { "$numberInt" : "2" }, "name" : "Bob", "user_orders" : [  ] }
 { "_id" : { "$numberInt" : "3" }, "name" : "Charlie", "user_orders" : [  ] }
(3 rows)

/*facet with redact test case user data*/
SELECT documentdb_api.insert_one('db', 'facetUsers', '{ "_id": 1, "name": "Alice", "email": "alice@example.com", "age": 25 }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'facetUsers', '{ "_id": 2, "name": "Bob", "email": "bob@example.com", "age": 25 }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'facetUsers', '{ "_id": 3, "name": "Charlie", "email": "charlie@example.com", "age": 30 }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

/*facet with redact case, one is empty array and the other is not*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "facetUsers", "pipeline": [ { "$facet": { "ageGroup": [ { "$group": { "_id": "$age", "users": { "$push": "$name" } } } ], "redactEmail": [ { "$redact": { "$cond": { "if": { "$eq": ["$email", null] }, "then": "$$KEEP", "else": "$$PRUNE" } } } ] } } ], "cursor": {} }');
                                                                                  document                                                                                  
---------------------------------------------------------------------
 { "ageGroup" : [ { "_id" : { "$numberInt" : "30" }, "users" : [ "Charlie" ] }, { "_id" : { "$numberInt" : "25" }, "users" : [ "Alice", "Bob" ] } ], "redactEmail" : [  ] }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "facetUsers", "pipeline": [ { "$facet": { "ageGroup": [ { "$group": { "_id": "$age", "users": { "$push": "$name" } } } ], "redactEmail": [ { "$redact": { "$cond": { "if": { "$eq": ["$email", "alice@example.com"] }, "then": "$$KEEP", "else": "$$PRUNE" } } } ] } } ], "cursor": {} }');
                                                                                                                                            document                                                                                                                                            
---------------------------------------------------------------------
 { "ageGroup" : [ { "_id" : { "$numberInt" : "30" }, "users" : [ "Charlie" ] }, { "_id" : { "$numberInt" : "25" }, "users" : [ "Alice", "Bob" ] } ], "redactEmail" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Alice", "email" : "alice@example.com", "age" : { "$numberInt" : "25" } } ] }
(1 row)

/*graphLookup with redact test case employee data*/
SELECT documentdb_api.insert_one('db', 'graphLookupEmployee', '{ "_id": 1, "employee_id": 1, "name": "Alice", "manager_id": null, "email": "alice@example.com" }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphLookupEmployee', '{ "_id": 2, "employee_id": 2, "name": "Bob", "manager_id": 1, "email": "bob@example.com" }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphLookupEmployee', '{ "_id": 3, "employee_id": 3, "name": "Charlie", "manager_id": 1, "email": "charlie@example.com" }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphLookupEmployee', '{ "_id": 4, "employee_id": 4, "name": "David", "manager_id": 2, "email": "david@example.com" }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphLookupEmployee', '{ "_id": 5, "employee_id": 5, "name": "Eve", "manager_id": 2, "email": "eve@example.com" }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

/*graphLookup with redact test case, prune employee do not have subordinates*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "graphLookupEmployee", "pipeline": [ { "$graphLookup": { "from": "graphLookupEmployee", "startWith": "$employee_id", "connectFromField": "employee_id", "connectToField": "manager_id", "as": "subordinates" } }, { "$redact": { "$cond": { "if": { "$eq": [{ "$size": "$subordinates" }, 0] }, "then": "$$PRUNE", "else": "$$KEEP" } } } ], "cursor": {} }');
                                                                                                                                                                                                                                                                                                                                                                                                                     document                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "employee_id" : { "$numberInt" : "1" }, "name" : "Alice", "manager_id" : null, "email" : "alice@example.com", "subordinates" : [ { "_id" : { "$numberInt" : "2" }, "employee_id" : { "$numberInt" : "2" }, "name" : "Bob", "manager_id" : { "$numberInt" : "1" }, "email" : "bob@example.com" }, { "_id" : { "$numberInt" : "3" }, "employee_id" : { "$numberInt" : "3" }, "name" : "Charlie", "manager_id" : { "$numberInt" : "1" }, "email" : "charlie@example.com" }, { "_id" : { "$numberInt" : "4" }, "employee_id" : { "$numberInt" : "4" }, "name" : "David", "manager_id" : { "$numberInt" : "2" }, "email" : "david@example.com" }, { "_id" : { "$numberInt" : "5" }, "employee_id" : { "$numberInt" : "5" }, "name" : "Eve", "manager_id" : { "$numberInt" : "2" }, "email" : "eve@example.com" } ] }
 { "_id" : { "$numberInt" : "2" }, "employee_id" : { "$numberInt" : "2" }, "name" : "Bob", "manager_id" : { "$numberInt" : "1" }, "email" : "bob@example.com", "subordinates" : [ { "_id" : { "$numberInt" : "4" }, "employee_id" : { "$numberInt" : "4" }, "name" : "David", "manager_id" : { "$numberInt" : "2" }, "email" : "david@example.com" }, { "_id" : { "$numberInt" : "5" }, "employee_id" : { "$numberInt" : "5" }, "name" : "Eve", "manager_id" : { "$numberInt" : "2" }, "email" : "eve@example.com" } ] }
 
 
 
(5 rows)

/*unionWith with redact test case user and employee data*/
SELECT documentdb_api.insert_one('db', 'unionWithUsers', '{ "_id": 1, "name": "Alice", "role": "admin", "address": { "city": "New York", "zip": "10001" } }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'unionWithUsers', '{ "_id": 2, "name": "Bob", "role": "user", "address": { "city": "Los Angeles", "zip": "90001" } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'unionWithEmployees', '{ "_id": 101, "name": "Charlie", "role": "admin", "department": "HR", "address": { "city": "San Francisco", "zip": "94101" } }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'unionWithEmployees', '{ "_id": 102, "name": "David", "role": "user", "department": "IT", "address": { "city": "Chicago", "zip": "60601" } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "unionWithUsers", "pipeline": [ { "$unionWith": { "coll": "unionWithEmployees", "pipeline": [ { "$redact": { "$cond": { "if": { "$gt": ["$_id", 101] }, "then": "$$KEEP", "else": "$$PRUNE" } } } ] } } ], "cursor": {} }');
                                                                     document                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "Alice", "role" : "admin", "address" : { "city" : "New York", "zip" : "10001" } }
 { "_id" : { "$numberInt" : "2" }, "name" : "Bob", "role" : "user", "address" : { "city" : "Los Angeles", "zip" : "90001" } }
 
 { "_id" : { "$numberInt" : "102" }, "name" : "David", "role" : "user", "department" : "IT", "address" : { "city" : "Chicago", "zip" : "60601" } }
(4 rows)

/*negative case*/
/*redact input as number*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": 1 }], "cursor": {} }');
ERROR:  $redact's parameter must be an expression or string valued as $$KEEP, $$DESCEND, and $$PRUNE, but input as '1'.
/*redact input as string*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": "string" }], "cursor": {} }');
ERROR:  $redact's expression should not return anything aside from the variables $$KEEP, $$DESCEND, and $$PRUNE, but returned '"string"'.
/*redact input as boolean*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": true }], "cursor": {} }');
ERROR:  $redact's parameter must be an expression or string valued as $$KEEP, $$DESCEND, and $$PRUNE, but input as 'true'.
/*redact input system variable not KEEP or PRUNE or DESCEND*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": "$$NOTVALID"}], "cursor": {} }');
ERROR:  Use of undefined variable: NOTVALID
/*redact input as array*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": ["$$KEEP", "$$PRUNE"]} ], "cursor": {} }');
ERROR:  $redact's parameter must be an expression or string valued as $$KEEP, $$DESCEND, and $$PRUNE, but input as '[ "$$KEEP", "$$PRUNE" ]'.
/*redact input cond return not KEEP or PRUNE or DESCEND*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": { "$cond": {"if": {"$eq": ["$level", 1]}, "then": "$$KEEP", "else": "$$NOTVALID"} } } ], "cursor": {} }');
ERROR:  Use of undefined variable: NOTVALID
/*throw exception when $$KEEP $$PRUEN $$DESCEND are used in other stages*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$project": {"filteredField" : "$$PRUNE"} } ], "cursor": {} }');
ERROR:  Use of undefined variable: PRUNE
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$project": {"newField" : "$$DESCEND"} } ], "cursor": {} }');
ERROR:  Use of undefined variable: DESCEND
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$project": {"newField" :{ "$add":["$$KEEP",1]} } } ], "cursor": {} }');
ERROR:  Use of undefined variable: KEEP
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$addFields": {"newField" : "$$DESCEND"} } ], "cursor": {} }');
ERROR:  Use of undefined variable: DESCEND
/*EXPLAIN*/
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": "$$KEEP" } ] }');
                                                                                                                                                                    QUERY PLAN                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_redact(document, '{ }'::documentdb_core.bson, '$$KEEP'::text, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson) AS document FROM documentdb_data.documents_51502_5150036 collection WHERE (shard_key_value OPERATOR(pg_catalog.=) '51502'::bigint)
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_51502_5150036 collection
               Output: documentdb_api_internal.bson_dollar_redact(document, '{ }'::documentdb_core.bson, '$$KEEP'::text, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)
               Recheck Cond: (collection.shard_key_value = '51502'::bigint)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '51502'::bigint)
(12 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": { "$cond": {"if": {"$eq": ["$level", 1]}, "then": "$$KEEP", "else": "$$PRUNE"} } } ] }');
                                                                                                                                                                                                                        QUERY PLAN                                                                                                                                                                                                                        
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_redact(document, '{ "$cond" : { "if" : { "$eq" : [ "$level", { "$numberInt" : "1" } ] }, "then" : "$$KEEP", "else" : "$$PRUNE" } }'::documentdb_core.bson, ''::text, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson) AS document FROM documentdb_data.documents_51502_5150036 collection WHERE (shard_key_value OPERATOR(pg_catalog.=) '51502'::bigint)
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_51502_5150036 collection
               Output: documentdb_api_internal.bson_dollar_redact(document, '{ "$cond" : { "if" : { "$eq" : [ "$level", { "$numberInt" : "1" } ] }, "then" : "$$KEEP", "else" : "$$PRUNE" } }'::documentdb_core.bson, ''::text, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)
               Recheck Cond: (collection.shard_key_value = '51502'::bigint)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '51502'::bigint)
(12 rows)

/*sharded collection*/
SELECT shard_collection('db', 'redactTest3', '{ "amount": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

/*positive cases:*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": { "$cond": [{"$lte": ["$level", 1]}, "$$KEEP", "$$PRUNE"] } }  ], "cursor": {} }');
                                                                                                         document                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }, "c" : { "level" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "1" } } }
 
 
(3 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": { "$cond": [{"$lte": ["$level", 2]}, "$$KEEP", "$$PRUNE"] } }  ], "cursor": {} }');
                                                                                                         document                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }, "c" : { "level" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "1" } } }
 { "_id" : { "$numberInt" : "2" }, "level" : { "$numberInt" : "2" }, "a" : { "level" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "2" } }, "c" : { "level" : { "$numberInt" : "2" }, "d" : { "$numberInt" : "2" } } }
 
(3 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": { "$cond": [{"$lte": ["$level", 3]}, "$$KEEP", "$$PRUNE"] } }  ], "cursor": {} }');
                                                                                                         document                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }, "c" : { "level" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "1" } } }
 { "_id" : { "$numberInt" : "2" }, "level" : { "$numberInt" : "2" }, "a" : { "level" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "2" } }, "c" : { "level" : { "$numberInt" : "2" }, "d" : { "$numberInt" : "2" } } }
 { "_id" : { "$numberInt" : "3" }, "level" : { "$numberInt" : "3" }, "a" : { "level" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "3" } }, "c" : { "level" : { "$numberInt" : "3" }, "d" : { "$numberInt" : "3" } } }
(3 rows)

/*test directly systemvariable*/
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": "$$KEEP" }], "cursor": {} }');
                                                                                                         document                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }, "c" : { "level" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "1" } } }
 { "_id" : { "$numberInt" : "2" }, "level" : { "$numberInt" : "2" }, "a" : { "level" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "2" } }, "c" : { "level" : { "$numberInt" : "2" }, "d" : { "$numberInt" : "2" } } }
 { "_id" : { "$numberInt" : "3" }, "level" : { "$numberInt" : "3" }, "a" : { "level" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "3" } }, "c" : { "level" : { "$numberInt" : "3" }, "d" : { "$numberInt" : "3" } } }
(3 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": "$$PRUNE"}], "cursor": {} }');
 document 
---------------------------------------------------------------------
 
 
 
(3 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": "$$DESCEND"}], "cursor": {} }');
                                                                                                         document                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : { "$numberInt" : "1" }, "a" : { "level" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }, "c" : { "level" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "1" } } }
 { "_id" : { "$numberInt" : "2" }, "level" : { "$numberInt" : "2" }, "a" : { "level" : { "$numberInt" : "2" }, "b" : { "$numberInt" : "2" } }, "c" : { "level" : { "$numberInt" : "2" }, "d" : { "$numberInt" : "2" } } }
 { "_id" : { "$numberInt" : "3" }, "level" : { "$numberInt" : "3" }, "a" : { "level" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "3" } }, "c" : { "level" : { "$numberInt" : "3" }, "d" : { "$numberInt" : "3" } } }
(3 rows)

/*EXPLAIN*/
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": "$$KEEP" } ] }');
                                                                                                                                          QUERY PLAN                                                                                                                                           
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_redact(document, '{ }'::documentdb_core.bson, '$$KEEP'::text, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson) AS document FROM documentdb_data.documents_51502_5150160 collection WHERE true
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documentdb_data.documents_51502_5150160 collection
               Output: documentdb_api_internal.bson_dollar_redact(document, '{ }'::documentdb_core.bson, '$$KEEP'::text, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)
(9 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "redactTest3", "pipeline": [ { "$redact": { "$cond": {"if": {"$eq": ["$level", 1]}, "then": "$$KEEP", "else": "$$PRUNE"} } } ] }');
                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                              
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_redact(document, '{ "$cond" : { "if" : { "$eq" : [ "$level", { "$numberInt" : "1" } ] }, "then" : "$$KEEP", "else" : "$$PRUNE" } }'::documentdb_core.bson, ''::text, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson) AS document FROM documentdb_data.documents_51502_5150160 collection WHERE true
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documentdb_data.documents_51502_5150160 collection
               Output: documentdb_api_internal.bson_dollar_redact(document, '{ "$cond" : { "if" : { "$eq" : [ "$level", { "$numberInt" : "1" } ] }, "then" : "$$KEEP", "else" : "$$PRUNE" } }'::documentdb_core.bson, ''::text, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)
(9 rows)

