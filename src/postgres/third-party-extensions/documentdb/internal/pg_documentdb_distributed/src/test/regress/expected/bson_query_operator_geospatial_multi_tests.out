SET search_path TO documentdb_core,documentdb_api,documentdb_api_catalog,documentdb_api_internal;
SET citus.next_shard_id TO 567100;
SET documentdb.next_collection_id TO 56710;
SET documentdb.next_collection_index_id TO 56710;
SELECT documentdb_api.drop_collection('db', 'geo_multi') IS NOT NULL;
 ?column? 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.create_collection('db', 'geo_multi') IS NOT NULL;
NOTICE:  creating collection
 ?column? 
---------------------------------------------------------------------
 t
(1 row)

-- Insert multiple items
SELECT documentdb_api.insert_one('db','geo_multi','{ "_id" : 1, "name": "PointA", "geo": { "type": "Point", "coordinates": [100, 0] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geo_multi','{ "_id" : 2, "name": "PointB", "geo": { "type": "Point", "coordinates": [102, 2] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geo_multi','{ "_id" : 3, "name": "MultiPointAB", "geo": { "type": "MultiPoint", "coordinates": [[100, 0], [101, 1], [102, 2], [103, 3]] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geo_multi','{ "_id" : 4, "name": "LineStringA", "geo": { "type": "LineString", "coordinates": [[100, 0], [100.5, 0.5], [101, 1]] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geo_multi','{ "_id" : 5, "name": "LineStringB", "geo": { "type": "LineString", "coordinates": [[102, 2], [102.5, 2.5], [103, 3]] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geo_multi','{ "_id" : 6, "name": "MultiLineStringAB", "geo": { "type": "MultiLineString", "coordinates": [ [[100, 0], [100.5, 0.5], [101, 1]], [[102, 2], [102.5, 2.5], [103, 3]] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geo_multi','{ "_id" : 7, "name": "PolygonA", "geo": { "type": "Polygon", "coordinates": [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geo_multi','{ "_id" : 8, "name": "PolygonB", "geo": { "type": "Polygon", "coordinates": [ [ [102, 2], [103, 2], [103, 3], [102, 3], [102, 2] ] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- commenting out the polygon with holes for now
-- SELECT documentdb_api.insert_one('db','geo_multi','{ "_id" : 9, "name": "PolygonA_WithHole", "geo": { "type": "Polygon", "coordinates": [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ], [ [100.2, 0.2], [100.8, 0.2], [100.8, 0.8], [100.2, 0.8], [100.2, 0.2] ] ] } }', NULL);
SELECT documentdb_api.insert_one('db','geo_multi','{ "_id" : 10, "name": "MultiPolygonAB", "geo": { "type": "MultiPolygon", "coordinates": [ [ [ [102, 2], [103, 2], [103, 3], [102, 3], [102, 2] ] ], [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ] ] ]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geo_multi','{ "_id" : 11, "name": "GeometryCollectionAll_Withouthole", "geo": { "type": "GeometryCollection", "geometries": [ { "type": "Point", "coordinates": [100, 0] }, { "type": "Point", "coordinates": [102, 2] }, { "type": "MultiPoint", "coordinates": [[100, 0], [101, 1], [102, 2], [103, 3]] }, { "type": "LineString", "coordinates": [[100, 0], [100.5, 0.5], [101, 1]] }, { "type": "LineString", "coordinates": [[102, 2], [102.5, 2.5], [103, 3]] }, { "type": "MultiLineString", "coordinates": [ [[100, 0], [100.5, 0.5], [101, 1]], [[102, 2], [102.5, 2.5], [103, 3]] ] }, { "type": "Polygon", "coordinates": [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ] ] }, { "type": "Polygon", "coordinates": [ [ [102, 2], [103, 2], [103, 3], [102, 3], [102, 2] ] ] }, { "type": "MultiPolygon", "coordinates": [ [ [ [102, 2], [103, 2], [103, 3], [102, 3], [102, 2] ] ], [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ] ] ]}] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- commenting out the polygon with holes for now
-- SELECT documentdb_api.insert_one('db','geo_multi','{ "_id" : 12, "name": "GeometryCollectionAll_Withhole", "geo": { "type": "GeometryCollection", "geometries": [ { "type": "Point", "coordinates": [100, 0] }, { "type": "Point", "coordinates": [102, 2] }, { "type": "MultiPoint", "coordinates": [[100, 0], [101, 1], [102, 2], [103, 3]] }, { "type": "LineString", "coordinates": [[100, 0], [100.5, 0.5], [101, 1]] }, { "type": "LineString", "coordinates": [[102, 2], [102.5, 2.5], [103, 3]] }, { "type": "MultiLineString", "coordinates": [ [[100, 0], [100.5, 0.5], [101, 1]], [[102, 2], [102.5, 2.5], [103, 3]] ] }, { "type": "Polygon", "coordinates": [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ] ] }, { "type": "Polygon", "coordinates": [ [ [102, 2], [103, 2], [103, 3], [102, 3], [102, 2] ] ] }, { "type": "Polygon", "coordinates": [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ], [ [100.2, 0.2], [100.8, 0.2], [100.8, 0.8], [100.2, 0.8], [100.2, 0.2] ] ] }, { "type": "MultiPolygon", "coordinates": [ [ [ [102, 2], [103, 2], [103, 3], [102, 3], [102, 2] ] ], [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ] ] ]}] } }', NULL);
SELECT documentdb_api.insert_one('db','geo_multi','{ "_id" : 13, "name": "Polygon_Exterior", "geo": { "type": "Polygon", "coordinates": [ [ [0, 0], [1, 0], [1, 1], [0, 1], [0, 0] ] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Big enough single polygon to match all the documents except Polygon_Exterior
SELECT document FROM documentdb_api.collection('db', 'geo_multi') WHERE document @@
    '{"geo": {"$geoWithin": { "$geometry": { "type": "Polygon", "coordinates": [ [ [100, 0], [103, 0], [103, 3], [100, 3], [100, 0] ] ] } } }}';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     document                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "PointA", "geo" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "name" : "PointB", "geo" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] } }
 { "_id" : { "$numberInt" : "3" }, "name" : "MultiPointAB", "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] } }
 { "_id" : { "$numberInt" : "4" }, "name" : "LineStringA", "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ] } }
 { "_id" : { "$numberInt" : "5" }, "name" : "LineStringB", "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] } }
 { "_id" : { "$numberInt" : "6" }, "name" : "MultiLineStringAB", "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ], [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] ] } }
 { "_id" : { "$numberInt" : "7" }, "name" : "PolygonA", "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] } }
 { "_id" : { "$numberInt" : "8" }, "name" : "PolygonB", "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ] } }
 { "_id" : { "$numberInt" : "10" }, "name" : "MultiPolygonAB", "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } }
 { "_id" : { "$numberInt" : "11" }, "name" : "GeometryCollectionAll_Withouthole", "geo" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] }, { "type" : "Point", "coordinates" : [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] }, { "type" : "MultiPoint", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] }, { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ], [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ] }, { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } ] } }
(10 rows)

-- PolygonA matches PointA, LineStringA, PolygonA, LineStringA
SELECT document FROM documentdb_api.collection('db', 'geo_multi') WHERE document @@
    '{"geo": {"$geoWithin": { "$geometry": { "type": "Polygon", "coordinates": [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ] ] } } }}';
                                                                                                                                                                                           document                                                                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "PointA", "geo" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "4" }, "name" : "LineStringA", "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ] } }
 { "_id" : { "$numberInt" : "7" }, "name" : "PolygonA", "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] } }
(3 rows)

-- PolygonB matches PointB, LineStringB, PolygonB,
SELECT document FROM documentdb_api.collection('db', 'geo_multi') WHERE document @@
    '{"geo": {"$geoWithin": { "$geometry": { "type": "Polygon", "coordinates": [ [ [102, 2], [103, 2], [103, 3], [102, 3], [102, 2] ] ] } } }}';
                                                                                                                                                                                           document                                                                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "name" : "PointB", "geo" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] } }
 { "_id" : { "$numberInt" : "5" }, "name" : "LineStringB", "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] } }
 { "_id" : { "$numberInt" : "8" }, "name" : "PolygonB", "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ] } }
(3 rows)

-- MultiPolygonAB creates a covered region that matches all except Polygon_Exterior
SELECT document FROM documentdb_api.collection('db', 'geo_multi') WHERE document @@
    '{"geo": {"$geoWithin": { "$geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [102, 2], [103, 2], [103, 3], [102, 3], [102, 2] ] ], [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ] ] ] } } }}';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     document                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "PointA", "geo" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "name" : "PointB", "geo" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] } }
 { "_id" : { "$numberInt" : "3" }, "name" : "MultiPointAB", "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] } }
 { "_id" : { "$numberInt" : "4" }, "name" : "LineStringA", "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ] } }
 { "_id" : { "$numberInt" : "5" }, "name" : "LineStringB", "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] } }
 { "_id" : { "$numberInt" : "6" }, "name" : "MultiLineStringAB", "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ], [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] ] } }
 { "_id" : { "$numberInt" : "7" }, "name" : "PolygonA", "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] } }
 { "_id" : { "$numberInt" : "8" }, "name" : "PolygonB", "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ] } }
 { "_id" : { "$numberInt" : "10" }, "name" : "MultiPolygonAB", "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } }
 { "_id" : { "$numberInt" : "11" }, "name" : "GeometryCollectionAll_Withouthole", "geo" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] }, { "type" : "Point", "coordinates" : [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] }, { "type" : "MultiPoint", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] }, { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ], [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ] }, { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } ] } }
(10 rows)

-- PolygonA_WithHole matches PointA and PolygonA (Bug) and doesn't match itself
-- Limitation1: Matching itself is different behavior in mongo and postgis doesn't behave same out of the box for 2 identical polygons with holes.
-- Limitation2: PolygonA is matched because of this limitation that the outer ring of polygon with hole covers the polygonB and in this case the hole is not considered
SELECT document FROM documentdb_api.collection('db', 'geo_multi') WHERE document @@
    '{"geo": {"$geoWithin": { "$geometry": { "type": "Polygon", "coordinates": [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ], [ [100.2, 0.2], [100.8, 0.2], [100.8, 0.8], [100.2, 0.8], [100.2, 0.2] ] ] } } }}';
ERROR:  $geoWithin currently doesn't support polygons with holes
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'geo_multi') WHERE document @@
    '{"geo": {"$geoWithin": { "$geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [102, 2], [103, 2], [103, 3], [102, 3], [102, 2] ] ], [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ] ] ] } } }}';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_56710_567101 collection WHERE (documentdb_api_catalog.bson_dollar_geowithin(documentdb_api_catalog.bson_validate_geography(document, 'geo'::text), '{ "geo" : { "$geometry" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } } }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '56710'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_56710_567101 collection
               Output: document
               Recheck Cond: (collection.shard_key_value = '56710'::bigint)
               Filter: (documentdb_api_catalog.bson_validate_geography(collection.document, 'geo'::text) OPERATOR(documentdb_api_catalog.@|-|) '{ "geo" : { "$geometry" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } } }'::documentdb_core.bson)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '56710'::bigint)
(13 rows)

-- Create Index and should get the same result
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "geo_multi", "indexes": [{"key": {"geo": "2dsphere"}, "name": "my_geo_indx" }]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

BEGIN;
set local enable_seqscan TO off;
set local documentdb.forceUseIndexIfAvailable to on;
-- Big enough single polygon to match all the documents except Polygon_Exterior
SELECT document FROM documentdb_api.collection('db', 'geo_multi') WHERE document @@
    '{"geo": {"$geoWithin": { "$geometry": { "type": "Polygon", "coordinates": [ [ [100, 0], [103, 0], [103, 3], [100, 3], [100, 0] ] ] } } }}';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     document                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "PointA", "geo" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "name" : "PointB", "geo" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] } }
 { "_id" : { "$numberInt" : "3" }, "name" : "MultiPointAB", "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] } }
 { "_id" : { "$numberInt" : "4" }, "name" : "LineStringA", "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ] } }
 { "_id" : { "$numberInt" : "5" }, "name" : "LineStringB", "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] } }
 { "_id" : { "$numberInt" : "6" }, "name" : "MultiLineStringAB", "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ], [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] ] } }
 { "_id" : { "$numberInt" : "7" }, "name" : "PolygonA", "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] } }
 { "_id" : { "$numberInt" : "8" }, "name" : "PolygonB", "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ] } }
 { "_id" : { "$numberInt" : "10" }, "name" : "MultiPolygonAB", "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } }
 { "_id" : { "$numberInt" : "11" }, "name" : "GeometryCollectionAll_Withouthole", "geo" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] }, { "type" : "Point", "coordinates" : [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] }, { "type" : "MultiPoint", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] }, { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ], [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ] }, { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } ] } }
(10 rows)

-- PolygonA matches PointA, LineStringA, PolygonA, LineStringA
SELECT document FROM documentdb_api.collection('db', 'geo_multi') WHERE document @@
    '{"geo": {"$geoWithin": { "$geometry": { "type": "Polygon", "coordinates": [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ] ] } } }}';
                                                                                                                                                                                           document                                                                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "PointA", "geo" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "4" }, "name" : "LineStringA", "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ] } }
 { "_id" : { "$numberInt" : "7" }, "name" : "PolygonA", "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] } }
(3 rows)

-- PolygonB matches PointB, LineStringB, PolygonB,
SELECT document FROM documentdb_api.collection('db', 'geo_multi') WHERE document @@
    '{"geo": {"$geoWithin": { "$geometry": { "type": "Polygon", "coordinates": [ [ [102, 2], [103, 2], [103, 3], [102, 3], [102, 2] ] ] } } }}';
                                                                                                                                                                                           document                                                                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "name" : "PointB", "geo" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] } }
 { "_id" : { "$numberInt" : "5" }, "name" : "LineStringB", "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] } }
 { "_id" : { "$numberInt" : "8" }, "name" : "PolygonB", "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ] } }
(3 rows)

-- MultiPolygonAB creates a covered region that matches all except Polygon_Exterior
SELECT document FROM documentdb_api.collection('db', 'geo_multi') WHERE document @@
    '{"geo": {"$geoWithin": { "$geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [102, 2], [103, 2], [103, 3], [102, 3], [102, 2] ] ], [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ] ] ] } } }}';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     document                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "PointA", "geo" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "name" : "PointB", "geo" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] } }
 { "_id" : { "$numberInt" : "3" }, "name" : "MultiPointAB", "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] } }
 { "_id" : { "$numberInt" : "4" }, "name" : "LineStringA", "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ] } }
 { "_id" : { "$numberInt" : "5" }, "name" : "LineStringB", "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] } }
 { "_id" : { "$numberInt" : "6" }, "name" : "MultiLineStringAB", "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ], [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] ] } }
 { "_id" : { "$numberInt" : "7" }, "name" : "PolygonA", "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] } }
 { "_id" : { "$numberInt" : "8" }, "name" : "PolygonB", "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ] } }
 { "_id" : { "$numberInt" : "10" }, "name" : "MultiPolygonAB", "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } }
 { "_id" : { "$numberInt" : "11" }, "name" : "GeometryCollectionAll_Withouthole", "geo" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] }, { "type" : "Point", "coordinates" : [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] }, { "type" : "MultiPoint", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] }, { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ], [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ] }, { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } ] } }
(10 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'geo_multi') WHERE document @@
    '{"geo": {"$geoWithin": { "$geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [102, 2], [103, 2], [103, 3], [102, 3], [102, 2] ] ], [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ] ] ] } } }}';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_56710_567101 collection WHERE (documentdb_api_catalog.bson_dollar_geowithin(documentdb_api_catalog.bson_validate_geography(document, 'geo'::text), '{ "geo" : { "$geometry" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } } }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '56710'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_geo_indx on documentdb_data.documents_56710_567101 collection
               Output: document
               Index Cond: (documentdb_api_catalog.bson_validate_geography(collection.document, 'geo'::text) OPERATOR(documentdb_api_catalog.@|-|) '{ "geo" : { "$geometry" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } } }'::documentdb_core.bson)
(10 rows)

ROLLBACK;
-- Shard the collection
SELECT documentdb_api.shard_collection('db', 'geo_multi', '{"_id": "hashed"}', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

BEGIN;
set local enable_seqscan TO off;
set local citus.enable_local_execution TO OFF;
set local documentdb.forceUseIndexIfAvailable to on;
SELECT document FROM documentdb_api.collection('db', 'geo_multi') WHERE document @@
    '{"geo": {"$geoWithin": { "$geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [102, 2], [103, 2], [103, 3], [102, 3], [102, 2] ] ], [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ] ] ] } } }}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     document                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "PointA", "geo" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "2" }, "name" : "PointB", "geo" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] } }
 { "_id" : { "$numberInt" : "3" }, "name" : "MultiPointAB", "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] } }
 { "_id" : { "$numberInt" : "4" }, "name" : "LineStringA", "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ] } }
 { "_id" : { "$numberInt" : "5" }, "name" : "LineStringB", "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] } }
 { "_id" : { "$numberInt" : "6" }, "name" : "MultiLineStringAB", "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ], [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] ] } }
 { "_id" : { "$numberInt" : "7" }, "name" : "PolygonA", "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] } }
 { "_id" : { "$numberInt" : "8" }, "name" : "PolygonB", "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ] } }
 { "_id" : { "$numberInt" : "10" }, "name" : "MultiPolygonAB", "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } }
 { "_id" : { "$numberInt" : "11" }, "name" : "GeometryCollectionAll_Withouthole", "geo" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] }, { "type" : "Point", "coordinates" : [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] }, { "type" : "MultiPoint", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] }, { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberDouble" : "100.5" }, { "$numberDouble" : "0.5" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ] ], [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberDouble" : "102.5" }, { "$numberDouble" : "2.5" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ] ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ] }, { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } ] } }
(10 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'geo_multi') WHERE document @@
    '{"geo": {"$geoWithin": { "$geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [102, 2], [103, 2], [103, 3], [102, 3], [102, 2] ] ], [ [ [100, 0], [101, 0], [101, 1], [100, 1], [100, 0] ] ] ] } } }}';
                                                                                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_56710_567116 documents_56710 WHERE documentdb_api_catalog.bson_dollar_geowithin(documentdb_api_catalog.bson_validate_geography(document, 'geo'::text), '{ "geo" : { "$geometry" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } } }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_geo_indx on documentdb_data.documents_56710_567116 documents_56710
               Output: document
               Index Cond: (documentdb_api_catalog.bson_validate_geography(documents_56710.document, 'geo'::text) OPERATOR(documentdb_api_catalog.@|-|) '{ "geo" : { "$geometry" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "2" } ], [ { "$numberInt" : "103" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "3" } ], [ { "$numberInt" : "102" }, { "$numberInt" : "2" } ] ] ], [ [ [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "101" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "1" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "0" } ] ] ] ] } } }'::documentdb_core.bson)
(10 rows)

ROLLBACK;
