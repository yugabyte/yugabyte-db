SET search_path TO documentdb_core,documentdb_api,documentdb_api_catalog,documentdb_api_internal;
SET citus.next_shard_id TO 6910000;
SET documentdb.next_collection_id TO 69100;
SET documentdb.next_collection_index_id TO 69100;
-- $isNumber: return true for numbers false otherwise
SELECT * FROM bson_dollar_project('{}', '{"result": {"$isNumber": [["not null"]]}}');
 bson_dollar_project  
---------------------------------------------------------------------
 { "result" : false }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$isNumber": {"$add": [1, 2]}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : true }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$isNumber": [true]}}');
 bson_dollar_project  
---------------------------------------------------------------------
 { "result" : false }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$isNumber": [false]}}');
 bson_dollar_project  
---------------------------------------------------------------------
 { "result" : false }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$isNumber": "1"}}');
 bson_dollar_project  
---------------------------------------------------------------------
 { "result" : false }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$isNumber": {"$numberLong": "1"}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : true }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$isNumber": {"$numberDecimal": "1"}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : true }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$isNumber": {"$numberDouble": "1.0"}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : true }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$isNumber": {}}}');
 bson_dollar_project  
---------------------------------------------------------------------
 { "result" : false }
(1 row)

-- $isNumber: returns null with null or undefined
SELECT * FROM bson_dollar_project('{}', '{"result": {"$isNumber": null}}');
 bson_dollar_project  
---------------------------------------------------------------------
 { "result" : false }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$isNumber": "$a"}}');
 bson_dollar_project  
---------------------------------------------------------------------
 { "result" : false }
(1 row)

-- $isNumber: error number of args should be 1
SELECT * FROM bson_dollar_project('{}', '{"result": {"$isNumber": []}}');
ERROR:  Expression $isNumber takes exactly 1 arguments. 0 were passed in.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$isNumber": [1, 2]}}');
ERROR:  Expression $isNumber takes exactly 1 arguments. 2 were passed in.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$isNumber": [[], 2]}}');
ERROR:  Expression $isNumber takes exactly 1 arguments. 2 were passed in.
-- $type: returns expected type
SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "1", "input": {"$numberDouble": "1.0"}, "expected": "double"}');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "2", "input": "string", "expected": "string"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "3", "input": {}, "expected": "object"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "4", "input": [], "expected": "array"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "5", "input": {"$binary": { "base64": "bGlnaHQgdw==", "subType": "01"}}, "expected": "binData"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "6", "input": {"$oid" : "639926cee6bda3127f153bf1" }, "expected": "objectId"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "7", "input": true, "expected": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "8", "input": {"$date": "2022-01-01T00:00:00.000Z"}, "expected": "date"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "9", "input": null, "expected": "null"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "10", "input": { "$regex": "a.*b", "$options": "" }, "expected": "regex"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "11", "input": { "$code": "var a = 1;"}, "expected": "javascript"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "12", "input": 1, "expected": "int"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "13", "input": {"$timestamp" : { "t": 1670981326, "i": 1 }}, "expected": "timestamp"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "14", "input": {"$numberLong" : "1"}, "expected": "long"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "15", "input": {"$numberDecimal" : "1"}, "expected": "decimal"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "16", "input": {"$minKey" : 1}, "expected": "minKey"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "17", "input": {"$maxKey" : 1}, "expected": "maxKey"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'dollarType', '{"_id": "18", "expected": "missing"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT bson_dollar_project(document, '{"output": {"$type": "$input"}, "expected": 1}') FROM documentdb_api.collection('db', 'dollarType');
                         bson_dollar_project                          
---------------------------------------------------------------------
 { "_id" : "1", "expected" : "double", "output" : "double" }
 { "_id" : "2", "expected" : "string", "output" : "string" }
 { "_id" : "3", "expected" : "object", "output" : "object" }
 { "_id" : "4", "expected" : "array", "output" : "array" }
 { "_id" : "5", "expected" : "binData", "output" : "binData" }
 { "_id" : "6", "expected" : "objectId", "output" : "objectId" }
 { "_id" : "7", "expected" : "bool", "output" : "bool" }
 { "_id" : "8", "expected" : "date", "output" : "date" }
 { "_id" : "9", "expected" : "null", "output" : "null" }
 { "_id" : "10", "expected" : "regex", "output" : "regex" }
 { "_id" : "11", "expected" : "javascript", "output" : "javascript" }
 { "_id" : "12", "expected" : "int", "output" : "int" }
 { "_id" : "13", "expected" : "timestamp", "output" : "timestamp" }
 { "_id" : "14", "expected" : "long", "output" : "long" }
 { "_id" : "15", "expected" : "decimal", "output" : "decimal" }
 { "_id" : "16", "expected" : "minKey", "output" : "minKey" }
 { "_id" : "17", "expected" : "maxKey", "output" : "maxKey" }
 { "_id" : "18", "expected" : "missing", "output" : "missing" }
(18 rows)

-- $convert: returns expected values
-- double input
SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "1", "input": {"$numberDouble": "1.9"}, "expected": {"$numberDouble": "1.9"}, "target": "double"}');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "2", "input": {"$numberDouble": "1.9"}, "expected": "1.9", "target": "string"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "3", "input": {"$numberDouble": "1.9"}, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "4", "input": {"$numberDouble": "0.0"}, "expected": false, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "5", "input": {"$numberDouble": "-0.1"}, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "6", "input": {"$numberDouble": "1.9"}, "expected": {"$date": "1970-01-01T00:00:00.001Z"}, "target": "date"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "7", "input": {"$numberDouble": "1.9"}, "expected": 1, "target": "int"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "8", "input": {"$numberDouble": "1.9"}, "expected": {"$numberLong": "1"}, "target": "long"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "9", "input": {"$numberDouble": "1.9"}, "expected": {"$numberDecimal": "1.9"}, "target": "decimal"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- str input
SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "10", "input": "myString", "expected": "myString", "target": "string"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "11", "input": "1.9", "expected": {"$numberDouble": "1.9"}, "target": "double"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "12", "input": "1E-2", "expected": {"$numberDouble": "0.01"}, "target": "double"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "13", "input": "13423423E-25", "expected": {"$numberDouble": "1.3423423e-18"}, "target": "double"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "14", "input": "0000000.0000000", "expected": {"$numberDouble": "0.0"}, "target": "double"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "15", "input": "1.9", "expected": {"$numberDecimal": "1.9"}, "target": "decimal"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "16", "input": "1E-2", "expected": {"$numberDecimal": "0.01"}, "target": "decimal"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "17", "input": "-13423423E25", "expected": {"$numberDecimal": "-1.3423423E+32"}, "target": "decimal"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "18", "input": "000000.000000", "expected": {"$numberDecimal": "0.000000"}, "target": "decimal"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "19", "input": "-1232", "expected": {"$numberLong": "-1232"}, "target": "long"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "20", "input": "00053235", "expected": {"$numberLong": "53235"}, "target": "long"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "21", "input": "00053235", "expected": 53235, "target": "int"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "22", "input": "00000000000", "expected": 0, "target": "int"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "23", "input": "0123456789abcdef01234567", "expected": {"$oid": "0123456789abcdef01234567"}, "target": "objectId"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "24", "input": "", "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- objectId input
SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "26", "input": {"$oid": "0123456789abcdef01234567"}, "expected": {"$oid": "0123456789abcdef01234567"}, "target": "objectId"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "27", "input": {"$oid": "0123456789abcdef01234567"}, "expected": "0123456789abcdef01234567", "target": "string"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "28", "input": {"$oid": "0123456789abcdef01234567"}, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "29", "input": {"$oid": "0123456789abcdef01234567"}, "expected": {"$date": "1970-08-09T22:25:43Z"}, "target": "date"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- bool input
SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "30", "input": false, "expected": {"$numberDouble": "0"}, "target": "double"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "31", "input": true, "expected": {"$numberDouble": "1"}, "target": "double"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "32", "input": false, "expected": {"$numberDecimal": "0"}, "target": "decimal"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "33", "input": true, "expected": {"$numberDecimal": "1"}, "target": "decimal"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "34", "input": false, "expected": {"$numberLong": "0"}, "target": "long"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "35", "input": true, "expected": {"$numberLong": "1"}, "target": "long"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "36", "input": false, "expected": 0, "target": "int"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "37", "input": true, "expected": 1, "target": "int"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "38", "input": false, "expected": "false", "target": "string"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "39", "input": true, "expected": "true", "target": "string"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "40", "input": false, "expected": false, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "45", "input": true, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- date input
SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "46", "input": {"$date": "1970-01-01T00:00:00.123Z"}, "expected": {"$date": "1970-01-01T00:00:00.123Z"}, "target": "date"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "47", "input": {"$date": "1970-01-01T00:00:00.123Z"}, "expected": "1970-01-01T00:00:00.123Z", "target": "string"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "48", "input": {"$date": "1970-01-01T00:00:00.123Z"}, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "49", "input": {"$date": "1970-01-01T00:00:00.123Z"}, "expected": {"$numberLong": "123"}, "target": "long"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "50", "input": {"$date": "1970-01-01T00:00:00.123Z"}, "expected": {"$numberDouble": "123"}, "target": "double"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "51", "input": {"$date": "1970-01-01T00:00:00.123Z"}, "expected": {"$numberDecimal": "123"}, "target": "decimal"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- int input
SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "52", "input": 1, "expected": 1, "target": "int"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "53", "input": 1, "expected": {"$numberDouble": "1"}, "target": "double"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "54", "input": -11, "expected": {"$numberDouble": "-11"}, "target": "double"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "55", "input": 523453, "expected": {"$numberDecimal": "523453"}, "target": "decimal"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "56", "input": 523453, "expected": {"$numberLong": "523453"}, "target": "long"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "57", "input": 1, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "58", "input": 0, "expected": false, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "59", "input": 25, "expected": "25", "target": "string"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- long input
SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "61", "input": {"$numberLong": "1" }, "expected": {"$numberLong": "1" }, "target": "long"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "62", "input": {"$numberLong": "1" }, "expected": 1, "target": "int"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "63", "input": {"$numberLong": "1" }, "expected": {"$numberDouble": "1"}, "target": "double"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "64", "input": {"$numberLong": "-11" }, "expected": {"$numberDouble": "-11"}, "target": "double"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "65", "input": {"$numberLong": "523453" }, "expected": {"$numberDecimal": "523453"}, "target": "decimal"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "66", "input": {"$numberLong": "523453" }, "expected": {"$numberLong": "523453"}, "target": "long"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "67", "input": {"$numberLong": "1" }, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "68", "input": {"$numberLong": "0" }, "expected": false, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "69", "input": {"$numberLong": "25" }, "expected": "25", "target": "string"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "70", "input": {"$numberLong": "25" }, "expected": {"$date": "1970-01-01T00:00:00.025Z"}, "target": "date"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- decimal input
SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "71", "input": {"$numberDecimal": "1.9"}, "expected": {"$numberDecimal": "1.9"}, "target": "decimal"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "72", "input": {"$numberDecimal": "1.9"}, "expected": "1.9", "target": "string"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "73", "input": {"$numberDecimal": "1.9"}, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "74", "input": {"$numberDecimal": "0.0"}, "expected": false, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "75", "input": {"$numberDecimal": "-0.1"}, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "76", "input": {"$numberDecimal": "1.9"}, "expected": {"$date": "1970-01-01T00:00:00.001Z"}, "target": "date"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "77", "input": {"$numberDecimal": "1.9"}, "expected": 1, "target": "int"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "78", "input": {"$numberDecimal": "1.9"}, "expected": {"$numberLong": "1"}, "target": "long"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "79", "input": {"$numberDecimal": "1.9"}, "expected": {"$numberDouble": "1.9"}, "target": "double"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- other supported types to bool
SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "80", "input": {"$minKey": 1}, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "81", "input": {"foo": 1}, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "82", "input": ["foo", 1], "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "83", "input": {"$binary": { "base64": "bGlnaHQgdw==", "subType": "01"}}, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "84", "input": { "$regex": "a.*b", "$options": "" }, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "85", "input": { "$code": "var a = 1;"}, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "86", "input": {"$maxKey": 1}, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "87", "input": {"$timestamp" : { "t": 1670981326, "i": 1 }}, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "88", "input": { "$dbPointer" : { "$ref" : "db.test", "$id" : { "$oid" : "347f000000c1de008ec19ceb" }}}, "expected": true, "target": "bool"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- str to date is not yet supported, will be added with $dateFromString
-- SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "89", "input": "1970-01-01", "expected": {"$date": "1970-01-01T00:00:00.001Z"}, "target": "date"}');
-- SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "90", "input": "1970-01-01T00:00:00.001Z", "expected": {"$date": "1970-01-01T00:00:00.001Z"}, "target": "date"}');
-- SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "91", "input": "1970-01-01T00:00:00.001+0500", "expected": {"$date": "1969-12-31T19:00:00.001Z"}, "target": "date"}');
-- SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "92", "input": "1970-01-01 00:00:00.001 +0500", "expected": {"$date": "1969-12-31T19:00:00.001Z"}, "target": "date"}');
-- SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "93", "input": "1970-01-01T00:00:00.001+5", "expected": {"$date": "1969-12-31T19:00:00.001Z"}, "target": "date"}');
-- SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "94", "input": "1970-01-01T00:00:00.001+05", "expected": {"$date": "1969-12-31T19:00:00.001Z"}, "target": "date"}');
-- SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "95", "input": "1970-01-01T00:00:00.001+050", "expected": {"$date": "1969-12-31T23:10:00.001Z"}, "target": "date"}');
-- SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "96", "input": "1970-01-01T00:00:00.001+0510", "expected": {"$date": "1969-12-31T18:50:00.001Z"}, "target": "date"}');
-- SELECT * from documentdb_api.insert_one('db', 'convertColl', '{"_id": "97", "input": "1970-01-01T00:00:00.001+0501", "expected": {"$date": "1969-12-31T18:59:00.001Z"}, "target": "date"}');
-- call convert with the input and target type and check if the output is equal to the expected output.
SELECT bson_dollar_project(document, '{"passed": { "$eq": [{"$convert": { "input": "$input", "to": "$target"}}, "$expected"]}}') FROM documentdb_api.collection('db', 'convertColl');
        bson_dollar_project        
---------------------------------------------------------------------
 { "_id" : "1", "passed" : true }
 { "_id" : "2", "passed" : true }
 { "_id" : "3", "passed" : true }
 { "_id" : "4", "passed" : true }
 { "_id" : "5", "passed" : true }
 { "_id" : "6", "passed" : true }
 { "_id" : "7", "passed" : true }
 { "_id" : "8", "passed" : true }
 { "_id" : "9", "passed" : true }
 { "_id" : "10", "passed" : true }
 { "_id" : "11", "passed" : true }
 { "_id" : "12", "passed" : true }
 { "_id" : "13", "passed" : true }
 { "_id" : "14", "passed" : true }
 { "_id" : "15", "passed" : true }
 { "_id" : "16", "passed" : true }
 { "_id" : "17", "passed" : true }
 { "_id" : "18", "passed" : true }
 { "_id" : "19", "passed" : true }
 { "_id" : "20", "passed" : true }
 { "_id" : "21", "passed" : true }
 { "_id" : "22", "passed" : true }
 { "_id" : "23", "passed" : true }
 { "_id" : "24", "passed" : true }
 { "_id" : "26", "passed" : true }
 { "_id" : "27", "passed" : true }
 { "_id" : "28", "passed" : true }
 { "_id" : "29", "passed" : true }
 { "_id" : "30", "passed" : true }
 { "_id" : "31", "passed" : true }
 { "_id" : "32", "passed" : true }
 { "_id" : "33", "passed" : true }
 { "_id" : "34", "passed" : true }
 { "_id" : "35", "passed" : true }
 { "_id" : "36", "passed" : true }
 { "_id" : "37", "passed" : true }
 { "_id" : "38", "passed" : true }
 { "_id" : "39", "passed" : true }
 { "_id" : "40", "passed" : true }
 { "_id" : "45", "passed" : true }
 { "_id" : "46", "passed" : true }
 { "_id" : "47", "passed" : true }
 { "_id" : "48", "passed" : true }
 { "_id" : "49", "passed" : true }
 { "_id" : "50", "passed" : true }
 { "_id" : "51", "passed" : true }
 { "_id" : "52", "passed" : true }
 { "_id" : "53", "passed" : true }
 { "_id" : "54", "passed" : true }
 { "_id" : "55", "passed" : true }
 { "_id" : "56", "passed" : true }
 { "_id" : "57", "passed" : true }
 { "_id" : "58", "passed" : true }
 { "_id" : "59", "passed" : true }
 { "_id" : "61", "passed" : true }
 { "_id" : "62", "passed" : true }
 { "_id" : "63", "passed" : true }
 { "_id" : "64", "passed" : true }
 { "_id" : "65", "passed" : true }
 { "_id" : "66", "passed" : true }
 { "_id" : "67", "passed" : true }
 { "_id" : "68", "passed" : true }
 { "_id" : "69", "passed" : true }
 { "_id" : "70", "passed" : true }
 { "_id" : "71", "passed" : true }
 { "_id" : "72", "passed" : true }
 { "_id" : "73", "passed" : true }
 { "_id" : "74", "passed" : true }
 { "_id" : "75", "passed" : true }
 { "_id" : "76", "passed" : true }
 { "_id" : "77", "passed" : true }
 { "_id" : "78", "passed" : true }
 { "_id" : "79", "passed" : true }
 { "_id" : "80", "passed" : true }
 { "_id" : "81", "passed" : true }
 { "_id" : "82", "passed" : true }
 { "_id" : "83", "passed" : true }
 { "_id" : "84", "passed" : true }
 { "_id" : "85", "passed" : true }
 { "_id" : "86", "passed" : true }
 { "_id" : "87", "passed" : true }
 { "_id" : "88", "passed" : true }
(82 rows)

-- $convert with null to type should return null with and without onNull
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": { "input": 1, "to": null}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": { "input": 1, "to": "$missingField"}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": { "input": 1, "to": null, "onNull": "Input was null"}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": { "input": 1, "to": "$missingField", "onNull": "Input was null"}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

-- $convert with null input should return null without onNull and onNull expression if specified even if 'to' is null
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": { "input": null, "to": "string"}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": { "input": "$missingField", "to": "bool"}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": { "input": null, "to": null, "onNull": "Input was null"}}}');
       bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "Input was null" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": { "input": "$missingField", "to": null, "onNull": "Input was null"}}}');
       bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "Input was null" }
(1 row)

-- $convert with null and undefined/missing onNull should return empty
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": { "input": null, "to": null, "onNull": "$onNullField"}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": { "input": "$missingField", "to": null, "onNull": "$onNullField"}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { }
(1 row)

-- $convert with error outside of parsing should honor onError
SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "1", "input": {"$numberDouble": "1.9"}, "target": "objectId"}');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "2", "input": {"$numberDouble": "1.9"}, "target": "array"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "3", "input": {"$numberDouble": "1.9"}, "target": "object"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "4", "input": { "$oid" : "347f000000c1de008ec19ceb" }, "target": "double"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "5", "input": { "$oid" : "347f000000c1de008ec19ceb" }, "target": "int"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "6", "input": { "$oid" : "347f000000c1de008ec19ceb" }, "target": "long"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "7", "input": { "$oid" : "347f000000c1de008ec19ceb" }, "target": "decimal"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "8", "input": true, "target": "objectId"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "9", "input": false, "target": "date"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "10", "input": {"$date": "1970-01-01T00:00:00.000Z"}, "target": "objectId"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "11", "input": {"$date": "1970-01-01T00:00:00.000Z"}, "target": "int"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "12", "input": 1, "target": "date"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "13", "input": 1.9, "target": "minKey"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "14", "input": 1.9, "target": "missing"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "15", "input": 1.9, "target": "object"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "16", "input": 1.9, "target": "array"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "17", "input": 1.9, "target": "binData"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "18", "input": 1.9, "target": "undefined"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "19", "input": 1.9, "target": "null"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "20", "input": 1.9, "target": "regex"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "21", "input": 1.9, "target": "dbPointer"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "22", "input": 1.9, "target": "javascript"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "23", "input": 1.9, "target": "symbol"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "24", "input": 1.9, "target": "javascriptWithScope"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "25", "input": 1.9, "target": "timestamp"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "26", "input": 1.9, "target": "maxKey"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "27", "input": 1, "target": "objectId"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "28", "input": {"$numberLong": "1"}, "target": "objectId"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * from documentdb_api.insert_one('db', 'convertCollWithErrors', '{"_id": "29", "input": {"$numberDecimal": "1"}, "target": "objectId"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT bson_dollar_project(document, '{"output": {"$convert": { "input": "$input", "to": "$target", "onError": "There was an error in $convert"}}}') FROM documentdb_api.collection('db', 'convertCollWithErrors');
                      bson_dollar_project                      
---------------------------------------------------------------------
 { "_id" : "1", "output" : "There was an error in $convert" }
 { "_id" : "2", "output" : "There was an error in $convert" }
 { "_id" : "3", "output" : "There was an error in $convert" }
 { "_id" : "4", "output" : "There was an error in $convert" }
 { "_id" : "5", "output" : "There was an error in $convert" }
 { "_id" : "6", "output" : "There was an error in $convert" }
 { "_id" : "7", "output" : "There was an error in $convert" }
 { "_id" : "8", "output" : "There was an error in $convert" }
 { "_id" : "9", "output" : "There was an error in $convert" }
 { "_id" : "10", "output" : "There was an error in $convert" }
 { "_id" : "11", "output" : "There was an error in $convert" }
 { "_id" : "12", "output" : "There was an error in $convert" }
 { "_id" : "13", "output" : "There was an error in $convert" }
 { "_id" : "14", "output" : "There was an error in $convert" }
 { "_id" : "15", "output" : "There was an error in $convert" }
 { "_id" : "16", "output" : "There was an error in $convert" }
 { "_id" : "17", "output" : "There was an error in $convert" }
 { "_id" : "18", "output" : "There was an error in $convert" }
 { "_id" : "19", "output" : "There was an error in $convert" }
 { "_id" : "20", "output" : "There was an error in $convert" }
 { "_id" : "21", "output" : "There was an error in $convert" }
 { "_id" : "22", "output" : "There was an error in $convert" }
 { "_id" : "23", "output" : "There was an error in $convert" }
 { "_id" : "24", "output" : "There was an error in $convert" }
 { "_id" : "25", "output" : "There was an error in $convert" }
 { "_id" : "26", "output" : "There was an error in $convert" }
 { "_id" : "27", "output" : "There was an error in $convert" }
 { "_id" : "28", "output" : "There was an error in $convert" }
 { "_id" : "29", "output" : "There was an error in $convert" }
(29 rows)

-- $convert undefined/missing field used for onError should return empty result
SELECT bson_dollar_project(document, '{"output": {"$convert": { "input": "$input", "to": "$target", "onError": "$missingField"}}}') FROM documentdb_api.collection('db', 'convertCollWithErrors');
 bson_dollar_project 
---------------------------------------------------------------------
 { "_id" : "1" }
 { "_id" : "2" }
 { "_id" : "3" }
 { "_id" : "4" }
 { "_id" : "5" }
 { "_id" : "6" }
 { "_id" : "7" }
 { "_id" : "8" }
 { "_id" : "9" }
 { "_id" : "10" }
 { "_id" : "11" }
 { "_id" : "12" }
 { "_id" : "13" }
 { "_id" : "14" }
 { "_id" : "15" }
 { "_id" : "16" }
 { "_id" : "17" }
 { "_id" : "18" }
 { "_id" : "19" }
 { "_id" : "20" }
 { "_id" : "21" }
 { "_id" : "22" }
 { "_id" : "23" }
 { "_id" : "24" }
 { "_id" : "25" }
 { "_id" : "26" }
 { "_id" : "27" }
 { "_id" : "28" }
 { "_id" : "29" }
(29 rows)

-- $convert errors in parsing should be honored even if onError is set
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": { "input": {"$divide": [1, 0]}, "to": "string", "onError": "There was an error in $convert"}}}');
ERROR:  can't $divide by zero
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": "$myField"}}');
ERROR:  $convert expects an object of named arguments but found: string
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": 1, "onError": "There was an error"}}}');
ERROR:  Missing 'to' parameter to $convert
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"to": 1, "onError": "There was an error"}}}');
ERROR:  Missing 'input' parameter to $convert
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"myCustomInput": 1, "onError": "There was an error"}}}');
ERROR:  $convert found an unknown argument: myCustomInput
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": 1, "to": "someType", "onError": "There was an error"}}}');
ERROR:  Unknown type name alias: someType
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": 1, "to": {"$numberDouble": "1.1"}, "onError": "There was an error"}}}');
ERROR:  In $convert, numeric 'to' argument is not an integer
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": 1, "to": {"$numberDouble": "255"}, "onError": "There was an error"}}}');
ERROR:  In $convert, numeric value for 'to' does not correspond to a BSON type: 255
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": 1, "to": {"$numberDouble": "-2.0"}, "onError": "There was an error"}}}');
ERROR:  In $convert, numeric value for 'to' does not correspond to a BSON type: -2
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": 1, "to": [], "onError": "There was an error"}}}');
ERROR:  $convert's 'to' argument must be a string or number, but is array
-- $convert identifies the target types with numbers
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": -1}}}');
ERROR:  Unsupported conversion from object to minKey in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 127}}}');
ERROR:  Unsupported conversion from object to maxKey in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 0}}}');
ERROR:  Unsupported conversion from object to missing in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 1}}}');
ERROR:  Unsupported conversion from object to double in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 2}}}');
ERROR:  Unsupported conversion from object to string in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 3}}}');
ERROR:  Unsupported conversion from object to object in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 4}}}');
ERROR:  Unsupported conversion from object to array in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 5}}}');
ERROR:  Unsupported conversion from object to binData in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 6}}}');
ERROR:  Unsupported conversion from object to undefined in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 7}}}');
ERROR:  Unsupported conversion from object to objectId in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 8}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : true }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 9}}}');
ERROR:  Unsupported conversion from object to date in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 10}}}');
ERROR:  Unsupported conversion from object to null in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 11}}}');
ERROR:  Unsupported conversion from object to regex in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 12}}}');
ERROR:  Unsupported conversion from object to dbPointer in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 13}}}');
ERROR:  Unsupported conversion from object to javascript in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 14}}}');
ERROR:  Unsupported conversion from object to symbol in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 15}}}');
ERROR:  Unsupported conversion from object to javascriptWithScope in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 16}}}');
ERROR:  Unsupported conversion from object to int in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {}, "to": 17}}}');
ERROR:  Unsupported conversion from object to timestamp in $convert with no onError value
-- double max + 1 and min-1 range $convert, $toLong
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {"$numberDouble" : "9223372036854775296"}, "to": "long"}}}');
ERROR:  Conversion would overflow target type in $convert with no onError value: 9.22337E+18
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {"$numberDouble" : "-9223372036854776833"}, "to": "long"}}}');
ERROR:  Conversion would overflow target type in $convert with no onError value: -9.22337E+18
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": {"$numberDouble": "9223372036854775296"}}}');
ERROR:  Conversion would overflow target type in $convert with no onError value: 9.22337E+18
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": {"$numberDouble": "-9223372036854776833"}}}');
ERROR:  Conversion would overflow target type in $convert with no onError value: -9.22337E+18
-- min supported value for $convert, $toLong
SELECT * FROM bson_dollar_project('{}', '{"result": {"$convert": {"input": {"$numberDouble" : "-9223372036854776832"}, "to": "long"}}}');
                    bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-9223372036854775808" } }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": {"$numberDouble": "-9223372036854776832"}}}');
                    bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-9223372036854775808" } }
(1 row)

--
--
-- $to* alias tests.
-- call the shorthand convert $to* aliases.
WITH toQuery AS (SELECT bson_dollar_project(document,
'{"expected": 1,
  "output":
    { 
        "$switch": {
            "branches": [
                {"case": {"$eq": ["$target", "double"]}, "then": {"$toDouble": "$input"}},
                {"case": {"$eq": ["$target", "string"]}, "then": {"$toString": "$input"}},
                {"case": {"$eq": ["$target", "objectId"]}, "then": {"$toObjectId": "$input"}},
                {"case": {"$eq": ["$target", "bool"]}, "then": {"$toBool": "$input"}},
                {"case": {"$eq": ["$target", "date"]}, "then": {"$toDate": "$input"}},
                {"case": {"$eq": ["$target", "int"]}, "then": {"$toInt": "$input"}},
                {"case": {"$eq": ["$target", "long"]}, "then": {"$toLong": "$input"}},
                {"case": {"$eq": ["$target", "decimal"]}, "then": {"$toDecimal": "$input"}}
            ]
        }
    }
}') as outDoc FROM documentdb_api.collection('db', 'convertColl'))
SELECT bson_dollar_project(outDoc, '{"passed": {"$eq": ["$output", "$expected"]}}') FROM toQuery;
        bson_dollar_project        
---------------------------------------------------------------------
 { "_id" : "1", "passed" : true }
 { "_id" : "2", "passed" : true }
 { "_id" : "3", "passed" : true }
 { "_id" : "4", "passed" : true }
 { "_id" : "5", "passed" : true }
 { "_id" : "6", "passed" : true }
 { "_id" : "7", "passed" : true }
 { "_id" : "8", "passed" : true }
 { "_id" : "9", "passed" : true }
 { "_id" : "10", "passed" : true }
 { "_id" : "11", "passed" : true }
 { "_id" : "12", "passed" : true }
 { "_id" : "13", "passed" : true }
 { "_id" : "14", "passed" : true }
 { "_id" : "15", "passed" : true }
 { "_id" : "16", "passed" : true }
 { "_id" : "17", "passed" : true }
 { "_id" : "18", "passed" : true }
 { "_id" : "19", "passed" : true }
 { "_id" : "20", "passed" : true }
 { "_id" : "21", "passed" : true }
 { "_id" : "22", "passed" : true }
 { "_id" : "23", "passed" : true }
 { "_id" : "24", "passed" : true }
 { "_id" : "26", "passed" : true }
 { "_id" : "27", "passed" : true }
 { "_id" : "28", "passed" : true }
 { "_id" : "29", "passed" : true }
 { "_id" : "30", "passed" : true }
 { "_id" : "31", "passed" : true }
 { "_id" : "32", "passed" : true }
 { "_id" : "33", "passed" : true }
 { "_id" : "34", "passed" : true }
 { "_id" : "35", "passed" : true }
 { "_id" : "36", "passed" : true }
 { "_id" : "37", "passed" : true }
 { "_id" : "38", "passed" : true }
 { "_id" : "39", "passed" : true }
 { "_id" : "40", "passed" : true }
 { "_id" : "45", "passed" : true }
 { "_id" : "46", "passed" : true }
 { "_id" : "47", "passed" : true }
 { "_id" : "48", "passed" : true }
 { "_id" : "49", "passed" : true }
 { "_id" : "50", "passed" : true }
 { "_id" : "51", "passed" : true }
 { "_id" : "52", "passed" : true }
 { "_id" : "53", "passed" : true }
 { "_id" : "54", "passed" : true }
 { "_id" : "55", "passed" : true }
 { "_id" : "56", "passed" : true }
 { "_id" : "57", "passed" : true }
 { "_id" : "58", "passed" : true }
 { "_id" : "59", "passed" : true }
 { "_id" : "61", "passed" : true }
 { "_id" : "62", "passed" : true }
 { "_id" : "63", "passed" : true }
 { "_id" : "64", "passed" : true }
 { "_id" : "65", "passed" : true }
 { "_id" : "66", "passed" : true }
 { "_id" : "67", "passed" : true }
 { "_id" : "68", "passed" : true }
 { "_id" : "69", "passed" : true }
 { "_id" : "70", "passed" : true }
 { "_id" : "71", "passed" : true }
 { "_id" : "72", "passed" : true }
 { "_id" : "73", "passed" : true }
 { "_id" : "74", "passed" : true }
 { "_id" : "75", "passed" : true }
 { "_id" : "76", "passed" : true }
 { "_id" : "77", "passed" : true }
 { "_id" : "78", "passed" : true }
 { "_id" : "79", "passed" : true }
 { "_id" : "80", "passed" : true }
 { "_id" : "81", "passed" : true }
 { "_id" : "82", "passed" : true }
 { "_id" : "83", "passed" : true }
 { "_id" : "84", "passed" : true }
 { "_id" : "85", "passed" : true }
 { "_id" : "86", "passed" : true }
 { "_id" : "87", "passed" : true }
 { "_id" : "88", "passed" : true }
(82 rows)

-- $toObjectId negative tests
-- only supports 24 char hex string, objectId, null/undefined, and requires exactly 1 argument.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toObjectId": {"input": ""}}}');
ERROR:  Unsupported conversion from object to objectId in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toObjectId": []}}');
ERROR:  Expression $toObjectId takes exactly 1 arguments. 0 were passed in.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toObjectId": "this is a string"}}');
ERROR:  Failed to parse objectId 'this is a string' in $convert with no onError value: Invalid string length for parsing to OID, expected 24 but found 16
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toObjectId": "asdsfsdzzzzsersdfrtghtsz"}}');
ERROR:  Failed to parse objectId 'asdsfsdzzzzsersdfrtghtsz' in $convert with no onError value: Invalid character found in hex string: 's'
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toObjectId": "639926cee6bda3127f153bfZ"}}');
ERROR:  Failed to parse objectId '639926cee6bda3127f153bfZ' in $convert with no onError value: Invalid character found in hex string: 'Z'
-- $toInt negative tests
-- only supports numeric, bool or string and must not overflow/underflow. Takes exactly 1 argument.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": {"input": ""}}}');
ERROR:  Unsupported conversion from object to int in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": []}}');
ERROR:  Expression $toInt takes exactly 1 arguments. 0 were passed in.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": [{"$date": "2022-01-01T00:00:00.000Z"}]}}');
ERROR:  Unsupported conversion from date to int in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": {"$numberDouble": "2147483648"}}}');
ERROR:  Conversion would overflow target type in $convert with no onError value: 2.14748E+09
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": {"$numberDouble": "Infinity"}}}');
ERROR:  Attempt to convert infinity value to integer type in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": {"$numberDouble": "-Infinity"}}}');
ERROR:  Attempt to convert infinity value to integer type in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": {"$numberDouble": "NaN"}}}');
ERROR:  Attempt to convert NaN value to integer type in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": {"$numberDecimal": "-Infinity"}}}');
ERROR:  Attempt to convert infinity value to integer type in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": {"$numberDecimal": "Infinity"}}}');
ERROR:  Attempt to convert infinity value to integer type in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": {"$numberDecimal": "NaN"}}}');
ERROR:  Attempt to convert NaN value to integer type in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": {"$numberDecimal": "-2147483649"}}}');
ERROR:  Conversion would overflow target type in $convert with no onError value: -2147483649
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": {"$numberLong": "-2147483649"}}}');
ERROR:  Conversion would overflow target type in $convert with no onError value: -2147483649
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": "-2147483649" }}');
ERROR:  Failed to parse number '-2147483649' in $convert with no onError value: Overflow
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": "2147483648" }}');
ERROR:  Failed to parse number '2147483648' in $convert with no onError value: Overflow
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": "This contains a number: 324423" }}');
ERROR:  Failed to parse number 'This contains a number: 324423' in $convert with no onError value: Did not consume whole string.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": "    324423" }}');
ERROR:  Failed to parse number '    324423' in $convert with no onError value: Did not consume whole string.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": "324423     " }}');
ERROR:  Failed to parse number '324423     ' in $convert with no onError value: Did not consume whole string.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": "0x01" }}');
ERROR:  Illegal hexadecimal input in $convert with no onError value: 0x01
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toInt": "" }}');
ERROR:  Failed to parse number '' in $convert with no onError value: No digits
-- $toLong negative tests
-- only support numeric, date, bool or string, must not overflow/underflow. Takes exactly 1 argument.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": {"input": ""}}}');
ERROR:  Unsupported conversion from object to long in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": []}}');
ERROR:  Expression $toLong takes exactly 1 arguments. 0 were passed in.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": {"$numberDouble": "9223372036854775808"}}}');
ERROR:  Conversion would overflow target type in $convert with no onError value: 9.22337E+18
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": {"$numberDouble": "Infinity"}}}');
ERROR:  Attempt to convert infinity value to integer type in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": {"$numberDouble": "-Infinity"}}}');
ERROR:  Attempt to convert infinity value to integer type in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": {"$numberDouble": "NaN"}}}');
ERROR:  Attempt to convert NaN value to integer type in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": {"$numberDecimal": "-Infinity"}}}');
ERROR:  Attempt to convert infinity value to integer type in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": {"$numberDecimal": "Infinity"}}}');
ERROR:  Attempt to convert infinity value to integer type in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": {"$numberDecimal": "NaN"}}}');
ERROR:  Attempt to convert NaN value to integer type in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": {"$numberDecimal": "-9223372036854775809"}}}');
ERROR:  Conversion would overflow target type in $convert with no onError value: -9223372036854775809
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": "-9223372036854775809" }}');
ERROR:  Failed to parse number '-9223372036854775809' in $convert with no onError value: Overflow
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": "9223372036854775808" }}');
ERROR:  Failed to parse number '9223372036854775808' in $convert with no onError value: Overflow
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": "This contains a number: 324423" }}');
ERROR:  Failed to parse number 'This contains a number: 324423' in $convert with no onError value: Did not consume whole string.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": "    324423" }}');
ERROR:  Failed to parse number '    324423' in $convert with no onError value: Did not consume whole string.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": "324423     " }}');
ERROR:  Failed to parse number '324423     ' in $convert with no onError value: Did not consume whole string.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": "0x01" }}');
ERROR:  Illegal hexadecimal input in $convert with no onError value: 0x01
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toLong": "" }}');
ERROR:  Failed to parse number '' in $convert with no onError value: No digits
-- $toDouble negative tests
-- only support numeric, date, bool or string, must not overflow/underflow. Takes exactly 1 argument.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDouble": {"input": ""}}}');
ERROR:  Unsupported conversion from object to double in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDouble": []}}');
ERROR:  Expression $toDouble takes exactly 1 arguments. 0 were passed in.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDouble": {"$numberDecimal": "1.8E309"}}}');
ERROR:  Conversion would overflow target type in $convert with no onError value: 1.8E+309
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDouble": {"$numberDecimal": "-1.8E309"}}}');
ERROR:  Conversion would overflow target type in $convert with no onError value: -1.8E+309
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDouble": "1.8E309" }}');
ERROR:  Failed to parse number '1.8E309' in $convert with no onError value: Out of range
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDouble": "-1.8E309" }}');
ERROR:  Failed to parse number '-1.8E309' in $convert with no onError value: Out of range
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDouble": "This contains a number: 324423.23" }}');
ERROR:  Failed to parse number 'This contains a number: 324423.23' in $convert with no onError value: Failed to parse string to decimal
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDouble": "    324423.0" }}');
ERROR:  Failed to parse number '    324423.0' in $convert with no onError value: Failed to parse string to decimal
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDouble": "324423.00001     " }}');
ERROR:  Failed to parse number '324423.00001     ' in $convert with no onError value: Failed to parse string to decimal
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDouble": "0x01" }}');
ERROR:  Illegal hexadecimal input in $convert with no onError value: 0x01
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDouble": "" }}');
ERROR:  Failed to parse number '' in $convert with no onError value: Empty string
-- $toDecimal negative tests
-- only support numeric, date, bool or string, must not overflow/underflow. Takes exactly 1 argument.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDecimal": {"input": ""}}}');
ERROR:  Unsupported conversion from object to decimal in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDecimal": []}}');
ERROR:  Expression $toDecimal takes exactly 1 arguments. 0 were passed in.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDecimal": "123423.8E6145" }}');
ERROR:  Failed to parse number '123423.8E6145' in $convert with no onError value: Failed to parse string to decimal
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDecimal": "-123423.8E6145" }}');
ERROR:  Failed to parse number '-123423.8E6145' in $convert with no onError value: Failed to parse string to decimal
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDecimal": "This contains a number: 324423.23" }}');
ERROR:  Failed to parse number 'This contains a number: 324423.23' in $convert with no onError value: Failed to parse string to decimal
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDecimal": "    324423.0" }}');
ERROR:  Failed to parse number '    324423.0' in $convert with no onError value: Failed to parse string to decimal
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDecimal": "324423.00001     " }}');
ERROR:  Failed to parse number '324423.00001     ' in $convert with no onError value: Failed to parse string to decimal
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDecimal": "0x01" }}');
ERROR:  Illegal hexadecimal input in $convert with no onError value: 0x01
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDecimal": "" }}');
ERROR:  Failed to parse number '' in $convert with no onError value: Empty string
-- $toString negative tests
-- only support numeric, date, bool, string, objectId. Takes exactly 1 argument
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toString": {"input": ""}}}');
ERROR:  Unsupported conversion from object to string in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toString": []}}');
ERROR:  Expression $toString takes exactly 1 arguments. 0 were passed in.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toString": {"$timestamp" : { "t": 1670981326, "i": 1 }}}}');
ERROR:  Unsupported conversion from timestamp to string in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toString": [[]]}}');
ERROR:  Unsupported conversion from array to string in $convert with no onError value
-- $toDate negative tests
-- only support double, decimal128, long, objectId, timestamp, date. String support will be added with $dateFromString.
-- Numeric, will be added to the Unix epoch 0 and shouldn't exceed int64 limits. Takes exactly 1 argument
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDate": {"input": ""}}}');
ERROR:  Unsupported conversion from object to date in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDate": []}}');
ERROR:  Expression $toDate takes exactly 1 arguments. 0 were passed in.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDate": [[]]}}');
ERROR:  Unsupported conversion from array to date in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDate": {"$numberDouble": "9223372036854775808"}}}');
ERROR:  Conversion would overflow target type in $convert with no onError value: 9.22337E+18
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDate": {"$numberDecimal": "9223372036854775808"}}}');
ERROR:  Conversion would overflow target type in $convert with no onError value: 9223372036854775808
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDate": {"$numberDecimal": "-9223372036854775809"}}}');
ERROR:  Conversion would overflow target type in $convert with no onError value: -9223372036854775809
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDate": {"$numberDouble": "-9223372036854775809"}}}');
                           bson_dollar_project                           
---------------------------------------------------------------------
 { "result" : { "$date" : { "$numberLong" : "-9223372036854775808" } } }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDate": 1}}');
ERROR:  Unsupported conversion from int to date in $convert with no onError value
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toDate": "2022-01-01T00:00:00.000Z"}}');
ERROR:  Unsupported conversion from string to date in $convert with no onError value
-- $$toHashedIndexKey tests
--test int
select *from bson_dollar_project('{"tests": 3}', '{"result": { "$toHashedIndexKey": "$tests" } }');
                    bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-4918719581749358852" } }
(1 row)

select *from bson_dollar_project('{}', '{"result": { "$toHashedIndexKey": 3 } }');
                    bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-4918719581749358852" } }
(1 row)

--test double
select *from bson_dollar_project('{"tests": 3.1}', '{"result": { "$toHashedIndexKey": "$tests" } }');
                   bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "4843356556253255961" } }
(1 row)

select *from bson_dollar_project('{}', '{"result": { "$toHashedIndexKey": 3.1 } }');
                   bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "4843356556253255961" } }
(1 row)

--test string
select *from bson_dollar_project('{"tests": "abc"}', '{"result": { "$toHashedIndexKey": "$tests" } }');
                    bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-6969118462091671691" } }
(1 row)

select *from bson_dollar_project('{}', '{"result": { "$toHashedIndexKey": "abc" } }');
                    bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-6969118462091671691" } }
(1 row)

--test int64
select *from bson_dollar_project('{"tests": 123456789012345678}', '{"result": { "$toHashedIndexKey": "$tests" } }');
                   bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1821714458417502614" } }
(1 row)

select *from bson_dollar_project('{}', '{"result": { "$toHashedIndexKey": 123456789012345678 } }');
                   bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1821714458417502614" } }
(1 row)

--test array
select *from bson_dollar_project('{"tests": [1, 2, 3.1]}', '{"result": { "$toHashedIndexKey": "$tests" } }');
                   bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "9190027316038958342" } }
(1 row)

select *from bson_dollar_project('{}', '{"result": { "$toHashedIndexKey": [1, 2, 3.1] } }');
                   bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "9190027316038958342" } }
(1 row)

--test nested array
select *from bson_dollar_project('{"tests": [1, 2, 3.1,[4, 5], 6]}', '{"result": { "$toHashedIndexKey": "$tests" } }');
                    bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-5553235042546732581" } }
(1 row)

select *from bson_dollar_project('{}', '{"result": { "$toHashedIndexKey": [1, 2, 3.1,[4, 5], 6] } }');
                    bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-5553235042546732581" } }
(1 row)

--test nested object
select *from bson_dollar_project('{"tests": [{"$numberDecimal": "1.2"},3]}', '{"result": { "$toHashedIndexKey": "$tests" } }');
                   bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-893570203633809211" } }
(1 row)

select *from bson_dollar_project('{}', '{"result": { "$toHashedIndexKey": [{"$numberDecimal": "1.2"},3] } }');
                   bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-893570203633809211" } }
(1 row)

--test null
select *from bson_dollar_project('{"tests": null}', '{"result": { "$toHashedIndexKey": "$tests" } }');
                    bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-4514028574017177401" } }
(1 row)

select *from bson_dollar_project('{}', '{"result": { "$toHashedIndexKey": null } }');
                    bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-4514028574017177401" } }
(1 row)

--test NaN
select *from bson_dollar_project('{"tests": {"$numberDouble": "NaN"}}', '{"result": { "$toHashedIndexKey": "$tests" } }');
                    bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-2341399240614902273" } }
(1 row)

select *from bson_dollar_project('{}', '{"result": { "$toHashedIndexKey": {"$numberDouble": "NaN"} } }');
                    bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-2341399240614902273" } }
(1 row)

--test Infinity
select *from bson_dollar_project('{"tests": {"$numberDouble": "Infinity"}}', '{"result": { "$toHashedIndexKey": "$tests" } }');
                    bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-3715419061678165155" } }
(1 row)

select *from bson_dollar_project('{}', '{"result": { "$toHashedIndexKey": {"$numberDouble": "Infinity"} } }');
                    bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "-3715419061678165155" } }
(1 row)

--test -Infinity
select *from bson_dollar_project('{"tests": {"$numberDouble": "-Infinity"}}', '{"result": { "$toHashedIndexKey": "$tests" } }');
                   bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "8076669524792135709" } }
(1 row)

select *from bson_dollar_project('{}', '{"result": { "$toHashedIndexKey": {"$numberDouble": "-Infinity"} } }');
                   bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "8076669524792135709" } }
(1 row)

--test path
select *from bson_dollar_project('{"tests": {"test" : 5}}', '{"result": { "$toHashedIndexKey": "$tests.test" } }');
                   bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "1786987034919379147" } }
(1 row)

select *from bson_dollar_project('{"tests": 3}', '{"result": { "$toHashedIndexKey": "$test" } }');
                   bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "4154612158245552303" } }
(1 row)

select *from bson_dollar_project('{"tests": {"test" : 5}}', '{"result": { "$toHashedIndexKey": "$tests.tes" } }');
                   bson_dollar_project                    
---------------------------------------------------------------------
 { "result" : { "$numberLong" : "4154612158245552303" } }
(1 row)

-- $toUUID tests
-- equivalent $convert query should be tested after extended $convert syntax is supported
-- positive tests
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toUUID": null }}');
 bson_dollar_project 
---------------------------------------------------------------------
 { "result" : null }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$toUUID": "123e4567-e89b-12d3-a456-426614174000" }}');
                                    bson_dollar_project                                     
---------------------------------------------------------------------
 { "result" : { "$binary" : { "base64" : "Ej5FZ+ibEtOkVkJmFBdAAA==", "subType" : "04" } } }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$toUUID": ["123e4567-e89b-12d3-a456-426614174000"] }}');
                                    bson_dollar_project                                     
---------------------------------------------------------------------
 { "result" : { "$binary" : { "base64" : "Ej5FZ+ibEtOkVkJmFBdAAA==", "subType" : "04" } } }
(1 row)

-- negative tests
-- invalid string
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toUUID": "invalid-uuid-1234" }}');
ERROR:  Failed to parse BinData invalid-uuid-1234 in $convert with no onError value: Invalid UUID string: invalid-uuid-1234
-- invalid type
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toUUID": 1234 }}');
ERROR:  Unsupported conversion from int to binData in $convert with no onError value
-- invalid count number of array input
SELECT * FROM bson_dollar_project('{}', '{"result": {"$toUUID": ["123e4567-e89b-12d3-a456-426614174000", "123e4567-e89b-12d3-a456-426614174000"] }}');
ERROR:  Expression $toUUID takes exactly 1 arguments. 2 were passed in.
