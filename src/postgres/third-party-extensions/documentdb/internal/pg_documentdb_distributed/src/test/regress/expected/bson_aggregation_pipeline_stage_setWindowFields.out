SET search_path TO documentdb_api_catalog;
SET citus.next_shard_id TO 455000;
SET documentdb.next_collection_id TO 4550;
SET documentdb.next_collection_index_id TO 4550;
SELECT documentdb_api.drop_collection('db','setWindowFields');
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

-- Add error and validation tests for setWindowFields stage
SELECT documentdb_api.insert_one('db','setWindowFields','{ "_id": 1, "a": "abc", "cost": 10, "quantity": 501, "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields','{ "_id": 2, "a": "def", "cost": 8, "quantity": 502, "date": { "$date": { "$numberLong": "1718841605000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields','{ "_id": 3, "a": "ghi", "cost": 4, "quantity": 503, "date": { "$date": { "$numberLong": "1718841610000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields','{ "_id": 4, "a": "abc", "cost": 10, "quantity": 504, "date": { "$date": { "$numberLong": "1718841615000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields','{ "_id": 5, "a": "def", "cost": 8, "quantity": 505, "date": { "$date": { "$numberLong": "1718841620000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields','{ "_id": 6, "a": "ghi", "cost": 4, "quantity": 506, "date": { "$date": { "$numberLong": "1718841630000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields','{ "_id": 7, "a": "abc", "cost": 10, "quantity": 507, "date": { "$date": { "$numberLong": "1718841640000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields','{ "_id": 8, "a": "def", "cost": 8, "quantity": 508, "date": { "$date": { "$numberLong": "1718841680000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields','{ "_id": 9, "a": "ghi", "cost": 4, "quantity": 509, "date": { "$date": { "$numberLong": "1718841700000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields','{ "_id": 10, "a": "abc", "cost": 10, "quantity": 510, "date": { "$date": { "$numberLong": "1718841800000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields','{ "_id": 11, "a": "def", "cost": 8, "quantity": 511, "date": { "$date": { "$numberLong": "1718841900000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields','{ "_id": 12, "a": "ghi", "cost": 4, "quantity": 512, "date": { "$date": { "$numberLong": "1718842600000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields','{ "_id": 13, "a": "abc", "cost": 80, "quantity": 515, "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_invalidtypes','{ "_id": 1, "a": "abc", "cost": 80, "quantity": 515, "date": 1 }', NULL); -- date type mismatch
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_invalidtypes','{ "_id": 2, "a": "abc", "cost": 80, "quantity": 515 }', NULL); -- date is missing
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_invalidtypes','{ "_id": 3, "a": "abc", "cost": "80", "quantity": 515 }', NULL); -- cost type mismatch
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_invalidtypes','{ "_id": 4, "a": "abc", "quantity": 515 }', NULL); -- cost is missing
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Validations of $setWindowFields stage and negative test cases
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": "Not an object" }]}');
ERROR:  the $setWindowFields stage specification must be an object, found string
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "partitionBy": 1, "sortBy": {"a": 1} } }]}');
ERROR:  BSON field '$setWindowFields.output' is missing but a required field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total": {"$sum": 1} }, "unknownField": {} } }]}');
ERROR:  BSON field '$setWindowFields.unknownField' is an unknown field.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total": {"$sum": 1} }, "partitionBy": [1] } }]}');
ERROR:  An expression used to partition cannot evaluate to value of type array
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total": {"$sum": 1} }, "partitionBy": { "$concatArrays": [[1], [2]] }}}]}');
ERROR:  PlanExecutor error during aggregation :: caused by :: An expression used to partition cannot evaluate to value of type array
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total": {"$sum": 1} }, "partitionBy": 1, "sortBy": { "a" : "asc" }}}]}');
ERROR:  Invalid sort direction "asc"
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total": {"$sum": 1} }, "partitionBy": 1, "sortBy": "Not an Object"}}]}');
ERROR:  BSON field '$setWindowFields.sortBy' is the wrong type 'string', expected type 'object'
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total": "Not an object" }}}]}');
ERROR:  The field 'total' must be an object
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total": {"$unknownOperator": 1}}}}]}');
ERROR:  Unrecognized window function, $unknownOperator
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "$total": {"$sum": 1}}}}]}');
ERROR:  FieldPath field names may not start with '$'. Consider using $getField or $setField.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "": {"$unknownOperator": 1}}}}]}');
ERROR:  FieldPath cannot be constructed with empty string
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1}, "total2": "Not an object" }}}]}');
ERROR:  The field 'total2' must be an object
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": "Not an object"}}}}]}');
ERROR:  'window' field must be an object
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "unknownBound": [1, 2] }}}}}]}');
ERROR:  'window' field can only contain 'documents' as the only argument or 'range' with an optional 'unit' field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "": [1, 2] }}}}}]}');
ERROR:  'window' field can only contain 'documents' as the only argument or 'range' with an optional 'unit' field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": "not an array" }}}}}]}');
ERROR:  Window bounds must be a 2-element array: documents: "not an array"
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "range": { "a": 1, "b": 2 } }}}}}]}');
ERROR:  Window bounds must be a 2-element array: range: { "a" : 1, "b" : 2 }
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": ["current", "current"], "unknownBound": [1, 2] }}}}}]}');
ERROR:  'window' field that specifies documents cannot have other fields 
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "range": ["current", "current"], "unknownBound": [1, 2] }}}}}]}');
ERROR:  'window' field that specifies range cannot have other fields besides 'unit'
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": ["current", "current"], "unit": "second" }}}}}]}');
ERROR:  Window bounds can only specify 'unit' with range-based bounds.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": [-1 , 1] }}}}}]}');
ERROR:  Document-based bounds require a sortBy
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": ["current" , 1] }}}}}]}');
ERROR:  Document-based bounds require a sortBy
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": ["current" , "current"] }}}}}]}');
ERROR:  Document-based bounds require a sortBy
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": ["current" , "unbounded"] }}}}}]}');
ERROR:  Document-based bounds require a sortBy
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": ["unbounded" , 1] }}}}}]}');
ERROR:  Document-based bounds require a sortBy
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": [-1 , "unbounded"] }}}}}]}');
ERROR:  Document-based bounds require a sortBy
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": ["" , ""] }}}}}]}');
ERROR:  Window bounds must be 'unbounded', 'current', or a number.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "range": ["unbounded" , "unbounded"] }}}}}]}');
ERROR:  Range-based bounds require sortBy a single field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "sortBy": {"a": 1, "b": 1}, "output": { "total1": {"$sum": 1 , "window": { "range": ["unbounded" , "unbounded"] }}}}}]}');
ERROR:  Range-based bounds require sortBy a single field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "sortBy": {"a": -1}, "output": { "total1": {"$sum": 1 , "window": { "range": ["unbounded" , "unbounded"] }}}}}]}');
ERROR:  Range-based bounds require an ascending sortBy
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": [1] }}}}}]}');
ERROR:  Window bounds must be a 2-element array: documents: [ 1 ]
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": [1, 2, 3] }}}}}]}');
ERROR:  Window bounds must be a 2-element array: documents: [ 1, 2, 3 ]
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": [1, "text"] }}}}}]}');
ERROR:  Window bounds must be 'unbounded', 'current', or a number.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": [1, {"a": 1}] }}}}}]}');
ERROR:  Numeric document-based bounds must be an integer
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "documents": [1, -1] }}}}}]}');
ERROR:  Lower bound must not exceed upper bound: [ 1, -1 ]
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "range": [1, "current"] }}}}}]}');
ERROR:  Lower bound must not exceed upper bound: [ 1, "current" ]
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "output": { "total1": {"$sum": 1 , "window": { "range": ["current", -2] }}}}}]}');
ERROR:  Lower bound must not exceed upper bound: [ "current", -2 ]
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "sortBy": {"date": 1}, "output": { "total1": {"$sum": 1 , "window": { "range": ["current", 2] }}}}}]}');
ERROR:  PlanExecutor error during aggregation :: caused by :: Invalid range: Expected the sortBy field to be a number, but it was date
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "sortBy": {"a": 1}, "output": { "total1": {"$sum": 1 , "window": { "range": ["current", 2], "unit": "day" }}}}}]}');
ERROR:  PlanExecutor error during aggregation :: caused by :: Invalid range: Expected the sortBy field to be a Date, but it was string
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "sortBy": {"a": 1}, "output": { "total1": {"$sum": 1 , "window": { "range": ["current", 2], "unit": "days" }}}}}]}');
ERROR:  unknown time unit value: days
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": { "sortBy": {"a": 1}, "output": { "total1": {"$sum": 1 , "window": { "range": ["current", 2], "unit": "Day" }}}}}]}');
ERROR:  unknown time unit value: Day
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$match": {"_id": 1 }}, {"$setWindowFields": { "sortBy": {"date": 1}, "output": { "total1": {"$sum": 1 , "window": { "range": ["current", 2], "unit": "second"}}}}}]}');
ERROR:  PlanExecutor error during aggregation :: caused by :: Invalid range: Expected the sortBy field to be a Date, but it was int
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$match": { "_id": 2 }}, {"$setWindowFields": { "sortBy": {"date": 1}, "output": { "total1": {"$sum": 1 , "window": { "range": ["current", 2], "unit": "second"}}}}}]}');
ERROR:  PlanExecutor error during aggregation :: caused by :: Invalid range: Expected the sortBy field to be a Date, but it was undefined
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$match": { "_id": 3 }}, {"$setWindowFields": { "sortBy": {"cost": 1}, "output": { "total1": {"$sum": 1 , "window": { "range": ["current", 2]}}}}}]}');
ERROR:  PlanExecutor error during aggregation :: caused by :: Invalid range: Expected the sortBy field to be a number, but it was string
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$match": { "_id": 4 }}, {"$setWindowFields": { "sortBy": {"cost": 1}, "output": { "total1": {"$sum": 1 , "window": { "range": ["current", 2]}}}}}]}');
ERROR:  PlanExecutor error during aggregation :: caused by :: Invalid range: Expected the sortBy field to be a number, but it was undefined
-- Common Positive tests for $setWindowFields stage and explains
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"total": { "$sum": 1}}}}]}');
                                                                                                        document                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "total" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "total" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "total" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "total" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "total" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "total" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "total" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "total" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "total" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "total" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "total" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "total" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "total" : { "$numberInt" : "4" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"output": {"total": { "$sum": 1}}}}]}'); -- No partitionBy or sortBy
                                                                                                         document                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "total" : { "$numberInt" : "13" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"sortBy": {"a": 1, "quantity": -1}, "output": {"total": { "$sum": 1}}}}]}'); -- No partitionBy
                                                                                                         document                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "total" : { "$numberInt" : "13" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "total" : { "$numberInt" : "13" } }
(13 rows)

-- [Optimization] Partition by on same shard key pushes the $setWindowFields stage to the shard
SELECT documentdb_api.insert_one('db','setWindowFields_sharded','{ "_id": 1, "a": "abc", "cost": 10, "quantity": 501, "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_sharded','{ "_id": 2, "a": "def", "cost": 8, "quantity": 502, "date": { "$date": { "$numberLong": "1718841605000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_sharded','{ "_id": 3, "a": "ghi", "cost": 4, "quantity": 503, "date": { "$date": { "$numberLong": "1718841610000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.shard_collection('db', 'setWindowFields_sharded', '{"a": "hashed"}', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": { "partitionBy": "$cost", "output": {"total": { "$sum": 1}}}}]}');
                                                                                                        document                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "total" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "total" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "total" : { "$numberInt" : "1" } }
(3 rows)

EXPLAIN (COSTS OFF, VERBOSE ON) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": { "partitionBy": "$cost", "output": {"total": { "$sum": 1}}}}]}'); -- different partitionby, not pushed to shards
                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   ->  Distributed Subplan 78_1
         ->  WindowAgg
               Output: remote_scan.document, bsonsum(documentdb_api_internal.bson_expression_get(remote_scan.total, '{ "" : { "$numberInt" : "1" } }'::documentdb_core.bson, true, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)) OVER (?), remote_scan."?partitionBy?"
               ->  Sort
                     Output: remote_scan."?partitionBy?", remote_scan.document, remote_scan.total
                     Sort Key: remote_scan."?partitionBy?"
                     ->  Custom Scan (Citus Adaptive)
                           Output: remote_scan."?partitionBy?", remote_scan.document, remote_scan.total
                           Task Count: 8
                           Tasks Shown: One of 8
                           ->  Task
                                 Query: SELECT document, document AS total, documentdb_api_internal.bson_expression_partition_get(document, '{ "" : "$cost" }'::documentdb_core.bson, true, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson) AS "?partitionBy?" FROM documentdb_data.documents_4552_455048 collection WHERE true
                                 Node: host=localhost port=58070 dbname=regression
                                 ->  Seq Scan on documentdb_data.documents_4552_455048 collection
                                       Output: document, document, documentdb_api_internal.bson_expression_partition_get(document, '{ "" : "$cost" }'::documentdb_core.bson, true, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(document, documentdb_core.bson_repath_and_build('total'::text, total)) AS document FROM (SELECT intermediate_result.document, intermediate_result.total FROM read_intermediate_result('78_1'::text, 'binary'::citus_copy_format) intermediate_result(document documentdb_core.bson, total documentdb_core.bson)) agg_stage_0
         Node: host=localhost port=58070 dbname=regression
         ->  Function Scan on pg_catalog.read_intermediate_result intermediate_result
               Output: documentdb_api_internal.bson_dollar_merge_documents(intermediate_result.document, documentdb_core.bson_repath_and_build('total'::text, intermediate_result.total))
               Function Call: read_intermediate_result('78_1'::text, 'binary'::citus_copy_format)
(25 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": { "partitionBy": "$a", "output": {"total": { "$sum": 1}}}}]}');
                                                                                                        document                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "total" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "total" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "total" : { "$numberInt" : "1" } }
(3 rows)

EXPLAIN (COSTS OFF, VERBOSE ON) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": { "partitionBy": "$a", "output": {"total": { "$sum": 1}}}}]}'); -- same partitioBy as shardkey, pushed to shards
                                                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(worker_column_1, documentdb_core.bson_repath_and_build('total'::text, worker_column_2)) AS document FROM (SELECT agg_stage_0.document AS worker_column_1, agg_stage_0.total AS worker_column_2 FROM (SELECT collection.document, documentdb_api_catalog.bsonsum(documentdb_api_internal.bson_expression_get(collection.document, '{ "" : { "$numberInt" : "1" } }'::documentdb_core.bson, true, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)) OVER (PARTITION BY collection.shard_key_value ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS total FROM documentdb_data.documents_4552_455048 collection) agg_stage_0) worker_subquery
         Node: host=localhost port=58070 dbname=regression
         ->  Subquery Scan on agg_stage_0
               Output: documentdb_api_internal.bson_dollar_merge_documents(agg_stage_0.document, documentdb_core.bson_repath_and_build('total'::text, agg_stage_0.total))
               ->  WindowAgg
                     Output: collection.document, documentdb_api_catalog.bsonsum(documentdb_api_internal.bson_expression_get(collection.document, '{ "" : { "$numberInt" : "1" } }'::documentdb_core.bson, true, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)) OVER (?), collection.shard_key_value
                     ->  Index Scan using _id_ on documentdb_data.documents_4552_455048 collection
                           Output: collection.shard_key_value, collection.document
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$match": {"a": "def"}}, {"$setWindowFields": { "output": {"total": { "$sum": 1}}}}]}');
                                                                                                       document                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "total" : { "$numberInt" : "1" } }
(1 row)

EXPLAIN (COSTS OFF, VERBOSE ON) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$match": {"a": "def"}}, {"$setWindowFields": { "output": {"total": { "$sum": 1}}}}]}'); -- target a single shard with $match, pushed to shard
                                                                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(document, documentdb_core.bson_repath_and_build('total'::text, total)) AS document FROM (SELECT collection.document, documentdb_api_catalog.bsonsum(documentdb_api_internal.bson_expression_get(collection.document, '{ "" : { "$numberInt" : "1" } }'::documentdb_core.bson, true, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS total FROM documentdb_data.documents_4552_455051 collection WHERE ((collection.document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "def" }'::documentdb_core.bsonquery) AND (collection.shard_key_value OPERATOR(pg_catalog.=) '8022442720571987527'::bigint))) agg_stage_1
         Node: host=localhost port=58070 dbname=regression
         ->  Subquery Scan on agg_stage_1
               Output: documentdb_api_internal.bson_dollar_merge_documents(agg_stage_1.document, documentdb_core.bson_repath_and_build('total'::text, agg_stage_1.total))
               ->  WindowAgg
                     Output: collection.document, documentdb_api_catalog.bsonsum(documentdb_api_internal.bson_expression_get(collection.document, '{ "" : { "$numberInt" : "1" } }'::documentdb_core.bson, true, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)) OVER (?)
                     ->  Seq Scan on documentdb_data.documents_4552_455051 collection
                           Output: collection.document
                           Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "def" }'::documentdb_core.bson) AND (collection.shard_key_value = '8022442720571987527'::bigint))
(14 rows)

-- Push to shard doesn't work when there is multi key shard key
SELECT documentdb_api.shard_collection('db', 'setWindowFields_sharded', '{"a": "hashed", "b": "hashed"}', true);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

EXPLAIN (COSTS OFF, VERBOSE ON) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": { "partitionBy": "$a", "output": {"total": { "$sum": 1}}}}]}'); -- same partitioBy as first key in shardkey, not pushed to shards
                                                                                                                                                                                                   QUERY PLAN                                                                                                                                                                                                    
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   ->  Distributed Subplan 97_1
         ->  WindowAgg
               Output: remote_scan.document, bsonsum(documentdb_api_internal.bson_expression_get(remote_scan.total, '{ "" : { "$numberInt" : "1" } }'::documentdb_core.bson, true, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)) OVER (?), remote_scan."?partitionBy?"
               ->  Sort
                     Output: remote_scan."?partitionBy?", remote_scan.document, remote_scan.total
                     Sort Key: remote_scan."?partitionBy?"
                     ->  Custom Scan (Citus Adaptive)
                           Output: remote_scan."?partitionBy?", remote_scan.document, remote_scan.total
                           Task Count: 8
                           Tasks Shown: One of 8
                           ->  Task
                                 Query: SELECT document, document AS total, documentdb_api_internal.bson_expression_partition_get(document, '{ "" : "$a" }'::documentdb_core.bson, true, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson) AS "?partitionBy?" FROM documentdb_data.documents_4552_455056 collection WHERE true
                                 Node: host=localhost port=58070 dbname=regression
                                 ->  Seq Scan on documentdb_data.documents_4552_455056 collection
                                       Output: document, document, documentdb_api_internal.bson_expression_partition_get(document, '{ "" : "$a" }'::documentdb_core.bson, true, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(document, documentdb_core.bson_repath_and_build('total'::text, total)) AS document FROM (SELECT intermediate_result.document, intermediate_result.total FROM read_intermediate_result('97_1'::text, 'binary'::citus_copy_format) intermediate_result(document documentdb_core.bson, total documentdb_core.bson)) agg_stage_0
         Node: host=localhost port=58070 dbname=regression
         ->  Function Scan on pg_catalog.read_intermediate_result intermediate_result
               Output: documentdb_api_internal.bson_dollar_merge_documents(intermediate_result.document, documentdb_core.bson_repath_and_build('total'::text, intermediate_result.total))
               Function Call: read_intermediate_result('97_1'::text, 'binary'::citus_copy_format)
(25 rows)

---------------------------------------------------------------------
-- $sum accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalQuantity": { "$sum": "$quantity"}}}}]}');
                                                                                                              document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalQuantity": { "$sum": "$quantity", "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                              document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$sum": "$quantity", "window": {"documents": ["unbounded", "current"]}}}}}]}');
                                                                                                              document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "1019" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "1526" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "2036" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "1016" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "1524" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "1009" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "1521" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$sum": "$quantity", "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$sum": "$quantity", "window": {"documents": ["current", "unbounded"]}}}}}]}');
                                                                                                              document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "2022" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "1518" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "1011" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "1521" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "1010" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "1524" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "1021" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$sum": "$quantity", "window": {"documents": [0, 0]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$sum": "$quantity", "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                              document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "1019" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "1526" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "1521" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "1518" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "1011" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "1016" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "1524" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "1521" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "1010" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "1009" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "1521" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "1524" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "1021" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$sum": "$quantity", "window": {"documents": [-10, 10]}}}}}]}');
                                                                                                              document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$sum": "$quantity", "window": {"documents": ["current", 1]}}}}}]}');
                                                                                                              document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "1019" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "1011" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "1017" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "1011" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "1016" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "1019" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "1010" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "1009" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "1015" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "1021" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$sum": "$quantity", "window": {"documents": ["unbounded", 1]}}}}}]}');
                                                                                                              document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "1019" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "1526" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "2036" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "1016" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "1524" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "1009" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "1521" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$sum": "$quantity", "window": {"documents": ["unbounded", -1]}}}}}]}');
                                                                                                              document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "0" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "1019" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "1526" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "2036" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "0" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "1016" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "1524" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "0" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "1009" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "1521" } }
(13 rows)

---------------------------------------------------------------------
-- Document window with sort
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"totalQuantity": { "$sum": "$quantity"}}} }]}');
                                                                                                              document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"totalQuantity": { "$sum": "$quantity", "window": {"documents": ["unbounded", "current"]}}}} }]}');
                                                                                                              document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "1005" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "1512" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "2022" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "2537" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "1007" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "1515" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "2026" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "1009" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "1518" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "2030" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"date": -1}, "output": {"totalQuantity": { "$sum": "$quantity", "window": {"documents": [-1, 1]}}}} }]}');
                                                                                                              document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "1017" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "1521" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "1526" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "1520" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "1016" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "1019" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "1524" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "1515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "1007" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "1021" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "1527" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "1518" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "1009" } }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"totalInGroup": { "$sum": 1, "window": {"range": [-3, 3]}}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "2" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"totalInGroup": { "$sum": 1, "window": {"range": ["unbounded", "current"]}}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "4" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"totalInGroup": { "$sum": 1, "window": {"range": ["current", "unbounded"]}}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "1" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$sum": 1, "window": {"range": [-5, 5], "unit": "second"}}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "1" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$sum": 1, "window": {"range": [-5, 5], "unit": "minute"}}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "1" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$sum": 1, "window": {"range": [-5, 5], "unit": "day"}}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "4" } }
(13 rows)

-- current in range doesn't mean current row its always the first peer which has same sort by value. This differs from MongoDB
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$sum": 1, "window": {"range": ["current", "current"], "unit": "day"}}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "1" } }
(13 rows)

---------------------------------------------------------------------
-- $count accumulator tests
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "{}", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalCount": { "$count": {}}}}}]}');
 document 
---------------------------------------------------------------------
(0 rows)

---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalCount": { "$count": {}}}}}]}');
                                                                                                           document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalCount" : { "$numberInt" : "4" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalCount": { "$count": {}, "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                           document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalCount" : { "$numberInt" : "4" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalCount": { "$count": {}, "window": {"documents": ["unbounded", "current"]}}}}}]}');
                                                                                                           document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalCount" : { "$numberInt" : "4" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalCount": { "$count": {}, "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                           document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalCount" : { "$numberInt" : "1" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalCount": { "$count": {}, "window": {"documents": ["current", "unbounded"]}}}}}]}');
                                                                                                           document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalCount" : { "$numberInt" : "1" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalCount": { "$count": {}, "window": {"documents": [0, 0]}}}}}]}');
                                                                                                           document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalCount" : { "$numberInt" : "1" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalCount": { "$count": {}, "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                           document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalCount" : { "$numberInt" : "2" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalCount": { "$count": {}, "window": {"documents": [-10, 10]}}}}}]}');
                                                                                                           document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalCount" : { "$numberInt" : "4" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalCount": { "$count": {}, "window": {"documents": ["current", 1]}}}}}]}');
                                                                                                           document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalCount" : { "$numberInt" : "1" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalCount": { "$count": {}, "window": {"documents": ["unbounded", 1]}}}}}]}');
                                                                                                           document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalCount" : { "$numberInt" : "4" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalCount": { "$count": {}, "window": {"documents": ["unbounded", -1]}}}}}]}');
                                                                                                           document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "0" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalCount" : { "$numberInt" : "0" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalCount" : { "$numberInt" : "0" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalCount" : { "$numberInt" : "3" } }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"countInGroup": { "$count": {}, "window": {"range": [-3, 3]}}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "countInGroup" : { "$numberInt" : "2" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"countInGroup": { "$count": {}, "window": {"range": ["unbounded", "current"]}}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "countInGroup" : { "$numberInt" : "4" } }
(13 rows)

    SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"countInGroup": { "$count": {}, "window": {"range": ["current", "unbounded"]}}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "countInGroup" : { "$numberInt" : "1" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"countInGroup": { "$count": {}, "window": {"range": [-5, 5], "unit": "second"}}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "countInGroup" : { "$numberInt" : "1" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"countInGroup": { "$count": {}, "window": {"range": [-5, 5], "unit": "minute"}}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "countInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "countInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "countInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "countInGroup" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "countInGroup" : { "$numberInt" : "1" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"countInGroup": { "$count": {}, "window": {"range": [-5, 5], "unit": "day"}}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "countInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "countInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "countInGroup" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "countInGroup" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "countInGroup" : { "$numberInt" : "4" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"countInGroup": { "$count": {}, "window": {"range": ["current", "current"], "unit": "day"}}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "countInGroup" : { "$numberInt" : "1" } }
(13 rows)

-- Should error since $count take no argument
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"countInGroup": { "$count": 1}}}}]}');
ERROR:  $count only accepts an empty object as input
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"countInGroup": { "$count": "str"}}}}]}');
ERROR:  $count only accepts an empty object as input
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"countInGroup": { "$count": true }}}}]}');
ERROR:  $count only accepts an empty object as input
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"countInGroup": { "$count": {"fst": 1} }}}}]}');
ERROR:  $count only accepts an empty object as input
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"countInGroup": { "$count": [1, "$a"] }}}}]}');
ERROR:  $count only accepts an empty object as input
-- test on shard collection
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalCount": { "$count": {}}}}}]}');
                                                                                                          document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "1" } }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalCount": { "$count": {}, "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                          document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "1" } }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalCount": { "$count": {}, "window": {"documents": ["unbounded", "current"]}}}}}]}');
                                                                                                          document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "1" } }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalCount": { "$count": {}, "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                          document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "1" } }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"countInGroup": { "$count": {}, "window": {"range": [-5, 5], "unit": "minute"}}}}}]}');
                                                                                                           document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "countInGroup" : { "$numberInt" : "1" } }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"countInGroup": { "$count": {}, "window": {"range": [-5, 5], "unit": "day"}}}}}]}');
                                                                                                           document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "countInGroup" : { "$numberInt" : "1" } }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"countInGroup": { "$count": {}, "window": {"range": ["current", "current"], "unit": "day"}}}}}]}');
                                                                                                           document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "countInGroup" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "countInGroup" : { "$numberInt" : "1" } }
(3 rows)

-- test on shard collection with range window
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": {"sortBy": {"quantity": 1}, "output": {"totalCount": { "$count": {}, "window": {"range": [-0.5, 0]}}}}}]}');
                                                                                                          document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "1" } }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": {"sortBy": {"quantity": 1}, "output": {"totalCount": { "$count": {}, "window": {"range": [-1, 0]}}}}}]}');
                                                                                                          document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "2" } }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_sharded", "pipeline":  [{"$setWindowFields": {"sortBy": {"quantity": 1}, "output": {"totalCount": { "$count": {}, "window": {"range": [-1, 1]}}}}}]}');
                                                                                                          document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalCount" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalCount" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalCount" : { "$numberInt" : "2" } }
(3 rows)

---------------------------------------------------------------------
-- $avg accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$avg": "$quantity", "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                                       document                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberDouble" : "509.5" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberDouble" : "508.66666666666668561" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberDouble" : "507.0" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberDouble" : "506.0" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberDouble" : "505.5" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberDouble" : "508.0" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberDouble" : "508.0" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberDouble" : "507.0" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberDouble" : "505.0" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberDouble" : "504.5" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberDouble" : "507.0" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberDouble" : "508.0" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberDouble" : "510.5" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$avg": "$quantity", "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                                document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberDouble" : "515.0" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberDouble" : "504.0" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberDouble" : "507.0" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberDouble" : "510.0" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberDouble" : "501.0" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberDouble" : "505.0" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberDouble" : "511.0" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberDouble" : "508.0" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberDouble" : "502.0" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberDouble" : "506.0" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberDouble" : "503.0" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberDouble" : "512.0" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberDouble" : "509.0" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$avg": "$quantity", "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                                        document                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberDouble" : "506.5" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberDouble" : "506.5" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberDouble" : "506.5" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberDouble" : "506.5" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberDouble" : "507.5" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberDouble" : "507.5" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberDouble" : "507.5" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberDouble" : "507.5" } }
(13 rows)

---------------------------------------------------------------------
-- Document window with sort
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"totalQuantity": { "$avg": "$quantity"}}} }]}');
                                                                                                                        document                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberDouble" : "506.5" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberDouble" : "506.5" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberDouble" : "506.5" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberDouble" : "506.5" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberDouble" : "507.5" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberDouble" : "507.5" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberDouble" : "507.5" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberDouble" : "507.5" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"totalQuantity": { "$avg": "$quantity", "window": {"documents": ["unbounded", "current"]}}}} }]}');
                                                                                                                        document                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberDouble" : "501.0" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberDouble" : "502.5" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberDouble" : "504.0" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberDouble" : "505.5" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberDouble" : "502.0" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberDouble" : "503.5" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberDouble" : "505.0" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberDouble" : "506.5" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberDouble" : "503.0" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberDouble" : "504.5" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberDouble" : "506.0" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberDouble" : "507.5" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"date": -1}, "output": {"totalQuantity": { "$avg": "$quantity", "window": {"documents": [-1, 1]}}}} }]}');
                                                                                                                        document                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberDouble" : "508.5" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberDouble" : "507.0" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberDouble" : "508.66666666666668561" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberDouble" : "506.66666666666668561" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberDouble" : "508.0" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberDouble" : "509.5" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberDouble" : "508.0" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberDouble" : "505.0" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberDouble" : "503.5" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberDouble" : "510.5" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberDouble" : "509.0" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberDouble" : "506.0" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberDouble" : "504.5" } }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"totalInGroup": { "$avg": "$quantity", "window": {"range": [-3, 3]}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberDouble" : "502.5" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberDouble" : "504.0" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberDouble" : "507.0" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberDouble" : "508.5" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberDouble" : "515.0" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberDouble" : "503.5" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberDouble" : "505.0" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberDouble" : "508.0" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberDouble" : "509.5" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberDouble" : "504.5" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberDouble" : "506.0" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberDouble" : "509.0" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberDouble" : "510.5" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$avg": "$quantity", "window": {"range": [-5, 5], "unit": "minute"}}}}}]}');
                                                                                                                       document                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberDouble" : "507.39999999999997726" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberDouble" : "506.5" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberDouble" : "506.5" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberDouble" : "506.5" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberDouble" : "506.5" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberDouble" : "506.0" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberDouble" : "506.0" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberDouble" : "506.0" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberDouble" : "512.0" } }
(13 rows)

---------------------------------------------------------------------
-- $push accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$push": "$quantity", "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                                                         document                                                                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$push": "$quantity", "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : [ { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : [ { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : [ { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : [ { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : [ { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : [ { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : [ { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : [ { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : [ { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$push": "$quantity", "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                                                                                   document                                                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$push": "$quantity", "window": {"documents": ["unbounded", -1]}}}}}]}');
                                                                                                                                                      document                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [  ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : [  ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : [ { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : [  ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : [ { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$push": "$$varRef", "window": {"documents": ["unbounded", "unbounded"]}}}}}], "let": {"varRef": "Hello"}}');
                                                                                                                         document                                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ "Hello", "Hello", "Hello", "Hello", "Hello" ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : [ "Hello", "Hello", "Hello", "Hello", "Hello" ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : [ "Hello", "Hello", "Hello", "Hello", "Hello" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : [ "Hello", "Hello", "Hello", "Hello", "Hello" ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ "Hello", "Hello", "Hello", "Hello", "Hello" ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : [ "Hello", "Hello", "Hello", "Hello" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : [ "Hello", "Hello", "Hello", "Hello" ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : [ "Hello", "Hello", "Hello", "Hello" ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : [ "Hello", "Hello", "Hello", "Hello" ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : [ "Hello", "Hello", "Hello", "Hello" ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : [ "Hello", "Hello", "Hello", "Hello" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : [ "Hello", "Hello", "Hello", "Hello" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : [ "Hello", "Hello", "Hello", "Hello" ] }
(13 rows)

---------------------------------------------------------------------
-- Document window with sort
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"totalQuantity": { "$push": "$quantity"}}} }]}');
                                                                                                                                                                   document                                                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"totalQuantity": { "$push": "$quantity", "window": {"documents": ["unbounded", "current"]}}}} }]}');
                                                                                                                                                                   document                                                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"date": -1}, "output": {"totalQuantity": { "$push": "$quantity", "window": {"documents": [-1, 1]}}}} }]}');
                                                                                                                                         document                                                                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "515" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$match": {"quantity": {"$type": "number"}}}, {"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"totalInGroup": { "$push": "$quantity", "window": {"range": [-3, 3]}}}}}]}');
                                                                                                                                        document                                                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : [ { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : [ { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : [ { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : [ { "$numberInt" : "506" }, { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : [ { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$push": "$quantity", "window": {"range": [-5, 5], "unit": "minute"}}}}}]}');
                                                                                                                                                                   document                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : [ { "$numberInt" : "501" }, { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : [ { "$numberInt" : "501" }, { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : [ { "$numberInt" : "501" }, { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : [ { "$numberInt" : "501" }, { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : [ { "$numberInt" : "501" }, { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : [ { "$numberInt" : "512" } ] }
(13 rows)

---------------------------------------------------------------------
-- Missing Field Test
---------------------------------------------------------------------
SELECT documentdb_api.insert_one('db','setWindowFields_push_missingFields','{ "_id": 1, "a": "abc", "quantity": 30, "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_push_missingFields','{ "_id": 2, "a": "abc", "quantity": [], "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_push_missingFields','{ "_id": 3, "a": "abc", "quantity": {}, "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_push_missingFields','{ "_id": 4, "a": "abc", "quantity": null, "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_push_missingFields','{ "_id": 5, "a": "abc", "quantity": { "$undefined": true }, "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_push_missingFields','{ "_id": 6, "a": "abc", "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Should push every quantity except a NULL from _id: 6 document where quantity is missing
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_push_missingFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalQuantity": { "$push": "$quantity", "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                                  document                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "quantity" : { "$numberInt" : "30" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "30" }, [  ], {  }, null, { "$undefined" : true } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "abc", "quantity" : [  ], "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "30" }, [  ], {  }, null, { "$undefined" : true } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "abc", "quantity" : {  }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "30" }, [  ], {  }, null, { "$undefined" : true } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "quantity" : null, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "30" }, [  ], {  }, null, { "$undefined" : true } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "abc", "quantity" : { "$undefined" : true }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "30" }, [  ], {  }, null, { "$undefined" : true } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "abc", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "$numberInt" : "30" }, [  ], {  }, null, { "$undefined" : true } ] }
(6 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_push_missingFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalQuantity": { "$push": { "qty": "$quantity" }, "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                                                                   document                                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "quantity" : { "$numberInt" : "30" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "qty" : { "$numberInt" : "30" } }, { "qty" : [  ] }, { "qty" : {  } }, { "qty" : null }, { "qty" : { "$undefined" : true } }, {  } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "abc", "quantity" : [  ], "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "qty" : { "$numberInt" : "30" } }, { "qty" : [  ] }, { "qty" : {  } }, { "qty" : null }, { "qty" : { "$undefined" : true } }, {  } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "abc", "quantity" : {  }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "qty" : { "$numberInt" : "30" } }, { "qty" : [  ] }, { "qty" : {  } }, { "qty" : null }, { "qty" : { "$undefined" : true } }, {  } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "quantity" : null, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "qty" : { "$numberInt" : "30" } }, { "qty" : [  ] }, { "qty" : {  } }, { "qty" : null }, { "qty" : { "$undefined" : true } }, {  } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "abc", "quantity" : { "$undefined" : true }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "qty" : { "$numberInt" : "30" } }, { "qty" : [  ] }, { "qty" : {  } }, { "qty" : null }, { "qty" : { "$undefined" : true } }, {  } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "abc", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ { "qty" : { "$numberInt" : "30" } }, { "qty" : [  ] }, { "qty" : {  } }, { "qty" : null }, { "qty" : { "$undefined" : true } }, {  } ] }
(6 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_push_missingFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalQuantity": { "$push": [ "$quantity" ], "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                                        document                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "quantity" : { "$numberInt" : "30" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ [ { "$numberInt" : "30" } ], [ [  ] ], [ {  } ], [ null ], [ null ], [ null ] ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "abc", "quantity" : [  ], "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ [ { "$numberInt" : "30" } ], [ [  ] ], [ {  } ], [ null ], [ null ], [ null ] ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "abc", "quantity" : {  }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ [ { "$numberInt" : "30" } ], [ [  ] ], [ {  } ], [ null ], [ null ], [ null ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "quantity" : null, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ [ { "$numberInt" : "30" } ], [ [  ] ], [ {  } ], [ null ], [ null ], [ null ] ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "abc", "quantity" : { "$undefined" : true }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ [ { "$numberInt" : "30" } ], [ [  ] ], [ {  } ], [ null ], [ null ], [ null ] ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "abc", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [ [ { "$numberInt" : "30" } ], [ [  ] ], [ {  } ], [ null ], [ null ], [ null ] ] }
(6 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_push_missingFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalQuantity": { "$push": "$non_existing" } } } } ]}');
                                                                                 document                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "quantity" : { "$numberInt" : "30" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [  ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "abc", "quantity" : [  ], "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [  ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "abc", "quantity" : {  }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [  ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "quantity" : null, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [  ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "abc", "quantity" : { "$undefined" : true }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [  ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "abc", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : [  ] }
(6 rows)

---------------------------------------------------------------------
-- $addToSet accumulator tests
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"addedSet": { "$addToSet": 1}}}}]}');
                                                                                                            document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "addedSet" : [ { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "addedSet" : [ { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "addedSet" : [ { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "addedSet" : [ { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "addedSet" : [ { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "addedSet" : [ { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "addedSet" : [ { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "addedSet" : [ { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "addedSet" : [ { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "addedSet" : [ { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "addedSet" : [ { "$numberInt" : "1" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"addedSet": { "$addToSet": [1]}}}}]}');
                                                                                                              document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ [ { "$numberInt" : "1" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "addedSet" : [ [ { "$numberInt" : "1" } ] ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "addedSet" : [ [ { "$numberInt" : "1" } ] ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "addedSet" : [ [ { "$numberInt" : "1" } ] ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ [ { "$numberInt" : "1" } ] ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "addedSet" : [ [ { "$numberInt" : "1" } ] ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "addedSet" : [ [ { "$numberInt" : "1" } ] ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "addedSet" : [ [ { "$numberInt" : "1" } ] ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "addedSet" : [ [ { "$numberInt" : "1" } ] ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "addedSet" : [ [ { "$numberInt" : "1" } ] ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "addedSet" : [ [ { "$numberInt" : "1" } ] ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "addedSet" : [ [ { "$numberInt" : "1" } ] ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "addedSet" : [ [ { "$numberInt" : "1" } ] ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "{}", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"addedSet": { "$addToSet": []}}}}]}');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "{}", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"addedSet": { "$addToSet": {}}}}}]}');
 document 
---------------------------------------------------------------------
(0 rows)

---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"addedSet": { "$addToSet": "$quantity", "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                                                       document                                                                                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "addedSet" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "addedSet" : [ { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "addedSet" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "addedSet" : [ { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "addedSet" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"addedSet": { "$addToSet": "$quantity", "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "addedSet" : [ { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "addedSet" : [ { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "addedSet" : [ { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "addedSet" : [ { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "addedSet" : [ { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "addedSet" : [ { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "addedSet" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "addedSet" : [ { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "addedSet" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "addedSet" : [ { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "addedSet" : [ { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"addedSet": { "$addToSet": "$quantity", "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                                                                                 document                                                                                                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"addedSet": { "$addToSet": "$quantity", "window": {"documents": ["unbounded", -1]}}}}}]}');
                                                                                                                                                   document                                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [  ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "addedSet" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "addedSet" : [  ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "addedSet" : [ { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "addedSet" : [  ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "addedSet" : [ { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "506" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"addedSet": { "$addToSet": ["$$varRef1", "$$varRef2"], "window": {"documents": ["unbounded", "unbounded"]}}}}}], "let": {"varRef1": "Hello", "varRef2": "World"}}');
                                                                                                           document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ [ "Hello", "World" ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "addedSet" : [ [ "Hello", "World" ] ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "addedSet" : [ [ "Hello", "World" ] ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "addedSet" : [ [ "Hello", "World" ] ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ [ "Hello", "World" ] ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "addedSet" : [ [ "Hello", "World" ] ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "addedSet" : [ [ "Hello", "World" ] ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "addedSet" : [ [ "Hello", "World" ] ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "addedSet" : [ [ "Hello", "World" ] ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "addedSet" : [ [ "Hello", "World" ] ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "addedSet" : [ [ "Hello", "World" ] ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "addedSet" : [ [ "Hello", "World" ] ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "addedSet" : [ [ "Hello", "World" ] ] }
(13 rows)

---------------------------------------------------------------------
-- Document window with sort
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"addedSet": { "$addToSet": "$quantity"}}} }]}');
                                                                                                                                                                 document                                                                                                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"addedSet": { "$addToSet": "$quantity", "window": {"documents": ["unbounded", "current"]}}}} }]}');
                                                                                                                                                                 document                                                                                                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "addedSet" : [ { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "addedSet" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "addedSet" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "addedSet" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "addedSet" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"date": -1}, "output": {"addedSet": { "$addToSet": "$quantity", "window": {"documents": [-1, 1]}}}} }]}');
                                                                                                                                       document                                                                                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "addedSet" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "addedSet" : [ { "$numberInt" : "504" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "$numberInt" : "515" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "addedSet" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "addedSet" : [ { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "addedSet" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "addedSet" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "addedSet" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$match": {"quantity": {"$type": "number"}}}, {"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"totalInGroup": { "$addToSet": "$quantity", "window": {"range": [-3, 3]}}}}}]}');
                                                                                                                                        document                                                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : [ { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : [ { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : [ { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : [ { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : [ { "$numberInt" : "503" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$addToSet": "$quantity", "window": {"range": [-5, 5], "unit": "minute"}}}}}]}');
                                                                                                                                                                   document                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : [ { "$numberInt" : "503" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : [ { "$numberInt" : "503" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : [ { "$numberInt" : "503" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : [ { "$numberInt" : "512" } ] }
(13 rows)

---------------------------------------------------------------------
-- Missing Field Test
---------------------------------------------------------------------
SELECT documentdb_api.insert_one('db','setWindowFields_addToSet_missingFields','{ "_id": 1, "a": "abc", "quantity": 30, "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_addToSet_missingFields','{ "_id": 2, "a": "abc", "quantity": [], "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_addToSet_missingFields','{ "_id": 3, "a": "abc", "quantity": {}, "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_addToSet_missingFields','{ "_id": 4, "a": "abc", "quantity": null, "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_addToSet_missingFields','{ "_id": 5, "a": "abc", "quantity": { "$undefined": true }, "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','setWindowFields_addToSet_missingFields','{ "_id": 6, "a": "abc", "date": { "$date": { "$numberLong": "1718841600000" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Should addToSet every quantity except a NULL from _id: 6 document where quantity is missing
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_addToSet_missingFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"addedSet": { "$addToSet": "$quantity", "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                   document                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "quantity" : { "$numberInt" : "30" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ null, [  ], {  }, { "$numberInt" : "30" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "abc", "quantity" : [  ], "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ null, [  ], {  }, { "$numberInt" : "30" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "abc", "quantity" : {  }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ null, [  ], {  }, { "$numberInt" : "30" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "quantity" : null, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ null, [  ], {  }, { "$numberInt" : "30" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "abc", "quantity" : { "$undefined" : true }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ null, [  ], {  }, { "$numberInt" : "30" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "abc", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ null, [  ], {  }, { "$numberInt" : "30" } ] }
(6 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_addToSet_missingFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"addedSet": { "$addToSet": { "qty": "$quantity" }, "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                                                              document                                                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "quantity" : { "$numberInt" : "30" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "qty" : null }, { "qty" : {  } }, { "qty" : [  ] }, { "qty" : { "$undefined" : true } }, { "qty" : { "$numberInt" : "30" } } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "abc", "quantity" : [  ], "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "qty" : null }, { "qty" : {  } }, { "qty" : [  ] }, { "qty" : { "$undefined" : true } }, { "qty" : { "$numberInt" : "30" } } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "abc", "quantity" : {  }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "qty" : null }, { "qty" : {  } }, { "qty" : [  ] }, { "qty" : { "$undefined" : true } }, { "qty" : { "$numberInt" : "30" } } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "quantity" : null, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "qty" : null }, { "qty" : {  } }, { "qty" : [  ] }, { "qty" : { "$undefined" : true } }, { "qty" : { "$numberInt" : "30" } } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "abc", "quantity" : { "$undefined" : true }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "qty" : null }, { "qty" : {  } }, { "qty" : [  ] }, { "qty" : { "$undefined" : true } }, { "qty" : { "$numberInt" : "30" } } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "abc", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ { "qty" : null }, { "qty" : {  } }, { "qty" : [  ] }, { "qty" : { "$undefined" : true } }, { "qty" : { "$numberInt" : "30" } } ] }
(6 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_addToSet_missingFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"addedSet": { "$addToSet": [ "$quantity" ], "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                           document                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "quantity" : { "$numberInt" : "30" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ [ { "$numberInt" : "30" } ], [ {  } ], [ [  ] ], [ null ] ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "abc", "quantity" : [  ], "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ [ { "$numberInt" : "30" } ], [ {  } ], [ [  ] ], [ null ] ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "abc", "quantity" : {  }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ [ { "$numberInt" : "30" } ], [ {  } ], [ [  ] ], [ null ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "quantity" : null, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ [ { "$numberInt" : "30" } ], [ {  } ], [ [  ] ], [ null ] ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "abc", "quantity" : { "$undefined" : true }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ [ { "$numberInt" : "30" } ], [ {  } ], [ [  ] ], [ null ] ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "abc", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ [ { "$numberInt" : "30" } ], [ {  } ], [ [  ] ], [ null ] ] }
(6 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_addToSet_missingFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"addedSet": { "$addToSet": "$non_existing" } } } } ]}');
                                                                                 document                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "quantity" : { "$numberInt" : "30" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ null ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "abc", "quantity" : [  ], "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ null ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "abc", "quantity" : {  }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ null ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "quantity" : null, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ null ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "abc", "quantity" : { "$undefined" : true }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ null ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "abc", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "addedSet" : [ null ] }
(6 rows)

---------------------------------------------------------------------
-- $covariancePop & $covarianceSamp accumulator tests
---------------------------------------------------------------------
-- empty collection
SELECT documentdb_api.insert_one('db','empty_covar_col',' { "_id": 0, "x": 1 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "empty_covar_col", "pipeline":  [{"$setWindowFields": {"output": {"covariancePop": { "$covariancePop": ["$x", "$y"]}}}}]}');
                                         document                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "covariancePop" : null }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "empty_covar_col", "pipeline":  [{"$setWindowFields": {"output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"]}}}}]}');
                                         document                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "covarianceSamp" : null }
(1 row)

-- collection with single document
SELECT documentdb_api.insert_one('db','single_col',' { "_id": 0, "x": 1, "y": 2 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "single_col", "pipeline":  [{"$setWindowFields": {"output": {"covariancePop": { "$covariancePop": ["$x", "$y"]}}}}]}');
                                                                   document                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "covariancePop" : { "$numberDouble" : "0.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "single_col", "pipeline":  [{"$setWindowFields": {"output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"]}}}}]}');
                                                        document                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "covarianceSamp" : null }
(1 row)

-- document with non-numeric values
SELECT documentdb_api.insert_one('db','non_numeric_col',' { "_id": 0, "x": "a", "y": "b" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','non_numeric_col',' { "_id": 1, "x": "c", "y": "d" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "non_numeric_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                     document                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : "a", "y" : "b", "covariancePop" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : "c", "y" : "d", "covariancePop" : null }
(2 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "non_numeric_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                     document                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : "a", "y" : "b", "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : "c", "y" : "d", "covarianceSamp" : null }
(2 rows)

-- document with mixed values
SELECT documentdb_api.insert_one('db','mixed_col',' { "_id": 0, "x": 1, "y": "a" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','mixed_col',' { "_id": 1, "x": 2, "y": 0 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','mixed_col',' { "_id": 2, "x": 3, "y": "b" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','mixed_col',' { "_id": 3, "x": 4, "y": 1 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "mixed_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                   document                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : "a", "covariancePop" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "0" }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : "b", "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "1" }, "covariancePop" : { "$numberDouble" : "0.5" } }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "mixed_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                    document                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : "a", "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "0" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : "b", "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "1" }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
(4 rows)

-- document with NAN values
SELECT documentdb_api.insert_one('db','nan_col',' { "_id": 0, "x": 1, "y": 2 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','nan_col',' { "_id": 1, "x": 2, "y": 3 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','nan_col',' { "_id": 2, "x": 3, "y": {"$numberDecimal": "NaN" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','nan_col',' { "_id": 3, "x": 4, "y": 4 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "nan_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberDecimal" : "NaN" }, "covariancePop" : { "$numberDecimal" : "NaN" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "4" }, "covariancePop" : { "$numberDecimal" : "NaN" } }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "nan_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                       document                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberDecimal" : "NaN" }, "covarianceSamp" : { "$numberDecimal" : "NaN" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "4" }, "covarianceSamp" : { "$numberDecimal" : "NaN" } }
(4 rows)

-- document with Infinity values
SELECT documentdb_api.insert_one('db','inf_col',' { "_id": 0, "type": "a", "x": 1, "y": 2 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_col',' { "_id": 1, "type": "a", "x": 2, "y": {"$numberDecimal": "Infinity" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_col',' { "_id": 2, "type": "a", "x": 3, "y": {"$numberDecimal": "-Infinity" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_col',' { "_id": 3, "type": "a", "x": 4, "y": 4 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_col',' { "_id": 5, "type": "b", "x": 1, "y": 2 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_col',' { "_id": 6, "type": "b", "x": 2, "y": 3 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_col',' { "_id": 7, "type": "b", "x": 3, "y": {"$numberDecimal": "-Infinity" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_col',' { "_id": 8, "type": "b", "x": 4, "y": {"$numberDecimal": "Infinity" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "inf_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                    document                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "type" : "a", "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "type" : "a", "x" : { "$numberInt" : "2" }, "y" : { "$numberDecimal" : "Infinity" }, "covariancePop" : { "$numberDecimal" : "Infinity" } }
 { "_id" : { "$numberInt" : "2" }, "type" : "a", "x" : { "$numberInt" : "3" }, "y" : { "$numberDecimal" : "-Infinity" }, "covariancePop" : { "$numberDecimal" : "NaN" } }
 { "_id" : { "$numberInt" : "3" }, "type" : "a", "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "4" }, "covariancePop" : { "$numberDecimal" : "NaN" } }
 { "_id" : { "$numberInt" : "5" }, "type" : "b", "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "6" }, "type" : "b", "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "7" }, "type" : "b", "x" : { "$numberInt" : "3" }, "y" : { "$numberDecimal" : "-Infinity" }, "covariancePop" : { "$numberDecimal" : "-Infinity" } }
 { "_id" : { "$numberInt" : "8" }, "type" : "b", "x" : { "$numberInt" : "4" }, "y" : { "$numberDecimal" : "Infinity" }, "covariancePop" : { "$numberDecimal" : "NaN" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "inf_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                    document                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "type" : "a", "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "type" : "a", "x" : { "$numberInt" : "2" }, "y" : { "$numberDecimal" : "Infinity" }, "covarianceSamp" : { "$numberDecimal" : "Infinity" } }
 { "_id" : { "$numberInt" : "2" }, "type" : "a", "x" : { "$numberInt" : "3" }, "y" : { "$numberDecimal" : "-Infinity" }, "covarianceSamp" : { "$numberDecimal" : "NaN" } }
 { "_id" : { "$numberInt" : "3" }, "type" : "a", "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "4" }, "covarianceSamp" : { "$numberDecimal" : "NaN" } }
 { "_id" : { "$numberInt" : "5" }, "type" : "b", "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "6" }, "type" : "b", "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "7" }, "type" : "b", "x" : { "$numberInt" : "3" }, "y" : { "$numberDecimal" : "-Infinity" }, "covarianceSamp" : { "$numberDecimal" : "-Infinity" } }
 { "_id" : { "$numberInt" : "8" }, "type" : "b", "x" : { "$numberInt" : "4" }, "y" : { "$numberDecimal" : "Infinity" }, "covarianceSamp" : { "$numberDecimal" : "NaN" } }
(8 rows)

-- document with Decimal128 values
SELECT documentdb_api.insert_one('db','decimal_col',' { "_id": 0, "x": 1, "y": 2 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','decimal_col',' { "_id": 1, "x": 2, "y": 3 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','decimal_col',' { "_id": 2, "x": 3, "y": {"$numberDecimal": "4.0" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','decimal_col',' { "_id": 3, "x": 4, "y": 5 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "decimal_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                       document                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberDecimal" : "4.0" }, "covariancePop" : { "$numberDecimal" : "0.6666666666666666666666666666666667" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "covariancePop" : { "$numberDecimal" : "1.2500000000000000000000000000" } }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "decimal_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                     document                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberDecimal" : "4.0" }, "covarianceSamp" : { "$numberDecimal" : "1.0000000000000000000000000000" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "covarianceSamp" : { "$numberDecimal" : "1.666666666666666666666666666666667" } }
(4 rows)

-- number overflow
SELECT documentdb_api.insert_one('db','overflow_col',' { "_id": 0, "x": 1, "y": {"$numberDecimal": "100000004"} }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','overflow_col',' { "_id": 1, "x": 2, "y": {"$numberDecimal": "10000000007"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','overflow_col',' { "_id": 2, "x": 3, "y": {"$numberDecimal": "1000000000000013"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','overflow_col',' { "_id": 3, "x": 4, "y": {"$numberDecimal": "1000000000000000000"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "overflow_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                              document                                                                                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberDecimal" : "100000004" }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberDecimal" : "10000000007" }, "covariancePop" : { "$numberDecimal" : "2475000000.750000000000000000000000" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberDecimal" : "1000000000000013" }, "covariancePop" : { "$numberDecimal" : "333333300000003.0000000000000000000" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberDecimal" : "1000000000000000000" }, "covariancePop" : { "$numberDecimal" : "375124998712499999.250000000000000" } }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "overflow_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                               document                                                                                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberDecimal" : "100000004" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberDecimal" : "10000000007" }, "covarianceSamp" : { "$numberDecimal" : "4950000001.500000000000000000000000" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberDecimal" : "1000000000000013" }, "covarianceSamp" : { "$numberDecimal" : "499999950000004.5000000000000000000" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberDecimal" : "1000000000000000000" }, "covarianceSamp" : { "$numberDecimal" : "500166664949999999.000000000000000" } }
(4 rows)

-- long values return double
SELECT documentdb_api.insert_one('db','long_col',' { "_id": 0, "x": 1, "y": {"$numberLong": "10000000004"} }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','long_col',' { "_id": 1, "x": 2, "y": {"$numberLong": "10000000007"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','long_col',' { "_id": 2, "x": 3, "y": {"$numberLong": "10000000013"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','long_col',' { "_id": 3, "x": 4, "y": {"$numberLong": "10000000016"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                         document                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covariancePop" : { "$numberDouble" : "0.75" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covariancePop" : { "$numberDouble" : "3.0" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covariancePop" : { "$numberDouble" : "5.25" } }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                         document                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covarianceSamp" : { "$numberDouble" : "1.5" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covarianceSamp" : { "$numberDouble" : "4.5" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covarianceSamp" : { "$numberDouble" : "7.0" } }
(4 rows)

-- evaluate data in expression
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", {"$multiply": ["$x", "$y"]}], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                  document                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covariancePop" : { "$numberDouble" : "2500000002.5" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covariancePop" : { "$numberDouble" : "6666666678.3333330154" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covariancePop" : { "$numberDouble" : "12500000025.625" } }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", {"$multiply": ["$x", "$y"]}], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                  document                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covarianceSamp" : { "$numberDouble" : "5000000005.0" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covarianceSamp" : { "$numberDouble" : "10000000017.5" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covarianceSamp" : { "$numberDouble" : "16666666700.833333969" } }
(4 rows)

-- negative cases
-- incorrect arguments won't throw error
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                             document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covariancePop" : null }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y", "$z"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                             document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covariancePop" : null }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": [5], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                             document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covariancePop" : null }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["a", {}], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                             document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covariancePop" : null }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": 3, "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                             document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covariancePop" : null }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": {"a": "$x"}, "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                             document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covariancePop" : null }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                              document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covarianceSamp" : null }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y", "$z"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                              document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covarianceSamp" : null }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": [5], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                              document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covarianceSamp" : null }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["a", {}], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                              document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covarianceSamp" : null }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": 3, "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                              document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covarianceSamp" : null }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": {"a": "$x"}, "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                              document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberLong" : "10000000004" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberLong" : "10000000007" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberLong" : "10000000013" }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberLong" : "10000000016" }, "covarianceSamp" : null }
(4 rows)

SELECT documentdb_api.insert_one('db','window_col',' { "_id": 0, "x": 1, "y": 2, "type": "a", "date": { "$date": { "$numberLong": "1718841600000" } } }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_col',' { "_id": 1, "x": 2, "y": 3, "type": "a", "date": { "$date": { "$numberLong": "1718841605000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_col',' { "_id": 2, "x": 3, "y": 4, "type": "a", "date": { "$date": { "$numberLong": "1718841610000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_col',' { "_id": 3, "x": 4, "y": 5, "type": "a", "date": { "$date": { "$numberLong": "1718841615000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_col',' { "_id": 4, "x": 5, "y": 6, "type": "a", "date": { "$date": { "$numberLong": "1718841620000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_col',' { "_id": 5, "x": 6, "y": 7, "type": "a", "date": { "$date": { "$numberLong": "1718841630000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_col',' { "_id": 6, "x": 7, "y": 8, "type": "b", "date": { "$date": { "$numberLong": "1718841640000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_col',' { "_id": 7, "x": 8, "y": 9, "type": "b", "date": { "$date": { "$numberLong": "1718841680000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_col',' { "_id": 8, "x": 9, "y": 10, "type": "b", "date": { "$date": { "$numberLong": "1718841700000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_col',' { "_id": 9, "x": 10, "y": 11, "type": "b", "date": { "$date": { "$numberLong": "1718841800000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_col',' { "_id": 10, "x": 11, "y": 12, "type": "b", "date": { "$date": { "$numberLong": "1718841900000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_col',' { "_id": 11, "x": 12, "y": 13, "type": "b", "date": { "$date": { "$numberLong": "1718842600000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- without window
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"]}}}}]}');
                                                                                                                   document                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"]}}}}]}');
                                                                                                          document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
(12 rows)

-- document window
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                                   document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                          document                                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                                   document                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                          document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                               document                                                                                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covarianceSamp" : null }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                          document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
(12 rows)

-- range window
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": {"range": [-2, 1]}}}}}]}');
                                                                                                                   document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": {"range": [-3, 3], "unit": "minute"}}}}}]}');
                                                                                                                 document                                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covariancePop" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": {"range": [-2, 1]}}}}}]}');
                                                                                                                   document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": {"range": [-3, 3], "unit": "minute"}}}}}]}');
                                                                                                                  document                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covarianceSamp" : { "$numberDouble" : "2.5" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covarianceSamp" : null }
(12 rows)

-- unsharded collection
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": { "documents": ["unbounded", -1]}}}}}]}');
                                                                                                                   document                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covariancePop" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covariancePop" : { "$numberDouble" : "2.0" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": { "documents": ["unbounded", -1]}}}}}]}');
                                                                                                                   document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covarianceSamp" : { "$numberDouble" : "2.5" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covarianceSamp" : { "$numberDouble" : "2.5" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                                                   document                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covariancePop" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covariancePop" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": {"documents": ["unbounded", "current"]}}}}}]}');
                                                                                                                   document                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covarianceSamp" : { "$numberDouble" : "2.5" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covarianceSamp" : { "$numberDouble" : "2.5" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": { "$cond": [{ "$eq": [{ "$mod": ["$_id", 2] }, 0] }, "even", "odd"] }, "sortBy": { "date": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                                                   document                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covariancePop" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covariancePop" : { "$numberDouble" : "2.6666666666666665186" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covariancePop" : { "$numberDouble" : "5.0" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covariancePop" : { "$numberDouble" : "8.0" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covariancePop" : { "$numberDouble" : "11.666666666666666075" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covariancePop" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covariancePop" : { "$numberDouble" : "2.6666666666666665186" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covariancePop" : { "$numberDouble" : "5.0" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covariancePop" : { "$numberDouble" : "8.0" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covariancePop" : { "$numberDouble" : "11.666666666666666075" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": { "$cond": [{ "$eq": [{ "$mod": ["$_id", 2] }, 0] }, "even", "odd"] }, "sortBy": {"date": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": {"documents": ["unbounded", "current"]}}}}}]}');
                                                                                                                  document                                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covarianceSamp" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covarianceSamp" : { "$numberDouble" : "4.0" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covarianceSamp" : { "$numberDouble" : "6.6666666666666669627" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covarianceSamp" : { "$numberDouble" : "10.0" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covarianceSamp" : { "$numberDouble" : "14.0" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covarianceSamp" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covarianceSamp" : { "$numberDouble" : "4.0" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covarianceSamp" : { "$numberDouble" : "6.6666666666666669627" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covarianceSamp" : { "$numberDouble" : "10.0" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covarianceSamp" : { "$numberDouble" : "14.0" } }
(12 rows)

-- shard collection
SELECT documentdb_api.shard_collection('db', 'window_col', '{ "type": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": { "documents": ["unbounded", -1]}}}}}]}');
                                                                                                                   document                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covariancePop" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covariancePop" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covariancePop" : { "$numberDouble" : "2.0" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": { "documents": ["unbounded", -1]}}}}}]}');
                                                                                                                   document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covarianceSamp" : { "$numberDouble" : "2.5" } }
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covarianceSamp" : { "$numberDouble" : "2.5" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                                                   document                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covariancePop" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covariancePop" : { "$numberDouble" : "0.25" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covariancePop" : { "$numberDouble" : "0.66666666666666662966" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covariancePop" : { "$numberDouble" : "1.25" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covariancePop" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covariancePop" : { "$numberDouble" : "2.9166666666666665186" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"_id": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": {"documents": ["unbounded", "current"]}}}}}]}');
                                                                                                                   document                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covarianceSamp" : { "$numberDouble" : "2.5" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covarianceSamp" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covarianceSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covarianceSamp" : { "$numberDouble" : "1.6666666666666667407" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covarianceSamp" : { "$numberDouble" : "2.5" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covarianceSamp" : { "$numberDouble" : "3.5" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": { "$cond": [{ "$eq": [{ "$mod": ["$_id", 2] }, 0] }, "even", "odd"] }, "sortBy": { "date": 1}, "output": {"covariancePop": { "$covariancePop": ["$x", "$y"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                                                   document                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covariancePop" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covariancePop" : { "$numberDouble" : "2.6666666666666665186" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covariancePop" : { "$numberDouble" : "5.0" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covariancePop" : { "$numberDouble" : "8.0" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covariancePop" : { "$numberDouble" : "11.666666666666666075" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covariancePop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covariancePop" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covariancePop" : { "$numberDouble" : "2.6666666666666665186" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covariancePop" : { "$numberDouble" : "5.0" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covariancePop" : { "$numberDouble" : "8.0" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covariancePop" : { "$numberDouble" : "11.666666666666666075" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_col", "pipeline":  [{"$setWindowFields": {"partitionBy": { "$cond": [{ "$eq": [{ "$mod": ["$_id", 2] }, 0] }, "even", "odd"] }, "sortBy": {"date": 1}, "output": {"covarianceSamp": { "$covarianceSamp": ["$x", "$y"], "window": {"documents": ["unbounded", "current"]}}}}}]}');
                                                                                                                  document                                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "covarianceSamp" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "4" }, "x" : { "$numberInt" : "5" }, "y" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "covarianceSamp" : { "$numberDouble" : "4.0" } }
 { "_id" : { "$numberInt" : "6" }, "x" : { "$numberInt" : "7" }, "y" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "covarianceSamp" : { "$numberDouble" : "6.6666666666666669627" } }
 { "_id" : { "$numberInt" : "8" }, "x" : { "$numberInt" : "9" }, "y" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "covarianceSamp" : { "$numberDouble" : "10.0" } }
 { "_id" : { "$numberInt" : "10" }, "x" : { "$numberInt" : "11" }, "y" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "covarianceSamp" : { "$numberDouble" : "14.0" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "covarianceSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "covarianceSamp" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "5" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "covarianceSamp" : { "$numberDouble" : "4.0" } }
 { "_id" : { "$numberInt" : "7" }, "x" : { "$numberInt" : "8" }, "y" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "covarianceSamp" : { "$numberDouble" : "6.6666666666666669627" } }
 { "_id" : { "$numberInt" : "9" }, "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "covarianceSamp" : { "$numberDouble" : "10.0" } }
 { "_id" : { "$numberInt" : "11" }, "x" : { "$numberInt" : "12" }, "y" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "covarianceSamp" : { "$numberDouble" : "14.0" } }
(12 rows)

---------------------------------------------------------------------
-- $rank accumulator tests
---------------------------------------------------------------------
-- no values overlap all unique values for sortBy field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1} ,"output": {"rank": { "$rank": {}}}}}]}');
                                                                                                        document                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "rank" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "rank" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "rank" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "rank" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "rank" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "rank" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "rank" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "rank" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "rank" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "rank" : { "$numberInt" : "4" } }
(13 rows)

-- values overlap non-unique values for sortBy field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"rank": { "$rank": {}}}}}]}');
                                                                                                        document                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "rank" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "rank" : { "$numberInt" : "1" } }
(13 rows)

-- field not present sort by field and also heterogenous bson type
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"rank": { "$rank": {}}}}}]}');
                                                                                          document                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "quantity" : { "$numberInt" : "515" }, "rank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$numberInt" : "1" }, "rank" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "rank" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "abc", "cost" : "80", "quantity" : { "$numberInt" : "515" }, "rank" : { "$numberInt" : "4" } }
(4 rows)

-- error scenario window provided in input.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"rank": { "$rank": {}, "window": []}}}}]}');
ERROR:  Rank style window functions take no other arguments
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"rank": { "$rank": {}, "window": {"documents": [-1, 1]}}}}}]}');
ERROR:  Rank style window functions take no other arguments
-- error when input is not empty document to $rank
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"rank": { "$rank": {"a":1}}}}}]}');
ERROR:  (None) must be specified with '{}' as the value
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"rank": { "$rank": "$a" }}}}]}');
ERROR:  (None) must be specified with '{}' as the value
-- error when input does not have a sort by clause
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a" ,"output": {"rank": { "$rank": {} }}}}]}');
ERROR:  $rank must be specified with a top level sortBy expression with exactly one element
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1, "a":-1} ,"output": {"rank": { "$rank": {} }}}}]}');
ERROR:  $rank must be specified with a top level sortBy expression with exactly one element
-- error when window is present > rank input valiation > sort by clause
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1, "a":-1} ,"output": {"rank": { "$rank": {"a":1}, "window":[] }}}}]}');
ERROR:  Rank style window functions take no other arguments
-- error when rank is not having empty document
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1, "a":-1} ,"output": {"rank": { "$rank": {"a":1} }}}}]}');
ERROR:  (None) must be specified with '{}' as the value
-- error when sort is not as expected
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1, "a":-1} ,"output": {"rank": { "$rank": {} }}}}]}');
ERROR:  $rank must be specified with a top level sortBy expression with exactly one element
---------------------------------------------------------------------
-- $denseRank accumulator tests
---------------------------------------------------------------------
-- no values overlap all unique values for sortBy field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1} ,"output": {"denseRank": { "$denseRank": {}}}}}]}');
                                                                                                          document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "denseRank" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "denseRank" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "denseRank" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "denseRank" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "denseRank" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "denseRank" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "denseRank" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "denseRank" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "denseRank" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "denseRank" : { "$numberInt" : "4" } }
(13 rows)

-- values overlap non-unique values for sortBy field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"denseRank": { "$denseRank": {}}}}}]}');
                                                                                                          document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "denseRank" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "denseRank" : { "$numberInt" : "1" } }
(13 rows)

-- field not present sort by field and also heterogenous bson type
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"denseRank": { "$denseRank": {}}}}}]}');
                                                                                            document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "quantity" : { "$numberInt" : "515" }, "denseRank" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$numberInt" : "1" }, "denseRank" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "denseRank" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "abc", "cost" : "80", "quantity" : { "$numberInt" : "515" }, "denseRank" : { "$numberInt" : "3" } }
(4 rows)

-- error scenario window provided in input.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"denseRank": { "$denseRank": {}, "window": []}}}}]}');
ERROR:  Rank style window functions take no other arguments
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"denseRank": { "$denseRank": {}, "window": {"documents": [-1, 1]}}}}}]}');
ERROR:  Rank style window functions take no other arguments
-- error when input is not empty document to $denseRank
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"denseRank": { "$denseRank": {"a":1}}}}}]}');
ERROR:  (None) must be specified with '{}' as the value
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"denseRank": { "$denseRank": "$a" }}}}]}');
ERROR:  (None) must be specified with '{}' as the value
-- error when input does not have a sort by clause
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a" ,"output": {"denseRank": { "$denseRank": {} }}}}]}');
ERROR:  $denseRank must be specified with a top level sortBy expression with exactly one element
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1, "a":-1} ,"output": {"denseRank": { "$denseRank": {} }}}}]}');
ERROR:  $denseRank must be specified with a top level sortBy expression with exactly one element
-- error when window is present > denseRank input valiation > sort by clause
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1, "a":-1} ,"output": {"denseRank": { "$denseRank": {"a":1}, "window":[] }}}}]}');
ERROR:  Rank style window functions take no other arguments
-- error when denseRank is not having empty document
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1, "a":-1} ,"output": {"denseRank": { "$denseRank": {"a":1} }}}}]}');
ERROR:  (None) must be specified with '{}' as the value
-- error when sort is not as expected
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1, "a":-1} ,"output": {"denseRank": { "$denseRank": {} }}}}]}');
ERROR:  $denseRank must be specified with a top level sortBy expression with exactly one element
---------------------------------------------------------------------
-- $documentNumber accumulator tests
---------------------------------------------------------------------
-- no values overlap all unique values for sortBy field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1} ,"output": {"rowNumber": { "$documentNumber": {}}}}}]}');
                                                                                                          document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "rowNumber" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "rowNumber" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "rowNumber" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "rowNumber" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "rowNumber" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "rowNumber" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "rowNumber" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "rowNumber" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "rowNumber" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "rowNumber" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "rowNumber" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "rowNumber" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "rowNumber" : { "$numberInt" : "4" } }
(13 rows)

-- values overlap non-unique values for sortBy field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"rowNumber": { "$documentNumber": {}}}}}]}');
                                                                                                          document                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "rowNumber" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "rowNumber" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "rowNumber" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "rowNumber" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "rowNumber" : { "$numberInt" : "5" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "rowNumber" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "rowNumber" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "rowNumber" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "rowNumber" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "rowNumber" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "rowNumber" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "rowNumber" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "rowNumber" : { "$numberInt" : "4" } }
(13 rows)

-- field not present sort by field and also heterogenous bson type
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"rowNumber": { "$documentNumber": {}}}}}]}');
                                                                                            document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "quantity" : { "$numberInt" : "515" }, "rowNumber" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$numberInt" : "1" }, "rowNumber" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "rowNumber" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "abc", "cost" : "80", "quantity" : { "$numberInt" : "515" }, "rowNumber" : { "$numberInt" : "4" } }
(4 rows)

-- error scenario window provided in input.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"rowNumber": { "$documentNumber": {}, "window": []}}}}]}');
ERROR:  Rank style window functions take no other arguments
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"rowNumber": { "$documentNumber": {}, "window": {"documents": [-1, 1]}}}}}]}');
ERROR:  Rank style window functions take no other arguments
-- error when input is not empty document to $documentNumber
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"rowNumber": { "$documentNumber": {"a":1}}}}}]}');
ERROR:  (None) must be specified with '{}' as the value
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1} ,"output": {"rowNumber": { "$documentNumber": "$a" }}}}]}');
ERROR:  (None) must be specified with '{}' as the value
-- error when input does not have a sort by clause
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a" ,"output": {"rowNumber": { "$documentNumber": {} }}}}]}');
ERROR:  $documentNumber must be specified with a top level sortBy expression with exactly one element
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1, "a":-1} ,"output": {"rowNumber": { "$documentNumber": {} }}}}]}');
ERROR:  $documentNumber must be specified with a top level sortBy expression with exactly one element
-- error when window is present > rowNumber input valiation > sort by clause
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1, "a":-1} ,"output": {"rowNumber": { "$documentNumber": {"a":1}, "window":[] }}}}]}');
ERROR:  Rank style window functions take no other arguments
-- error when rowNumber is not having empty document
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1, "a":-1} ,"output": {"rowNumber": { "$documentNumber": {"a":1} }}}}]}');
ERROR:  (None) must be specified with '{}' as the value
-- error when sort is not as expected
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields_invalidtypes", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"cost": 1, "a":-1} ,"output": {"rowNumber": { "$documentNumber": {} }}}}]}');
ERROR:  $documentNumber must be specified with a top level sortBy expression with exactly one element
---------------------------------------------------------------------
-- $integral and $derivative accumulator tests
---------------------------------------------------------------------
SELECT documentdb_api.insert_one('db', 'powerConsumption', '{"powerMeterID": "1", "timeStamp": { "$date": { "$numberLong": "1589814630000" }}, "a": "abc", "kilowatts": 2.95}', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerConsumption', '{"powerMeterID": "1", "timeStamp": { "$date": { "$numberLong": "1589814660000" }}, "a": "abc", "kilowatts": 2.7}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerConsumption', '{"powerMeterID": "1", "timeStamp": { "$date": { "$numberLong": "1589814690000" }}, "a": "abc", "kilowatts": 2.6}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerConsumption', '{"powerMeterID": "1", "timeStamp": { "$date": { "$numberLong": "1589814720000" }}, "a": "abc", "kilowatts": 2.98}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerConsumption', '{"powerMeterID": "2", "timeStamp": { "$date": { "$numberLong": "1589814630000" }}, "a": "abc", "kilowatts": 2.5}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerConsumption', '{"powerMeterID": "2", "timeStamp": { "$date": { "$numberLong": "1589814660000" }}, "a": "abc", "kilowatts": 2.25}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerConsumption', '{"powerMeterID": "2", "timeStamp": { "$date": { "$numberLong": "1589814690000" }}, "a": "abc", "kilowatts": 2.75}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerConsumption', '{"powerMeterID": "2", "timeStamp": { "$date": { "$numberLong": "1589814720000" }}, "a": "abc", "kilowatts": 2.82}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Validations
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour" }, "window": { "range": [ "unbounded", "current" ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
                                                                                                                     document                                                                                                                     
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.023541666666666665603" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.04562499999999999889" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.019791666666666665741" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.040624999999999994449" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
                                                                                                                     document                                                                                                                     
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour" }, "window": { "range": [ -1, 2 ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
                                                                                                                     document                                                                                                                     
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour" }, "window": { "range": [ -1, 2 ], "unit": "minute" } } } } }, { "$unset": "_id" } ]}');
                                                                                                                     document                                                                                                                     
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.04533333333333333659" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.044041666666666666463" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour" }, "window": { "range": [ -10, 20 ], "unit": "second" } } } } }, { "$unset": "_id" } ]}');
                                                                                                           document                                                                                                           
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "millisecond" }, "window": { "range": [ "unbounded", "current" ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "84750.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "164250.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "247950.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "71250.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "146250.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "229800.0" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "second" }, "window": { "range": [ "unbounded", "current" ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
                                                                                                                    document                                                                                                                    
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "84.75" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "164.25" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "247.94999999999998863" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "71.25" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "146.25" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "229.80000000000001137" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "minute" }, "window": { "range": [ "unbounded", "current" ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
                                                                                                                    document                                                                                                                    
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "1.4125000000000000888" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "2.7375000000000002665" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "4.1325000000000002842" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "1.1875" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "2.4375" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "3.8300000000000000711" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "day" }, "window": { "range": [ "unbounded", "current" ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.00098090277777777780573" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.001901041666666666765" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.002869791666666666758" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.00082465277777777777537" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0016927083333333333912" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0026597222222222221752" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "week" }, "window": { "range": [ "unbounded", "current" ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.00014012896825396826571" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.00027157738095238102838" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.00040997023809523813927" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.00011780753968253968413" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.00024181547619047619874" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.00037996031746031746134" } }
(8 rows)

-- Negative tests
-- unknown argument
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour", "unknown": 1 }, "window": { "range": [ -1, 2 ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
ERROR:  $integral got unexpected argument: unknown
-- $integral (with no 'unit')
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts" }, "window": { "range": [ "unbounded", "current" ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
ERROR:  $integral (with no 'unit') expects the sortBy field to be numeric
-- $integral (with no 'sortBy')
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour" }, "window": { "range": [ "unbounded", "current" ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
ERROR:  $integral requires a sortBy
-- $integral sort by unknown field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "unknown": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts" }, "window": { "range": [ "unbounded", "current" ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
ERROR:  $integral (with no 'unit') expects the sortBy field to be numeric
-- $integral with invalid 'unit'
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "year" }, "window": { "range": [ -1, 2 ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
ERROR:  unit must be 'week' or smaller
-- $integral with no input
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "unit": "hour" }, "window": { "range": [ -1, 2 ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
ERROR:  $integral requires an 'input' expression
-- $integral with invalid input
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$unknown", "unit": "hour" }, "window": { "range": [ -1, 2 ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
ERROR:  The input value of $integral window function must be a vector of 2 value, the first value must be numeric or date type and the second must be numeric.
-- $integral with invalid window range
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour" }, "window": { "range": [ -1, "current" ] } } } } }, { "$unset": "_id" } ]}');
ERROR:  PlanExecutor error during aggregation :: caused by :: Invalid range: Expected the sortBy field to be a number, but it was date
-- $integral input is str
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$str", "unit": "hour" }, "window": { "range": [ -1, 2 ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
ERROR:  The input value of $integral window function must be a vector of 2 value, the first value must be numeric or date type and the second must be numeric.
-- test integral without timestamp
SELECT documentdb_api.insert_one('db', 'collNumeric', '{"partitionID": 1, "x": 0, "y": 1}', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'collNumeric', '{"partitionID": 1, "x": 1, "y": 2}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'collNumeric', '{"partitionID": 1, "x": 2, "y": 1}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'collNumeric', '{"partitionID": 1, "x": 3, "y": 4}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'collNumeric', '{"partitionID": 2, "x": 0, "y": 100}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'collNumeric', '{"partitionID": 2, "x": 2, "y": 105}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'collNumeric', '{"partitionID": 2, "x": 4, "y": 107}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'collNumeric', '{"partitionID": 2, "x": 6, "y": -100}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Validations
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNumeric", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "integral": { "$integral": { "input": "$y" }, "window": { "range": [ -1, 2 ]} } } } }, { "$unset": "_id" } ]}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "1" }, "integral" : { "$numberDouble" : "3.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "integral" : { "$numberDouble" : "5.5" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "1" }, "integral" : { "$numberDouble" : "4.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "integral" : { "$numberDouble" : "2.5" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "100" }, "integral" : { "$numberDouble" : "205.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "105" }, "integral" : { "$numberDouble" : "212.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "107" }, "integral" : { "$numberDouble" : "7.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "-100" }, "integral" : { "$numberDouble" : "0.0" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNumeric", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "integral": { "$integral": { "input": "$y" }, "window": { "range": [ -1, 2 ]} } } } }, { "$unset": "_id" } ]}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "1" }, "integral" : { "$numberDouble" : "3.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "integral" : { "$numberDouble" : "5.5" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "1" }, "integral" : { "$numberDouble" : "4.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "integral" : { "$numberDouble" : "2.5" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "100" }, "integral" : { "$numberDouble" : "205.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "105" }, "integral" : { "$numberDouble" : "212.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "107" }, "integral" : { "$numberDouble" : "7.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "-100" }, "integral" : { "$numberDouble" : "0.0" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNumeric", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "integral": { "$integral": { "input": "$y" }, "window": { "range": [ "unbounded", "current" ]} } } } }, { "$unset": "_id" } ]}');
                                                                       document                                                                        
---------------------------------------------------------------------
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "1" }, "integral" : { "$numberDouble" : "0.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "integral" : { "$numberDouble" : "1.5" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "1" }, "integral" : { "$numberDouble" : "3.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "integral" : { "$numberDouble" : "5.5" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "100" }, "integral" : { "$numberDouble" : "0.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "105" }, "integral" : { "$numberDouble" : "205.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "107" }, "integral" : { "$numberDouble" : "417.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "-100" }, "integral" : { "$numberDouble" : "424.0" } }
(8 rows)

-- Negative tests, common negative tests for $integral
-- $integral (with unit and without timestamp)
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNumeric", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "integral": { "$integral": { "input": "$y", "unit": "hour" }, "window": { "range": [ -1, 2 ]} } } } }, { "$unset": "_id" } ]}'); 
ERROR:  $integral with 'unit' expects the sortBy field to be a Date
-- test derivative with timestamp
SELECT documentdb_api.insert_one('db', 'deliveryFleet', '{"truckID": "1", "timeStamp": { "$date": { "$numberLong": "1589814630000" } }, "miles": 1295.1, "a": "abc"}', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'deliveryFleet', '{"truckID": "1", "timeStamp": { "$date": { "$numberLong": "1589814660000" } }, "miles": 1295.63, "a": "abc"}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'deliveryFleet', '{"truckID": "1", "timeStamp": { "$date": { "$numberLong": "1589814690000" } }, "miles": 1296.25, "a": "abc"}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'deliveryFleet', '{"truckID": "1", "timeStamp": { "$date": { "$numberLong": "1589814720000" } }, "miles": 1296.76, "a": "abc"}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'deliveryFleet', '{"truckID": "2", "timeStamp": { "$date": { "$numberLong": "1589814630000" } }, "miles": 10234.1, "a": "abc"}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'deliveryFleet', '{"truckID": "2", "timeStamp": { "$date": { "$numberLong": "1589814660000" } }, "miles": 10234.33, "a": "abc"}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'deliveryFleet', '{"truckID": "2", "timeStamp": { "$date": { "$numberLong": "1589814690000" } }, "miles": 10234.73, "a": "abc"}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'deliveryFleet', '{"truckID": "2", "timeStamp": { "$date": { "$numberLong": "1589814720000" } }, "miles": 10235.13, "a": "abc"}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Validations
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "hour" }, "window": { "range": [ -30, 0 ], "unit": "second" } } } } }, { "$match": { "truckAverageSpeed": { "$gt": 50 } } }, { "$unset": "_id" } ]}');
                                                                                                            document                                                                                                             
---------------------------------------------------------------------
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "miles" : { "$numberDouble" : "1295.6300000000001091" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "63.60000000002401066" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "miles" : { "$numberDouble" : "1296.25" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "74.399999999986903276" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "miles" : { "$numberDouble" : "1296.7599999999999909" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "61.199999999998908606" } }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "hour" }, "window": { "range": [ "unbounded", "current" ], "unit": "second" } } } } }, { "$match": { "truckAverageSpeed": { "$gt": 50 } } }, { "$unset": "_id" } ]}');
                                                                                                            document                                                                                                             
---------------------------------------------------------------------
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "miles" : { "$numberDouble" : "1295.6300000000001091" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "63.60000000002401066" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "miles" : { "$numberDouble" : "1296.25" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "69.000000000005456968" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "miles" : { "$numberDouble" : "1296.7599999999999909" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "66.400000000003274181" } }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "millisecond" }, "window": { "range": [ "unbounded", "current" ], "unit": "second" } } } } }, { "$unset": "_id" } ]}');
                                                                                                              document                                                                                                               
---------------------------------------------------------------------
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "miles" : { "$numberDouble" : "1295.0999999999999091" }, "a" : "abc", "truckAverageSpeed" : null }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "miles" : { "$numberDouble" : "1295.6300000000001091" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "1.7666666666673335899e-05" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "miles" : { "$numberDouble" : "1296.25" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "1.9166666666668181741e-05" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "miles" : { "$numberDouble" : "1296.7599999999999909" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "1.8444444444445352806e-05" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "miles" : { "$numberDouble" : "10234.100000000000364" }, "a" : "abc", "truckAverageSpeed" : null }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "miles" : { "$numberDouble" : "10234.329999999999927" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "7.6666666666521152113e-06" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "miles" : { "$numberDouble" : "10234.729999999999563" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "1.0499999999986660344e-05" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "miles" : { "$numberDouble" : "10235.1299999999992" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "1.1444444444431509851e-05" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "second" }, "window": { "range": [ "unbounded", "current" ], "unit": "second" } } } } }, { "$unset": "_id" } ]}');
                                                                                                              document                                                                                                              
---------------------------------------------------------------------
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "miles" : { "$numberDouble" : "1295.0999999999999091" }, "a" : "abc", "truckAverageSpeed" : null }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "miles" : { "$numberDouble" : "1295.6300000000001091" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "0.017666666666673335601" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "miles" : { "$numberDouble" : "1296.25" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "0.019166666666668181335" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "miles" : { "$numberDouble" : "1296.7599999999999909" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "0.01844444444444535286" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "miles" : { "$numberDouble" : "10234.100000000000364" }, "a" : "abc", "truckAverageSpeed" : null }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "miles" : { "$numberDouble" : "10234.329999999999927" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "0.0076666666666521145201" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "miles" : { "$numberDouble" : "10234.729999999999563" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "0.010499999999986660629" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "miles" : { "$numberDouble" : "10235.1299999999992" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "0.011444444444431508753" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "minute" }, "window": { "range": [ "unbounded", "current" ], "unit": "second" } } } } }, { "$unset": "_id" } ]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "miles" : { "$numberDouble" : "1295.0999999999999091" }, "a" : "abc", "truckAverageSpeed" : null }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "miles" : { "$numberDouble" : "1295.6300000000001091" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "1.0600000000004001777" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "miles" : { "$numberDouble" : "1296.25" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "1.1500000000000909495" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "miles" : { "$numberDouble" : "1296.7599999999999909" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "1.1066666666667213104" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "miles" : { "$numberDouble" : "10234.100000000000364" }, "a" : "abc", "truckAverageSpeed" : null }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "miles" : { "$numberDouble" : "10234.329999999999927" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "0.45999999999912688509" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "miles" : { "$numberDouble" : "10234.729999999999563" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "0.62999999999919964466" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "miles" : { "$numberDouble" : "10235.1299999999992" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "0.68666666666589060153" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "day" }, "window": { "range": [ "unbounded", "current" ], "unit": "second" } } } } }, { "$unset": "_id" } ]}');
                                                                                                            document                                                                                                             
---------------------------------------------------------------------
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "miles" : { "$numberDouble" : "1295.0999999999999091" }, "a" : "abc", "truckAverageSpeed" : null }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "miles" : { "$numberDouble" : "1295.6300000000001091" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "1526.4000000005762558" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "miles" : { "$numberDouble" : "1296.25" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "1656.0000000001309672" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "miles" : { "$numberDouble" : "1296.7599999999999909" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "1593.6000000000785803" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "miles" : { "$numberDouble" : "10234.100000000000364" }, "a" : "abc", "truckAverageSpeed" : null }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "miles" : { "$numberDouble" : "10234.329999999999927" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "662.39999999874271452" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "miles" : { "$numberDouble" : "10234.729999999999563" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "907.19999999884748831" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "miles" : { "$numberDouble" : "10235.1299999999992" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "988.79999999888241291" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "week" }, "window": { "range": [ "unbounded", "current" ], "unit": "second" } } } } }, { "$unset": "_id" } ]}');
                                                                                                            document                                                                                                             
---------------------------------------------------------------------
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "miles" : { "$numberDouble" : "1295.0999999999999091" }, "a" : "abc", "truckAverageSpeed" : null }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "miles" : { "$numberDouble" : "1295.6300000000001091" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "10684.800000004033791" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "miles" : { "$numberDouble" : "1296.25" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "11592.000000000916771" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "miles" : { "$numberDouble" : "1296.7599999999999909" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "11155.200000000548243" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "miles" : { "$numberDouble" : "10234.100000000000364" }, "a" : "abc", "truckAverageSpeed" : null }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "miles" : { "$numberDouble" : "10234.329999999999927" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "4636.7999999911990017" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "miles" : { "$numberDouble" : "10234.729999999999563" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "6350.3999999919324182" } }
 { "truckID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "miles" : { "$numberDouble" : "10235.1299999999992" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "6921.5999999921759809" } }
(8 rows)

-- Negative tests
-- $derivative (with no 'unit')
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles" }, "window": { "range": [ -30, 0 ], "unit": "second" } } } } }, { "$match": { "truckAverageSpeed": { "$gt": 50 } } }, { "$unset": "_id" } ]}');
ERROR:  $derivative where the sortBy is a Date requires an 'unit'
-- $derivative with invalid 'unit'
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "month" }, "window": { "range": [ -30, 0 ], "unit": "second" } } } } }, { "$match": { "truckAverageSpeed": { "$gt": 50 } } }, { "$unset": "_id" } ]}');
ERROR:  unit must be 'week' or smaller
-- $derivative (with no 'sortBy')
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "hour" }, "window": { "unit": "second" } } } } }, { "$match": { "truckAverageSpeed": { "$gt": 50 } } }, { "$unset": "_id" } ]}');
ERROR:  Window bounds can only specify 'unit' with range-based bounds.
-- $derivative (with invalid str 'sortBy')
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "str": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "hour" }, "window": { "range": [ -30, 0 ], "unit": "second" } } } } }, { "$match": { "truckAverageSpeed": { "$gt": 50 } } }, { "$unset": "_id" } ]}');
ERROR:  PlanExecutor error during aggregation :: caused by :: Invalid range: Expected the sortBy field to be a Date, but it was undefined
-- $derivative sort by unknown field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "unknown": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "hour" }, "window": { "range": [ -30, 0 ], "unit": "second" } } } } }, { "$match": { "truckAverageSpeed": { "$gt": 50 } } }, { "$unset": "_id" } ]}');
ERROR:  PlanExecutor error during aggregation :: caused by :: Invalid range: Expected the sortBy field to be a Date, but it was undefined
-- $derivative with no window
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "hour" } } } } }, { "$match": { "truckAverageSpeed": { "$gt": 50 } } }, { "$unset": "_id" } ]}');
ERROR:  $derivative requires explicit window bounds
-- $derivative with invalid input
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$str", "unit": "hour" }, "window": { "range": [ -30, 0 ], "unit": "second" } } } } }, { "$match": { "truckAverageSpeed": { "$gt": 50 } } }, { "$unset": "_id" } ]}');
ERROR:  The input value of $derivative window function must be a vector of 2 value, the first value must be numeric or date type and the second must be numeric.
-- $derivative with no input
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "unit": "hour" }, "window": { "range": [ -30, 0 ], "unit": "second" } } } } }, { "$match": { "truckAverageSpeed": { "$gt": 50 } } }, { "$unset": "_id" } ]}');
ERROR:  $derivative requires an 'input' expression
-- unknown argument
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "hour", "unknown": 1 }, "window": { "range": [ -30, 0 ], "unit": "second" } } } } }, { "$match": { "truckAverageSpeed": { "$gt": 50 } } }, { "$unset": "_id" } ]}');
ERROR:  $derivative got unexpected argument: unknown
-- test derivative without timestamp
-- Validations
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNumeric", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "derivative": { "$derivative": { "input": "$y" }, "window": { "range": [ -1, 1 ]} } } } }, { "$unset": "_id" } ]}');
                                                                      document                                                                      
---------------------------------------------------------------------
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "1" }, "derivative" : { "$numberDouble" : "1.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "derivative" : { "$numberDouble" : "0.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "1" }, "derivative" : { "$numberDouble" : "1.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "derivative" : { "$numberDouble" : "3.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "100" }, "derivative" : null }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "105" }, "derivative" : null }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "107" }, "derivative" : null }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "-100" }, "derivative" : null }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNumeric", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "derivative": { "$derivative": { "input": "$y"}, "window": { "range": [ "unbounded", "current" ]} } } } }, { "$unset": "_id" } ]}');
                                                                                 document                                                                                 
---------------------------------------------------------------------
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "1" }, "derivative" : null }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "derivative" : { "$numberDouble" : "1.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "1" }, "derivative" : { "$numberDouble" : "0.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "derivative" : { "$numberDouble" : "1.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "100" }, "derivative" : null }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "105" }, "derivative" : { "$numberDouble" : "2.5" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "107" }, "derivative" : { "$numberDouble" : "1.75" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "-100" }, "derivative" : { "$numberDouble" : "-33.333333333333335702" } }
(8 rows)

-- Negative tests
-- $derivative (with 'unit' and without timestamp)
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNumeric", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "derivative": { "$derivative": { "input": "$y", "unit": "hour" }, "window": { "range": [ -1, 1 ]} } } } }, { "$unset": "_id" } ]}');
ERROR:  $derivative with 'unit' expects the sortBy field to be a Date
-- $derivative (window is with date range)
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNumeric", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "derivative": { "$derivative": { "input": "$y" }, "window": { "range": [ -1, 1 ], "unit": "second"} } } } }, { "$unset": "_id" } ]}');
ERROR:  PlanExecutor error during aggregation :: caused by :: Invalid range: Expected the sortBy field to be a Date, but it was int
-- test integral and derivative with shard
SELECT documentdb_api.shard_collection('db', 'collNumeric', '{ "type": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT documentdb_api.shard_collection('db', 'deliveryFleet', '{ "type": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT documentdb_api.shard_collection('db', 'powerConsumption', '{ "type": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- derivative
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNumeric", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "derivative": { "$derivative": { "input": "$y" }, "window": { "range": [ -1, 1 ]} } } } }, { "$unset": "_id" } ]}');
                                                                      document                                                                      
---------------------------------------------------------------------
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "1" }, "derivative" : { "$numberDouble" : "1.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "derivative" : { "$numberDouble" : "0.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "1" }, "derivative" : { "$numberDouble" : "1.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "derivative" : { "$numberDouble" : "3.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "100" }, "derivative" : null }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "105" }, "derivative" : null }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "107" }, "derivative" : null }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "-100" }, "derivative" : null }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNumeric", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "derivative": { "$derivative": { "input": "$y"}, "window": { "range": [ "unbounded", "current" ]} } } } }, { "$unset": "_id" } ]}');
                                                                                 document                                                                                 
---------------------------------------------------------------------
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "1" }, "derivative" : null }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "derivative" : { "$numberDouble" : "1.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "1" }, "derivative" : { "$numberDouble" : "0.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "derivative" : { "$numberDouble" : "1.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "100" }, "derivative" : null }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "105" }, "derivative" : { "$numberDouble" : "2.5" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "107" }, "derivative" : { "$numberDouble" : "1.75" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "-100" }, "derivative" : { "$numberDouble" : "-33.333333333333335702" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "hour" }, "window": { "range": [ -30, 0 ], "unit": "second" } } } } }, { "$match": { "truckAverageSpeed": { "$gt": 50 } } }, { "$unset": "_id" } ]}');
                                                                                                            document                                                                                                             
---------------------------------------------------------------------
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "miles" : { "$numberDouble" : "1295.6300000000001091" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "63.60000000002401066" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "miles" : { "$numberDouble" : "1296.25" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "74.399999999986903276" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "miles" : { "$numberDouble" : "1296.7599999999999909" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "61.199999999998908606" } }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "deliveryFleet", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "hour" }, "window": { "range": [ "unbounded", "current" ], "unit": "second" } } } } }, { "$match": { "truckAverageSpeed": { "$gt": 50 } } }, { "$unset": "_id" } ]}');
                                                                                                            document                                                                                                             
---------------------------------------------------------------------
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "miles" : { "$numberDouble" : "1295.6300000000001091" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "63.60000000002401066" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "miles" : { "$numberDouble" : "1296.25" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "69.000000000005456968" } }
 { "truckID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "miles" : { "$numberDouble" : "1296.7599999999999909" }, "a" : "abc", "truckAverageSpeed" : { "$numberDouble" : "66.400000000003274181" } }
(3 rows)

-- integral
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNumeric", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "integral": { "$integral": { "input": "$y" }, "window": { "range": [ -1, 2 ]} } } } }, { "$unset": "_id" } ]}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "1" }, "integral" : { "$numberDouble" : "3.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "integral" : { "$numberDouble" : "5.5" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "1" }, "integral" : { "$numberDouble" : "4.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "integral" : { "$numberDouble" : "2.5" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "100" }, "integral" : { "$numberDouble" : "205.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "105" }, "integral" : { "$numberDouble" : "212.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "107" }, "integral" : { "$numberDouble" : "7.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "-100" }, "integral" : { "$numberDouble" : "0.0" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNumeric", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "integral": { "$integral": { "input": "$y" }, "window": { "range": [ -1, 2 ]} } } } }, { "$unset": "_id" } ]}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "1" }, "integral" : { "$numberDouble" : "3.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "integral" : { "$numberDouble" : "5.5" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "1" }, "integral" : { "$numberDouble" : "4.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "integral" : { "$numberDouble" : "2.5" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "100" }, "integral" : { "$numberDouble" : "205.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "105" }, "integral" : { "$numberDouble" : "212.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "107" }, "integral" : { "$numberDouble" : "7.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "-100" }, "integral" : { "$numberDouble" : "0.0" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNumeric", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "integral": { "$integral": { "input": "$y" }, "window": { "range": [ "unbounded", "current" ]} } } } }, { "$unset": "_id" } ]}');
                                                                       document                                                                        
---------------------------------------------------------------------
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "1" }, "integral" : { "$numberDouble" : "0.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "integral" : { "$numberDouble" : "1.5" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "1" }, "integral" : { "$numberDouble" : "3.0" } }
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "4" }, "integral" : { "$numberDouble" : "5.5" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberInt" : "100" }, "integral" : { "$numberDouble" : "0.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "105" }, "integral" : { "$numberDouble" : "205.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "107" }, "integral" : { "$numberDouble" : "417.0" } }
 { "partitionID" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "6" }, "y" : { "$numberInt" : "-100" }, "integral" : { "$numberDouble" : "424.0" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour" }, "window": { "range": [ "unbounded", "current" ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
                                                                                                                     document                                                                                                                     
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.023541666666666665603" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.04562499999999999889" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.019791666666666665741" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.040624999999999994449" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
                                                                                                                     document                                                                                                                     
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour" }, "window": { "range": [ -1, 2 ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
                                                                                                                     document                                                                                                                     
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour" }, "window": { "range": [ -1, 2 ], "unit": "minute" } } } } }, { "$unset": "_id" } ]}');
                                                                                                                     document                                                                                                                     
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.068874999999999991784" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.04533333333333333659" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.063833333333333325266" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.044041666666666666463" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerConsumption", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour" }, "window": { "range": [ -10, 20 ], "unit": "second" } } } } }, { "$unset": "_id" } ]}');
                                                                                                           document                                                                                                           
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9500000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.7000000000000001776" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.6000000000000000888" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.9799999999999999822" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.5" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814660000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.25" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.75" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "2", "timeStamp" : { "$date" : { "$numberLong" : "1589814720000" } }, "a" : "abc", "kilowatts" : { "$numberDouble" : "2.8199999999999998401" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
(8 rows)

-- test integral and derivative with invalid mixed types
-- insert non-date data
SELECT documentdb_api.insert_one('db', 'IntegralInvalid', '{"truckID": "1", "timeStamp": { "$date": { "$numberLong": "1589814630000" } }, "miles": 1295.1}', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'IntegralInvalid', '{"truckID": "1", "timeStamp": { "$date": { "$numberLong": "1589814660000" } }, "miles": 1295.63}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'IntegralInvalid', '{"truckID": "1", "timeStamp": { "$date": { "$numberLong": "1589814690000" } }, "miles": 1296.25}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'IntegralInvalid', '{"truckID": "1", "timeStamp": { "$date": { "$numberLong": "1589814720000" } }, "miles": 1296.76}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'IntegralInvalid', '{"truckID": "2", "timeStamp": { "$date": { "$numberLong": "1589814630000" } }, "miles": 10234.1}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'IntegralInvalid', '{"truckID": "2", "timeStamp": { "$date": { "$numberLong": "1589814660000" } }, "miles": 10234.33}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'IntegralInvalid', '{"truckID": "2", "timeStamp": { "$date": { "$numberLong": "1589814690000" } }, "miles": 10234.73}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'IntegralInvalid', '{"truckID": "2", "timeStamp": { "$date": { "$numberLong": "1589814720000" } }, "miles": 10235.13}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'IntegralInvalid', '{"truckID": "2", "timeStamp": 0, "miles": 10234.73}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'IntegralInvalid', '{"truckID": "3", "timeStamp": 1, "miles": 10234.73}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- derivative failed
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "IntegralInvalid", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$derivative": { "input": "$miles", "unit": "hour" }, "window": { "range": [ -30, 0 ], "unit": "second" } } } } }, { "$unset": "_id" } ]}');
ERROR:  PlanExecutor error during aggregation :: caused by :: Invalid range: Expected the sortBy field to be a Date, but it was int
-- integral failed
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{"aggregate": "IntegralInvalid", "pipeline": [ { "$setWindowFields": { "partitionBy": "$truckID", "sortBy": { "timeStamp": 1 }, "output": { "truckAverageSpeed": { "$integral": { "input": "$miles", "unit": "hour" }, "window": { "range": [ -30, 0 ], "unit": "second" } } } } }, { "$unset": "_id" } ]}');
ERROR:  PlanExecutor error during aggregation :: caused by :: Invalid range: Expected the sortBy field to be a Date, but it was int
-- test integral and derivative with infinity/null/NaN mixed types
SELECT documentdb_api.insert_one('db', 'collNaN', '{"partitionID": 1, "x": 0, "y":  {"$numberDecimal": "NaN" }}', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- test NaN
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNaN", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "integral": { "$integral": { "input": "$y" }, "window": { "range": [ -1, 1 ]} } } } }, { "$unset": "_id" } ]}');
                                                                        document                                                                        
---------------------------------------------------------------------
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberDecimal" : "NaN" }, "integral" : { "$numberDouble" : "0.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "collNaN", "pipeline": [ { "$setWindowFields": { "partitionBy": "$partitionID", "sortBy": { "x": 1 }, "output": { "integral": { "$derivative": { "input": "$y" }, "window": { "range": [ -1, 1 ]} } } } }, { "$unset": "_id" } ]}');
                                                            document                                                             
---------------------------------------------------------------------
 { "partitionID" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "0" }, "y" : { "$numberDecimal" : "NaN" }, "integral" : null }
(1 row)

-- test infinity
SELECT documentdb_api.insert_one('db','inf_col_integral',' { "_id": 0, "x": 1, "y": 2 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_col_integral',' { "_id": 1, "x": 2, "y": {"$numberDecimal": "Infinity" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_col_integral',' { "_id": 2, "x": 3, "y": {"$numberDecimal": "-Infinity" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_col_integral',' { "_id": 3, "x": 4, "y": 4 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_col_integral',' { "_id": 5, "x": 1, "y": 2 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_col_integral',' { "_id": 6, "x": 2, "y": 3 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_col_integral',' { "_id": 7, "x": 3, "y": {"$numberDecimal": "-Infinity" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_col_integral',' { "_id": 8, "x": 4, "y": {"$numberDecimal": "Infinity" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "inf_col_integral", "pipeline": [ { "$setWindowFields": { "partitionBy": "$_id", "sortBy": { "x": 1 }, "output": { "integral": { "$integral": { "input": "$y" }, "window": { "range": [ -1, 1 ]} } } } }, { "$unset": "_id" } ]}');
                                                       document                                                       
---------------------------------------------------------------------
 { "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "integral" : { "$numberDouble" : "0.0" } }
 { "x" : { "$numberInt" : "2" }, "y" : { "$numberDecimal" : "Infinity" }, "integral" : { "$numberDouble" : "0.0" } }
 { "x" : { "$numberInt" : "3" }, "y" : { "$numberDecimal" : "-Infinity" }, "integral" : { "$numberDouble" : "0.0" } }
 { "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "4" }, "integral" : { "$numberDouble" : "0.0" } }
 { "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "integral" : { "$numberDouble" : "0.0" } }
 { "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "integral" : { "$numberDouble" : "0.0" } }
 { "x" : { "$numberInt" : "3" }, "y" : { "$numberDecimal" : "-Infinity" }, "integral" : { "$numberDouble" : "0.0" } }
 { "x" : { "$numberInt" : "4" }, "y" : { "$numberDecimal" : "Infinity" }, "integral" : { "$numberDouble" : "0.0" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "inf_col_integral", "pipeline": [ { "$setWindowFields": { "partitionBy": "$_id", "sortBy": { "x": 1 }, "output": { "integral": { "$derivative": { "input": "$y" }, "window": { "range": [ -1, 1 ]} } } } }, { "$unset": "_id" } ]}');
                                           document                                            
---------------------------------------------------------------------
 { "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "integral" : null }
 { "x" : { "$numberInt" : "2" }, "y" : { "$numberDecimal" : "Infinity" }, "integral" : null }
 { "x" : { "$numberInt" : "3" }, "y" : { "$numberDecimal" : "-Infinity" }, "integral" : null }
 { "x" : { "$numberInt" : "4" }, "y" : { "$numberInt" : "4" }, "integral" : null }
 { "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "2" }, "integral" : null }
 { "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "3" }, "integral" : null }
 { "x" : { "$numberInt" : "3" }, "y" : { "$numberDecimal" : "-Infinity" }, "integral" : null }
 { "x" : { "$numberInt" : "4" }, "y" : { "$numberDecimal" : "Infinity" }, "integral" : null }
(8 rows)

-- test null
SELECT documentdb_api.insert_one('db','null_col',' { "_id": 0, "x": 1, "y": 2 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','null_col',' { "_id": 1, "x": 2, "y": null }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','null_col',' { "_id": 2, "x": 3, "y": 3 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','null_col',' { "_id": 3, "x": 4, "y": 4 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "null_col", "pipeline": [ { "$setWindowFields": { "partitionBy": "$_id", "sortBy": { "x": 1 }, "output": { "integral": { "$integral": { "input": "$y" }, "window": { "range": [ -1, 1 ]} } } } }, { "$unset": "_id" } ]}');
ERROR:  The input value of $integral window function must be a vector of 2 value, the first value must be numeric or date type and the second must be numeric.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "null_col", "pipeline": [ { "$setWindowFields": { "partitionBy": "$_id", "sortBy": { "x": 1 }, "output": { "integral": { "$derivative": { "input": "$y" }, "window": { "range": [ -1, 1 ]} } } } }, { "$unset": "_id" } ]}');
ERROR:  The input value of $derivative window function must be a vector of 2 value, the first value must be numeric or date type and the second must be numeric.
-- test decimal overflow
SELECT documentdb_api.insert_one('db', 'powerMeterDataDecimal', '{"powerMeterID": "1", "timeStamp": { "$date": { "$numberLong": "1589814630000" } }, "kilowatts": { "$numberDecimal": "1E+320" } }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerMeterDataDecimal', '{"powerMeterID": "1", "timeStamp": { "$date": { "$numberLong": "1589814690000" } }, "kilowatts": { "$numberDecimal": "2E+340" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerMeterDataDecimal', '{"powerMeterID": "1", "timeStamp": { "$date": { "$numberLong": "1589814700000" } }, "kilowatts": { "$numberDecimal": "2E+330" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerMeterDataDecimal', '{"powerMeterID": "1", "timeStamp": { "$date": { "$numberLong": "1589814800000" } }, "kilowatts": { "$numberDecimal": "3E+332" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerMeterDataDecimal', '{"powerMeterID": "1", "timeStamp": { "$date": { "$numberLong": "1589814900000" } }, "kilowatts": { "$numberDecimal": "3.123E+331" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerMeterDataDecimal", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour" }, "window": { "range": [ "unbounded", "current" ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
                                                                                                                  document                                                                                                                   
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "kilowatts" : { "$numberDecimal" : "1E+320" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814690000" } }, "kilowatts" : { "$numberDecimal" : "2E+340" }, "powerMeterKilowattHours" : { "$numberDecimal" : "1.666666666666666666675000000000000E+338" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814700000" } }, "kilowatts" : { "$numberDecimal" : "2E+330" }, "powerMeterKilowattHours" : { "$numberDecimal" : "1.944444444472222222230555555555556E+338" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814800000" } }, "kilowatts" : { "$numberDecimal" : "3E+332" }, "powerMeterKilowattHours" : { "$numberDecimal" : "1.944444486416666666675000000000000E+338" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814900000" } }, "kilowatts" : { "$numberDecimal" : "3.123E+331" }, "powerMeterKilowattHours" : { "$numberDecimal" : "1.944444532420833333341666666666667E+338" } }
(5 rows)

-- test double overflow
SELECT documentdb_api.insert_one('db', 'powerMeterDataDouble', '{"powerMeterID": "1", "timeStamp": { "$date": { "$numberLong": "1589814630000" } }, "kilowatts": 1e308 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerMeterDataDouble', '{"powerMeterID": "1", "timeStamp": { "$date": { "$numberLong": "1589814900000" } }, "kilowatts": 1e308 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerMeterDataDouble', '{"powerMeterID": "1", "timeStamp": { "$date": { "$numberLong": "1589814910000" } }, "kilowatts": 1e308 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerMeterDataDouble', '{"powerMeterID": "1", "timeStamp": { "$date": { "$numberLong": "1589814920000" } }, "kilowatts": 1e308 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'powerMeterDataDouble', '{"powerMeterID": "1", "timeStamp": { "$date": { "$numberLong": "1589814930000" } }, "kilowatts": 1e308 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "powerMeterDataDouble", "pipeline": [ { "$setWindowFields": { "partitionBy": "$powerMeterID", "sortBy": { "timeStamp": 1 }, "output": { "powerMeterKilowattHours": { "$integral": { "input": "$kilowatts", "unit": "hour" }, "window": { "range": [ "unbounded", "current" ], "unit": "hour" } } } } }, { "$unset": "_id" } ]}');
                                                                                                         document                                                                                                         
---------------------------------------------------------------------
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814630000" } }, "kilowatts" : { "$numberDouble" : "1.000000000000000011e+308" }, "powerMeterKilowattHours" : { "$numberDouble" : "0.0" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814900000" } }, "kilowatts" : { "$numberDouble" : "1.000000000000000011e+308" }, "powerMeterKilowattHours" : { "$numberDouble" : "Infinity" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814910000" } }, "kilowatts" : { "$numberDouble" : "1.000000000000000011e+308" }, "powerMeterKilowattHours" : { "$numberDouble" : "Infinity" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814920000" } }, "kilowatts" : { "$numberDouble" : "1.000000000000000011e+308" }, "powerMeterKilowattHours" : { "$numberDouble" : "Infinity" } }
 { "powerMeterID" : "1", "timeStamp" : { "$date" : { "$numberLong" : "1589814930000" } }, "kilowatts" : { "$numberDouble" : "1.000000000000000011e+308" }, "powerMeterKilowattHours" : { "$numberDouble" : "Infinity" } }
(5 rows)

---------------------------------------------------------------------
-- $shift accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- Negative Tests
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "output": "$quantity", "by": 1 }, "window": {"documents": ["unbounded", "unbounded"]}}}}}]}'); -- window not allowed with $shift
ERROR:  $shift does not accept a 'window' field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "output": "$quantity", "by": 1 }, "window": {"range": [-1, 1]}}}}}]}'); -- range not allowed with $shift
ERROR:  $shift does not accept a 'window' field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"shiftQuantity": { "$shift":  { "output": "$quantity", "by": 1 }}}}}]}'); -- missing sortBy in $setWindowFields
ERROR:  '$shift' requires a sortBy
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "by": 1 }}}}}]}'); -- missing ouput field in $shift
ERROR:  $shift requires an 'output' expression.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "output": "$quantity" }}}}}]}'); -- missing by field in $shift
ERROR:  $shift requires 'by' as an integer value.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "output": "$quantity", "by": 1.1 }}}}}]}'); -- non-integer by field in $shift
ERROR:  '$shift:by' field must be an integer, but found by: 1.1
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "output": "$quantity", "by": {"t": 1} }}}}}]}'); -- non-integer by field in $shift
ERROR:  '$shift:by' field must be an integer, but found by: { "t" : 1 }
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "output": "$quantity", "by": {"undefined": true} }}}}}]}'); -- non-integer by field in $shift
ERROR:  '$shift:by' field must be an integer, but found by: { "undefined" : true }
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "output": "$quantity", "by": 1, "default": "$quantity" }}}}}]}'); -- non-constant default expression in $shift
ERROR:  '$shift:default' expression must yield a constant value.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "output": "$quantity", "by": 1, "default": ["$sasdf"] }}}}}]}'); -- non-constant default expression in $shift
ERROR:  '$shift:default' expression must yield a constant value.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "output": "$quantity", "by": 2147483649}}}}}]}'); -- by value greater than int32 max value
ERROR:  '$shift:by' field must be an integer, but found by: 2147483649
---------------------------------------------------------------------
-- Valid tests
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "output": "$quantity", "by": 1 }}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "shiftQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "shiftQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "shiftQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "shiftQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "shiftQuantity" : null }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "shiftQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "shiftQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "shiftQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "shiftQuantity" : null }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "shiftQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "shiftQuantity" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "shiftQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "shiftQuantity" : null }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "output": "$quantity", "by": -2 }}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "shiftQuantity" : null }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "shiftQuantity" : null }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "shiftQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "shiftQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "shiftQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "shiftQuantity" : null }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "shiftQuantity" : null }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "shiftQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "shiftQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "shiftQuantity" : null }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "shiftQuantity" : null }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "shiftQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "shiftQuantity" : { "$numberInt" : "506" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "output": ["$quantity", "$cost"], "by": 0 }}}}}]}');
                                                                                                                            document                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "shiftQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "10" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "shiftQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "10" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "shiftQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "10" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "shiftQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "10" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "shiftQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "80" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "shiftQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "8" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "shiftQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "8" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "shiftQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "8" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "shiftQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "8" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "shiftQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "shiftQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "shiftQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "shiftQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "4" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "output": ["$quantity", "$cost"], "by": 1, "default": "Not available" }}}}}]}');
                                                                                                                            document                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "shiftQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "10" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "shiftQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "10" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "shiftQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "10" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "shiftQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "80" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "shiftQuantity" : "Not available" }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "shiftQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "8" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "shiftQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "8" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "shiftQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "8" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "shiftQuantity" : "Not available" }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "shiftQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "shiftQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "shiftQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "shiftQuantity" : "Not available" }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity" : 1}, "output": {"shiftQuantity": { "$shift":  { "output": ["$quantity", "$cost"], "by": -2, "default": [0, 0] }}}}}]}');
                                                                                                                            document                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "shiftQuantity" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "shiftQuantity" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "shiftQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "10" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "shiftQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "10" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "shiftQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "10" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "shiftQuantity" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "shiftQuantity" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "shiftQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "8" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "shiftQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "8" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "shiftQuantity" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "shiftQuantity" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "shiftQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "shiftQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "4" } ] }
(13 rows)

---------------------------------------------------------------------
-- $top accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$top": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"documents": ["unbounded", -1]}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : null }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : null }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : null }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$top": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$top": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$top": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
(13 rows)

---------------------------------------------------------------------
-- Document window with sort
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"expensiveQuantity": { "$top": {"output": "$quantity", "sortBy": {"cost": -1}}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"expensiveQuantity": { "$top": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"documents": ["unbounded", "current"]}}}} }]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"date": -1}, "output": {"expensiveQuantity": { "$top": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"documents": [-1, 1]}}}} }]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"expensiveQuantity": { "$top": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"range": [-3, 3]}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"expensiveQuantity": { "$top": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"range": [-20, 20], "unit": "second"}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
(13 rows)

---------------------------------------------------------------------
-- $bottom accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$bottom": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"documents": ["unbounded", -1]}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : null }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : null }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : null }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$bottom": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$bottom": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$bottom": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
(13 rows)

---------------------------------------------------------------------
-- Document window with sort
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"expensiveQuantity": { "$bottom": {"output": "$quantity", "sortBy": {"cost": -1}}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"expensiveQuantity": { "$bottom": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"documents": ["unbounded", "current"]}}}} }]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"date": -1}, "output": {"expensiveQuantity": { "$bottom": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"documents": [-1, 1]}}}} }]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"expensiveQuantity": { "$bottom": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"range": [-3, 3]}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"expensiveQuantity": { "$bottom": {"output": "$quantity", "sortBy": {"cost": -1}}, "window": {"range": [-20, 20], "unit": "second"}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "$numberInt" : "512" } }
(13 rows)

---------------------------------------------------------------------
-- $topN accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$topN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"documents": ["unbounded", -1]}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [  ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [  ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [  ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$topN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$topN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                                 document                                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$topN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
(13 rows)

---------------------------------------------------------------------
-- Document window with sort
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"expensiveQuantity": { "$topN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"expensiveQuantity": { "$topN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"documents": ["unbounded", "current"]}}}} }]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "501" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"date": -1}, "output": {"expensiveQuantity": { "$topN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"documents": [-1, 1]}}}} }]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"expensiveQuantity": { "$topN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"range": [-3, 3]}}}}}]}');
                                                                                                                                           document                                                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"expensiveQuantity": { "$topN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"range": [-20, 20], "unit": "second"}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "501" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "501" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "501" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" } ] }
(13 rows)

---------------------------------------------------------------------
-- $bottomN accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$bottomN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"documents": ["unbounded", -1]}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [  ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [  ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [  ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$bottomN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$bottomN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                                 document                                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$bottomN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
(13 rows)

---------------------------------------------------------------------
-- Document window with sort
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"expensiveQuantity": { "$bottomN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"expensiveQuantity": { "$bottomN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"documents": ["unbounded", "current"]}}}} }]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"date": -1}, "output": {"expensiveQuantity": { "$bottomN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"documents": [-1, 1]}}}} }]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "501" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"expensiveQuantity": { "$bottomN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"range": [-3, 3]}}}}}]}');
                                                                                                                                           document                                                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"expensiveQuantity": { "$bottomN": {"output": "$quantity", "sortBy": {"cost": -1}, "n": 3}, "window": {"range": [-20, 20], "unit": "second"}}}}}]}');    
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" } ] }
(13 rows)

/* Negative tests FOR $top(N)/$bottom(N) */
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "games", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$topN": [1]}}}}] }'); -- spec should be document
ERROR:  specification must be an object; found $topN :[ 1 ]
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "games", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$bottomN": "hello"}}}}] }');  -- spec should be document
ERROR:  specification must be an object; found $bottomN :"hello"
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "games", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$top": {"output": "hello"}}}}} ] }'); -- missing sortBy
ERROR:  Missing value for 'sortBy'
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "games", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$bottom": {"sortBy": {"quantity": 1}}}}}} ] }'); -- missing output field
ERROR:  Missing value for 'output'
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "games", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$topN": {"output": "hello", "sortBy": {"quantity": 1}}}}}} ] }'); -- missing n
ERROR:  Missing value for 'n'
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "games", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$bottomN": {"n": 2, "sortBy": {"quantity": 1}}}}}} ] }'); -- missing output
ERROR:  Missing value for 'output'
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "games", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$bottomN": {"output": "hello", "n": 2}}}}} ] }'); -- missing sortBy
ERROR:  Missing value for 'sortBy'
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "games", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$bottomN": {"output": "$quantity", "n": 2, "sortBy": {"quantity": 1}, "fourth": true}}}}} ] }'); -- extra field
ERROR:  Unknown argument to $bottomN 'fourth'
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "games", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$topN": {"output": "$quantity", "n": -2, "sortBy": {"quantity": 1}}}}}} ] }'); -- negative n
ERROR:  'n' must be greater than 0, found -2
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "games", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$topN": {"output": "$quantity", "n": 2.2, "sortBy": {"quantity": 1}}}}}} ] }'); -- non-integer n
ERROR:  Value for 'n' must be of integral type, but found 2.2
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "games", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$topN": {"output": "$quantity", "n": "a", "sortBy": {"quantity": 1}}}}}} ] }'); -- non-integer n
ERROR:  Value for 'n' must be of integral type, but found "a"
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "games", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$topN": {"output": "$quantity", "n": {"$undefined": true}, "sortBy": {"quantity": 1}}}}}} ] }'); -- undefined  n
ERROR:  Value for 'n' must be of integral type, but found { "$undefined" : true }
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "games", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$topN": {"output": "$quantity", "n": {"$numberDecimal": "Infinity"}, "sortBy": {"quantity": 1}}}}}} ] }'); -- undefined  n
ERROR:  Can't coerce out of range value Infinity to long
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "games", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$bottomN": {"output": "$quantity", "n": 2, "sortBy": 1}}}}} ] }'); -- sortBy is not an object
ERROR:  expected 'sortBy' to already be an object in the arguments to $bottomN
---------------------------------------------------------------------
-- $stdDevPop & $stdDevSamp accumulator tests
---------------------------------------------------------------------
-- empty collection
SELECT documentdb_api.insert_one('db','empty_stddev_col',' { "_id": 0, "num": {} }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "empty_stddev_col", "pipeline":  [{"$setWindowFields": {"output": {"stdDevPop": { "$stdDevPop": "$num"}}}}]}');
                               document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : {  }, "stdDevPop" : null }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "empty_stddev_col", "pipeline":  [{"$setWindowFields": {"output": {"stdDevSamp": { "$stdDevSamp": "$num"}}}}]}');
                               document                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : {  }, "stdDevSamp" : null }
(1 row)

-- collection with single document
SELECT documentdb_api.insert_one('db','single_stddev_col',' { "_id": 0, "num": 1 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "single_stddev_col", "pipeline":  [{"$setWindowFields": {"output": {"stdDevPop": { "$stdDevPop": "$num"}}}}]}');
                                                   document                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "1" }, "stdDevPop" : { "$numberDouble" : "0.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "single_stddev_col", "pipeline":  [{"$setWindowFields": {"output": {"stdDevSamp": { "$stdDevSamp": "$num"}}}}]}');
                                        document                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "1" }, "stdDevSamp" : null }
(1 row)

-- document with non-numeric values
SELECT documentdb_api.insert_one('db','non_numeric_stddev_col',' { "_id": 0, "num": "a"}');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','non_numeric_stddev_col',' { "_id": 1, "num": "c"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "non_numeric_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : "a", "stdDevPop" : null }
 { "_id" : { "$numberInt" : "1" }, "num" : "c", "stdDevPop" : null }
(2 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "non_numeric_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                               document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : "a", "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "num" : "c", "stdDevSamp" : null }
(2 rows)

-- document with mixed values
SELECT documentdb_api.insert_one('db','mixed_stddev_col',' { "_id": 0, "num": "a" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','mixed_stddev_col',' { "_id": 1, "num": 0 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','mixed_stddev_col',' { "_id": 2, "num": "b" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','mixed_stddev_col',' { "_id": 3, "num": 1 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "mixed_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                   document                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : "a", "stdDevPop" : null }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "0" }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "2" }, "num" : "b", "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "1" }, "stdDevPop" : { "$numberDouble" : "0.5" } }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "mixed_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                             document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : "a", "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "0" }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "num" : "b", "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "1" }, "stdDevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
(4 rows)

-- document with NAN values
SELECT documentdb_api.insert_one('db','nan_stddev_col',' { "_id": 0, "num": 2 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','nan_stddev_col',' { "_id": 1, "num": 3 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','nan_stddev_col',' { "_id": 2, "num": {"$numberDecimal": "NaN" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','nan_stddev_col',' { "_id": 3, "num": 4 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "nan_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                      document                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberDecimal" : "NaN" }, "stdDevPop" : { "$numberDouble" : "NaN" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "4" }, "stdDevPop" : { "$numberDouble" : "NaN" } }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "nan_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                             document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "stdDevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberDecimal" : "NaN" }, "stdDevSamp" : { "$numberDouble" : "NaN" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "4" }, "stdDevSamp" : { "$numberDouble" : "NaN" } }
(4 rows)

-- document with Infinity values
SELECT documentdb_api.insert_one('db','inf_stddev_col',' { "_id": 0, "type": "a", "num": 2 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_stddev_col',' { "_id": 1, "type": "a", "num": {"$numberDecimal": "Infinity" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_stddev_col',' { "_id": 2, "type": "a", "num": {"$numberDecimal": "-Infinity" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_stddev_col',' { "_id": 3, "type": "a", "num": 4 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_stddev_col',' { "_id": 5, "type": "b", "num": 2 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_stddev_col',' { "_id": 6, "type": "b", "num": 3 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_stddev_col',' { "_id": 7, "type": "b", "num": {"$numberDecimal": "-Infinity" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','inf_stddev_col',' { "_id": 8, "type": "b", "num": {"$numberDecimal": "Infinity" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "inf_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                document                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "type" : "a", "num" : { "$numberInt" : "2" }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "type" : "a", "num" : { "$numberDecimal" : "Infinity" }, "stdDevPop" : { "$numberDouble" : "NaN" } }
 { "_id" : { "$numberInt" : "2" }, "type" : "a", "num" : { "$numberDecimal" : "-Infinity" }, "stdDevPop" : { "$numberDouble" : "NaN" } }
 { "_id" : { "$numberInt" : "3" }, "type" : "a", "num" : { "$numberInt" : "4" }, "stdDevPop" : { "$numberDouble" : "NaN" } }
 { "_id" : { "$numberInt" : "5" }, "type" : "b", "num" : { "$numberInt" : "2" }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "6" }, "type" : "b", "num" : { "$numberInt" : "3" }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "7" }, "type" : "b", "num" : { "$numberDecimal" : "-Infinity" }, "stdDevPop" : { "$numberDouble" : "NaN" } }
 { "_id" : { "$numberInt" : "8" }, "type" : "b", "num" : { "$numberDecimal" : "Infinity" }, "stdDevPop" : { "$numberDouble" : "NaN" } }
(8 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "inf_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"stddevSamp": { "$stdDevSamp": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                    document                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "type" : "a", "num" : { "$numberInt" : "2" }, "stddevSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "type" : "a", "num" : { "$numberDecimal" : "Infinity" }, "stddevSamp" : { "$numberDouble" : "NaN" } }
 { "_id" : { "$numberInt" : "2" }, "type" : "a", "num" : { "$numberDecimal" : "-Infinity" }, "stddevSamp" : { "$numberDouble" : "NaN" } }
 { "_id" : { "$numberInt" : "3" }, "type" : "a", "num" : { "$numberInt" : "4" }, "stddevSamp" : { "$numberDouble" : "NaN" } }
 { "_id" : { "$numberInt" : "5" }, "type" : "b", "num" : { "$numberInt" : "2" }, "stddevSamp" : null }
 { "_id" : { "$numberInt" : "6" }, "type" : "b", "num" : { "$numberInt" : "3" }, "stddevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
 { "_id" : { "$numberInt" : "7" }, "type" : "b", "num" : { "$numberDecimal" : "-Infinity" }, "stddevSamp" : { "$numberDouble" : "NaN" } }
 { "_id" : { "$numberInt" : "8" }, "type" : "b", "num" : { "$numberDecimal" : "Infinity" }, "stddevSamp" : { "$numberDouble" : "NaN" } }
(8 rows)

-- document with Decimal128 values
SELECT documentdb_api.insert_one('db','decimal_stddev_col',' { "_id": 0, "num": 2 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','decimal_stddev_col',' { "_id": 1, "num": 3 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','decimal_stddev_col',' { "_id": 2, "num": {"$numberDecimal": "4.0" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','decimal_stddev_col',' { "_id": 3, "num": 5 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "decimal_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                document                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberDecimal" : "4.0" }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "decimal_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                             document                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "stdDevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberDecimal" : "4.0" }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "stdDevSamp" : { "$numberDouble" : "1.2909944487358055998" } }
(4 rows)

-- number overflow
SELECT documentdb_api.insert_one('db','overflow_stddev_col',' { "_id": 0, "num": {"$numberDecimal": "100000004"} }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','overflow_stddev_col',' { "_id": 1, "num": {"$numberDecimal": "10000000007"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','overflow_stddev_col',' { "_id": 2, "num": {"$numberDecimal": "1000000000000013"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','overflow_stddev_col',' { "_id": 3, "num": {"$numberDecimal": "1000000000000000000"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "overflow_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberDecimal" : "100000004" }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberDecimal" : "10000000007" }, "stdDevPop" : { "$numberDouble" : "4950000001.5" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberDecimal" : "1000000000000013" }, "stdDevPop" : { "$numberDouble" : "471402140215531.1875" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberDecimal" : "1000000000000000000" }, "stdDevPop" : { "$numberDouble" : "432868555379387136.0" } }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "overflow_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                       document                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberDecimal" : "100000004" }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberDecimal" : "10000000007" }, "stdDevSamp" : { "$numberDouble" : "7000357135.8681402206" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberDecimal" : "1000000000000013" }, "stdDevSamp" : { "$numberDouble" : "577347353591990.5" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberDecimal" : "1000000000000000000" }, "stdDevSamp" : { "$numberDouble" : "499833553944027136.0" } }
(4 rows)

-- long values return double
SELECT documentdb_api.insert_one('db','long_stddev_col',' { "_id": 0, "x": 1, "num": {"$numberLong": "10000000004"} }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','long_stddev_col',' { "_id": 1, "x": 2, "num": {"$numberLong": "10000000007"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','long_stddev_col',' { "_id": 2, "x": 3, "num": {"$numberLong": "10000000013"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','long_stddev_col',' { "_id": 3, "x": 4, "num": {"$numberLong": "10000000016"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                 document                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "num" : { "$numberLong" : "10000000004" }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "num" : { "$numberLong" : "10000000007" }, "stdDevPop" : { "$numberDouble" : "1.5" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "num" : { "$numberLong" : "10000000013" }, "stdDevPop" : { "$numberDouble" : "3.7416573867739413295" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "num" : { "$numberLong" : "10000000016" }, "stdDevPop" : { "$numberDouble" : "4.7434164902525690621" } }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                 document                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "num" : { "$numberLong" : "10000000004" }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "num" : { "$numberLong" : "10000000007" }, "stdDevSamp" : { "$numberDouble" : "2.1213203435596423851" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "num" : { "$numberLong" : "10000000013" }, "stdDevSamp" : { "$numberDouble" : "4.582575694955839829" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "num" : { "$numberLong" : "10000000016" }, "stdDevSamp" : { "$numberDouble" : "5.4772255750516611883" } }
(4 rows)

-- large values return nan
SELECT documentdb_api.insert_one('db','large_stddev_col',' { "_id": 0, "num": {"$numberDecimal": "1E+310" } }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','large_stddev_col',' { "_id": 1, "num": {"$numberDecimal": "2E+310" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "large_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": 1, "sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num"}}}}]}');
                                                        document                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberDecimal" : "1E+310" }, "stdDevPop" : { "$numberDouble" : "NaN" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberDecimal" : "2E+310" }, "stdDevPop" : { "$numberDouble" : "NaN" } }
(2 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "large_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": 1, "sortBy": { "_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num"}}}}]}');
                                                        document                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberDecimal" : "1E+310" }, "stdDevSamp" : { "$numberDouble" : "NaN" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberDecimal" : "2E+310" }, "stdDevSamp" : { "$numberDouble" : "NaN" } }
(2 rows)

-- evaluate data in expression
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": {"$multiply": ["$x", "$num"]}, "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                 document                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "num" : { "$numberLong" : "10000000004" }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "num" : { "$numberLong" : "10000000007" }, "stdDevPop" : { "$numberDouble" : "5000000005.0" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "num" : { "$numberLong" : "10000000013" }, "stdDevPop" : { "$numberDouble" : "8164965823.5659503937" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "num" : { "$numberLong" : "10000000016" }, "stdDevPop" : { "$numberDouble" : "11180339910.418645859" } }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": {"$multiply": ["$x", "$num"]}, "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                 document                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "num" : { "$numberLong" : "10000000004" }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "num" : { "$numberLong" : "10000000007" }, "stdDevSamp" : { "$numberDouble" : "7071067818.936542511" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "num" : { "$numberLong" : "10000000013" }, "stdDevSamp" : { "$numberDouble" : "10000000017.5" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "num" : { "$numberLong" : "10000000016" }, "stdDevSamp" : { "$numberDouble" : "12909944513.823442459" } }
(4 rows)

-- array value
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": ["$num"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                            document                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "num" : { "$numberLong" : "10000000004" }, "stdDevPop" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "num" : { "$numberLong" : "10000000007" }, "stdDevPop" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "num" : { "$numberLong" : "10000000013" }, "stdDevPop" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "num" : { "$numberLong" : "10000000016" }, "stdDevPop" : null }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": ["$num"], "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                             document                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "num" : { "$numberLong" : "10000000004" }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "num" : { "$numberLong" : "10000000007" }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "num" : { "$numberLong" : "10000000013" }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "num" : { "$numberLong" : "10000000016" }, "stdDevSamp" : null }
(4 rows)

-- negative cases
-- incorrect arguments won't throw error
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": 3, "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                        document                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "num" : { "$numberLong" : "10000000004" }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "num" : { "$numberLong" : "10000000007" }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "num" : { "$numberLong" : "10000000013" }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "num" : { "$numberLong" : "10000000016" }, "stdDevPop" : { "$numberDouble" : "0.0" } }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": {"a": "$num"}, "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                            document                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "num" : { "$numberLong" : "10000000004" }, "stdDevPop" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "num" : { "$numberLong" : "10000000007" }, "stdDevPop" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "num" : { "$numberLong" : "10000000013" }, "stdDevPop" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "num" : { "$numberLong" : "10000000016" }, "stdDevPop" : null }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": 3, "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                        document                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "num" : { "$numberLong" : "10000000004" }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "num" : { "$numberLong" : "10000000007" }, "stdDevSamp" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "num" : { "$numberLong" : "10000000013" }, "stdDevSamp" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "num" : { "$numberLong" : "10000000016" }, "stdDevSamp" : { "$numberDouble" : "0.0" } }
(4 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "long_stddev_col", "pipeline":  [{"$setWindowFields": {"sortBy": { "_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": {"a": "$x"}, "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                             document                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "x" : { "$numberInt" : "1" }, "num" : { "$numberLong" : "10000000004" }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "x" : { "$numberInt" : "2" }, "num" : { "$numberLong" : "10000000007" }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "x" : { "$numberInt" : "3" }, "num" : { "$numberLong" : "10000000013" }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "x" : { "$numberInt" : "4" }, "num" : { "$numberLong" : "10000000016" }, "stdDevSamp" : null }
(4 rows)

SELECT documentdb_api.insert_one('db','window_stddev_col',' { "_id": 0, "num": 2, "type": "a", "date": { "$date": { "$numberLong": "1718841600000" } } }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_stddev_col',' { "_id": 1, "num": 3, "type": "a", "date": { "$date": { "$numberLong": "1718841605000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_stddev_col',' { "_id": 2, "num": 4, "type": "a", "date": { "$date": { "$numberLong": "1718841610000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_stddev_col',' { "_id": 3, "num": 5, "type": "a", "date": { "$date": { "$numberLong": "1718841615000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_stddev_col',' { "_id": 4, "num": 6, "type": "a", "date": { "$date": { "$numberLong": "1718841620000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_stddev_col',' { "_id": 5, "num": 7, "type": "a", "date": { "$date": { "$numberLong": "1718841630000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_stddev_col',' { "_id": 6, "num": 8, "type": "b", "date": { "$date": { "$numberLong": "1718841640000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_stddev_col',' { "_id": 7, "num": 9, "type": "b", "date": { "$date": { "$numberLong": "1718841680000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_stddev_col',' { "_id": 8, "num": 10, "type": "b", "date": { "$date": { "$numberLong": "1718841700000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_stddev_col',' { "_id": 9, "num": 11, "type": "b", "date": { "$date": { "$numberLong": "1718841800000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_stddev_col',' { "_id": 10, "num": 12, "type": "b", "date": { "$date": { "$numberLong": "1718841900000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','window_stddev_col',' { "_id": 11, "num": 13, "type": "b", "date": { "$date": { "$numberLong": "1718842600000" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- without window
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"_id": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num"}}}}]}');
                                                                                                  document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num"}}}}]}');
                                                                                                   document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
(12 rows)

-- document window
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                   document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                         document                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                  document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                   document                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": {"documents": ["current", "current"]}}}}}]}');
                                                                              document                                                                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevSamp" : null }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                   document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
(12 rows)

-- range window
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"_id": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": {"range": [-2, 1]}}}}}]}');
                                                                                                   document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": {"range": [-3, 3], "unit": "minute"}}}}}]}');
                                                                                                  document                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevPop" : { "$numberDouble" : "1.4142135623730951455" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": {"range": [-2, 1]}}}}}]}');
                                                                                                   document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevSamp" : { "$numberDouble" : "1.2909944487358055998" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevSamp" : { "$numberDouble" : "1.2909944487358055998" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevSamp" : { "$numberDouble" : "1.2909944487358055998" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevSamp" : { "$numberDouble" : "1.2909944487358055998" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevSamp" : { "$numberDouble" : "1.2909944487358055998" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevSamp" : { "$numberDouble" : "1.2909944487358055998" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"date": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": {"range": [-3, 3], "unit": "minute"}}}}}]}');
                                                                                                   document                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevSamp" : { "$numberDouble" : "1.2909944487358055998" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevSamp" : { "$numberDouble" : "1.2909944487358055998" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevSamp" : { "$numberDouble" : "1.2909944487358055998" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevSamp" : { "$numberDouble" : "1.5811388300841897614" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevSamp" : null }
(12 rows)

-- unsharded collection
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": { "documents": ["unbounded", -1]}}}}}]}');
                                                                                                  document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevPop" : null }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevPop" : { "$numberDouble" : "1.4142135623730951455" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevPop" : null }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevPop" : { "$numberDouble" : "1.4142135623730951455" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                                  document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevPop" : { "$numberDouble" : "1.4142135623730951455" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevPop" : { "$numberDouble" : "1.4142135623730951455" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": {"documents": ["unbounded", "current"]}}}}}]}');
                                                                                                   document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevSamp" : { "$numberDouble" : "1.2909944487358055998" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevSamp" : { "$numberDouble" : "1.5811388300841897614" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevSamp" : { "$numberDouble" : "1.2909944487358055998" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevSamp" : { "$numberDouble" : "1.5811388300841897614" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": { "$cond": [{ "$eq": [{ "$mod": ["$_id", 2] }, 0] }, "even", "odd"] }, "sortBy": { "date": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                                  document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevPop" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevPop" : { "$numberDouble" : "1.6329931618554520689" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevPop" : { "$numberDouble" : "2.2360679774997898051" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevPop" : { "$numberDouble" : "2.8284271247461902909" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevPop" : { "$numberDouble" : "3.4156502553198659911" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevPop" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevPop" : { "$numberDouble" : "1.6329931618554520689" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevPop" : { "$numberDouble" : "2.2360679774997898051" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevPop" : { "$numberDouble" : "2.8284271247461902909" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevPop" : { "$numberDouble" : "3.4156502553198659911" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": { "$cond": [{ "$eq": [{ "$mod": ["$_id", 2] }, 0] }, "even", "odd"] }, "sortBy": {"date": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": {"documents": ["unbounded", "current"]}}}}}]}');
                                                                                                   document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevSamp" : { "$numberDouble" : "1.4142135623730951455" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevSamp" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevSamp" : { "$numberDouble" : "2.5819888974716111996" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevSamp" : { "$numberDouble" : "3.1622776601683795228" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevSamp" : { "$numberDouble" : "3.7416573867739413295" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevSamp" : { "$numberDouble" : "1.4142135623730951455" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevSamp" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevSamp" : { "$numberDouble" : "2.5819888974716111996" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevSamp" : { "$numberDouble" : "3.1622776601683795228" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevSamp" : { "$numberDouble" : "3.7416573867739413295" } }
(12 rows)

-- shard collection
SELECT documentdb_api.shard_collection('db', 'window_stddev_col', '{ "type": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": { "documents": ["unbounded", -1]}}}}}]}');
                                                                                                  document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevPop" : null }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevPop" : { "$numberDouble" : "1.4142135623730951455" } }
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevPop" : null }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevPop" : { "$numberDouble" : "1.4142135623730951455" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": { "_id": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                                  document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevPop" : { "$numberDouble" : "1.4142135623730951455" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevPop" : { "$numberDouble" : "0.5" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevPop" : { "$numberDouble" : "0.81649658092772603446" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevPop" : { "$numberDouble" : "1.1180339887498949025" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevPop" : { "$numberDouble" : "1.4142135623730951455" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevPop" : { "$numberDouble" : "1.7078251276599329955" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": "$type", "sortBy": {"_id": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": {"documents": ["unbounded", "current"]}}}}}]}');
                                                                                                   document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevSamp" : { "$numberDouble" : "1.2909944487358055998" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevSamp" : { "$numberDouble" : "1.5811388300841897614" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevSamp" : { "$numberDouble" : "0.70710678118654757274" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevSamp" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevSamp" : { "$numberDouble" : "1.2909944487358055998" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevSamp" : { "$numberDouble" : "1.5811388300841897614" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevSamp" : { "$numberDouble" : "1.8708286933869706647" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": { "$cond": [{ "$eq": [{ "$mod": ["$_id", 2] }, 0] }, "even", "odd"] }, "sortBy": { "date": 1}, "output": {"stdDevPop": { "$stdDevPop": "$num", "window": { "documents": ["unbounded", "current"]}}}}}]}');
                                                                                                  document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevPop" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevPop" : { "$numberDouble" : "1.6329931618554520689" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevPop" : { "$numberDouble" : "2.2360679774997898051" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevPop" : { "$numberDouble" : "2.8284271247461902909" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevPop" : { "$numberDouble" : "3.4156502553198659911" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevPop" : { "$numberDouble" : "0.0" } }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevPop" : { "$numberDouble" : "1.0" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevPop" : { "$numberDouble" : "1.6329931618554520689" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevPop" : { "$numberDouble" : "2.2360679774997898051" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevPop" : { "$numberDouble" : "2.8284271247461902909" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevPop" : { "$numberDouble" : "3.4156502553198659911" } }
(12 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "window_stddev_col", "pipeline":  [{"$setWindowFields": {"partitionBy": { "$cond": [{ "$eq": [{ "$mod": ["$_id", 2] }, 0] }, "even", "odd"] }, "sortBy": {"date": 1}, "output": {"stdDevSamp": { "$stdDevSamp": "$num", "window": {"documents": ["unbounded", "current"]}}}}}]}');
                                                                                                   document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "num" : { "$numberInt" : "2" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "2" }, "num" : { "$numberInt" : "4" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "stdDevSamp" : { "$numberDouble" : "1.4142135623730951455" } }
 { "_id" : { "$numberInt" : "4" }, "num" : { "$numberInt" : "6" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "stdDevSamp" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "6" }, "num" : { "$numberInt" : "8" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "stdDevSamp" : { "$numberDouble" : "2.5819888974716111996" } }
 { "_id" : { "$numberInt" : "8" }, "num" : { "$numberInt" : "10" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "stdDevSamp" : { "$numberDouble" : "3.1622776601683795228" } }
 { "_id" : { "$numberInt" : "10" }, "num" : { "$numberInt" : "12" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "stdDevSamp" : { "$numberDouble" : "3.7416573867739413295" } }
 { "_id" : { "$numberInt" : "1" }, "num" : { "$numberInt" : "3" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "stdDevSamp" : null }
 { "_id" : { "$numberInt" : "3" }, "num" : { "$numberInt" : "5" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "stdDevSamp" : { "$numberDouble" : "1.4142135623730951455" } }
 { "_id" : { "$numberInt" : "5" }, "num" : { "$numberInt" : "7" }, "type" : "a", "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "stdDevSamp" : { "$numberDouble" : "2.0" } }
 { "_id" : { "$numberInt" : "7" }, "num" : { "$numberInt" : "9" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "stdDevSamp" : { "$numberDouble" : "2.5819888974716111996" } }
 { "_id" : { "$numberInt" : "9" }, "num" : { "$numberInt" : "11" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "stdDevSamp" : { "$numberDouble" : "3.1622776601683795228" } }
 { "_id" : { "$numberInt" : "11" }, "num" : { "$numberInt" : "13" }, "type" : "b", "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "stdDevSamp" : { "$numberDouble" : "3.7416573867739413295" } }
(12 rows)

---------------------------------------------------------------------
-- $first accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- No window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"firstDate": { "$first": {"output": "$date"}}}}}]}');
                                                                                                                               document                                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841600000" } } } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841600000" } } } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841600000" } } } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841600000" } } } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841600000" } } } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841620000" } } } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841620000" } } } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841620000" } } } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841620000" } } } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841630000" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841630000" } } } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841630000" } } } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841630000" } } } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"expensiveQuantity": { "$first": {"output": "$quantity", "sortBy": {"cost": -1}}}}}}]}'); -- the sortBy inside $first is just treated as output expression
                                                                                                                                               document                                                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "515" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "515" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "515" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "515" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "515" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "511" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "511" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "511" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "511" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "512" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "512" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "512" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "512" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
(13 rows)

---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$first": "$quantity", "window": {"documents": ["unbounded", -1]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : null }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : null }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : null }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : { "$numberInt" : "503" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$first": "$quantity", "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$first": "$quantity", "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$first": "$quantity", "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : { "$numberInt" : "503" } }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"expensiveQuantity": { "$first": {"quantity": "$quantity", "cost": "$cost"}, "window": {"range": [-3, 3]}}}}}]}');
                                                                                                                                         document                                                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "504" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "507" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "515" }, "cost" : { "$numberInt" : "80" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "502" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "502" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "505" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "508" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "503" }, "cost" : { "$numberInt" : "4" } } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "503" }, "cost" : { "$numberInt" : "4" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "506" }, "cost" : { "$numberInt" : "4" } } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "509" }, "cost" : { "$numberInt" : "4" } } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"expensiveQuantity": { "$first": {"quantity": "$quantity", "cost": "$cost"}, "window": {"range": [-20, 20], "unit": "second"}}}}}]}');
                                                                                                                                         document                                                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "507" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "510" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "502" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "502" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "508" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "511" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "503" }, "cost" : { "$numberInt" : "4" } } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "503" }, "cost" : { "$numberInt" : "4" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "509" }, "cost" : { "$numberInt" : "4" } } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "512" }, "cost" : { "$numberInt" : "4" } } }
(13 rows)

---------------------------------------------------------------------
-- $last accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- No window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"firstDate": { "$last": {"output": "$date"}}}}}]}');
                                                                                                                               document                                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841600000" } } } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841600000" } } } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841600000" } } } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841600000" } } } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841600000" } } } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841605000" } } } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841605000" } } } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841605000" } } } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841605000" } } } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841700000" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841700000" } } } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841700000" } } } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "firstDate" : { "output" : { "$date" : { "$numberLong" : "1718841700000" } } } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"expensiveQuantity": { "$last": {"output": "$quantity", "sortBy": {"cost": -1}}}}}}]}'); -- the sortBy inside $last is just treated as output expression
                                                                                                                                               document                                                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "501" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "501" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "501" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "501" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "501" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "502" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "502" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "502" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "502" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "503" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "503" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "503" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "output" : { "$numberInt" : "503" }, "sortBy" : { "cost" : { "$numberInt" : "-1" } } } }
(13 rows)

---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$last": "$quantity", "window": {"documents": ["unbounded", -1]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : null }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : null }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : null }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$last": "$quantity", "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$last": "$quantity", "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$last": "$quantity", "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : { "$numberInt" : "512" } }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"expensiveQuantity": { "$last": {"quantity": "$quantity", "cost": "$cost"}, "window": {"range": [-3, 3]}}}}}]}');
                                                                                                                                         document                                                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "504" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "507" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "510" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "510" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "515" }, "cost" : { "$numberInt" : "80" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "505" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "508" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "511" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "511" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "506" }, "cost" : { "$numberInt" : "4" } } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "509" }, "cost" : { "$numberInt" : "4" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "512" }, "cost" : { "$numberInt" : "4" } } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "512" }, "cost" : { "$numberInt" : "4" } } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"expensiveQuantity": { "$last": {"quantity": "$quantity", "cost": "$cost"}, "window": {"range": [-20, 20], "unit": "second"}}}}}]}');
                                                                                                                                         document                                                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "504" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "504" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "504" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "507" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "510" }, "cost" : { "$numberInt" : "10" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "505" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "505" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "508" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "511" }, "cost" : { "$numberInt" : "8" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "506" }, "cost" : { "$numberInt" : "4" } } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "506" }, "cost" : { "$numberInt" : "4" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "509" }, "cost" : { "$numberInt" : "4" } } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : { "quantity" : { "$numberInt" : "512" }, "cost" : { "$numberInt" : "4" } } }
(13 rows)

    
---------------------------------------------------------------------
-- $firstN accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- No window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"firstDate": { "$firstN": {"input": "$date", "n": 2}}}}}]}');
                                                                                                                                                   document                                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "firstDate" : [ { "$date" : { "$numberLong" : "1718841600000" } }, { "$date" : { "$numberLong" : "1718841615000" } } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "firstDate" : [ { "$date" : { "$numberLong" : "1718841600000" } }, { "$date" : { "$numberLong" : "1718841615000" } } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "firstDate" : [ { "$date" : { "$numberLong" : "1718841600000" } }, { "$date" : { "$numberLong" : "1718841615000" } } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "firstDate" : [ { "$date" : { "$numberLong" : "1718841600000" } }, { "$date" : { "$numberLong" : "1718841615000" } } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "firstDate" : [ { "$date" : { "$numberLong" : "1718841600000" } }, { "$date" : { "$numberLong" : "1718841615000" } } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "firstDate" : [ { "$date" : { "$numberLong" : "1718841620000" } }, { "$date" : { "$numberLong" : "1718841900000" } } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "firstDate" : [ { "$date" : { "$numberLong" : "1718841620000" } }, { "$date" : { "$numberLong" : "1718841900000" } } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "firstDate" : [ { "$date" : { "$numberLong" : "1718841620000" } }, { "$date" : { "$numberLong" : "1718841900000" } } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "firstDate" : [ { "$date" : { "$numberLong" : "1718841620000" } }, { "$date" : { "$numberLong" : "1718841900000" } } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "firstDate" : [ { "$date" : { "$numberLong" : "1718841630000" } }, { "$date" : { "$numberLong" : "1718841610000" } } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "firstDate" : [ { "$date" : { "$numberLong" : "1718841630000" } }, { "$date" : { "$numberLong" : "1718841610000" } } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "firstDate" : [ { "$date" : { "$numberLong" : "1718841630000" } }, { "$date" : { "$numberLong" : "1718841610000" } } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "firstDate" : [ { "$date" : { "$numberLong" : "1718841630000" } }, { "$date" : { "$numberLong" : "1718841610000" } } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"expensiveQuantity": { "$firstN": {"input": "$quantity", "n": 3}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
(13 rows)

---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$firstN": {"input": "$quantity", "n": 3}, "window": {"documents": ["unbounded", -1]}}}}}]}');
                                                                                                                                         document                                                                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [  ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : [  ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : [  ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$firstN": {"input": "$quantity", "n": 3}, "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                                                         document                                                                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$firstN": {"input": "$quantity", "n": 4}, "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : [ { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : [ { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : [ { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : [ { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : [ { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : [ { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : [ { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : [ { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : [ { "$numberInt" : "512" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$firstN": {"input": "$quantity", "n": 5}, "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                                                                                   document                                                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"expensiveQuantity": { "$firstN": {"input": {"quantity": "$quantity", "cost": "$cost"}, "n": 3}, "window": {"range": [-3, 3]}}}}}]}');
                                                                                                                                                                                                                       document                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "504" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "504" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "507" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "504" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "507" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "510" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "507" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "510" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "515" }, "cost" : { "$numberInt" : "80" } } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "502" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "505" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "502" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "505" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "508" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "505" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "508" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "511" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "508" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "511" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "503" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "506" }, "cost" : { "$numberInt" : "4" } } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "503" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "506" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "509" }, "cost" : { "$numberInt" : "4" } } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "506" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "509" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "512" }, "cost" : { "$numberInt" : "4" } } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "509" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "512" }, "cost" : { "$numberInt" : "4" } } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"expensiveQuantity": { "$firstN": {"input": {"quantity": "$quantity", "cost": "$cost"}, "n": 2}, "window": {"range": [-20, 20], "unit": "second"}}}}}]}');
                                                                                                                                                                                 document                                                                                                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "515" }, "cost" : { "$numberInt" : "80" } } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "515" }, "cost" : { "$numberInt" : "80" } } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "515" }, "cost" : { "$numberInt" : "80" } } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "507" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "510" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "502" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "505" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "502" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "505" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "508" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "511" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "503" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "506" }, "cost" : { "$numberInt" : "4" } } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "503" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "506" }, "cost" : { "$numberInt" : "4" } } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "509" }, "cost" : { "$numberInt" : "4" } } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "512" }, "cost" : { "$numberInt" : "4" } } ] }
(13 rows)

---------------------------------------------------------------------
-- $lastN accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- No window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": { "$lastN": {"input": "$quantity", "n": 2}}}}}]}');
                                                                                                                          document                                                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "lastDate" : [ { "$numberInt" : "501" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "lastDate" : [ { "$numberInt" : "501" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "lastDate" : [ { "$numberInt" : "501" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "lastDate" : [ { "$numberInt" : "501" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "lastDate" : [ { "$numberInt" : "501" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "lastDate" : [ { "$numberInt" : "502" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "lastDate" : [ { "$numberInt" : "502" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "lastDate" : [ { "$numberInt" : "502" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "lastDate" : [ { "$numberInt" : "502" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "lastDate" : [ { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "lastDate" : [ { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "lastDate" : [ { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "lastDate" : [ { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"expensiveQuantity": { "$lastN": {"input": "$quantity", "n": 3}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
(13 rows)

---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$lastN": {"input": "$quantity", "n": 3}, "window": {"documents": ["unbounded", -1]}}}}}]}');
                                                                                                                                         document                                                                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [  ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : [  ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : [  ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$lastN": {"input": "$quantity", "n": 3}, "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                                                         document                                                                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$lastN": {"input": "$quantity", "n": 4}, "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : [ { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : [ { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : [ { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : [ { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : [ { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : [ { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : [ { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : [ { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : [ { "$numberInt" : "512" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"cheapQuantity": { "$lastN": {"input": "$quantity", "n": 5}, "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                                                                                   document                                                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "cheapQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "cheapQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "cheapQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "cheapQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "cheapQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "cheapQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "cheapQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "cheapQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "cheapQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "cheapQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "cheapQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "cheapQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"expensiveQuantity": { "$lastN": {"input": {"quantity": "$quantity", "cost": "$cost"}, "n": 3}, "window": {"range": [-3, 3]}}}}}]}');
                                                                                                                                                                                                                       document                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "504" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "507" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "504" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "510" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "507" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "504" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "510" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "507" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "515" }, "cost" : { "$numberInt" : "80" } } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "505" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "502" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "508" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "505" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "502" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "511" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "508" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "505" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "511" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "508" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "506" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "503" }, "cost" : { "$numberInt" : "4" } } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "509" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "506" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "503" }, "cost" : { "$numberInt" : "4" } } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "512" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "509" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "506" }, "cost" : { "$numberInt" : "4" } } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "512" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "509" }, "cost" : { "$numberInt" : "4" } } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"expensiveQuantity": { "$lastN": {"input": {"quantity": "$quantity", "cost": "$cost"}, "n": 2}, "window": {"range": [-20, 20], "unit": "second"}}}}}]}');
                                                                                                                                                                                 document                                                                                                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "504" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "504" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "504" }, "cost" : { "$numberInt" : "10" } }, { "quantity" : { "$numberInt" : "501" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "507" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "510" }, "cost" : { "$numberInt" : "10" } } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "505" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "502" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "505" }, "cost" : { "$numberInt" : "8" } }, { "quantity" : { "$numberInt" : "502" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "508" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "511" }, "cost" : { "$numberInt" : "8" } } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "506" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "503" }, "cost" : { "$numberInt" : "4" } } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "506" }, "cost" : { "$numberInt" : "4" } }, { "quantity" : { "$numberInt" : "503" }, "cost" : { "$numberInt" : "4" } } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "509" }, "cost" : { "$numberInt" : "4" } } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "quantity" : { "$numberInt" : "512" }, "cost" : { "$numberInt" : "4" } } ] }
(13 rows)

/* Negative tests for $firstN/$lastN */
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$firstN": [1]}}}}] }'); -- spec should be document
ERROR:  specification must be an object; found $firstN :[ 1 ]
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$lastN": "hello"}}}}] }');  -- spec should be document
ERROR:  specification must be an object; found $lastN :"hello"
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$firstN": {"input": "hello"}}}}} ] }'); -- missing n
ERROR:  $firstN requires an 'n' field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$lastN": {"n": 2}}}}} ] }'); -- missing input
ERROR:  $lastN requires an 'input' field
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$lastN": {"input": "$quantity", "n": 2, "third": true}}}}} ] }'); -- extra field
ERROR:  $lastN found an unknown argument: third
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$firstN": {"input": "$quantity", "n": -2}}}}} ] }'); -- negative n
ERROR:  'n' must be greater than 0, found -2
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$firstN": {"input": "$quantity", "n": 2.2}}}}} ] }'); -- non-integer n
ERROR:  Value for 'n' must be of integral type, but found 2.2
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$firstN": {"input": "$quantity", "n": "a"}}}}} ] }'); -- non-integer n
ERROR:  Value for 'n' must be of integral type, but found "a"
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$firstN": {"input": "$quantity", "n": {"$undefined": true}}}}}} ] }'); -- undefined  n
ERROR:  Value for 'n' must be of integral type, but found { "$undefined" : true }
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [ {"$setWindowFields": {"partitionBy": "$a", "output": {"lastDate": {"$firstN": {"input": "$quantity", "n": {"$numberDecimal": "Infinity"}}}}}} ] }'); -- undefined  n
ERROR:  Can't coerce out of range value Infinity to long
/* Test $first, $last, $firstN, $lastN with $group stage as code path is common with $setWindowFields */
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [{"$group": {"_id": "$a", "res": {"$firstN": {"input": "$quantity", "n": 3 }}}}] }');
                                                  document                                                   
---------------------------------------------------------------------
 { "_id" : "abc", "res" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : "def", "res" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : "ghi", "res" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" }, { "$numberInt" : "512" } ] }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [{"$group": {"_id": "$a", "res": {"$lastN": {"input": "$quantity", "n": 3}}}}] }');
                                                  document                                                   
---------------------------------------------------------------------
 { "_id" : "abc", "res" : [ { "$numberInt" : "501" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : "def", "res" : [ { "$numberInt" : "502" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : "ghi", "res" : [ { "$numberInt" : "509" }, { "$numberInt" : "512" }, { "$numberInt" : "503" } ] }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [{"$group": {"_id": "$a", "res": {"$lastN": {"input": ["$quantity", "$cost"], "n": 3}}}}] }');
                                                                                              document                                                                                              
---------------------------------------------------------------------
 { "_id" : "abc", "res" : [ [ { "$numberInt" : "501" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "510" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "507" }, { "$numberInt" : "10" } ] ] }
 { "_id" : "def", "res" : [ [ { "$numberInt" : "502" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "508" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "511" }, { "$numberInt" : "8" } ] ] }
 { "_id" : "ghi", "res" : [ [ { "$numberInt" : "509" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "512" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "503" }, { "$numberInt" : "4" } ] ] }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [{"$group": {"_id": "$a", "res": {"$first": {"input": ["$quantity", "$cost"], "n": 3}}}}] }');
                                                           document                                                           
---------------------------------------------------------------------
 { "_id" : "abc", "res" : { "input" : [ { "$numberInt" : "515" }, { "$numberInt" : "80" } ], "n" : { "$numberInt" : "3" } } }
 { "_id" : "def", "res" : { "input" : [ { "$numberInt" : "505" }, { "$numberInt" : "8" } ], "n" : { "$numberInt" : "3" } } }
 { "_id" : "ghi", "res" : { "input" : [ { "$numberInt" : "506" }, { "$numberInt" : "4" } ], "n" : { "$numberInt" : "3" } } }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [{"$group": {"_id": "$a", "res": {"$first": "$quantity"}}}] }');
                      document                       
---------------------------------------------------------------------
 { "_id" : "abc", "res" : { "$numberInt" : "515" } }
 { "_id" : "def", "res" : { "$numberInt" : "505" } }
 { "_id" : "ghi", "res" : { "$numberInt" : "506" } }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [{"$group": {"_id": "$a", "res": {"$last": {"input": ["$quantity", "$cost"], "n": 3}}}}] }');
                                                           document                                                           
---------------------------------------------------------------------
 { "_id" : "abc", "res" : { "input" : [ { "$numberInt" : "501" }, { "$numberInt" : "10" } ], "n" : { "$numberInt" : "3" } } }
 { "_id" : "def", "res" : { "input" : [ { "$numberInt" : "502" }, { "$numberInt" : "8" } ], "n" : { "$numberInt" : "3" } } }
 { "_id" : "ghi", "res" : { "input" : [ { "$numberInt" : "509" }, { "$numberInt" : "4" } ], "n" : { "$numberInt" : "3" } } }
(3 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "setWindowFields", "pipeline": [{"$group": {"_id": "$a", "res": {"$last": "$quantity"}}}] }');
                      document                       
---------------------------------------------------------------------
 { "_id" : "abc", "res" : { "$numberInt" : "501" } }
 { "_id" : "def", "res" : { "$numberInt" : "502" } }
 { "_id" : "ghi", "res" : { "$numberInt" : "509" } }
(3 rows)

---------------------------------------------------------------------
-- $maxN accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$maxN": {"input": "$quantity", "n": 3}, "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$maxN": {"input": "$quantity", "n": 3}, "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                                 document                                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$maxN": {"input": "$quantity", "n": 3}, "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
(13 rows)

---------------------------------------------------------------------
-- Document window with sort
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"expensiveQuantity": { "$maxN": {"input": "$quantity", "n": 3}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"expensiveQuantity": { "$maxN": {"input": "$quantity", "n": 3}, "window": {"documents": ["unbounded", "current"]}}}} }]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"date": -1}, "output": {"expensiveQuantity": { "$maxN": {"input": "$quantity", "n": 3}, "window": {"documents": [-1, 1]}}}} }]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"expensiveQuantity": { "$maxN": {"input": "$quantity", "n": 3}, "window": {"range": [-3, 3]}}}}}]}');
                                                                                                                                           document                                                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" }, { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"expensiveQuantity": { "$maxN": {"input": "$quantity", "n": 3}, "window": {"range": [-20, 20], "unit": "second"}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" }, { "$numberInt" : "504" }, { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" } ] }
(13 rows)

---------------------------------------------------------------------
-- $minN accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$minN": {"input": "$quantity", "n": 3}, "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$minN": {"input": "$quantity", "n": 3}, "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                                 document                                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"expensiveQuantity": { "$minN": {"input": "$quantity", "n": 3}, "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
(13 rows)

---------------------------------------------------------------------
-- Document window with sort
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"expensiveQuantity": { "$minN": {"input": "$quantity", "n": 3}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"expensiveQuantity": { "$minN": {"input": "$quantity", "n": 3}, "window": {"documents": ["unbounded", "current"]}}}} }]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"date": -1}, "output": {"expensiveQuantity": { "$minN": {"input": "$quantity", "n": 3}, "window": {"documents": [-1, 1]}}}} }]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"expensiveQuantity": { "$minN": {"input": "$quantity", "n": 3}, "window": {"range": [-3, 3]}}}}}]}');
                                                                                                                                           document                                                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "504" }, { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" }, { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" }, { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "505" }, { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" }, { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" }, { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "506" }, { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" }, { "$numberInt" : "512" } ] }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"expensiveQuantity": { "$minN": {"input": "$quantity", "n": 3}, "window": {"range": [-20, 20], "unit": "second"}}}}}]}');
                                                                                                                                           document                                                                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "expensiveQuantity" : [ { "$numberInt" : "501" }, { "$numberInt" : "504" }, { "$numberInt" : "515" } ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "expensiveQuantity" : [ { "$numberInt" : "507" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "expensiveQuantity" : [ { "$numberInt" : "510" } ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "expensiveQuantity" : [ { "$numberInt" : "502" }, { "$numberInt" : "505" } ] }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "expensiveQuantity" : [ { "$numberInt" : "508" } ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "expensiveQuantity" : [ { "$numberInt" : "511" } ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "expensiveQuantity" : [ { "$numberInt" : "503" }, { "$numberInt" : "506" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "expensiveQuantity" : [ { "$numberInt" : "509" } ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "expensiveQuantity" : [ { "$numberInt" : "512" } ] }
(13 rows)

---------------------------------------------------------------------
-- $min accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalQuantity": { "$min": "$quantity"}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "503" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalQuantity": { "$min": "$quantity", "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "503" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$min": "$quantity", "window": {"documents": ["unbounded", "current"]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "503" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$min": "$quantity", "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$min": "$quantity", "window": {"documents": ["current", "unbounded"]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$min": "$quantity", "window": {"documents": [0, 0]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$min": "$quantity", "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$min": "$quantity", "window": {"documents": [-10, 10]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "503" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$min": "$quantity", "window": {"documents": ["current", 1]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$min": "$quantity", "window": {"documents": ["unbounded", 1]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "503" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$min": "$quantity", "window": {"documents": ["unbounded", -1]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : null }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : null }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : null }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "503" } }
(13 rows)

---------------------------------------------------------------------
-- Document window with sort
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"totalQuantity": { "$min": "$quantity"}}} }]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"totalQuantity": { "$min": "$quantity", "window": {"documents": ["unbounded", "current"]}}}} }]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "503" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"date": -1}, "output": {"totalQuantity": { "$min": "$quantity", "window": {"documents": [-1, 1]}}}} }]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"totalInGroup": { "$min": "$quantity", "window": {"range": [-3, 3]}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"totalInGroup": { "$min": "$quantity", "window": {"range": ["unbounded", "current"]}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "503" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"totalInGroup": { "$min": "$quantity", "window": {"range": ["current", "unbounded"]}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$min": "$quantity", "window": {"range": [-5, 5], "unit": "second"}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$min": "$quantity", "window": {"range": [-5, 5], "unit": "minute"}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$min": "$quantity", "window": {"range": [-5, 5], "unit": "day"}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "503" } }
(13 rows)

-- current in range doesn't mean current row its always the first peer which has same sort by value. This differs from MongoDB
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$max": "$quantity", "window": {"range": ["current", "current"], "unit": "day"}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "512" } }
(13 rows)

---------------------------------------------------------------------
-- $max accumulator tests
---------------------------------------------------------------------
---------------------------------------------------------------------
-- Document window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalQuantity": { "$max": "$quantity"}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "output": {"totalQuantity": { "$max": "$quantity", "window": {"documents": ["unbounded", "unbounded"]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$max": "$quantity", "window": {"documents": ["unbounded", "current"]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$max": "$quantity", "window": {"documents": ["current", "current"]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$max": "$quantity", "window": {"documents": ["current", "unbounded"]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$max": "$quantity", "window": {"documents": [0, 0]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$max": "$quantity", "window": {"documents": [-1, 1]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$max": "$quantity", "window": {"documents": [-10, 10]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$max": "$quantity", "window": {"documents": ["current", 1]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "509" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$max": "$quantity", "window": {"documents": ["unbounded", 1]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"a": 1}, "output": {"totalQuantity": { "$max": "$quantity", "window": {"documents": ["unbounded", -1]}}}}}]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : null }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : null }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : null }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "512" } }
(13 rows)

---------------------------------------------------------------------
-- Document window with sort
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"_id": -1}, "output": {"totalQuantity": { "$max": "$quantity"}}} }]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"quantity": 1}, "output": {"totalQuantity": { "$max": "$quantity", "window": {"documents": ["unbounded", "current"]}}}} }]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": {"date": -1}, "output": {"totalQuantity": { "$max": "$quantity", "window": {"documents": [-1, 1]}}}} }]}');
                                                                                                             document                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalQuantity" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalQuantity" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalQuantity" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalQuantity" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalQuantity" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalQuantity" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalQuantity" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalQuantity" : { "$numberInt" : "506" } }
(13 rows)

---------------------------------------------------------------------
-- Range window
---------------------------------------------------------------------
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"totalInGroup": { "$max": "$quantity", "window": {"range": [-3, 3]}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"totalInGroup": { "$max": "$quantity", "window": {"range": ["unbounded", "current"]}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "501" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "quantity": 1 }, "output": {"totalInGroup": { "$max": "$quantity", "window": {"range": ["current", "unbounded"]}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$max": "$quantity", "window": {"range": [-5, 5], "unit": "second"}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$max": "$quantity", "window": {"range": [-5, 5], "unit": "minute"}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "512" } }
(13 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$max": "$quantity", "window": {"range": [-5, 5], "unit": "day"}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "512" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "512" } }
(13 rows)

-- current in range doesn't mean current row its always the first peer which has same sort by value. This differs from MongoDB
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "setWindowFields", "pipeline":  [{"$setWindowFields": {"partitionBy": "$a", "sortBy": { "date": 1 }, "output": {"totalInGroup": { "$max": "$quantity", "window": {"range": ["current", "current"], "unit": "day"}}}}}]}');
                                                                                                             document                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "501" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "abc", "cost" : { "$numberInt" : "80" }, "quantity" : { "$numberInt" : "515" }, "date" : { "$date" : { "$numberLong" : "1718841600000" } }, "totalInGroup" : { "$numberInt" : "515" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "504" }, "date" : { "$date" : { "$numberLong" : "1718841615000" } }, "totalInGroup" : { "$numberInt" : "504" } }
 { "_id" : { "$numberInt" : "7" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "507" }, "date" : { "$date" : { "$numberLong" : "1718841640000" } }, "totalInGroup" : { "$numberInt" : "507" } }
 { "_id" : { "$numberInt" : "10" }, "a" : "abc", "cost" : { "$numberInt" : "10" }, "quantity" : { "$numberInt" : "510" }, "date" : { "$date" : { "$numberLong" : "1718841800000" } }, "totalInGroup" : { "$numberInt" : "510" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "502" }, "date" : { "$date" : { "$numberLong" : "1718841605000" } }, "totalInGroup" : { "$numberInt" : "502" } }
 { "_id" : { "$numberInt" : "5" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "505" }, "date" : { "$date" : { "$numberLong" : "1718841620000" } }, "totalInGroup" : { "$numberInt" : "505" } }
 { "_id" : { "$numberInt" : "8" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "508" }, "date" : { "$date" : { "$numberLong" : "1718841680000" } }, "totalInGroup" : { "$numberInt" : "508" } }
 { "_id" : { "$numberInt" : "11" }, "a" : "def", "cost" : { "$numberInt" : "8" }, "quantity" : { "$numberInt" : "511" }, "date" : { "$date" : { "$numberLong" : "1718841900000" } }, "totalInGroup" : { "$numberInt" : "511" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "503" }, "date" : { "$date" : { "$numberLong" : "1718841610000" } }, "totalInGroup" : { "$numberInt" : "503" } }
 { "_id" : { "$numberInt" : "6" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "506" }, "date" : { "$date" : { "$numberLong" : "1718841630000" } }, "totalInGroup" : { "$numberInt" : "506" } }
 { "_id" : { "$numberInt" : "9" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "509" }, "date" : { "$date" : { "$numberLong" : "1718841700000" } }, "totalInGroup" : { "$numberInt" : "509" } }
 { "_id" : { "$numberInt" : "12" }, "a" : "ghi", "cost" : { "$numberInt" : "4" }, "quantity" : { "$numberInt" : "512" }, "date" : { "$date" : { "$numberLong" : "1718842600000" } }, "totalInGroup" : { "$numberInt" : "512" } }
(13 rows)

