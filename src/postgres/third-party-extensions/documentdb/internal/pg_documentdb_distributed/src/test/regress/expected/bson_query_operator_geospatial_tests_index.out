SET search_path TO documentdb_api_catalog, postgis_public;
SET citus.next_shard_id TO 168300;
SET documentdb.next_collection_id TO 16830;
SET documentdb.next_collection_index_id TO 16830;
\set prevEcho :ECHO
\set ECHO none
NOTICE:  creating collection
-- Tests without sharding
-- Geometries
BEGIN;
set local enable_seqscan TO off;
\i sql/bson_query_operator_geospatial_core.sql
-- Insert multiple items
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 1, "a" : { "b": [10, 10] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 2, "a" : { "b": { "long": { "$numberLong": "20" }, "lat": { "$numberInt": "20" } } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 3, "a" : [ {"b": { "long": 25, "lat": 25 }}, [ { "$numberDouble": "30" }, { "$numberDecimal": "30" }], [35, 35]] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 4, "a" : { "b": [ [40, 40], [45, 45], [50, 50], [55, 55] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Insert items for $center corner case test
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 201, "geo" : { "loc": [ 2, 5 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 202, "geo" : { "loc": [ 5, 2 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 203, "geo" : { "loc": [ 5, 8 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 204, "geo" : { "loc": [ 4, 5 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 205, "geo" : { "loc": [ 5, 4 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 206, "geo" : { "loc": [ 5, 6 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 207, "geo" : { "loc": [ 6, 5 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 208, "geo" : { "loc": [ 0, 0 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 209, "geo" : { "loc": [ 0, 10 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- $geoWithin / $within => $box shape operator
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$box": [[10, 10], [10, 10]]}}}' ORDER BY object_id; -- boundary check
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$box": [[19.00001, 19.00002], [29.9999, 29.9999]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$box": [[10, 10], [64, 64]]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$box": [[10, 10], [65, 65]]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$box": {"bottomLeft": {"x": 10, "y": 10}, "bottomRight": {"x": 10, "y": 10}} }}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$box": {"bottomLeft": {"x": 10, "y": 10, "z": 20}, "bottomRight": {"x": 10, "y": 10, "z": 20 }}}}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$box": [[10, 10], [10, 10]]}}}' ORDER BY object_id; -- boundary check
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$box": [[19.00001, 19.00002], [29.9999, 29.9999]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$box": [[10, 10], [64, 64]]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$box": [[10, 10], [65, 65]]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$box": {"bottomLeft": {"x": 10, "y": 10}, "bottomRight": {"x": 10, "y": 10}} }}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$box": {"bottomLeft": {"x": 10, "y": 10, "z": 20}, "bottomRight": {"x": 10, "y": 10, "z": 20 }}}}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

-- $geoWithin / $within => $center shape operator
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$center": [[5, 10], 5]}}}' ORDER BY object_id; -- boundary check
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$center": [[15, 14], 10]}}}' ORDER BY object_id;
                                                          document                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$center": [[50, 50], 50]}}}' ORDER BY object_id; -- This will not include [10, 10]
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$center": [[50, 50], 60]}}}' ORDER BY object_id; -- The radius is enough to include [10, 10] now
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$center": [ { "x": 5, "y": 10 }, 5]}}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$center": [[5, 10], 5]}}}' ORDER BY object_id; -- boundary check
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$center": [[15, 14], 10]}}}' ORDER BY object_id;
                                                          document                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$center": [[50, 50], 50]}}}' ORDER BY object_id; -- This will not include [10, 10]
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$center": [[50, 50], 60]}}}' ORDER BY object_id; -- The radius is enough to include [10, 10] now
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$center": [ { "x": 5, "y": 10 }, 5]}}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$center": [[0,0], { "$numberDecimal" : "Infinity" }]}}}' ORDER BY object_id; -- infinite radius
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$within": {"$center": [[5, 5], 3]}}}' ORDER BY object_id; -- _id 201,202,203 on boundary
                                                   document                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "201" }, "geo" : { "loc" : [ { "$numberInt" : "2" }, { "$numberInt" : "5" } ] } }
 { "_id" : { "$numberInt" : "202" }, "geo" : { "loc" : [ { "$numberInt" : "5" }, { "$numberInt" : "2" } ] } }
 { "_id" : { "$numberInt" : "203" }, "geo" : { "loc" : [ { "$numberInt" : "5" }, { "$numberInt" : "8" } ] } }
 { "_id" : { "$numberInt" : "204" }, "geo" : { "loc" : [ { "$numberInt" : "4" }, { "$numberInt" : "5" } ] } }
 { "_id" : { "$numberInt" : "205" }, "geo" : { "loc" : [ { "$numberInt" : "5" }, { "$numberInt" : "4" } ] } }
 { "_id" : { "$numberInt" : "206" }, "geo" : { "loc" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] } }
 { "_id" : { "$numberInt" : "207" }, "geo" : { "loc" : [ { "$numberInt" : "6" }, { "$numberInt" : "5" } ] } }
(7 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$within": {"$center": [[5, 5], 1]}}}' ORDER BY object_id; -- _id 204,205,206 on boundary
                                                   document                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "204" }, "geo" : { "loc" : [ { "$numberInt" : "4" }, { "$numberInt" : "5" } ] } }
 { "_id" : { "$numberInt" : "205" }, "geo" : { "loc" : [ { "$numberInt" : "5" }, { "$numberInt" : "4" } ] } }
 { "_id" : { "$numberInt" : "206" }, "geo" : { "loc" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] } }
 { "_id" : { "$numberInt" : "207" }, "geo" : { "loc" : [ { "$numberInt" : "6" }, { "$numberInt" : "5" } ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$within": {"$center": [[0, 5], 5]}}}' ORDER BY object_id; -- _id 208,209 on boundary
                                                   document                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "201" }, "geo" : { "loc" : [ { "$numberInt" : "2" }, { "$numberInt" : "5" } ] } }
 { "_id" : { "$numberInt" : "204" }, "geo" : { "loc" : [ { "$numberInt" : "4" }, { "$numberInt" : "5" } ] } }
 { "_id" : { "$numberInt" : "208" }, "geo" : { "loc" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "209" }, "geo" : { "loc" : [ { "$numberInt" : "0" }, { "$numberInt" : "10" } ] } }
(4 rows)

-- $geoWithin / $within => $polygon shape operator
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[5, 10], [11, 11], [12, 5]]}}}' ORDER BY object_id; -- [10, 10] included
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[10, 10], [10, 10], [10, 10]]}}}' ORDER BY object_id; -- boundary check
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[10, 10], [10, 12], [11, 11], [9, 11]]}}}' ORDER BY object_id; -- Invalid polygon with self intersection
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[10, 10], [20, 20], [26, 26], [25, 12]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[10, 10], [20, 20], [26, 26], [25, 12]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[10, 10], [20, 20], [26, 26], [25, 12]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[10, 10], [80, 80], [60, 60], [20, 20]]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[5, 10], {"x": 11, "y": 11}, [12, 5]]}}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[5, 10], [11, 11], [12, 5]]}}}' ORDER BY object_id; -- [10, 10] included
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[10, 10], [10, 10], [10, 10]]}}}' ORDER BY object_id; -- boundary check
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[10, 10], [10, 12], [11, 11], [9, 11]]}}}' ORDER BY object_id; -- Invalid polygon with self intersection
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[10, 10], [20, 20], [26, 26], [25, 12]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[10, 10], [20, 20], [26, 26], [25, 12]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[10, 10], [20, 20], [26, 26], [25, 12]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[10, 10], [80, 80], [60, 60], [20, 20]]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[5, 10], {"x": 11, "y": 11}, [12, 5]]}}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

-- Validate non-geo query operator are not pushed to geo indexes but regular indexes and works fine
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$eq": [10, 10]}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

-- Test valid polygons in query
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoIntersects": { "$geometry": { "type": "Polygon", "coordinates": [[[0.0, 0.0], [60.0, 0.0], [90.0, 0.0], [0.0, 0.0]]]}}}}'; -- Polygon with points on a great circle of earth
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoIntersects": { "$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0 ,4], [0, 6], [0, 8], [0, 0]]]}}}}'; -- Polygon with points on the same longitude
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoIntersects": { "$geometry": { "type": "Polygon", "coordinates": [[[-120, 60.0], [0.0, 60.0], [60.0, 60.0], [90.0, 60.0], [-120.0, 60.0]]]}}}}'; -- Polygon with points on a single latitude, appear as straight line in 2d
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoIntersects": { "$geometry": { "type": "Polygon", "coordinates": [[[-120.0, 89], [-60, 89], [0, 89], [120, 89], [-120.0, 89]]]}}}}'; -- Polygon with points on a single latitude close to north pole
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoIntersects": { "$geometry": { "type": "Polygon", "coordinates": [[[-120.0, 60], [-60, 60], [0, 60], [120, 60], [-120.0, 60]], [[-120.0, 70], [-60, 70], [0, 70], [120, 70], [-120.0, 70]]]}}}}'; -- Polygon with points on a single latitude, points going around the earth with similar hole
 document 
---------------------------------------------------------------------
(0 rows)

-- Special case for array of legacy pairs
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 5, "c" : { "d": [ [10, 10], [100, 100] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 6, "c" : { "d": [ [100, 100], [10, 10] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 7, "c" : [{ "d": [100, 100]}, { "d": [10, 10]}] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 8, "c" : [{ "d": [10, 10]}, { "d": [100, 100]}] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Test that no matter the order of legacy pairs in the array, if 1 matches the document is returned
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"c.d": {"$geoWithin": {"$center": [[0, 0], 20]}}}' ORDER BY object_id;
                                                                                    document                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "c" : { "d" : [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ] ] } }
 { "_id" : { "$numberInt" : "6" }, "c" : { "d" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] } }
 { "_id" : { "$numberInt" : "7" }, "c" : [ { "d" : [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ] }, { "d" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } ] }
 { "_id" : { "$numberInt" : "8" }, "c" : [ { "d" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, { "d" : [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ] } ] }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"c.d": {"$geoWithin": {"$center": [[90, 90], 20]}}}' ORDER BY object_id;
                                                                                    document                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "c" : { "d" : [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ] ] } }
 { "_id" : { "$numberInt" : "6" }, "c" : { "d" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] } }
 { "_id" : { "$numberInt" : "7" }, "c" : [ { "d" : [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ] }, { "d" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } ] }
 { "_id" : { "$numberInt" : "8" }, "c" : [ { "d" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, { "d" : [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ] } ] }
(4 rows)

ROLLBACK;
-- Geographies
BEGIN;
set local enable_seqscan TO on;
\i sql/bson_query_operator_geospatial_geography_core.sql
-- Insert multiple items
-- Old format legacy points are valid for geography
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 1, "geo" : { "loc": [2.1, 2.2] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 2, "geo" : [ { "loc": [3.1, 3.2] }, { "loc": [4.1, 4.2] } ] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 3, "geo" : { "loc": {"type": "Point", "coordinates": [5.1, 5.2] } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 4, "geo" : [ { "loc": {"type": "Point", "coordinates": [6.1, 6.2] } }, { "loc": { "type": "Point", "coordinates": [6.3, 6.4]} }] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 5, "geo" : { "loc": { "type": "MultiPoint", "coordinates": [[7.1, 7.2], [7.3, 7.4]] } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 6, "geo" : { "loc": { "type": "LineString", "coordinates": [[8.1, 8.2], [8.3, 8.4]] } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 7, "geo" : { "loc": { "type": "Polygon", "coordinates": [[[10, 10], [10, -10], [-10, -10], [-10, 10], [10, 10]]] } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 8, "geo" : { "loc": { "type": "Polygon", "coordinates": [[[10, 10], [10, -10], [-10, -10], [-10, 10], [10, 10]], [[5, 5], [5, -5], [-5, -5], [-5, 5], [5, 5]]] } } }', NULL);
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 9, "geo" : { "loc": { "type": "MultiLineString", "coordinates": [[[10, 10], [10, -10], [-10, -10], [-10, 10], [10, 10]], [[5, 5], [5, -5], [-5, -5], [-5, 5], [5, 5]]] } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 10, "geo" : { "loc": { "type": "MultiPolygon", "coordinates": [[[[10, 10], [10, -10], [-10, -10], [-10, 10], [10, 10]], [[5, 5], [5, -5], [-5, -5], [-5, 5], [5, 5]]]] } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 11, "geo" : { "loc": { "type": "GeometryCollection", "geometries": [ {"type": "Point", "coordinates": [11.1, 11.2]}, {"type": "LineString", "coordinates": [[11.3, 11.4], [11.5, 11.6]]}, {"type": "Polygon", "coordinates": [[[5, 5], [5, -5], [-5, -5], [-5, 5], [5, 5]]]}  ] } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 12, "geo" : { "loc": [120, 89.1 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 13, "geo" : { "loc": { "x": 50, "y": 50, "z": 51 } } }', NULL); -- Legacy object format
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 14, "geo" : { "loc": [51, 51, 52] } }', NULL); -- Legacy array format
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 15, "geo" : { "loc": [ -46.67527188, -23.60076866 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 16, "geo" : { "loc": [ -46.67354611, -23.60337759 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 50, "a" : { "b": [ [40, 40], [45, 45], [50, 50], [55, 55] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 51, "a" : { "b": [ { "x" : 1, "y" : 1 }, { "x" : 2, "y" : 2 }, { "x" : 3, "y" : 3 } ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 52, "a" : { "b": [ ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 53, "a" : { "b": { } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 54, "a" : { "b": [ [], [] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 55, "a" : { "b": [ [10, 10], [120, 80] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 56, "a" : { "b": [ [120, 80], [10, 10] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 57, "a" : [{ "b": [120, 80]}, { "b": [10, 10]}] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 58, "a" : [{ "b": [10, 10]}, { "b": [120, 80]}] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- for $centerSphere edge test
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 17, "geo" : { "loc": [4.9757, 2.66966] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 18, "geo" : { "loc": [-4.9757, -2.66966] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 19, "geoPrec" : { "loc": [1, 0], "d": {"$numberDouble": "0.017453292519943295"} } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 20, "geoPrec" : { "loc": [-1, 0], "d": {"$numberDouble": "0.017453292519943295"} } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 21, "geoPrec" : { "loc": [0, 1], "d": {"$numberDouble": "0.017453292519943295"} } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 22, "geoPrec" : { "loc": [0, -1], "d": {"$numberDouble": "0.017453292519943295"} } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Insert some items for testing composite 2dsphere index
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 200, "geoA" : { "type" : "Point", "coordinates": [ 10, 10] }, "geoB": { "type": "Point", "coordinates": [20, 20] } }', NULL); -- Both geoA and geoB
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 201, "geoA" : { "type" : "Point", "coordinates": [ 11, 11] } }', NULL); -- Only geoA
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 202, "geoB" : { "type" : "Point", "coordinates": [ 21, 21] } }', NULL); -- Only geoB
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 203, "geoC" : { "type" : "Point", "coordinates": [ 30, 30] } }', NULL); -- No geoA, no geoB
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Insert some items for composited 2dsphere index with pfe
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 300, "geo1" : { "type" : "Point", "coordinates": [ 10, 10] }, "geo2": { "type": "Point", "coordinates": [20, 20] }, "region": "USA" }', NULL); -- Both geo1 and geo2
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 301, "geo1" : { "type" : "Point", "coordinates": [ 11, 11] }, "region": "USA" }', NULL); -- Only geo1
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 302, "geo2" : { "type" : "Point", "coordinates": [ 21, 21] }, "region": "USA" }', NULL); -- Only geo2
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 303, "geo3" : { "type" : "Point", "coordinates": [ 30, 30] }, "region": "USA" }', NULL); -- No geo1, no geo2
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Insert for large query cap containing all of shapes vertices but not the shape itself.
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 400, "largeGeo" : { "type" : "LineString", "coordinates": [[96.328125, 5.61598581915534], [153.984375, -6.315298538330033]] }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 401, "largeGeo" : { "type" : "Polygon", "coordinates": [[
                [98.96484375, -11.350796722383672],
                [135.35156249999997, -11.350796722383672],
                [135.35156249999997, 0.8788717828324276],
                [98.96484375, 0.8788717828324276],
                [98.96484375, -11.350796722383672]
            ]] }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Valid polygon inserts
SELECT documentdb_api.insert_one('db','geoquerytest','{"_id": 601, "geo" : { "loc" : {"type": "Polygon", "coordinates": [[[0.0, 0.0], [60.0, 0.0], [90.0, 0.0], [0.0, 0.0]]] } } }', NULL); -- all points on equator
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{"_id": 602, "geo" : { "loc" : {"type": "Polygon", "coordinates": [[[-120, 60.0], [0.0, 60.0], [60.0, 60.0], [90.0, 60.0], [-120.0, 60.0]]] } } }', NULL); -- all points on same latitude
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{"_id": 603, "geo" : { "loc" : {"type": "Polygon", "coordinates": [[[0, 0], [0 ,4], [0, 6], [0, 8], [0, 0]]] } } }', NULL); -- all points on same longitude
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

--$geoIntersects operator
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "MultiPoint", "coordinates": [[1.1, 1.2], [2.1, 2.2], [3.1, 3.2]] } }}}' ORDER BY object_id; -- Validate legacy format works
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "Point", "coordinates": {"lon": 3.1, "lat": 3.2} } }}}' ORDER BY object_id; -- this weird GeoJson mongo native syntax is also supported
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "MultiPoint", "coordinates": [[7.1, 7.2], [4.1, 4.2]] } }}}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
(5 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "LineString", "coordinates": [[7.1, 7.2], [4.1, 4.2], [7.3, 7.4], [2.1, 2.2]] } }}}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
(7 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[ [0, 0], [0, 10], [10, 10], [10, 0], [0, 0] ]] } }}}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "3" }, "geo" : { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "5.0999999999999996447" }, { "$numberDouble" : "5.2000000000000001776" } ] } } }
 { "_id" : { "$numberInt" : "4" }, "geo" : [ { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.0999999999999996447" }, { "$numberDouble" : "6.2000000000000001776" } ] } }, { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.2999999999999998224" }, { "$numberDouble" : "6.4000000000000003553" } ] } } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "6" }, "geo" : { "loc" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "8.0999999999999996447" }, { "$numberDouble" : "8.1999999999999992895" } ], [ { "$numberDouble" : "8.3000000000000007105" }, { "$numberDouble" : "8.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "601" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(13 rows)

-- with holes, should not include document with _id 4
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[ [0, 0], [0, 10], [10, 10], [10, 0], [0, 0] ], [ [4, 4], [4, 7], [7, 7], [7, 4], [4, 4] ]] } }}}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "6" }, "geo" : { "loc" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "8.0999999999999996447" }, { "$numberDouble" : "8.1999999999999992895" } ], [ { "$numberDouble" : "8.3000000000000007105" }, { "$numberDouble" : "8.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "601" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(11 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "LineString", "coordinates": [ [25, 25], [-25, -25] ] } }}}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
 { "_id" : { "$numberInt" : "601" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(6 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "GeometryCollection", "geometries": [ {"type": "LineString", "coordinates": [[-25, -25], [25, 25]]}, {"type": "Point", "coordinates": [2.1, 2.2]} ] } }}}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
 { "_id" : { "$numberInt" : "601" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(7 rows)

-- Legacy formats with $geometry works
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "lon": 50, "lat": 50 } }}}' ORDER BY object_id;
                                                                         document                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "geo" : { "loc" : { "x" : { "$numberInt" : "50" }, "y" : { "$numberInt" : "50" }, "z" : { "$numberInt" : "51" } } } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": [51, 51] }}}' ORDER BY object_id;
                                                                document                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "14" }, "geo" : { "loc" : [ { "$numberInt" : "51" }, { "$numberInt" : "51" }, { "$numberInt" : "52" } ] } }
(1 row)

-- Check if a north pole region geography finds a point with _id 12, this is invalid polygon in 2d but valid as a spherical geometry
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[-120.0, 89.0], [0.0, 89.0], [120.0, 89.0], [-120.0, 89.0]]] } }}}' ORDER BY object_id;
                                                                                                                                                                                                                document                                                                                                                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "12" }, "geo" : { "loc" : [ { "$numberInt" : "120" }, { "$numberDouble" : "89.099999999999994316" } ] } }
 { "_id" : { "$numberInt" : "602" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "-120" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "-120.0" }, { "$numberDouble" : "60.0" } ] ] ] } } }
(2 rows)

-- $geoWithin operator works with spherical queries with $geometry (Polygon and Multipolygons only) and $centerSphere
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$geometry": { "type": "Polygon", "coordinates": [[ [0, 0], [0, 10], [10, 10], [10, 0], [0, 0] ]] } }}}' ORDER BY object_id;
                                                                                                                                                                                   document                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "3" }, "geo" : { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "5.0999999999999996447" }, { "$numberDouble" : "5.2000000000000001776" } ] } } }
 { "_id" : { "$numberInt" : "4" }, "geo" : [ { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.0999999999999996447" }, { "$numberDouble" : "6.2000000000000001776" } ] } }, { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.2999999999999998224" }, { "$numberDouble" : "6.4000000000000003553" } ] } } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "6" }, "geo" : { "loc" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "8.0999999999999996447" }, { "$numberDouble" : "8.1999999999999992895" } ], [ { "$numberDouble" : "8.3000000000000007105" }, { "$numberDouble" : "8.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(8 rows)

-- SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$geometry": { "type": "Polygon", "coordinates": [[ [0, 0], [0, 10], [10, 10], [10, 0], [0, 0] ], [ [4, 4], [4, 7], [7, 7], [7, 4], [4, 4] ]] } }}}' ORDER BY object_id;
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$geometry": { "type": "Polygon", "coordinates": [[[-120.0, 89.0], [0.0, 89.0], [120.0, 89.0], [-120.0, 89.0]]] } }}}' ORDER BY object_id;
                                                               document                                                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "12" }, "geo" : { "loc" : [ { "$numberInt" : "120" }, { "$numberDouble" : "89.099999999999994316" } ] } }
(1 row)

-- $centerSphere operator
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$centerSphere": [[0,0], 1] }}}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "3" }, "geo" : { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "5.0999999999999996447" }, { "$numberDouble" : "5.2000000000000001776" } ] } } }
 { "_id" : { "$numberInt" : "4" }, "geo" : [ { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.0999999999999996447" }, { "$numberDouble" : "6.2000000000000001776" } ] } }, { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.2999999999999998224" }, { "$numberDouble" : "6.4000000000000003553" } ] } } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "6" }, "geo" : { "loc" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "8.0999999999999996447" }, { "$numberDouble" : "8.1999999999999992895" } ], [ { "$numberDouble" : "8.3000000000000007105" }, { "$numberDouble" : "8.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
 { "_id" : { "$numberInt" : "15" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.675271879999996827" }, { "$numberDouble" : "-23.600768659999999954" } ] } }
 { "_id" : { "$numberInt" : "16" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.673546109999996645" }, { "$numberDouble" : "-23.603377590000000907" } ] } }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "18" }, "geo" : { "loc" : [ { "$numberDouble" : "-4.9756999999999997897" }, { "$numberDouble" : "-2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(15 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$centerSphere": [[0,0], 4] }}}' ORDER BY object_id; -- still returns results with bigger buffer
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "3" }, "geo" : { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "5.0999999999999996447" }, { "$numberDouble" : "5.2000000000000001776" } ] } } }
 { "_id" : { "$numberInt" : "4" }, "geo" : [ { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.0999999999999996447" }, { "$numberDouble" : "6.2000000000000001776" } ] } }, { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.2999999999999998224" }, { "$numberDouble" : "6.4000000000000003553" } ] } } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "6" }, "geo" : { "loc" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "8.0999999999999996447" }, { "$numberDouble" : "8.1999999999999992895" } ], [ { "$numberDouble" : "8.3000000000000007105" }, { "$numberDouble" : "8.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
 { "_id" : { "$numberInt" : "12" }, "geo" : { "loc" : [ { "$numberInt" : "120" }, { "$numberDouble" : "89.099999999999994316" } ] } }
 { "_id" : { "$numberInt" : "13" }, "geo" : { "loc" : { "x" : { "$numberInt" : "50" }, "y" : { "$numberInt" : "50" }, "z" : { "$numberInt" : "51" } } } }
 { "_id" : { "$numberInt" : "14" }, "geo" : { "loc" : [ { "$numberInt" : "51" }, { "$numberInt" : "51" }, { "$numberInt" : "52" } ] } }
 { "_id" : { "$numberInt" : "15" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.675271879999996827" }, { "$numberDouble" : "-23.600768659999999954" } ] } }
 { "_id" : { "$numberInt" : "16" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.673546109999996645" }, { "$numberDouble" : "-23.603377590000000907" } ] } }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "18" }, "geo" : { "loc" : [ { "$numberDouble" : "-4.9756999999999997897" }, { "$numberDouble" : "-2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "601" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "602" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "-120" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "-120.0" }, { "$numberDouble" : "60.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(20 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$centerSphere": [[0,0], 0.0984] }}}' ORDER BY object_id; -- edge test for $centerSphere
                                                                                                                                  document                                                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "18" }, "geo" : { "loc" : [ { "$numberDouble" : "-4.9756999999999997897" }, { "$numberDouble" : "-2.669659999999999922" } ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$centerSphere": [[0,0], 0.21] }}}' ORDER BY object_id; -- 0.21 is enough to include Point(5 5) and not Point(10 10) so shouldn't include some docs 
                                                                                                                                                                                   document                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "3" }, "geo" : { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "5.0999999999999996447" }, { "$numberDouble" : "5.2000000000000001776" } ] } } }
 { "_id" : { "$numberInt" : "4" }, "geo" : [ { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.0999999999999996447" }, { "$numberDouble" : "6.2000000000000001776" } ] } }, { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.2999999999999998224" }, { "$numberDouble" : "6.4000000000000003553" } ] } } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "6" }, "geo" : { "loc" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "8.0999999999999996447" }, { "$numberDouble" : "8.1999999999999992895" } ], [ { "$numberDouble" : "8.3000000000000007105" }, { "$numberDouble" : "8.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "18" }, "geo" : { "loc" : [ { "$numberDouble" : "-4.9756999999999997897" }, { "$numberDouble" : "-2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(9 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$centerSphere": [[0,0], { "$numberDecimal" : "Infinity" }] }}}' ORDER BY object_id; -- infinite radius should include all docs
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "3" }, "geo" : { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "5.0999999999999996447" }, { "$numberDouble" : "5.2000000000000001776" } ] } } }
 { "_id" : { "$numberInt" : "4" }, "geo" : [ { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.0999999999999996447" }, { "$numberDouble" : "6.2000000000000001776" } ] } }, { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.2999999999999998224" }, { "$numberDouble" : "6.4000000000000003553" } ] } } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "6" }, "geo" : { "loc" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "8.0999999999999996447" }, { "$numberDouble" : "8.1999999999999992895" } ], [ { "$numberDouble" : "8.3000000000000007105" }, { "$numberDouble" : "8.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
 { "_id" : { "$numberInt" : "12" }, "geo" : { "loc" : [ { "$numberInt" : "120" }, { "$numberDouble" : "89.099999999999994316" } ] } }
 { "_id" : { "$numberInt" : "13" }, "geo" : { "loc" : { "x" : { "$numberInt" : "50" }, "y" : { "$numberInt" : "50" }, "z" : { "$numberInt" : "51" } } } }
 { "_id" : { "$numberInt" : "14" }, "geo" : { "loc" : [ { "$numberInt" : "51" }, { "$numberInt" : "51" }, { "$numberInt" : "52" } ] } }
 { "_id" : { "$numberInt" : "15" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.675271879999996827" }, { "$numberDouble" : "-23.600768659999999954" } ] } }
 { "_id" : { "$numberInt" : "16" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.673546109999996645" }, { "$numberDouble" : "-23.603377590000000907" } ] } }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "18" }, "geo" : { "loc" : [ { "$numberDouble" : "-4.9756999999999997897" }, { "$numberDouble" : "-2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "601" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "602" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "-120" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "-120.0" }, { "$numberDouble" : "60.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(20 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"largeGeo": {"$geoWithin": {"$centerSphere": [[-59.80246852929814, -2.3633072488322853], 2.768403272464979]}}}' ORDER BY object_id; -- no result
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"largeGeo": {"$geoWithin": {"$centerSphere": [[-61.52266094410311, 17.79937981451866], 2.9592242752161573]}}}' ORDER BY object_id; -- big enough for linestring but not for polygon
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "400" }, "largeGeo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "96.328125" }, { "$numberDouble" : "5.6159858191553402307" } ], [ { "$numberDouble" : "153.984375" }, { "$numberDouble" : "-6.3152985383300332956" } ] ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"largeGeo": {"$geoWithin": {"$centerSphere": [[-61.52266094410311, 17.79937981451866], 3.15]}}}' ORDER BY object_id; -- radius > pi, both docs in result
                                                                                                                                                                                                                                                                                      document                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "400" }, "largeGeo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "96.328125" }, { "$numberDouble" : "5.6159858191553402307" } ], [ { "$numberDouble" : "153.984375" }, { "$numberDouble" : "-6.3152985383300332956" } ] ] } }
 { "_id" : { "$numberInt" : "401" }, "largeGeo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "98.96484375" }, { "$numberDouble" : "-11.350796722383671877" } ], [ { "$numberDouble" : "135.35156249999997158" }, { "$numberDouble" : "-11.350796722383671877" } ], [ { "$numberDouble" : "135.35156249999997158" }, { "$numberDouble" : "0.87887178283242761712" } ], [ { "$numberDouble" : "98.96484375" }, { "$numberDouble" : "0.87887178283242761712" } ], [ { "$numberDouble" : "98.96484375" }, { "$numberDouble" : "-11.350796722383671877" } ] ] ] } }
(2 rows)

-- Testing composite 2dsphere index
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geoA": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}}' ORDER BY object_id;
                                                                                                                    document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "200" }, "geoA" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, "geoB" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ] } }
 { "_id" : { "$numberInt" : "201" }, "geoA" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "11" }, { "$numberInt" : "11" } ] } }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geoB": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}}' ORDER BY object_id;
                                                                                                                    document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "200" }, "geoA" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, "geoB" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ] } }
 { "_id" : { "$numberInt" : "202" }, "geoB" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "21" }, { "$numberInt" : "21" } ] } }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') 
    WHERE document @@ '{"geoA": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}, 
                        "geoB": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}}' ORDER BY object_id;
                                                                                                                    document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "200" }, "geoA" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, "geoB" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ] } }
(1 row)

-- Testing composite 2dsphere with pfe
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo1": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}, "region": {"$eq": "USA" }}' ORDER BY object_id;
                                                                                                                             document                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "300" }, "geo1" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, "geo2" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ] }, "region" : "USA" }
 { "_id" : { "$numberInt" : "301" }, "geo1" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "11" }, { "$numberInt" : "11" } ] }, "region" : "USA" }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo2": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}, "region": {"$eq": "USA" }}' ORDER BY object_id;
                                                                                                                             document                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "300" }, "geo1" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, "geo2" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ] }, "region" : "USA" }
 { "_id" : { "$numberInt" : "302" }, "geo2" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "21" }, { "$numberInt" : "21" } ] }, "region" : "USA" }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') 
    WHERE document @@ '{"geo1": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }} ,
                        "geo2": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }} ,
                        "region": { "$eq": "USA" } }' ORDER BY object_id;
                                                                                                                             document                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "300" }, "geo1" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, "geo2" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ] }, "region" : "USA" }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') 
    WHERE document @@ '{"geo1": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}, 
                        "geo2": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}}' ORDER BY object_id; -- This one should not use index because pfe doesn't match but should return same values
                                                                                                                             document                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "300" }, "geo1" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, "geo2" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ] }, "region" : "USA" }
(1 row)

-- Make sure a really big query that requires buffer reallocs don't mess up geometry/geography and return the result
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{ "geo.loc" : { "$geoIntersects" : { "$geometry" : '
                '{ "type" : "MultiPolygon", "coordinates" : [[[[-46.67914894304542, -23.39591591], [-46.69148969424672, -23.39647184], [-46.70371190620094, -23.39813429], '
                '[-46.7156981694656, -23.40088729], [-46.72733332377327, -23.40470439], [-46.7385055566174, -23.40954892], [-46.749107470871145, -23.41537434], '
                '[-46.75903711150689, -23.42212468], [-46.768198941818476, -23.42973505], [-46.77650475996186, -23.43813231], [-46.78387454712577, -23.44723573], '
                '[-46.79023723921629, -23.45695777], [-46.7955314145885, -23.46720494], [-46.79970589107978, -23.47787865], [-46.80272022639018, -23.48887621], '
                '[-46.80454511671058, -23.50009177], [-46.805162689414196, -23.51141736], [-46.804566686594455, -23.52274393], [-46.80276253724614, -23.53396238], '
                '[-46.79976731693784, -23.54496462], [-46.79560959490368, -23.55564464], [-46.79032916958054, -23.56589949], [-46.783976694723066, -23.5756303], '
                '[-46.77661319932978, -23.58474322], [-46.76830950569968, -23.59315037], [-46.75914555099343, -23.60077063], [-46.74920961868761, -23.60753048], [-46.73859748726804, -23.61336466], '
                '[-46.727411504398404, -23.61821688], [-46.71575959561004, -23.62204028], [-46.703754217276085, -23.62479797], [-46.691511264249215, -23.6264633], '
                '[-46.67914894304542, -23.6270202], [-46.66678662184163, -23.6264633], [-46.65454366881477, -23.62479797], [-46.642538290480815, -23.62204028], '
                '[-46.63088638169245, -23.61821688], [-46.619700398822815, -23.61336466], [-46.60908826740324, -23.60753048], [-46.59915233509742, -23.60077063], '
                '[-46.589988380391155, -23.59315037], [-46.58168468676106, -23.58474322], [-46.57432119136778, -23.5756303], [-46.56796871651031, -23.56589949], '
                '[-46.56268829118717, -23.55564464], [-46.558530569153, -23.54496462], [-46.5555353488447, -23.53396238], [-46.55373119949638, -23.52274393], '
                '[-46.55313519667665, -23.51141736], [-46.55375276938027, -23.50009177], [-46.55557765970067, -23.48887621], [-46.55859199501106, -23.47787865], '
                '[-46.56276647150235, -23.46720494], [-46.56806064687455, -23.45695777], [-46.57442333896507, -23.44723573], [-46.58179312612898, -23.43813231], '
                '[-46.59009894427236, -23.42973505], [-46.59926077458395, -23.42212468], [-46.60919041521971, -23.41537434], [-46.61979232947344, -23.40954892], '
                '[-46.63096456231758, -23.40470439], [-46.64259971662524, -23.40088729], [-46.65458597988991, -23.39813429], [-46.66680819184413, -23.39647184], '
                '[-46.67914894304542, -23.39591591]]]]}}}}' ORDER BY object_id;
                                                                          document                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "15" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.675271879999996827" }, { "$numberDouble" : "-23.600768659999999954" } ] } }
 { "_id" : { "$numberInt" : "16" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.673546109999996645" }, { "$numberDouble" : "-23.603377590000000907" } ] } }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{ "geo.loc" : { "$geoWithin" : { "$geometry" : '
                '{ "type" : "MultiPolygon", "coordinates" : [[[[-46.67914894304542, -23.39591591], [-46.69148969424672, -23.39647184], [-46.70371190620094, -23.39813429], '
                '[-46.7156981694656, -23.40088729], [-46.72733332377327, -23.40470439], [-46.7385055566174, -23.40954892], [-46.749107470871145, -23.41537434], '
                '[-46.75903711150689, -23.42212468], [-46.768198941818476, -23.42973505], [-46.77650475996186, -23.43813231], [-46.78387454712577, -23.44723573], '
                '[-46.79023723921629, -23.45695777], [-46.7955314145885, -23.46720494], [-46.79970589107978, -23.47787865], [-46.80272022639018, -23.48887621], '
                '[-46.80454511671058, -23.50009177], [-46.805162689414196, -23.51141736], [-46.804566686594455, -23.52274393], [-46.80276253724614, -23.53396238], '
                '[-46.79976731693784, -23.54496462], [-46.79560959490368, -23.55564464], [-46.79032916958054, -23.56589949], [-46.783976694723066, -23.5756303], '
                '[-46.77661319932978, -23.58474322], [-46.76830950569968, -23.59315037], [-46.75914555099343, -23.60077063], [-46.74920961868761, -23.60753048], [-46.73859748726804, -23.61336466], '
                '[-46.727411504398404, -23.61821688], [-46.71575959561004, -23.62204028], [-46.703754217276085, -23.62479797], [-46.691511264249215, -23.6264633], '
                '[-46.67914894304542, -23.6270202], [-46.66678662184163, -23.6264633], [-46.65454366881477, -23.62479797], [-46.642538290480815, -23.62204028], '
                '[-46.63088638169245, -23.61821688], [-46.619700398822815, -23.61336466], [-46.60908826740324, -23.60753048], [-46.59915233509742, -23.60077063], '
                '[-46.589988380391155, -23.59315037], [-46.58168468676106, -23.58474322], [-46.57432119136778, -23.5756303], [-46.56796871651031, -23.56589949], '
                '[-46.56268829118717, -23.55564464], [-46.558530569153, -23.54496462], [-46.5555353488447, -23.53396238], [-46.55373119949638, -23.52274393], '
                '[-46.55313519667665, -23.51141736], [-46.55375276938027, -23.50009177], [-46.55557765970067, -23.48887621], [-46.55859199501106, -23.47787865], '
                '[-46.56276647150235, -23.46720494], [-46.56806064687455, -23.45695777], [-46.57442333896507, -23.44723573], [-46.58179312612898, -23.43813231], '
                '[-46.59009894427236, -23.42973505], [-46.59926077458395, -23.42212468], [-46.60919041521971, -23.41537434], [-46.61979232947344, -23.40954892], '
                '[-46.63096456231758, -23.40470439], [-46.64259971662524, -23.40088729], [-46.65458597988991, -23.39813429], [-46.66680819184413, -23.39647184], '
                '[-46.67914894304542, -23.39591591]]]]}}}}' ORDER BY object_id;
                                                                          document                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "15" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.675271879999996827" }, { "$numberDouble" : "-23.600768659999999954" } ] } }
 { "_id" : { "$numberInt" : "16" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.673546109999996645" }, { "$numberDouble" : "-23.603377590000000907" } ] } }
(2 rows)

-- $centerSphere precision test
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geoPrec.loc": {"$geoWithin": {"$centerSphere": [[0,0], {"$numberDouble": "0.017453292519943295"}] }}}' ORDER BY object_id;
                                                                                document                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "19" }, "geoPrec" : { "loc" : [ { "$numberInt" : "1" }, { "$numberInt" : "0" } ], "d" : { "$numberDouble" : "0.017453292519943295474" } } }
 { "_id" : { "$numberInt" : "20" }, "geoPrec" : { "loc" : [ { "$numberInt" : "-1" }, { "$numberInt" : "0" } ], "d" : { "$numberDouble" : "0.017453292519943295474" } } }
 { "_id" : { "$numberInt" : "21" }, "geoPrec" : { "loc" : [ { "$numberInt" : "0" }, { "$numberInt" : "1" } ], "d" : { "$numberDouble" : "0.017453292519943295474" } } }
 { "_id" : { "$numberInt" : "22" }, "geoPrec" : { "loc" : [ { "$numberInt" : "0" }, { "$numberInt" : "-1" } ], "d" : { "$numberDouble" : "0.017453292519943295474" } } }
(4 rows)

-- $centerSphere test with array of legacy coordinates in document
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$centerSphere": [[0,0], 2] }}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "50" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
 { "_id" : { "$numberInt" : "51" }, "a" : { "b" : [ { "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "1" } }, { "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "2" } }, { "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "3" } } ] } }
 { "_id" : { "$numberInt" : "55" }, "a" : { "b" : [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] ] } }
 { "_id" : { "$numberInt" : "56" }, "a" : { "b" : [ [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] } }
 { "_id" : { "$numberInt" : "57" }, "a" : [ { "b" : [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] }, { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } ] }
 { "_id" : { "$numberInt" : "58" }, "a" : [ { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, { "b" : [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] } ] }
(6 rows)

-- Test that no matter the order of legacy pairs in the array, if 1 matches the document is returned
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$centerSphere": [[0, 0], 1]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "50" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
 { "_id" : { "$numberInt" : "51" }, "a" : { "b" : [ { "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "1" } }, { "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "2" } }, { "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "3" } } ] } }
 { "_id" : { "$numberInt" : "55" }, "a" : { "b" : [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] ] } }
 { "_id" : { "$numberInt" : "56" }, "a" : { "b" : [ [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] } }
 { "_id" : { "$numberInt" : "57" }, "a" : [ { "b" : [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] }, { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } ] }
 { "_id" : { "$numberInt" : "58" }, "a" : [ { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, { "b" : [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] } ] }
(6 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$centerSphere": [[90, 90], 1]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "50" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
 { "_id" : { "$numberInt" : "55" }, "a" : { "b" : [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] ] } }
 { "_id" : { "$numberInt" : "56" }, "a" : { "b" : [ [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] } }
 { "_id" : { "$numberInt" : "57" }, "a" : [ { "b" : [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] }, { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } ] }
 { "_id" : { "$numberInt" : "58" }, "a" : [ { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, { "b" : [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] } ] }
(5 rows)

ROLLBACK;
-- Again testing with shards
-- Shard the collection and run the tests
SELECT documentdb_api.shard_collection('db', 'geoquerytest', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- Geometries
BEGIN;
set local enable_seqscan TO off;
\i sql/bson_query_operator_geospatial_core.sql
-- Insert multiple items
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 1, "a" : { "b": [10, 10] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 2, "a" : { "b": { "long": { "$numberLong": "20" }, "lat": { "$numberInt": "20" } } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 3, "a" : [ {"b": { "long": 25, "lat": 25 }}, [ { "$numberDouble": "30" }, { "$numberDecimal": "30" }], [35, 35]] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 4, "a" : { "b": [ [40, 40], [45, 45], [50, 50], [55, 55] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Insert items for $center corner case test
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 201, "geo" : { "loc": [ 2, 5 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 202, "geo" : { "loc": [ 5, 2 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 203, "geo" : { "loc": [ 5, 8 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 204, "geo" : { "loc": [ 4, 5 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 205, "geo" : { "loc": [ 5, 4 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 206, "geo" : { "loc": [ 5, 6 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 207, "geo" : { "loc": [ 6, 5 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 208, "geo" : { "loc": [ 0, 0 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 209, "geo" : { "loc": [ 0, 10 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- $geoWithin / $within => $box shape operator
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$box": [[10, 10], [10, 10]]}}}' ORDER BY object_id; -- boundary check
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$box": [[19.00001, 19.00002], [29.9999, 29.9999]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$box": [[10, 10], [64, 64]]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$box": [[10, 10], [65, 65]]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$box": {"bottomLeft": {"x": 10, "y": 10}, "bottomRight": {"x": 10, "y": 10}} }}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$box": {"bottomLeft": {"x": 10, "y": 10, "z": 20}, "bottomRight": {"x": 10, "y": 10, "z": 20 }}}}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$box": [[10, 10], [10, 10]]}}}' ORDER BY object_id; -- boundary check
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$box": [[19.00001, 19.00002], [29.9999, 29.9999]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$box": [[10, 10], [64, 64]]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$box": [[10, 10], [65, 65]]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$box": {"bottomLeft": {"x": 10, "y": 10}, "bottomRight": {"x": 10, "y": 10}} }}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$box": {"bottomLeft": {"x": 10, "y": 10, "z": 20}, "bottomRight": {"x": 10, "y": 10, "z": 20 }}}}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

-- $geoWithin / $within => $center shape operator
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$center": [[5, 10], 5]}}}' ORDER BY object_id; -- boundary check
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$center": [[15, 14], 10]}}}' ORDER BY object_id;
                                                          document                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$center": [[50, 50], 50]}}}' ORDER BY object_id; -- This will not include [10, 10]
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$center": [[50, 50], 60]}}}' ORDER BY object_id; -- The radius is enough to include [10, 10] now
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$center": [ { "x": 5, "y": 10 }, 5]}}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$center": [[5, 10], 5]}}}' ORDER BY object_id; -- boundary check
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$center": [[15, 14], 10]}}}' ORDER BY object_id;
                                                          document                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$center": [[50, 50], 50]}}}' ORDER BY object_id; -- This will not include [10, 10]
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$center": [[50, 50], 60]}}}' ORDER BY object_id; -- The radius is enough to include [10, 10] now
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$center": [ { "x": 5, "y": 10 }, 5]}}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$center": [[0,0], { "$numberDecimal" : "Infinity" }]}}}' ORDER BY object_id; -- infinite radius
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$within": {"$center": [[5, 5], 3]}}}' ORDER BY object_id; -- _id 201,202,203 on boundary
                                                   document                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "201" }, "geo" : { "loc" : [ { "$numberInt" : "2" }, { "$numberInt" : "5" } ] } }
 { "_id" : { "$numberInt" : "202" }, "geo" : { "loc" : [ { "$numberInt" : "5" }, { "$numberInt" : "2" } ] } }
 { "_id" : { "$numberInt" : "203" }, "geo" : { "loc" : [ { "$numberInt" : "5" }, { "$numberInt" : "8" } ] } }
 { "_id" : { "$numberInt" : "204" }, "geo" : { "loc" : [ { "$numberInt" : "4" }, { "$numberInt" : "5" } ] } }
 { "_id" : { "$numberInt" : "205" }, "geo" : { "loc" : [ { "$numberInt" : "5" }, { "$numberInt" : "4" } ] } }
 { "_id" : { "$numberInt" : "206" }, "geo" : { "loc" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] } }
 { "_id" : { "$numberInt" : "207" }, "geo" : { "loc" : [ { "$numberInt" : "6" }, { "$numberInt" : "5" } ] } }
(7 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$within": {"$center": [[5, 5], 1]}}}' ORDER BY object_id; -- _id 204,205,206 on boundary
                                                   document                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "204" }, "geo" : { "loc" : [ { "$numberInt" : "4" }, { "$numberInt" : "5" } ] } }
 { "_id" : { "$numberInt" : "205" }, "geo" : { "loc" : [ { "$numberInt" : "5" }, { "$numberInt" : "4" } ] } }
 { "_id" : { "$numberInt" : "206" }, "geo" : { "loc" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] } }
 { "_id" : { "$numberInt" : "207" }, "geo" : { "loc" : [ { "$numberInt" : "6" }, { "$numberInt" : "5" } ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$within": {"$center": [[0, 5], 5]}}}' ORDER BY object_id; -- _id 208,209 on boundary
                                                   document                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "201" }, "geo" : { "loc" : [ { "$numberInt" : "2" }, { "$numberInt" : "5" } ] } }
 { "_id" : { "$numberInt" : "204" }, "geo" : { "loc" : [ { "$numberInt" : "4" }, { "$numberInt" : "5" } ] } }
 { "_id" : { "$numberInt" : "208" }, "geo" : { "loc" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] } }
 { "_id" : { "$numberInt" : "209" }, "geo" : { "loc" : [ { "$numberInt" : "0" }, { "$numberInt" : "10" } ] } }
(4 rows)

-- $geoWithin / $within => $polygon shape operator
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[5, 10], [11, 11], [12, 5]]}}}' ORDER BY object_id; -- [10, 10] included
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[10, 10], [10, 10], [10, 10]]}}}' ORDER BY object_id; -- boundary check
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[10, 10], [10, 12], [11, 11], [9, 11]]}}}' ORDER BY object_id; -- Invalid polygon with self intersection
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[10, 10], [20, 20], [26, 26], [25, 12]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[10, 10], [20, 20], [26, 26], [25, 12]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[10, 10], [20, 20], [26, 26], [25, 12]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[10, 10], [80, 80], [60, 60], [20, 20]]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$polygon": [[5, 10], {"x": 11, "y": 11}, [12, 5]]}}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[5, 10], [11, 11], [12, 5]]}}}' ORDER BY object_id; -- [10, 10] included
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[10, 10], [10, 10], [10, 10]]}}}' ORDER BY object_id; -- boundary check
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[10, 10], [10, 12], [11, 11], [9, 11]]}}}' ORDER BY object_id; -- Invalid polygon with self intersection
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[10, 10], [20, 20], [26, 26], [25, 12]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[10, 10], [20, 20], [26, 26], [25, 12]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[10, 10], [20, 20], [26, 26], [25, 12]]}}}' ORDER BY object_id;
                                                                                                                      document                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[10, 10], [80, 80], [60, 60], [20, 20]]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : { "long" : { "$numberLong" : "20" }, "lat" : { "$numberInt" : "20" } } } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "b" : { "long" : { "$numberInt" : "25" }, "lat" : { "$numberInt" : "25" } } }, [ { "$numberDouble" : "30.0" }, { "$numberDecimal" : "30" } ], [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$within": {"$polygon": [[5, 10], {"x": 11, "y": 11}, [12, 5]]}}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

-- Validate non-geo query operator are not pushed to geo indexes but regular indexes and works fine
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$eq": [10, 10]}}' ORDER BY object_id;
                                                 document                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } }
(1 row)

-- Test valid polygons in query
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoIntersects": { "$geometry": { "type": "Polygon", "coordinates": [[[0.0, 0.0], [60.0, 0.0], [90.0, 0.0], [0.0, 0.0]]]}}}}'; -- Polygon with points on a great circle of earth
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoIntersects": { "$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0 ,4], [0, 6], [0, 8], [0, 0]]]}}}}'; -- Polygon with points on the same longitude
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoIntersects": { "$geometry": { "type": "Polygon", "coordinates": [[[-120, 60.0], [0.0, 60.0], [60.0, 60.0], [90.0, 60.0], [-120.0, 60.0]]]}}}}'; -- Polygon with points on a single latitude, appear as straight line in 2d
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoIntersects": { "$geometry": { "type": "Polygon", "coordinates": [[[-120.0, 89], [-60, 89], [0, 89], [120, 89], [-120.0, 89]]]}}}}'; -- Polygon with points on a single latitude close to north pole
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoIntersects": { "$geometry": { "type": "Polygon", "coordinates": [[[-120.0, 60], [-60, 60], [0, 60], [120, 60], [-120.0, 60]], [[-120.0, 70], [-60, 70], [0, 70], [120, 70], [-120.0, 70]]]}}}}'; -- Polygon with points on a single latitude, points going around the earth with similar hole
 document 
---------------------------------------------------------------------
(0 rows)

-- Special case for array of legacy pairs
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 5, "c" : { "d": [ [10, 10], [100, 100] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 6, "c" : { "d": [ [100, 100], [10, 10] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 7, "c" : [{ "d": [100, 100]}, { "d": [10, 10]}] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 8, "c" : [{ "d": [10, 10]}, { "d": [100, 100]}] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Test that no matter the order of legacy pairs in the array, if 1 matches the document is returned
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"c.d": {"$geoWithin": {"$center": [[0, 0], 20]}}}' ORDER BY object_id;
                                                                                    document                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "c" : { "d" : [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ] ] } }
 { "_id" : { "$numberInt" : "6" }, "c" : { "d" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] } }
 { "_id" : { "$numberInt" : "7" }, "c" : [ { "d" : [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ] }, { "d" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } ] }
 { "_id" : { "$numberInt" : "8" }, "c" : [ { "d" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, { "d" : [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ] } ] }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"c.d": {"$geoWithin": {"$center": [[90, 90], 20]}}}' ORDER BY object_id;
                                                                                    document                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "c" : { "d" : [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ] ] } }
 { "_id" : { "$numberInt" : "6" }, "c" : { "d" : [ [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] } }
 { "_id" : { "$numberInt" : "7" }, "c" : [ { "d" : [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ] }, { "d" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } ] }
 { "_id" : { "$numberInt" : "8" }, "c" : [ { "d" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, { "d" : [ { "$numberInt" : "100" }, { "$numberInt" : "100" } ] } ] }
(4 rows)

ROLLBACK;
-- Geographies
BEGIN;
set local enable_seqscan TO on;
\i sql/bson_query_operator_geospatial_geography_core.sql
-- Insert multiple items
-- Old format legacy points are valid for geography
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 1, "geo" : { "loc": [2.1, 2.2] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 2, "geo" : [ { "loc": [3.1, 3.2] }, { "loc": [4.1, 4.2] } ] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 3, "geo" : { "loc": {"type": "Point", "coordinates": [5.1, 5.2] } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 4, "geo" : [ { "loc": {"type": "Point", "coordinates": [6.1, 6.2] } }, { "loc": { "type": "Point", "coordinates": [6.3, 6.4]} }] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 5, "geo" : { "loc": { "type": "MultiPoint", "coordinates": [[7.1, 7.2], [7.3, 7.4]] } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 6, "geo" : { "loc": { "type": "LineString", "coordinates": [[8.1, 8.2], [8.3, 8.4]] } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 7, "geo" : { "loc": { "type": "Polygon", "coordinates": [[[10, 10], [10, -10], [-10, -10], [-10, 10], [10, 10]]] } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 8, "geo" : { "loc": { "type": "Polygon", "coordinates": [[[10, 10], [10, -10], [-10, -10], [-10, 10], [10, 10]], [[5, 5], [5, -5], [-5, -5], [-5, 5], [5, 5]]] } } }', NULL);
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 9, "geo" : { "loc": { "type": "MultiLineString", "coordinates": [[[10, 10], [10, -10], [-10, -10], [-10, 10], [10, 10]], [[5, 5], [5, -5], [-5, -5], [-5, 5], [5, 5]]] } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 10, "geo" : { "loc": { "type": "MultiPolygon", "coordinates": [[[[10, 10], [10, -10], [-10, -10], [-10, 10], [10, 10]], [[5, 5], [5, -5], [-5, -5], [-5, 5], [5, 5]]]] } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 11, "geo" : { "loc": { "type": "GeometryCollection", "geometries": [ {"type": "Point", "coordinates": [11.1, 11.2]}, {"type": "LineString", "coordinates": [[11.3, 11.4], [11.5, 11.6]]}, {"type": "Polygon", "coordinates": [[[5, 5], [5, -5], [-5, -5], [-5, 5], [5, 5]]]}  ] } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 12, "geo" : { "loc": [120, 89.1 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 13, "geo" : { "loc": { "x": 50, "y": 50, "z": 51 } } }', NULL); -- Legacy object format
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 14, "geo" : { "loc": [51, 51, 52] } }', NULL); -- Legacy array format
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 15, "geo" : { "loc": [ -46.67527188, -23.60076866 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 16, "geo" : { "loc": [ -46.67354611, -23.60337759 ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 50, "a" : { "b": [ [40, 40], [45, 45], [50, 50], [55, 55] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 51, "a" : { "b": [ { "x" : 1, "y" : 1 }, { "x" : 2, "y" : 2 }, { "x" : 3, "y" : 3 } ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 52, "a" : { "b": [ ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 53, "a" : { "b": { } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 54, "a" : { "b": [ [], [] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 55, "a" : { "b": [ [10, 10], [120, 80] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 56, "a" : { "b": [ [120, 80], [10, 10] ] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 57, "a" : [{ "b": [120, 80]}, { "b": [10, 10]}] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 58, "a" : [{ "b": [10, 10]}, { "b": [120, 80]}] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- for $centerSphere edge test
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 17, "geo" : { "loc": [4.9757, 2.66966] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 18, "geo" : { "loc": [-4.9757, -2.66966] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 19, "geoPrec" : { "loc": [1, 0], "d": {"$numberDouble": "0.017453292519943295"} } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 20, "geoPrec" : { "loc": [-1, 0], "d": {"$numberDouble": "0.017453292519943295"} } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 21, "geoPrec" : { "loc": [0, 1], "d": {"$numberDouble": "0.017453292519943295"} } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 22, "geoPrec" : { "loc": [0, -1], "d": {"$numberDouble": "0.017453292519943295"} } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Insert some items for testing composite 2dsphere index
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 200, "geoA" : { "type" : "Point", "coordinates": [ 10, 10] }, "geoB": { "type": "Point", "coordinates": [20, 20] } }', NULL); -- Both geoA and geoB
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 201, "geoA" : { "type" : "Point", "coordinates": [ 11, 11] } }', NULL); -- Only geoA
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 202, "geoB" : { "type" : "Point", "coordinates": [ 21, 21] } }', NULL); -- Only geoB
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 203, "geoC" : { "type" : "Point", "coordinates": [ 30, 30] } }', NULL); -- No geoA, no geoB
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Insert some items for composited 2dsphere index with pfe
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 300, "geo1" : { "type" : "Point", "coordinates": [ 10, 10] }, "geo2": { "type": "Point", "coordinates": [20, 20] }, "region": "USA" }', NULL); -- Both geo1 and geo2
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 301, "geo1" : { "type" : "Point", "coordinates": [ 11, 11] }, "region": "USA" }', NULL); -- Only geo1
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 302, "geo2" : { "type" : "Point", "coordinates": [ 21, 21] }, "region": "USA" }', NULL); -- Only geo2
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 303, "geo3" : { "type" : "Point", "coordinates": [ 30, 30] }, "region": "USA" }', NULL); -- No geo1, no geo2
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Insert for large query cap containing all of shapes vertices but not the shape itself.
SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 400, "largeGeo" : { "type" : "LineString", "coordinates": [[96.328125, 5.61598581915534], [153.984375, -6.315298538330033]] }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{ "_id" : 401, "largeGeo" : { "type" : "Polygon", "coordinates": [[
                [98.96484375, -11.350796722383672],
                [135.35156249999997, -11.350796722383672],
                [135.35156249999997, 0.8788717828324276],
                [98.96484375, 0.8788717828324276],
                [98.96484375, -11.350796722383672]
            ]] }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Valid polygon inserts
SELECT documentdb_api.insert_one('db','geoquerytest','{"_id": 601, "geo" : { "loc" : {"type": "Polygon", "coordinates": [[[0.0, 0.0], [60.0, 0.0], [90.0, 0.0], [0.0, 0.0]]] } } }', NULL); -- all points on equator
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{"_id": 602, "geo" : { "loc" : {"type": "Polygon", "coordinates": [[[-120, 60.0], [0.0, 60.0], [60.0, 60.0], [90.0, 60.0], [-120.0, 60.0]]] } } }', NULL); -- all points on same latitude
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','geoquerytest','{"_id": 603, "geo" : { "loc" : {"type": "Polygon", "coordinates": [[[0, 0], [0 ,4], [0, 6], [0, 8], [0, 0]]] } } }', NULL); -- all points on same longitude
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

--$geoIntersects operator
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "MultiPoint", "coordinates": [[1.1, 1.2], [2.1, 2.2], [3.1, 3.2]] } }}}' ORDER BY object_id; -- Validate legacy format works
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "Point", "coordinates": {"lon": 3.1, "lat": 3.2} } }}}' ORDER BY object_id; -- this weird GeoJson mongo native syntax is also supported
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "MultiPoint", "coordinates": [[7.1, 7.2], [4.1, 4.2]] } }}}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
(5 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "LineString", "coordinates": [[7.1, 7.2], [4.1, 4.2], [7.3, 7.4], [2.1, 2.2]] } }}}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
(7 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[ [0, 0], [0, 10], [10, 10], [10, 0], [0, 0] ]] } }}}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "3" }, "geo" : { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "5.0999999999999996447" }, { "$numberDouble" : "5.2000000000000001776" } ] } } }
 { "_id" : { "$numberInt" : "4" }, "geo" : [ { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.0999999999999996447" }, { "$numberDouble" : "6.2000000000000001776" } ] } }, { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.2999999999999998224" }, { "$numberDouble" : "6.4000000000000003553" } ] } } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "6" }, "geo" : { "loc" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "8.0999999999999996447" }, { "$numberDouble" : "8.1999999999999992895" } ], [ { "$numberDouble" : "8.3000000000000007105" }, { "$numberDouble" : "8.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "601" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(13 rows)

-- with holes, should not include document with _id 4
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[ [0, 0], [0, 10], [10, 10], [10, 0], [0, 0] ], [ [4, 4], [4, 7], [7, 7], [7, 4], [4, 4] ]] } }}}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "6" }, "geo" : { "loc" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "8.0999999999999996447" }, { "$numberDouble" : "8.1999999999999992895" } ], [ { "$numberDouble" : "8.3000000000000007105" }, { "$numberDouble" : "8.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "601" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(11 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "LineString", "coordinates": [ [25, 25], [-25, -25] ] } }}}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
 { "_id" : { "$numberInt" : "601" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(6 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "GeometryCollection", "geometries": [ {"type": "LineString", "coordinates": [[-25, -25], [25, 25]]}, {"type": "Point", "coordinates": [2.1, 2.2]} ] } }}}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
 { "_id" : { "$numberInt" : "601" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(7 rows)

-- Legacy formats with $geometry works
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "lon": 50, "lat": 50 } }}}' ORDER BY object_id;
                                                                         document                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "13" }, "geo" : { "loc" : { "x" : { "$numberInt" : "50" }, "y" : { "$numberInt" : "50" }, "z" : { "$numberInt" : "51" } } } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": [51, 51] }}}' ORDER BY object_id;
                                                                document                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "14" }, "geo" : { "loc" : [ { "$numberInt" : "51" }, { "$numberInt" : "51" }, { "$numberInt" : "52" } ] } }
(1 row)

-- Check if a north pole region geography finds a point with _id 12, this is invalid polygon in 2d but valid as a spherical geometry
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[-120.0, 89.0], [0.0, 89.0], [120.0, 89.0], [-120.0, 89.0]]] } }}}' ORDER BY object_id;
                                                                                                                                                                                                                document                                                                                                                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "12" }, "geo" : { "loc" : [ { "$numberInt" : "120" }, { "$numberDouble" : "89.099999999999994316" } ] } }
 { "_id" : { "$numberInt" : "602" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "-120" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "-120.0" }, { "$numberDouble" : "60.0" } ] ] ] } } }
(2 rows)

-- $geoWithin operator works with spherical queries with $geometry (Polygon and Multipolygons only) and $centerSphere
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$geometry": { "type": "Polygon", "coordinates": [[ [0, 0], [0, 10], [10, 10], [10, 0], [0, 0] ]] } }}}' ORDER BY object_id;
                                                                                                                                                                                   document                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "3" }, "geo" : { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "5.0999999999999996447" }, { "$numberDouble" : "5.2000000000000001776" } ] } } }
 { "_id" : { "$numberInt" : "4" }, "geo" : [ { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.0999999999999996447" }, { "$numberDouble" : "6.2000000000000001776" } ] } }, { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.2999999999999998224" }, { "$numberDouble" : "6.4000000000000003553" } ] } } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "6" }, "geo" : { "loc" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "8.0999999999999996447" }, { "$numberDouble" : "8.1999999999999992895" } ], [ { "$numberDouble" : "8.3000000000000007105" }, { "$numberDouble" : "8.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(8 rows)

-- SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$geometry": { "type": "Polygon", "coordinates": [[ [0, 0], [0, 10], [10, 10], [10, 0], [0, 0] ], [ [4, 4], [4, 7], [7, 7], [7, 4], [4, 4] ]] } }}}' ORDER BY object_id;
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$geometry": { "type": "Polygon", "coordinates": [[[-120.0, 89.0], [0.0, 89.0], [120.0, 89.0], [-120.0, 89.0]]] } }}}' ORDER BY object_id;
                                                               document                                                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "12" }, "geo" : { "loc" : [ { "$numberInt" : "120" }, { "$numberDouble" : "89.099999999999994316" } ] } }
(1 row)

-- $centerSphere operator
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$centerSphere": [[0,0], 1] }}}' ORDER BY object_id;
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "3" }, "geo" : { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "5.0999999999999996447" }, { "$numberDouble" : "5.2000000000000001776" } ] } } }
 { "_id" : { "$numberInt" : "4" }, "geo" : [ { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.0999999999999996447" }, { "$numberDouble" : "6.2000000000000001776" } ] } }, { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.2999999999999998224" }, { "$numberDouble" : "6.4000000000000003553" } ] } } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "6" }, "geo" : { "loc" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "8.0999999999999996447" }, { "$numberDouble" : "8.1999999999999992895" } ], [ { "$numberDouble" : "8.3000000000000007105" }, { "$numberDouble" : "8.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
 { "_id" : { "$numberInt" : "15" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.675271879999996827" }, { "$numberDouble" : "-23.600768659999999954" } ] } }
 { "_id" : { "$numberInt" : "16" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.673546109999996645" }, { "$numberDouble" : "-23.603377590000000907" } ] } }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "18" }, "geo" : { "loc" : [ { "$numberDouble" : "-4.9756999999999997897" }, { "$numberDouble" : "-2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(15 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$centerSphere": [[0,0], 4] }}}' ORDER BY object_id; -- still returns results with bigger buffer
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "3" }, "geo" : { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "5.0999999999999996447" }, { "$numberDouble" : "5.2000000000000001776" } ] } } }
 { "_id" : { "$numberInt" : "4" }, "geo" : [ { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.0999999999999996447" }, { "$numberDouble" : "6.2000000000000001776" } ] } }, { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.2999999999999998224" }, { "$numberDouble" : "6.4000000000000003553" } ] } } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "6" }, "geo" : { "loc" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "8.0999999999999996447" }, { "$numberDouble" : "8.1999999999999992895" } ], [ { "$numberDouble" : "8.3000000000000007105" }, { "$numberDouble" : "8.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
 { "_id" : { "$numberInt" : "12" }, "geo" : { "loc" : [ { "$numberInt" : "120" }, { "$numberDouble" : "89.099999999999994316" } ] } }
 { "_id" : { "$numberInt" : "13" }, "geo" : { "loc" : { "x" : { "$numberInt" : "50" }, "y" : { "$numberInt" : "50" }, "z" : { "$numberInt" : "51" } } } }
 { "_id" : { "$numberInt" : "14" }, "geo" : { "loc" : [ { "$numberInt" : "51" }, { "$numberInt" : "51" }, { "$numberInt" : "52" } ] } }
 { "_id" : { "$numberInt" : "15" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.675271879999996827" }, { "$numberDouble" : "-23.600768659999999954" } ] } }
 { "_id" : { "$numberInt" : "16" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.673546109999996645" }, { "$numberDouble" : "-23.603377590000000907" } ] } }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "18" }, "geo" : { "loc" : [ { "$numberDouble" : "-4.9756999999999997897" }, { "$numberDouble" : "-2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "601" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "602" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "-120" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "-120.0" }, { "$numberDouble" : "60.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(20 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$centerSphere": [[0,0], 0.0984] }}}' ORDER BY object_id; -- edge test for $centerSphere
                                                                                                                                  document                                                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "18" }, "geo" : { "loc" : [ { "$numberDouble" : "-4.9756999999999997897" }, { "$numberDouble" : "-2.669659999999999922" } ] } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$centerSphere": [[0,0], 0.21] }}}' ORDER BY object_id; -- 0.21 is enough to include Point(5 5) and not Point(10 10) so shouldn't include some docs 
                                                                                                                                                                                   document                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "3" }, "geo" : { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "5.0999999999999996447" }, { "$numberDouble" : "5.2000000000000001776" } ] } } }
 { "_id" : { "$numberInt" : "4" }, "geo" : [ { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.0999999999999996447" }, { "$numberDouble" : "6.2000000000000001776" } ] } }, { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.2999999999999998224" }, { "$numberDouble" : "6.4000000000000003553" } ] } } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "6" }, "geo" : { "loc" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "8.0999999999999996447" }, { "$numberDouble" : "8.1999999999999992895" } ], [ { "$numberDouble" : "8.3000000000000007105" }, { "$numberDouble" : "8.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "18" }, "geo" : { "loc" : [ { "$numberDouble" : "-4.9756999999999997897" }, { "$numberDouble" : "-2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(9 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo.loc": {"$geoWithin": {"$centerSphere": [[0,0], { "$numberDecimal" : "Infinity" }] }}}' ORDER BY object_id; -- infinite radius should include all docs
                                                                                                                                                                                                                                                                                                                                                                                                    document                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : { "loc" : [ { "$numberDouble" : "2.1000000000000000888" }, { "$numberDouble" : "2.2000000000000001776" } ] } }
 { "_id" : { "$numberInt" : "2" }, "geo" : [ { "loc" : [ { "$numberDouble" : "3.1000000000000000888" }, { "$numberDouble" : "3.2000000000000001776" } ] }, { "loc" : [ { "$numberDouble" : "4.0999999999999996447" }, { "$numberDouble" : "4.2000000000000001776" } ] } ] }
 { "_id" : { "$numberInt" : "3" }, "geo" : { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "5.0999999999999996447" }, { "$numberDouble" : "5.2000000000000001776" } ] } } }
 { "_id" : { "$numberInt" : "4" }, "geo" : [ { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.0999999999999996447" }, { "$numberDouble" : "6.2000000000000001776" } ] } }, { "loc" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "6.2999999999999998224" }, { "$numberDouble" : "6.4000000000000003553" } ] } } ] }
 { "_id" : { "$numberInt" : "5" }, "geo" : { "loc" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "7.0999999999999996447" }, { "$numberDouble" : "7.2000000000000001776" } ], [ { "$numberDouble" : "7.2999999999999998224" }, { "$numberDouble" : "7.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "6" }, "geo" : { "loc" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "8.0999999999999996447" }, { "$numberDouble" : "8.1999999999999992895" } ], [ { "$numberDouble" : "8.3000000000000007105" }, { "$numberDouble" : "8.4000000000000003553" } ] ] } } }
 { "_id" : { "$numberInt" : "7" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] ] } } }
 { "_id" : { "$numberInt" : "9" }, "geo" : { "loc" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } } }
 { "_id" : { "$numberInt" : "10" }, "geo" : { "loc" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "-10" } ], [ { "$numberInt" : "-10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ], [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] ] } } }
 { "_id" : { "$numberInt" : "11" }, "geo" : { "loc" : { "type" : "GeometryCollection", "geometries" : [ { "type" : "Point", "coordinates" : [ { "$numberDouble" : "11.099999999999999645" }, { "$numberDouble" : "11.199999999999999289" } ] }, { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "11.300000000000000711" }, { "$numberDouble" : "11.400000000000000355" } ], [ { "$numberDouble" : "11.5" }, { "$numberDouble" : "11.599999999999999645" } ] ] }, { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "-5" } ], [ { "$numberInt" : "-5" }, { "$numberInt" : "5" } ], [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] ] ] } ] } } }
 { "_id" : { "$numberInt" : "12" }, "geo" : { "loc" : [ { "$numberInt" : "120" }, { "$numberDouble" : "89.099999999999994316" } ] } }
 { "_id" : { "$numberInt" : "13" }, "geo" : { "loc" : { "x" : { "$numberInt" : "50" }, "y" : { "$numberInt" : "50" }, "z" : { "$numberInt" : "51" } } } }
 { "_id" : { "$numberInt" : "14" }, "geo" : { "loc" : [ { "$numberInt" : "51" }, { "$numberInt" : "51" }, { "$numberInt" : "52" } ] } }
 { "_id" : { "$numberInt" : "15" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.675271879999996827" }, { "$numberDouble" : "-23.600768659999999954" } ] } }
 { "_id" : { "$numberInt" : "16" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.673546109999996645" }, { "$numberDouble" : "-23.603377590000000907" } ] } }
 { "_id" : { "$numberInt" : "17" }, "geo" : { "loc" : [ { "$numberDouble" : "4.9756999999999997897" }, { "$numberDouble" : "2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "18" }, "geo" : { "loc" : [ { "$numberDouble" : "-4.9756999999999997897" }, { "$numberDouble" : "-2.669659999999999922" } ] } }
 { "_id" : { "$numberInt" : "601" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "0.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "0.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "602" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "-120" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "0.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "60.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "90.0" }, { "$numberDouble" : "60.0" } ], [ { "$numberDouble" : "-120.0" }, { "$numberDouble" : "60.0" } ] ] ] } } }
 { "_id" : { "$numberInt" : "603" }, "geo" : { "loc" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "4" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "6" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "8" } ], [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] ] ] } } }
(20 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"largeGeo": {"$geoWithin": {"$centerSphere": [[-59.80246852929814, -2.3633072488322853], 2.768403272464979]}}}' ORDER BY object_id; -- no result
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"largeGeo": {"$geoWithin": {"$centerSphere": [[-61.52266094410311, 17.79937981451866], 2.9592242752161573]}}}' ORDER BY object_id; -- big enough for linestring but not for polygon
                                                                                                                                    document                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "400" }, "largeGeo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "96.328125" }, { "$numberDouble" : "5.6159858191553402307" } ], [ { "$numberDouble" : "153.984375" }, { "$numberDouble" : "-6.3152985383300332956" } ] ] } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"largeGeo": {"$geoWithin": {"$centerSphere": [[-61.52266094410311, 17.79937981451866], 3.15]}}}' ORDER BY object_id; -- radius > pi, both docs in result
                                                                                                                                                                                                                                                                                      document                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "400" }, "largeGeo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "96.328125" }, { "$numberDouble" : "5.6159858191553402307" } ], [ { "$numberDouble" : "153.984375" }, { "$numberDouble" : "-6.3152985383300332956" } ] ] } }
 { "_id" : { "$numberInt" : "401" }, "largeGeo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "98.96484375" }, { "$numberDouble" : "-11.350796722383671877" } ], [ { "$numberDouble" : "135.35156249999997158" }, { "$numberDouble" : "-11.350796722383671877" } ], [ { "$numberDouble" : "135.35156249999997158" }, { "$numberDouble" : "0.87887178283242761712" } ], [ { "$numberDouble" : "98.96484375" }, { "$numberDouble" : "0.87887178283242761712" } ], [ { "$numberDouble" : "98.96484375" }, { "$numberDouble" : "-11.350796722383671877" } ] ] ] } }
(2 rows)

-- Testing composite 2dsphere index
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geoA": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}}' ORDER BY object_id;
                                                                                                                    document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "200" }, "geoA" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, "geoB" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ] } }
 { "_id" : { "$numberInt" : "201" }, "geoA" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "11" }, { "$numberInt" : "11" } ] } }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geoB": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}}' ORDER BY object_id;
                                                                                                                    document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "200" }, "geoA" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, "geoB" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ] } }
 { "_id" : { "$numberInt" : "202" }, "geoB" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "21" }, { "$numberInt" : "21" } ] } }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') 
    WHERE document @@ '{"geoA": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}, 
                        "geoB": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}}' ORDER BY object_id;
                                                                                                                    document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "200" }, "geoA" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, "geoB" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ] } }
(1 row)

-- Testing composite 2dsphere with pfe
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo1": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}, "region": {"$eq": "USA" }}' ORDER BY object_id;
                                                                                                                             document                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "300" }, "geo1" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, "geo2" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ] }, "region" : "USA" }
 { "_id" : { "$numberInt" : "301" }, "geo1" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "11" }, { "$numberInt" : "11" } ] }, "region" : "USA" }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geo2": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}, "region": {"$eq": "USA" }}' ORDER BY object_id;
                                                                                                                             document                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "300" }, "geo1" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, "geo2" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ] }, "region" : "USA" }
 { "_id" : { "$numberInt" : "302" }, "geo2" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "21" }, { "$numberInt" : "21" } ] }, "region" : "USA" }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') 
    WHERE document @@ '{"geo1": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }} ,
                        "geo2": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }} ,
                        "region": { "$eq": "USA" } }' ORDER BY object_id;
                                                                                                                             document                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "300" }, "geo1" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, "geo2" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ] }, "region" : "USA" }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') 
    WHERE document @@ '{"geo1": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}, 
                        "geo2": {"$geoIntersects": {"$geometry": { "type": "Polygon", "coordinates": [[[0, 0], [0, 50], [50, 50], [50, 0], [0, 0]]]} }}}' ORDER BY object_id; -- This one should not use index because pfe doesn't match but should return same values
                                                                                                                             document                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "300" }, "geo1" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, "geo2" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ] }, "region" : "USA" }
(1 row)

-- Make sure a really big query that requires buffer reallocs don't mess up geometry/geography and return the result
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{ "geo.loc" : { "$geoIntersects" : { "$geometry" : '
                '{ "type" : "MultiPolygon", "coordinates" : [[[[-46.67914894304542, -23.39591591], [-46.69148969424672, -23.39647184], [-46.70371190620094, -23.39813429], '
                '[-46.7156981694656, -23.40088729], [-46.72733332377327, -23.40470439], [-46.7385055566174, -23.40954892], [-46.749107470871145, -23.41537434], '
                '[-46.75903711150689, -23.42212468], [-46.768198941818476, -23.42973505], [-46.77650475996186, -23.43813231], [-46.78387454712577, -23.44723573], '
                '[-46.79023723921629, -23.45695777], [-46.7955314145885, -23.46720494], [-46.79970589107978, -23.47787865], [-46.80272022639018, -23.48887621], '
                '[-46.80454511671058, -23.50009177], [-46.805162689414196, -23.51141736], [-46.804566686594455, -23.52274393], [-46.80276253724614, -23.53396238], '
                '[-46.79976731693784, -23.54496462], [-46.79560959490368, -23.55564464], [-46.79032916958054, -23.56589949], [-46.783976694723066, -23.5756303], '
                '[-46.77661319932978, -23.58474322], [-46.76830950569968, -23.59315037], [-46.75914555099343, -23.60077063], [-46.74920961868761, -23.60753048], [-46.73859748726804, -23.61336466], '
                '[-46.727411504398404, -23.61821688], [-46.71575959561004, -23.62204028], [-46.703754217276085, -23.62479797], [-46.691511264249215, -23.6264633], '
                '[-46.67914894304542, -23.6270202], [-46.66678662184163, -23.6264633], [-46.65454366881477, -23.62479797], [-46.642538290480815, -23.62204028], '
                '[-46.63088638169245, -23.61821688], [-46.619700398822815, -23.61336466], [-46.60908826740324, -23.60753048], [-46.59915233509742, -23.60077063], '
                '[-46.589988380391155, -23.59315037], [-46.58168468676106, -23.58474322], [-46.57432119136778, -23.5756303], [-46.56796871651031, -23.56589949], '
                '[-46.56268829118717, -23.55564464], [-46.558530569153, -23.54496462], [-46.5555353488447, -23.53396238], [-46.55373119949638, -23.52274393], '
                '[-46.55313519667665, -23.51141736], [-46.55375276938027, -23.50009177], [-46.55557765970067, -23.48887621], [-46.55859199501106, -23.47787865], '
                '[-46.56276647150235, -23.46720494], [-46.56806064687455, -23.45695777], [-46.57442333896507, -23.44723573], [-46.58179312612898, -23.43813231], '
                '[-46.59009894427236, -23.42973505], [-46.59926077458395, -23.42212468], [-46.60919041521971, -23.41537434], [-46.61979232947344, -23.40954892], '
                '[-46.63096456231758, -23.40470439], [-46.64259971662524, -23.40088729], [-46.65458597988991, -23.39813429], [-46.66680819184413, -23.39647184], '
                '[-46.67914894304542, -23.39591591]]]]}}}}' ORDER BY object_id;
                                                                          document                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "15" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.675271879999996827" }, { "$numberDouble" : "-23.600768659999999954" } ] } }
 { "_id" : { "$numberInt" : "16" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.673546109999996645" }, { "$numberDouble" : "-23.603377590000000907" } ] } }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{ "geo.loc" : { "$geoWithin" : { "$geometry" : '
                '{ "type" : "MultiPolygon", "coordinates" : [[[[-46.67914894304542, -23.39591591], [-46.69148969424672, -23.39647184], [-46.70371190620094, -23.39813429], '
                '[-46.7156981694656, -23.40088729], [-46.72733332377327, -23.40470439], [-46.7385055566174, -23.40954892], [-46.749107470871145, -23.41537434], '
                '[-46.75903711150689, -23.42212468], [-46.768198941818476, -23.42973505], [-46.77650475996186, -23.43813231], [-46.78387454712577, -23.44723573], '
                '[-46.79023723921629, -23.45695777], [-46.7955314145885, -23.46720494], [-46.79970589107978, -23.47787865], [-46.80272022639018, -23.48887621], '
                '[-46.80454511671058, -23.50009177], [-46.805162689414196, -23.51141736], [-46.804566686594455, -23.52274393], [-46.80276253724614, -23.53396238], '
                '[-46.79976731693784, -23.54496462], [-46.79560959490368, -23.55564464], [-46.79032916958054, -23.56589949], [-46.783976694723066, -23.5756303], '
                '[-46.77661319932978, -23.58474322], [-46.76830950569968, -23.59315037], [-46.75914555099343, -23.60077063], [-46.74920961868761, -23.60753048], [-46.73859748726804, -23.61336466], '
                '[-46.727411504398404, -23.61821688], [-46.71575959561004, -23.62204028], [-46.703754217276085, -23.62479797], [-46.691511264249215, -23.6264633], '
                '[-46.67914894304542, -23.6270202], [-46.66678662184163, -23.6264633], [-46.65454366881477, -23.62479797], [-46.642538290480815, -23.62204028], '
                '[-46.63088638169245, -23.61821688], [-46.619700398822815, -23.61336466], [-46.60908826740324, -23.60753048], [-46.59915233509742, -23.60077063], '
                '[-46.589988380391155, -23.59315037], [-46.58168468676106, -23.58474322], [-46.57432119136778, -23.5756303], [-46.56796871651031, -23.56589949], '
                '[-46.56268829118717, -23.55564464], [-46.558530569153, -23.54496462], [-46.5555353488447, -23.53396238], [-46.55373119949638, -23.52274393], '
                '[-46.55313519667665, -23.51141736], [-46.55375276938027, -23.50009177], [-46.55557765970067, -23.48887621], [-46.55859199501106, -23.47787865], '
                '[-46.56276647150235, -23.46720494], [-46.56806064687455, -23.45695777], [-46.57442333896507, -23.44723573], [-46.58179312612898, -23.43813231], '
                '[-46.59009894427236, -23.42973505], [-46.59926077458395, -23.42212468], [-46.60919041521971, -23.41537434], [-46.61979232947344, -23.40954892], '
                '[-46.63096456231758, -23.40470439], [-46.64259971662524, -23.40088729], [-46.65458597988991, -23.39813429], [-46.66680819184413, -23.39647184], '
                '[-46.67914894304542, -23.39591591]]]]}}}}' ORDER BY object_id;
                                                                          document                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "15" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.675271879999996827" }, { "$numberDouble" : "-23.600768659999999954" } ] } }
 { "_id" : { "$numberInt" : "16" }, "geo" : { "loc" : [ { "$numberDouble" : "-46.673546109999996645" }, { "$numberDouble" : "-23.603377590000000907" } ] } }
(2 rows)

-- $centerSphere precision test
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"geoPrec.loc": {"$geoWithin": {"$centerSphere": [[0,0], {"$numberDouble": "0.017453292519943295"}] }}}' ORDER BY object_id;
                                                                                document                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "19" }, "geoPrec" : { "loc" : [ { "$numberInt" : "1" }, { "$numberInt" : "0" } ], "d" : { "$numberDouble" : "0.017453292519943295474" } } }
 { "_id" : { "$numberInt" : "20" }, "geoPrec" : { "loc" : [ { "$numberInt" : "-1" }, { "$numberInt" : "0" } ], "d" : { "$numberDouble" : "0.017453292519943295474" } } }
 { "_id" : { "$numberInt" : "21" }, "geoPrec" : { "loc" : [ { "$numberInt" : "0" }, { "$numberInt" : "1" } ], "d" : { "$numberDouble" : "0.017453292519943295474" } } }
 { "_id" : { "$numberInt" : "22" }, "geoPrec" : { "loc" : [ { "$numberInt" : "0" }, { "$numberInt" : "-1" } ], "d" : { "$numberDouble" : "0.017453292519943295474" } } }
(4 rows)

-- $centerSphere test with array of legacy coordinates in document
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$centerSphere": [[0,0], 2] }}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "50" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
 { "_id" : { "$numberInt" : "51" }, "a" : { "b" : [ { "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "1" } }, { "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "2" } }, { "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "3" } } ] } }
 { "_id" : { "$numberInt" : "55" }, "a" : { "b" : [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] ] } }
 { "_id" : { "$numberInt" : "56" }, "a" : { "b" : [ [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] } }
 { "_id" : { "$numberInt" : "57" }, "a" : [ { "b" : [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] }, { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } ] }
 { "_id" : { "$numberInt" : "58" }, "a" : [ { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, { "b" : [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] } ] }
(6 rows)

-- Test that no matter the order of legacy pairs in the array, if 1 matches the document is returned
SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$centerSphere": [[0, 0], 1]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "50" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
 { "_id" : { "$numberInt" : "51" }, "a" : { "b" : [ { "x" : { "$numberInt" : "1" }, "y" : { "$numberInt" : "1" } }, { "x" : { "$numberInt" : "2" }, "y" : { "$numberInt" : "2" } }, { "x" : { "$numberInt" : "3" }, "y" : { "$numberInt" : "3" } } ] } }
 { "_id" : { "$numberInt" : "55" }, "a" : { "b" : [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] ] } }
 { "_id" : { "$numberInt" : "56" }, "a" : { "b" : [ [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] } }
 { "_id" : { "$numberInt" : "57" }, "a" : [ { "b" : [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] }, { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } ] }
 { "_id" : { "$numberInt" : "58" }, "a" : [ { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, { "b" : [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] } ] }
(6 rows)

SELECT document FROM documentdb_api.collection('db', 'geoquerytest') WHERE document @@ '{"a.b": {"$geoWithin": {"$centerSphere": [[90, 90], 1]}}}' ORDER BY object_id;
                                                                                                                                    document                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "50" }, "a" : { "b" : [ [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ], [ { "$numberInt" : "45" }, { "$numberInt" : "45" } ], [ { "$numberInt" : "50" }, { "$numberInt" : "50" } ], [ { "$numberInt" : "55" }, { "$numberInt" : "55" } ] ] } }
 { "_id" : { "$numberInt" : "55" }, "a" : { "b" : [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] ] } }
 { "_id" : { "$numberInt" : "56" }, "a" : { "b" : [ [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ], [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] ] } }
 { "_id" : { "$numberInt" : "57" }, "a" : [ { "b" : [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] }, { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] } ] }
 { "_id" : { "$numberInt" : "58" }, "a" : [ { "b" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ] }, { "b" : [ { "$numberInt" : "120" }, { "$numberInt" : "80" } ] } ] }
(5 rows)

ROLLBACK;
