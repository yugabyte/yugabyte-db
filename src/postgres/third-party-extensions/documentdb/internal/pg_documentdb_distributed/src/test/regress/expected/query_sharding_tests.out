SET search_path TO documentdb_core,documentdb_api,documentdb_api_catalog,documentdb_api_internal;
SET citus.next_shard_id TO 739000;
SET documentdb.next_collection_id TO 7390;
SET documentdb.next_collection_index_id TO 7390;
SELECT documentdb_api.insert_one('qst', 'single_shard', '{ "_id": 1, "a": 1, "b": 2, "c": 3, "d": 4 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('qst', 'comp_shard', '{ "_id": 1, "a": 1, "b": 2, "c": 3, "d": 4 }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.shard_collection('qst', 'single_shard', '{ "a": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT documentdb_api.shard_collection('qst', 'comp_shard', '{ "a": "hashed", "b": "hashed", "c": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- cross shard queries
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "single_shard", "pipeline": [ { "$match": { "e": 1 } } ] }');
                                                     QUERY PLAN                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7391_739006 collection
               Filter: (document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson)
(7 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "comp_shard", "pipeline": [ { "$match": { "e": 1 } } ] }');
                                                     QUERY PLAN                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7392_739014 collection
               Filter: (document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson)
(7 rows)

-- single shard queries
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "single_shard", "pipeline": [ { "$match": { "e": 1, "a": 4 } } ] }');
                                                                                                       QUERY PLAN                                                                                                        
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_7391_739006 collection
               Recheck Cond: (shard_key_value = '4004935074940511305'::bigint)
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson))
               ->  Bitmap Index Scan on _id_
                     Index Cond: (shard_key_value = '4004935074940511305'::bigint)
(10 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "comp_shard", "pipeline": [ { "$match": { "e": 1, "a": 4, "b": 2, "c": 6 } } ] }');
                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7392_739014 collection
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "2" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "6" } }'::documentdb_core.bson) AND (shard_key_value = '4112493706261607605'::bigint))
(7 rows)

-- single shard with and
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "single_shard", "pipeline": [ { "$match": { "$and": [ { "e": 1 }, { "a": 4 } ] } } ] }');
                                                                                                       QUERY PLAN                                                                                                        
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_7391_739006 collection
               Recheck Cond: (shard_key_value = '4004935074940511305'::bigint)
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson))
               ->  Bitmap Index Scan on _id_
                     Index Cond: (shard_key_value = '4004935074940511305'::bigint)
(10 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "comp_shard", "pipeline": [ { "$match": { "$and": [ { "e": 1 }, { "a": 4 }, { "b": 2 }, { "c": 6 } ] } } ] }');
                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7392_739014 collection
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "2" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "6" } }'::documentdb_core.bson) AND (shard_key_value = '4112493706261607605'::bigint))
(7 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "comp_shard", "pipeline": [ { "$match": { "$and": [ { "e": 1, "a": 4 }, { "b": 2, "c": 6 } ] } } ] }');
                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7392_739014 collection
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "2" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "6" } }'::documentdb_core.bson) AND (shard_key_value = '4112493706261607605'::bigint))
(7 rows)

-- all components speciied but not equals, cross-shard
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "single_shard", "pipeline": [ { "$match": { "$and": [ { "e": 1 }, { "a": { "$ne": 4 } } ] } } ] }');
                                                                                                        QUERY PLAN                                                                                                        
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7391_739006 collection
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@!=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson))
(7 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "comp_shard", "pipeline": [ { "$match": { "$and": [ { "e": 1, "a": 4 }, { "b": 2, "c": { "$gt": 6 } } ] } } ] }');
                                                                                                                                                                                                         QUERY PLAN                                                                                                                                                                                                          
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7392_739014 collection
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "2" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@>) '{ "c" : { "$numberInt" : "6" } }'::documentdb_core.bson))
(7 rows)

-- $or with a single branch - single shard
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "single_shard", "pipeline": [ { "$match": { "$or": [ { "a": 4 } ] } } ] }');
                                                        QUERY PLAN                                                        
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_7391_739006 collection
               Recheck Cond: (shard_key_value = '4004935074940511305'::bigint)
               Filter: (document OPERATOR(documentdb_api_catalog.@*=) '{ "a" : [ { "$numberInt" : "4" } ] }'::documentdb_core.bson)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (shard_key_value = '4004935074940511305'::bigint)
(10 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "comp_shard", "pipeline": [ { "$match": { "$or": [ { "e": 1, "a": 4, "b": 2, "c": 6 } ] } } ] }');
                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7392_739014 collection
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "2" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "6" } }'::documentdb_core.bson) AND (shard_key_value = '4112493706261607605'::bigint))
(7 rows)

-- top level $or - N shard query but not all branches have shard key: cross-shard
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "single_shard", "pipeline": [ { "$match": { "$or": [ { "e": 1 }, { "a": 4 } ] } } ] }');
                                                                                                       QUERY PLAN                                                                                                       
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7391_739006 collection
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) OR (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson))
(7 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "comp_shard", "pipeline": [ { "$match": { "$or": [ { "e": 1, "a": 4, "b": 2, "c": 6 }, { "a": 4, "b": 5 } ] } } ] }');
                                                                                                                                                                                                                                                            QUERY PLAN                                                                                                                                                                                                                                                            
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7392_739014 collection
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson) AND (((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "2" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "6" } }'::documentdb_core.bson)) OR (document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "5" } }'::documentdb_core.bson)))
(7 rows)

-- top level $or - all branches have shard key - N shard
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "single_shard", "pipeline": [ { "$match": { "$or": [ { "e": 1, "a": 5 }, { "a": 4 } ] } } ] }');
                                                                                                                                                         QUERY PLAN                                                                                                                                                         
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 2
   Tasks Shown: One of 2
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_7391_739012 collection
               Recheck Cond: ((shard_key_value = '1786987034919379147'::bigint) OR (shard_key_value = '4004935074940511305'::bigint))
               Filter: (((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "5" } }'::documentdb_core.bson)) OR (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson))
               ->  BitmapOr
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (shard_key_value = '1786987034919379147'::bigint)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (shard_key_value = '4004935074940511305'::bigint)
(13 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "comp_shard", "pipeline": [ { "$match": { "$or": [ { "e": 1, "a": 4, "b": 2, "c": 6 }, { "a": 4, "b": 5, "c": 9 } ] } } ] }');
                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 2
   Tasks Shown: One of 2
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7392_739014 collection
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson) AND ((shard_key_value = '4112493706261607605'::bigint) OR (shard_key_value = '-6685363114159754435'::bigint)) AND (((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "2" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "6" } }'::documentdb_core.bson)) OR ((document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "5" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "9" } }'::documentdb_core.bson))))
(7 rows)

-- $and  and $or with $and having shard key and $or having shard key - single shard
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "single_shard", "pipeline": [ { "$match": { "$and": [ { "a": 15}, { "$or": [ { "e": 1, "a": 5 }, { "a": 4 } ] } ] } } ] }');
                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7391_739013 collection
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "15" } }'::documentdb_core.bson) AND (shard_key_value = '8792588867541173546'::bigint) AND (((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "5" } }'::documentdb_core.bson)) OR (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson)))
(7 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "comp_shard", "pipeline": [ { "$match": { "$and": [ { "a": 15, "b": 3, "c": 7, "g": 5 }, { "$or": [ { "e": 1, "a": 4, "b": 2, "c": 6 }, { "a": 4, "b": 5, "c": 9 } ] } ] } } ] }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_7392_739017 collection
               Recheck Cond: (shard_key_value = '5799615767555655734'::bigint)
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "15" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "3" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "7" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "g" : { "$numberInt" : "5" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson) AND (((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "2" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "6" } }'::documentdb_core.bson)) OR ((document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "5" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "9" } }'::documentdb_core.bson))))
               ->  Bitmap Index Scan on _id_
                     Index Cond: (shard_key_value = '5799615767555655734'::bigint)
(10 rows)

-- $and and $or with $or having shard key - N shard
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "single_shard", "pipeline": [ { "$match": { "$and": [ { "g": 15}, { "$or": [ { "e": 1, "a": 5 }, { "a": 4 } ] } ] } } ] }');
                                                                                                                                                                                                           QUERY PLAN                                                                                                                                                                                                            
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 2
   Tasks Shown: One of 2
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_7391_739012 collection
               Recheck Cond: ((shard_key_value = '1786987034919379147'::bigint) OR (shard_key_value = '4004935074940511305'::bigint))
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "g" : { "$numberInt" : "15" } }'::documentdb_core.bson) AND (((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "5" } }'::documentdb_core.bson)) OR (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson)))
               ->  BitmapOr
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (shard_key_value = '1786987034919379147'::bigint)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (shard_key_value = '4004935074940511305'::bigint)
(13 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "comp_shard", "pipeline": [ { "$match": { "$and": [ { "g": 5 }, { "$or": [ { "e": 1, "a": 4, "b": 2, "c": 6 }, { "a": 4, "b": 5, "c": 9 } ] } ] } } ] }');
                                                                                                                                                                                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 2
   Tasks Shown: One of 2
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7392_739014 collection
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "g" : { "$numberInt" : "5" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson) AND ((shard_key_value = '4112493706261607605'::bigint) OR (shard_key_value = '-6685363114159754435'::bigint)) AND (((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "2" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "6" } }'::documentdb_core.bson)) OR ((document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "5" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "9" } }'::documentdb_core.bson))))
(7 rows)

-- $and and $or with $or not having shard key - cross-shard
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "single_shard", "pipeline": [ { "$match": { "$and": [ { "g": 15}, { "$or": [ { "e": 1}, { "a": 4 } ] } ] } } ] }');
                                                                                                                                                         QUERY PLAN                                                                                                                                                          
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7391_739006 collection
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "g" : { "$numberInt" : "15" } }'::documentdb_core.bson) AND ((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) OR (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson)))
(7 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('qst', '{ "aggregate": "comp_shard", "pipeline": [ { "$match": { "$and": [ { "g": 5 }, { "$or": [ { "e": 1, "a": 4, "c": 6 }, { "a": 4, "b": 5, "c": 9 } ] } ] } } ] }');
                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                              
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_7392_739014 collection
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "g" : { "$numberInt" : "5" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" } }'::documentdb_core.bson) AND (((document OPERATOR(documentdb_api_catalog.@=) '{ "e" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "6" } }'::documentdb_core.bson)) OR ((document OPERATOR(documentdb_api_catalog.@=) '{ "b" : { "$numberInt" : "5" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "9" } }'::documentdb_core.bson))))
(7 rows)

