SET search_path TO documentdb_api_catalog;
SET citus.next_shard_id TO 498000;
SET documentdb.next_collection_id TO 4980;
SET documentdb.next_collection_index_id TO 4980;
SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 1, "a": { "b": [ 0, 0]} }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 2, "a": { "b": [ 1.1, 1.1]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 3, "a": { "b": [ 2.29, 2.29]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 4, "a": { "b": [ 3.31, 3.31]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 5, "a": { "b": [ 4.42, 4.42]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 6, "a": { "b": [ 5.5, 5.5]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 7, "a": { "b": [ 6.66, 6.66]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 8, "a": { "b": [ 7.74, 7.74]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 9, "a": { "b": [ 8.81, 8.81]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 10, "a": { "geo": {"type": "Point", "coordinates": [35.3, 35.4]}} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 11, "a": { "geo": {"type": "LineString", "coordinates": [[35.36, 35.42], [32.3, 30]]}} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 12, "a": { "geo": {"type": "Polygon", "coordinates": [[[35.73, 35.74], [38.6, 35.3], [38.7, 39.2], [35.73, 35.74]]]}} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 13, "a": { "geo": {"type": "MultiPoint", "coordinates": [[35.43, 35.44], [32.3, 30]]}} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 14, "a": { "geo": {"type": "MultiLineString", "coordinates": [[[35.83, 35.84], [32.3, 30]]]}} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 15, "a": { "geo": {"type": "MultiPolygon", "coordinates": [[[[35.312, 35.441], [38.644, 35.3231], [38.71, 39.32], [35.312, 35.441]]]]}} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Validations (more validations to follow)
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$match": { "query": {  } } }, { "$geoNear": { "near": [5, 6], "key": "a.b", "distanceField": "dist.calculated" } } ]}');
ERROR:  $geoNear was not the first stage in the pipeline.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated" } } ]}');
ERROR:  $geoNear requires a 2d or 2dsphere index, but none were found
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": {  } } ]}');
ERROR:  $geoNear requires a 'distanceField' option as a String
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": "value" } ]}');
ERROR:  invalid parameter: expected an object ($geoNear)
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": true, "distanceField": "dist.calculated", "key": "a" } } ]}');
ERROR:  $geoNear requires near argument to be a GeoJSON object or a legacy point(array)
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a", "query": { "$text": { "$search": "cat" } } } } ]}');
ERROR:  text and geoNear not allowed in same query
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a", "query": { "$or": [{"$text": { "$search": "cat" }}, {"b": 2}] } } } ]}');        
ERROR:  text and geoNear not allowed in same query
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a", "query": { "a": {"$near": [1, 1]}} } } ]}');       
ERROR:  Too many geoNear expressions
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a", "query": { "a": {"$nearSphere": {"coordinates": [1, 1]}}} } } ]}'); 
ERROR:  Too many geoNear expressions
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a",  "minDistance": -1} } ]}');
ERROR:  minDistance must be nonnegative
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a",  "minDistance": {"$numberDouble": "-Infinity"}} } ]}');
ERROR:  minDistance must be nonnegative
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a",  "minDistance": {"$numberDouble": "NaN"}} } ]}');
ERROR:  minDistance must be non-negative
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a",  "minDistance": {"$numberDouble": "-NaN"}} } ]}');
ERROR:  minDistance must be non-negative
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a",  "maxDistance": {"$numberDecimal": "-Infinity"}} } ]}');
ERROR:  maxDistance must be nonnegative
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a",  "maxDistance": {"$numberDecimal": "NaN"}} } ]}');
ERROR:  maxDistance must be non-negative
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a",  "maxDistance": {"$numberDecimal": "-NaN"}} } ]}');
ERROR:  maxDistance must be non-negative
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a"} }, { "$match": { "a": { "$near": {"coordinates": [1,1]}}}} ]}');
ERROR:  Too many geoNear expressions
-- Tests for verifying strict index usage
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b" } }] }');
ERROR:  planner returned error :: caused by :: unable to find index for $geoNear query
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "key": "a.b" } }] }');
ERROR:  planner returned error :: caused by :: unable to find index for $geoNear query
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "agg_geonear", "indexes": [{"key": {"a.b": "2d"}, "name": "my_2d_ab_idx" }, {"key": {"a.b": "2dsphere"}, "name": "my_2ds_ab_idx" }, {"key": {"a.geo": "2dsphere"}, "name": "my_2ds_ageo_idx" }, {"key": {"a.c": "2d"}, "name": "my_2d_ac_idx" }]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "5" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_distributed_test_helpers.drop_primary_key('db','agg_geonear');
 drop_primary_key 
---------------------------------------------------------------------
 
(1 row)

SELECT * FROM documentdb_distributed_test_helpers.get_collection_indexes('db', 'agg_geonear') ORDER BY collection_id, index_id;
 collection_id | index_id |                                                               index_spec_as_bson                                                                | index_is_valid 
---------------------------------------------------------------------
          4980 |     4981 | { "v" : { "$numberInt" : "2" }, "key" : { "a.b" : "2d" }, "name" : "my_2d_ab_idx" }                                                             | t
          4980 |     4982 | { "v" : { "$numberInt" : "2" }, "key" : { "a.b" : "2dsphere" }, "name" : "my_2ds_ab_idx", "2dsphereIndexVersion" : { "$numberInt" : "3" } }     | t
          4980 |     4983 | { "v" : { "$numberInt" : "2" }, "key" : { "a.geo" : "2dsphere" }, "name" : "my_2ds_ageo_idx", "2dsphereIndexVersion" : { "$numberInt" : "3" } } | t
          4980 |     4984 | { "v" : { "$numberInt" : "2" }, "key" : { "a.c" : "2d" }, "name" : "my_2d_ac_idx" }                                                             | t
(4 rows)

\d documentdb_data.documents_4980
                   Table "documentdb_data.documents_4980"
     Column      |           Type           | Collation | Nullable | Default 
---------------------------------------------------------------------
 shard_key_value | bigint                   |           | not null | 
 object_id       | documentdb_core.bson     |           | not null | 
 document        | documentdb_core.bson     |           | not null | 
 creation_time   | timestamp with time zone |           |          | 
Indexes:
    "documents_rum_index_4981" gist (bson_validate_geometry(document, 'a.b'::text) bson_gist_geometry_ops_2d (path='a.b', minbound='-180', maxbound='180')) WHERE bson_validate_geometry(document, 'a.b'::text) IS NOT NULL
    "documents_rum_index_4982" gist (bson_validate_geography(document, 'a.b'::text) bson_gist_geography_ops_2d (path='a.b')) WHERE bson_validate_geography(document, 'a.b'::text) IS NOT NULL
    "documents_rum_index_4983" gist (bson_validate_geography(document, 'a.geo'::text) bson_gist_geography_ops_2d (path='a.geo')) WHERE bson_validate_geography(document, 'a.geo'::text) IS NOT NULL
    "documents_rum_index_4984" gist (bson_validate_geometry(document, 'a.c'::text) bson_gist_geometry_ops_2d (path='a.c', minbound='-180', maxbound='180')) WHERE bson_validate_geometry(document, 'a.c'::text) IS NOT NULL
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '4980'::bigint)

-- If geo indexes are available on different paths then also geonear should fail
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "key": "not_available" } }] }');
ERROR:  planner returned error :: caused by :: unable to find index for $geoNear query
BEGIN;
-- Find using $geoNear
set local citus.enable_local_execution TO OFF;
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b" } }, { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                      document                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "calculated" : { "$numberDouble" : "70711.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "calculated" : { "$numberDouble" : "168309.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "calculated" : { "$numberDouble" : "178639.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "calculated" : { "$numberDouble" : "317682.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "calculated" : { "$numberDouble" : "324580.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "calculated" : { "$numberDouble" : "459437.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "calculated" : { "$numberDouble" : "473415.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "calculated" : { "$numberDouble" : "626259.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "calculated" : { "$numberDouble" : "781025.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                             document                                                                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "70711.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "168309.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "178639.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "317682.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "324580.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "459437.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "473415.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "626259.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "781025.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                             document                                                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "1231.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "2936.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "3101.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "5539.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "5636.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "8011.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "8218.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "10921.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "13621.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location", "distanceMultiplier": 6378.1 } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                              document                                                                                                                                                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "7851641.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "18726743.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "19781171.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "35330111.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "35946104.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "51094295.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "52412129.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "69654220.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "86877567.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "spherical": false, "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                             document                                                                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "70711.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "168309.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "178639.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "317682.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "324580.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "459437.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "473415.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "626259.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "781025.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "spherical": false, "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                                document                                                                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "7842911090.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "18705922360.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "19759178280.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "35290831015.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "35906139203.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "51037488256.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "52353856384.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "69576778059.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "86780975615.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "spherical": false, "key": "a.b", "includeLocs": "dist.location", "distanceMultiplier": 0.001 } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                              document                                                                                                                                                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "7842911.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "18705922.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "19759178.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "35290831.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "35906139.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "51037488.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "52353856.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "69576778.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "86780976.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                                document                                                                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "7842911090.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "18705922360.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "19759178280.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "35290831015.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "35906139203.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "51037488256.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "52353856384.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "69576778059.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "86780975615.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [35, 35] }, "distanceField": "dist.calculated", "key": "a.geo"} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                                                                                                                                                         document                                                                                                                                                                                                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } }, "dist" : { "calculated" : { "$numberDouble" : "877873731.0" } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] ] } }, "dist" : { "calculated" : { "$numberDouble" : "2329546050.0" } } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } }, "dist" : { "calculated" : { "$numberDouble" : "5216633547.0" } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } }, "dist" : { "calculated" : { "$numberDouble" : "5663819707.0" } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } }, "dist" : { "calculated" : { "$numberDouble" : "6260588933.0" } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } }, "dist" : { "calculated" : { "$numberDouble" : "10560172762.0" } } }
(6 rows)

--min/max distance test
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 500000} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 500 kms
                                                                                                                                                                document                                                                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "7842911090.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "18705922360.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "19759178280.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "35290831015.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "35906139203.0" } } }
(5 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 2} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 2 cartesian distance
                                                                                                                                                             document                                                                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "0.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "155563.0" } } }
(2 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b", "spherical": true, "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 0.1} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 0.1 radians
                                                                                                                                                            document                                                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "1231.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "2936.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "3101.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "5539.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "5636.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "8011.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "8218.0" } } }
(7 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0, 2], "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location"} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 2 cartesian distance
                                                                                                                                                             document                                                                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "0.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "155563.0" } } }
(2 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6, 0.1], "distanceField": "dist.calculated", "key": "a.b", "spherical": true, "includeLocs": "dist.location"} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 0.1 radians
                                                                                                                                                            document                                                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "1231.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "2936.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "3101.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "5539.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "5636.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "8011.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "8218.0" } } }
(7 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "maxDistance": 0.2, "near": [5, 6, 0.1], "distanceField": "dist.calculated", "key": "a.b", "spherical": true, "includeLocs": "dist.location"} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 0.2 radians
                                                                                                                                                             document                                                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "1231.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "2936.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "3101.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "5539.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "5636.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "8011.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "8218.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "10921.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "13621.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6, 0.1], "maxDistance": 0.2, "distanceField": "dist.calculated", "key": "a.b", "spherical": true, "includeLocs": "dist.location"} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 0.2 radians
                                                                                                                                                             document                                                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "1231.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "2936.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "3101.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "5539.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "5636.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "8011.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "8218.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "10921.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "13621.0" } } }
(9 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location" } } ]}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson) AS document FROM documentdb_data.documents_4980_498002 collection WHERE ((documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) IS NOT NULL) AND (shard_key_value OPERATOR(pg_catalog.=) '4980'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_2ds_ab_idx on documentdb_data.documents_4980_498002 collection
               Output: documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson)
               Order By: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson)
(10 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location" } } ]}');
                                                                                                                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson) AS document FROM documentdb_data.documents_4980_498002 collection WHERE ((documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) IS NOT NULL) AND (shard_key_value OPERATOR(pg_catalog.=) '4980'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_2d_ab_idx on documentdb_data.documents_4980_498002 collection
               Output: documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson)
               Order By: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson)
(10 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [35, 35] }, "distanceField": "dist.calculated", "key": "a.geo"} } ]}');    
                                                                                                                                                                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] }, "distanceField" : "dist.calculated", "key" : "a.geo" }'::documentdb_core.bson) AS document FROM documentdb_data.documents_4980_498002 collection WHERE ((documentdb_api_catalog.bson_validate_geography(document, 'a.geo'::text) IS NOT NULL) AND (shard_key_value OPERATOR(pg_catalog.=) '4980'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geography(document, 'a.geo'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] }, "distanceField" : "dist.calculated", "key" : "a.geo" }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_2ds_ageo_idx on documentdb_data.documents_4980_498002 collection
               Output: documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] }, "distanceField" : "dist.calculated", "key" : "a.geo" }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geography(document, 'a.geo'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] }, "distanceField" : "dist.calculated", "key" : "a.geo" }'::documentdb_core.bson)
               Order By: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a.geo'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] }, "distanceField" : "dist.calculated", "key" : "a.geo" }'::documentdb_core.bson)
(10 rows)

-- min / maxDistance Explains
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 500000} } ]}'); -- Upto 500 kms
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::documentdb_core.bson) AS document FROM documentdb_data.documents_4980_498002 collection WHERE ((documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) IS NOT NULL) AND (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } } }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '4980'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_2ds_ab_idx on documentdb_data.documents_4980_498002 collection
               Output: documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::documentdb_core.bson)
               Index Cond: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } } }'::documentdb_core.bson)
               Order By: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::documentdb_core.bson)
(11 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 2} } ]}'); -- Upto 2 cartesian distance
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::documentdb_core.bson) AS document FROM documentdb_data.documents_4980_498002 collection WHERE ((documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) IS NOT NULL) AND (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } } }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '4980'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_2d_ab_idx on documentdb_data.documents_4980_498002 collection
               Output: documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::documentdb_core.bson)
               Index Cond: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } } }'::documentdb_core.bson)
               Order By: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::documentdb_core.bson)
(11 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b", "spherical": true, "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 0.1} } ]}'); -- Upto 0.1 radians
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::documentdb_core.bson) AS document FROM documentdb_data.documents_4980_498002 collection WHERE ((documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) IS NOT NULL) AND (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } } }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '4980'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using my_2d_ab_idx on documentdb_data.documents_4980_498002 collection
               Output: documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::documentdb_core.bson)
               Index Cond: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } } }'::documentdb_core.bson)
               Order By: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::documentdb_core.bson)
(11 rows)

ROLLBACK;
-- Shard the collection
SELECT documentdb_api.shard_collection('db', 'agg_geonear', '{"_id": "hashed"}', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

BEGIN;
-- Find using $geoNear
set local citus.enable_local_execution TO OFF;
SELECT * FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                      document                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "calculated" : { "$numberDouble" : "70711.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "calculated" : { "$numberDouble" : "168309.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "calculated" : { "$numberDouble" : "178639.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "calculated" : { "$numberDouble" : "317682.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "calculated" : { "$numberDouble" : "324580.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "calculated" : { "$numberDouble" : "459437.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "calculated" : { "$numberDouble" : "473415.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "calculated" : { "$numberDouble" : "626259.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "calculated" : { "$numberDouble" : "781025.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                             document                                                                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "70711.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "168309.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "178639.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "317682.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "324580.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "459437.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "473415.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "626259.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "781025.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                             document                                                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "1231.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "2936.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "3101.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "5539.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "5636.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "8011.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "8218.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "10921.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "13621.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location", "distanceMultiplier": 6378.1 } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                              document                                                                                                                                                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "7851641.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "18726743.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "19781171.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "35330111.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "35946104.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "51094295.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "52412129.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "69654220.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "86877567.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "spherical": false, "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                             document                                                                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "70711.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "168309.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "178639.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "317682.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "324580.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "459437.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "473415.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "626259.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "781025.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "spherical": false, "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                                document                                                                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "7842911090.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "18705922360.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "19759178280.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "35290831015.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "35906139203.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "51037488256.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "52353856384.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "69576778059.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "86780975615.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "spherical": false, "key": "a.b", "includeLocs": "dist.location", "distanceMultiplier": 0.001 } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                              document                                                                                                                                                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "7842911.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "18705922.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "19759178.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "35290831.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "35906139.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "51037488.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "52353856.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "69576778.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "86780976.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                                document                                                                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "7842911090.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "18705922360.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "19759178280.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "35290831015.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "35906139203.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "51037488256.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "52353856384.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "69576778059.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "86780975615.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [35, 35] }, "distanceField": "dist.calculated", "key": "a.geo"} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                                                                                                                                                         document                                                                                                                                                                                                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : { "geo" : { "type" : "LineString", "coordinates" : [ [ { "$numberDouble" : "35.359999999999999432" }, { "$numberDouble" : "35.420000000000001705" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } }, "dist" : { "calculated" : { "$numberDouble" : "877873731.0" } } }
 { "_id" : { "$numberInt" : "14" }, "a" : { "geo" : { "type" : "MultiLineString", "coordinates" : [ [ [ { "$numberDouble" : "35.829999999999998295" }, { "$numberDouble" : "35.840000000000003411" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] ] } }, "dist" : { "calculated" : { "$numberDouble" : "2329546050.0" } } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "geo" : { "type" : "Point", "coordinates" : [ { "$numberDouble" : "35.299999999999997158" }, { "$numberDouble" : "35.399999999999998579" } ] } }, "dist" : { "calculated" : { "$numberDouble" : "5216633547.0" } } }
 { "_id" : { "$numberInt" : "15" }, "a" : { "geo" : { "type" : "MultiPolygon", "coordinates" : [ [ [ [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ], [ { "$numberDouble" : "38.643999999999998352" }, { "$numberDouble" : "35.323099999999996612" } ], [ { "$numberDouble" : "38.710000000000000853" }, { "$numberDouble" : "39.320000000000000284" } ], [ { "$numberDouble" : "35.311999999999997613" }, { "$numberDouble" : "35.441000000000002501" } ] ] ] ] } }, "dist" : { "calculated" : { "$numberDouble" : "5663819707.0" } } }
 { "_id" : { "$numberInt" : "13" }, "a" : { "geo" : { "type" : "MultiPoint", "coordinates" : [ [ { "$numberDouble" : "35.429999999999999716" }, { "$numberDouble" : "35.439999999999997726" } ], [ { "$numberDouble" : "32.299999999999997158" }, { "$numberInt" : "30" } ] ] } }, "dist" : { "calculated" : { "$numberDouble" : "6260588933.0" } } }
 { "_id" : { "$numberInt" : "12" }, "a" : { "geo" : { "type" : "Polygon", "coordinates" : [ [ [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ], [ { "$numberDouble" : "38.600000000000001421" }, { "$numberDouble" : "35.299999999999997158" } ], [ { "$numberDouble" : "38.700000000000002842" }, { "$numberDouble" : "39.200000000000002842" } ], [ { "$numberDouble" : "35.729999999999996874" }, { "$numberDouble" : "35.74000000000000199" } ] ] ] } }, "dist" : { "calculated" : { "$numberDouble" : "10560172762.0" } } }
(6 rows)

--min/max distance test
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 500000} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 500 kms
                                                                                                                                                                document                                                                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "7842911090.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "18705922360.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "19759178280.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "35290831015.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "35906139203.0" } } }
(5 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 2} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 2 cartesian distance
                                                                                                                                                             document                                                                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "0.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "155563.0" } } }
(2 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b", "spherical": true, "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 0.1} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 0.1 radians
                                                                                                                                                            document                                                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "1231.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "2936.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "3101.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "5539.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "5636.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "8011.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "8218.0" } } }
(7 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0, 2], "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location"} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 2 cartesian distance
                                                                                                                                                             document                                                                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "0.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "155563.0" } } }
(2 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6, 0.1], "distanceField": "dist.calculated", "key": "a.b", "spherical": true, "includeLocs": "dist.location"} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 0.1 radians
                                                                                                                                                            document                                                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "1231.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "2936.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "3101.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "5539.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "5636.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "8011.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "8218.0" } } }
(7 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "maxDistance": 0.2, "near": [5, 6, 0.1], "distanceField": "dist.calculated", "key": "a.b", "spherical": true, "includeLocs": "dist.location"} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 0.2 radians
                                                                                                                                                             document                                                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "1231.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "2936.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "3101.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "5539.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "5636.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "8011.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "8218.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "10921.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "13621.0" } } }
(9 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6, 0.1], "maxDistance": 0.2, "distanceField": "dist.calculated", "key": "a.b", "spherical": true, "includeLocs": "dist.location"} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 0.2 radians
                                                                                                                                                             document                                                                                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ] }, "dist" : { "location" : [ { "$numberDouble" : "5.5" }, { "$numberDouble" : "5.5" } ], "calculated" : { "$numberDouble" : "1231.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ] }, "dist" : { "location" : [ { "$numberDouble" : "4.4199999999999999289" }, { "$numberDouble" : "4.4199999999999999289" } ], "calculated" : { "$numberDouble" : "2936.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ] }, "dist" : { "location" : [ { "$numberDouble" : "6.6600000000000001421" }, { "$numberDouble" : "6.6600000000000001421" } ], "calculated" : { "$numberDouble" : "3101.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ] }, "dist" : { "location" : [ { "$numberDouble" : "3.3100000000000000533" }, { "$numberDouble" : "3.3100000000000000533" } ], "calculated" : { "$numberDouble" : "5539.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ] }, "dist" : { "location" : [ { "$numberDouble" : "7.7400000000000002132" }, { "$numberDouble" : "7.7400000000000002132" } ], "calculated" : { "$numberDouble" : "5636.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ] }, "dist" : { "location" : [ { "$numberDouble" : "2.2900000000000000355" }, { "$numberDouble" : "2.2900000000000000355" } ], "calculated" : { "$numberDouble" : "8011.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ] }, "dist" : { "location" : [ { "$numberDouble" : "8.8100000000000004974" }, { "$numberDouble" : "8.8100000000000004974" } ], "calculated" : { "$numberDouble" : "8218.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ] }, "dist" : { "location" : [ { "$numberDouble" : "1.1000000000000000888" }, { "$numberDouble" : "1.1000000000000000888" } ], "calculated" : { "$numberDouble" : "10921.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "13621.0" } } }
(9 rows)

-- As of version 1.16 ORDER BY clauses are not pushed to shards it can pick either 2d or 2dsphere index for use in shards and sorts the data in coordinator.
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location" } } ]}');
                                                                                                                                                                                                                                                                                                                                                                                                                           QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                            
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson) AS document, (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_4980_498016 collection WHERE (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) IS NOT NULL)
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2ds_ab_idx on documentdb_data.documents_4980_498016 collection
                     Output: documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson)
(12 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location" } } ]}');
                                                                                                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson) AS document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_4980_498016 collection WHERE (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) IS NOT NULL)
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2d_ab_idx on documentdb_data.documents_4980_498016 collection
                     Output: documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::documentdb_core.bson)
(12 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [35, 35] }, "distanceField": "dist.calculated", "key": "a.geo"} } ]}');    
                                                                                                                                                                                                                                                                                                                                                                            QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                             
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] }, "distanceField" : "dist.calculated", "key" : "a.geo" }'::documentdb_core.bson) AS document, (documentdb_api_catalog.bson_validate_geography(document, 'a.geo'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] }, "distanceField" : "dist.calculated", "key" : "a.geo" }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_4980_498016 collection WHERE (documentdb_api_catalog.bson_validate_geography(document, 'a.geo'::text) IS NOT NULL)
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2ds_ageo_idx on documentdb_data.documents_4980_498016 collection
                     Output: documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] }, "distanceField" : "dist.calculated", "key" : "a.geo" }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geography(document, 'a.geo'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] }, "distanceField" : "dist.calculated", "key" : "a.geo" }'::documentdb_core.bson)
(12 rows)

-- min / maxDistance Explains
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 500000} } ]}'); -- Upto 500 kms
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::documentdb_core.bson) AS document, (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_4980_498016 collection WHERE ((documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) IS NOT NULL) AND (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2ds_ab_idx on documentdb_data.documents_4980_498016 collection
                     Output: documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geography(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::documentdb_core.bson)
                     Index Cond: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } } }'::documentdb_core.bson)
(13 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 2} } ]}'); -- Upto 2 cartesian distance
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::documentdb_core.bson) AS document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_4980_498016 collection WHERE ((documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) IS NOT NULL) AND (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2d_ab_idx on documentdb_data.documents_4980_498016 collection
                     Output: documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::documentdb_core.bson)
                     Index Cond: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } } }'::documentdb_core.bson)
(13 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b", "spherical": true, "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 0.1} } ]}'); -- Upto 0.1 radians
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::documentdb_core.bson) AS document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_4980_498016 collection WHERE ((documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) IS NOT NULL) AND (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2d_ab_idx on documentdb_data.documents_4980_498016 collection
                     Output: documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geometry(document, 'a.b'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::documentdb_core.bson)
                     Index Cond: (documentdb_api_catalog.bson_validate_geometry(collection.document, 'a.b'::text) OPERATOR(documentdb_api_internal.@|><|) '{ "a.b" : { "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } } }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
-- Legacy geonear spherical queries are pushed to 2dsphere index if that is the only index available
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "agg_geonear_legacy", "indexes": [{"key": {"a": "2dsphere"}, "name": "my_2ds_a_idx" }]}', true);
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM documentdb_distributed_test_helpers.get_collection_indexes('db', 'agg_geonear_legacy') ORDER BY collection_id, index_id;
 collection_id | index_id |                                                            index_spec_as_bson                                                            | index_is_valid 
---------------------------------------------------------------------
          4981 |     4989 | { "v" : { "$numberInt" : "2" }, "key" : { "_id" : { "$numberInt" : "1" } }, "name" : "_id_" }                                            | t
          4981 |     4990 | { "v" : { "$numberInt" : "2" }, "key" : { "a" : "2dsphere" }, "name" : "my_2ds_a_idx", "2dsphereIndexVersion" : { "$numberInt" : "3" } } | t
(2 rows)

SELECT documentdb_api.insert_one('db','agg_geonear_legacy','{ "_id": 1, "a": [1, 1] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear_legacy", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a", "spherical": true } }, { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                         document                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ], "dist" : { "calculated" : { "$numberDouble" : "2468.0" } } }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear_legacy", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a", "spherical": true } }, { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_add_fields(documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a", "spherical" : true }'::documentdb_core.bson), '{ "dist.calculated" : { "$round" : [ { "$multiply" : [ "$dist.calculated", { "$numberInt" : "100000" } ] } ] } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson) AS document FROM documentdb_data.documents_4981_498025 collection WHERE ((documentdb_api_catalog.bson_validate_geometry(document, 'a'::text) IS NOT NULL) AND (shard_key_value OPERATOR(pg_catalog.=) '4981'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geometry(document, 'a'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a", "spherical" : true }'::documentdb_core.bson)
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: (documentdb_api_internal.bson_dollar_add_fields(documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a", "spherical" : true }'::documentdb_core.bson), '{ "dist.calculated" : { "$round" : [ { "$multiply" : [ "$dist.calculated", { "$numberInt" : "100000" } ] } ] } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)), ((documentdb_api_catalog.bson_validate_geography(document, 'a'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a", "spherical" : true }'::documentdb_core.bson))
               Sort Key: ((documentdb_api_catalog.bson_validate_geography(collection.document, 'a'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a", "spherical" : true }'::documentdb_core.bson))
               ->  Bitmap Heap Scan on documentdb_data.documents_4981_498025 collection
                     Output: documentdb_api_internal.bson_dollar_add_fields(documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a", "spherical" : true }'::documentdb_core.bson), '{ "dist.calculated" : { "$round" : [ { "$multiply" : [ "$dist.calculated", { "$numberInt" : "100000" } ] } ] } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geography(document, 'a'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a", "spherical" : true }'::documentdb_core.bson)
                     Recheck Cond: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a'::text) IS NOT NULL)
                     ->  Bitmap Index Scan on my_2ds_a_idx
(14 rows)

-- Same non spherical query doesn't work though
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear_legacy", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a", "spherical": false } }, { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
ERROR:  planner returned error :: caused by :: unable to find index for $geoNear query
-- Tests with other stages. $lookup
SELECT documentdb_api.insert_one('db','geonear_lookup_1','{ "_id": 1, "a": [10, 10], "x": 5 }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "geonear_lookup_1", "indexes": [{"key": {"a": "2dsphere"}, "name": "lookup1_2ds_a_idx" }]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api.insert_one('db','geonear_lookup_2','{ "_id": 5, "foo": "bar", "a": [5, 5], "x": 5 }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "geonear_lookup_1", "pipeline": [ { "$geoNear": {"near": {"type": "Point", "coordinates": [0, 1]}, "distanceField": "distance", "spherical": true, "key": "a"}}, {"$lookup": {"from": "geonear_lookup_2", "localField": "x", "foreignField": "x", "as": "new"}}] } ');
                                                                                                                                                                    document                                                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], "x" : { "$numberInt" : "5" }, "distance" : { "$numberDouble" : "1491297.403229492018" }, "new" : [ { "_id" : { "$numberInt" : "5" }, "foo" : "bar", "a" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], "x" : { "$numberInt" : "5" } } ] }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT * FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "geonear_lookup_1", "pipeline": [ { "$geoNear": {"near": {"type": "Point", "coordinates": [0, 1]}, "distanceField": "distance", "spherical": true, "key": "a"}}, {"$lookup": {"from": "geonear_lookup_2", "localField": "x", "foreignField": "x", "as": "new"}}]} ');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(lookup_stage_1.document, "lookupRight_stage_1".document) AS document FROM ((SELECT agg_stage_1.document, documentdb_api_internal.bson_dollar_lookup_extract_filter_expression(agg_stage_1.document, '{ "x" : "x" }'::documentdb_core.bson) AS lookup_filter FROM (SELECT documentdb_api_catalog.bson_dollar_project_geonear(collection.document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "1" } ] }, "distanceField" : "distance", "spherical" : true, "key" : "a" }'::documentdb_core.bson) AS document FROM documentdb_data.documents_4982_498047 collection WHERE ((documentdb_api_catalog.bson_validate_geography(collection.document, 'a'::text) IS NOT NULL) AND (collection.shard_key_value OPERATOR(pg_catalog.=) '4982'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geography(collection.document, 'a'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "1" } ] }, "distanceField" : "distance", "spherical" : true, "key" : "a" }'::documentdb_core.bson)) agg_stage_1) lookup_stage_1 LEFT JOIN LATERAL (SELECT COALESCE(documentdb_api_catalog.bson_array_agg(lookup_right_query_stage_0.document, 'new'::text), '{ "new" : [  ] }'::documentdb_core.bson) AS document FROM (SELECT collection_0_1.document FROM documentdb_data.documents_4983_498056 collection_0_1 WHERE (collection_0_1.shard_key_value OPERATOR(pg_catalog.=) '4983'::bigint)) lookup_right_query_stage_0 WHERE documentdb_api_internal.bson_dollar_lookup_join_filter(lookup_right_query_stage_0.document, lookup_stage_1.lookup_filter, 'x'::text)) "lookupRight_stage_1" ON (true))
         Node: host=localhost port=58070 dbname=regression
         ->  Nested Loop Left Join
               Output: documentdb_api_internal.bson_dollar_merge_documents((documentdb_api_catalog.bson_dollar_project_geonear(collection.document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "1" } ] }, "distanceField" : "distance", "spherical" : true, "key" : "a" }'::documentdb_core.bson)), (COALESCE(documentdb_api_catalog.bson_array_agg(collection_0_1.document, 'new'::text), '{ "new" : [  ] }'::documentdb_core.bson)))
               ->  Index Scan using lookup1_2ds_a_idx on documentdb_data.documents_4982_498047 collection
                     Output: documentdb_api_catalog.bson_dollar_project_geonear(collection.document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "1" } ] }, "distanceField" : "distance", "spherical" : true, "key" : "a" }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geography(collection.document, 'a'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "1" } ] }, "distanceField" : "distance", "spherical" : true, "key" : "a" }'::documentdb_core.bson)
                     Order By: (documentdb_api_catalog.bson_validate_geography(collection.document, 'a'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "1" } ] }, "distanceField" : "distance", "spherical" : true, "key" : "a" }'::documentdb_core.bson)
               ->  Aggregate
                     Output: COALESCE(documentdb_api_catalog.bson_array_agg(collection_0_1.document, 'new'::text), '{ "new" : [  ] }'::documentdb_core.bson)
                     ->  Bitmap Heap Scan on documentdb_data.documents_4983_498056 collection_0_1
                           Output: collection_0_1.shard_key_value, collection_0_1.object_id, collection_0_1.document, collection_0_1.creation_time
                           Recheck Cond: (collection_0_1.shard_key_value = '4983'::bigint)
                           Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_1.document, documentdb_api_internal.bson_dollar_lookup_extract_filter_expression((documentdb_api_catalog.bson_dollar_project_geonear(collection.document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "0" }, { "$numberInt" : "1" } ] }, "distanceField" : "distance", "spherical" : true, "key" : "a" }'::documentdb_core.bson)), '{ "x" : "x" }'::documentdb_core.bson), 'x'::text)
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection_0_1.shard_key_value = '4983'::bigint)
(20 rows)

-- This fails because no valid index on geonear_lookup_2 for $geoNear
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db','{ "aggregate": "geonear_lookup_1", "pipeline": [ '
'{ "$lookup": { "from": "geonear_lookup_2", "pipeline": [{ "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "key": "a"} } ], "as": "c"  } }]}');
ERROR:  planner returned error :: caused by :: unable to find index for $geoNear query
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "geonear_lookup_2", "indexes": [{"key": {"a": "2dsphere"}, "name": "lookup2_2ds_a_idx" }]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Now it should pass
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db','{ "aggregate": "geonear_lookup_1", "pipeline": [ '
'{ "$lookup": { "from": "geonear_lookup_2", "pipeline": [{ "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "key": "a"} } ], "as": "c"  } }]}');
                                                                                                                                                                           document                                                                                                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], "x" : { "$numberInt" : "5" }, "c" : [ { "_id" : { "$numberInt" : "5" }, "foo" : "bar", "a" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], "x" : { "$numberInt" : "5" }, "dist" : { "calculated" : { "$numberDouble" : "111195.07973463153758" } } } ] }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db','{ "aggregate": "geonear_lookup_1", "pipeline": [ '
'{ "$lookup": { "from": "geonear_lookup_2", "pipeline": [{ "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "key": "a"} } ], "as": "c"  } }]}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(lookup_stage_1.document, "lookupRight_stage_1".document) AS document FROM ((SELECT collection.document FROM documentdb_data.documents_4982_498047 collection WHERE (collection.shard_key_value OPERATOR(pg_catalog.=) '4982'::bigint)) lookup_stage_1 LEFT JOIN LATERAL (SELECT COALESCE(documentdb_api_catalog.bson_array_agg(agg_stage_sub_1_1.document, 'c'::text), '{ "c" : [  ] }'::documentdb_core.bson) AS document FROM (SELECT documentdb_api_catalog.bson_dollar_project_geonear(collection_0_1.document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a" }'::documentdb_core.bson) AS document FROM documentdb_data.documents_4983_498056 collection_0_1 WHERE ((documentdb_api_catalog.bson_validate_geography(collection_0_1.document, 'a'::text) IS NOT NULL) AND (collection_0_1.shard_key_value OPERATOR(pg_catalog.=) '4983'::bigint)) ORDER BY (documentdb_api_catalog.bson_validate_geography(collection_0_1.document, 'a'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a" }'::documentdb_core.bson)) agg_stage_sub_1_1) "lookupRight_stage_1" ON (true))
         Node: host=localhost port=58070 dbname=regression
         ->  Nested Loop Left Join
               Output: documentdb_api_internal.bson_dollar_merge_documents(collection.document, (COALESCE(documentdb_api_catalog.bson_array_agg((documentdb_api_catalog.bson_dollar_project_geonear(collection_0_1.document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a" }'::documentdb_core.bson)), 'c'::text), '{ "c" : [  ] }'::documentdb_core.bson)))
               ->  Seq Scan on documentdb_data.documents_4982_498047 collection
                     Output: collection.shard_key_value, collection.object_id, collection.document, collection.creation_time
               ->  Aggregate
                     Output: COALESCE(documentdb_api_catalog.bson_array_agg((documentdb_api_catalog.bson_dollar_project_geonear(collection_0_1.document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a" }'::documentdb_core.bson)), 'c'::text), '{ "c" : [  ] }'::documentdb_core.bson)
                     ->  Index Scan using lookup2_2ds_a_idx on documentdb_data.documents_4983_498056 collection_0_1
                           Output: documentdb_api_catalog.bson_dollar_project_geonear(collection_0_1.document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a" }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geography(collection_0_1.document, 'a'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a" }'::documentdb_core.bson)
                           Order By: (documentdb_api_catalog.bson_validate_geography(collection_0_1.document, 'a'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a" }'::documentdb_core.bson)
(16 rows)

-- Additional checks with legacy pair array
BEGIN;
SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 16, "a": { "c": [[10, 10], [20, 20], [30, 30], [40, 40]]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 17, "a": { "c": [{"x": 10, "y": 10}, {"x": 20, "y": 20}, {"x": 30, "y": 30}, {"x": 40, "y": 40}]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 18, "a": { "c": [[]]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','agg_geonear','{ "_id": 19, "a": { "c": [{}]} }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [10, 10], "distanceField": "dist.calculated", "key": "a.c" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                                                         document                                                                                                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "16" }, "a" : { "c" : [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ], [ { "$numberInt" : "30" }, { "$numberInt" : "30" } ], [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ] ] }, "dist" : { "calculated" : { "$numberDouble" : "0.0" } } }
 { "_id" : { "$numberInt" : "17" }, "a" : { "c" : [ { "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "10" } }, { "x" : { "$numberInt" : "20" }, "y" : { "$numberInt" : "20" } }, { "x" : { "$numberInt" : "30" }, "y" : { "$numberInt" : "30" } }, { "x" : { "$numberInt" : "40" }, "y" : { "$numberInt" : "40" } } ] }, "dist" : { "calculated" : { "$numberDouble" : "0.0" } } }
(2 rows)

SELECT * FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [30, 30], "distanceField": "dist.calculated", "key": "a.c" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                                                         document                                                                                                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "16" }, "a" : { "c" : [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ], [ { "$numberInt" : "30" }, { "$numberInt" : "30" } ], [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ] ] }, "dist" : { "calculated" : { "$numberDouble" : "0.0" } } }
 { "_id" : { "$numberInt" : "17" }, "a" : { "c" : [ { "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "10" } }, { "x" : { "$numberInt" : "20" }, "y" : { "$numberInt" : "20" } }, { "x" : { "$numberInt" : "30" }, "y" : { "$numberInt" : "30" } }, { "x" : { "$numberInt" : "40" }, "y" : { "$numberInt" : "40" } } ] }, "dist" : { "calculated" : { "$numberDouble" : "0.0" } } }
(2 rows)

SELECT * FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [10, 10], "distanceField": "dist.calculated", "key": "a.c", "spherical": true } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                                                         document                                                                                                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "16" }, "a" : { "c" : [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ], [ { "$numberInt" : "30" }, { "$numberInt" : "30" } ], [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ] ] }, "dist" : { "calculated" : { "$numberDouble" : "0.0" } } }
 { "_id" : { "$numberInt" : "17" }, "a" : { "c" : [ { "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "10" } }, { "x" : { "$numberInt" : "20" }, "y" : { "$numberInt" : "20" } }, { "x" : { "$numberInt" : "30" }, "y" : { "$numberInt" : "30" } }, { "x" : { "$numberInt" : "40" }, "y" : { "$numberInt" : "40" } } ] }, "dist" : { "calculated" : { "$numberDouble" : "0.0" } } }
(2 rows)

SELECT * FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [30, 30], "distanceField": "dist.calculated", "key": "a.c", "spherical": true } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                                                         document                                                                                                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "16" }, "a" : { "c" : [ [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], [ { "$numberInt" : "20" }, { "$numberInt" : "20" } ], [ { "$numberInt" : "30" }, { "$numberInt" : "30" } ], [ { "$numberInt" : "40" }, { "$numberInt" : "40" } ] ] }, "dist" : { "calculated" : { "$numberDouble" : "0.0" } } }
 { "_id" : { "$numberInt" : "17" }, "a" : { "c" : [ { "x" : { "$numberInt" : "10" }, "y" : { "$numberInt" : "10" } }, { "x" : { "$numberInt" : "20" }, "y" : { "$numberInt" : "20" } }, { "x" : { "$numberInt" : "30" }, "y" : { "$numberInt" : "30" } }, { "x" : { "$numberInt" : "40" }, "y" : { "$numberInt" : "40" } } ] }, "dist" : { "calculated" : { "$numberDouble" : "0.0" } } }
(2 rows)

EXPLAIN VERBOSE SELECT * FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [10, 10], "distanceField": "dist.calculated", "key": "a.c" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
---------------------------------------------------------------------
 Sort  (cost=11041.82..11291.82 rows=100000 width=40)
   Output: remote_scan.document, remote_scan.distance
   Sort Key: remote_scan.distance
   ->  Custom Scan (Citus Adaptive)  (cost=0.00..0.00 rows=100000 width=40)
         Output: remote_scan.document, remote_scan.distance
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT documentdb_api_internal.bson_dollar_add_fields(documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], "distanceField" : "dist.calculated", "key" : "a.c" }'::documentdb_core.bson), '{ "dist.calculated" : { "$round" : [ { "$multiply" : [ "$dist.calculated", { "$numberInt" : "100000" } ] } ] } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson) AS document, (documentdb_api_catalog.bson_validate_geometry(document, 'a.c'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], "distanceField" : "dist.calculated", "key" : "a.c" }'::documentdb_core.bson) AS distance FROM documentdb_data.documents_4980_498016 collection WHERE (documentdb_api_catalog.bson_validate_geometry(document, 'a.c'::text) IS NOT NULL)
               Node: host=localhost port=58070 dbname=regression
               ->  Index Scan using my_2d_ac_idx on documentdb_data.documents_4980_498016 collection  (cost=0.12..8.17 rows=2 width=40)
                     Output: documentdb_api_internal.bson_dollar_add_fields(documentdb_api_catalog.bson_dollar_project_geonear(document, '{ "near" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], "distanceField" : "dist.calculated", "key" : "a.c" }'::documentdb_core.bson), '{ "dist.calculated" : { "$round" : [ { "$multiply" : [ "$dist.calculated", { "$numberInt" : "100000" } ] } ] } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), (documentdb_api_catalog.bson_validate_geometry(document, 'a.c'::text) OPERATOR(documentdb_api_catalog.<|-|>) '{ "near" : [ { "$numberInt" : "10" }, { "$numberInt" : "10" } ], "distanceField" : "dist.calculated", "key" : "a.c" }'::documentdb_core.bson)
(12 rows)

ROLLBACK;
SELECT documentdb_api.insert_one('db','boundstest','{ "_id": 1, "geo": [ 0, 0]}', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "boundstest", "indexes": [{"key": {"geo": "2d"}, "name": "2d_bounds_idx", "max": 1, "min": -1 }]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Errors out with point not in interval based on index bounds.
-- TODO: add index bound tests for sharded collection once ORDER BY pushdown to shards is supported
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "boundstest", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "geo", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 500000} } ]}');
ERROR:  point not in interval of [ -1, 1 ]
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "boundstest", "pipeline": [ { "$geoNear": { "near": [0, 6], "distanceField": "dist.calculated", "key": "geo", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 500000} } ]}');
ERROR:  point not in interval of [ -1, 1 ]
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "boundstest", "pipeline": [ { "$geoNear": { "near": [5, 0], "distanceField": "dist.calculated", "key": "geo", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 500000} } ]}');
ERROR:  point not in interval of [ -1, 1 ]
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "boundstest", "pipeline": [ { "$geoNear": { "near": [1, -1], "distanceField": "dist.calculated", "key": "geo", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 500000} } ]}');
                                                                                                                  document                                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "geo" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "1.4142135623730951455" } } }
(1 row)

RESET enable_seqscan;
RESET documentdb.forceUseIndexIfAvailable;
SELECT documentdb_api.drop_collection('db', 'boundstest') IS NOT NULL;
 ?column? 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.insert_one('db','valid_extract','{ "_id" : 1, "a" : { "b" : { "type" : "Point", "coordinates" : [ 10, 10 ] } } }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','invalid_extract1','{ "_id" : 2, "a" : { "b" : { "type" : "MultiPoint", "coordinates" : [ [ 10, 10 ], [ 15, 15 ] ] } } }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- This now fails to because no valid index, and without index this invalid extract will not happen
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "valid_extract", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b"} } ]}');
ERROR:  planner returned error :: caused by :: unable to find index for $geoNear query
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db', '{ "aggregate": "invalid_extract1", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b"} } ]}');
ERROR:  planner returned error :: caused by :: unable to find index for $geoNear query
SELECT documentdb_api.drop_collection('db', 'valid_extract') IS NOT NULL;
 ?column? 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.drop_collection('db', 'invalid_extract1') IS NOT NULL;
 ?column? 
---------------------------------------------------------------------
 t
(1 row)

