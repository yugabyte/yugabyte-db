SET search_path TO documentdb_core,documentdb_api,documentdb_api_catalog,documentdb_api_internal;
SET citus.next_shard_id TO 640000;
SET documentdb.next_collection_id TO 6400;
SET documentdb.next_collection_index_id TO 6400;
SET documentdb.enableIndexTermTruncationOnNestedObjects to on;
-- Set configs to something reasonable for testing.
set documentdb.indexTermLimitOverride to 100;
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{ "createIndexes": "index_truncation_tests", "indexes": [ { "key": { "ikey": 1 }, "name": "ikey_1", "enableLargeIndexKeys": true } ] }');
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- now we have an index with truncation enabled and 100 chars.
\d documentdb_data.documents_6400;
                      Table "documentdb_data.documents_6400"
     Column      |           Type           | Collation | Nullable | Default 
---------------------------------------------------------------------
 shard_key_value | bigint                   |           | not null | 
 object_id       | bson                     |           | not null | 
 document        | bson                     |           | not null | 
 creation_time   | timestamp with time zone |           |          | 
Indexes:
    "collection_pk_6400" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_6401" documentdb_rum (document bson_rum_single_path_ops (path=ikey, tl='100'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '6400'::bigint)

---------------------------------------------------------------------
---- DATA TYPE: UTF8
---------------------------------------------------------------------
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 13, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end"}', '', true, true, false, 100) term;
 length |                                                term                                                 
---------------------------------------------------------------------
     14 | { "_id" : { "$numberInt" : "13" } }
    100 | { "ikey" : "this is another string that does violate the index term limit as it goes much over t" }
      8 | { "" : true }
      7 | { "" : { "$maxKey" : 1 } }
(4 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 13, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end"}', 'ikey', false, true, false, 100) term;
 length |                                                term                                                 
---------------------------------------------------------------------
    100 | { "$" : "this is another string that does violate the index term limit as it goes much over the " }
      8 | { "" : true }
      7 | { "" : { "$maxKey" : 1 } }
(3 rows)

-- now insert some documents that don't exceed the index term limit.
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{ "_id": 1, "ikey": "this is a string that does not violate the index term limit" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{ "_id": 2, "ikey": "this is another string that doesnt violate the index term limit" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- now insert some documents that technically do violate the index term limit.
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{ "_id": 3, "ikey": "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{ "_id": 4, "ikey": "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- only changes beyond the index term limit
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{ "_id": 5, "ikey": "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{ "_id": 6, "ikey": "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- this is less than _id: 6
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{ "_id": 7, "ikey": "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- this is less than _id: 7
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{ "_id": 8, "ikey": "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- now that they've succeeded query all of them.
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": "this is a string that does not violate the index term limit" }';
                                                  document                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": "this is another string that doesnt violate the index term limit" }';
                                                    document                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }';
                                                                            document                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }';
                                                                               document                                                                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }';
                                                                                      document                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }';
                                                                                         document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }';
                                                                                         document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(1 row)

-- test $gt
-- all records
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": "this is a" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(8 rows)

-- all "this is another string ..."
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": "this is aa" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(5 rows)

-- no strings
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": "this is another string that doesnt violate the index term limit" } }';
 document 
---------------------------------------------------------------------
(0 rows)

-- all long strings with 'another'
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": "this is another string that does violate the index term limit" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(5 rows)

-- only the string that has the change in the end & the one that doesnt' violate the index term limit.
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" } }';
                                                                                         document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
(2 rows)

-- only the one with 'in' and 'of' in the suffix & the one that doesn't violate the index term limit.
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" } }';
                                                                                         document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
(4 rows)

-- test $gte
-- all records
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": "this is a" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(8 rows)

-- all "this is another string ..."
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": "this is aa" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(5 rows)

-- unlike $gt with no strings - this returns the equality on that exact string.
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": "this is another string that doesnt violate the index term limit" } }';
                                                    document                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
(1 row)

-- all strings with 'another' (unlike $gt since we have $eq as well)
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": "this is another string that does violate the index term limit" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(5 rows)

-- all strings but this one
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" } }';
                                                                                         document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
(3 rows)

-- all but 'in' and 'of' in the suffix & the one that doesn't violate the index term limit.
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(5 rows)

-- test $lt
-- no records
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": "this is a" } }';
 document 
---------------------------------------------------------------------
(0 rows)

-- all records
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": "this is b" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(8 rows)

-- all that are not "this is another string ..."
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": "this is aa" } }';
                                                                                      document                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
(3 rows)

-- all that are not "this is another string ..."
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": "this is another string that does violate the index term limit" } }';
                                                                                      document                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
(3 rows)

-- Matches all that are "this is a string". Also matches all the 'another' strings that are 'after', 'in', but not 'of'
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(5 rows)

-- Matches all that are "this is a string".
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" } }';
                                                                                      document                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
(3 rows)

-- test $lte
-- no records
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lte": "this is a" } }';
 document 
---------------------------------------------------------------------
(0 rows)

-- all records
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lte": "this is b" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(8 rows)

-- all that are not "this is another string ..."
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lte": "this is aa" } }';
                                                                                      document                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
(3 rows)

-- all that are not "this is another string ..."
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lte": "this is another string that does violate the index term limit" } }';
                                                                                      document                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
(3 rows)

-- All strings except 'this is another string that doesnt'
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lte": "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(6 rows)

-- Matches all that are "this is a string" & equality on exact match on the string.
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lte": "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(4 rows)

-- $range 
-- repeat checks with $gt/$lt
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": "this is a", "$lt": "this is an" } }';
                                                                                      document                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": "this is a", "$lte": "this is a string that does not violate the index term limit" } }';
                                                  document                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": "this is a", "$lte": "this is another string that does not violate the index term limit" } }';
                                                                                      document                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": "this is a", "$lte": "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end", "$lt": "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(3 rows)

-- $in
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$in": [ "this is a string that does not violate the index term limit", "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" ] } }';
                                                                            document                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$in": [ "this is a string that does not violate the index term limit", "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings", "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(3 rows)

-- $ne
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$ne": "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(7 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$ne": "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" } }';
                                                                                         document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "3" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
(7 rows)

-- $nin
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$nin": [ "this is a string that does not violate the index term limit", "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(6 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$nin": [ "this is a string that does not violate the index term limit", "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings", "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" ] } }';
                                                                                         document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : "this is another string that doesnt violate the index term limit" }
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
(5 rows)

-- $regex scenarios
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$in": [ "this is a string that does not violate the index term limit", { "$regex": "the end$", "$options": "" } ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(5 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$regex": "the end$", "$options": "" } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "ikey" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(4 rows)

-- $all scenarios
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$all": [ "this is a string that does not violate the index term limit", { "$regex": "\\s+", "$options": "" } ] } }';
                                                  document                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$all": [ { "$regex": "\\d+", "$options": "" }, { "$regex": "\\s+another\\s+", "$options": "" } ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings" }
 { "_id" : { "$numberInt" : "6" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit of strings and changes the end" }
 { "_id" : { "$numberInt" : "7" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit in strings and changes the end" }
 { "_id" : { "$numberInt" : "8" }, "ikey" : "this is another string that does violate the index term limit as it goes much over the 100 character limit after strings and changes the end" }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$all": [ "this is a string that does not violate the index term limit" ] } }';
                                                  document                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : "this is a string that does not violate the index term limit" }
(1 row)

---------------------------------------------------------------------
---- DATA TYPE: Array
---------------------------------------------------------------------
-- with  60 byte truncation limit, the real limit is 60-21 = 39 bytes. We can tolerate any entries over 39 bytes as long as they're also marked truncated.
-- the base structural overhead for an array is 5 (bson Doc) + 2 (path) + 1 (typecode) + 5 (array header) = 13 bytes
-- each path takes 2-4 characters (index as a string), 1 byte (type code) + path Value (variable) = 3-5 bytes + valueLength
-- track truncation with simple int4
-- empty array (13 bytes)
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 13, "ikey" : [ ]}'::bson, 'ikey', false, true, true, 60) term;
 length |            term             
---------------------------------------------------------------------
     13 | { "$" : [  ], "t" : false }
      8 | { "" : true, "t" : false }
(2 rows)

-- int array: int overhead = 3 + sizeof(int) = 7
-- Expectation is 13 bytes of overhead + (2 * 7) = 27 bytes 
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ 1234 %s ]}', repeat(', 1234', 1))::bson, 'ikey', false, true, true, 60) term;
 length |                                      term                                       
---------------------------------------------------------------------
     27 | { "$" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ], "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
      8 | { "" : true, "t" : false }
(4 rows)

-- Expectation is 13 bytes of overhead + (3 * 7) = 34 bytes 
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ 1234 %s ]}', repeat(', 1234', 2))::bson, 'ikey', false, true, true, 60) term;
 length |                                                    term                                                    
---------------------------------------------------------------------
     34 | { "$" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ], "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
      8 | { "" : true, "t" : false }
(5 rows)

-- Expectation is 13 bytes of overhead + (4 * 7) = 41 bytes -> 41 bytes and truncated
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ 1234 %s ]}', repeat(', 1234', 3))::bson, 'ikey', false, true, true, 60) term;
 length |                                                                 term                                                                 
---------------------------------------------------------------------
     41 | { "$" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ], "t" : true }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(7 rows)

-- Expectation is 13 bytes of overhead + (5 * 7) = 51 bytes -> 41 bytes and truncated
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ 1234 %s ]}', repeat(', 1234', 4))::bson, 'ikey', false, true, true, 60) term;
 length |                                                                 term                                                                 
---------------------------------------------------------------------
     41 | { "$" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ], "t" : true }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(8 rows)

-- track truncation with bools: size overhead = 3 + sizeof(bool) = 4
-- Expectation is 13 bytes of overhead + (4 * 4) = 29 bytes 
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ false %s ]}', repeat(', true', 3))::bson, 'ikey', false, true, true, 60) term;
 length |                        term                        
---------------------------------------------------------------------
     29 | { "$" : [ false, true, true, true ], "t" : false }
      9 | { "$" : false, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      8 | { "" : true, "t" : false }
(6 rows)

-- Expectation is 13 bytes of overhead + (5 * 4) = 33 bytes 
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ false %s ]}', repeat(', false', 4))::bson, 'ikey', false, true, true, 60) term;
 length |                             term                             
---------------------------------------------------------------------
     33 | { "$" : [ false, false, false, false, false ], "t" : false }
      9 | { "$" : false, "t" : false }
      9 | { "$" : false, "t" : false }
      9 | { "$" : false, "t" : false }
      9 | { "$" : false, "t" : false }
      9 | { "$" : false, "t" : false }
      8 | { "" : true, "t" : false }
(7 rows)

-- Expectation is 13 bytes of overhead + (6 * 4) = 37 bytes
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ false %s ]}', repeat(', true', 5))::bson, 'ikey', false, true, true, 60) term;
 length |                              term                              
---------------------------------------------------------------------
     37 | { "$" : [ false, true, true, true, true, true ], "t" : false }
      9 | { "$" : false, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      8 | { "" : true, "t" : false }
(8 rows)

-- Expectation is 13 bytes of overhead + (7 * 4) = 41 bytes -> 41 bytes (truncated)
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ false %s ]}', repeat(', true', 6))::bson, 'ikey', false, true, true, 60) term;
 length |                                term                                 
---------------------------------------------------------------------
     41 | { "$" : [ false, true, true, true, true, true, true ], "t" : true }
      9 | { "$" : false, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(10 rows)

-- Expectation is 13 bytes of overhead + (8 * 4) = 45 bytes -> 41 bytes (truncated)
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ false %s ]}', repeat(', true', 7))::bson, 'ikey', false, true, true, 60) term;
 length |                                term                                 
---------------------------------------------------------------------
     41 | { "$" : [ false, true, true, true, true, true, true ], "t" : true }
      9 | { "$" : false, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(11 rows)

-- decimal128 overhead = 3 + sizeof(decimal128) = 19 bytes
-- Expectation is 13 bytes of overhead + (1 * 19) = 32 bytes
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 13, "ikey" : [ { "$numberDecimal": "129e400" }]}'::bson, 'ikey', false, true, true, 60) term;
 length |                             term                              
---------------------------------------------------------------------
     32 | { "$" : [ { "$numberDecimal" : "1.29E+402" } ], "t" : false }
     24 | { "$" : { "$numberDecimal" : "1.29E+402" }, "t" : false }
      8 | { "" : true, "t" : false }
(3 rows)

-- 2 decimal128 : 13 + 38 = 51 bytes
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 13, "ikey" : [ { "$numberDecimal": "129e400" }, { "$numberDecimal": "129e400" }]}'::bson, 'ikey', false, true, true, 60) term;
 length |                                               term                                               
---------------------------------------------------------------------
     51 | { "$" : [ { "$numberDecimal" : "1.29E+402" }, { "$numberDecimal" : "1.29E+402" } ], "t" : true }
     24 | { "$" : { "$numberDecimal" : "1.29E+402" }, "t" : false }
     24 | { "$" : { "$numberDecimal" : "1.29E+402" }, "t" : false }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(5 rows)

-- 3 decimal128 : 13 + 57 = 70 bytes-> 51 bytes
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 13, "ikey" : [ { "$numberDecimal": "129e400" }, { "$numberDecimal": "129e400" }, { "$numberDecimal": "129e400" }]}'::bson, 'ikey', false, true, true, 60) term;
 length |                                               term                                               
---------------------------------------------------------------------
     51 | { "$" : [ { "$numberDecimal" : "1.29E+402" }, { "$numberDecimal" : "1.29E+402" } ], "t" : true }
     24 | { "$" : { "$numberDecimal" : "1.29E+402" }, "t" : false }
     24 | { "$" : { "$numberDecimal" : "1.29E+402" }, "t" : false }
     24 | { "$" : { "$numberDecimal" : "1.29E+402" }, "t" : false }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(6 rows)

-- decimal 127 + bool (truncated at decimal128)
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 13, "ikey" : [ { "$numberDecimal": "129e400" }, { "$numberDecimal": "129e400" }, false]}'::bson, 'ikey', false, true, true, 60) term;
 length |                                               term                                               
---------------------------------------------------------------------
     51 | { "$" : [ { "$numberDecimal" : "1.29E+402" }, { "$numberDecimal" : "1.29E+402" } ], "t" : true }
     24 | { "$" : { "$numberDecimal" : "1.29E+402" }, "t" : false }
     24 | { "$" : { "$numberDecimal" : "1.29E+402" }, "t" : false }
      9 | { "$" : false, "t" : false }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(6 rows)

-- bool + decimal128 (truncated but has all values)
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 13, "ikey" : [ false, { "$numberDecimal": "129e400" }, { "$numberDecimal": "129e400" }]}'::bson, 'ikey', false, true, true, 60) term;
 length |                                                  term                                                   
---------------------------------------------------------------------
     55 | { "$" : [ false, { "$numberDecimal" : "1.29E+402" }, { "$numberDecimal" : "1.29E+402" } ], "t" : true }
      9 | { "$" : false, "t" : false }
     24 | { "$" : { "$numberDecimal" : "1.29E+402" }, "t" : false }
     24 | { "$" : { "$numberDecimal" : "1.29E+402" }, "t" : false }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(6 rows)

-- 5 bool + int: Expected is 13 + (5 * 4) + 7 = 33 + 7 = 40 -> Truncated with all values
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ false %s, 1234 ]}', repeat(', true', 4))::bson, 'ikey', false, true, true, 60) term;
 length |                                        term                                        
---------------------------------------------------------------------
     40 | { "$" : [ false, true, true, true, true, { "$numberInt" : "1234" } ], "t" : true }
      9 | { "$" : false, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(9 rows)

-- 5 bool + decimal128: Expected is 13 + (5 * 4) + 19 = 33 + 19 = 52 -> Truncated with all values
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ false %s, { "$numberDecimal": "129e400" } ]}', repeat(', true', 4))::bson, 'ikey', false, true, true, 60) term;
 length |                                            term                                             
---------------------------------------------------------------------
     52 | { "$" : [ false, true, true, true, true, { "$numberDecimal" : "1.29E+402" } ], "t" : true }
      9 | { "$" : false, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
      9 | { "$" : true, "t" : false }
     24 | { "$" : { "$numberDecimal" : "1.29E+402" }, "t" : false }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(9 rows)

-- array with mixed fixed + variable.
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ { "$numberDecimal": "1234" }, "This is a string that needs to be truncated after an integer term in an array"  ]}', repeat(', true', 4))::bson, 'ikey', false, true, true, 60) term;
 length |                                         term                                          
---------------------------------------------------------------------
     58 | { "$" : [ { "$numberInt" : "1234" }, "This is a string that needs to" ], "t" : true }
     24 | { "$" : { "$numberDecimal" : "1234" }, "t" : false }
     60 | { "$" : "This is a string that needs to be truncated aft", "t" : true }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(5 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ { "$numberInt": "1234" }, "This is a string that needs to be truncated after an integer term in an array"  ]}', repeat(', true', 4))::bson, 'ikey', false, true, true, 60) term;
 length |                                         term                                          
---------------------------------------------------------------------
     58 | { "$" : [ { "$numberInt" : "1234" }, "This is a string that needs to" ], "t" : true }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
     60 | { "$" : "This is a string that needs to be truncated aft", "t" : true }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(5 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ { "$numberLong": "1234" }, "This is a string that needs to be truncated after an integer term in an array"  ]}', repeat(', true', 4))::bson, 'ikey', false, true, true, 60) term;
 length |                                         term                                          
---------------------------------------------------------------------
     58 | { "$" : [ { "$numberInt" : "1234" }, "This is a string that needs to" ], "t" : true }
     16 | { "$" : { "$numberLong" : "1234" }, "t" : false }
     60 | { "$" : "This is a string that needs to be truncated aft", "t" : true }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(5 rows)

-- Expectation is 13 bytes of overhead + (3 * 7) = 34 bytes + 1 bools == 38 bytes. Now add a string - it shouldn't fail since it will still go over the soft limit of 39
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : [ 1234 %s, true, "abcde" ]}', repeat(', 1234', 2))::bson, 'ikey', false, true, true, 60) term;
 length |                                                           term                                                           
---------------------------------------------------------------------
     51 | { "$" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, true, "abcde" ], "t" : true }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
     12 | { "$" : { "$numberInt" : "1234" }, "t" : false }
      9 | { "$" : true, "t" : false }
     18 | { "$" : "abcde", "t" : false }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(8 rows)

-- start fresh with arrays
SELECT documentdb_api.drop_collection('db','index_truncation_tests');
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

set documentdb.indexTermLimitOverride to 60;
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{ "createIndexes": "index_truncation_tests", "indexes": [ { "key": { "ikey": 1 }, "name": "ikey_1", "enableLargeIndexKeys": true } ] }');
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

\d documentdb_data.documents_6401
                      Table "documentdb_data.documents_6401"
     Column      |           Type           | Collation | Nullable | Default 
---------------------------------------------------------------------
 shard_key_value | bigint                   |           | not null | 
 object_id       | bson                     |           | not null | 
 document        | bson                     |           | not null | 
 creation_time   | timestamp with time zone |           |          | 
Indexes:
    "collection_pk_6401" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_6403" documentdb_rum (document bson_rum_single_path_ops (path=ikey, tl='60'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '6401'::bigint)

-- empty array
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{ "_id": 1, "ikey": [] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- bool arrays
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{ "_id": 2, "ikey": [ false ] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{ "_id": 3, "ikey": [ false %s ] }', repeat(', true', 3))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{ "_id": 4, "ikey": [ false %s ] }', repeat(', true', 4))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{ "_id": 5, "ikey": [ false %s ] }', repeat(', true', 5))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{ "_id": 6, "ikey": [ false %s ] }', repeat(', true', 6))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- int arrays
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 7, "ikey" : [ 1234 %s ]}', repeat(', 1234', 1))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 8, "ikey" : [ 1234 %s ]}', repeat(', 1234', 2))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 9, "ikey" : [ 1234 %s ]}', repeat(', 1234', 3))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 10, "ikey" : [ 1234 %s ]}', repeat(', 1234', 4))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 21, "ikey" : [ 1234 %s, 3457 ]}', repeat(', 1234', 4))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- decimal array
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 11, "ikey" : [ { "$numberDecimal": "1234" } %s ]}', repeat(', { "$numberDecimal": "1234" }', 1))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 12, "ikey" : [ { "$numberDecimal": "1234" } %s ]}', repeat(', { "$numberDecimal": "1234" }', 2))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 13, "ikey" : [ { "$numberDecimal": "1234" } %s ]}', repeat(', { "$numberDecimal": "1234" }', 3))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 14, "ikey" : [ { "$numberDecimal": "1234" } %s ]}', repeat(', { "$numberDecimal": "1234" }', 4))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 15, "ikey" : [ { "$numberDecimal": "1234" } %s, 2345 ]}', repeat(', { "$numberDecimal": "1234" }', 4))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 16, "ikey" : [ { "$numberDecimal": "1234" } %s, 3456 ]}', repeat(', { "$numberDecimal": "1234" }', 4))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 17, "ikey" : [ { "$numberDecimal": "1e406" } %s ]}', repeat(', { "$numberDecimal": "1e406" }', 1))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 18, "ikey" : [ { "$numberDecimal": "1e406" } %s ]}', repeat(', { "$numberDecimal": "1e406" }', 2))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 19, "ikey" : [ { "$numberDecimal": "1e406" } %s, 1 ]}', repeat(', { "$numberDecimal": "1e406" }', 3))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', FORMAT('{"_id": 20, "ikey" : [ { "$numberDecimal": "1e406" } %s, 5 ]}', repeat(', { "$numberDecimal": "1e406" }', 4))::bson);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- mixed types
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 22, "ikey" : [ 1234, 1234, "This is a string after the numbers" ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 23, "ikey" : [ { "$numberDecimal": "1234" }, { "$numberDecimal": "1234" }, "This is a string after the numbers" ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 24, "ikey" : [ "String before", 1234, 1234 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 25, "ikey" : [ "String before", { "$numberDecimal": "1234" }, { "$numberDecimal": "1234" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 26, "ikey" : [ "String before", 1234, 1234, "This is a string after the numbers" ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 27, "ikey" : [ "String before", { "$numberDecimal": "1234" }, { "$numberDecimal": "1234" }, "This is a string after the numbers" ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- test $eq
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": [] }';
                     document                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey" : [  ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": [ false ] }';
                        document                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : [ false ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": [ false, true, true, true, true, true, false ] }';
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": [ false, true, true, true, true, true, true ] }';
                                          document                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "ikey" : [ false, true, true, true, true, true, true ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": [ 1234, 1234, 1234, 1234 ] }';
                                                                                   document                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "9" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "13" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": [ 1234, 1234, 1234, 1234, 1234 ] }';
                                                                                                  document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "14" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": [ 1234, 1234, 1234, 1234, 1234, 3457 ] }';
                                                                                                      document                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "21" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "3457" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": [ { "$numberDecimal": "1e406" }, { "$numberDecimal": "1e406" }, { "$numberDecimal": "1e406" }, { "$numberDecimal": "1e406" }, 1 ] }';
                                                                                                   document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "19" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberInt" : "1" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": [ { "$numberDecimal": "1e406" }, { "$numberDecimal": "1e406" }, { "$numberDecimal": "1e406" }, { "$numberDecimal": "1e406" }, 2 ] }';
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": [ 1234, 1234, "This is a string after the numbers" ] }';
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "22" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "23" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": [ "String before", { "$numberDecimal": "1234" }, { "$numberDecimal": "1234" } ] }';
                                                            document                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "24" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "25" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": [ "String before", { "$numberLong": "1234" }, { "$numberLong": "1234" }, "This is a string after the numbers" ] }';
                                                                               document                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "26" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "27" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
(2 rows)

-- test $gt/$gte
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ false, true, true, true, true, true, false ] } }';
                                          document                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "ikey" : [ false, true, true, true, true, true, true ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ false, true, true, true, true, true, true ] } }';
                                          document                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "ikey" : [ false, true, true, true, true, true, true ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 1233 ] } }';
                                                                                                                   document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : [ false ] }
 { "_id" : { "$numberInt" : "3" }, "ikey" : [ false, true, true, true ] }
 { "_id" : { "$numberInt" : "4" }, "ikey" : [ false, true, true, true, true ] }
 { "_id" : { "$numberInt" : "5" }, "ikey" : [ false, true, true, true, true, true ] }
 { "_id" : { "$numberInt" : "6" }, "ikey" : [ false, true, true, true, true, true, true ] }
 { "_id" : { "$numberInt" : "7" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "8" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "9" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "10" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "21" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "3457" } ] }
 { "_id" : { "$numberInt" : "11" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
 { "_id" : { "$numberInt" : "12" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
 { "_id" : { "$numberInt" : "13" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
 { "_id" : { "$numberInt" : "14" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
 { "_id" : { "$numberInt" : "15" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberInt" : "2345" } ] }
 { "_id" : { "$numberInt" : "16" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberInt" : "3456" } ] }
 { "_id" : { "$numberInt" : "17" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" } ] }
 { "_id" : { "$numberInt" : "18" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" } ] }
 { "_id" : { "$numberInt" : "19" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "20" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberInt" : "5" } ] }
 { "_id" : { "$numberInt" : "22" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "23" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "24" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "25" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
 { "_id" : { "$numberInt" : "26" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "27" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
(26 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 1234, 1234, 1234, 1234, 1234, 3000 ] } }';
                                                                                                                   document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : [ false ] }
 { "_id" : { "$numberInt" : "3" }, "ikey" : [ false, true, true, true ] }
 { "_id" : { "$numberInt" : "4" }, "ikey" : [ false, true, true, true, true ] }
 { "_id" : { "$numberInt" : "5" }, "ikey" : [ false, true, true, true, true, true ] }
 { "_id" : { "$numberInt" : "6" }, "ikey" : [ false, true, true, true, true, true, true ] }
 { "_id" : { "$numberInt" : "21" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "3457" } ] }
 { "_id" : { "$numberInt" : "16" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberInt" : "3456" } ] }
 { "_id" : { "$numberInt" : "17" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" } ] }
 { "_id" : { "$numberInt" : "18" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" } ] }
 { "_id" : { "$numberInt" : "19" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "20" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberInt" : "5" } ] }
 { "_id" : { "$numberInt" : "22" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "23" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "24" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "25" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
 { "_id" : { "$numberInt" : "26" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "27" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
(17 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 1234, 1234, 1234, 1234, 1234, 3457 ] } }';
                                                                                                                   document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : [ false ] }
 { "_id" : { "$numberInt" : "3" }, "ikey" : [ false, true, true, true ] }
 { "_id" : { "$numberInt" : "4" }, "ikey" : [ false, true, true, true, true ] }
 { "_id" : { "$numberInt" : "5" }, "ikey" : [ false, true, true, true, true, true ] }
 { "_id" : { "$numberInt" : "6" }, "ikey" : [ false, true, true, true, true, true, true ] }
 { "_id" : { "$numberInt" : "21" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "3457" } ] }
 { "_id" : { "$numberInt" : "17" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" } ] }
 { "_id" : { "$numberInt" : "18" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" } ] }
 { "_id" : { "$numberInt" : "19" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "20" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberInt" : "5" } ] }
 { "_id" : { "$numberInt" : "22" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "23" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "24" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "25" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
 { "_id" : { "$numberInt" : "26" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "27" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
(16 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 1234, 1234, "This is a string after the numbers greater" ] } }';
                                                                                                                   document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : [ false ] }
 { "_id" : { "$numberInt" : "3" }, "ikey" : [ false, true, true, true ] }
 { "_id" : { "$numberInt" : "4" }, "ikey" : [ false, true, true, true, true ] }
 { "_id" : { "$numberInt" : "5" }, "ikey" : [ false, true, true, true, true, true ] }
 { "_id" : { "$numberInt" : "6" }, "ikey" : [ false, true, true, true, true, true, true ] }
 { "_id" : { "$numberInt" : "17" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" } ] }
 { "_id" : { "$numberInt" : "18" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" } ] }
 { "_id" : { "$numberInt" : "19" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "20" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberInt" : "5" } ] }
 { "_id" : { "$numberInt" : "24" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "25" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
 { "_id" : { "$numberInt" : "26" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "27" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
(13 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 1234, 1234, "This is a string after the number" ] } }';
                                                                                                                   document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : [ false ] }
 { "_id" : { "$numberInt" : "3" }, "ikey" : [ false, true, true, true ] }
 { "_id" : { "$numberInt" : "4" }, "ikey" : [ false, true, true, true, true ] }
 { "_id" : { "$numberInt" : "5" }, "ikey" : [ false, true, true, true, true, true ] }
 { "_id" : { "$numberInt" : "6" }, "ikey" : [ false, true, true, true, true, true, true ] }
 { "_id" : { "$numberInt" : "17" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" } ] }
 { "_id" : { "$numberInt" : "18" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" } ] }
 { "_id" : { "$numberInt" : "19" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "20" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberInt" : "5" } ] }
 { "_id" : { "$numberInt" : "22" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "23" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "24" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "25" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
 { "_id" : { "$numberInt" : "26" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "27" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
(15 rows)

-- $size
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$size": 1 } }';
                        document                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey" : [ false ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$size": 2 } }';
                                                      document                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "7" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "11" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
 { "_id" : { "$numberInt" : "17" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" } ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$size": 3 } }';
                                                                       document                                                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "8" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "12" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
 { "_id" : { "$numberInt" : "18" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" } ] }
 { "_id" : { "$numberInt" : "22" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "23" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "24" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "25" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
(7 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$size": 4 } }';
                                                                                   document                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "ikey" : [ false, true, true, true ] }
 { "_id" : { "$numberInt" : "9" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "13" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
 { "_id" : { "$numberInt" : "26" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "27" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
(5 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$size": 5 } }';
                                                                                                   document                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "ikey" : [ false, true, true, true, true ] }
 { "_id" : { "$numberInt" : "10" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "14" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" } ] }
 { "_id" : { "$numberInt" : "19" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberInt" : "1" } ] }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$size": 6 } }';
                                                                                                                   document                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "ikey" : [ false, true, true, true, true, true ] }
 { "_id" : { "$numberInt" : "21" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "3457" } ] }
 { "_id" : { "$numberInt" : "15" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberInt" : "2345" } ] }
 { "_id" : { "$numberInt" : "16" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberInt" : "3456" } ] }
 { "_id" : { "$numberInt" : "20" }, "ikey" : [ { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberDecimal" : "1E+406" }, { "$numberInt" : "5" } ] }
(5 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$size": 7 } }';
                                          document                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "ikey" : [ false, true, true, true, true, true, true ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$size": 8 } }';
 document 
---------------------------------------------------------------------
(0 rows)

-- $all 
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$all": [ 1234, 3457 ] } }';
                                                                                                      document                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "21" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "3457" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$all": [ 1234, "This is a string after the numbers" ] } }';
                                                                               document                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "22" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "23" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "26" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "27" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$all": [ 1234, { "$regex": ".+string.+numbers", "$options": "" } ] } }';
                                                                               document                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "22" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "23" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "26" }, "ikey" : [ "String before", { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string after the numbers" ] }
 { "_id" : { "$numberInt" : "27" }, "ikey" : [ "String before", { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, "This is a string after the numbers" ] }
(4 rows)

-- $all with $elemMatch
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$all": [{ "$elemMatch": { "$gt": 1000, "$lt": 2000 } }, { "$elemMatch": { "$gt": 2000, "$lt": 3000 } } ] } }';
                                                                                                                document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "15" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberInt" : "2345" } ] }
(1 row)

-- $elemMatch
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$elemMatch": { "$gt": 3000, "$lt": 4000 }} }';
                                                                                                                document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "21" }, "ikey" : [ { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "3457" } ] }
 { "_id" : { "$numberInt" : "16" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberInt" : "3456" } ] }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$elemMatch": { "$all": [ 2345 ] }} }';
                                                                                                                document                                                                                                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "15" }, "ikey" : [ { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberDecimal" : "1234" }, { "$numberInt" : "2345" } ] }
(1 row)

DELETE FROM documentdb_data.documents_6401;
-- Specific operator tests.
-- $gt
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : [ 2345, 1234, 1234, 1234, 1234 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 32, "ikey" : [ { "$numberDecimal": "2344" }, 1234, 1234, 1234, 1234 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- both are greater (null < numbers)
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ null, 2345 ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2344" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(2 rows)

-- both are bigger than 2340
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2340, 2345 ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2344" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(2 rows)

-- only the 1st doc matches
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2344, 1235 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2345, 1234 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(1 row)

ROLLBACk;
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : [ 2345, 1234, 1234, 1234, 1234 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 32, "ikey" : [ { "$numberDecimal": "2344" }, 1234, 1234, 1234, 1234 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- both are greater (null < numbers)
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ null, 2345 ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2344" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(2 rows)

-- both are bigger than 2340
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2340, 2345 ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2344" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(2 rows)

-- only the 1st doc matches
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2344, 1235 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2345, 1234 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(1 row)

ROLLBACk;
-- from above, for int arrays, the 5th integer is lost in truncation.
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : [ 2345, 1234, 1234, { "$numberInt": "1450" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 32, "ikey" : [ 2345, 1234, 1234, { "$numberDecimal": "1451" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 33, "ikey" : [ 2345, 1234, 1234, { "$numberDouble": "1449" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- the "1" would not be in the index term.
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 34, "ikey" : [ 2345, 1234, 1234, { "$numberInt": "1450" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 35, "ikey" : [ 2345, 1234, 1234, { "$numberDecimal": "1451" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 36, "ikey" : [ 2345, 1234, 1234, { "$numberDouble": "1449" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- now insert some via Decimal128 - 37 matches 36, 38 matches 32
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 37, "ikey" : [ { "$numberDecimal": "2345" }, 1234, 1234, { "$numberDouble": "1449" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 38, "ikey" : [ { "$numberDecimal": "2345" }, 1234, { "$numerDouble": "1234" }, { "$numberDecimal": "1451" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- 31, 32, 34, 35 have values in position 4 that would be > and match, 36 matches on the last index. Only 33 is a mismatch
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2345, 1234, 1234, { "$numberInt": "1449" }, 0 ] } }';
                                                                                           document                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" } ] }
 { "_id" : { "$numberInt" : "34" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "36" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "37" }, "ikey" : [ { "$numberDecimal" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "38" }, "ikey" : [ { "$numberDecimal" : "2345" }, { "$numberInt" : "1234" }, { "$numerDouble" : "1234" }, { "$numberDecimal" : "1451" } ] }
(7 rows)

-- Now only 31, 32, 34, 35 match
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2345, 1234, 1234, { "$numberInt": "1449" }, 2 ] } }';
                                                                                         document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" } ] }
 { "_id" : { "$numberInt" : "34" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "38" }, "ikey" : [ { "$numberDecimal" : "2345" }, { "$numberInt" : "1234" }, { "$numerDouble" : "1234" }, { "$numberDecimal" : "1451" } ] }
(5 rows)

ROLLBACK;
-- integer + string + integer.
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : [ 2345.1, "Some large string that should theoretically go over 60 chars", 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 32, "ikey" : [ { "$numberDecimal": "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", 0 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 33, "ikey" : [ { "$numberDecimal": "2345.1" }, "Some large string that should theoretically go over 60 chars", 2 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2345, { "$maxKey": 1 } ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberDouble" : "2345.0999999999999091" }, "Some large string that should theoretically go over 60 chars", { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", { "$numberInt" : "0" } ] }
 { "_id" : { "$numberInt" : "33" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars", { "$numberInt" : "2" } ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2345.1, { "$maxKey": 1 } ] } }';
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2345.1, "Some maximal string" ] } }';
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2345.1, "Some large string that should theoretically" ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberDouble" : "2345.0999999999999091" }, "Some large string that should theoretically go over 60 chars", { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", { "$numberInt" : "0" } ] }
 { "_id" : { "$numberInt" : "33" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars", { "$numberInt" : "2" } ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2345.1, "Some large string that should theoretically go over 60 chars", 1 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", { "$numberInt" : "0" } ] }
 { "_id" : { "$numberInt" : "33" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars", { "$numberInt" : "2" } ] }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ { "$numberDecimal": "2345.1" }, "Some large string that should theoretically go over 60 chars and then less", -1 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", { "$numberInt" : "0" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ { "$numberDecimal": "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", -1 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", { "$numberInt" : "0" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ { "$numberDecimal": "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", 1 ] } }';
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
-- $lt
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : [ 2345, 1234, 1234, 1234, 1234 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 32, "ikey" : [ { "$numberDecimal": "2344" }, 1234, 1234, 1234, 1234 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": [ true, 2345 ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2344" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": [ 2340, 2345 ] } }';
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": [ 2346, 2345 ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2344" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": [ 2344, 1235 ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2344" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": [ 2345, 1234 ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2344" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": [ 2345, 1234, 1234, 1234, 1234 ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2344" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": [ 2345, 1234, 1234, 1234, 1234, 1234 ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2344" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(2 rows)

ROLLBACk;
-- from above, for int arrays, the 5th integer is lost in truncation.
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : [ 2345, 1234, 1234, { "$numberInt": "1450" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 32, "ikey" : [ 2345, 1234, 1234, { "$numberDecimal": "1451" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 33, "ikey" : [ 2345, 1234, 1234, { "$numberDouble": "1449" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- the "1" would not be in the index term.
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 34, "ikey" : [ 2345, 1234, 1234, { "$numberInt": "1450" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 35, "ikey" : [ 2345, 1234, 1234, { "$numberDecimal": "1451" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 36, "ikey" : [ 2345, 1234, 1234, { "$numberDouble": "1449" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- now insert some via Decimal128 - 37 matches 36, 38 matches 32
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 37, "ikey" : [ { "$numberDecimal": "2345" }, 1234, 1234, { "$numberDouble": "1449" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 38, "ikey" : [ { "$numberDecimal": "2345" }, 1234, { "$numerDouble": "1234" }, { "$numberDecimal": "1451" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": [ 2345, 1234, 1234, { "$numberInt": "1449" }, 0 ] } }';
                                                                             document                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "33" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": [ 2345, 1234, 1234, { "$numberInt": "1449" } ] } }';
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": [ 2345, 1234, 1234, { "$numberInt": "1450" }, 0 ] } }';
                                                                                           document                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" } ] }
 { "_id" : { "$numberInt" : "33" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" } ] }
 { "_id" : { "$numberInt" : "36" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "37" }, "ikey" : [ { "$numberDecimal" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" }, { "$numberInt" : "1" } ] }
(4 rows)

ROLLBACK;
-- $gte
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : [ 2345, 1234, 1234, 1234, 1234 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 32, "ikey" : [ { "$numberDecimal": "2344" }, 1234, 1234, 1234, 1234 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- both are greater (null < numbers)
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ null, 2345 ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2344" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(2 rows)

-- both are bigger than 2340
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 2340, 2345 ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2344" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(2 rows)

-- only the 1st doc matches
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 2344, 1235 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 2345, 1234 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(1 row)

ROLLBACk;
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : [ 2345, 1234, 1234, 1234, 1234 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 32, "ikey" : [ { "$numberDecimal": "2344" }, 1234, 1234, 1234, 1234 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- both are greater (null < numbers)
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ null, 2345 ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2344" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(2 rows)

-- both are bigger than 2340
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 2340, 2345 ] } }';
                                                                                          document                                                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2344" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(2 rows)

-- only the 1st doc matches
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 2344, 1235 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 2345, 1234 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
(1 row)

ROLLBACk;
-- from above, for int arrays, the 5th integer is lost in truncation.
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : [ 2345, 1234, 1234, { "$numberInt": "1450" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 32, "ikey" : [ 2345, 1234, 1234, { "$numberDecimal": "1451" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 33, "ikey" : [ 2345, 1234, 1234, { "$numberDouble": "1449" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- the "1" would not be in the index term.
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 34, "ikey" : [ 2345, 1234, 1234, { "$numberInt": "1450" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 35, "ikey" : [ 2345, 1234, 1234, { "$numberDecimal": "1451" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 36, "ikey" : [ 2345, 1234, 1234, { "$numberDouble": "1449" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- now insert some via Decimal128 - 37 matches 36, 38 matches 32
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 37, "ikey" : [ { "$numberDecimal": "2345" }, 1234, 1234, { "$numberDouble": "1449" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 38, "ikey" : [ { "$numberDecimal": "2345" }, 1234, { "$numerDouble": "1234" }, { "$numberDecimal": "1451" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- 31, 32, 34, 35 have values in position 4 that would be > and match, 36 matches on the last index. Only 33 is a mismatch
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 2345, 1234, 1234, { "$numberInt": "1449" }, 0 ] } }';
                                                                                           document                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" } ] }
 { "_id" : { "$numberInt" : "34" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "36" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "37" }, "ikey" : [ { "$numberDecimal" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "38" }, "ikey" : [ { "$numberDecimal" : "2345" }, { "$numberInt" : "1234" }, { "$numerDouble" : "1234" }, { "$numberDecimal" : "1451" } ] }
(7 rows)

-- Now only 31, 32, 34, 35 match
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 2345, 1234, 1234, { "$numberInt": "1449" }, 2 ] } }';
                                                                                         document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" } ] }
 { "_id" : { "$numberInt" : "34" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "38" }, "ikey" : [ { "$numberDecimal" : "2345" }, { "$numberInt" : "1234" }, { "$numerDouble" : "1234" }, { "$numberDecimal" : "1451" } ] }
(5 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 2345, 1234, 1234, { "$numberInt": "1449" }, 1 ] } }';
                                                                                           document                                                                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" } ] }
 { "_id" : { "$numberInt" : "34" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "36" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "37" }, "ikey" : [ { "$numberDecimal" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "38" }, "ikey" : [ { "$numberDecimal" : "2345" }, { "$numberInt" : "1234" }, { "$numerDouble" : "1234" }, { "$numberDecimal" : "1451" } ] }
(7 rows)

ROLLBACK;
-- integer + string + integer.
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : [ 2345.1, "Some large string that should theoretically go over 60 chars", 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 32, "ikey" : [ { "$numberDecimal": "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", 0 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 33, "ikey" : [ { "$numberDecimal": "2345.1" }, "Some large string that should theoretically go over 60 chars", 2 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 2345, { "$maxKey": 1 } ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberDouble" : "2345.0999999999999091" }, "Some large string that should theoretically go over 60 chars", { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", { "$numberInt" : "0" } ] }
 { "_id" : { "$numberInt" : "33" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars", { "$numberInt" : "2" } ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 2345.1, { "$maxKey": 1 } ] } }';
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 2345.1, "Some maximal string" ] } }';
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 2345.1, "Some large string that should theoretically" ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberDouble" : "2345.0999999999999091" }, "Some large string that should theoretically go over 60 chars", { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", { "$numberInt" : "0" } ] }
 { "_id" : { "$numberInt" : "33" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars", { "$numberInt" : "2" } ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ 2345.1, "Some large string that should theoretically go over 60 chars", 1 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberDouble" : "2345.0999999999999091" }, "Some large string that should theoretically go over 60 chars", { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", { "$numberInt" : "0" } ] }
 { "_id" : { "$numberInt" : "33" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars", { "$numberInt" : "2" } ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ { "$numberDecimal": "2345.1" }, "Some large string that should theoretically go over 60 chars and then less", -1 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", { "$numberInt" : "0" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ { "$numberDecimal": "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", -1 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", { "$numberInt" : "0" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ { "$numberDecimal": "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", 0 ] } }';
                                                                                        document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberDecimal" : "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", { "$numberInt" : "0" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": [ { "$numberDecimal": "2345.1" }, "Some large string that should theoretically go over 60 chars and then some", 1 ] } }';
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
-- $in/$nin/$ne/$all(eq)
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : [ 2345, 1234, 1234, { "$numberInt": "1450" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 32, "ikey" : [ 2345, 1234, 1234, { "$numberDecimal": "1451" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 33, "ikey" : [ 2345, 1234, 1234, { "$numberDouble": "1449" } ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- the "1" would not be in the index term.
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 34, "ikey" : [ 2345, 1234, 1234, { "$numberInt": "1450" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 35, "ikey" : [ 2345, 1234, 1234, { "$numberDecimal": "1451" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 36, "ikey" : [ 2345, 1234, 1234, { "$numberDouble": "1449" }, 1 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$in": [ [ 2345, 1234, 1234, { "$numberInt": "1450" } ], [ 2345, 1234, 1234, { "$numberDouble": "1449" }, 1 ] ] }}';
                                                                                         document                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" } ] }
 { "_id" : { "$numberInt" : "36" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" }, { "$numberInt" : "1" } ] }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$nin": [ [ 2345, 1234, 1234, { "$numberInt": "1450" } ], [ 2345, 1234, 1234, { "$numberDouble": "1449" }, 1 ] ] }}';
                                                                                         document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" } ] }
 { "_id" : { "$numberInt" : "33" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" } ] }
 { "_id" : { "$numberInt" : "34" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" }, { "$numberInt" : "1" } ] }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$ne": [ 2345, 1234, 1234, { "$numberDouble": "1449" }, 1 ] }}';
                                                                                         document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" } ] }
 { "_id" : { "$numberInt" : "33" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" } ] }
 { "_id" : { "$numberInt" : "34" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" }, { "$numberInt" : "1" } ] }
(5 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$all": [ [ 2345, 1234, 1234, { "$numberDouble": "1449" }, 1 ] ] }}';
                                                                                         document                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "36" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" }, { "$numberInt" : "1" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$all": [ { "$elemMatch": { "$eq": 1 }}, { "$elemMatch": { "$eq": 1451 } } ] }}';
                                                                                         document                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" }, { "$numberInt" : "1" } ] }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$elemMatch": { "$eq": 1 } }}';
                                                                                         document                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "34" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1450" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDecimal" : "1451" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "36" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberDouble" : "1449.0" }, { "$numberInt" : "1" } ] }
(3 rows)

ROLLBACK;
-- $elemMatch (regex)
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : [ 2345, 1234, 1234, "This is a string that goes over the index truncation limit" ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$elemMatch": { "$all": [ { "$regex": "limit$", "$options": "" } ] }}}';
                                                                                            document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, "This is a string that goes over the index truncation limit" ] }
(1 row)

ROLLBACK;
-- $range
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : [ 2345, 1234, 1234, 1234, 1234, 1234, 1234 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 32, "ikey" : [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1235 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 33, "ikey" : [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1236 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 34, "ikey" : [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1237 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 35, "ikey" : [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1238 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 36, "ikey" : [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1239 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 37, "ikey" : [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1241 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 38, "ikey" : [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1242 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 39, "ikey" : [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1243 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 40, "ikey" : [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1244 ]}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- matches nothing.
SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2345, 1234, 1234, 1234, 1234, 1235 ], "$lt": [ 2346, 1234, 1234, 1234, 1234, 1234, 1234 ] } }';
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt":[ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1236 ], "$lt": [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1241 ] } }';
                                                                                                                                 document                                                                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "34" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1237" } ] }
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1238" } ] }
 { "_id" : { "$numberInt" : "36" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1239" } ] }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt":[ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1236 ], "$lte": [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1241 ] } }';
                                                                                                                                 document                                                                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "34" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1237" } ] }
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1238" } ] }
 { "_id" : { "$numberInt" : "36" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1239" } ] }
 { "_id" : { "$numberInt" : "37" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1241" } ] }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte":[ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1236 ], "$lt": [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1241 ] } }';
                                                                                                                                 document                                                                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "33" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1236" } ] }
 { "_id" : { "$numberInt" : "34" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1237" } ] }
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1238" } ] }
 { "_id" : { "$numberInt" : "36" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1239" } ] }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte":[ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1236 ], "$lte": [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1241 ] } }';
                                                                                                                                 document                                                                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "33" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1236" } ] }
 { "_id" : { "$numberInt" : "34" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1237" } ] }
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1238" } ] }
 { "_id" : { "$numberInt" : "36" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1239" } ] }
 { "_id" : { "$numberInt" : "37" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1241" } ] }
(5 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": { "$minKey": 1 } , "$lt": [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1241 ] } }';
                                                                                                                                 document                                                                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
 { "_id" : { "$numberInt" : "32" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1235" } ] }
 { "_id" : { "$numberInt" : "33" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1236" } ] }
 { "_id" : { "$numberInt" : "34" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1237" } ] }
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1238" } ] }
 { "_id" : { "$numberInt" : "36" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1239" } ] }
(6 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": [ 2345, 1234, 1234, 1234, 1234, 1234, 1234, 1236 ], "$lt": { "$maxKey": 1 } } }';
                                                                                                                                 document                                                                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "34" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1237" } ] }
 { "_id" : { "$numberInt" : "35" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1238" } ] }
 { "_id" : { "$numberInt" : "36" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1239" } ] }
 { "_id" : { "$numberInt" : "37" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1241" } ] }
 { "_id" : { "$numberInt" : "38" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1242" } ] }
 { "_id" : { "$numberInt" : "39" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1243" } ] }
 { "_id" : { "$numberInt" : "40" }, "ikey" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1244" } ] }
(7 rows)

ROLLBACK;
---------------------------------------------------------------------
---- DATA TYPE: Document
---------------------------------------------------------------------
-- with  60 byte truncation limit, the real limit is 60-18 = 42 bytes. We can tolerate any entries over 42 bytes as long as they're also marked truncated.
-- the base structural overhead for an array is 5 (bson Doc) + 2 (path) + 1 (typecode) + 5 (doc header) = 13 bytes
-- each path takes some characters (string), 1 byte (type code) + path Value (variable) = 1+ bytes + valueLength
-- empty doc (13 bytes)
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 13, "ikey" : {} }'::bson, 'ikey', false, true, true, 60) term;
 length |            term             
---------------------------------------------------------------------
     13 | { "$" : {  }, "t" : false }
      8 | { "" : true, "t" : false }
(2 rows)

-- single path (13 bytes + 4 bytes (path) + 1 byte type Code, 9 byte string, 1 for the \0, 4 byte string length) = 32 bytes (not truncated)
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 13, "ikey" : { "abc": "123456789" } }'::bson, 'ikey', false, true, true, 60) term;
 length |                      term                      
---------------------------------------------------------------------
     32 | { "$" : { "abc" : "123456789" }, "t" : false }
      8 | { "" : true, "t" : false }
(2 rows)

-- single path truncated on path - path should be truncated
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : { "%s": "123456789", "b": 1, "c": 1 } }', repeat('abcdefg', 10))::bson, 'ikey', false, true, true, 60) term;
 length |                                            term                                             
---------------------------------------------------------------------
     58 | { "$" : { "abcdefgabcdefgabcdefgabcdefgabcdefgabcdefga" : { "$maxKey" : 1 } }, "t" : true }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(3 rows)

-- single path truncated on path since path is greater than soft limit less than hard limit - path should not be truncated
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : { "%s": "123456789", "b": 1, "c": 1 } }', repeat('abcdefg', 6))::bson, 'ikey', false, true, true, 60) term;
 length |                                            term                                            
---------------------------------------------------------------------
     57 | { "$" : { "abcdefgabcdefgabcdefgabcdefgabcdefgabcdefg" : { "$maxKey" : 1 } }, "t" : true }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(3 rows)

-- value doesn't show up until we're under the soft limit.
-- overhead: 13 bytes, 1 byte type code: for a 42 byte soft limit we're looking at a 28 byte path: from paths >= 29 bytes values Must be maxkey
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : { "%s": "123456789", "b": 1, "c": 1 } }', repeat('a', 41))::bson, 'ikey', false, true, true, 60) term;
 length |                                           term                                            
---------------------------------------------------------------------
     56 | { "$" : { "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" : { "$maxKey" : 1 } }, "t" : true }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(3 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : { "%s": "123456789", "b": 1, "c": 1 } }', repeat('a', 30))::bson, 'ikey', false, true, true, 60) term;
 length |                                      term                                      
---------------------------------------------------------------------
     45 | { "$" : { "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" : { "$maxKey" : 1 } }, "t" : true }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(3 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : { "%s": "123456789", "b": 1, "c": 1 } }', repeat('a', 29))::bson, 'ikey', false, true, true, 60) term;
 length |                                     term                                      
---------------------------------------------------------------------
     44 | { "$" : { "aaaaaaaaaaaaaaaaaaaaaaaaaaaaa" : { "$maxKey" : 1 } }, "t" : true }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(3 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : { "%s": "123456789", "b": 1, "c": 1 } }', repeat('a', 28))::bson, 'ikey', false, true, true, 60) term;
 length |                                     term                                     
---------------------------------------------------------------------
     43 | { "$" : { "aaaaaaaaaaaaaaaaaaaaaaaaaaaa" : { "$maxKey" : 1 } }, "t" : true }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(3 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : { "%s": "123456789", "b": 1, "c": 1 } }', repeat('a', 27))::bson, 'ikey', false, true, true, 60) term;
 length |                                 term                                  
---------------------------------------------------------------------
     56 | { "$" : { "aaaaaaaaaaaaaaaaaaaaaaaaaaa" : "123456789" }, "t" : true }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(3 rows)

-- value gets truncated when it appears
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : { "%s": "123456789123451234512345", "b": 1, "c": 1 } }', repeat('a', 28))::bson, 'ikey', false, true, true, 60) term;
 length |                                     term                                     
---------------------------------------------------------------------
     43 | { "$" : { "aaaaaaaaaaaaaaaaaaaaaaaaaaaa" : { "$maxKey" : 1 } }, "t" : true }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(3 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : { "%s": "%s", "b": 1, "c": 1 } }', repeat('a', 5), repeat('b', 40))::bson, 'ikey', false, true, true, 60) term;
 length |                                  term                                  
---------------------------------------------------------------------
     57 | { "$" : { "aaaaa" : "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb" }, "t" : true }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(3 rows)

-- truncation with object + string after works
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(FORMAT('{"_id": 13, "ikey" : { "a": { "b": 1 }, "%s": "123456789123451234512345", "b": 1, "c": 1 } }', repeat('a', 28))::bson, 'ikey', false, true, true, 60) term;
 length |                                                         term                                                         
---------------------------------------------------------------------
     58 | { "$" : { "a" : { "b" : { "$numberInt" : "1" } }, "aaaaaaaaaaaaaaaaaaaaaaaaaaaa" : { "$maxKey" : 1 } }, "t" : true }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(3 rows)

-- sample docs from subsequent stages
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 31, "ikey" : { "userName": "myFirstUserName", "address": "1st avenue, Rua Amalho" }}'::bson, 'ikey', false, true, true, 60) term;
 length |                                          term                                           
---------------------------------------------------------------------
     52 | { "$" : { "userName" : "myFirstUserName", "address" : { "$maxKey" : 1 } }, "t" : true }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(3 rows)

-- start fresh with documents
DELETE FROM documentdb_data.documents_6401;
-- $eq on something that's past truncation.
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : { "userName": "myFirstUserName", "address": "1st avenue, Rua Amalho" }}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 32, "ikey" : { "userName": "myFirstUserName", "address": "2nd avenue, Rua Amalho" }}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 33, "ikey" : { "userName": "myFirstUserName", "address": "0th avenue, Rua Amalho" }}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 34, "ikey" : { "userName": "myFirstUserName", "address": { "$maxKey": 1 } }}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "userName": "myFirstUserName", "address": "2nd avenue, Rua Amalho" }}';
                                                        document                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "32" }, "ikey" : { "userName" : "myFirstUserName", "address" : "2nd avenue, Rua Amalho" } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "userName": "myFirstUserName", "address": "0th avenue, Rua Amalho" }}';
                                                        document                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "33" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho" } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "userName": "myFirstUserName", "address": { "$maxKey": 1 } }}';
                                                    document                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "34" }, "ikey" : { "userName" : "myFirstUserName", "address" : { "$maxKey" : 1 } } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$ne": { "userName": "myFirstUserName", "address": "2nd avenue, Rua Amalho" } }}';
                                                        document                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "33" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "34" }, "ikey" : { "userName" : "myFirstUserName", "address" : { "$maxKey" : 1 } } }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$ne": { "userName": "myFirstUserName", "address": "0th avenue, Rua Amalho" } }}';
                                                        document                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "32" }, "ikey" : { "userName" : "myFirstUserName", "address" : "2nd avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "34" }, "ikey" : { "userName" : "myFirstUserName", "address" : { "$maxKey" : 1 } } }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$ne": { "userName": "myFirstUserName", "address": { "$maxKey": 1 } } }}';
                                                        document                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "32" }, "ikey" : { "userName" : "myFirstUserName", "address" : "2nd avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "33" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho" } }
(3 rows)

ROLLBACK;
-- $gt/$lt/$gte/$gt/$range on something past truncation
BEGIN;
SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 31, "ikey" : { "userName": "myFirstUserName", "address": "1st avenue, Rua Amalho" }}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 32, "ikey" : { "userName": "myFirstUserName", "address": "2nd avenue, Rua Amalho" }}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 33, "ikey" : { "userName": "myFirstUserName", "address": "0th avenue, Rua Amalho" }}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 34, "ikey" : { "userName": "myFirstUserName", "address": { "$maxKey": 1 } }}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 35, "ikey" : { "userName": "myFirstUserName", "address1": { "$maxKey": 1 } }}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 36, "ikey" : { "userName": "myFirstUserName", "address": "0th avenue, Rua Amalho", "MaxField": { "$maxKey": 1 } }}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 37, "ikey" : { "userName": "myFirstUserName", "address": "1st avenue, Rua Amalho", "apartment": "compartamento"  }}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 38, "ikey" : { "userName": "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address": "0th avenue, Rua Amalho", "apartment": "compartamento"  }}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 39, "ikey" : { "userName": "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address": "1st avenue, Rua Amalho", "apartment": "compartamento"  }}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'index_truncation_tests', '{"_id": 40, "ikey" : { "userName": "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address": "2nd avenue, Rua Amalho", "apartment": "compartamento"  }}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": { "userName": "myFirstUserName", "address": "1st avenue, Rua Amalho" } }}';
                                                                       document                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "32" }, "ikey" : { "userName" : "myFirstUserName", "address" : "2nd avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "34" }, "ikey" : { "userName" : "myFirstUserName", "address" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "35" }, "ikey" : { "userName" : "myFirstUserName", "address1" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "37" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho", "apartment" : "compartamento" } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gt": { "userName": "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address": "1st avenue, Rua Amalho", "apartment": "compartamento"  } }}';
                                                                                                 document                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "32" }, "ikey" : { "userName" : "myFirstUserName", "address" : "2nd avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "33" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "34" }, "ikey" : { "userName" : "myFirstUserName", "address" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "35" }, "ikey" : { "userName" : "myFirstUserName", "address1" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "36" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho", "MaxField" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "37" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho", "apartment" : "compartamento" } }
 { "_id" : { "$numberInt" : "40" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "2nd avenue, Rua Amalho", "apartment" : "compartamento" } }
(8 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": { "userName": "myFirstUserName", "address": "1st avenue, Rua Amalho" } }}';
                                                                       document                                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "32" }, "ikey" : { "userName" : "myFirstUserName", "address" : "2nd avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "34" }, "ikey" : { "userName" : "myFirstUserName", "address" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "35" }, "ikey" : { "userName" : "myFirstUserName", "address1" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "37" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho", "apartment" : "compartamento" } }
(5 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$gte": { "userName": "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address": "1st avenue, Rua Amalho", "apartment": "compartamento"  } }}';
                                                                                                 document                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "32" }, "ikey" : { "userName" : "myFirstUserName", "address" : "2nd avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "33" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "34" }, "ikey" : { "userName" : "myFirstUserName", "address" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "35" }, "ikey" : { "userName" : "myFirstUserName", "address1" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "36" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho", "MaxField" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "37" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho", "apartment" : "compartamento" } }
 { "_id" : { "$numberInt" : "39" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "1st avenue, Rua Amalho", "apartment" : "compartamento" } }
 { "_id" : { "$numberInt" : "40" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "2nd avenue, Rua Amalho", "apartment" : "compartamento" } }
(9 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": { "userName": "myFirstUserName", "address": "1st avenue, Rua Amalho" } }}';
                                                                                                 document                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "33" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "36" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho", "MaxField" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "38" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "0th avenue, Rua Amalho", "apartment" : "compartamento" } }
 { "_id" : { "$numberInt" : "39" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "1st avenue, Rua Amalho", "apartment" : "compartamento" } }
 { "_id" : { "$numberInt" : "40" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "2nd avenue, Rua Amalho", "apartment" : "compartamento" } }
(5 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": { "userName": "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address": "1st avenue, Rua Amalho", "apartment": "compartamento"  } }}';
                                                                                                 document                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "38" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "0th avenue, Rua Amalho", "apartment" : "compartamento" } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lte": { "userName": "myFirstUserName", "address": "1st avenue, Rua Amalho" } }}';
                                                                                                 document                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "33" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "36" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho", "MaxField" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "38" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "0th avenue, Rua Amalho", "apartment" : "compartamento" } }
 { "_id" : { "$numberInt" : "39" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "1st avenue, Rua Amalho", "apartment" : "compartamento" } }
 { "_id" : { "$numberInt" : "40" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "2nd avenue, Rua Amalho", "apartment" : "compartamento" } }
(6 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lte": { "userName": "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address": "1st avenue, Rua Amalho", "apartment": "compartamento"  } }}';
                                                                                                 document                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "38" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "0th avenue, Rua Amalho", "apartment" : "compartamento" } }
 { "_id" : { "$numberInt" : "39" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "1st avenue, Rua Amalho", "apartment" : "compartamento" } }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": { "userName": "myFirstUserName", "address": "1st avenue, Rua Amalho" }, "$gt": { "userName": "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address": "1st avenue, Rua Amalho", "apartment": "compartamento" } }}';
                                                                                                 document                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "33" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "36" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho", "MaxField" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "40" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "2nd avenue, Rua Amalho", "apartment" : "compartamento" } }
(3 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lt": { "userName": "myFirstUserName", "address": "1st avenue, Rua Amalho" }, "$gte": { "userName": "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address": "1st avenue, Rua Amalho", "apartment": "compartamento" } }}';
                                                                                                 document                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "33" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "36" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho", "MaxField" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "39" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "1st avenue, Rua Amalho", "apartment" : "compartamento" } }
 { "_id" : { "$numberInt" : "40" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "2nd avenue, Rua Amalho", "apartment" : "compartamento" } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lte": { "userName": "myFirstUserName", "address": "1st avenue, Rua Amalho" }, "$gt": { "userName": "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address": "1st avenue, Rua Amalho", "apartment": "compartamento" } }}';
                                                                                                 document                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "33" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "36" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho", "MaxField" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "40" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "2nd avenue, Rua Amalho", "apartment" : "compartamento" } }
(4 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$lte": { "userName": "myFirstUserName", "address": "1st avenue, Rua Amalho" }, "$gte": { "userName": "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address": "1st avenue, Rua Amalho", "apartment": "compartamento" } }}';
                                                                                                 document                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "33" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "36" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho", "MaxField" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "39" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "1st avenue, Rua Amalho", "apartment" : "compartamento" } }
 { "_id" : { "$numberInt" : "40" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "2nd avenue, Rua Amalho", "apartment" : "compartamento" } }
(5 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$in": [ { "userName": "myFirstUserName", "address": "1st avenue, Rua Amalho" }, { "userName": "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address": "1st avenue, Rua Amalho", "apartment": "compartamento" } ] }}';
                                                                                                 document                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "31" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "39" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "1st avenue, Rua Amalho", "apartment" : "compartamento" } }
(2 rows)

SELECT document FROM documentdb_api.collection('db', 'index_truncation_tests') WHERE document @@ '{ "ikey": { "$nin": [ { "userName": "myFirstUserName", "address": "1st avenue, Rua Amalho" }, { "userName": "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address": "1st avenue, Rua Amalho", "apartment": "compartamento" } ] }}';
                                                                                                 document                                                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "32" }, "ikey" : { "userName" : "myFirstUserName", "address" : "2nd avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "33" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho" } }
 { "_id" : { "$numberInt" : "34" }, "ikey" : { "userName" : "myFirstUserName", "address" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "35" }, "ikey" : { "userName" : "myFirstUserName", "address1" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "36" }, "ikey" : { "userName" : "myFirstUserName", "address" : "0th avenue, Rua Amalho", "MaxField" : { "$maxKey" : 1 } } }
 { "_id" : { "$numberInt" : "37" }, "ikey" : { "userName" : "myFirstUserName", "address" : "1st avenue, Rua Amalho", "apartment" : "compartamento" } }
 { "_id" : { "$numberInt" : "38" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "0th avenue, Rua Amalho", "apartment" : "compartamento" } }
 { "_id" : { "$numberInt" : "40" }, "ikey" : { "userName" : "my0thUserNamethatgoespasttruncationlimitssothataddressdoesnotshowup", "address" : "2nd avenue, Rua Amalho", "apartment" : "compartamento" } }
(8 rows)

ROLLBACK;
-- finally shard_collection and ensure it's Truncation limit is still there.
SELECT * FROM documentdb_api_catalog.collection_indexes WHERE collection_id = 6401 ORDER BY index_id;
 collection_id | index_id |                                                        index_spec                                                        | index_is_valid 
---------------------------------------------------------------------
          6401 |     6402 | (_id_,"{ ""_id"" : { ""$numberInt"" : ""1"" } }",,,,,2,,,)                                                               | t
          6401 |     6403 | (ikey_1,"{ ""ikey"" : { ""$numberInt"" : ""1"" } }",,,,,2,,,"{ ""enableLargeIndexKeys"" : { ""$numberInt"" : ""1"" } }") | t
(2 rows)

SELECT documentdb_api.shard_collection('db', 'index_truncation_tests', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

\d documentdb_data.documents_6401
                      Table "documentdb_data.documents_6401"
     Column      |           Type           | Collation | Nullable | Default 
---------------------------------------------------------------------
 shard_key_value | bigint                   |           | not null | 
 object_id       | bson                     |           | not null | 
 document        | bson                     |           | not null | 
 creation_time   | timestamp with time zone |           |          | 
Indexes:
    "collection_pk_6401" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_6404" documentdb_rum (document bson_rum_single_path_ops (path=_id, tl='60'))
    "documents_rum_index_6405" documentdb_rum (document bson_rum_single_path_ops (path=ikey, tl='60'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = get_shard_key_value('{ "_id" : "hashed" }'::bson, 6401::bigint, document))

/* testing wildcard indexes */
SET documentdb.indexTermLimitOverride TO 100;
SET documentdb.maxWildcardIndexKeySize TO 50;
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{ "createIndexes": "wildcard_index_truncation_tests", "indexes": [ { "key": { "$**": 1 }, "name": "wkey_1", "enableLargeIndexKeys": true } ] }');
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

\d documentdb_data.documents_6402
                      Table "documentdb_data.documents_6402"
     Column      |           Type           | Collation | Nullable | Default 
---------------------------------------------------------------------
 shard_key_value | bigint                   |           | not null | 
 object_id       | bson                     |           | not null | 
 document        | bson                     |           | not null | 
 creation_time   | timestamp with time zone |           |          | 
Indexes:
    "collection_pk_6402" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_6407" documentdb_rum (document bson_rum_single_path_ops (path='', iswildcard='true', tl='100', wkl='50'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '6402'::bigint)

/* should fail fue to maximum size exceeded */
SELECT documentdb_api.insert_one('db', 'wildcard_index_truncation_tests', '{"_id": 1, "thiskeyislargerthanthemaximumallowedsizeof50characters" : "sample_value"}');
                                                                                                                    insert_one                                                                                                                    
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "0" }, "ok" : { "$numberDouble" : "1.0" }, "writeErrors" : [ { "index" : { "$numberInt" : "0" }, "code" : { "$numberInt" : "16777245" }, "errmsg" : "Wildcard index key exceeded the maximum allowed size of 50." } ] }
(1 row)

/* should succeed due to maximum size not exceeded */
SELECT documentdb_api.insert_one('db', 'wildcard_index_truncation_tests', '{"_id": 1, "ikey1" : "this is a string that does not violate the index term limit"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

/* should succeed and truncate index term with wildcard index */
SELECT documentdb_api.insert_one('db', 'wildcard_index_truncation_tests', '{ "_id": 2, "ikey2": "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

/* query all and check if same index is used for both */
SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests') WHERE document @@ '{ "ikey1": { "$gt": "this is a" } }';
                                                  document                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "ikey1" : "this is a string that does not violate the index term limit" }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests') WHERE document @@ '{ "ikey1": { "$gt": "this is a" } }';
                                                                                                                   QUERY PLAN                                                                                                                    
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_6402_640040 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "ikey1" : "this is a" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '6402'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_6402_640040 collection
               Output: document
               Recheck Cond: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "ikey1" : "this is a" }'::documentdb_core.bson)
               ->  Bitmap Index Scan on wkey_1
                     Index Cond: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "ikey1" : "this is a" }'::documentdb_core.bson)
(12 rows)

SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests') WHERE document @@ '{ "ikey2": { "$gt": "this is a" } }';
                                                                            document                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "ikey2" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests') WHERE document @@ '{ "ikey2": { "$gt": "this is a" } }';
                                                                                                                   QUERY PLAN                                                                                                                    
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_6402_640040 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "ikey2" : "this is a" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '6402'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_6402_640040 collection
               Output: document
               Recheck Cond: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "ikey2" : "this is a" }'::documentdb_core.bson)
               ->  Bitmap Index Scan on wkey_1
                     Index Cond: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "ikey2" : "this is a" }'::documentdb_core.bson)
(12 rows)

/* create collection again and test with single field wildcard. */
set documentdb.indexTermLimitOverride to 60;
/* should create wildcard for single path */
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{ "createIndexes": "wildcard_index_truncation_tests_single_field", "indexes": [ { "key": { "a.b.$**": 1 }, "name": "wkey_2", "enableLargeIndexKeys": true } ] }');
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

\d documentdb_data.documents_6403
                      Table "documentdb_data.documents_6403"
     Column      |           Type           | Collation | Nullable | Default 
---------------------------------------------------------------------
 shard_key_value | bigint                   |           | not null | 
 object_id       | bson                     |           | not null | 
 document        | bson                     |           | not null | 
 creation_time   | timestamp with time zone |           |          | 
Indexes:
    "collection_pk_6403" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_6409" documentdb_rum (document bson_rum_single_path_ops (path='a.b', iswildcard='true', tl='60'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '6403'::bigint)

/* should succeed and truncate index term with wildcard index */
SELECT documentdb_api.insert_one('db', 'wildcard_index_truncation_tests_single_field', '{ "_id": 1, "a": { "b": { "c": "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'wildcard_index_truncation_tests_single_field', '{ "_id": 2, "a": { "d": { "c": "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'wildcard_index_truncation_tests_single_field', '{"_id": 3, "a" : { "b": { "c": [ 2345, 1234, 1234, 1234, 1234 ] } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

/* making sure the array is being truncated */
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 3, "a.b.c": [ 2345, 1234, 1234, 1234, 1234 ] }', '', true, true, false, 60) term;
 length |                                                             term                                                             
---------------------------------------------------------------------
     14 | { "_id" : { "$numberInt" : "3" } }
     45 | { "a.b.c" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
     18 | { "a.b.c.0" : { "$numberInt" : "2345" } }
     18 | { "a.b.c.1" : { "$numberInt" : "1234" } }
     18 | { "a.b.c.2" : { "$numberInt" : "1234" } }
     18 | { "a.b.c.3" : { "$numberInt" : "1234" } }
     18 | { "a.b.c.4" : { "$numberInt" : "1234" } }
     16 | { "a.b.c" : { "$numberInt" : "2345" } }
     16 | { "a.b.c" : { "$numberInt" : "1234" } }
     16 | { "a.b.c" : { "$numberInt" : "1234" } }
     16 | { "a.b.c" : { "$numberInt" : "1234" } }
     16 | { "a.b.c" : { "$numberInt" : "1234" } }
      8 | { "" : true }
      7 | { "" : { "$maxKey" : 1 } }
(14 rows)

/* making sure the wildcard index terms are being generated correctly for a truncated value */
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_wildcard_project_generated_terms('{"_id": 3, "a.b.c": [ 2345, 1234, 1234, 1234, 1234, 76, 85 ] }', '["a"]', false, true, false, 60) term;
 length |                                                             term                                                             
---------------------------------------------------------------------
     14 | { "_id" : { "$numberInt" : "3" } }
     45 | { "a.b.c" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] }
     18 | { "a.b.c.0" : { "$numberInt" : "2345" } }
     18 | { "a.b.c.1" : { "$numberInt" : "1234" } }
     18 | { "a.b.c.2" : { "$numberInt" : "1234" } }
     18 | { "a.b.c.3" : { "$numberInt" : "1234" } }
     18 | { "a.b.c.4" : { "$numberInt" : "1234" } }
     18 | { "a.b.c.5" : { "$numberInt" : "76" } }
     18 | { "a.b.c.6" : { "$numberInt" : "85" } }
     16 | { "a.b.c" : { "$numberInt" : "2345" } }
     16 | { "a.b.c" : { "$numberInt" : "1234" } }
     16 | { "a.b.c" : { "$numberInt" : "1234" } }
     16 | { "a.b.c" : { "$numberInt" : "1234" } }
     16 | { "a.b.c" : { "$numberInt" : "1234" } }
     16 | { "a.b.c" : { "$numberInt" : "76" } }
     16 | { "a.b.c" : { "$numberInt" : "85" } }
      8 | { "" : true }
      7 | { "" : { "$maxKey" : 1 } }
(18 rows)

SELECT documentdb_api.insert_one('db', 'wildcard_index_truncation_tests_single_field', '{"_id": 4, "a": { "b": { "c": 1, "d": 2, "e": "12334141424124" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

/* making sure the document is being truncated */
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 4, "a": { "b": { "c": 1, "d": 2, "e": "12334141424124" } } }', '', true, true, false, 60) term;
 length |                                                    term                                                    
---------------------------------------------------------------------
     14 | { "_id" : { "$numberInt" : "4" } }
     57 | { "a" : { "b" : { "c" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "2" }, "e" : "12334141424124" } } }
     51 | { "a.b" : { "c" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "2" }, "e" : "12334141424124" } }
     16 | { "a.b.c" : { "$numberInt" : "1" } }
     16 | { "a.b.d" : { "$numberInt" : "2" } }
     31 | { "a.b.e" : "12334141424124" }
      8 | { "" : true }
      7 | { "" : { "$maxKey" : 1 } }
(8 rows)

/* making sure the wildcard index terms are being generated correctly for a truncated value */
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_wildcard_project_generated_terms('{"_id": 4, "a": { "b": { "c": 1, "d": 2, "e": "12334141424124" } } }', '["a"]', false, true, false, 60) term;
 length |                                                    term                                                    
---------------------------------------------------------------------
     14 | { "_id" : { "$numberInt" : "4" } }
     57 | { "a" : { "b" : { "c" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "2" }, "e" : "12334141424124" } } }
     51 | { "a.b" : { "c" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "2" }, "e" : "12334141424124" } }
     16 | { "a.b.c" : { "$numberInt" : "1" } }
     16 | { "a.b.d" : { "$numberInt" : "2" } }
     31 | { "a.b.e" : "12334141424124" }
      8 | { "" : true }
      7 | { "" : { "$maxKey" : 1 } }
(8 rows)

/* second element in array shouldn't appear as a term */
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_wildcard_project_generated_terms('{"_id": 6, "a": [{ "b": { "c": 1, "d": 2, "e": "1" } }, { "oi": 2} ], "c": 1}', '["a.0"]', false, true, false, 60) term;
 length |                                              term                                               
---------------------------------------------------------------------
     14 | { "_id" : { "$numberInt" : "6" } }
     46 | { "a.0" : { "b" : { "c" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "2" }, "e" : "1" } } }
     40 | { "a.0.b" : { "c" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "2" }, "e" : "1" } }
     18 | { "a.0.b.c" : { "$numberInt" : "1" } }
     18 | { "a.0.b.d" : { "$numberInt" : "2" } }
     20 | { "a.0.b.e" : "1" }
      8 | { "" : true }
      7 | { "" : { "$maxKey" : 1 } }
     12 | { "" : [  ] }
(9 rows)

/* term key "c" shouldn't appear as a term */
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_wildcard_project_generated_terms('{"_id": 6, "a": [{ "b": { "c": 1, "d": 2, "e": "1" } }, { "oi": 2} ], "c": 1}', '["a"]', false, true, false, 60) term;
 length |                                              term                                               
---------------------------------------------------------------------
     14 | { "_id" : { "$numberInt" : "6" } }
     43 | { "a" : [ { "b" : { "c" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "2" } } } ] }
     46 | { "a.0" : { "b" : { "c" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "2" }, "e" : "1" } } }
     40 | { "a.0.b" : { "c" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "2" }, "e" : "1" } }
     18 | { "a.0.b.c" : { "$numberInt" : "1" } }
     18 | { "a.0.b.d" : { "$numberInt" : "2" } }
     20 | { "a.0.b.e" : "1" }
     23 | { "a.1" : { "oi" : { "$numberInt" : "2" } } }
     17 | { "a.1.oi" : { "$numberInt" : "2" } }
     44 | { "a" : { "b" : { "c" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "2" }, "e" : "1" } } }
     38 | { "a.b" : { "c" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "2" }, "e" : "1" } }
     16 | { "a.b.c" : { "$numberInt" : "1" } }
     16 | { "a.b.d" : { "$numberInt" : "2" } }
     18 | { "a.b.e" : "1" }
     21 | { "a" : { "oi" : { "$numberInt" : "2" } } }
     15 | { "a.oi" : { "$numberInt" : "2" } }
      8 | { "" : true }
      7 | { "" : { "$maxKey" : 1 } }
     12 | { "" : [  ] }
(19 rows)

SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_single_field') WHERE document @@ '{ "a.b.c": { "$gt": "this is a" } }';
                                                                                    document                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : { "c" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" } } }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_single_field') WHERE document @@ '{ "a.b.c": { "$gt": "this is a" } }';
                                                                                                                   QUERY PLAN                                                                                                                    
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_6403_640061 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "a.b.c" : "this is a" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '6403'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_6403_640061 collection
               Output: document
               Recheck Cond: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "a.b.c" : "this is a" }'::documentdb_core.bson)
               ->  Bitmap Index Scan on wkey_2
                     Index Cond: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "a.b.c" : "this is a" }'::documentdb_core.bson)
(12 rows)

SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_single_field') WHERE document @@ '{ "a.d.c": { "$gt": "this is a" } }';
                                                                                    document                                                                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "d" : { "c" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" } } }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_single_field') WHERE document @@ '{ "a.d.c": { "$gt": "this is a" } }';
                                                                                                                   QUERY PLAN                                                                                                                    
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_6403_640061 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "a.d.c" : "this is a" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '6403'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_6403_640061 collection
               Output: document
               Recheck Cond: (collection.shard_key_value = '6403'::bigint)
               Filter: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "a.d.c" : "this is a" }'::documentdb_core.bson)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '6403'::bigint)
(13 rows)

SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_single_field') WHERE document @@ '{ "a.b.c": { "$gte": [ 2345, 1234, 1234, 1234, 1230 ] , "$lte": [ 2345, 1234, 1234, 1234, 1240 ] } }';
                                                                                                document                                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : { "c" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] } } }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_single_field') WHERE document @@ '{ "a.b.c": { "$gte": [ 2345, 1234, 1234, 1234, 1230 ] , "$lte": [ 2345, 1234, 1234, 1234, 1240 ] } }';
                                                                                                                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_6403_640061 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "a.b.c" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1230" } ] }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#<=) '{ "a.b.c" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1240" } ] }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '6403'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_6403_640061 collection
               Output: document
               Recheck Cond: (collection.document OPERATOR(documentdb_api_catalog.@<>) '{ "a.b.c" : { "min" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1230" } ], "max" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1240" } ], "minInclusive" : true, "maxInclusive" : true } }'::documentdb_core.bson)
               ->  Bitmap Index Scan on wkey_2
                     Index Cond: (collection.document OPERATOR(documentdb_api_catalog.@<>) '{ "a.b.c" : { "min" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1230" } ], "max" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1240" } ], "minInclusive" : true, "maxInclusive" : true } }'::documentdb_core.bson)
(12 rows)

SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_single_field') WHERE document @@ '{ "a.b.c": 1 }';
                                                                  document                                                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : { "c" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "2" }, "e" : "12334141424124" } } }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_single_field') WHERE document @@ '{ "a.b.c": 1 }';
                                                                                                                         QUERY PLAN                                                                                                                         
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_6403_640061 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a.b.c" : { "$numberInt" : "1" } }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '6403'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_6403_640061 collection
               Output: document
               Recheck Cond: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a.b.c" : { "$numberInt" : "1" } }'::documentdb_core.bson)
               ->  Bitmap Index Scan on wkey_2
                     Index Cond: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a.b.c" : { "$numberInt" : "1" } }'::documentdb_core.bson)
(12 rows)

SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_single_field') WHERE document @@ '{ "a.b.c": { "$elemMatch": { "$eq": 2345 } } }';
                                                                                                document                                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : { "c" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ] } } }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_single_field') WHERE document @@ '{ "a.b.c": { "$elemMatch": { "$eq": 2345 } } }';
                                                                                                                                  QUERY PLAN                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_6403_640061 collection WHERE (documentdb_api_catalog.bson_dollar_elemmatch(document, '{ "a.b.c" : { "$eq" : { "$numberInt" : "2345" } } }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '6403'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_6403_640061 collection
               Output: document
               Recheck Cond: (collection.document OPERATOR(documentdb_api_catalog.@#?) '{ "a.b.c" : { "$eq" : { "$numberInt" : "2345" } } }'::documentdb_core.bson)
               ->  Bitmap Index Scan on wkey_2
                     Index Cond: (collection.document OPERATOR(documentdb_api_catalog.@#?) '{ "a.b.c" : { "$eq" : { "$numberInt" : "2345" } } }'::documentdb_core.bson)
(12 rows)

/* create collection again and test with wildcard projection. */
set documentdb.indexTermLimitOverride to 60;
/* should create wildcard index with projection */
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', 
                                '{ 
                                    "createIndexes": "wildcard_index_truncation_tests_wildcard_projection",
                                    "indexes": 
                                    [ 
                                        { "key": { "$**": 1 }, 
                                          "name": "wkey_3", 
                                          "enableLargeIndexKeys": true ,
                                          "wildcardProjection": { "a": 1, "b": 1 }
                                        } 
                                    ] 
                                }');
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

\d documentdb_data.documents_6404
                      Table "documentdb_data.documents_6404"
     Column      |           Type           | Collation | Nullable | Default 
---------------------------------------------------------------------
 shard_key_value | bigint                   |           | not null | 
 object_id       | bson                     |           | not null | 
 document        | bson                     |           | not null | 
 creation_time   | timestamp with time zone |           |          | 
Indexes:
    "collection_pk_6404" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_6411" documentdb_rum (document bson_rum_wildcard_project_path_ops (includeid='false', tl='60', wkl='50', pathspec='[ "a", "b" ]', isexclusion='false'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '6404'::bigint)

/* should succeed and truncate index term with wildcard index */
SELECT documentdb_api.insert_one('db', 'wildcard_index_truncation_tests_wildcard_projection', '{ "_id": 1, "a": "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings", "c": 2 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'wildcard_index_truncation_tests_wildcard_projection', '{ "_id": 2, "b": "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings", "c": 2 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'wildcard_index_truncation_tests_wildcard_projection', '{"_id": 3, "a" : [ 2345, 1234, 1234, 1234, 1234 ], "b": "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'wildcard_index_truncation_tests_wildcard_projection', '{"_id": 4, "a": { "l": { "j": 1 } }, "d": 2 }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_wildcard_projection') WHERE document @@ '{ "a": { "$gt": "this is a" } }';
                                                                                         document                                                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings", "c" : { "$numberInt" : "2" } }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_wildcard_projection') WHERE document @@ '{ "a": { "$gt": "this is a" } }';
                                                                                                                 QUERY PLAN                                                                                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_6404_640074 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "a" : "this is a" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '6404'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_6404_640074 collection
               Output: document
               Recheck Cond: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "a" : "this is a" }'::documentdb_core.bson)
               ->  Bitmap Index Scan on wkey_3
                     Index Cond: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "a" : "this is a" }'::documentdb_core.bson)
(12 rows)

SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_wildcard_projection') WHERE document @@ '{ "b": { "$gt": "this is a" } }';
                                                                                                                                                   document                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "b" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings", "c" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ], "b" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
(2 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_wildcard_projection') WHERE document @@ '{ "b": { "$gt": "this is a" } }';
                                                                                                                 QUERY PLAN                                                                                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_6404_640074 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "b" : "this is a" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '6404'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_6404_640074 collection
               Output: document
               Recheck Cond: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "b" : "this is a" }'::documentdb_core.bson)
               ->  Bitmap Index Scan on wkey_3
                     Index Cond: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "b" : "this is a" }'::documentdb_core.bson)
(12 rows)

SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_wildcard_projection') WHERE document @@ '{ "a": { "$gte": [ 2345, 1234, 1234, 1234, 1230 ] , "$lte": [ 2345, 1234, 1234, 1234, 1240 ] } }';
                                                                                                                                                   document                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ], "b" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_wildcard_projection') WHERE document @@ '{ "a": { "$gte": [ 2345, 1234, 1234, 1234, 1230 ] , "$lte": [ 2345, 1234, 1234, 1234, 1240 ] } }';
                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_6404_640074 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1230" } ] }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#<=) '{ "a" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1240" } ] }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '6404'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_6404_640074 collection
               Output: document
               Recheck Cond: (collection.document OPERATOR(documentdb_api_catalog.@<>) '{ "a" : { "min" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1230" } ], "max" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1240" } ], "minInclusive" : true, "maxInclusive" : true } }'::documentdb_core.bson)
               ->  Bitmap Index Scan on wkey_3
                     Index Cond: (collection.document OPERATOR(documentdb_api_catalog.@<>) '{ "a" : { "min" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1230" } ], "max" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1240" } ], "minInclusive" : true, "maxInclusive" : true } }'::documentdb_core.bson)
(12 rows)

SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_wildcard_projection') WHERE document @@ '{ "a.l.j": 1 }';
                                                      document                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : { "l" : { "j" : { "$numberInt" : "1" } } }, "d" : { "$numberInt" : "2" } }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_wildcard_projection') WHERE document @@ '{ "a.l.j": 1 }';
                                                                                                                         QUERY PLAN                                                                                                                         
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_6404_640074 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a.l.j" : { "$numberInt" : "1" } }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '6404'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_6404_640074 collection
               Output: document
               Recheck Cond: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a.l.j" : { "$numberInt" : "1" } }'::documentdb_core.bson)
               ->  Bitmap Index Scan on wkey_3
                     Index Cond: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a.l.j" : { "$numberInt" : "1" } }'::documentdb_core.bson)
(12 rows)

SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_wildcard_projection') WHERE document @@ '{ "a": { "$elemMatch": { "$eq": 2345 } } }';
                                                                                                                                                   document                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : [ { "$numberInt" : "2345" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" }, { "$numberInt" : "1234" } ], "b" : "this is a string that does violate the index term limit as it goes much over the 100 character limit of strings" }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_wildcard_projection') WHERE document @@ '{ "a": { "$elemMatch": { "$eq": 2345 } } }';
                                                                                                                                QUERY PLAN                                                                                                                                 
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_6404_640074 collection WHERE (documentdb_api_catalog.bson_dollar_elemmatch(document, '{ "a" : { "$eq" : { "$numberInt" : "2345" } } }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '6404'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_6404_640074 collection
               Output: document
               Recheck Cond: (collection.document OPERATOR(documentdb_api_catalog.@#?) '{ "a" : { "$eq" : { "$numberInt" : "2345" } } }'::documentdb_core.bson)
               ->  Bitmap Index Scan on wkey_3
                     Index Cond: (collection.document OPERATOR(documentdb_api_catalog.@#?) '{ "a" : { "$eq" : { "$numberInt" : "2345" } } }'::documentdb_core.bson)
(12 rows)

/* should not use index when query uses key not specified in the projection */
SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_wildcard_projection') WHERE document @@ '{ "c": 1 }';
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_wildcard_projection') WHERE document @@ '{ "c": 1 }';
                                                                                                                       QUERY PLAN                                                                                                                       
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_6404_640074 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "c" : { "$numberInt" : "1" } }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '6404'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_6404_640074 collection
               Output: document
               Recheck Cond: (collection.shard_key_value = '6404'::bigint)
               Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c" : { "$numberInt" : "1" } }'::documentdb_core.bson)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '6404'::bigint)
(13 rows)

SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_wildcard_projection') WHERE document @@ '{ "d": 2 }';
                                                      document                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : { "l" : { "j" : { "$numberInt" : "1" } } }, "d" : { "$numberInt" : "2" } }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api.collection('db', 'wildcard_index_truncation_tests_wildcard_projection') WHERE document @@ '{ "d": 2 }';
                                                                                                                       QUERY PLAN                                                                                                                       
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_6404_640074 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "d" : { "$numberInt" : "2" } }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '6404'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_6404_640074 collection
               Output: document
               Recheck Cond: (collection.shard_key_value = '6404'::bigint)
               Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "d" : { "$numberInt" : "2" } }'::documentdb_core.bson)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '6404'::bigint)
(13 rows)

/* test that term truncation is enabled by default if user doesn't explicitly disable it. */
set documentdb.indexTermLimitOverride to 60;
/* enableLargeIndexKeys should be false because it was explicitly set to false */
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{ "createIndexes": "test_default_trunc1", "indexes": [ { "key": { "a.b": 1 }, "name": "key" } ] }');
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM documentdb_api_catalog.collection_indexes WHERE collection_id = 6405 ORDER BY index_id;
 collection_id | index_id |                         index_spec                         | index_is_valid 
---------------------------------------------------------------------
          6405 |     6412 | (_id_,"{ ""_id"" : { ""$numberInt"" : ""1"" } }",,,,,2,,,) | t
          6405 |     6413 | (key,"{ ""a.b"" : { ""$numberInt"" : ""1"" } }",,,,,2,,,)  | t
(2 rows)

/* enableLargeIndexKeys should be true because it was not explicitly set to false */
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{ "createIndexes": "test_default_trunc2", "indexes": [ { "key": { "a.b": 1 }, "name": "key" } ] }');
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM documentdb_api_catalog.collection_indexes WHERE collection_id = 6406 ORDER BY index_id;
 collection_id | index_id |                         index_spec                         | index_is_valid 
---------------------------------------------------------------------
          6406 |     6414 | (_id_,"{ ""_id"" : { ""$numberInt"" : ""1"" } }",,,,,2,,,) | t
          6406 |     6415 | (key,"{ ""a.b"" : { ""$numberInt"" : ""1"" } }",,,,,2,,,)  | t
(2 rows)

/* enableLargeIndexKeys should be false because index does not support it (ttl index) */
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{ "createIndexes": "test_default_trunc3", "indexes": [{"key": {"ttl": 1}, "name": "ttl_index", "v" : 1, "expireAfterSeconds": 5}]}');
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM documentdb_api_catalog.collection_indexes WHERE collection_id = 6407 ORDER BY index_id;
 collection_id | index_id |                            index_spec                            | index_is_valid 
---------------------------------------------------------------------
          6407 |     6416 | (_id_,"{ ""_id"" : { ""$numberInt"" : ""1"" } }",,,,,2,,,)       | t
          6407 |     6417 | (ttl_index,"{ ""ttl"" : { ""$numberInt"" : ""1"" } }",,,,,1,5,,) | t
(2 rows)

/* enableLargeIndexKeys should be false because index does not support it (hashed) */
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{ "createIndexes": "test_default_trunc4", "indexes": [ { "key": { "a.b": "hashed" }, "name": "key" } ] }');
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM documentdb_api_catalog.collection_indexes WHERE collection_id = 6408 ORDER BY index_id;
 collection_id | index_id |                         index_spec                         | index_is_valid 
---------------------------------------------------------------------
          6408 |     6418 | (_id_,"{ ""_id"" : { ""$numberInt"" : ""1"" } }",,,,,2,,,) | t
          6408 |     6419 | (key,"{ ""a.b"" : ""hashed"" }",,,,,2,,,)                  | t
(2 rows)

/* enableLargeIndexKeys should be false because index does not support it (text) */
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{ "createIndexes": "test_default_trunc5", "indexes": [ { "key": { "a.b": "text" }, "name": "key" } ] }');
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM documentdb_api_catalog.collection_indexes WHERE collection_id = 6409 ORDER BY index_id;
 collection_id | index_id |                         index_spec                         | index_is_valid 
---------------------------------------------------------------------
          6409 |     6420 | (_id_,"{ ""_id"" : { ""$numberInt"" : ""1"" } }",,,,,2,,,) | t
          6409 |     6421 | (key,"{ ""a.b"" : ""text"" }",,,,,2,,,)                    | t
(2 rows)

-- Additional tests for bug where index term length optimization with '$' was not consistent, i.e., we would generate prefix like 'ikey' and '$.0'
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 2, "ikey" : { "a": ["abcdefgh"]}}', 'ikey.a', false, true
, true, 500) term;
 length |                 term                  
---------------------------------------------------------------------
     29 | { "$" : [ "abcdefgh" ], "t" : false }
     21 | { "$" : "abcdefgh", "t" : false }
      8 | { "" : true, "t" : false }
(3 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 2, "ikey" : { "a": ["abcdefgh"]}}', 'ikey.a', false, true
, true) term;
 length |                    term                    
---------------------------------------------------------------------
     34 | { "ikey.a" : [ "abcdefgh" ], "t" : false }
     26 | { "ikey.a" : "abcdefgh", "t" : false }
      8 | { "" : true, "t" : false }
(3 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 2, "ikey" : { "a": ["abcdefgh"]}}', 'ikey.a', true, true
, true, 500) term;
 length |                 term                  
---------------------------------------------------------------------
     29 | { "$" : [ "abcdefgh" ], "t" : false }
     23 | { "$.0" : "abcdefgh", "t" : false }
     21 | { "$" : "abcdefgh", "t" : false }
      8 | { "" : true, "t" : false }
(4 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 2, "ikey" : { "a": ["abcdefgh"]}}', 'ikey.a', true, true
, true) term;
 length |                    term                    
---------------------------------------------------------------------
     34 | { "ikey.a" : [ "abcdefgh" ], "t" : false }
     28 | { "ikey.a.0" : "abcdefgh", "t" : false }
     26 | { "ikey.a" : "abcdefgh", "t" : false }
      8 | { "" : true, "t" : false }
(4 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 2, "ikey" : { "a": ["abcdefgh"]}}', '', true, true
, true, 60) term;
 length |                       term                        
---------------------------------------------------------------------
     14 | { "_id" : { "$numberInt" : "2" }, "t" : false }
     40 | { "ikey" : { "a" : [ "abcdefgh" ] }, "t" : true }
     34 | { "ikey.a" : [ "abcdefgh" ], "t" : false }
     28 | { "ikey.a.0" : "abcdefgh", "t" : false }
     26 | { "ikey.a" : "abcdefgh", "t" : false }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(7 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 2, "ikey" : { "a": ["abcdefgh"]}}', '', true, true
, true) term;
 length |                        term                        
---------------------------------------------------------------------
     14 | { "_id" : { "$numberInt" : "2" }, "t" : false }
     40 | { "ikey" : { "a" : [ "abcdefgh" ] }, "t" : false }
     34 | { "ikey.a" : [ "abcdefgh" ], "t" : false }
     28 | { "ikey.a.0" : "abcdefgh", "t" : false }
     26 | { "ikey.a" : "abcdefgh", "t" : false }
      8 | { "" : true, "t" : false }
(6 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_wildcard_project_generated_terms('{"_id": 2, "ikey" : { "a": ["abcdefgh"]}}', '["ikey"]', false, true               
, true, 60) term;
 length |                       term                        
---------------------------------------------------------------------
     14 | { "_id" : { "$numberInt" : "2" }, "t" : false }
     40 | { "ikey" : { "a" : [ "abcdefgh" ] }, "t" : true }
     34 | { "ikey.a" : [ "abcdefgh" ], "t" : false }
     28 | { "ikey.a.0" : "abcdefgh", "t" : false }
     26 | { "ikey.a" : "abcdefgh", "t" : false }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
(7 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 2, "ikey" : { "a": ["abcdefgh"]}}', 'ikey', true, true, true, 500) term;
 length |                      term                       
---------------------------------------------------------------------
     37 | { "$" : { "a" : [ "abcdefgh" ] }, "t" : false }
     31 | { "$.a" : [ "abcdefgh" ], "t" : false }
     25 | { "$.a.0" : "abcdefgh", "t" : false }
     23 | { "$.a" : "abcdefgh", "t" : false }
      8 | { "" : true, "t" : false }
(5 rows)

SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms('{"_id": 2, "ikey" : { "a": ["abcdefgh"]}}', 'ikey', true, true, true) term;
 length |                        term                        
---------------------------------------------------------------------
     40 | { "ikey" : { "a" : [ "abcdefgh" ] }, "t" : false }
     34 | { "ikey.a" : [ "abcdefgh" ], "t" : false }
     28 | { "ikey.a.0" : "abcdefgh", "t" : false }
     26 | { "ikey.a" : "abcdefgh", "t" : false }
      8 | { "" : true, "t" : false }
(5 rows)

SELECT FORMAT('{ "visits": [ "1" %s ] }', repeat(', { "estimatedTimeOfArrival": { "$date": 101010 }, "estimatedTimeOfDeparture": { "$date": 101010 }, "visitId": "someVisitIdValueString", "visitDocuments": { } } ', 5)) AS documentvalue \gset
SELECT length(bson_dollar_project(term, '{ "t": 0 }')::bytea), term FROM documentdb_distributed_test_helpers.gin_bson_get_single_path_generated_terms(:'documentvalue'::bson, '', true, true, true, 500) term;
 length |                                                                                                                                                                                                                                                                                                                                                                                                          term                                                                                                                                                                                                                                                                                                                                                                                                          
---------------------------------------------------------------------
    486 | { "visits" : [ "1", { "estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "visitId" : "someVisitIdValueString", "visitDocuments" : {  } }, { "estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "visitId" : "someVisitIdValueString", "visitDocuments" : {  } }, { "estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "visitId" : "someVisitIdValueString", "visitDocuments" : {  } }, { "estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "estimatedTimeOfDeparture" : { "$maxKey" : 1 } } ], "t" : true }
     21 | { "visits.0" : "1", "t" : false }
    143 | { "visits.1" : { "estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "visitId" : "someVisitIdValueString", "visitDocuments" : {  } }, "t" : false }
     46 | { "visits.1.estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     48 | { "visits.1.estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     50 | { "visits.1.visitId" : "someVisitIdValueString", "t" : false }
     35 | { "visits.1.visitDocuments" : {  }, "t" : false }
    143 | { "visits.2" : { "estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "visitId" : "someVisitIdValueString", "visitDocuments" : {  } }, "t" : false }
     46 | { "visits.2.estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     48 | { "visits.2.estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     50 | { "visits.2.visitId" : "someVisitIdValueString", "t" : false }
     35 | { "visits.2.visitDocuments" : {  }, "t" : false }
    143 | { "visits.3" : { "estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "visitId" : "someVisitIdValueString", "visitDocuments" : {  } }, "t" : false }
     46 | { "visits.3.estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     48 | { "visits.3.estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     50 | { "visits.3.visitId" : "someVisitIdValueString", "t" : false }
     35 | { "visits.3.visitDocuments" : {  }, "t" : false }
    143 | { "visits.4" : { "estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "visitId" : "someVisitIdValueString", "visitDocuments" : {  } }, "t" : false }
     46 | { "visits.4.estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     48 | { "visits.4.estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     50 | { "visits.4.visitId" : "someVisitIdValueString", "t" : false }
     35 | { "visits.4.visitDocuments" : {  }, "t" : false }
    143 | { "visits.5" : { "estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "visitId" : "someVisitIdValueString", "visitDocuments" : {  } }, "t" : false }
     46 | { "visits.5.estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     48 | { "visits.5.estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     50 | { "visits.5.visitId" : "someVisitIdValueString", "t" : false }
     35 | { "visits.5.visitDocuments" : {  }, "t" : false }
     19 | { "visits" : "1", "t" : false }
    141 | { "visits" : { "estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "visitId" : "someVisitIdValueString", "visitDocuments" : {  } }, "t" : false }
     44 | { "visits.estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     46 | { "visits.estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     48 | { "visits.visitId" : "someVisitIdValueString", "t" : false }
     33 | { "visits.visitDocuments" : {  }, "t" : false }
    141 | { "visits" : { "estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "visitId" : "someVisitIdValueString", "visitDocuments" : {  } }, "t" : false }
     44 | { "visits.estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     46 | { "visits.estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     48 | { "visits.visitId" : "someVisitIdValueString", "t" : false }
     33 | { "visits.visitDocuments" : {  }, "t" : false }
    141 | { "visits" : { "estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "visitId" : "someVisitIdValueString", "visitDocuments" : {  } }, "t" : false }
     44 | { "visits.estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     46 | { "visits.estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     48 | { "visits.visitId" : "someVisitIdValueString", "t" : false }
     33 | { "visits.visitDocuments" : {  }, "t" : false }
    141 | { "visits" : { "estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "visitId" : "someVisitIdValueString", "visitDocuments" : {  } }, "t" : false }
     44 | { "visits.estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     46 | { "visits.estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     48 | { "visits.visitId" : "someVisitIdValueString", "t" : false }
     33 | { "visits.visitDocuments" : {  }, "t" : false }
    141 | { "visits" : { "estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "visitId" : "someVisitIdValueString", "visitDocuments" : {  } }, "t" : false }
     44 | { "visits.estimatedTimeOfArrival" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     46 | { "visits.estimatedTimeOfDeparture" : { "$date" : { "$numberLong" : "101010" } }, "t" : false }
     48 | { "visits.visitId" : "someVisitIdValueString", "t" : false }
     33 | { "visits.visitDocuments" : {  }, "t" : false }
      8 | { "" : true, "t" : false }
      7 | { "" : { "$maxKey" : 1 }, "t" : true }
     12 | { "" : [  ], "t" : false }
(56 rows)

SET documentdb.enableIndexTermTruncationOnNestedObjects to off;
