SET search_path TO documentdb_api_catalog;
SET citus.next_shard_id TO 330000;
SET documentdb.next_collection_id TO 33000;
SET documentdb.next_collection_index_id TO 33000;
DO $$
BEGIN
    FOR i IN 1..10000 LOOP
        PERFORM documentdb_api.insert_one('db', 'in_opt_tests', '{ "accid": 1, "vid": 3, "val": [1, 2] }');
    END LOOP;
END;
$$ LANGUAGE plpgsql;
NOTICE:  creating collection
SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":1, "accid": 1, "vid": 1, "val": [1, 2]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":2, "accid": 1, "vid": 2, "val": [3, 4]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":3, "_id":1, "accid": 1, "vid": 1, "val": [3, 1]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":4, "accid": 1, "vid": 2, "val": {"test": 5}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":5, "accid": 1, "vid": 1, "val": [{"test": 7}]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":6, "accid": 1, "vid": 2, "val": [true, false]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":7, "accid": 1, "vid": 1, "val": 2}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":8, "accid": 1, "vid": 2, "val": 3}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":9, "accid": 1, "vid": 1, "val": 4}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":10, "accid": 1, "vid": 2, "val": [2]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":11, "accid": 1, "vid": 1, "val": [3]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":12, "accid": 1, "vid": 2, "val": [4]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":13, "accid": 1, "vid": 1, "val": [1, true]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":14, "accid": 1, "vid": 2, "val": [true, 1]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":15, "accid": 1, "vid": 1, "val": [1, 4]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":16, "accid": 1, "vid": 2, "val": [null]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":17, "accid": 1, "vid": 1, "val": null}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":18, "accid": 1, "vid": 2, "val": { "$minKey": 1 }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":19, "accid": 1, "vid": 1, "val": [{ "$minKey": 1 }]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":20, "accid": 1, "vid": 2, "val": [{ "$minKey": 1 }, 3]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":21, "accid": 1, "vid": 1, "val": [3, { "$minKey": 1 }]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":22, "accid": 1, "vid": 2, "val": { "$maxKey": 1 }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":23, "accid": 1, "vid": 1, "val": [{ "$maxKey": 1 }]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":24, "accid": 1, "vid": 2, "val": [{ "$maxKey": 1 }, 3]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":25, "accid": 1, "vid": 1, "val": [3, { "$maxKey": 1 }]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":26, "accid": 1, "vid": 2, "val": []}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":27, "accid": 1, "vid": 1, "a": {"val": [1, 2]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":28, "accid": 1, "vid": 2, "a": {"val": [3, 4]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":29, "accid": 1, "vid": 1, "a": {"val": [3, 1]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":30, "accid": 1, "vid": 2, "a": {"val": {"test": 5}}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":31, "accid": 1, "vid": 1, "a": {"val": [{"test": 7}]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":32, "accid": 1, "vid": 2, "a": {"val": [true, false]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":33, "accid": 1, "vid": 1, "a": {"val": 2}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":34, "accid": 1, "vid": 2, "a": {"val": 3}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":35, "accid": 1, "vid": 1, "a": {"val": 4}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":36, "accid": 1, "vid": 2, "a": {"val": [2]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":37, "accid": 1, "vid": 1, "a": {"val": [3]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":38, "accid": 1, "vid": 2, "a": {"val": [4]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":39, "accid": 1, "vid": 1, "a": {"val": [1, true]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":40, "accid": 1, "vid": 2, "a": {"val": [true, 1]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":41, "accid": 1, "vid": 1, "a": {"val": [1, 4]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":42, "accid": 1, "vid": 2, "a": {"val": [null]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":43, "accid": 1, "vid": 1, "a": {"val": null}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":44, "accid": 1, "vid": 2, "a": {"val": { "$minKey": 1 }}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":45, "accid": 1, "vid": 1, "a": {"val": [{ "$minKey": 1 }]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":46, "accid": 1, "vid": 2, "a": {"val": [{ "$minKey": 1 }, 3]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":47, "accid": 1, "vid": 1, "a": {"val": [3, { "$minKey": 1 }]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":48, "accid": 1, "vid": 2, "a": {"val": { "$maxKey": 1 }}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":49, "accid": 1, "vid": 1, "a": {"val": [{ "$maxKey": 1 }]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":50, "accid": 1, "vid": 2, "a": {"val": [{ "$maxKey": 1 }, 3]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":51, "accid": 1, "vid": 1, "a": {"val": [3, { "$maxKey": 1 }]}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'in_opt_tests', '{"_id":52, "accid": 1, "vid": 2, "a": {"val": []}}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "val": { "$in": [1, 2, 3]} } }');
                                                                                             document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] }
 { "_id" : { "$numberInt" : "3" }, "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "7" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "11" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "13" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, true ] }
 { "_id" : { "$numberInt" : "15" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "21" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] }
 { "_id" : { "$numberInt" : "25" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] }
(8 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1,  "$or": [{"val": { "$eq": 1}}, {"val": { "$eq": 3}}] } }');
                                                                                             document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] }
 { "_id" : { "$numberInt" : "3" }, "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "11" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "13" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, true ] }
 { "_id" : { "$numberInt" : "15" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "21" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] }
 { "_id" : { "$numberInt" : "25" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] }
(7 rows)

 
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "in_opt_tests",
     "indexes": [
       {"key": {"val": 1, "accid": 1, "vid": 1}, "name": "val_accid_vid"}
     ]
   }',
   true
);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "in_opt_tests",
     "indexes": [
       {"key": {"a.val": 1, "accid": 1, "vid": 1}, "name": "a_val_accid_vid"}
     ]
   }',
   true
);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "2" }, "numIndexesAfter" : { "$numberInt" : "3" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

BEGIN;
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "$or": [{"val": { "$eq": 1}}, {"val": { "$eq": 3}}] } }'); 
                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330005 collection
               Recheck Cond: ((document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               ->  Bitmap Index Scan on val_accid_vid
                     Index Cond: ((document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(9 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": {"$or": [{"val": { "$eq": 1}, "accid":{ "$eq": 1}, "vid": { "$eq": 1}}, {"val": { "$eq": 3}, "accid":{ "$eq": 1}, "vid": { "$eq": 1}}] } }'); 
                                                                                                               QUERY PLAN                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330005 collection
               Recheck Cond: ((document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "val" : { "$numberInt" : "1" } }'::documentdb_core.bson) OR (document OPERATOR(documentdb_api_catalog.@=) '{ "val" : { "$numberInt" : "3" } }'::documentdb_core.bson))
               ->  Bitmap Index Scan on a_val_accid_vid
                     Index Cond: ((document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(10 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "val": { "$in": [1, 3]} } }');
                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330005 collection
               Recheck Cond: ((document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               ->  Bitmap Index Scan on val_accid_vid
                     Index Cond: ((document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(9 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "a.val": { "$in": [1, 3]} } }');
                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                 
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330005 collection
               Recheck Cond: ((document OPERATOR(documentdb_api_catalog.@*=) '{ "a.val" : [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               ->  Bitmap Index Scan on a_val_accid_vid
                     Index Cond: ((document OPERATOR(documentdb_api_catalog.@*=) '{ "a.val" : [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(9 rows)

-- no optimization
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "val": { "$in": []} } }');
                                                   QUERY PLAN                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330005 collection
               Recheck Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [  ] }'::documentdb_core.bson)
               ->  Bitmap Index Scan on val_accid_vid
                     Index Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [  ] }'::documentdb_core.bson)
(9 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "val": { "$in": [4, 3]} } }');
                                                                          QUERY PLAN                                                                          
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330005 collection
               Recheck Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [ { "$numberInt" : "4" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson)
               ->  Bitmap Index Scan on val_accid_vid
                     Index Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [ { "$numberInt" : "4" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson)
(9 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "a.val": { "$in": [4, 3]} } }');
                                                                           QUERY PLAN                                                                           
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330005 collection
               Recheck Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "a.val" : [ { "$numberInt" : "4" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson)
               ->  Bitmap Index Scan on a_val_accid_vid
                     Index Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "a.val" : [ { "$numberInt" : "4" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson)
(9 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "val": { "$in": [3]} } }');
                                                                                                                                                                 QUERY PLAN                                                                                                                                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330005 collection
               Recheck Cond: ((document OPERATOR(documentdb_api_catalog.@=) '{ "val" : { "$numberInt" : "3" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               ->  Bitmap Index Scan on val_accid_vid
                     Index Cond: ((document OPERATOR(documentdb_api_catalog.@=) '{ "val" : { "$numberInt" : "3" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(9 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "a.val": { "$in": [3]} } }');
                                                                                                                                                                  QUERY PLAN                                                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330005 collection
               Recheck Cond: ((document OPERATOR(documentdb_api_catalog.@=) '{ "a.val" : { "$numberInt" : "3" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               ->  Bitmap Index Scan on a_val_accid_vid
                     Index Cond: ((document OPERATOR(documentdb_api_catalog.@=) '{ "a.val" : { "$numberInt" : "3" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(9 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "$or": [{"val": { "$eq": 1}}, {"val": { "$eq": 3}}] } }'); 
                                                                                             document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] }
 { "_id" : { "$numberInt" : "3" }, "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "11" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "13" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, true ] }
 { "_id" : { "$numberInt" : "15" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "21" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] }
 { "_id" : { "$numberInt" : "25" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] }
(7 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": {"$or": [{"val": { "$eq": 1}, "accid":{ "$eq": 1}, "vid": { "$eq": 1}}, {"val": { "$eq": 3}, "accid":{ "$eq": 1}, "vid": { "$eq": 1}}] } }'); 
                                                                                             document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] }
 { "_id" : { "$numberInt" : "3" }, "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "11" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "13" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, true ] }
 { "_id" : { "$numberInt" : "15" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "21" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] }
 { "_id" : { "$numberInt" : "25" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] }
(7 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "val": { "$in": [1, 3]} } }');
                                                                                             document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] }
 { "_id" : { "$numberInt" : "3" }, "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "11" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "13" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, true ] }
 { "_id" : { "$numberInt" : "15" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "21" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] }
 { "_id" : { "$numberInt" : "25" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] }
(7 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "a.val": { "$in": [1, 3]} } }');
                                                                                  document                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "27" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] } }
 { "_id" : { "$numberInt" : "29" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] } }
 { "_id" : { "$numberInt" : "37" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" } ] } }
 { "_id" : { "$numberInt" : "39" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "1" }, true ] } }
 { "_id" : { "$numberInt" : "41" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "4" } ] } }
 { "_id" : { "$numberInt" : "47" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] } }
 { "_id" : { "$numberInt" : "51" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] } }
(7 rows)

-- no optimization
SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "val": { "$in": []} } }');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "val": { "$in": [4, 3]} } }');
                                                                                             document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "3" }, "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "8" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "val" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "9" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "11" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "12" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "val" : [ { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "15" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "20" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "val" : [ { "$minKey" : 1 }, { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "21" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] }
 { "_id" : { "$numberInt" : "24" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "val" : [ { "$maxKey" : 1 }, { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "25" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] }
(11 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "a.val": { "$in": [4, 3]} } }');
                                                                                  document                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "28" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "4" } ] } }
 { "_id" : { "$numberInt" : "29" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] } }
 { "_id" : { "$numberInt" : "34" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "a" : { "val" : { "$numberInt" : "3" } } }
 { "_id" : { "$numberInt" : "35" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : { "$numberInt" : "4" } } }
 { "_id" : { "$numberInt" : "37" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" } ] } }
 { "_id" : { "$numberInt" : "38" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "a" : { "val" : [ { "$numberInt" : "4" } ] } }
 { "_id" : { "$numberInt" : "41" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "4" } ] } }
 { "_id" : { "$numberInt" : "46" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "a" : { "val" : [ { "$minKey" : 1 }, { "$numberInt" : "3" } ] } }
 { "_id" : { "$numberInt" : "47" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] } }
 { "_id" : { "$numberInt" : "50" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "a" : { "val" : [ { "$maxKey" : 1 }, { "$numberInt" : "3" } ] } }
 { "_id" : { "$numberInt" : "51" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] } }
(11 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "val": { "$in": [3]} } }');
                                                                                             document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "11" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "21" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] }
 { "_id" : { "$numberInt" : "25" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "a.val": { "$in": [3]} } }');
                                                                                  document                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "29" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] } }
 { "_id" : { "$numberInt" : "37" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" } ] } }
 { "_id" : { "$numberInt" : "47" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] } }
 { "_id" : { "$numberInt" : "51" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] } }
(4 rows)

END;
SELECT documentdb_api.shard_collection('db','in_opt_tests', '{"accid":"hashed"}', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

BEGIN;
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "$or": [{"val": { "$eq": 1}}, {"val": { "$eq": 3}}] } }'); 
                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330023 collection
               Recheck Cond: ((document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Filter: (shard_key_value = '4322365043291501017'::bigint)
               ->  Bitmap Index Scan on val_accid_vid
                     Index Cond: ((document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(10 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": {"$or": [{"val": { "$eq": 1}, "accid":{ "$eq": 1}, "vid": { "$eq": 1}}, {"val": { "$eq": 3}, "accid":{ "$eq": 1}, "vid": { "$eq": 1}}] } }'); 
                                                                                                                                     QUERY PLAN                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330023 collection
               Recheck Cond: ((document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Filter: ((shard_key_value = '4322365043291501017'::bigint) AND ((document OPERATOR(documentdb_api_catalog.@=) '{ "val" : { "$numberInt" : "1" } }'::documentdb_core.bson) OR (document OPERATOR(documentdb_api_catalog.@=) '{ "val" : { "$numberInt" : "3" } }'::documentdb_core.bson)))
               ->  Bitmap Index Scan on a_val_accid_vid
                     Index Cond: ((document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(10 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "val": { "$in": [1, 3]} } }');
                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330023 collection
               Recheck Cond: ((document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Filter: (shard_key_value = '4322365043291501017'::bigint)
               ->  Bitmap Index Scan on val_accid_vid
                     Index Cond: ((document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(10 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "a.val": { "$in": [1, 3]} } }');
                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                 
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330023 collection
               Recheck Cond: ((document OPERATOR(documentdb_api_catalog.@*=) '{ "a.val" : [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Filter: (shard_key_value = '4322365043291501017'::bigint)
               ->  Bitmap Index Scan on a_val_accid_vid
                     Index Cond: ((document OPERATOR(documentdb_api_catalog.@*=) '{ "a.val" : [ { "$numberInt" : "1" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(10 rows)

-- no optimization
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "val": { "$in": []} } }');
                                                   QUERY PLAN                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330016 collection
               Recheck Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [  ] }'::documentdb_core.bson)
               ->  Bitmap Index Scan on val_accid_vid
                     Index Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [  ] }'::documentdb_core.bson)
(9 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "val": { "$in": [4, 3]} } }');
                                                                          QUERY PLAN                                                                          
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330016 collection
               Recheck Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [ { "$numberInt" : "4" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson)
               ->  Bitmap Index Scan on val_accid_vid
                     Index Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "val" : [ { "$numberInt" : "4" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson)
(9 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "a.val": { "$in": [4, 3]} } }');
                                                                           QUERY PLAN                                                                           
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330016 collection
               Recheck Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "a.val" : [ { "$numberInt" : "4" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson)
               ->  Bitmap Index Scan on a_val_accid_vid
                     Index Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "a.val" : [ { "$numberInt" : "4" }, { "$numberInt" : "3" } ] }'::documentdb_core.bson)
(9 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "val": { "$in": [3]} } }');
                                                                                                                                                                 QUERY PLAN                                                                                                                                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330023 collection
               Recheck Cond: ((document OPERATOR(documentdb_api_catalog.@=) '{ "val" : { "$numberInt" : "3" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Filter: (shard_key_value = '4322365043291501017'::bigint)
               ->  Bitmap Index Scan on val_accid_vid
                     Index Cond: ((document OPERATOR(documentdb_api_catalog.@=) '{ "val" : { "$numberInt" : "3" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(10 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "a.val": { "$in": [3]} } }');
                                                                                                                                                                  QUERY PLAN                                                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_33000_330023 collection
               Recheck Cond: ((document OPERATOR(documentdb_api_catalog.@=) '{ "a.val" : { "$numberInt" : "3" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Filter: (shard_key_value = '4322365043291501017'::bigint)
               ->  Bitmap Index Scan on a_val_accid_vid
                     Index Cond: ((document OPERATOR(documentdb_api_catalog.@=) '{ "a.val" : { "$numberInt" : "3" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "accid" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "vid" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(10 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "$or": [{"val": { "$eq": 1}}, {"val": { "$eq": 3}}] } }'); 
                                                                                             document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] }
 { "_id" : { "$numberInt" : "3" }, "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "11" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "13" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, true ] }
 { "_id" : { "$numberInt" : "15" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "21" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] }
 { "_id" : { "$numberInt" : "25" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] }
(7 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": {"$or": [{"val": { "$eq": 1}, "accid":{ "$eq": 1}, "vid": { "$eq": 1}}, {"val": { "$eq": 3}, "accid":{ "$eq": 1}, "vid": { "$eq": 1}}] } }'); 
                                                                                             document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] }
 { "_id" : { "$numberInt" : "3" }, "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "11" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "13" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, true ] }
 { "_id" : { "$numberInt" : "15" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "21" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] }
 { "_id" : { "$numberInt" : "25" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] }
(7 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "val": { "$in": [1, 3]} } }');
                                                                                             document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] }
 { "_id" : { "$numberInt" : "3" }, "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "11" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "13" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, true ] }
 { "_id" : { "$numberInt" : "15" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "21" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] }
 { "_id" : { "$numberInt" : "25" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] }
(7 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "a.val": { "$in": [1, 3]} } }');
                                                                                  document                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "27" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" } ] } }
 { "_id" : { "$numberInt" : "29" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] } }
 { "_id" : { "$numberInt" : "37" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" } ] } }
 { "_id" : { "$numberInt" : "39" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "1" }, true ] } }
 { "_id" : { "$numberInt" : "41" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "4" } ] } }
 { "_id" : { "$numberInt" : "47" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] } }
 { "_id" : { "$numberInt" : "51" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] } }
(7 rows)

-- no optimization
SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "val": { "$in": []} } }');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "val": { "$in": [4, 3]} } }');
                                                                                             document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "3" }, "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "8" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "val" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "9" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "11" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "12" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "val" : [ { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "15" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "4" } ] }
 { "_id" : { "$numberInt" : "20" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "val" : [ { "$minKey" : 1 }, { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "21" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] }
 { "_id" : { "$numberInt" : "24" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "val" : [ { "$maxKey" : 1 }, { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "25" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] }
(11 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "a.val": { "$in": [4, 3]} } }');
                                                                                  document                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "28" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "4" } ] } }
 { "_id" : { "$numberInt" : "29" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] } }
 { "_id" : { "$numberInt" : "34" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "a" : { "val" : { "$numberInt" : "3" } } }
 { "_id" : { "$numberInt" : "35" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : { "$numberInt" : "4" } } }
 { "_id" : { "$numberInt" : "37" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" } ] } }
 { "_id" : { "$numberInt" : "38" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "a" : { "val" : [ { "$numberInt" : "4" } ] } }
 { "_id" : { "$numberInt" : "41" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "1" }, { "$numberInt" : "4" } ] } }
 { "_id" : { "$numberInt" : "46" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "a" : { "val" : [ { "$minKey" : 1 }, { "$numberInt" : "3" } ] } }
 { "_id" : { "$numberInt" : "47" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] } }
 { "_id" : { "$numberInt" : "50" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "2" }, "a" : { "val" : [ { "$maxKey" : 1 }, { "$numberInt" : "3" } ] } }
 { "_id" : { "$numberInt" : "51" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] } }
(11 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "val": { "$in": [3]} } }');
                                                                                             document                                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "_id" : { "$numberInt" : "1" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] }
 { "_id" : { "$numberInt" : "11" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" } ] }
 { "_id" : { "$numberInt" : "21" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] }
 { "_id" : { "$numberInt" : "25" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "in_opt_tests", "filter": { "accid":1, "vid": 1, "a.val": { "$in": [3]} } }');
                                                                                  document                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "29" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$numberInt" : "1" } ] } }
 { "_id" : { "$numberInt" : "37" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" } ] } }
 { "_id" : { "$numberInt" : "47" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$minKey" : 1 } ] } }
 { "_id" : { "$numberInt" : "51" }, "accid" : { "$numberInt" : "1" }, "vid" : { "$numberInt" : "1" }, "a" : { "val" : [ { "$numberInt" : "3" }, { "$maxKey" : 1 } ] } }
(4 rows)

END;
