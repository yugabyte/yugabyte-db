SET search_path TO documentdb_core,documentdb_api,documentdb_api_catalog,documentdb_api_internal;
SET citus.next_shard_id TO 630000;
SET documentdb.next_collection_id TO 6300;
SET documentdb.next_collection_index_id TO 6300;
-- Utility function to add multiple documents to a collection.
CREATE OR REPLACE FUNCTION insert_docs(p_db TEXT, p_coll TEXT, p_num INT, p_start INT default 0)
RETURNS void
AS $$
DECLARE
    num INTEGER := p_start;
    docText bson;
BEGIN
    WHILE num < p_num + p_start LOOP
        docText :=  CONCAT('{ "a" : ', num, '}');
        PERFORM documentdb_api.insert_one(p_db, p_coll, docText::documentdb_core.bson, NULL);
        num := num + 1;
    END LOOP;
END;
$$
LANGUAGE plpgsql;
SELECT documentdb_api.drop_database('db1');
 drop_database 
---------------------------------------------------------------------
 
(1 row)

-- Non existing database should return zero values
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                db_stats                                                                                                                                                                                                                                
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "0" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "0" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "0.0" }, "storageSize" : { "$numberDouble" : "0.0" }, "indexes" : { "$numberLong" : "0" }, "indexSize" : { "$numberDouble" : "0.0" }, "totalSize" : { "$numberDouble" : "0.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api.db_stats('db1', 1);
                                                                                                                                                                                                                                db_stats                                                                                                                                                                                                                                
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "0" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "0" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "0.0" }, "storageSize" : { "$numberDouble" : "0.0" }, "indexes" : { "$numberLong" : "0" }, "indexSize" : { "$numberDouble" : "0.0" }, "totalSize" : { "$numberDouble" : "0.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api.db_stats('db1', 1024);
                                                                                                                                                                                                                                 db_stats                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "0" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "0" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "0.0" }, "storageSize" : { "$numberDouble" : "0.0" }, "indexes" : { "$numberLong" : "0" }, "indexSize" : { "$numberDouble" : "0.0" }, "totalSize" : { "$numberDouble" : "0.0" }, "scaleFactor" : { "$numberInt" : "1024" }, "ok" : { "$numberInt" : "1" } }
(1 row)

--=============== Tests for "collections" & "objects" count ===============+=--
-- Create a Collection
SELECT documentdb_api.create_collection('db1', 'col1');
NOTICE:  creating collection
 create_collection 
---------------------------------------------------------------------
 t
(1 row)

-- db_stats with one empty collection
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                      db_stats                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "1" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "0" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "8192.0" }, "storageSize" : { "$numberDouble" : "8192.0" }, "indexes" : { "$numberLong" : "1" }, "indexSize" : { "$numberDouble" : "8192.0" }, "totalSize" : { "$numberDouble" : "16384.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api.db_stats('db1', 1);
                                                                                                                                                                                                                                      db_stats                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "1" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "0" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "8192.0" }, "storageSize" : { "$numberDouble" : "8192.0" }, "indexes" : { "$numberLong" : "1" }, "indexSize" : { "$numberDouble" : "8192.0" }, "totalSize" : { "$numberDouble" : "16384.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api.db_stats('db1', 1024);
                                                                                                                                                                                                                                  db_stats                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "1" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "0" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "8.0" }, "storageSize" : { "$numberDouble" : "8.0" }, "indexes" : { "$numberLong" : "1" }, "indexSize" : { "$numberDouble" : "8.0" }, "totalSize" : { "$numberDouble" : "16.0" }, "scaleFactor" : { "$numberInt" : "1024" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Add one doc
SELECT documentdb_api.insert_one('db1','col1',' { "a" : 100 }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- The AutoVacuum might still be napping so count in stats might still be 0,
-- In this test we cannot wait till nap time is over, so we manually trigger the ANALYZE
ANALYZE;
-- db_stats with single collection and single document
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                       db_stats                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "1" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "1" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "30.0" }, "storageSize" : { "$numberDouble" : "16384.0" }, "indexes" : { "$numberLong" : "1" }, "indexSize" : { "$numberDouble" : "16384.0" }, "totalSize" : { "$numberDouble" : "32768.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Insert few docs in the collection
SELECT insert_docs('db1', 'col1', 20, 1);
 insert_docs 
---------------------------------------------------------------------
 
(1 row)

-- In this test we cannot wait till Autovaccum nap time is over, so we manually trigger the ANALYZE
ANALYZE;
-- "objects" should be 21, "collections" should be 1, and fsStorageSize > fsUsedSize
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                        db_stats                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "1" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "21" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "630.0" }, "storageSize" : { "$numberDouble" : "16384.0" }, "indexes" : { "$numberLong" : "1" }, "indexSize" : { "$numberDouble" : "16384.0" }, "totalSize" : { "$numberDouble" : "32768.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Create 4 more Collections
SELECT documentdb_api.create_collection('db1', 'col2');
NOTICE:  creating collection
 create_collection 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.create_collection('db1', 'col3');
NOTICE:  creating collection
 create_collection 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.create_collection('db1', 'col4');
NOTICE:  creating collection
 create_collection 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.create_collection('db1', 'col5');
NOTICE:  creating collection
 create_collection 
---------------------------------------------------------------------
 t
(1 row)

-- "collections" and "indexes" count should increase to 5
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                        db_stats                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "5" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "21" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "630.0" }, "storageSize" : { "$numberDouble" : "49152.0" }, "indexes" : { "$numberLong" : "5" }, "indexSize" : { "$numberDouble" : "49152.0" }, "totalSize" : { "$numberDouble" : "98304.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Add one doc to each new collection
SELECT documentdb_api.insert_one('db1','col2',' { "a" : 100 }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db1','col3',' { "a" : 100 }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db1','col4',' { "a" : 100 }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db1','col5',' { "a" : 100 }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- In this test we cannot wait till Autovaccum nap time is over, so we manually trigger the ANALYZE
ANALYZE;
-- "objects" count should increase to 25
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                        db_stats                                                                                                                                                                                                                                         
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "5" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "25" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "750.0" }, "storageSize" : { "$numberDouble" : "81920.0" }, "indexes" : { "$numberLong" : "5" }, "indexSize" : { "$numberDouble" : "81920.0" }, "totalSize" : { "$numberDouble" : "163840.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Insert 20 more docs in each new collection
SELECT insert_docs('db1', 'col2', 20, 1);
 insert_docs 
---------------------------------------------------------------------
 
(1 row)

SELECT insert_docs('db1', 'col3', 20, 1);
 insert_docs 
---------------------------------------------------------------------
 
(1 row)

SELECT insert_docs('db1', 'col4', 20, 1);
 insert_docs 
---------------------------------------------------------------------
 
(1 row)

SELECT insert_docs('db1', 'col5', 20, 1);
 insert_docs 
---------------------------------------------------------------------
 
(1 row)

-- In this test we cannot wait till Autovaccum nap time is over, so we manually trigger the ANALYZE
ANALYZE;
-- "objects" count should increase to 105
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                         db_stats                                                                                                                                                                                                                                          
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "5" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "105" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "3150.0" }, "storageSize" : { "$numberDouble" : "81920.0" }, "indexes" : { "$numberLong" : "5" }, "indexSize" : { "$numberDouble" : "81920.0" }, "totalSize" : { "$numberDouble" : "163840.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Delete 1 document
SELECT documentdb_api.delete('db1', '{"delete":"col1", "deletes":[{"q":{"a":{"$gte": 100}},"limit":0}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

-- In this test we cannot wait till Autovaccum nap time is over, so we manually trigger the ANALYZE
ANALYZE;
-- "objects" count should reduce to 104
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                         db_stats                                                                                                                                                                                                                                          
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "5" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "104" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "3120.0" }, "storageSize" : { "$numberDouble" : "81920.0" }, "indexes" : { "$numberLong" : "5" }, "indexSize" : { "$numberDouble" : "81920.0" }, "totalSize" : { "$numberDouble" : "163840.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Delete 1 document from each remaining collections
SELECT documentdb_api.delete('db1', '{"delete":"col2", "deletes":[{"q":{"a":{"$gte": 100}},"limit":0}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db1', '{"delete":"col3", "deletes":[{"q":{"a":{"$gte": 100}},"limit":0}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db1', '{"delete":"col4", "deletes":[{"q":{"a":{"$gte": 100}},"limit":0}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db1', '{"delete":"col5", "deletes":[{"q":{"a":{"$gte": 100}},"limit":0}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

-- In this test we cannot wait till Autovaccum nap time is over, so we manually trigger the ANALYZE
ANALYZE;
-- "objects" count should reduce to 100
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                         db_stats                                                                                                                                                                                                                                          
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "5" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "100" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "3000.0" }, "storageSize" : { "$numberDouble" : "81920.0" }, "indexes" : { "$numberLong" : "5" }, "indexSize" : { "$numberDouble" : "81920.0" }, "totalSize" : { "$numberDouble" : "163840.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Now shard all collections
SELECT documentdb_api.shard_collection('db1','col1', '{"a":"hashed"}', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT documentdb_api.shard_collection('db1','col2', '{"a":"hashed"}', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT documentdb_api.shard_collection('db1','col3', '{"a":"hashed"}', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT documentdb_api.shard_collection('db1','col4', '{"a":"hashed"}', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT documentdb_api.shard_collection('db1','col5', '{"a":"hashed"}', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- "objects" count should remain 100
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                            db_stats                                                                                                                                                                                                                                            
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "5" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "100" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "614400.0" }, "storageSize" : { "$numberDouble" : "614400.0" }, "indexes" : { "$numberLong" : "5" }, "indexSize" : { "$numberDouble" : "1269760.0" }, "totalSize" : { "$numberDouble" : "1884160.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

--===================== Test for "indexes", "indexSize" =====================--
-- Create one more index
SELECT documentdb_api_internal.create_indexes_non_concurrently('db1', documentdb_distributed_test_helpers.generate_create_index_arg('col1', 'index_a_1', '{"a": 1}'), true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- "indexes" count should increase to 6, "indexSize" should increase
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                            db_stats                                                                                                                                                                                                                                            
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "5" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "100" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "614400.0" }, "storageSize" : { "$numberDouble" : "614400.0" }, "indexes" : { "$numberLong" : "6" }, "indexSize" : { "$numberDouble" : "1400832.0" }, "totalSize" : { "$numberDouble" : "2015232.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Create one more index in each remaining collections
SELECT documentdb_api_internal.create_indexes_non_concurrently('db1', documentdb_distributed_test_helpers.generate_create_index_arg('col2', 'index_a_1', '{"a": 1}'), true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db1', documentdb_distributed_test_helpers.generate_create_index_arg('col3', 'index_a_1', '{"a": 1}'), true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db1', documentdb_distributed_test_helpers.generate_create_index_arg('col4', 'index_a_1', '{"a": 1}'), true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db1', documentdb_distributed_test_helpers.generate_create_index_arg('col5', 'index_a_1', '{"a": 1}'), true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- "indexes" count should increase to 10, "indexSize" should increase
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                            db_stats                                                                                                                                                                                                                                             
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "5" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "100" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "614400.0" }, "storageSize" : { "$numberDouble" : "614400.0" }, "indexes" : { "$numberLong" : "10" }, "indexSize" : { "$numberDouble" : "1925120.0" }, "totalSize" : { "$numberDouble" : "2539520.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Drop one index
CALL documentdb_api.drop_indexes('db1', '{"dropIndexes": "col1", "index": "index_a_1"}');
                          retval                          
---------------------------------------------------------------------
 { "ok" : true, "nIndexesWas" : { "$numberLong" : "2" } }
(1 row)

-- "indexes" count should reduce to 9
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                            db_stats                                                                                                                                                                                                                                            
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "5" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "100" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "614400.0" }, "storageSize" : { "$numberDouble" : "614400.0" }, "indexes" : { "$numberLong" : "9" }, "indexSize" : { "$numberDouble" : "1794048.0" }, "totalSize" : { "$numberDouble" : "2408448.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Drop one index from each remaining collections
CALL documentdb_api.drop_indexes('db1', '{"dropIndexes": "col2", "index": "index_a_1"}');
                          retval                          
---------------------------------------------------------------------
 { "ok" : true, "nIndexesWas" : { "$numberLong" : "2" } }
(1 row)

CALL documentdb_api.drop_indexes('db1', '{"dropIndexes": "col3", "index": "index_a_1"}');
                          retval                          
---------------------------------------------------------------------
 { "ok" : true, "nIndexesWas" : { "$numberLong" : "2" } }
(1 row)

CALL documentdb_api.drop_indexes('db1', '{"dropIndexes": "col4", "index": "index_a_1"}');
                          retval                          
---------------------------------------------------------------------
 { "ok" : true, "nIndexesWas" : { "$numberLong" : "2" } }
(1 row)

CALL documentdb_api.drop_indexes('db1', '{"dropIndexes": "col5", "index": "index_a_1"}');
                          retval                          
---------------------------------------------------------------------
 { "ok" : true, "nIndexesWas" : { "$numberLong" : "2" } }
(1 row)

-- "indexes" count should be back to 5 (one default _id index in each collection), "indexSize" should decrease
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                            db_stats                                                                                                                                                                                                                                            
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "5" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "100" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "614400.0" }, "storageSize" : { "$numberDouble" : "614400.0" }, "indexes" : { "$numberLong" : "5" }, "indexSize" : { "$numberDouble" : "1269760.0" }, "totalSize" : { "$numberDouble" : "1884160.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

--===================== Test with Views =====================================--
-- create a view on a collection
SELECT documentdb_api.create_collection_view('db1', '{ "create": "col1_view1", "viewOn": "col1" }');
         create_collection_view         
---------------------------------------------------------------------
 { "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- "views" should be 1
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                            db_stats                                                                                                                                                                                                                                            
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "5" }, "views" : { "$numberLong" : "1" }, "objects" : { "$numberLong" : "100" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "614400.0" }, "storageSize" : { "$numberDouble" : "614400.0" }, "indexes" : { "$numberLong" : "5" }, "indexSize" : { "$numberDouble" : "1269760.0" }, "totalSize" : { "$numberDouble" : "1884160.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- create one view on each remaining collection
SELECT documentdb_api.create_collection_view('db1', '{ "create": "col2_view1", "viewOn": "col2" }');
         create_collection_view         
---------------------------------------------------------------------
 { "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.create_collection_view('db1', '{ "create": "col3_view1", "viewOn": "col3" }');
         create_collection_view         
---------------------------------------------------------------------
 { "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.create_collection_view('db1', '{ "create": "col4_view1", "viewOn": "col4" }');
         create_collection_view         
---------------------------------------------------------------------
 { "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.create_collection_view('db1', '{ "create": "col5_view1", "viewOn": "col5" }');
         create_collection_view         
---------------------------------------------------------------------
 { "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- "views" should be 5
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                            db_stats                                                                                                                                                                                                                                            
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "5" }, "views" : { "$numberLong" : "5" }, "objects" : { "$numberLong" : "100" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "614400.0" }, "storageSize" : { "$numberDouble" : "614400.0" }, "indexes" : { "$numberLong" : "5" }, "indexSize" : { "$numberDouble" : "1269760.0" }, "totalSize" : { "$numberDouble" : "1884160.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Drop one collection (despite a view on it)
SELECT documentdb_api.drop_collection('db1', 'col5');
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

-- In this test we cannot wait till Autovaccum nap time is over, so we manually trigger the ANALYZE
ANALYZE;
-- "collections" should be 4, and "objects" will reduce
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                           db_stats                                                                                                                                                                                                                                           
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "4" }, "views" : { "$numberLong" : "5" }, "objects" : { "$numberLong" : "80" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "2400.0" }, "storageSize" : { "$numberDouble" : "491520.0" }, "indexes" : { "$numberLong" : "4" }, "indexSize" : { "$numberDouble" : "1015808.0" }, "totalSize" : { "$numberDouble" : "1507328.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Drop one view
SELECT documentdb_api.drop_collection('db1', 'col5_view1');
NOTICE:  table "documents_6310" does not exist, skipping
NOTICE:  table "retry_6310" does not exist, skipping
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

-- "views" should be 4
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                           db_stats                                                                                                                                                                                                                                           
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "4" }, "views" : { "$numberLong" : "4" }, "objects" : { "$numberLong" : "80" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "2400.0" }, "storageSize" : { "$numberDouble" : "491520.0" }, "indexes" : { "$numberLong" : "4" }, "indexSize" : { "$numberDouble" : "1015808.0" }, "totalSize" : { "$numberDouble" : "1507328.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Drop all remaining collections
SELECT documentdb_api.drop_collection('db1', 'col1');
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.drop_collection('db1', 'col2');
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.drop_collection('db1', 'col3');
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.drop_collection('db1', 'col4');
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

-- Only "views" and fs stats should be available, rest all should be zero values.
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                db_stats                                                                                                                                                                                                                                
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "0" }, "views" : { "$numberLong" : "4" }, "objects" : { "$numberLong" : "0" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "0.0" }, "storageSize" : { "$numberDouble" : "0.0" }, "indexes" : { "$numberLong" : "0" }, "indexSize" : { "$numberDouble" : "0.0" }, "totalSize" : { "$numberDouble" : "0.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

--===================== Test with another database =============================--
-- Make sure this new database does not exist
SELECT documentdb_api.drop_database('db2');
 drop_database 
---------------------------------------------------------------------
 
(1 row)

-- Add one document
SELECT documentdb_api.insert_one('db2','col1',' { "a" : 100 }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- In this test we cannot wait till Autovaccum nap time is over, so we manually trigger the ANALYZE
ANALYZE;
-- various stats should be available
SELECT documentdb_api.db_stats('db2');
                                                                                                                                                                                                                                       db_stats                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 { "db" : "db2", "collections" : { "$numberLong" : "1" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "1" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "30.0" }, "storageSize" : { "$numberDouble" : "16384.0" }, "indexes" : { "$numberLong" : "1" }, "indexSize" : { "$numberDouble" : "16384.0" }, "totalSize" : { "$numberDouble" : "32768.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

--===================== Test for "scale" Values =============================--
SELECT documentdb_api.db_stats('db2', 1);
                                                                                                                                                                                                                                       db_stats                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 { "db" : "db2", "collections" : { "$numberLong" : "1" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "1" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "30.0" }, "storageSize" : { "$numberDouble" : "16384.0" }, "indexes" : { "$numberLong" : "1" }, "indexSize" : { "$numberDouble" : "16384.0" }, "totalSize" : { "$numberDouble" : "32768.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api.db_stats('db2', 2);
                                                                                                                                                                                                                                      db_stats                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 { "db" : "db2", "collections" : { "$numberLong" : "1" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "1" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "15.0" }, "storageSize" : { "$numberDouble" : "8192.0" }, "indexes" : { "$numberLong" : "1" }, "indexSize" : { "$numberDouble" : "8192.0" }, "totalSize" : { "$numberDouble" : "16384.0" }, "scaleFactor" : { "$numberInt" : "2" }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api.db_stats('db2', 2.5);
                                                                                                                                                                                                                                      db_stats                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 { "db" : "db2", "collections" : { "$numberLong" : "1" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "1" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "15.0" }, "storageSize" : { "$numberDouble" : "8192.0" }, "indexes" : { "$numberLong" : "1" }, "indexSize" : { "$numberDouble" : "8192.0" }, "totalSize" : { "$numberDouble" : "16384.0" }, "scaleFactor" : { "$numberInt" : "2" }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api.db_stats('db2', 2.99);
                                                                                                                                                                                                                                      db_stats                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 { "db" : "db2", "collections" : { "$numberLong" : "1" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "1" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "15.0" }, "storageSize" : { "$numberDouble" : "8192.0" }, "indexes" : { "$numberLong" : "1" }, "indexSize" : { "$numberDouble" : "8192.0" }, "totalSize" : { "$numberDouble" : "16384.0" }, "scaleFactor" : { "$numberInt" : "2" }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api.db_stats('db2', 100);
                                                                                                                                                                                                                                                                     db_stats                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 { "db" : "db2", "collections" : { "$numberLong" : "1" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "1" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "0.2999999999999999889" }, "storageSize" : { "$numberDouble" : "163.84000000000000341" }, "indexes" : { "$numberLong" : "1" }, "indexSize" : { "$numberDouble" : "163.84000000000000341" }, "totalSize" : { "$numberDouble" : "327.68000000000000682" }, "scaleFactor" : { "$numberInt" : "100" }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api.db_stats('db2', 1024.99);
                                                                                                                                                                                                                                       db_stats                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 { "db" : "db2", "collections" : { "$numberLong" : "1" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "1" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "0.029296875" }, "storageSize" : { "$numberDouble" : "16.0" }, "indexes" : { "$numberLong" : "1" }, "indexSize" : { "$numberDouble" : "16.0" }, "totalSize" : { "$numberDouble" : "32.0" }, "scaleFactor" : { "$numberInt" : "1024" }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api.db_stats('db2', 2147483647);      -- INT_MAX
                                                                                                                                                                                                                                                                                 db_stats                                                                                                                                                                                                                                                                                 
---------------------------------------------------------------------
 { "db" : "db2", "collections" : { "$numberLong" : "1" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "1" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "1.3969838625737390769e-08" }, "storageSize" : { "$numberDouble" : "7.6293945348027136788e-06" }, "indexes" : { "$numberLong" : "1" }, "indexSize" : { "$numberDouble" : "7.6293945348027136788e-06" }, "totalSize" : { "$numberDouble" : "1.5258789069605427358e-05" }, "scaleFactor" : { "$numberInt" : "2147483647" }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api.db_stats('db2', 2147483647000);   -- More than INT_MAX
                                                                                                                                                                                                                                                                                 db_stats                                                                                                                                                                                                                                                                                 
---------------------------------------------------------------------
 { "db" : "db2", "collections" : { "$numberLong" : "1" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "1" }, "avgObjSize" : { "$numberDouble" : "30.0" }, "dataSize" : { "$numberDouble" : "1.3969838625737390769e-08" }, "storageSize" : { "$numberDouble" : "7.6293945348027136788e-06" }, "indexes" : { "$numberLong" : "1" }, "indexSize" : { "$numberDouble" : "7.6293945348027136788e-06" }, "totalSize" : { "$numberDouble" : "1.5258789069605427358e-05" }, "scaleFactor" : { "$numberInt" : "2147483647" }, "ok" : { "$numberInt" : "1" } }
(1 row)

--===================== ERROR Cases =============================--
SELECT documentdb_api.db_stats('db2', 0);
ERROR:  scale has to be > 0
SELECT documentdb_api.db_stats('db2', 0.99);
ERROR:  scale has to be > 0
SELECT documentdb_api.db_stats('db2', -0.2);
ERROR:  scale has to be > 0
SELECT documentdb_api.db_stats('db2', -2);
ERROR:  scale has to be > 0
SELECT documentdb_api.db_stats('db2', -2147483648);      -- INT_MIN
ERROR:  scale has to be > 0
SELECT documentdb_api.db_stats('db2', -2147483647000);   -- Less than INT_MIN
ERROR:  scale has to be > 0
--======================== Clean Up =============================--
SET client_min_messages TO WARNING;
-- Clean up
SELECT documentdb_api.drop_database('db1');
 drop_database 
---------------------------------------------------------------------
 
(1 row)

-- Should return Zero values for non-existing collection (except of fs stats)
SELECT documentdb_api.db_stats('db1');
                                                                                                                                                                                                                                db_stats                                                                                                                                                                                                                                
---------------------------------------------------------------------
 { "db" : "db1", "collections" : { "$numberLong" : "0" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "0" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "0.0" }, "storageSize" : { "$numberDouble" : "0.0" }, "indexes" : { "$numberLong" : "0" }, "indexSize" : { "$numberDouble" : "0.0" }, "totalSize" : { "$numberDouble" : "0.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Clean up
SELECT documentdb_api.drop_database('db2');
 drop_database 
---------------------------------------------------------------------
 
(1 row)

-- Should return Zero values for non-existing collection (except of fs stats)
SELECT documentdb_api.db_stats('db2');
                                                                                                                                                                                                                                db_stats                                                                                                                                                                                                                                
---------------------------------------------------------------------
 { "db" : "db2", "collections" : { "$numberLong" : "0" }, "views" : { "$numberLong" : "0" }, "objects" : { "$numberLong" : "0" }, "avgObjSize" : { "$numberDouble" : "0.0" }, "dataSize" : { "$numberDouble" : "0.0" }, "storageSize" : { "$numberDouble" : "0.0" }, "indexes" : { "$numberLong" : "0" }, "indexSize" : { "$numberDouble" : "0.0" }, "totalSize" : { "$numberDouble" : "0.0" }, "scaleFactor" : { "$numberInt" : "1" }, "ok" : { "$numberInt" : "1" } }
(1 row)

SET client_min_messages TO DEFAULT;
