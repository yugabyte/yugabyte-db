SET search_path TO documentdb_core,documentdb_api,documentdb_api_catalog,documentdb_api_internal;
SET citus.next_shard_id TO 912000;
SET documentdb.next_collection_id TO 9120;
SET documentdb.next_collection_index_id TO 9120;
SELECT documentdb_api.insert_one('db', 'graph_lookup_employees', '{ "_id" : 1, "name" : "Dev" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graph_lookup_employees', '{ "_id" : 2, "name" : "Eliot", "reportsTo" : "Dev" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graph_lookup_employees', '{ "_id" : 3, "name" : "Ron", "reportsTo" : "Eliot" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graph_lookup_employees', '{ "_id" : 4, "name" : "Andrew", "reportsTo" : "Eliot" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graph_lookup_employees', '{ "_id" : 5, "name" : "Asya", "reportsTo" : "Ron" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graph_lookup_employees', '{ "_id" : 6, "name" : "Dan", "reportsTo" : "Andrew" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graph_lookup_employees", "pipeline": [ { "$graphLookup": { "from": "graph_lookup_employees", "startWith": "$reportsTo", "connectFromField": "reportsTo", "connectToField": "name", "as": "reportingHierarchy" } } ]}');
                                                                                                                                                      document                                                                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "Dev", "reportingHierarchy" : [  ] }
 { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" } ] }
 { "_id" : { "$numberInt" : "3" }, "name" : "Ron", "reportsTo" : "Eliot", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" } ] }
 { "_id" : { "$numberInt" : "4" }, "name" : "Andrew", "reportsTo" : "Eliot", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" } ] }
 { "_id" : { "$numberInt" : "5" }, "name" : "Asya", "reportsTo" : "Ron", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" }, { "_id" : { "$numberInt" : "3" }, "name" : "Ron", "reportsTo" : "Eliot" } ] }
 { "_id" : { "$numberInt" : "6" }, "name" : "Dan", "reportsTo" : "Andrew", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" }, { "_id" : { "$numberInt" : "4" }, "name" : "Andrew", "reportsTo" : "Eliot" } ] }
(6 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graph_lookup_employees", "pipeline": [ { "$graphLookup": { "from": "graph_lookup_employees", "startWith": "$reportsTo", "connectFromField": "reportsTo", "connectToField": "name", "as": "reportingHierarchy" } } ]}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(document, "addFields") AS document FROM (SELECT "graphLookupBase_stage_1".document, COALESCE((SELECT COALESCE(documentdb_api_catalog.bson_array_agg(agg_stage_sub_1_0.document, 'reportingHierarchy'::text), '{ "reportingHierarchy" : [  ] }'::documentdb_core.bson) AS document FROM (WITH RECURSIVE "graphLookupRecurseStage" AS (SELECT "*TLOCRN*".document, "*TLOCRN*".depth, "*TLOCRN*"."baseDocId", false AS is_cycle, ARRAY[ROW("*TLOCRN*"."baseDocId")] AS path FROM (SELECT collection_0_2.document, '{ "depth" : { "$numberInt" : "0" } }'::documentdb_core.bson AS depth, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson) AS "baseDocId" FROM documentdb_data.documents_9120_912000 collection_0_2 WHERE ((collection_0_2.shard_key_value OPERATOR(pg_catalog.=) '9120'::bigint) AND documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, "graphLookupBase_stage_1"."inputExpr", 'name'::text))) "*TLOCRN*"(document, depth, "baseDocId") UNION ALL SELECT "*TROCRN*".document, "*TROCRN*".depth, "*TROCRN*"."baseDocId", CASE WHEN (ROW("*TROCRN*"."baseDocId") OPERATOR(pg_catalog.=) ANY ("*TROCRN*".path)) THEN true ELSE false END AS is_cycle, array_cat("*TROCRN*".path, ARRAY[ROW("*TROCRN*"."baseDocId")]) AS path FROM (SELECT collection_0_2.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "depth" : { "$add" : [ "$depth", { "$numberInt" : "1" } ] } }'::documentdb_core.bson) AS depth, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson) AS "baseDocId", "lookupRecursive_stage_1".is_cycle, "lookupRecursive_stage_1".path FROM documentdb_data.documents_9120_912000 collection_0_2, "graphLookupRecurseStage" "lookupRecursive_stage_1" WHERE ((collection_0_2.shard_key_value OPERATOR(pg_catalog.=) '9120'::bigint) AND documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "name" : { "$makeArray" : "$reportsTo" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), 'name'::text))) "*TROCRN*"(document, depth, "baseDocId", is_cycle, path) WHERE ("*TROCRN*".is_cycle OPERATOR(pg_catalog.<>) true)) SELECT DISTINCT ON ("graphLookup_stage_2"."baseDocId") "graphLookup_stage_2".document FROM "graphLookupRecurseStage" "graphLookup_stage_2" ORDER BY "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth) agg_stage_sub_1_0), '{ "reportingHierarchy" : [  ] }'::documentdb_core.bson) AS "addFields" FROM (SELECT collection.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "name" : { "$makeArray" : "$reportsTo" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson) AS "inputExpr" FROM documentdb_data.documents_9120_912000 collection WHERE (collection.shard_key_value OPERATOR(pg_catalog.=) '9120'::bigint)) "graphLookupBase_stage_1") "graphLookup_stage_1"
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_9120_912000 collection
               Output: documentdb_api_internal.bson_dollar_merge_documents(collection.document, COALESCE((SubPlan 2), '{ "reportingHierarchy" : [  ] }'::documentdb_core.bson))
               Recheck Cond: (collection.shard_key_value = '9120'::bigint)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '9120'::bigint)
               SubPlan 2
                 ->  Aggregate
                       Output: COALESCE(documentdb_api_catalog.bson_array_agg("graphLookup_stage_2".document, 'reportingHierarchy'::text), '{ "reportingHierarchy" : [  ] }'::documentdb_core.bson)
                       ->  Unique
                             Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                             CTE graphLookupRecurseStage
                               ->  Recursive Union
                                     ->  Bitmap Heap Scan on documentdb_data.documents_9120_912000 collection_0_2
                                           Output: collection_0_2.document, '{ "depth" : { "$numberInt" : "0" } }'::documentdb_core.bson, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false), false, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false))]
                                           Recheck Cond: (collection_0_2.shard_key_value = '9120'::bigint)
                                           Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "name" : { "$makeArray" : "$reportsTo" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), 'name'::text)
                                           ->  Bitmap Index Scan on _id_
                                                 Index Cond: (collection_0_2.shard_key_value = '9120'::bigint)
                                     ->  Nested Loop
                                           Output: collection_0_2_1.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "depth" : { "$add" : [ "$depth", { "$numberInt" : "1" } ] } }'::documentdb_core.bson), documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false), CASE WHEN (ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false)) = ANY ("lookupRecursive_stage_1".path)) THEN true ELSE false END, array_cat("lookupRecursive_stage_1".path, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false))])
                                           Join Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2_1.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "name" : { "$makeArray" : "$reportsTo" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), 'name'::text)
                                           ->  WorkTable Scan on "graphLookupRecurseStage" "lookupRecursive_stage_1"
                                                 Output: "lookupRecursive_stage_1".document, "lookupRecursive_stage_1".depth, "lookupRecursive_stage_1"."baseDocId", "lookupRecursive_stage_1".is_cycle, "lookupRecursive_stage_1".path
                                                 Filter: (NOT "lookupRecursive_stage_1".is_cycle)
                                           ->  Materialize
                                                 Output: collection_0_2_1.document
                                                 ->  Bitmap Heap Scan on documentdb_data.documents_9120_912000 collection_0_2_1
                                                       Output: collection_0_2_1.document
                                                       Recheck Cond: (collection_0_2_1.shard_key_value = '9120'::bigint)
                                                       ->  Bitmap Index Scan on _id_
                                                             Index Cond: (collection_0_2_1.shard_key_value = '9120'::bigint)
                             ->  Sort
                                   Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                                   Sort Key: "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                                   ->  CTE Scan on "graphLookupRecurseStage" "graphLookup_stage_2"
                                         Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
(43 rows)

SELECT documentdb_api.insert_one('db', 'graph_lookup_airports', '{ "_id" : 0, "airport" : "JFK", "connects" : [ "BOS", "ORD" ] }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graph_lookup_airports', '{ "_id" : 1, "airport" : "BOS", "connects" : [ "JFK", "PWM" ] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graph_lookup_airports', '{ "_id" : 2, "airport" : "ORD", "connects" : [ "JFK" ] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graph_lookup_airports', '{ "_id" : 3, "airport" : "PWM", "connects" : [ "BOS", "LHR" ] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graph_lookup_airports', '{ "_id" : 4, "airport" : "LHR", "connects" : [ "PWM" ] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graph_lookup_travelers', '{ "_id" : 1, "name" : "Dev", "nearestAirport" : "JFK" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graph_lookup_travelers', '{ "_id" : 2, "name" : "Eliot", "nearestAirport" : "JFK" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graph_lookup_travelers', '{ "_id" : 3, "name" : "Jeff", "nearestAirport" : "BOS" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graph_lookup_travelers", "pipeline": [ { "$graphLookup": { "from": "graph_lookup_airports", "startWith": "$nearestAirport", "connectFromField": "connects", "connectToField": "airport", "as": "destinations", "maxDepth": 2 } } ]}');
                                                                                                                                                                                                                                                              document                                                                                                                                                                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "Dev", "nearestAirport" : "JFK", "destinations" : [ { "_id" : { "$numberInt" : "0" }, "airport" : "JFK", "connects" : [ "BOS", "ORD" ] }, { "_id" : { "$numberInt" : "1" }, "airport" : "BOS", "connects" : [ "JFK", "PWM" ] }, { "_id" : { "$numberInt" : "2" }, "airport" : "ORD", "connects" : [ "JFK" ] }, { "_id" : { "$numberInt" : "3" }, "airport" : "PWM", "connects" : [ "BOS", "LHR" ] } ] }
 { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "nearestAirport" : "JFK", "destinations" : [ { "_id" : { "$numberInt" : "0" }, "airport" : "JFK", "connects" : [ "BOS", "ORD" ] }, { "_id" : { "$numberInt" : "1" }, "airport" : "BOS", "connects" : [ "JFK", "PWM" ] }, { "_id" : { "$numberInt" : "2" }, "airport" : "ORD", "connects" : [ "JFK" ] }, { "_id" : { "$numberInt" : "3" }, "airport" : "PWM", "connects" : [ "BOS", "LHR" ] } ] }
 { "_id" : { "$numberInt" : "3" }, "name" : "Jeff", "nearestAirport" : "BOS", "destinations" : [ { "_id" : { "$numberInt" : "0" }, "airport" : "JFK", "connects" : [ "BOS", "ORD" ] }, { "_id" : { "$numberInt" : "1" }, "airport" : "BOS", "connects" : [ "JFK", "PWM" ] }, { "_id" : { "$numberInt" : "2" }, "airport" : "ORD", "connects" : [ "JFK" ] }, { "_id" : { "$numberInt" : "3" }, "airport" : "PWM", "connects" : [ "BOS", "LHR" ] }, { "_id" : { "$numberInt" : "4" }, "airport" : "LHR", "connects" : [ "PWM" ] } ] }
(3 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graph_lookup_travelers", "pipeline": [ { "$graphLookup": { "from": "graph_lookup_airports", "startWith": "$nearestAirport", "connectFromField": "connects", "connectToField": "airport", "as": "destinations", "maxDepth": 2 } } ]}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(document, "addFields") AS document FROM (SELECT "graphLookupBase_stage_1".document, COALESCE((SELECT COALESCE(documentdb_api_catalog.bson_array_agg(agg_stage_sub_1_0.document, 'destinations'::text), '{ "destinations" : [  ] }'::documentdb_core.bson) AS document FROM (WITH RECURSIVE "graphLookupRecurseStage" AS (SELECT "*TLOCRN*".document, "*TLOCRN*".depth, "*TLOCRN*"."baseDocId", false AS is_cycle, ARRAY[ROW("*TLOCRN*"."baseDocId")] AS path FROM (SELECT collection_0_2.document, '{ "depth" : { "$numberInt" : "0" } }'::documentdb_core.bson AS depth, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson) AS "baseDocId" FROM documentdb_data.documents_9121_912019 collection_0_2 WHERE ((collection_0_2.shard_key_value OPERATOR(pg_catalog.=) '9121'::bigint) AND documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, "graphLookupBase_stage_1"."inputExpr", 'airport'::text))) "*TLOCRN*"(document, depth, "baseDocId") UNION ALL SELECT "*TROCRN*".document, "*TROCRN*".depth, "*TROCRN*"."baseDocId", CASE WHEN (ROW("*TROCRN*"."baseDocId") OPERATOR(pg_catalog.=) ANY ("*TROCRN*".path)) THEN true ELSE false END AS is_cycle, array_cat("*TROCRN*".path, ARRAY[ROW("*TROCRN*"."baseDocId")]) AS path FROM (SELECT collection_0_2.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "depth" : { "$add" : [ "$depth", { "$numberInt" : "1" } ] } }'::documentdb_core.bson) AS depth, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson) AS "baseDocId", "lookupRecursive_stage_1".is_cycle, "lookupRecursive_stage_1".path FROM documentdb_data.documents_9121_912019 collection_0_2, "graphLookupRecurseStage" "lookupRecursive_stage_1" WHERE ((collection_0_2.shard_key_value OPERATOR(pg_catalog.=) '9121'::bigint) AND documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "airport" : { "$makeArray" : "$connects" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), 'airport'::text) AND ("lookupRecursive_stage_1".depth OPERATOR(documentdb_api_catalog.#<) '{ "depth" : { "$numberInt" : "2" } }'::documentdb_core.bsonquery))) "*TROCRN*"(document, depth, "baseDocId", is_cycle, path) WHERE ("*TROCRN*".is_cycle OPERATOR(pg_catalog.<>) true)) SELECT DISTINCT ON ("graphLookup_stage_2"."baseDocId") "graphLookup_stage_2".document FROM "graphLookupRecurseStage" "graphLookup_stage_2" ORDER BY "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth) agg_stage_sub_1_0), '{ "destinations" : [  ] }'::documentdb_core.bson) AS "addFields" FROM (SELECT collection.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "airport" : { "$makeArray" : "$nearestAirport" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson) AS "inputExpr" FROM documentdb_data.documents_9122_912038 collection WHERE (collection.shard_key_value OPERATOR(pg_catalog.=) '9122'::bigint)) "graphLookupBase_stage_1") "graphLookup_stage_1"
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_9122_912038 collection
               Output: documentdb_api_internal.bson_dollar_merge_documents(collection.document, COALESCE((SubPlan 2), '{ "destinations" : [  ] }'::documentdb_core.bson))
               Recheck Cond: (collection.shard_key_value = '9122'::bigint)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '9122'::bigint)
               SubPlan 2
                 ->  Aggregate
                       Output: COALESCE(documentdb_api_catalog.bson_array_agg("graphLookup_stage_2".document, 'destinations'::text), '{ "destinations" : [  ] }'::documentdb_core.bson)
                       ->  Unique
                             Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                             CTE graphLookupRecurseStage
                               ->  Recursive Union
                                     ->  Bitmap Heap Scan on documentdb_data.documents_9121_912019 collection_0_2
                                           Output: collection_0_2.document, '{ "depth" : { "$numberInt" : "0" } }'::documentdb_core.bson, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false), false, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false))]
                                           Recheck Cond: (collection_0_2.shard_key_value = '9121'::bigint)
                                           Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "airport" : { "$makeArray" : "$nearestAirport" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), 'airport'::text)
                                           ->  Bitmap Index Scan on _id_
                                                 Index Cond: (collection_0_2.shard_key_value = '9121'::bigint)
                                     ->  Nested Loop
                                           Output: collection_0_2_1.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "depth" : { "$add" : [ "$depth", { "$numberInt" : "1" } ] } }'::documentdb_core.bson), documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false), CASE WHEN (ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false)) = ANY ("lookupRecursive_stage_1".path)) THEN true ELSE false END, array_cat("lookupRecursive_stage_1".path, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false))])
                                           Join Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2_1.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "airport" : { "$makeArray" : "$connects" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), 'airport'::text)
                                           ->  WorkTable Scan on "graphLookupRecurseStage" "lookupRecursive_stage_1"
                                                 Output: "lookupRecursive_stage_1".document, "lookupRecursive_stage_1".depth, "lookupRecursive_stage_1"."baseDocId", "lookupRecursive_stage_1".is_cycle, "lookupRecursive_stage_1".path
                                                 Filter: ((NOT "lookupRecursive_stage_1".is_cycle) AND ("lookupRecursive_stage_1".depth OPERATOR(documentdb_api_catalog.#<) '{ "depth" : { "$numberInt" : "2" } }'::documentdb_core.bsonquery))
                                           ->  Materialize
                                                 Output: collection_0_2_1.document
                                                 ->  Bitmap Heap Scan on documentdb_data.documents_9121_912019 collection_0_2_1
                                                       Output: collection_0_2_1.document
                                                       Recheck Cond: (collection_0_2_1.shard_key_value = '9121'::bigint)
                                                       ->  Bitmap Index Scan on _id_
                                                             Index Cond: (collection_0_2_1.shard_key_value = '9121'::bigint)
                             ->  Sort
                                   Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                                   Sort Key: "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                                   ->  CTE Scan on "graphLookupRecurseStage" "graphLookup_stage_2"
                                         Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
(43 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graph_lookup_travelers", "pipeline": [ { "$graphLookup": { "from": "graph_lookup_airports", "startWith": "$nearestAirport", "connectFromField": "connects", "connectToField": "airport", "as": "destinations", "depthField": "depth" } } ]}');
                                                                                                                                                                                                                                                                                                                                                   document                                                                                                                                                                                                                                                                                                                                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "Dev", "nearestAirport" : "JFK", "destinations" : [ { "_id" : { "$numberInt" : "0" }, "airport" : "JFK", "connects" : [ "BOS", "ORD" ], "depth" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "1" }, "airport" : "BOS", "connects" : [ "JFK", "PWM" ], "depth" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "2" }, "airport" : "ORD", "connects" : [ "JFK" ], "depth" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "3" }, "airport" : "PWM", "connects" : [ "BOS", "LHR" ], "depth" : { "$numberInt" : "2" } }, { "_id" : { "$numberInt" : "4" }, "airport" : "LHR", "connects" : [ "PWM" ], "depth" : { "$numberInt" : "3" } } ] }
 { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "nearestAirport" : "JFK", "destinations" : [ { "_id" : { "$numberInt" : "0" }, "airport" : "JFK", "connects" : [ "BOS", "ORD" ], "depth" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "1" }, "airport" : "BOS", "connects" : [ "JFK", "PWM" ], "depth" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "2" }, "airport" : "ORD", "connects" : [ "JFK" ], "depth" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "3" }, "airport" : "PWM", "connects" : [ "BOS", "LHR" ], "depth" : { "$numberInt" : "2" } }, { "_id" : { "$numberInt" : "4" }, "airport" : "LHR", "connects" : [ "PWM" ], "depth" : { "$numberInt" : "3" } } ] }
 { "_id" : { "$numberInt" : "3" }, "name" : "Jeff", "nearestAirport" : "BOS", "destinations" : [ { "_id" : { "$numberInt" : "0" }, "airport" : "JFK", "connects" : [ "BOS", "ORD" ], "depth" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "1" }, "airport" : "BOS", "connects" : [ "JFK", "PWM" ], "depth" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "2" }, "airport" : "ORD", "connects" : [ "JFK" ], "depth" : { "$numberInt" : "2" } }, { "_id" : { "$numberInt" : "3" }, "airport" : "PWM", "connects" : [ "BOS", "LHR" ], "depth" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "4" }, "airport" : "LHR", "connects" : [ "PWM" ], "depth" : { "$numberInt" : "2" } } ] }
(3 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graph_lookup_travelers", "pipeline": [ { "$graphLookup": { "from": "graph_lookup_airports", "startWith": "$nearestAirport", "connectFromField": "connects", "connectToField": "airport", "as": "destinations", "depthField": "depth" } } ]}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(document, "addFields") AS document FROM (SELECT "graphLookupBase_stage_1".document, COALESCE((SELECT COALESCE(documentdb_api_catalog.bson_array_agg(agg_stage_sub_1_0.document, 'destinations'::text), '{ "destinations" : [  ] }'::documentdb_core.bson) AS document FROM (WITH RECURSIVE "graphLookupRecurseStage" AS (SELECT "*TLOCRN*".document, "*TLOCRN*".depth, "*TLOCRN*"."baseDocId", false AS is_cycle, ARRAY[ROW("*TLOCRN*"."baseDocId")] AS path FROM (SELECT collection_0_2.document, '{ "depth" : { "$numberInt" : "0" } }'::documentdb_core.bson AS depth, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson) AS "baseDocId" FROM documentdb_data.documents_9121_912019 collection_0_2 WHERE ((collection_0_2.shard_key_value OPERATOR(pg_catalog.=) '9121'::bigint) AND documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, "graphLookupBase_stage_1"."inputExpr", 'airport'::text))) "*TLOCRN*"(document, depth, "baseDocId") UNION ALL SELECT "*TROCRN*".document, "*TROCRN*".depth, "*TROCRN*"."baseDocId", CASE WHEN (ROW("*TROCRN*"."baseDocId") OPERATOR(pg_catalog.=) ANY ("*TROCRN*".path)) THEN true ELSE false END AS is_cycle, array_cat("*TROCRN*".path, ARRAY[ROW("*TROCRN*"."baseDocId")]) AS path FROM (SELECT collection_0_2.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "depth" : { "$add" : [ "$depth", { "$numberInt" : "1" } ] } }'::documentdb_core.bson) AS depth, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson) AS "baseDocId", "lookupRecursive_stage_1".is_cycle, "lookupRecursive_stage_1".path FROM documentdb_data.documents_9121_912019 collection_0_2, "graphLookupRecurseStage" "lookupRecursive_stage_1" WHERE ((collection_0_2.shard_key_value OPERATOR(pg_catalog.=) '9121'::bigint) AND documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "airport" : { "$makeArray" : "$connects" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), 'airport'::text))) "*TROCRN*"(document, depth, "baseDocId", is_cycle, path) WHERE ("*TROCRN*".is_cycle OPERATOR(pg_catalog.<>) true)) SELECT DISTINCT ON ("graphLookup_stage_2"."baseDocId") documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth) AS document FROM "graphLookupRecurseStage" "graphLookup_stage_2" ORDER BY "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth) agg_stage_sub_1_0), '{ "destinations" : [  ] }'::documentdb_core.bson) AS "addFields" FROM (SELECT collection.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "airport" : { "$makeArray" : "$nearestAirport" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson) AS "inputExpr" FROM documentdb_data.documents_9122_912038 collection WHERE (collection.shard_key_value OPERATOR(pg_catalog.=) '9122'::bigint)) "graphLookupBase_stage_1") "graphLookup_stage_1"
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_9122_912038 collection
               Output: documentdb_api_internal.bson_dollar_merge_documents(collection.document, COALESCE((SubPlan 2), '{ "destinations" : [  ] }'::documentdb_core.bson))
               Recheck Cond: (collection.shard_key_value = '9122'::bigint)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '9122'::bigint)
               SubPlan 2
                 ->  Aggregate
                       Output: COALESCE(documentdb_api_catalog.bson_array_agg((documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth)), 'destinations'::text), '{ "destinations" : [  ] }'::documentdb_core.bson)
                       ->  Unique
                             Output: (documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth)), "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                             CTE graphLookupRecurseStage
                               ->  Recursive Union
                                     ->  Bitmap Heap Scan on documentdb_data.documents_9121_912019 collection_0_2
                                           Output: collection_0_2.document, '{ "depth" : { "$numberInt" : "0" } }'::documentdb_core.bson, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false), false, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false))]
                                           Recheck Cond: (collection_0_2.shard_key_value = '9121'::bigint)
                                           Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "airport" : { "$makeArray" : "$nearestAirport" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), 'airport'::text)
                                           ->  Bitmap Index Scan on _id_
                                                 Index Cond: (collection_0_2.shard_key_value = '9121'::bigint)
                                     ->  Nested Loop
                                           Output: collection_0_2_1.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "depth" : { "$add" : [ "$depth", { "$numberInt" : "1" } ] } }'::documentdb_core.bson), documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false), CASE WHEN (ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false)) = ANY ("lookupRecursive_stage_1".path)) THEN true ELSE false END, array_cat("lookupRecursive_stage_1".path, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false))])
                                           Join Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2_1.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "airport" : { "$makeArray" : "$connects" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), 'airport'::text)
                                           ->  WorkTable Scan on "graphLookupRecurseStage" "lookupRecursive_stage_1"
                                                 Output: "lookupRecursive_stage_1".document, "lookupRecursive_stage_1".depth, "lookupRecursive_stage_1"."baseDocId", "lookupRecursive_stage_1".is_cycle, "lookupRecursive_stage_1".path
                                                 Filter: (NOT "lookupRecursive_stage_1".is_cycle)
                                           ->  Materialize
                                                 Output: collection_0_2_1.document
                                                 ->  Bitmap Heap Scan on documentdb_data.documents_9121_912019 collection_0_2_1
                                                       Output: collection_0_2_1.document
                                                       Recheck Cond: (collection_0_2_1.shard_key_value = '9121'::bigint)
                                                       ->  Bitmap Index Scan on _id_
                                                             Index Cond: (collection_0_2_1.shard_key_value = '9121'::bigint)
                             ->  Sort
                                   Output: (documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth)), "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                                   Sort Key: "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                                   ->  CTE Scan on "graphLookupRecurseStage" "graphLookup_stage_2"
                                         Output: documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth), "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
(43 rows)

-- $graphLookup inside $facet
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graph_lookup_employees", "pipeline": [ { "$facet": { "inner": [ { "$graphLookup": { "from": "graph_lookup_employees", "startWith": "$reportsTo", "connectFromField": "reportsTo", "connectToField": "name", "as": "reportingHierarchy" } } ] } } ]}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  document                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "inner" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev", "reportingHierarchy" : [  ] }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" } ] }, { "_id" : { "$numberInt" : "3" }, "name" : "Ron", "reportsTo" : "Eliot", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" } ] }, { "_id" : { "$numberInt" : "4" }, "name" : "Andrew", "reportsTo" : "Eliot", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" } ] }, { "_id" : { "$numberInt" : "5" }, "name" : "Asya", "reportsTo" : "Ron", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" }, { "_id" : { "$numberInt" : "3" }, "name" : "Ron", "reportsTo" : "Eliot" } ] }, { "_id" : { "$numberInt" : "6" }, "name" : "Dan", "reportsTo" : "Andrew", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" }, { "_id" : { "$numberInt" : "4" }, "name" : "Andrew", "reportsTo" : "Eliot" } ] } ] }
(1 row)

-- $graphLookup inside $lookup
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graph_lookup_travelers", "pipeline": [ { "$lookup": { "from": "graph_lookup_employees", "as": "inner", "pipeline": [ { "$graphLookup": { "from": "graph_lookup_employees", "startWith": "$reportsTo", "connectFromField": "reportsTo", "connectToField": "name", "as": "reportingHierarchy" } } ] } } ]}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "Dev", "nearestAirport" : "JFK", "inner" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev", "reportingHierarchy" : [  ] }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" } ] }, { "_id" : { "$numberInt" : "3" }, "name" : "Ron", "reportsTo" : "Eliot", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" } ] }, { "_id" : { "$numberInt" : "4" }, "name" : "Andrew", "reportsTo" : "Eliot", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" } ] }, { "_id" : { "$numberInt" : "5" }, "name" : "Asya", "reportsTo" : "Ron", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" }, { "_id" : { "$numberInt" : "3" }, "name" : "Ron", "reportsTo" : "Eliot" } ] }, { "_id" : { "$numberInt" : "6" }, "name" : "Dan", "reportsTo" : "Andrew", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" }, { "_id" : { "$numberInt" : "4" }, "name" : "Andrew", "reportsTo" : "Eliot" } ] } ] }
 { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "nearestAirport" : "JFK", "inner" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev", "reportingHierarchy" : [  ] }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" } ] }, { "_id" : { "$numberInt" : "3" }, "name" : "Ron", "reportsTo" : "Eliot", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" } ] }, { "_id" : { "$numberInt" : "4" }, "name" : "Andrew", "reportsTo" : "Eliot", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" } ] }, { "_id" : { "$numberInt" : "5" }, "name" : "Asya", "reportsTo" : "Ron", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" }, { "_id" : { "$numberInt" : "3" }, "name" : "Ron", "reportsTo" : "Eliot" } ] }, { "_id" : { "$numberInt" : "6" }, "name" : "Dan", "reportsTo" : "Andrew", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" }, { "_id" : { "$numberInt" : "4" }, "name" : "Andrew", "reportsTo" : "Eliot" } ] } ] }
 { "_id" : { "$numberInt" : "3" }, "name" : "Jeff", "nearestAirport" : "BOS", "inner" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev", "reportingHierarchy" : [  ] }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" } ] }, { "_id" : { "$numberInt" : "3" }, "name" : "Ron", "reportsTo" : "Eliot", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" } ] }, { "_id" : { "$numberInt" : "4" }, "name" : "Andrew", "reportsTo" : "Eliot", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" } ] }, { "_id" : { "$numberInt" : "5" }, "name" : "Asya", "reportsTo" : "Ron", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" }, { "_id" : { "$numberInt" : "3" }, "name" : "Ron", "reportsTo" : "Eliot" } ] }, { "_id" : { "$numberInt" : "6" }, "name" : "Dan", "reportsTo" : "Andrew", "reportingHierarchy" : [ { "_id" : { "$numberInt" : "1" }, "name" : "Dev" }, { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "reportsTo" : "Dev" }, { "_id" : { "$numberInt" : "4" }, "name" : "Andrew", "reportsTo" : "Eliot" } ] } ] }
(3 rows)

-- source can be sharded
SELECT documentdb_api.shard_collection('db', 'graph_lookup_travelers', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graph_lookup_travelers", "pipeline": [ { "$graphLookup": { "from": "graph_lookup_airports", "startWith": "$nearestAirport", "connectFromField": "connects", "connectToField": "airport", "as": "destinations", "maxDepth": 2 } } ]}');
                                                                                                                                                                                                                                                              document                                                                                                                                                                                                                                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "name" : "Eliot", "nearestAirport" : "JFK", "destinations" : [ { "_id" : { "$numberInt" : "0" }, "airport" : "JFK", "connects" : [ "BOS", "ORD" ] }, { "_id" : { "$numberInt" : "1" }, "airport" : "BOS", "connects" : [ "JFK", "PWM" ] }, { "_id" : { "$numberInt" : "2" }, "airport" : "ORD", "connects" : [ "JFK" ] }, { "_id" : { "$numberInt" : "3" }, "airport" : "PWM", "connects" : [ "BOS", "LHR" ] } ] }
 { "_id" : { "$numberInt" : "3" }, "name" : "Jeff", "nearestAirport" : "BOS", "destinations" : [ { "_id" : { "$numberInt" : "0" }, "airport" : "JFK", "connects" : [ "BOS", "ORD" ] }, { "_id" : { "$numberInt" : "1" }, "airport" : "BOS", "connects" : [ "JFK", "PWM" ] }, { "_id" : { "$numberInt" : "2" }, "airport" : "ORD", "connects" : [ "JFK" ] }, { "_id" : { "$numberInt" : "3" }, "airport" : "PWM", "connects" : [ "BOS", "LHR" ] }, { "_id" : { "$numberInt" : "4" }, "airport" : "LHR", "connects" : [ "PWM" ] } ] }
 { "_id" : { "$numberInt" : "1" }, "name" : "Dev", "nearestAirport" : "JFK", "destinations" : [ { "_id" : { "$numberInt" : "0" }, "airport" : "JFK", "connects" : [ "BOS", "ORD" ] }, { "_id" : { "$numberInt" : "1" }, "airport" : "BOS", "connects" : [ "JFK", "PWM" ] }, { "_id" : { "$numberInt" : "2" }, "airport" : "ORD", "connects" : [ "JFK" ] }, { "_id" : { "$numberInt" : "3" }, "airport" : "PWM", "connects" : [ "BOS", "LHR" ] } ] }
(3 rows)

-- target cannot be sharded
SELECT documentdb_api.shard_collection('db', 'graph_lookup_airports', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT documentdb_api.shard_collection('db', 'graph_lookup_employees', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graph_lookup_employees", "pipeline": [ { "$graphLookup": { "from": "graph_lookup_employees", "startWith": "$reportsTo", "connectFromField": "reportsTo", "connectToField": "name", "as": "reportingHierarchy" } } ]}');
ERROR:  $graphLookup with 'from' on a sharded collection is not supported
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graph_lookup_travelers", "pipeline": [ { "$graphLookup": { "from": "graph_lookup_airports", "startWith": "$nearestAirport", "connectFromField": "connects", "connectToField": "airport", "as": "destinations", "maxDepth": 2 } } ]}');
ERROR:  $graphLookup with 'from' on a sharded collection is not supported
-- Construct random numeric relationship between 1000 people and 5 hobbies
DO $$
DECLARE i int;
BEGIN
FOR i IN 1..1000 LOOP
PERFORM documentdb_api.insert_one('db', 'people', FORMAT('{ "_id": %s, "name": %s, "friends": [ %s, %s, %s ], "hobbies": [ %s, %s, %s ] }',  i, i, FLOOR(RANDOM() * 10) + 1 , FLOOR(RANDOM() * 10) + 1, FLOOR(RANDOM() * 10) + 1, FLOOR(RANDOM() * 5) + 1, FLOOR(RANDOM() * 5) + 1, FLOOR(RANDOM() * 5) + 1 )::documentdb_core.bson);
END LOOP;
END;
$$;
NOTICE:  creating collection
-- $graphlookup with restrictSearchWithMatch
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "people", "indexes": [{"key": {"name": 1, "hobbies": 1}, "name": "name_1_hobbies_1" }]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

\d+ documentdb_data.documents_9123;
                                       Table "documentdb_data.documents_9123"
     Column      |           Type           | Collation | Nullable | Default | Storage  | Stats target | Description 
---------------------------------------------------------------------
 shard_key_value | bigint                   |           | not null |         | plain    |              | 
 object_id       | bson                     |           | not null |         | extended |              | 
 document        | bson                     |           | not null |         | extended |              | 
 creation_time   | timestamp with time zone |           |          |         | plain    |              | 
Indexes:
    "collection_pk_9123" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_9127" documentdb_rum (document bson_rum_single_path_ops (path=name, tl='2691'), document bson_rum_single_path_ops (path=hobbies, tl='2691'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '9123'::bigint)

ANALYZE documentdb_data.documents_9123;
BEGIN;
SET enable_seqscan TO off;
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "people", "pipeline": [ { "$match": { "name": { "$lte": 50 } } }, { "$graphLookup": { "from": "people", "startWith": "$friends", "connectFromField": "friends", "connectToField": "name", "as": "golfers", "restrictSearchWithMatch": { "hobbies" : { "$lte": 3 } } } }]}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(document, "addFields") AS document FROM (SELECT "graphLookupBase_stage_1".document, COALESCE((SELECT COALESCE(documentdb_api_catalog.bson_array_agg(agg_stage_sub_1_0.document, 'golfers'::text), '{ "golfers" : [  ] }'::documentdb_core.bson) AS document FROM (WITH RECURSIVE "graphLookupRecurseStage" AS (SELECT "*TLOCRN*".document, "*TLOCRN*".depth, "*TLOCRN*"."baseDocId", false AS is_cycle, ARRAY[ROW("*TLOCRN*"."baseDocId")] AS path FROM (SELECT collection_0_2.document, '{ "depth" : { "$numberInt" : "0" } }'::documentdb_core.bson AS depth, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson) AS "baseDocId" FROM documentdb_data.documents_9123_912079 collection_0_2 WHERE ((collection_0_2.document OPERATOR(documentdb_api_catalog.#<=) '{ "hobbies" : { "$numberInt" : "3" } }'::documentdb_core.bsonquery) AND (collection_0_2.shard_key_value OPERATOR(pg_catalog.=) '9123'::bigint) AND documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, "graphLookupBase_stage_1"."inputExpr", 'name'::text))) "*TLOCRN*"(document, depth, "baseDocId") UNION ALL SELECT "*TROCRN*".document, "*TROCRN*".depth, "*TROCRN*"."baseDocId", CASE WHEN (ROW("*TROCRN*"."baseDocId") OPERATOR(pg_catalog.=) ANY ("*TROCRN*".path)) THEN true ELSE false END AS is_cycle, array_cat("*TROCRN*".path, ARRAY[ROW("*TROCRN*"."baseDocId")]) AS path FROM (SELECT collection_0_2.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "depth" : { "$add" : [ "$depth", { "$numberInt" : "1" } ] } }'::documentdb_core.bson) AS depth, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson) AS "baseDocId", "lookupRecursive_stage_1".is_cycle, "lookupRecursive_stage_1".path FROM documentdb_data.documents_9123_912079 collection_0_2, "graphLookupRecurseStage" "lookupRecursive_stage_1" WHERE ((collection_0_2.document OPERATOR(documentdb_api_catalog.#<=) '{ "hobbies" : { "$numberInt" : "3" } }'::documentdb_core.bsonquery) AND (collection_0_2.shard_key_value OPERATOR(pg_catalog.=) '9123'::bigint) AND documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "name" : { "$makeArray" : "$friends" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), 'name'::text))) "*TROCRN*"(document, depth, "baseDocId", is_cycle, path) WHERE ("*TROCRN*".is_cycle OPERATOR(pg_catalog.<>) true)) SELECT DISTINCT ON ("graphLookup_stage_2"."baseDocId") "graphLookup_stage_2".document FROM "graphLookupRecurseStage" "graphLookup_stage_2" ORDER BY "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth) agg_stage_sub_1_0), '{ "golfers" : [  ] }'::documentdb_core.bson) AS "addFields" FROM (SELECT collection.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "name" : { "$makeArray" : "$friends" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson) AS "inputExpr" FROM documentdb_data.documents_9123_912079 collection WHERE ((collection.document OPERATOR(documentdb_api_catalog.#<=) '{ "name" : { "$numberInt" : "50" } }'::documentdb_core.bsonquery) AND (collection.shard_key_value OPERATOR(pg_catalog.=) '9123'::bigint))) "graphLookupBase_stage_1") "graphLookup_stage_1"
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_9123_912079 collection
               Output: documentdb_api_internal.bson_dollar_merge_documents(collection.document, COALESCE((SubPlan 2), '{ "golfers" : [  ] }'::documentdb_core.bson))
               Recheck Cond: (collection.document OPERATOR(documentdb_api_catalog.@<=) '{ "name" : { "$numberInt" : "50" } }'::documentdb_core.bson)
               ->  Bitmap Index Scan on name_1_hobbies_1
                     Index Cond: (collection.document OPERATOR(documentdb_api_catalog.@<=) '{ "name" : { "$numberInt" : "50" } }'::documentdb_core.bson)
               SubPlan 2
                 ->  Aggregate
                       Output: COALESCE(documentdb_api_catalog.bson_array_agg("graphLookup_stage_2".document, 'golfers'::text), '{ "golfers" : [  ] }'::documentdb_core.bson)
                       ->  Unique
                             Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                             CTE graphLookupRecurseStage
                               ->  Recursive Union
                                     ->  Bitmap Heap Scan on documentdb_data.documents_9123_912079 collection_0_2
                                           Output: collection_0_2.document, '{ "depth" : { "$numberInt" : "0" } }'::documentdb_core.bson, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false), false, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false))]
                                           Recheck Cond: (collection_0_2.document OPERATOR(documentdb_api_catalog.@<=) '{ "hobbies" : { "$numberInt" : "3" } }'::documentdb_core.bson)
                                           Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "name" : { "$makeArray" : "$friends" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), 'name'::text)
                                           ->  Bitmap Index Scan on name_1_hobbies_1
                                                 Index Cond: ((collection_0_2.document OPERATOR(documentdb_api_catalog.@*=) documentdb_api_internal.bson_expression_get(collection.document, '{ "name" : { "$makeArray" : "$friends" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)) AND (collection_0_2.document OPERATOR(documentdb_api_catalog.@<=) '{ "hobbies" : { "$numberInt" : "3" } }'::documentdb_core.bson))
                                     ->  Nested Loop
                                           Output: collection_0_2_1.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "depth" : { "$add" : [ "$depth", { "$numberInt" : "1" } ] } }'::documentdb_core.bson), documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false), CASE WHEN (ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false)) = ANY ("lookupRecursive_stage_1".path)) THEN true ELSE false END, array_cat("lookupRecursive_stage_1".path, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false))])
                                           Join Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2_1.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "name" : { "$makeArray" : "$friends" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), 'name'::text)
                                           ->  WorkTable Scan on "graphLookupRecurseStage" "lookupRecursive_stage_1"
                                                 Output: "lookupRecursive_stage_1".document, "lookupRecursive_stage_1".depth, "lookupRecursive_stage_1"."baseDocId", "lookupRecursive_stage_1".is_cycle, "lookupRecursive_stage_1".path
                                                 Filter: (NOT "lookupRecursive_stage_1".is_cycle)
                                           ->  Materialize
                                                 Output: collection_0_2_1.document
                                                 ->  Bitmap Heap Scan on documentdb_data.documents_9123_912079 collection_0_2_1
                                                       Output: collection_0_2_1.document
                                                       Recheck Cond: (documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2_1.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "name" : { "$makeArray" : "$friends" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson), 'name'::text) AND (collection_0_2_1.document OPERATOR(documentdb_api_catalog.@<=) '{ "hobbies" : { "$numberInt" : "3" } }'::documentdb_core.bson))
                                                       ->  Bitmap Index Scan on name_1_hobbies_1
                                                             Index Cond: ((collection_0_2_1.document OPERATOR(documentdb_api_catalog.@*=) documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "name" : { "$makeArray" : "$friends" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson)) AND (collection_0_2_1.document OPERATOR(documentdb_api_catalog.@<=) '{ "hobbies" : { "$numberInt" : "3" } }'::documentdb_core.bson))
                             ->  Sort
                                   Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                                   Sort Key: "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                                   ->  CTE Scan on "graphLookupRecurseStage" "graphLookup_stage_2"
                                         Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
(43 rows)

ROLLBACK;
