SET search_path TO documentdb_api_catalog;
SET documentdb.next_collection_id TO 1800;
SET documentdb.next_collection_index_id TO 1800;
CREATE OR REPLACE FUNCTION generate_auth_message_client_proof(
    p_user_name text,
    p_password text)
RETURNS documentdb_core.bson LANGUAGE C AS 'pg_documentdb', $$command_generate_auth_message_client_proof_for_test$$;
CREATE OR REPLACE FUNCTION generate_server_signature(
    p_user_name text,
    p_password text,
    p_auth_message text)
RETURNS documentdb_core.bson LANGUAGE C AS 'pg_documentdb', $$command_generate_server_signature_for_test$$;
-- TEST SCRAM SHA-256 authentication support functions from extension
--   Test file to test the functions:
--     1. documentdb_api_internal.scram_sha256_get_salt_and_iterations() and 
--     2. documentdb_api_internal.authenticate_with_scram_sha256()
CREATE OR REPLACE FUNCTION test_documentdb_scram_sha256_dual_api(p_user_name text,
															  p_password text)
RETURNS text 
AS $$
DECLARE
    rol_pas            text; -- Role Password from pg_authid table
    iter_ext           text; -- iterations count extracted from shadow password
    salt_ext           text; -- salt extracted from shadow password
    salt_n_iter        text; -- SALT and iterations from scram_sha256_get_salt_and_iterations()
    salt_n_iter_formed text; -- json format text with SALT and iterations formed in this test.
    auth_result        documentdb_core.bson; -- Authentication result.
    cp_n_authmsg       text; -- Client Proof and Auth message from test helper function.
    auth_message       text; -- Auth Message generated by test suite
    client_proof       text;
    result             text;
    serv_sign          text; -- Server signature sent by extension
    serv_sign_gen      text; -- Generated server signature by Test suite.
    auth_result_t      text; -- Scram Authentication result in text type
BEGIN
    -- Get salt and Iterations from Postgres for the provided User name
    SELECT documentdb_api_internal.scram_sha256_get_salt_and_iterations(p_user_name) into salt_n_iter;
    
    select rolpassword into rol_pas from pg_catalog.pg_authid where rolname = p_user_name;

	SELECT substring(rol_pas similar '%SCRAM-SHA-256$#"_+#":_+$_+:%' escape '#') into iter_ext;
	SELECT substring(rol_pas similar '%SCRAM-SHA-256$_+:#"_+#"$_+:%' escape '#') into salt_ext;
	
    salt_n_iter_formed := '{ "ok" : { "$numberInt" : "1" }, "iterations" : { "$numberInt" : "' 
                          || iter_ext || '" }, "salt" : "' || salt_ext || '" }';
	
	-- IF the salt and iterations got from scram_sha256_get_salt_and_iterations is 
	-- not not matching with the extracted ones from the shadow password then return false.
	IF salt_n_iter <> salt_n_iter_formed THEN
        RETURN 'SALT request result mismatch';
    END IF;

    SELECT generate_auth_message_client_proof(p_user_name, p_password) into cp_n_authmsg;

    SELECT substring(cp_n_authmsg similar '%"AuthMessage" : "#"_+#"", "ClientProof"%' escape '#') into auth_message;
    SELECT substring(cp_n_authmsg similar '%"AuthMessage" : "_+", "ClientProof" : "#"_+#""%' escape '#') into client_proof;

    SELECT REPLACE(auth_message, '\"', '"') into auth_message;
    SELECT REPLACE(auth_message, '\\', '\') into auth_message;
    
    SELECT documentdb_api_internal.authenticate_with_scram_sha256(p_user_name, auth_message, client_proof) into auth_result;

    result := auth_result @= '{"ok":1}';

    IF result = 'true' THEN
        SELECT auth_result into auth_result_t;
        SELECT substring(auth_result_t similar '%"ServerSignature" : "#"_+#""%' escape '#') into serv_sign;

        -- Validate Server Signature in auth_result
        --     ServerKey = HMAC(SaltedPassword, "Server Key")
        --     ServerSignature = HMAC(ServerKey, AuthMessage)
        --   This ServerSignature has to be compared against serv_sign (which is received from extension).
        --       If matched, then authentication is success.
        SELECT generate_server_signature(p_user_name, p_password, auth_message) into serv_sign_gen;
        SELECT substring(serv_sign_gen similar '%"ServerSignature" : "#"_+#""%' escape '#') into serv_sign_gen;
              
        IF serv_sign <> serv_sign_gen THEN
            return 'false';
        END IF;
        
    END IF;

    RETURN result;
	
END;
$$ 
LANGUAGE plpgsql;
SET client_min_messages TO ERROR;
CREATE ROLE myuser4      WITH LOGIN PASSWORD '<password_placeholder>';
CREATE ROLE mYuSeR5      WITH LOGIN PASSWORD '<password_placeholder1>';
CREATE ROLE "Myuser6"    WITH LOGIN PASSWORD '<password_placeholder2>';
create role "Fi""roz"    with LOGIN PASSWORD '<password_placeholder3>';
create role "fi""r""oZ"  with LOGIN PASSWORD '<password_placeholder4>';
create role "fi""r""."   with LOGIN PASSWORD '<password_placeholder5>';
create role "fir"""      with LOGIN PASSWORD '<password_placeholder6>';
create role "firo"""""   with LOGIN PASSWORD '<password_placeholder7>';
create role "fi""""ro""" with LOGIN PASSWORD '<password_placeholder8>';
create role "firoz ev"   with LOGIN PASSWORD '<password_placeholder9>';
create role "Fi\troz"    with LOGIN PASSWORD '<password_placeholder10>';
RESET client_min_messages;
-- 1. CALL THE TEST FUNCTION with a valid user name
SELECT test_documentdb_scram_sha256_dual_api('myuser4', '<password_placeholder>');
 test_documentdb_scram_sha256_dual_api 
---------------------------------------
 true
(1 row)

-- 2. CALL THE TEST FUNCTION with a valid user name
SELECT test_documentdb_scram_sha256_dual_api('Myuser6', '<password_placeholder2>');
 test_documentdb_scram_sha256_dual_api 
---------------------------------------
 true
(1 row)

-- 3. CALL scram_sha256_get_salt_and_iterations with null input parameter
SELECT documentdb_api_internal.scram_sha256_get_salt_and_iterations(null);
                         scram_sha256_get_salt_and_iterations                          
---------------------------------------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "iterations" : { "$numberInt" : "0" }, "salt" : "" }
(1 row)

-- 4. CALL scram_sha256_get_salt_and_iterations with empty input parameter
SELECT documentdb_api_internal.scram_sha256_get_salt_and_iterations('');
                         scram_sha256_get_salt_and_iterations                          
---------------------------------------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "iterations" : { "$numberInt" : "0" }, "salt" : "" }
(1 row)

-- 5. CALL scram_sha256_get_salt_and_iterations with non existent user name
SELECT documentdb_api_internal.scram_sha256_get_salt_and_iterations('nonexistent');
                         scram_sha256_get_salt_and_iterations                          
---------------------------------------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "iterations" : { "$numberInt" : "0" }, "salt" : "" }
(1 row)

-- 6. CALL scram_sha256_get_salt_and_iterations with non existent user name with a white space in it
SELECT documentdb_api_internal.scram_sha256_get_salt_and_iterations('white space');
                         scram_sha256_get_salt_and_iterations                          
---------------------------------------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "iterations" : { "$numberInt" : "0" }, "salt" : "" }
(1 row)

-- 7. CALL scram_sha256_get_salt_and_iterations with non existent quoted user name with a white space in it. Note that quoted user name is not supported by this API
SELECT documentdb_api_internal.scram_sha256_get_salt_and_iterations('"white space"');
                         scram_sha256_get_salt_and_iterations                          
---------------------------------------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "iterations" : { "$numberInt" : "0" }, "salt" : "" }
(1 row)

-- 8. CALL scram_sha256_get_salt_and_iterations with non existent user name which is of length more than 64
SELECT documentdb_api_internal.scram_sha256_get_salt_and_iterations('abcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxy');
                         scram_sha256_get_salt_and_iterations                          
---------------------------------------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "iterations" : { "$numberInt" : "0" }, "salt" : "" }
(1 row)

-- 9. FAIL CASE because username is given in lower case but was created with mixed case using double quotes.
SELECT documentdb_api_internal.scram_sha256_get_salt_and_iterations('myuser6');
                         scram_sha256_get_salt_and_iterations                          
---------------------------------------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "iterations" : { "$numberInt" : "0" }, "salt" : "" }
(1 row)

-- 10. FAIL CASE because username is given in upper case but was created with mixed case using double quotes.
SELECT documentdb_api_internal.scram_sha256_get_salt_and_iterations('MYUSER6');
                         scram_sha256_get_salt_and_iterations                          
---------------------------------------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "iterations" : { "$numberInt" : "0" }, "salt" : "" }
(1 row)

SET client_min_messages = LOG;
-- 10.1
SELECT test_documentdb_scram_sha256_dual_api('Fi"roz', '<password_placeholder3>');
 test_documentdb_scram_sha256_dual_api 
---------------------------------------
 true
(1 row)

-- 10.2
SELECT test_documentdb_scram_sha256_dual_api('fi"r"oZ', '<password_placeholder4>');
 test_documentdb_scram_sha256_dual_api 
---------------------------------------
 true
(1 row)

-- 10.3
SELECT test_documentdb_scram_sha256_dual_api('fi"r".', '<password_placeholder5>');
 test_documentdb_scram_sha256_dual_api 
---------------------------------------
 true
(1 row)

-- 10.4
SELECT test_documentdb_scram_sha256_dual_api('fir"', '<password_placeholder6>');
 test_documentdb_scram_sha256_dual_api 
---------------------------------------
 true
(1 row)

-- 10.5
SELECT test_documentdb_scram_sha256_dual_api('firo""', '<password_placeholder7>');
 test_documentdb_scram_sha256_dual_api 
---------------------------------------
 true
(1 row)

-- 10.6
SELECT test_documentdb_scram_sha256_dual_api('fi""ro"', '<password_placeholder8>');
 test_documentdb_scram_sha256_dual_api 
---------------------------------------
 true
(1 row)

-- 10.7
SELECT test_documentdb_scram_sha256_dual_api('firoz ev', '<password_placeholder9>');
 test_documentdb_scram_sha256_dual_api 
---------------------------------------
 true
(1 row)

-- 10.8
SELECT test_documentdb_scram_sha256_dual_api('Fi\troz', '<password_placeholder10>');
 test_documentdb_scram_sha256_dual_api 
---------------------------------------
 true
(1 row)

-- 10.9 Test for incorrect password
SELECT test_documentdb_scram_sha256_dual_api('Fi\troz', '<password_placeholder111>');
LOG:  Client proof verification failed.
 test_documentdb_scram_sha256_dual_api 
---------------------------------------
 false
(1 row)

SET client_min_messages = NOTICE;
-- 11. Checking for case sensitiveness. FULL Lowercase. Real username is mYuSeR5. Expect true
SELECT test_documentdb_scram_sha256_dual_api('myuser5', '<password_placeholder1>');
 test_documentdb_scram_sha256_dual_api 
---------------------------------------
 true
(1 row)

-- 12. Checking for case sensitiveness. FULL Uppercase. Real username is mYuSeR5. Expect false (because PG downcase when username is unquoted)
SELECT test_documentdb_scram_sha256_dual_api('MYUSER5', '<password_placeholder1>');
 test_documentdb_scram_sha256_dual_api 
---------------------------------------
 false
(1 row)

-- 13. Checking for case sensitiveness. Original. Real username is mYuSeR5. Expect false (because PG downcase when username is unquoted)
SELECT test_documentdb_scram_sha256_dual_api('mYuSeR5', '<password_placeholder1>');
 test_documentdb_scram_sha256_dual_api 
---------------------------------------
 false
(1 row)

-- 1. Call with User Name as NULL
SELECT documentdb_api_internal.authenticate_with_scram_sha256(null, 'authmsg', 'client proof');
              authenticate_with_scram_sha256               
-----------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "ServerSignature" : "" }
(1 row)

-- 2. Call with AUTH MESSAGE as NULL
SELECT documentdb_api_internal.authenticate_with_scram_sha256('myuser4', null, 'client proof');
              authenticate_with_scram_sha256               
-----------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "ServerSignature" : "" }
(1 row)

-- 3. Call with User Name, AUTH MESSAGE, CLIENT PROOF as NULL
SELECT documentdb_api_internal.authenticate_with_scram_sha256(null, null, null);
              authenticate_with_scram_sha256               
-----------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "ServerSignature" : "" }
(1 row)

-- 4. Empty user name
SELECT documentdb_api_internal.authenticate_with_scram_sha256('', 'abc', 'defg');
              authenticate_with_scram_sha256               
-----------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "ServerSignature" : "" }
(1 row)

-- 5. Non existent user name
SELECT documentdb_api_internal.authenticate_with_scram_sha256('abc', 'abc', 'defgh');
              authenticate_with_scram_sha256               
-----------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "ServerSignature" : "" }
(1 row)

-- 6. User name > 64
SELECT documentdb_api_internal.authenticate_with_scram_sha256('abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz', 'abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz', 'client proof');
              authenticate_with_scram_sha256               
-----------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "ServerSignature" : "" }
(1 row)

-- 7. Incorrect auth message for a valid user
select documentdb_api_internal.authenticate_with_scram_sha256('myuser4', 'authMsg1', 'clientProof123');
              authenticate_with_scram_sha256               
-----------------------------------------------------------
 { "ok" : { "$numberInt" : "0" }, "ServerSignature" : "" }
(1 row)

-- DROP THE USERS CREATED FOR THE TEST
DROP ROLE myuser4;
DROP ROLE mYuSeR5;
DROP ROLE "Myuser6";
DROP role "Fi""roz";
DROP role "fi""r""oZ";
DROP role "fi""r"".";
DROP role "fir"""      ;
DROP role "firo"""""   ;
DROP role "fi""""ro""" ;
DROP role "firoz ev";
DROP role "Fi\troz";
