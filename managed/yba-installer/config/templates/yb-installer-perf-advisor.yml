services:
  - name: perfAdvisorConfig
    fileName: "{{ .ConfFileLocation }}"
    contents: |
      # Copyright (c) YugabyteDB, Inc.
      # Perf Advisor overrides configuration file
      # This file is generated from pa-ctl.yml configuration

      # Spring Boot Web Resources
      spring.web.resources.static-locations=file://{{ installRoot }}/perf-advisor/ui

      # Spring Boot DataSource Configuration
      spring.datasource.username=postgres
      spring.datasource.url=jdbc:postgresql://localhost:{{ yamlPath "postgres.install.port" }}/ts
      spring.datasource.password={{ yamlPath "postgres.install.password" }}
      spring.profiles.active=api,task-runner,collector

      # Perf Advisor Security Configuration
      pa.security.api.token.secret={{ yamlPath "perfAdvisor.paSecret" }}
      # CORS allowed origins: host(s) and platform support origin URL(s), comma-separated
      pa.security.cors.origin={{ yamlPath "host" }}
      {{- if ne (yamlPath "platform.support_origin_url") "" }}
      {{- ","}}{{ yamlPath "platform.support_origin_url" }}{{ end }}

      # Perf Advisor CallHome Information
      pa.callhome.enabled={{ yamlPath "perfAdvisor.callhome.enabled" }}
      pa.callhome.environment={{ yamlPath "perfAdvisor.callhome.environment" }}
      pa.deployment.type=yba_installer

      # PA Topology Configuration - for writing the PA collected data to Prometheus
      pa.metrics.export.topology={{ baseInstall }}/perf-advisor/config/metrics-export.yml

      # Perf Advisor Prometheus Configuration - reading the data from the prometheus server
      {{ if eq (yamlPath "prometheus.enableHttps") "true" }}
      pa.prometheus.url=https://{{ index (splitInput (yamlPath "host")) 0 }}:
      {{- yamlPath "prometheus.port" }}
      {{ else }}
      pa.prometheus.url=http://{{ index (splitInput (yamlPath "host")) 0 }}:
      {{- yamlPath "prometheus.port" }}
      {{ end }}
      pa.prometheus.username={{ yamlPath "prometheus.authUsername" }}
      pa.prometheus.password={{ yamlPath "prometheus.authPassword" }}

      # Perf Advisor Web Port
      server.port={{ yamlPath "perfAdvisor.port" }}

      # Perf Advisor TLS/SSL Configuration
      {{ if eq (yamlPath "perfAdvisor.tls.enabled") "true" }}
      server.ssl.enabled=true
      server.ssl.key-store-type=PKCS12
      server.ssl.key-store={{ baseInstall }}/perf-advisor/certs/tls.p12
      server.ssl.key-store-password={{ yamlPath "perfAdvisor.tls.keystorePassword" }}
      {{ if ne (yamlPath "perfAdvisor.tls.sslProtocols") "" }}
      server.ssl.enabled-protocols={{ yamlPath "perfAdvisor.tls.sslProtocols" }}
      {{ end }}
      pa.web.hsts.enabled={{ yamlPath "perfAdvisor.tls.hsts" }}
      {{ end }}

  - name: perfAdvisorMetricsExportTopology
    fileName: "{{ baseInstall }}/perf-advisor/config/metrics-export.yml"
    contents: |
      labels:
        collector_id: local
      shards:
        - id: 0
          default: true
          type: remotewrite
          replicas:
            - endpoint: "{{ if eq (yamlPath "prometheus.enableHttps") "true" }}https
            {{- else }}http{{ end }}://
              {{- index (splitInput (yamlPath "host")) 0 }}:
              {{- yamlPath "prometheus.port" }}/api/v1/write"
              auth:
                {{ if eq (yamlPath "prometheus.enableAuth") "true" }}
                type: basic
                username: {{ yamlPath "prometheus.authUsername" }}
                password: {{ yamlPath "prometheus.authPassword" }}
                {{ else }}
                type: none
                {{ end }}

  - name: perfAdvisorService
    fileName: "{{ .SystemdFileLocation }}"
    contents: |
      [Unit]
      Description=Perf Advisor
      Wants=network-online.target
      After=network-online.target

      [Service]
      {{ if eq (yamlPath "as_root") "true" }}
      User={{ yamlPath "service_username" }}
      Group={{ yamlPath "service_username" }}
      {{ end }}
      Type=simple

      Environment="JAVA_HOME={{ installVersionDir }}/jdk-17.0.7+7-jre/"

      ExecStart=/bin/sh -c "{{ .PABin }}/perf-advisor \
        --spring.config.additional-location=file:{{ .ConfFileLocation }} \
        &>> {{ .PALogDir }}/perf-advisor.log"

      Restart=always
      RestartSec={{ yamlPath "perfAdvisor.restartSeconds"}}

      # TODO: The logging might not work currently, perf-advisor app only logs to stdout/stderr
      # Once Aleks makes changes to the perf advisor app, logging should work as expected
      # Prevent logging to journalctl and only use log.override.path
      StandardOutput=null
      StandardError=null

      # Sigterm causes exit status 143 for java, if we dont have this, stopping the perf-advisor
      # service will show status as errored. Doing this will set ActiveState=inactive
      SuccessExitStatus=143

      [Install]
      WantedBy=multi-user.target
