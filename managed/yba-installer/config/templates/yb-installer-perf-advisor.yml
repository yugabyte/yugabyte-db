services:
  - name: perfAdvisorConfig
    fileName: "{{ .ConfFileLocation }}"
    contents: |
      # Copyright (c) YugabyteDB, Inc.
      # Perf Advisor overrides configuration file
      # This file is generated from pa-ctl.yml configuration

      # Spring Boot Web Resources
      spring.web.resources.static-locations=file://{{ installRoot }}/perf-advisor/ui

      # Spring Boot DataSource Configuration
      spring.datasource.username=postgres
      spring.datasource.url=jdbc:postgresql://localhost:{{ yamlPath "postgres.install.port" }}/ts
      spring.datasource.password={{ yamlPath "postgres.install.password" }}

      # Perf Advisor Security Configuration
      pa.security.api.token.secret=''
      pa.security.cors.origin=*
      pa.security.cors.origin.dev=*

      # Perf Advisor Prometheus Configuration
      pa.prometheus.url=http://localhost:{{ yamlPath "prometheus.port" }}

      # Perf Advisor Web Port
      server.port={{ yamlPath "perfAdvisor.port" }}

  - name: perfAdvisorService
    fileName: "{{ .SystemdFileLocation }}"
    contents: |
      [Unit]
      Description=Perf Advisor
      Wants=network-online.target
      After=network-online.target

      [Service]
      {{ if eq (yamlPath "as_root") "true" }}
      User={{ yamlPath "service_username" }}
      Group={{ yamlPath "service_username" }}
      {{ end }}
      Type=simple

      Environment="JAVA_HOME={{ installVersionDir }}/jdk-17.0.7+7-jre/"

      ExecStart=/bin/sh -c "{{ .PABin }}/perf-advisor \
        --spring.config.additional-location=file:{{ .ConfFileLocation }} \
        &>> {{ .PALogDir }}/perf-advisor.log"

      Restart=always
      RestartSec={{ yamlPath "perfAdvisor.restartSeconds"}}

      # TODO: The logging might not work currently, perf-advisor app only logs to stdout/stderr
      # Once Aleks makes changes to the perf advisor app, logging should work as expected
      # Prevent logging to journalctl and only use log.override.path
      StandardOutput=null
      StandardError=null

      # Sigterm causes exit status 143 for java, if we dont have this, stopping the perf-advisor
      # service will show status as errored. Doing this will set ActiveState=inactive
      SuccessExitStatus=143

      [Install]
      WantedBy=multi-user.target
