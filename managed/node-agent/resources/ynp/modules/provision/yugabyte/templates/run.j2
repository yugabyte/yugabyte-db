# Check if the user already exists
if id "{{ yb_user }}" &>/dev/null; then
    echo "User {{ yb_user }} already exists"
    # FATAL: Check if existing user's home directory matches the configured yb_home_dir
    existing_home=$(getent passwd {{ yb_user }} | cut -d: -f6)
    if [ -z "$existing_home" ]; then
        add_fatal_result "Yugabyte User Home Directory" \
            "Home directory for user {{ yb_user }} is not set"
    else
        configured_home="{{ yb_home_dir }}"
        # Resolve both paths to absolute canonical paths for comparison
        existing_home_abs=$(realpath -m "$existing_home" 2>/dev/null || echo "$existing_home")
        configured_home_abs=$(realpath -m "$configured_home" 2>/dev/null || echo "$configured_home")

        if [ "$existing_home_abs" != "$configured_home_abs" ]; then
            fatal_msg="User {{ yb_user }} home directory"
            fatal_msg+=" '$existing_home_abs' does not match"
            fatal_msg+=" configured '$configured_home_abs'."
            fatal_msg+=" This mismatch can cause system corruption."
            add_fatal_result \
                "Yugabyte User Home Directory Mismatch" \
                "$fatal_msg"
        fi
    fi
else
    # Creating the yb_user
    useradd -u {{ yb_user_id }} -s /bin/bash --create-home --home-dir {{ yb_home_dir }} -U {{ yb_user }}
    chown -R {{ yb_user }}:{{ yb_user }} {{ yb_home_dir }}
    chmod -R 711 {{ yb_home_dir }}
    echo "User {{ yb_user }} created"
fi

# Check if yb_user_password is not null
if [ -n "{{ yb_user_password }}" ]; then
    # Set the password for the new user if it needs to be updated
    current_password=$(getent shadow {{ yb_user }} | cut -d: -f2)
    new_password=$(openssl passwd -1 "{{ yb_user_password }}")

    if [[ "$current_password" != "$new_password" ]]; then
        echo '{{ yb_user }}:{{ yb_user_password }}' | chpasswd
        echo "Password for {{ yb_user }} updated"
    else
        echo "Password for {{ yb_user }} is already set"
    fi
fi

# Add yugabyte user to systemd-journal group if not already a member
if groups {{ yb_user }} | grep -q "\bsystemd-journal\b"; then
    echo "User {{ yb_user }} is already in the systemd-journal group"
else
    usermod -aG systemd-journal {{ yb_user }}
    echo "User {{ yb_user }} added to systemd-journal group"
fi

# Determine the PLATFORM_ID
platform_id=$(grep -oP '(?<=^PLATFORM_ID=).+' /etc/os-release | tr -d '"' || echo "unknown")

if [[ "{{ os_family }}" == "RedHat" ]]; then
    # Check SELinux status
    SELINUX_STATUS=$(sestatus | grep 'SELinux status' | awk '{print $3}')
    if [[ "$SELINUX_STATUS" == "enabled" ]]; then
        # Configuring the correct SELinux context
        current_context=$(ls -Zd "{{ yb_home_dir }}" | awk '{print $1}' | cut -d: -f3)
        if [[ "$current_context" != "ssh_home_t" ]]; then
            if command -v semanage >/dev/null 2>&1; then
                echo "semanage command found, using semanage"
                semanage fcontext -a -t ssh_home_t "{{ yb_home_dir }}(/.*)?"
                restorecon -ir "{{ yb_home_dir }}"
            else
                echo "semanage command not found, using chcon"
                chcon -R -t ssh_home_t "{{ yb_home_dir }}"
            fi
            echo "SELinux context for {{ yb_home_dir }} changed to ssh_home_t"
        else
            echo "SELinux context for {{ yb_home_dir }} is already set to ssh_home_t"
        fi
    fi
else
    echo "RedHat not detected, skipping changing selinux context"
fi

mount_points="{{ mount_paths | default('') | trim }}"
IFS=' ' read -ra mount_points_array <<< "$mount_points"
# Verify each mount point
for mount_point in "${mount_points_array[@]}"; do
    if [ ! -d "$mount_point" ]; then
        echo "Creating mount point: $mount_point"
        mkdir -p "$mount_point"
    else
        echo "Mount point already exists: $mount_point"
    fi
    chown -R {{ yb_user }}:{{ yb_user }} "$mount_point"
done

{% if is_cloud == 'True' %}
    # Set up the ssh key access for yugabyte
    mkdir -p {{ yb_home_dir }}/.ssh
    # Determine the current user
    if [ -n "$SUDO_USER" ]; then
        CURRENT_USER=$SUDO_USER
    else
        CURRENT_USER=$(whoami)
    fi
    echo $CURRENT_USER
    CURRENT_USER_HOME=$(eval echo "~$CURRENT_USER")
    AUTHORIZED_KEYS="$CURRENT_USER_HOME/.ssh/authorized_keys"

    # Check if the current user's authorized_keys file exists
    if [[ -f "$AUTHORIZED_KEYS" ]]; then
        cat "$AUTHORIZED_KEYS" > {{ yb_home_dir }}/.ssh/authorized_keys
        chown -R {{ yb_user }}:{{ yb_user }} {{ yb_home_dir }}/.ssh
        chmod 600 "{{ yb_home_dir }}/.ssh/authorized_keys"

        echo "Authorized keys from $CURRENT_USER copied to {{ yb_user }} home directory."
    else
        echo "No authorized_keys file found for user $CURRENT_USER. Skipping."
    fi
{% endif %}

{% if is_install_node_agent == 'True' %}
installer_script="{{ ynp_dir }}/../../bin/node-agent-installer.sh"
if [ ! -f "$installer_script" ]; then
    # For backward compatibility when backported.
    # Remove me later.
    installer_script="{{ ynp_dir }}/../node-agent-installer.sh"
fi
# Copy node-agent binary to yugabyte home directory. This is needed so that yugabyte user
# can read the binary in restricted environment.
mkdir -p {{ yb_home_dir }}/.install
cp "$installer_script" {{ yb_home_dir }}/.install
chown -R {{ yb_user }}:{{ yb_user }} {{ yb_home_dir }}/.install
{% endif %}

# Ensure the permissions for yb_home_dir are 750
chmod 750 "{{ yb_home_dir }}"
